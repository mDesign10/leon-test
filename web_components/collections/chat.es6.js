!function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/",i(i.s=70)}([function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(93);e.AppMode=n.AppMode;var o=i(43);e.Alert=o.Alert,e.DefaultAlerts=o.DefaultAlerts;var s=i(97);e.ButtonType=s.ButtonType;var r=i(98);e.ChatEntry=r.ChatEntry;var a=i(99);e.ChatEntryType=a.ChatEntryType;var c=i(100);e.ChatMessage=c.ChatMessage;var l=i(101);e.ChatMessageMarker=l.ChatMessageMarker;var d=i(102);e.ChatMessageAttachment=d.ChatMessageAttachment;var h=i(103);e.ChatMetaActivity=h.ChatMetaActivity;var u=i(104);e.ChatRole=u.ChatRole;var p=i(105);e.ConnectionStatus=p.ConnectionStatus;var g=i(106);e.DisconnectionStatus=g.DisconnectionStatus;var m=i(44);e.Icons=m.Icons,e.IconCollection=m.IconCollection,e.IconDefinition=m.IconDefinition;var f=i(107);e.RoomRole=f.RoomRole;var _=i(108);e.BaseUser=_.BaseUser;var v=i(109);e.XmppContact=v.XmppContact;var y=i(110);e.UserAdditionalDetailsType=y.UserAdditionalDetailsType;var C=i(111);e.BotResponse=C.BotResponse;var b=i(112);e.IQRequest=b.IQRequest;var w=i(113);e.IQResponse=w.IQResponse;var T=i(114);e.PushNotificationRegistrationDetails=T.PushNotificationRegistrationDetails},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(73);e.BaseLayer=n.BaseLayer,e.BaseLayerComponentInterface=n.BaseLayerComponentInterface;var o=i(48);e.CTBaseComponent=o.CTBaseComponent;var s=i(126);e.CTLayerComponent=s.CTLayerComponent;var r=i(127);e.NullableNumber=r.NullableNumber,e.Stroolean=r.Stroolean;var a=i(34);e.prop=a.prop;var c=i(17);e.Logger=c.Logger;var l=i(128);e.JSXElement=l.JSXElement},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(90),s=i(91),r=i(33),a=i(20);var c;function l(t){const i=(new e.safeMoment).startOf("day");return new e.safeMoment(t).startOf("day").diff(i,"days")}function d(t,i=null){const n=l(t);if(0===n||-1===n){const t=0===n?a.CommonI18nKeys.TODAY:a.CommonI18nKeys.YESTERDAY;return i&&i.translateI18nItem(a.CommonMetadata.getI18nItem(t))||t.toString()}return e.safeMoment(t).format("L")}function h(t,i=!1){const n=i?"LTS":"LT";return e.safeMoment(t).format(n)}function u(t){return t.map(t=>t instanceof Array?u(t):"object"==typeof t?Object.assign({},t):t)}function p(t){return null===t?null:void 0!==t?"object"!=typeof t?t:JSON.parse(JSON.stringify(t)):void 0}function g(t){return t&&"object"==typeof t&&!Array.isArray(t)}function m(t){if("data"in t&&"object"==typeof t.data){const e=Object.keys(t.data).filter(t=>"$attributes"!==t);if(e.length>0)return e[0]}return r.BaseMessageType.XmppChat}function f(t,e){const i=p(t);return i.data&&"string"==typeof i.data[e.toString()]&&(i.data[e.toString()]=JSON.parse(i.data[e.toString()])),i}!function(t){t[t.PREFIX_INITIAL_LAST=0]="PREFIX_INITIAL_LAST",t[t.PREFIX_FIRST_LAST=1]="PREFIX_FIRST_LAST"}(c=e.NameFormat||(e.NameFormat={})),e.safeMoment=o,e.setLocale=function(t){e.safeMoment.locale(t)},e.isDesktop=function(){return void 0===window.orientation},e.isMobile=function(){return void 0!==window.orientation},e.isAndroid=function(){const t=window;return t.device&&t.device.platform?"android"===t.device.platform.toLowerCase():!!t.cti&&"android"===t.cti.store.env.platform.name},e.isIos=function(){const t=window;return t.device&&t.device.platform?"ios"===t.device.platform.toLowerCase():!!t.cti&&"ios"===t.cti.store.env.platform.name},e.normalizeLocalFilePaths=function(t){return window.Ionic&&window.Ionic.normalizeURL?window.Ionic.normalizeURL(t):t},e.padLeft=function(t,e,i=" "){let n=t;const o=e-t.length;return o>0&&(n=Array(o+1).join(i)+n),n},e.generateRandomSixString=function(){let t=46656*Math.random()|0,e=46656*Math.random()|0;return(t=("000"+t.toString(36)).slice(-3))+("000"+e.toString(36)).slice(-3)},e.tokenReplace=function(t,e){return t?null==e?t:-1===t.indexOf("${")?t:t.replace(/\${([^{}]*)}/g,(t,i)=>{const n=((t,e)=>{const i=e.split(".");do{}while(i.length&&(t=t[i.shift()]));return t})(e,i);return"string"==typeof n||"number"==typeof n?n:t}):""},e.jidsMatch=function(t,e,i=!1){return i||(t=(t||"").toLowerCase(),e=(e||"").toLowerCase()),t===e},e.formatDate=function(t,e){return null==t?"":o(t).format(e)},e.formatDateForTimeOrDate=function(t,e=!1,i=!1,n=null){if(null==t)return"";if(0===l(t)){let o="";if(e){const t=a.CommonI18nKeys.TODAY;o=n&&n.translateI18nItem(a.CommonMetadata.getI18nItem(t))||t.toString()}return(e&&`${o}, `||"")+h(t,i)}return`${d(t,n)} ${h(t,i)}`},e.daysFromNow=l,e.getFriendlyDate=d,e.getFriendlyTime=h,e.prettyDuration=function(t){if(t<1e3)return"< 1s";const e=Math.trunc(t/1e3);if(e<60)return`${e}s`;const i=Math.trunc(t/1e3/60),n=Math.trunc((t-60*i*1e3)/1e3);if(i<60)return`${i}m`+(n&&` ${n}s`||"");const o=Math.trunc(t/1e3/60/60),s=Math.trunc((t-60*o*60*1e3)/1e3/60);return o<24?`${o}h`+(s&&` ${s}m`||""):`${Math.trunc(t/1e3/60/60/24)} days`},e.formatUserName=function(t,e){if(!t)return"";switch(e){case c.PREFIX_INITIAL_LAST:return`${t.prefix||""} ${(t.firstName||"").substr(0,1)} ${t.lastName||""}`.trim()||t.username||t.jid||"";case c.PREFIX_FIRST_LAST:return`${t.prefix||""} ${t.firstName||""} ${t.lastName||""}`.trim()||t.username||t.jid||""}},e.sortUsersByName=function(t){return u(t).sort((t,e)=>{const i=t.lastName||"",n=e.lastName||"",o=i.localeCompare(n);if(0!==o)return o;const s=t.firstName||"",r=e.firstName||"";return s.localeCompare(r)})},e.enumFromString=function(t){return t||null},e.deepCloneArray=u,e.uniqueArrayItems=function(t,e=(t=>t)){const i=[],n=[];return t.forEach(t=>{const o=e(t);i.includes(o)||(i.push(o),n.push(t))}),n},e.groupArrayItemsByKey=function(t,e=(t=>t)){return t.reduce((t,i)=>{const n=e(i);let o=null;return t[n]?o=t[n]:(o=[],t[n]=o),o.push(i),t},{})},e.deepCloneObject=p,e.isObject=g,e.mergeDeep=function t(e,...i){if(!i.length)return e;const n=i.shift();if(g(e)&&g(n))for(const i in n)g(n[i])?(e[i]||Object.assign(e,{[i]:{}}),t(e[i],n[i])):Object.assign(e,{[i]:n[i]});return t(e,...i)},e.getMessageType=m,e.parseMessagePayload=f,e.getMessageContentForDebug=function(t){const e=m(t);return null===e?"":e===r.BaseMessageType.XmppChat?{[e]:{body:t.body,attachments:t.attachments}}:t.data&&e in t.data?{[e]:f(t,e).data[e]}:""},e.getUsernameFromJid=function(t){return t.indexOf("@")>-1?t.substring(0,t.indexOf("@")):t},e.findRoomJidInMessage=function(t,e){const i=["recipient_id","sender_id","jid"];for(let n=0;n<i.length;n++){const o=i[n];if(t[o]){const i=(t[o]||"").toString().toLowerCase().split("/")[0];if(i.endsWith(e.toLowerCase()))return i}}return null},e.validateVCardObject=function(t){return t&&Object.keys(t).length>0},e.randomNumberBetween=function(t,e){return Math.floor(Math.random()*e)+t},e.sleep=function(t){return n(this,void 0,void 0,function*(){return new Promise(e=>{setTimeout(e,t)})})},e.getDiffs=function(t,e){return void 0===t||void 0===e?[]:s.default(t,e).map(t=>{const e=t.path.reduce((t,e)=>"number"==typeof e?`${t}[${e}]`:`${t}.${e}`,"").replace(".","");if("_id"===e||"_rev"===e)return null;let i="",n=!1,o=!1,s=null,r=null;return"A"===t.kind&&"N"===t.item.kind?(i=`ADDED [${t.index}]`,n=!0,r=t.item.rhs):"A"===t.kind&&"D"===t.item.kind?(i=`DELETED [${t.index}]`,o=!0,r=t.item.lhs):"N"===t.kind?(i="ADDED",n=!0,r=t.rhs):"D"===t.kind?(i="DELETED",o=!0,r=t.lhs):(i="EDITED",s=t.lhs,r=t.rhs),{type:i,added:n,deleted:o,path:e,lhs:s,rhs:r}}).filter(t=>null!==t)},e.getCSSVariable=function(t){const e=getComputedStyle(document.body).getPropertyValue(t);return e?e.trim():e}},function(t,e){t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var i=function(t,e){var i=t[1]||"",n=t[3];if(!n)return i;if(e&&"function"==typeof btoa){var o=function(t){return"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t))))+" */"}(n),s=n.sources.map(function(t){return"/*# sourceURL="+n.sourceRoot+t+" */"});return[i].concat(s).concat([o]).join("\n")}return[i].join("\n")}(e,t);return e[2]?"@media "+e[2]+"{"+i+"}":i}).join("")},e.i=function(t,i){"string"==typeof t&&(t=[[null,t,""]]);for(var n={},o=0;o<this.length;o++){var s=this[o][0];"number"==typeof s&&(n[s]=!0)}for(o=0;o<t.length;o++){var r=t[o];"number"==typeof r[0]&&n[r[0]]||(i&&!r[2]?r[2]=i:i&&(r[2]="("+r[2]+") and ("+i+")"),e.push(r))}},e}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(35);e.CTActionSheet=n.CTActionSheet;var o=i(183);e.CTAlertModalManager=o.CTAlertModalManager;var s=i(186);e.CTAlertModal=s.CTAlertModal;var r=i(189);e.CTAvatarTile=r.CTAvatarTile;var a=i(62);e.CTButton=a.CTButton;var c=i(194);e.CTDebugger=c.CTDebugger;var l=i(197);e.CTFilePicker=l.CTFilePicker;var d=i(37);e.CTGroupAvatar=d.CTGroupAvatar;var h=i(63);e.CTGroupTile=h.CTGroupTile;var u=i(202);e.CTGrowingTextbox=u.CTGrowingTextbox;var p=i(205);e.CTIcon=p.CTIcon;var g=i(208);e.CTLoginForm=g.CTLoginForm,e.CTLoginFormMetadata=g.CTLoginFormMetadata;var m=i(211);e.CTMenu=m.CTMenu,e.MenuItem=m.MenuItem;var f=i(214);e.CTOnlineIndicator=f.CTOnlineIndicator,e.CTOnlineIndicatorMetadata=f.CTOnlineIndicatorMetadata;var _=i(217);e.CTSearchbox=_.CTSearchbox;var v=i(220);e.CTSelectionList=v.CTSelectionList,e.CTSelectionListItem=v.CTSelectionListItem;var y=i(38);e.CTSelectionTextFilter=y.CTSelectionTextFilter;var C=i(225);e.CTSlidePanel=C.CTSlidePanel;var b=i(228);e.CTTextbox=b.CTTextbox;var w=i(231);e.CTUserAvatar=w.CTUserAvatar;var T=i(234);e.CTUserDisplay=T.CTUserDisplay,function(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}(i(237));var E=i(240);e.CTUserTile=E.CTUserTile},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(11);var o=i(116);e.AttachmentDownloadComplete=o.AttachmentDownloadComplete;var s=i(117);e.AudioAttachmentDownloadComplete=s.AudioAttachmentDownloadComplete;var r=i(45);e.ChatEntryEventArgs=r.ChatEntryEventArgs;var a=i(118);e.ChatNotificationEventArgs=a.ChatNotificationEventArgs;var c=i(47);e.ConversationEventArgs=c.ConversationEventArgs;var l=i(119);e.ConversationParticiantRoleEventArgs=l.ConversationParticiantRoleEventArgs;var d=i(120);e.ConversationParticiantsEventArgs=d.ConversationParticiantsEventArgs;var h=i(121);e.ForceQuitConversationEventArgs=h.ForceQuitConversationEventArgs;class u extends n.BaseEvents{}u.ConversationAdded="conversation-added",u.ConversationUpdated="conversation-updated",u.ConversationClosed="conversation-closed",u.ConversationRemoved="conversation-removed",u.ConversationDeleted="conversation-deleted",u.ConversationPurged="conversation-purged",u.ConversationParticipantsChanged="conversation-participants-changed",u.ForceQuitConversation="force-quit-conversation",u.CurrentConversationChanged="current-conversation-changed",u.ChatEntryReceived="chat-entry-received",u.ChatEntryUpdated="chat-entry-updated",u.ChatEntriesFetched="chat-entries-fetched",u.ThumbnailLoaded="thumbnail-loaded",u.ChatNotification="chat-notification",u.PriorityConversationNotification="priority-conversation-notification",u.PriorityConversationAcknowledged="priority-conversation-acknowledged",u.PriorityConversationAcknowledgedOnAnotherDevice="priority-conversation-acknowledged-on-another-device",u.MuteAlertToPlayOtherAudio="mute-alert-to-play-other-audio",u.ResumeAlertAfterPlayingAudio="resume-alert-after-playing-audio",u.AudioAttachmentDownloadComplete="audio-attachment-download-complete",u.RemotelyStartAudioPlayer="remotely-start-audio-player",u.RemotelyStopAudioPlayer="remotely-stop-audio-player",u.AudioRecordingStarted="audio-recording-started",u.AudioRecordingStopped="audio-recording-stopped",u.AttachmentDownloadComplete="attachment-download-complete",u.AutoReconnected="auto-reconnected",u.PostLoginComplete="post-login-complete",u.Mute="mute",u.MessageProcessorQueueEmpty="message-processor-queue-empty",e.ChatEvents=u},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */function n(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}Object.defineProperty(e,"__esModule",{value:!0});var o=i(129);e.DraftAttachmentData=o.DraftAttachmentData;var s=i(130);e.ChatMetaActivityType=s.ChatMetaActivityType;var r=i(131);e.Conversation=r.Conversation,e.ConversationHash=r.ConversationHash;var a=i(132);e.ConversationType=a.ConversationType;var c=i(133);e.ConversationParticipant=c.ConversationParticipant;var l=i(134);e.ConversationUpdateOptions=l.ConversationUpdateOptions;var d=i(135);e.Draft=d.Draft;var h=i(136);e.Icons=h.Icons;var u=i(137);e.User=u.User,n(i(138)),n(i(141)),n(i(142)),n(i(49))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(33),s=i(2);class r extends o.BaseHandler{constructor(t){super(t)}callHandleMessage(t){return n(this,void 0,void 0,function*(){this._ensureValidVersion(t),yield this.handleMessage(t),yield this.layer.updateLatestIdentifier(t)})}callHandleMessageUpdate(t){return n(this,void 0,void 0,function*(){this._ensureValidVersion(t),yield this.handleMessageUpdate(t),yield this.layer.updateLatestIdentifier(t)})}handleConversationNotFound(t,e){}isMamMessage(t){return!0===t.fromMam}isInjectedMessage(t){return!0===t.injected}_ensureValidVersion(t){const e=s.getMessageType(t);if(e===o.BaseMessageType.XmppChat)return;const i=t.data[e];if((i&&i.version||1)>r.VERSION){const n=`Invalid message version ${i.version} for message "${e}" - expected ${r.VERSION}`;throw this.layer.logger.error(n,t),new Error(n)}}}r.VERSION=1,e.BaseChatHandler=r},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(145);var o=i(146);e.ChatMessageToChatEntryConverter=o.ChatMessageToChatEntryConverter;var s=i(147);e.ChatMessageType=s.ChatMessageType;var r=i(50);e.FetchConversationsData=r.FetchConversationsData;var a=i(51);e.CreateConversationData=a.CreateConversationData;var c=i(52);e.UpdateConversationData=c.UpdateConversationData;var l=i(53);e.AddParticipantsData=l.AddParticipantsData;var d=i(54);e.RemoveParticipantsData=d.RemoveParticipantsData;var h=i(55);e.ChangeParticipantRoleData=h.ChangeParticipantRoleData;var u=i(56);e.LeaveConversationData=u.LeaveConversationData;var p=i(57);e.EndConversationData=p.EndConversationData;const g=i(148),m=i(50),f=i(51),_=i(52),v=i(53),y=i(54),C=i(55),b=i(56),w=i(57),T=i(149),E=i(150),S=i(151),R=i(152),A=i(153),I=i(154),x=i(155),M=i(156),O=i(157),N=i(158),P=i(159),L=i(160),D=i(161),k=i(162),j=i(163),U=i(164),F=i(165),B=i(166),H=i(167),$=i(168),q=i(169);e.get=function(t){return[new F.AutoReconnectedHandler(t),new g.CommsConnectionHandler(t),new q.AttachmentDownloadedHandler(t),new $.RaiseDeviceNotificationHandler(t),new m.FetchConversationsHandler(t),new f.CreateConversationHandler(t),new _.UpdateConversationHandler(t),new v.AddParticipantsHandler(t),new y.RemoveParticipantsHandler(t),new C.ChangeParticipantRoleHandler(t),new b.LeaveConversationHandler(t),new w.EndConversationHandler(t),new B.ReceivedConversationHandler(t),new n.AcknowledgeConversationHandler(t),new T.DeleteDirectConversationHandler(t),new E.ChatMessageHandler(t),new S.ConversationStartedHandler(t),new R.ConversationUpdatedHandler(t),new A.ParticipantAddedHandler(t),new I.ParticipantRemovedHandler(t),new x.ParticipantRoleChangedHandler(t),new M.ParticipantLeftHandler(t),new O.ConversationEndedHandler(t),new H.ParticipantReceivedHandler(t),new U.ParticipantAcknowledgedHandler(t),new N.UserAddedHandler(t),new P.UserRemovedHandler(t),new L.UserLeftHandler(t),new D.UserConversationEndedHandler(t),new k.UserDeleteDirectConversationHandler(t),new j.ChatEntryEventHandler(t)]}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(174);document.createElement("div");let o=!1;function s(t,e,i){return t?e:i}function r(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,n){return e+e+i+i+n+n});const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}e.debouncedRequestAnimationFrame=function(t){o||(o=!0,requestAnimationFrame(()=>{o=!1,t()}))},e.renderIf=function(t,e){return s(t,e,null)},e.renderIfElse=s,e.buildStyles=function(t={}){return t},e.hexToRgbaString=function(t){const e=r(t);return`rgba(${e.r}, ${e.g}, ${e.b}, 1)`},e.decideTextColorFromBgColor=function(t){const e=r(t);return.299*e.r+.587*e.g+.114*e.b>186?"#000000":"#ffffff"},e.linkifyText=function(t){return n(t,{target:"_system",attributes:{onclick:"window.open(this.href, '_system'); return false;"}}).replace(/&amp;/g,"&")}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0),s=i(15),r=i(14),a=i(6),c=i(2);function l(t,e,i,n,o,s,r,c,l,d,h,u,p,g,m,f=[]){const _={id:t,roomJid:i,type:e,participants:n,hasUnread:!1,preview:null,createdTime:parseInt(r),instigator:p,hideBefore:g,config:m?JSON.parse(m):null};return e===a.ConversationType.Named&&(_.subject=o,_.description=s,_.priority=c,_.expiryTTL=l,_.activityTTL=d,_.receivedList=h||[],_.acknowledgements=u||[],_.attachments=f.map(t=>JSON.parse(t))),_}function d(t,e,i,n="",o="",r){let l=c.deepCloneArray(e);return""!==n&&"all"!==n.toLowerCase()&&(l=l.filter(t=>(t.config?t.config.name:t.type).toLowerCase()===n.toLowerCase())),o&&(l=l.filter(e=>{const n=[],s=[];e.participants.forEach(e=>{if(c.jidsMatch(e.jid,i))return;const o=t.get(e.jid)||null;o&&(o.firstName&&n.push(o.firstName.toLowerCase()),o.lastName&&n.push(o.lastName.toLowerCase()))}),e.type===a.ConversationType.Named&&s.push(e.subject.toLowerCase());const r=o.toLowerCase();return n.some(t=>t.startsWith(r))||s.some(t=>t.includes(r))})),l.sort((t,e)=>{const i=new s.ConversationConfigReader(r,t),n=new s.ConversationConfigReader(r,e);if(h(t)&&!h(e))return 1;if(h(e)&&!h(t))return-1;if(i.alert&&!n.alert)return-1;if(n.alert&&!i.alert)return 1;if(i.alert&&n.alert){const t=i.sortOrder,e=n.sortOrder;if(t!==e)return e-t}const o=t.preview&&t.preview.date||0,a=e.preview&&e.preview.date||0;return Math.sign(a-o)}),l}function h(t){if(!t||!t.priority)return!1;if(!t.expiryTTL||0===t.expiryTTL)return!1;const e=t.createdTime+1e3*t.expiryTTL;return(new Date).getTime()>e}function u(t,e,i,n=0){const o=e.map(e=>t.get(e.jid));let s=c.sortUsersByName(o).map(t=>c.formatUserName(t,c.NameFormat.PREFIX_INITIAL_LAST)).join(", ");return n>0&&(s=s.substr(0,n)),s}e.buildConversationParticipants=function(t,e,i){return[...t&&t.map(t=>({jid:t,role:o.ChatRole.Owner}))||[],...e&&e.map(t=>({jid:t,role:o.ChatRole.Administrator}))||[],...i&&i.map(t=>({jid:t,role:o.ChatRole.Participant}))||[]]},e.createConversation=l,e.createProvisionalDirectConversation=function(t,e){return Object.assign({},l("provisional",a.ConversationType.Direct,null,t),{isProvisional:!0,config:e})},e.getParticipantHash=function(t){return t.map(t=>t.jid.toLowerCase()).sort().reduce((t,e)=>t.concat(e),"")},e.prepareConversationsForList=d,e.sortConversationsIntoHash=function(t,e,i,n="",o="",s){const r={};return d(t,e,i,n,o,s).forEach(t=>{let e=(t.config?t.config.name:t.type).toLowerCase();h(t)&&(e=`${e} (expired)`),r[e]?r[e].push(t):r[e]=[t]}),r},e.isExpiredConversation=h,e.getConversationTitle=function(t,e,i,n){const o=t.type===a.ConversationType.Named,s=t.participants.filter(t=>!c.jidsMatch(t.jid,i));return o?t.subject:0===s.length?n:u(e,s,0,this._contentLimit)},e.generateConversationTitleFromParticipants=u,e.createChatMessage=function(t,e,i,n,s,r,a,l=null,d=null,h=null){"string"==typeof e&&(e=parseInt(e,10));const u={id:t,type:o.ChatEntryType.Chat,date:e,mine:c.jidsMatch(n,i),from:n,to:s,body:r};return a&&a.length&&(u.attachments=a),l&&l.length&&(u.receivedBy=l),d&&d.length&&(u.readBy=d),h&&(u.placeholder=h),u},e.createMetaEntry=function(t,e,i,n,s,r,a){return"string"==typeof e&&(e=parseInt(e,10)),{id:t,type:o.ChatEntryType.Meta,date:e,to:i,instigator:s,subject:r,action:n.toString(),data:a}},e.convertToChatEntry=function(t,e){return n(this,void 0,void 0,function*(){const i=c.getMessageType(t),n=c.parseMessagePayload(t,i);let o=e.getHandlerForMessage(n);if("convert"in o){o=o;const e=n.data&&n.data[o.messageKey]||null;return yield o.convert(t,e)}return null})},e.getChatMessageTextForPreview=function(t,e){if(t.body&&t.body.length>0){const e=100,i=t.body.length>e-3?"...":"";return t.body.substr(0,e)+i}return t.attachments&&t.attachments.length>0?e.translateI18nItem(r.ChatCommonMetadata.getI18nItem(r.ChatCommonI18nKeys.ATTATCHMENT_RECEIVED)):""},e.getChatMetaActivitySummaryText=function(t,e,i,n,s=!1){let l=null;switch(c.enumFromString(t.action)){case a.ChatMetaActivityType.START:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.START_BY_YOU:r.ChatCommonI18nKeys.START;break;case a.ChatMetaActivityType.UPDATE:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.UPDATE_BY_YOU:r.ChatCommonI18nKeys.UPDATE;break;case a.ChatMetaActivityType.ADD:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.ADD_BY_YOU:c.jidsMatch(t.subject,i)?r.ChatCommonI18nKeys.ADD_YOU:r.ChatCommonI18nKeys.ADD;break;case a.ChatMetaActivityType.REMOVE:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.KICK_BY_YOU:c.jidsMatch(t.subject,i)?r.ChatCommonI18nKeys.KICK_YOU:r.ChatCommonI18nKeys.KICK;break;case a.ChatMetaActivityType.CHANGEROLE:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.CHANGE_ROLE_BY_YOU:c.jidsMatch(t.subject,i)?r.ChatCommonI18nKeys.CHANGE_ROLE_YOU:r.ChatCommonI18nKeys.CHANGE_ROLE;break;case a.ChatMetaActivityType.LEFT:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.LEFT_YOU:r.ChatCommonI18nKeys.LEFT;break;case a.ChatMetaActivityType.END:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.END_YOU:r.ChatCommonI18nKeys.END;break;case a.ChatMetaActivityType.ACK:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.ACK_BY_YOU:r.ChatCommonI18nKeys.ACK;break;case a.ChatMetaActivityType.RECEIVED:l=c.jidsMatch(t.instigator,i)?r.ChatCommonI18nKeys.RECEIVED_YOU:r.ChatCommonI18nKeys.RECEIVED}if(!l)return null;const d=t=>{const i=e.get(t);return i&&c.formatUserName(i,c.NameFormat.PREFIX_INITIAL_LAST)||t},h={date:c.getFriendlyDate(t.date,n),time:c.getFriendlyTime(t.date),instigator:d(t.instigator),subject:d(t.subject),data:t.data,value:t.subject||"acknowledge"};if("change_role"===t.action)switch(t.data){case o.ChatRole.Participant.toString():h.data=n.translateI18nItem(r.ChatCommonMetadata.getI18nItem(r.ChatCommonI18nKeys.PARTICIPANT));break;case o.ChatRole.Administrator.toString():h.data=n.translateI18nItem(r.ChatCommonMetadata.getI18nItem(r.ChatCommonI18nKeys.ADMINISTRATOR));break;case o.ChatRole.Owner.toString():h.data=n.translateI18nItem(r.ChatCommonMetadata.getI18nItem(r.ChatCommonI18nKeys.OWNER))}let u=n.translateI18nItem(r.ChatCommonMetadata.getI18nItem(l));return Object.keys(h).forEach(t=>{u=u.replace(`{{${t}}}`,h[t])}),s?u.replace(/\*(.*?)\*/g,"<span class='b'>$1</span>"):u.replace(/\*(.*?)\*/g,"$1")}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(24);e.BaseEventArgs=n.BaseEventArgs;var o=i(85);e.CommsEventArgs=o.CommsEventArgs;var s=i(86);e.UserActivityEventArgs=s.UserActivityEventArgs;var r=i(87);e.UserConnectionStatusEventArgs=r.UserConnectionStatusEventArgs;var a=i(88);e.RoomParticipantUpdateEventArgs=a.RoomParticipantUpdateEventArgs;var c=i(89);e.ConnectionStatusEventArgs=c.ConnectionStatusEventArgs;class l{}l._Request_RaiseAlert="request-raise-alert",l._Request_CloseAlert="request-close-alert",l._Request_UpdateUISuppression="request-update-ui-suppression",l._Request_RedrawAllUIs="_request-redraw-all-uis",l._Request_Logout="request-logout",l._Request_Component_Clear_Data="request-component-clear-data",l._Request_ThemeChange="request-theme-change",l.ConnectionStatusChange="connection-status-change",l.OtherUserConnectionStatusChange="other-user-connection-status-change",l.CurrentUserVCardUpdate="current-user-vcard-update",l.RoomParticipantUpdate="room-participant-update",l.UserActivity="user-activity",l.LoginResult="login-result",l.LogoutResult="logout-result",l.LoginFormResult="login-form-result",l.MoveTaskToBack="move-task-to-back",e.BaseEvents=l},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(94);e.Metadata=n.Metadata;var o=i(95);e.I18nItem=o.I18nItem;var s=i(96);e.TranslationProvider=s.TranslationProvider},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(173);e.CTCLComponent=n.CTCLComponent},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(12);var o;!function(t){t[t.FETCHING_OWN_DATA="Fetching personal data..."]="FETCHING_OWN_DATA",t[t.UPDATING_CONTACTS="Updating contacts..."]="UPDATING_CONTACTS",t[t.FETCHING_CONVERSATIONS="Fetching conversations..."]="FETCHING_CONVERSATIONS",t[t.REMOVED_TITLE="Removed from conversation"]="REMOVED_TITLE",t[t.REMOVED_MESSAGE='You were removed from the conversation "{{subject}}"']="REMOVED_MESSAGE",t[t.ENDED_TITLE="Conversation closed"]="ENDED_TITLE",t[t.ENDED_MESSAGE='The conversation "{{subject}}" has been closed']="ENDED_MESSAGE",t[t.ERROR_SAVING_CHANGES_TITLE="Error saving changes"]="ERROR_SAVING_CHANGES_TITLE",t[t.ERROR_SAVING_CHANGES_MESSAGE="There was an error saving changes"]="ERROR_SAVING_CHANGES_MESSAGE",t[t.ERROR_CREATING_CONVERSATION_TITLE="Unable to create conversation"]="ERROR_CREATING_CONVERSATION_TITLE",t[t.ERROR_UPDATING_CONVERSATION_TITLE="Unable to update details"]="ERROR_UPDATING_CONVERSATION_TITLE",t[t.ERROR_ADDING_PARTICIPANTS_TITLE="Unable to add participants"]="ERROR_ADDING_PARTICIPANTS_TITLE",t[t.ERROR_REMOVING_PARTICIPANTS_TITLE="Unable to remove participants"]="ERROR_REMOVING_PARTICIPANTS_TITLE",t[t.ERROR_CHANGING_PARTICIPANT_ROLE_TITLE="Unable to change role"]="ERROR_CHANGING_PARTICIPANT_ROLE_TITLE",t[t.ERROR_LEAVING_CONVERSATION_TITLE="Unable to leave conversation"]="ERROR_LEAVING_CONVERSATION_TITLE",t[t.ERROR_ENDING_CONVERSATION_TITLE="Unable to end conversation"]="ERROR_ENDING_CONVERSATION_TITLE",t[t.ERROR_RECEIVING_CONVERSATION="Unable to mark conversation as received"]="ERROR_RECEIVING_CONVERSATION",t[t.ERROR_ACKNOWLEDGING_CONVERSATION="Unable to acknowledge conversation"]="ERROR_ACKNOWLEDGING_CONVERSATION",t[t.ERROR_DELETING_DIRECT_CONVERSATION="Unable to delete this conversation"]="ERROR_DELETING_DIRECT_CONVERSATION",t[t.YOU_HAVE_NEW_NOTIFICATIONS="You have new notifications"]="YOU_HAVE_NEW_NOTIFICATIONS",t[t.ATTATCHMENT_RECEIVED="Image"]="ATTATCHMENT_RECEIVED",t[t.START="Started *{{date}}* at *{{time}}* by *{{instigator}}*"]="START",t[t.START_BY_YOU="Started *{{date}}* at *{{time}}* by *you*"]="START_BY_YOU",t[t.UPDATE="*{{instigator}}* updated the conversation details"]="UPDATE",t[t.UPDATE_BY_YOU="*You* updated the conversation details"]="UPDATE_BY_YOU",t[t.ADD="*{{subject}}* was added by *{{instigator}}*"]="ADD",t[t.ADD_YOU="*You* were added by *{{instigator}}*"]="ADD_YOU",t[t.ADD_BY_YOU="*{{subject}}* was added by *you*"]="ADD_BY_YOU",t[t.ACK="*{{instigator}}* responded with: *{{value}}* *{{date}}* at *{{time}}*"]="ACK",t[t.ACK_BY_YOU="You responded with: *{{value}}* *{{date}}* at *{{time}}*"]="ACK_BY_YOU",t[t.CHANGE_ROLE="*{{subject}}* was made *{{data}}* by *{{instigator}}*"]="CHANGE_ROLE",t[t.CHANGE_ROLE_YOU="*You* were made *{{data}}* by *{{instigator}}*"]="CHANGE_ROLE_YOU",t[t.CHANGE_ROLE_BY_YOU="*{{subject}}* was made *{{data}}* by *you*"]="CHANGE_ROLE_BY_YOU",t[t.KICK="*{{subject}}* was removed by *{{instigator}}*"]="KICK",t[t.KICK_YOU="*You* were removed by *{{instigator}}*"]="KICK_YOU",t[t.KICK_BY_YOU="*{{subject}}* was removed by *you*"]="KICK_BY_YOU",t[t.LEFT="*{{instigator}}* left the conversation"]="LEFT",t[t.LEFT_YOU="*You* left the conversation"]="LEFT_YOU",t[t.END="*{{instigator}}* ended the conversation"]="END",t[t.END_YOU="*You* ended the conversation"]="END_YOU",t[t.RECEIVED="*{{instigator}}* received an alert: *{{date}}* at *{{time}}*"]="RECEIVED",t[t.RECEIVED_YOU="You received the alert: *{{date}}* at *{{time}}*"]="RECEIVED_YOU",t[t.PARTICIPANT="participant"]="PARTICIPANT",t[t.ADMINISTRATOR="administrator"]="ADMINISTRATOR",t[t.OWNER="owner"]="OWNER"}(o=e.ChatCommonI18nKeys||(e.ChatCommonI18nKeys={})),e.ChatCommonMetadata=new n.Metadata("ChatCommon",o)},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(6),o=i(2);e.ConversationConfigReader=class{constructor(t,e,i){this._layer=t,this._conversation=e,this._config=i||this._loadConfiguration()}_loadConfiguration(){let t="";if(this._conversation&&this._conversation.config)return this._conversation.config;if(this._conversation){t=this._conversation.type;const e=this._layer.config.conversationTypes.find(t=>t.id===this._conversation.type);if(e)return e}switch(t){case"named":return n.namedConversationConfig;case"direct":default:return n.directConversationConfig}}_ensureConfigSet(){if(!this._config)throw new Error("Configuration has not been set.")}constructConfigurationToSend(t,e=!0){const i=o.deepCloneObject(this._config);return t&&i.behaviour.alert&&(i.behaviour.alert.alertResponseOptions=[t]),i.behaviour.chatAvailable=e,i}get id(){return this._config.id||null}get sortOrder(){return this._config.sortOrder||999}get name(){return this._config.name||"Direct"}get shortDescription(){return this._config.shortDescription||null}get longDescription(){return this._config.longDescription||null}get descriptionAtTop(){return this._config.descriptionAtTop||null}get colorCode(){return this._config.colorCode||null}get displayGroup(){return this._config.displayGroup||null}get defaultConversationExpiryTTL(){return void 0===this._config.defaultConversationExpiryTTL?this._layer.config.behaviour.defaultConversationExpiryTTL||3600:this._config.defaultConversationExpiryTTL}get defaultConversationActivityTTL(){return void 0===this._config.defaultConversationActivityTTL?this._layer.config.behaviour.defaultConversationActivityTTL||604800:this._config.defaultConversationActivityTTL}get maxConversationParticipants(){return this._config.maxConversationParticipants||this._layer.config.behaviour.maxConversationParticipants||20}get warnWhenNoContacts(){return void 0!==this._config.behaviour.warnWhenNoContacts&&this._config.behaviour.warnWhenNoContacts}get errorWhenNoContacts(){return void 0!==this._config.behaviour.errorWhenNoContacts&&this._config.behaviour.errorWhenNoContacts}get chatAvailable(){return void 0===this._config.behaviour.chatAvailable||this._config.behaviour.chatAvailable}get namedSettings(){return!!(this._config.behaviour.namedSettings&&Object.keys(this._config.behaviour.namedSettings).length>0)||null}get usePagerUI(){return this._config.behaviour.usePagerUI||!1}get subjectRequired(){return this._config.behaviour.namedSettings?void 0===this._config.behaviour.namedSettings.subjectRequired||this._config.behaviour.namedSettings.subjectRequired:null}get subjectFieldLabel(){return this._config.behaviour.namedSettings&&this._config.behaviour.namedSettings.subjectFieldLabel||"Subject"}get maxSubjectLength(){return this._config.behaviour.namedSettings&&this._config.behaviour.namedSettings.maxSubjectLength||this._layer.config.behaviour.maxSubjectLength}get descriptionRequired(){return this._config.behaviour.namedSettings&&this._config.behaviour.namedSettings.descriptionRequired||!1}get descriptionFieldLabel(){return this._config.behaviour.namedSettings?this._config.behaviour.namedSettings.descriptionFieldLabel||`Description${this.descriptionRequired?"":" (optional)"}`:"Description (optional)"}get maxDescriptionLength(){return this._config.behaviour.namedSettings&&this._config.behaviour.namedSettings.maxDescriptionLength||this._layer.config.behaviour.maxDescriptionLength}get participantCanLeave(){return void 0===this._config.behaviour.participantCanLeave||this._config.behaviour.participantCanLeave}get participantCanDelete(){return void 0===this._config.behaviour.participantCanDelete||this._config.behaviour.participantCanDelete}get ownerCanEditAfterSend(){return void 0===this._config.behaviour.ownerCanEditAfterSend||this._config.behaviour.ownerCanEditAfterSend}get ownerCanAddAdditionalContacts(){return void 0===this._config.behaviour.ownerCanAddAdditionalContacts||this._config.behaviour.ownerCanAddAdditionalContacts}get ownerCanCloseEarly(){return void 0===this._config.behaviour.ownerCanCloseEarly||this._config.behaviour.ownerCanCloseEarly}get canSendAttachmentsWithinConversation(){return void 0===this._config.behaviour.canSendAttachmentsWithinConversation||this._config.behaviour.canSendAttachmentsWithinConversation}get autoRemoveOnClose(){return void 0===this._config.behaviour.autoRemoveOnClose||this._config.behaviour.autoRemoveOnClose}get priorityPush(){return this._config.behaviour.priorityPush?this._config.behaviour.priorityPush:null}get alert(){return!!(this._config.behaviour.alert&&Object.keys(this._config.behaviour.alert).length>0)||null}get autoAlert(){return this._config.behaviour.alert?void 0===this._config.behaviour.alert.autoAlert||this._config.behaviour.alert.autoAlert:null}get suppressAlertModalWarning(){return this._config.behaviour.alert&&this._config.behaviour.alert.suppressAlertModalWarning||!1}get alertVolume(){return this._config.behaviour.alert?void 0===this._config.behaviour.alert.alertVolume?100:this._config.behaviour.alert.alertVolume:100}get alertSoundFilename(){return this._config.behaviour.alert&&void 0!==this._config.behaviour.alert.alertSoundFilename?this._config.behaviour.alert.alertSoundFilename:"Clinical_Messaging_Notification.m4a"}get alertSoundLoops(){return this._config.behaviour.alert&&void 0!==this._config.behaviour.alert.alertSoundLoops?this._config.behaviour.alert.alertSoundLoops:1}get alertAudioStream(){return this._config.behaviour.alert&&void 0!==this._config.behaviour.alert.alertAudioStream?this._config.behaviour.alert.alertAudioStream:"notification"}get vibrate(){return!this._config.behaviour.alert||void 0===this._config.behaviour.alert.vibrate||this._config.behaviour.alert.vibrate}get forceVibrate(){return!this._config.behaviour.alert||void 0===this._config.behaviour.alert.forceVibrate||this._config.behaviour.alert.forceVibrate}get vibrateDuration(){return this._config.behaviour.alert&&void 0!==this._config.behaviour.alert.vibrateDuration?this._config.behaviour.alert.vibrateDuration:300}get automaticallyPlayAudioOnDownload(){return!(!this._config.behaviour.alert||void 0===this._config.behaviour.alert.automaticallyPlayAudioOnDownload)&&this._config.behaviour.alert.automaticallyPlayAudioOnDownload}get allowMute(){return this._config.behaviour.alert?this._config.behaviour.alert.allowMute||!1:null}get snoozeDuration(){return this._config.behaviour.alert?this._config.behaviour.alert.snoozeDuration||60:null}get alertResponseOptions(){return this.alert&&this._config.behaviour.alert.alertResponseOptions?this._config.behaviour.alert.alertResponseOptions:[]}get alertResponseOptionTemplates(){return this.alert&&this.alertResponseOptions.length?this.alertResponseOptions.reduce((t,e)=>t=[...t,...e.options],[]):[]}get attachments(){return!!(this._config.behaviour&&this._config.behaviour.attachments&&Object.keys(this._config.behaviour.attachments).length>0)||null}get image(){return this.attachments?this._config.behaviour.attachments.image:null}get allowOpenInFullScreen(){return!(this.attachments&&this.image&&Object.keys(this._config.behaviour.attachments.image).length>0)||void 0===this._config.behaviour.attachments.image.allowOpenInFullScreen||this._config.behaviour.attachments.image.allowOpenInFullScreen}get audio(){if(this.attachments){if(this._config.behaviour.attachments.audio&&"object"==typeof this._config.behaviour.attachments.audio){const t=Object.keys(this._config.behaviour.attachments.audio);for(let e=0;e<t.length;e++)if(!0===this._config.behaviour.attachments.audio[e])return this._config.behaviour.attachments.audio;return!1}return this._config.behaviour.attachments.audio}return null}get attachPreRecordedFile(){return this.attachments?!this.audio||void 0===this.audio.attachPreRecordedFile||this.audio.attachPreRecordedFile:null}get attachLiveRecordedAudio(){return this.attachments?!this.audio||void 0===this.audio.attachLiveRecordedAudio||this.audio.attachLiveRecordedAudio:null}get video(){return this.attachments?this._config.behaviour.attachments.video:null}get autoPlay(){return this.attachments&&this.audio?this.audio.autoPlay||!1:null}get limitPlaybackToEarpiece(){return this.attachments&&this.audio?this.audio.limitPlaybackToEarpiece||!1:null}get shouldOpenConversationAfterResponded(){return!this._config.behaviour.alert||void 0===this._config.behaviour.alert.shouldOpenConversationAfterResponded||this._config.behaviour.alert.shouldOpenConversationAfterResponded}get participantAlertResponsesVisible(){return!this._config.behaviour.alert||void 0===this._config.behaviour.alert.participantAlertResponsesVisible||this._config.behaviour.alert.participantAlertResponsesVisible}get autoIncludeMembersInRoles(){return this._config.behaviour.alert&&this._config.behaviour.alert.autoIncludeMembersInRoles||[]}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */function n(t,e=null){const i={};return t&&(i.$attributes=t),Object.assign({},i,e||{})}Object.defineProperty(e,"__esModule",{value:!0}),e.createIq=function(t,e,i){return{[t]:n({xmlns:"urn:commontime:infinity:muc"},i)}},e.createIqNode=n},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(2);!function(t){t[t.Connectivity="connectivity"]="Connectivity",t[t.MessageSent="message-sent"]="MessageSent",t[t.MessageReceived="message-received"]="MessageReceived",t[t.MessageUpdated="message-updated"]="MessageUpdated",t[t.MessageChatMarker="message-chat-marker"]="MessageChatMarker",t[t.ProcessingReceived="processing-received"]="ProcessingReceived",t[t.ProcessingUpdated="processing-updated"]="ProcessingUpdated",t[t.ProcessingChatMarker="processing-chat-marker"]="ProcessingChatMarker",t[t.Status="status"]="Status",t[t.Presence="presence"]="Presence",t[t.Participation="participation"]="Participation",t[t.Mam="mam"]="Mam",t[t.CleanUp="clean-up"]="CleanUp",t[t.XmppClient="xmpp-client"]="XmppClient",t[t.Events="events"]="Events",t[t.DataStorage="data-storage"]="DataStorage",t[t.Other="other"]="Other"}(e.LoggerTypes||(e.LoggerTypes={})),e.Logger=class{constructor(t=null){this._types=t||[],this._initialTypes=t}log(t,...e){this.shouldLog(t)&&console.log.call(null,...e)}info(t,...e){this.shouldLog(t)&&console.info.call(null,...e)}debug(t,...e){this.shouldLog(t)&&console.debug.call(null,...e)}error(...t){console.error.call(null,...t)}group(t,e=!1,i="",...n){this.shouldLog(t)&&(e?console.group.call(null,i,...n):console.groupCollapsed.call(null,i,...n))}groupEnd(t){this.shouldLog(t)&&console.groupEnd.call(null)}getTypes(){return this._types}hasInitialTypes(){return this._initialTypes&&this._initialTypes.length>0}getTypesAsEnumValues(){return this._types.map(t=>n.enumFromString(t))}setTypes(t){this._types=t||[]}resetTypes(){this._types=this._initialTypes}shouldLog(t){return!(!this._types||!this._types.length)&&(!!this._types.includes("_all_")||this._types.includes(t.toString()))}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(12);var o;!function(t){t[t.E_IQ_TYPE_INVALID="Unknown request"]="E_IQ_TYPE_INVALID",t[t.E_IQ_SUB_EL_MISSING="Request has missing data"]="E_IQ_SUB_EL_MISSING",t[t.E_IQ_SUB_EL_UNKNOWN="Request has unknown data"]="E_IQ_SUB_EL_UNKNOWN",t[t.E_CONV_NOT_FOUND="The conversation could not be found"]="E_CONV_NOT_FOUND",t[t.E_CONV_TYPE="Unable to perform operation on this type of conversation"]="E_CONV_TYPE",t[t.E_CONV_ROLE="You are not permitted to perform that operation"]="E_CONV_ROLE",t[t.E_CREATION_FAILED="Could not create conversation"]="E_CREATION_FAILED",t[t.E_CREATOR_NOT_PARTICIPANT="Could not create conversation - the creator was not included as a participant"]="E_CREATOR_NOT_PARTICIPANT",t[t.E_PARTICIPANTS_NOT_MEMBERS="Could not create conversation - all participants must be in the participant role"]="E_PARTICIPANTS_NOT_MEMBERS",t[t.E_CONV_SELF="You are not permitted to change your own role"]="E_CONV_SELF",t[t.E_CONV_NO_OWNER="You cannot leave this conversation as you are the only owner"]="E_CONV_NO_OWNER",t[t.E_NO_CONNECTION_DELETING_DIRECT="You cannot delete a direct conversation when you are offline."]="E_NO_CONNECTION_DELETING_DIRECT",t[t.E_UNKNOWN="An unknown error occurred"]="E_UNKNOWN"}(o=e.ChatErrorsI18nKeys||(e.ChatErrorsI18nKeys={})),e.ChatErrorsMetadata=new n.Metadata("ChatErrors",o),e.getErrorMessage=function(t,i){const n=o[t]||o.E_UNKNOWN;return i.translateI18nItem(e.ChatErrorsMetadata.getI18nItem(n))}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(12);e.component=function(t){return e=>(customElements.get(t.tag)||customElements.define(t.tag,e),e.prototype.styles=t.styles,t.i18nKeys&&(e.prototype._metadata=new n.Metadata(e.name,t.i18nKeys),function(t,e){window.translationData||(window.translationData=new Map),window.translationData.set(t,e)}(e.name,e.prototype._metadata)),class extends e{static get is(){return t.tag}static set styles(t){this.styles=t}static set _metadata(t){this._metadata=t}})}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(12);var o;!function(t){t[t.TODAY="Today"]="TODAY",t[t.YESTERDAY="Yesterday"]="YESTERDAY",t[t.ARE_YOU_SURE="Are you sure?"]="ARE_YOU_SURE",t[t.PLEASE_WAIT="Please wait..."]="PLEASE_WAIT",t[t.AUTHENTICATING="Authenticating..."]="AUTHENTICATING",t[t.SYNCING="Syncing with server..."]="SYNCING",t[t.LOGIN_ERROR_TITLE="Error logging in"]="LOGIN_ERROR_TITLE",t[t.LOGIN_ERROR_GENERIC="Check your connectivity and credentials and try again."]="LOGIN_ERROR_GENERIC",t[t.USER_NOT_FOUND="User {{username}} was not found."]="USER_NOT_FOUND",t[t.FETCH_ERROR="Error fetching data"]="FETCH_ERROR",t[t.LOGIN_TIMEOUT="Logging in took longer than expected. Please check your connectivity and log in again."]="LOGIN_TIMEOUT",t[t.LOGOUT_ERROR_TITLE="Error logging out"]="LOGOUT_ERROR_TITLE",t[t.UPLOAD_ERROR_TITLE="Upload Error"]="UPLOAD_ERROR_TITLE",t[t.UPLOAD_ERROR_DESCRIPTION="Uploading your file failed. Please try again or try a different file."]="UPLOAD_ERROR_DESCRIPTION",t[t.ERROR="Error"]="ERROR"}(o=e.CommonI18nKeys||(e.CommonI18nKeys={})),e.CommonMetadata=new n.Metadata("Common",o)},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(12),r=i(0),a=i(13),c=i(6),l=i(4),d=i(1),h=i(9);var u;!function(t){t[t.ONLINE="Online"]="ONLINE",t[t.OFFLINE="Offline"]="OFFLINE",t[t.RECONNECTING="Reconnecting"]="RECONNECTING"}(u||(u={}));class p{static _create(){return new s.Metadata(g,u)}static get instance(){return this._instance||(this._instance=this._create())}}p._instance=null,e.CTCLHeaderMetadata=p;class g extends a.CTCLComponent{constructor(){super(),this.setMetadata(p.instance)}static get is(){return"ct-cl-header"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){this.setupConnectionStatusListener(()=>{clearTimeout(this._reconnectTimeout)})}get generateComponentStyles(){return i(243)}generateComponentMarkup(){const t=["header",...this._getConnectionStatusCssClasses()],e=h.buildStyles({backgroundColor:this.backgroundColor});return window.__CTRender("div",{class:t.join(" "),style:e},window.__CTRender("div",{class:"left-action"},window.__CTRender("slot",{name:"left-action"})),window.__CTRender("div",{class:"details"},window.__CTRender("div",{class:"heading"},window.__CTRender("slot",{name:"heading"})),window.__CTRender("div",{class:"sub-heading"},window.__CTRender("slot",{name:"sub-heading"})),window.__CTRender("div",{class:"status",onClick:this._onClickReconnectNow.bind(this)},window.__CTRender("div",{class:"label"},this._getConnectionStatusLabel()),window.__CTRender(l.CTIcon,{class:"icon",width:"10",height:"10",icon:c.Icons.UI.Reconnect,spin:this.connectionStatus===r.ConnectionStatus.Connecting}))),window.__CTRender("div",{class:"right-action"},window.__CTRender("slot",{name:"right-action"})))}_onClickReconnectNow(){this.connectionStatus===r.ConnectionStatus.Disconnected&&(this.connectionStatus=r.ConnectionStatus.Connecting,clearTimeout(this._reconnectTimeout),this._reconnectTimeout=setTimeout(()=>{this.layer.attemptReconnect()},500))}_getConnectionStatusCssClasses(){switch(this.connectionStatus){case r.ConnectionStatus.Disconnected:return["offline disconnected"];case r.ConnectionStatus.Disconnecting:return["offline disconnecting"];case r.ConnectionStatus.Connecting:return["offline connecting"];case r.ConnectionStatus.Connected:return["online connected"]}}_getConnectionStatusLabel(){switch(this.connectionStatus){case r.ConnectionStatus.Connected:return this.translateI18nItem(u.ONLINE);case r.ConnectionStatus.Connecting:case r.ConnectionStatus.Disconnecting:case r.ConnectionStatus.Disconnected:return this.translateI18nItem(u.OFFLINE)}}}n([d.prop({type:String,attribute:!0,default:null})],g.prototype,"backgroundColor",void 0),e.CTCLHeader=g,g.register()},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(39),o=i(68),s=i(40),r=i(31),a=i(23),c=i(78),l=i(79),d=i(32),h=i(82);if(!window.Promise)throw new Error("ct-xmpp-client.js has a dependency on Promise, did you forget to include the polyfill?");if(!window.PouchDB)throw new Error("ct-xmpp-client.js has a dependency on PouchDB, please ensure PouchDB is included before ct-xmpp-client.js");class u{constructor(t,e,i){if(this._userDirectory=null,this._includeStanzaFilters=[],this._excludeStanzaFilters=[],this._pushNodeName=null,this._lastStatusId=null,this._pingInterval=null,this._pingTimeout=null,this._alreadyReLoggingIn=!1,this._reLoginTimeout=null,this._reLoginBackOff=3e3,this._forcedLogout=!1,this._sendTimeouts={},this._sendStanzaPromises={},this._destroyingDbs=!1,this._joinedRooms={},this._saveDebounce={},this._botCommandTimeouts={},this._botCommandPromises={},this._initialised=!1,!t)throw new Error("An instance ID must be provided.");this._instanceId=t;let s=localStorage.getItem(`${this._instanceId}_last_archive_id`);if(null===s&&(s="0"),this._lastArchiveId=s,!e)throw new Error("XMPP server hostname must be provided.");this._serverTimeDiff=null,this._eventListeners={},this._options=u._merge({sendTimeout:3e5,debug:!1,perfLogging:!1,mucHost:null,uploadHost:null,echoHost:null,authAttachments:!1,mam:{auto:!0,defaultTimeLimit:2628e6,pageSize:250},push:{androidEnabled:!1,packageId:"",senderId:"",iosEnabled:!1},enablePing:!0,pingInterval:5e3,pingTimeout:1e4,connectTimeout:7e3,autoLogin:!1,autoReconnect:!0,autoMarkMessages:!0,encryption:!1,fileEncryption:!1,autoDownloadAttachmentTime:-1,autoPurgeOldMessagesAge:-1,autoPurgeOldMessagesCount:-1,streamResumption:!0,useEncodedJidAsResource:!1,adSpn:null,adSecurityPackage:null,adTokenPlaceholder:"[[AD_PASSWORD_TOKEN]]",updateUserDirectoryOnLogin:!1,enableMessageCarbons:!1,maxReconnectBackoff:3e5,stropheLogging:!1,forceIndexedDb:!1,bringToForegroundOnVoipPush:!0,updateUserDirectoryInterval:18e5,useConnectionEvents:!0,autoResumeTimers:!0,maxStreamResumptionTime:null,alwaysSendPresence:!1,updateRosterOnLogin:!0},i),this._endpoint=e,this._connection=null,this.connected=!1,this.loggedIn=!1,this._reLoggingIn=!1,this._loggingOut=!1,this._jid=null,this.resource=null,this._bareJid=null,this.username=null,this._userDirectory=new l.UsersDirectory(this._instanceId,this._options.debug),!0===this._options.stropheLogging&&(o.default.Strophe.log=((t,e)=>{this._log(`[${t}]: ${e}`)})),n.Promise.all([this._getInstallId(),this._initDbs()]).then(()=>{this._initialised=!0,this._log("XMPP client successfully initialised.");const t=[this._getCacheItem("user_jid"),this._getCacheItem("user_password")];n.Promise.all(t).then(t=>{const e=t[0],i=t[1];if(e){const t=o.default.Strophe.getBareJidFromJid(e);this.getUserByJid(t).then(i=>{this._dispatchEvent(u.EVENT_TYPES.INITIALISED,{jid:e,bareJid:t,user:i})}).catch(t=>{this._onError("Couldn't get user object for current user during initialise:"+t)})}else this._dispatchEvent(u.EVENT_TYPES.INITIALISED,null);!0===this._options.autoLogin&&void 0!==e&&void 0!==i&&this._reLogin()}).catch(t=>{this._onError("Unable to get jid/pw: "+t)})}).catch(t=>{throw new Error(t)}),this._options.useConnectionEvents&&(document.addEventListener("offline",()=>{this._onOffline()},!1),document.addEventListener("online",()=>{this._onOnline()},!1))}set sendTimeout(t){t!==this._options.sendTimeout&&(this._options.sendTimeout=t)}get status(){return this._isMethodReady(!0),this._getCacheItem("connection_status")}get bareJid(){return this._bareJid}get mucHost(){return this._options.mucHost}addIncludeStanzaFilter(t){this._includeStanzaFilters.push(t)}addExcludeStanzaFilter(t){this._excludeStanzaFilters.push(t)}_onOffline(){this._connection._doDisconnect()}_onOnline(){this.connected||this.reLoginNow()}_getInstallId(){return new n.Promise((t,e)=>{const i=localStorage.getItem(`${this._instanceId}_install_id`);if(null!==i)return this._installId=i,t();{let i=this;if("ios"===s.getPlatformName()){const n=a.getSource("securesettings");n.get(o=>{if("string"==typeof o)i._installId=o,localStorage.setItem(`${i._instanceId}_install_id`,i._installId),t();else{const o=d.generateGuid();n.set(()=>{i._installId=o,localStorage.setItem(`${i._instanceId}_install_id`,i._installId),t()},t=>{e(t)},"install_id",o)}},t=>{i._log("Secure settings error:",t),e(t)},"install_id")}else if("android"===s.getPlatformName()){const e=a.getSource("device");this._installId=e.uuid,localStorage.setItem(`${this._instanceId}_install_id`,this._installId),t()}else{const e=d.generateGuid();i._installId=e,localStorage.setItem(`${this._instanceId}_install_id`,this._installId),t()}}})}_initDbs(){return new n.Promise((t,e)=>{const i={auto_compaction:!1,revs_limit:1};this._msgDb=new window.PouchDB(`${this._instanceId}_messages`,i),this._contactDb=new window.PouchDB(`${this._instanceId}_contacts`,i),this._cacheDb=new window.PouchDB(`${this._instanceId}_cache`,i),this._cache={},this._roomDb=new window.PouchDB(`${this._instanceId}_rooms`,i),this._participantDb=new window.PouchDB(`${this._instanceId}_participants`,i);const o=[];o.push(this._msgDb.compact()),o.push(this._contactDb.compact()),o.push(this._cacheDb.compact()),o.push(this._roomDb.compact()),o.push(this._participantDb.compact()),n.Promise.all(o).then(i=>{this._log(`Compaction results: ${i}`),!0===this._options.encryption?d.getEncryptionKey(this._instanceId).then(e=>{this._cacheDb.crypto({key:e}),this._msgDb.crypto({key:e}),this._contactDb.crypto({key:e}),this._roomDb.crypto({key:e}),this._participantDb.crypto({key:e}),t()}).catch(e):(console.warn("Encryption has not been enabled! If you have auto-reconnect, auto-login or authenticated attachments enabled your password will be stored unencrypted! "),t())}).catch(t=>{this._log(`Compaction errors: ${t}`),e(t)})})}_setStatus(t,e=!0,i=null){return new n.Promise((n,s)=>{if(this._lastStatusId===t)n();else{const r={id:t,label:null,reason:i};switch(t){case o.default.Strophe.Status.CONNECTING:r.label="Connecting";break;case o.default.Strophe.Status.CONNFAIL:r.label="Connection failed";break;case o.default.Strophe.Status.DISCONNECTING:r.label="Disconnecting";break;case o.default.Strophe.Status.DISCONNECTED:r.label="Disconnected";break;case o.default.Strophe.Status.CONNECTED:r.label="Connected";break;case o.default.Strophe.Status.AUTHFAIL:r.label="Authentication failed.";break;case o.default.Strophe.Status.ERROR:r.label=i||"An unknown error occurred."}this._lastStatusId!==r.id&&!1!==e&&this._dispatchEvent(u.EVENT_TYPES.STATUS,r),this._lastStatusId=r.id,this._setCacheItem("connection_status",r).then(n).catch(s)}})}static _isReasonToReconnect(t){if(!t||"string"!=typeof t)return!0;let e=!0;switch(t.toLowerCase()){case"kicked by administrator":case"replaced by new connection":case"conflict":e=!1}return e}static _translateCondition(t){if(!t)return null;switch(t.toLowerCase()){case"conflict":return"You already have an active session. Please log out of any previous sessions or wait for the previous login attempt to timeout.";case"system-shutdown":return"Remote server was shut down.";case"connection-timeout":return"The connection to the server timed out.";case"socket closed, probably due to no network connectivity.":case"invalid username or password":case"kicked by administrator":return t;default:return"Connection closed unexpectedly."}}_connect(t,e){return new n.Promise((i,s)=>{this._connection&&this._connection.connected&&this._connection._doDisconnect(),this._connection=new o.default.Strophe.Connection(this._endpoint,{instance_id:this._instanceId}),this._connection.addHandler(this._onStanza.bind(this),null,"message"),this._connection.addHandler(t=>this._onPresence(u.xmlToJson(t)),null,"presence"),this._connection.addHandler(t=>this._onIq(u.xmlToJson(t)),null,"iq");const r=setTimeout(()=>{this._connection._doDisconnect(),s("Connection took more than 5 seconds to be established, connection closed.")},this._options.connectTimeout);(!0===this._options.streamResumption?this._getCacheItem("stream_management_id"):n.Promise.resolve()).then(n=>{this._connection.streamManagement.prevId=n;let a=!1;this._forcedLogout&&(!0===this._options.useEncodedJidAsResource&&(this._connection.override=!0),this._forcedLogout=!1),this._connection.connect(t,e,(t,e)=>{if(!0!==this._reLoggingIn&&this._setStatus(t,!0,e),!0===a)return!1;switch(t){case o.default.Strophe.Status.ERROR:case o.default.Strophe.Status.AUTHFAIL:case o.default.Strophe.Status.CONNFAIL:case o.default.Strophe.Status.DISCONNECTED:const n=u._translateCondition(e);let c="Connection Disconnected";t===o.default.Strophe.Status.ERROR&&(c="Connection Error",this._onError(c,n)),t===o.default.Strophe.Status.AUTHFAIL&&(c="Authentication Failed"),t===o.default.Strophe.Status.CONNFAIL&&(c="Connection Failed"),null!==n&&(c+=": "+n);const l=(t,e)=>{const i=e[t];i.pauseable?i.paused||(this._log(`Pausing timer for request with ID '${t}'...`),i.pause()):(this._log(`Ending timer for request with ID '${t}'...`),i.end())};Object.keys(this._sendTimeouts).length>0&&Object.keys(this._sendTimeouts).forEach(t=>l(t,this._sendTimeouts)),Object.keys(this._botCommandTimeouts).length>0&&Object.keys(this._botCommandTimeouts).forEach(t=>l(t,this._botCommandTimeouts)),clearTimeout(r),this.connected=!1,this._stopPing(),this._log("Disconnected:",e),this._alreadyReLoggingIn=!1,!1===this._loggingOut&&!0===this._options.autoReconnect&&t!==o.default.Strophe.Status.AUTHFAIL&&!0===u._isReasonToReconnect(e)&&(this._log("Attempting to re-login..."),this._reLogin()),a=!0,s({msg:c,status:t,condition:e});break;case o.default.Strophe.Status.CONNECTED:clearTimeout(r),this.connected=!0,i(e)}})})})}_enableStreamManagement(){return new n.Promise((t,e)=>{const i=t=>{t.id===o.default.Strophe.Status.DISCONNECTED&&(this.removeEventListener(u.EVENT_TYPES.STATUS,i),e("Disconnected during stream management enabling."))};if(this.addEventListener(u.EVENT_TYPES.STATUS,i),!1===this.connected||null===this._connection)e("You must have an active connection to enable stream management");else{if(!this._connection.streamManagement)throw new Error("Stream management is required.");try{this._connection.addHandler(e=>(this._log("Stream resumption enabled!"),this._setCacheItem("stream_management_id",e.getAttribute("id")).then(()=>{this.removeEventListener(u.EVENT_TYPES.STATUS,i),t()}),!1),"urn:xmpp:sm:3","enabled"),this._connection.streamManagement.enable(this._options.maxStreamResumptionTime)}catch(t){console.error(t),e()}}})}_enableMessageCarbons(){return this.sendIq(null,"set",{enable:{$attributes:{xmlns:u.NAMESPACES.CARBONS},$value:""}})}_initialisePing(){return new n.Promise(t=>{!0===this._options.enablePing&&(null!==this._pingInterval&&clearInterval(this._pingInterval),this._pingInterval=setTimeout(()=>{this._sendPing().then(()=>{this._initialisePing()}).catch(()=>{this._log("Ping failed."),!0===this._options.autoReconnect&&(this._log("Auto-reconnect enabled, so let's try and reconnect!"),this._connection&&this._connection._doDisconnect(),this._reLogin())})},this._options.pingInterval)),t()})}_sendPing(){return new n.Promise((t,e)=>{this._pingTimeout=setTimeout(()=>{this.connected?(this.connected=!1,this._setStatus(o.default.Strophe.Status.DISCONNECTED),!0===this._options.autoReconnect&&this._setStatus(o.default.Strophe.Status.CONNECTING),e()):t()},this._options.pingTimeout),this.sendIq(this._domain,"get",{ping:{$attributes:{xmlns:u.NAMESPACES.PING}}}).then(()=>{clearTimeout(this._pingTimeout),t()}).catch(e)})}_makeParticipantsOffline(){return new n.Promise((t,e)=>{this._participantDb.allDocs({include_docs:!0}).then(i=>{const n=i.rows.filter(t=>!t.doc.language).map(t=>(t.doc.online=!1,t.doc));this._participantDb.bulkDocs(n).then(t).catch(t=>{this._onError("Unable to bulk update participants to offline status.",t),e(t)})}).catch(t=>{this._onError("Unable to get participants from database.",t),e(t)})})}_makeContactsOffline(){return new n.Promise((t,e)=>{this.getContacts().then(i=>{i.forEach(t=>{t.online=!1}),this._contactDb.bulkDocs(i).then(function(){t()}).catch(t=>{this._onError("Unable to bulk update contacts to offline status.",t),e(t)})}).catch(t=>{this._onError("Unable to get contacts from database.",t),e(t)})})}resumeTimers(){Object.keys(this._sendTimeouts).length>0&&Object.keys(this._sendTimeouts).forEach(t=>{const e=this._sendTimeouts[t];e.paused&&(this._log(`Resuming send timer for request with ID '${e.id}'...`),e.resume())}),Object.keys(this._botCommandTimeouts).length>0&&Object.keys(this._botCommandTimeouts).forEach(t=>{const e=this._botCommandTimeouts[t];e.paused&&(this._log(`Resuming bot command timer for request with ID '${e.id}'...`),e.resume())})}reLoginNow(){if(this._alreadyReLoggingIn)return void this._log("Not executing reLoginNow() because _alreadyReLoggingIn is currently 'true'.");this._alreadyReLoggingIn=!0,this._clearReLoginTimeout();const t=[this._getCacheItem("user_jid"),this._getCacheItem("user_password")];n.Promise.all(t).then(t=>{const e=t[0],i=t[1];void 0!==e&&void 0!==i&&(this._log(`Auto-logging in with JID '${e}'.`),this._setStatus(o.default.Strophe.Status.CONNECTING),this._login(e,i,!0).then(t=>{this._reLoginBackOff=3e3,this._log("Auto-login success."),this._reLoggingIn=!1,this.connected=!0;const e=[];for(let t in this._joinedRooms)e.push(this.joinRoom(t));n.Promise.all(e).then(()=>{this._setStatus(o.default.Strophe.Status.CONNECTED).then(()=>{!1!==this._options.autoResumeTimers&&this.resumeTimers(),this._dispatchEvent(u.EVENT_TYPES.AUTO_RECONNECTED,{resumed:t}),this._alreadyReLoggingIn=!1}).catch(t=>{this._alreadyReLoggingIn=!1,console.error("Couldn't set connection status:",t)})}).catch(t=>{this._onError("Couldn't join all rooms on re-login, logging out.",t),this.logout(),this._alreadyReLoggingIn=!1})}).catch(t=>{if(this._alreadyReLoggingIn=!1,t.status==o.default.Strophe.Status.AUTHFAIL){const e={id:o.default.Strophe.Status.DISCONNECTED,label:"Authentication Failed.",wontReconnect:!0,reason:t.condition};this._dispatchEvent(u.EVENT_TYPES.STATUS,e)}else this._reLoginBackOff+=3e3,this._reLoginBackOff>this._options.maxReconnectBackoff&&(this._reLoginBackOff=this._options.maxReconnectBackoff),this._log(`Couldn't re-login, trying again in ${this._reLoginBackOff/1e3} seconds...`),this._reLogin()}))}).catch(t=>{this._onError("Couldn't get user JID or user password for re-login!",t)})}_reLogin(){if(!0!==this._loggingOut){if(this._reLoggingIn=!0,this._clearReLoginTimeout(),this._log("Re-login back off time is:",this._reLoginBackOff),this._reLoginBackOff>0){const t={id:o.default.Strophe.Status.DISCONNECTED,label:"Disconnected",reconnectTime:this._reLoginBackOff};this._dispatchEvent(u.EVENT_TYPES.STATUS,t)}this._reLoginTimeout=setTimeout(()=>{this._log("Calling reLoginNow()..."),this.reLoginNow()},this._reLoginBackOff)}else this._log("Not executing _reLogin because _loggingOut is currently 'true'.")}_clearReLoginTimeout(){null!==this._reLoginTimeout&&(clearTimeout(this._reLoginTimeout),this._reLoginTimeout=null)}_stopPing(){null!==this._pingTimeout&&clearTimeout(this._pingTimeout),null!==this._pingInterval&&clearInterval(this._pingInterval)}_createPresenceObject(){return new n.Promise((t,e)=>{const i={$attributes:{from:this._jid,xmlns:u.NAMESPACES.JABBER_CLIENT},show:"chat",status:"Available"};this._getCacheItem("chat_status").then(e=>{void 0!==e&&(e.status&&(i.show=e.status),e.label&&(i.status=e.label),e.metadata&&(i.metadata=u._merge({$attributes:{xmlns:u.NAMESPACES.CT_METADATA}},e.metadata))),t(i)}).catch(t=>{this._onError("Couldn't get chat status to construct presence object!",t),e(t)})})}sendPresence(){return this._sendPresence()}uploadAttachment(t){if(!this._options.uploadHost)throw new Error("Cannot send attachments without a upload host configured.");let e=n.Promise.resolve({}),i=null;return e=e.then(()=>new n.Promise((e,n)=>{r.getFileInfo(t).then(t=>{i=t,e()}).catch(n)})).then(()=>new n.Promise((t,e)=>{r.getFileSize(i).then(n=>{const o={$attributes:{id:this.getUniqueId(),to:this._options.uploadHost,from:this._jid,type:"get",xmlns:u.NAMESPACES.JABBER_CLIENT},request:{$attributes:{xmlns:u.NAMESPACES.HTTP_UPLOAD},filename:i.name.replace(".encrypted",""),size:""+n,"content-type":i.type}};this.sendIq(this._options.uploadHost,"get",o).then(t).catch(e)}).catch(t=>{console.error(`Couldn't get file size for file with name '${i.name}'.`,t),e(t)})})).then(t=>new n.Promise(e=>{!0===this._options.authAttachments?this._getCacheItem("user_password").then(t=>this._embellishPasswordWithAdToken(t)).then(n=>{e([t,{Authorization:"Basic "+btoa(this._bareJid+":"+n),"Content-Type":i.type}])}):e([t,{"Content-Type":i.type}])})).then(t=>{const e=t[0],o=t[1];return new n.Promise((t,n)=>{const s=e.iq.slot.put,a=e.iq.slot.get;r.upload(i.path,s,a,o).then(()=>{this._dispatchEvent(u.EVENT_TYPES.UPLOAD_SUCCESS,i.path),t(a)}).catch(t=>{this._dispatchEvent(u.EVENT_TYPES.UPLOAD_FAILED,i.path);const e=`Couldn't successfully upload file '${i.path}' to the server:`;this._onError(e,t),n({error:e})})})}),new n.Promise((t,i)=>e.then(t).catch(i))}_sendPresence(){return this._log("Sending presence..."),new n.Promise((t,e)=>{this._log("Creating presence object..."),this._createPresenceObject().then(i=>{this._log("Presence object created:",i),this.sendStanza(i,!1,"presence",!1,!1).then(()=>{this._log("Presence sent!"),this._log("Sending presence for all rooms...");const o=[];for(let t in this._joinedRooms)i.$attributes.to=`${t}@${this._options.mucHost}`,i.x={$attributes:{xmlns:u.NAMESPACES.MUC}},o.push(this.sendStanza(i,!1,"presence",!1,!1));n.Promise.all(o).then(()=>{this._log("Finished sending presence(s)."),t()}).catch(t=>{this._onError("Couldn't send all presence objects:",t),e(t)})}).catch(t=>{this._onError("Couldn't send initial presence object:",t),e(t)})}).catch(t=>{this._onError("Couldn't create presence object:",t),e(t)})})}getServerTime(){return this._isMethodReady(!0,!0),new n.Promise((t,e)=>{this.sendIq(this._domain,"get",{time:{$attributes:{xmlns:u.NAMESPACES.TIME}}}).then(e=>{if(void 0!==e.iq.time&&e.iq.time.utc){const t=new Date(e.iq.time.utc).valueOf(),i=Date.now();this._serverTimeDiff=t-i}t(this._serverTimeDiff)}).catch(e)})}getSyncedTimestamp(t){if(null===this._serverTimeDiff)return t;const e=Math.abs(this._serverTimeDiff);return this._serverTimeDiff>=0?t+e:t-e}login(t,e){return this._login(t,e,!1)}_login(t,e,i=!1){if(this._isMethodReady(!0),!t)throw new Error("Parameter 'jid' must be provided.");if(!e)throw new Error("Parameter 'password' must be provided.");return!0===this._reLoggingIn&&!1===i&&(this._clearReLoginTimeout(),this._reLoggingIn=!1),this._loggingOut=!1,new n.Promise((i,r)=>{this._getInstallId().then(()=>{this._getCacheItem("user_jid").then(a=>{if(!0===this.connected&&!0===this.loggedIn&&a===o.default.Strophe.getBareJidFromJid(t))i(!1);else{const c=o.default.Strophe.getResourceFromJid(t);if(null!==c)this.resource=c,this._jid=t,this._bareJid=o.default.getBareJidFromJid(this._jid);else{if(this._bareJid=t,!0===this._options.useEncodedJidAsResource)this.resource=btoa(this._bareJid);else{const t=localStorage.getItem(`${this._instanceId}_resource`);null===t?(this.resource=this._installId,localStorage.setItem(`${this._instanceId}_resource`,this.resource)):this.resource=t}this._jid=this._bareJid+"/"+this.resource}const l=()=>{this.loggedIn=!0,localStorage.removeItem(`${this._instanceId}_logging_in`)};this.username=o.default.Strophe.getNodeFromJid(this._jid),this._domain=this._bareJid.split("@")[1];const d=()=>{let o=!1;const a=null!==localStorage.getItem(`${this._instanceId}_logging_in`);a&&this._log("Previous login attempt failed, calling a force logout to clean-up."),this.logout(a,!0).then(()=>this._embellishPasswordWithAdToken(e)).then(t=>this._connect(this._jid,t).then(t=>{o="resumed"===t,localStorage.setItem(`${this._instanceId}_logging_in`,"true")})).then(()=>!1===o?this._enableStreamManagement():n.Promise.resolve()).then(()=>!1===o&&!0===this._options.enableMessageCarbons?this._enableMessageCarbons():n.Promise.resolve()).then(()=>!1===o?this.getServerTime():n.Promise.resolve()).then(()=>!1===o?this._setCacheItem("user_jid",this._bareJid):n.Promise.resolve()).then(()=>new n.Promise((t,i)=>{!1!==o||!0!==this._options.autoReconnect&&!0!==this._options.autoLogin&&!0!==this._options.authAttachments?t():this._setCacheItem("user_password",e,!0).then(t).catch(i)})).then(()=>o?void 0:n.Promise.all([this._makeContactsOffline(),this._makeParticipantsOffline()])).then(()=>new n.Promise((t,e)=>{!o&&this.isPushEnabled()?this._getPushTokens().then(t=>this.registerForPush(t)).then(()=>{t()}).catch(e=>{this._log("Failed to register for push: "+e),t()}):t()})).then(()=>this._initialisePing()).then(()=>!0===this._options.updateUserDirectoryOnLogin?this.updateUserDirectory():n.Promise.resolve()).then(()=>!1===o&&!1!==this._options.updateRosterOnLogin?this._getCacheItem("roster_version").then(t=>this.sendIq(this._bareJid,"get",{query:{$attributes:{xmlns:"jabber:iq:roster",ver:t||""}}})):n.Promise.resolve()).then(t=>this._processRoster(t)).then(()=>new n.Promise((t,e)=>{if(!1===o&&!1!==this._options.mam.auto){const i=this.getLastArchiveId();this.listSubscriptions().then(o=>{const s=[];o.forEach(t=>{s.push(this.queryMamByRoomName(t.name,!0,i))}),n.Promise.all(s).then(()=>{this.queryMam(null,i).then(t).catch(t=>{this._onError("Unable to query the MAM for missed messages.",t),e(t)})}).catch(t=>{this._onError("Unable to query the MAM for missed messages in a subscribed room.",t),e(t)})}).catch(t=>{this._onError("Unable to get a list of subscriptions.",t),e(t)})}else t()})).then(()=>{"ios"===s.getPlatformName()&&window.VoIPPushNotification.suppressProcessing(!1,function(){}),l(),i(o)}).catch(e=>{null!==this._connection&&!0===this._connection.connected&&(this._connection._doDisconnect(),this._connection=null),this._onError(`Unable to complete login process with JID '${t}'.`,e.msg),r(e)})};void 0!==a&&a!==this._bareJid?this._clearDbsForNewUser().then(()=>{d()}):d()}}).catch(r)}).catch(r)})}isPushEnabled(){return!(!this._options.push.androidEnabled||"android"!==s.getPlatformName())||!(!this._options.push.iosEnabled||"ios"!==s.getPlatformName())}logout(t=!1,e=!1){return new n.Promise((i,o)=>{const r=()=>{this._joinedRooms={},this._reLoggingIn=!1,this.connected=!1,this.loggedIn=!1,this._stopPing(),this._clearReLoginTimeout(),"ios"===s.getPlatformName()&&window.VoIPPushNotification.suppressProcessing(!0,function(){}),localStorage.removeItem(`${this._instanceId}_logging_in`);const t=[this._deleteCacheItem("stream_management_id")];!0!==e&&t.push(this._deleteCacheItem("user_password")),n.Promise.all(t).then(()=>{this._loggingOut=!1,i()}).catch(o)};if(!0===t||!1!==this.connected&&!0!==this._loggingOut)if(null!==this._connection&&!0===this._connection.connected&&!1===this._loggingOut){this._loggingOut=!0;const t=()=>{this._stopPing(),this._clearReLoginTimeout(),this._connection.disconnect("user_logout"),this._connection=null,r()};this.isPushEnabled()?this.disablePush().then(()=>{t()}).catch(e=>{this._log(`Unable to disable push notifications: ${e}`),t()}):t()}else r();else i()})}forceLogout(){return new n.Promise((t,e)=>{this._forcedLogout=!0,this._loggingOut=!0,this._joinedRooms={},this._reLoggingIn=!1,this.connected=!1,this.loggedIn=!1,this._stopPing(),this._clearReLoginTimeout(),localStorage.removeItem(`${this._instanceId}_logging_in`),this._connection&&(this._connection.disconnect("user_logout"),this._connection=null),n.Promise.all([this._deleteCacheItem("stream_management_id"),this._deleteCacheItem("user_password")]).then(()=>{this._loggingOut=!1,t()}).catch(e)})}resendMessage(t){return this._isMethodReady(!0,!0),new n.Promise((e,i)=>{this.getMessageById(t).then(n=>{this._log(`Resending message with ID '${t}':`,n);const o={$attributes:{id:n._id,to:n.recipient_id,from:n.sender_id,type:n.type,xmlns:u.NAMESPACES.JABBER_CLIENT},markable:{$attributes:{xmlns:u.NAMESPACES.CHAT_MARKERS}},body:n.body,data:n.data,attachments:[]};void 0!==n.addresses&&(o.addresses={$attributes:{xmlns:u.NAMESPACES.ADDRESS},address:n.addresses}),n.attachments.forEach(t=>{o.attachments.push({name:t.name,type:t.type,size:""+t.size,get:t.get})}),this.sendStanza(o).then(()=>{e(n)}).catch(i)}).catch(i)})}_stanzaResponseHandler(t,e){this._sendTimeouts[t]&&(this._log(`Clearing send timeout for message with ID '${t}'.`),this._sendTimeouts[t].cancel(),delete this._sendTimeouts[t]),e?this._rejectSendStanzaPromise(t,e):this._resolveSendStanzaPromise(t)}_resolveSendStanzaPromise(t,e){this._sendStanzaPromises[t]&&(this._log(`Resolving send stanza promise for message with ID '${t}'.`),this._sendStanzaPromises[t].resolve(e),delete this._sendStanzaPromises[t],this._sendTimeouts[t]&&delete this._sendTimeouts[t])}_rejectSendStanzaPromise(t,e){this._sendStanzaPromises[t]&&(this._log(`Rejecting send stanza promise for message with ID '${t}'.`),this._sendStanzaPromises[t].reject(e),delete this._sendStanzaPromises[t],this._sendTimeouts[t]&&delete this._sendTimeouts[t])}sendStanza(t,e=!0,i="message",o=!0,s=!0){return this._isMethodReady(!0,!0),new n.Promise((n,r)=>{t.$attributes||(t.$attributes={}),void 0===t.$attributes.id&&(t.$attributes.id=this.getUniqueId());let a=t.$attributes.id;if(!0===this.connected&&null!==this._connection){this._sendStanzaPromises[a]={resolve:n,reject:r},this._sendTimeouts[a]=new c.default(a,()=>{const e=`${i.replace(/^\w/,t=>t.toUpperCase())} with ID '${a}' was not received by the server within ${this._options.sendTimeout}ms.`;this._log(e,t),this._rejectSendStanzaPromise(a,e)},this._options.sendTimeout,s);try{void 0===t.$attributes&&(t.$attributes={}),void 0===t.$attributes.from&&(t.$attributes.from=this._jid),!0===e&&(t.store={$attributes:{xmlns:u.NAMESPACES.HINTS},$value:""}),!0===o&&(t.timestamp={$attributes:{xmlns:u.NAMESPACES.CT_CLIENT_TIMESTAMP},$value:Date.now()});const n=u.jsonToXml(i,t);this._connection.send(n)}catch(t){const e=`Unable to send XMPP ${i}`;this._onError(e,t),this._rejectSendStanzaPromise(a,e)}}else{const t="You're not currently connected, please connect and try again.";this._onError(t),this._rejectSendStanzaPromise(a,t)}})}_sendMessageWithAttachments(t,e){if(!this._options.uploadHost)throw new Error("Cannot send attachments without a upload host configured.");this._log(`Sending message with ID ${t._id} with attachments:`,e);let i=n.Promise.resolve({});return e.forEach((e,o)=>{i=i.then(()=>new n.Promise((t,i)=>{r.getFileSize(e).then(n=>{const o={$attributes:{id:this.getUniqueId(),to:this._options.uploadHost,from:this._jid,type:"get",xmlns:u.NAMESPACES.JABBER_CLIENT},request:{$attributes:{xmlns:u.NAMESPACES.HTTP_UPLOAD},filename:e.name.replace(".encrypted",""),size:""+n,"content-type":e.type}};this.sendIq(this._options.uploadHost,"get",o).then(t).catch(i)}).catch(t=>{console.error(`Couldn't get file size for file with name '${e.name}'.`,t),i(t)})})).then(t=>new n.Promise(i=>{!0===this._options.authAttachments?this._getCacheItem("user_password").then(t=>this._embellishPasswordWithAdToken(t)).then(n=>{i([t,{Authorization:"Basic "+btoa(this._bareJid+":"+n),"Content-Type":e.type}])}):i([t,{"Content-Type":e.type}])})).then(i=>{const o=i[0],s=i[1];return new n.Promise((i,n)=>{const a=o.iq.slot.put,c=o.iq.slot.get;r.upload(e.path,a,c,s).then(()=>{this._dispatchEvent(u.EVENT_TYPES.UPLOAD_SUCCESS,t),i(["transferred",c,a])}).catch(i=>{this._dispatchEvent(u.EVENT_TYPES.UPLOAD_FAILED,t);const o=`Couldn't successfully upload file '${e.path}' to the server:`;this._onError(o,i),n({error:o,message:t})})})}).then(e=>{const i=e[0],r=e[1],a=e[2];return new n.Promise((e,n)=>{this.saveMessage(t._id,t=>(t.attachments[o].state=i,t.attachments[o].get=r,t.attachments[o].put=a,s.isBrowser()&&(t.attachments[o].path=r),t)).then(e).catch(n)})})}),i.then(()=>this.resendMessage(t._id))}_prepareMessageAttachmentsForSend(t,e){return this._log("Preparing to send the following attachments:",e),new n.Promise((i,o)=>{const s=[];e.forEach(t=>{s.push(new n.Promise((e,i)=>{this._log("Getting file information for file:",t),r.getFileInfo(t).then(t=>{this._log("Got file info for file:",t),e(Object.assign({get:"",put:"",state:"transferring"},t))}).catch(i)}))}),n.Promise.all(s).then(e=>{this._messageStanzaToDbObject({message:t},{mine:!0,attachments:e}).then(t=>{this._dispatchEvent(u.EVENT_TYPES.UPLOAD_STARTED,t),this._sendMessageWithAttachments(t,e).then(i).catch(o)}).catch(o)})})}sendChatMessage(t,e,i,o=[],s=!0){if(this._isMethodReady(!0,!0),!t)throw new Error("Parameter 'to' is required.");if(this._options.mucHost&&t.indexOf(this._options.mucHost)>-1)throw new Error("You are trying to send a peer-to-peer chat message to a room, please use the 'sendGroupChatMessage' method instead.");return new n.Promise((n,r)=>{const a={$attributes:{id:this.getUniqueId(),from:this._jid,to:t,type:"chat",xmlns:u.NAMESPACES.JABBER_CLIENT}};!0===s&&(a.markable={$attributes:{xmlns:u.NAMESPACES.CHAT_MARKERS}}),null!==e&&(a.body=e),null!==i&&(a.data=i),o.length<1?this.sendMessage(a).then(n).catch(r):this._prepareMessageAttachmentsForSend(a,o).then(n).catch(r)})}sendMulticastMessage(t,e,i,o=[],s=!0){return this._isMethodReady(!0,!0),new n.Promise((n,r)=>{const a={$attributes:{id:this.getUniqueId(),from:this._jid,to:`${this._options.multicastHost}`,type:"chat",xmlns:u.NAMESPACES.JABBER_CLIENT},addresses:{$attributes:{xmlns:u.NAMESPACES.ADDRESS},address:t.map(t=>({$attributes:t}))}};!0===s&&(a.markable={$attributes:{xmlns:u.NAMESPACES.CHAT_MARKERS}}),null!==e&&(a.body=e),null!==i&&(a.data=i),o.length<1?this.sendMessage(a).then(n).catch(r):this._prepareMessageAttachmentsForSend(a,o).then(n).catch(r)})}sendGroupChatMessage(t,e,i,o=[],s=!0,r=!1){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");if(!t)throw new Error("Parameter 'roomName' is required.");return new n.Promise((n,a)=>{const c={$attributes:{id:this.getUniqueId(),from:this._jid,to:`${t}@${this._options.mucHost}`,type:"groupchat",xmlns:u.NAMESPACES.JABBER_CLIENT}};!0===s&&(c.markable={$attributes:{xmlns:u.NAMESPACES.CHAT_MARKERS}}),null!==e&&(c.body=e),null!==i&&(c.data=i),!0!==r&&(c.exclude={$attributes:{xmlns:u.NAMESPACES.INFINITY_MAM,archive:"user"}}),o.length<1?this.sendMessage(c).then(n).catch(a):this._prepareMessageAttachmentsForSend(c,o).then(n).catch(a)})}sendMessage(t){return new n.Promise((e,i)=>{this._messageStanzaToDbObject({message:t},{state:{sent:!1},mine:!0}).then(n=>{this.sendStanza(t).then(()=>{this.saveMessage(n._id,t=>(t.state.sent=!0,t)).then(e).catch(i)}).catch(i)}).catch(i)})}sendIq(t,e,i,s=this._options.sendTimeout||25e3,r){this._isMethodReady(!0,!0);const a=void 0===r?this.getUniqueId():r;return new n.Promise((n,r)=>{const c=t=>{t.id===o.default.Strophe.Status.DISCONNECTED&&(this.removeEventListener(u.EVENT_TYPES.STATUS,c),r("Disconnected during IQ request."))};this.addEventListener(u.EVENT_TYPES.STATUS,c);let l=null;try{l={$attributes:{id:a,type:e,from:this._connection.jid}},t&&(l.$attributes.to=t);for(let t in i)l[t]=i[t]}catch(t){this._onError("Couldn't construct IQ message:",t),r(t)}if(null!==l){const t=u.jsonToXml("iq",l);this._connection.sendIQ(t,t=>{try{this.removeEventListener(u.EVENT_TYPES.STATUS,c),n(u.xmlToJson(t))}catch(t){this._onError("Couldn't convert IQ response to JSON.",t),r(t)}},r,s)}})}getPrivateData(){this._isMethodReady(!0,!0),this._log("Fetching Private XML Data for:",this._bareJid);const t={privatexmldata:{$attributes:{xmlns:u.NAMESPACES.CT_PRIVATE_XML_STORAGE}}};return new n.Promise((e,i)=>this._getPrivateXMLStorage(t).then(t=>{void 0!==t&&void 0!==t.privatexmldata&&void 0!==t.privatexmldata.json?e(JSON.parse(t.privatexmldata.json)):i("No private data found, or unable to fetch")}))}_getPrivateXMLStorage(t){return this._log("Fetching Private XML Storage Data for: ",this._bareJid),new n.Promise((e,i)=>{this.sendIq(this._bareJid,"get",{query:Object.assign({$attributes:{xmlns:u.NAMESPACES.PRIVATE_XML_STORAGE}},t)}).then(t=>{this._log("Fetched Private XML Storage Data for:",this._bareJid),e(t.iq.query)}).catch(t=>{i("Unable to send IQ for Private XML Storage")})})}setPrivateData(t){this._isMethodReady(!0,!0),this._log("Setting Private XML data for:",this._bareJid);const e=JSON.stringify(t),i={privatexmldata:{$attributes:{xmlns:u.NAMESPACES.CT_PRIVATE_XML_STORAGE},json:e}};return this._setPrivateXMLStorage(i)}_setPrivateXMLStorage(t){const e={query:Object.assign({$attributes:{xmlns:u.NAMESPACES.PRIVATE_XML_STORAGE}},t)};return new n.Promise((t,i)=>{this.sendIq(null,"set",e).then(e=>{t(),this._log("Set Private XML Storage for:",this._bareJid)}).catch(i)})}_getvCard(t){return this._log(" Fetching vCard for:",t),new n.Promise((e,i)=>{this.sendIq(t,"get",{vCard:{$attributes:{xmlns:"vcard-temp"}}}).then(i=>{this._log("Fetched vCard for:",t),e(i.iq.vCard)}).catch(t=>{i("Unable to send IQ for vCard")})})}_setvCard(t,e){this._log(" Setting vCard for:",t);const i=(new DOMParser).parseFromString(e,"text/xml"),o=u.xmlToJson(i);return new n.Promise((e,i)=>{this.sendIq(null,"set",o["#document"]).then(i=>{e(),this._log(" Set vCard for:",t)}).catch(i)})}addEventListener(t,e){if(!u._validateEventType(t))throw new Error("Invalid event type provided.");t===u.EVENT_TYPES.INITIALISED&&!0===this._initialised?e(null):(void 0===this._eventListeners[t]&&(this._eventListeners[t]=[]),this._eventListeners[t].push(e))}removeEventListener(t,e){if(!u._validateEventType(t))throw new Error("Invalid event type provided.");void 0!==this._eventListeners[t]&&this._eventListeners[t].forEach((i,n)=>{i===e&&this._eventListeners[t].splice(n,1)})}_searchDb(t,e,i,o,s,r){return new n.Promise((n,a)=>{const c=[];for(let t in e)0!==t.indexOf("$")?c.push(t):["$or","$and","$not","$nor","$all"].indexOf(t)>-1&&Array.isArray(e[t])&&e[t].length>0&&e[t].forEach(t=>{for(let e in t)c.push(e)});c.length>0&&t.createIndex({index:{fields:c}}).then(()=>{let c={selector:e};Array.isArray(i)&&i.length>0&&(c.sort=i),Array.isArray(o)&&o.length>0&&(c.fields=o),r&&(c.skip=r),s&&(c.limit=s),t.find(c).then(t=>{n(t.docs)}).catch(a)}).catch(a)})}findMessages(t,e,i,n,o){return this._isMethodReady(!0),this._searchDb(this._msgDb,t,e,i,n,o)}getAllMessageIds(){return this._isMethodReady(!0),new n.Promise((t,e)=>{this._msgDb.allDocs().then(e=>{let i=[];e.rows&&e.rows.length>0&&(i=e.rows.map(t=>t.id)),t(i)}).catch(e)})}getAllMessages(){return this._isMethodReady(!0),new n.Promise((t,e)=>{this._msgDb.allDocs({include_docs:!0}).then(e=>{const i=e.rows.map(t=>t.doc);t(i)}).catch(e)})}getChatHistory(t,e,i,o,s){this._isMethodReady(!0);let r={$or:[{sender_id:t},{recipient_id:t}]};return!0===i&&(r["state.read"]=!0),new n.Promise((t,i)=>{this.findMessages(r,e,null,o,s).then(e=>{const i=e.sort((t,e)=>t.ts-e.ts);t(i)}).catch(i)})}getMessagesById(t){return this._msgDb.allDocs({include_docs:!0}).then(e=>e.rows.filter(e=>t.includes(e.id)))}getMessageById(t){if(this._isMethodReady(!0),!t)throw new Error("A message ID must be provided.");return this._msgDb.get(t)}deleteMessage(t,e=!0){return this._isMethodReady(!0),new n.Promise((i,o)=>{if(t){const a=[];e&&void 0!==t.attachments&&t.attachments.forEach(t=>{void 0!==t.path&&a.push(new n.Promise(e=>("ios"!==s.getPlatformName()||t.path.includes("file://")||(t.path=`file://${t.path}`),r.deleteFile(t.path).then(e).catch(i=>{this._onError(`Couldn't delete attachment: '${t.name}':`,i),e()}))))}),n.Promise.all(a).then(()=>{this._msgDb.remove(t).then(()=>{if(this._log("Message successfully deleted with ID:",t._id),"android"===s.getPlatformName()&&window.PushNotification&&window.PushNotification.removeFromIgnoreList&&t.data&&t.data.conversationstarted){const e=JSON.parse(t.data.conversationstarted).started;window.PushNotification.removeFromIgnoreList(()=>{},()=>{},e)}if("ios"===s.getPlatformName()&&window.VoIPPushNotification&&window.VoIPPushNotification.removeFromIgnoreList&&t.data&&t.data.conversationstarted){const e=JSON.parse(t.data.conversationstarted).started;window.VoIPPushNotification.removeFromIgnoreList(e,()=>{},()=>{})}i()}).catch(e=>{this._onError(`Couldn't delete message with ID '${t._id}'.`,e),o(e)})}).catch(e=>{this._onError(`Couldn't delete attachment(s) for message with ID '${t._id}':`,e),o(e)})}else i()})}deleteMessageById(t,e=!0){return this._isMethodReady(!0),this._log("Deleting message with ID:",t),new n.Promise((i,n)=>{this.getMessageById(t).then(t=>{this.deleteMessage(t,e).then(i).catch(n)}).catch(e=>{this._onError(`Couldn't get message with ID '${t}' to delete it.`,e),n(e)})})}deleteMessages(t){return this._isMethodReady(!0),new n.Promise((e,i)=>{this._searchDb(this._msgDb,t).then(t=>{this._log(" There are "+t.length+" messages to delete");const o=[];t.forEach(t=>{o.push(this.deleteMessage(t))}),n.Promise.all(o).then(e).catch(t=>{this._onError("Couldn't delete messages from database.",t),i(t)})})})}deleteMessagesByRoom(t){return console.warn("This method is going to be DEPRECATED, please use 'deleteMessagesByRoomName' instead."),this.deleteMessages({$or:[{sender_id:t},{recipient_id:t}]})}deleteMessagesByRoomName(t){if(!this._options.mucHost)throw new Error("mucHost must be provided as an option.");return this.deleteMessages({$or:[{sender_id:`${t}@${this._options.mucHost}`},{recipient_id:`${t}@${this._options.mucHost}`}]})}saveMessage(t,e){return this._isMethodReady(!0),new n.Promise((i,n)=>{this._saveObject(u.OBJECT_TYPES.MESSAGE,t,e,t=>{i(t)},t=>{n(t)})})}_clearDbsForNewUser(){return new n.Promise((t,e)=>{this.destroyDbs(!1).then(()=>{this._dispatchEvent(u.EVENT_TYPES.AUTO_DBS_DESTROYED,null),t()}).catch(e)})}destroyDbs(t=!0,e=!1){return new n.Promise((i,o)=>{if(this._destroyingDbs)return void i();this._log(" Destroying all databases and data..."),this._destroyingDbs=!0,this._lastArchiveId=null,localStorage.removeItem(`${this._instanceId}_last_archive_id`),this.resource=null,localStorage.removeItem(`${this._instanceId}_resource`),localStorage.removeItem(`${this._instanceId}_counters`),!0!==e&&localStorage.removeItem(`${this._instanceId}_key`),localStorage.removeItem(`${this._instanceId}_logging_in`),localStorage.removeItem(`${this._instanceId}_presence_needed`);const s=[this._msgDb.destroy(),this._contactDb.destroy(),this._roomDb.destroy(),this._participantDb.destroy()];!1!==a.getSource("file")&&s.push(r.deleteAttachments()),!0!==e&&s.push(this._cacheDb.destroy()),s.push(new n.Promise((t,e)=>{this._userDirectory.initialised?(localStorage.removeItem(`${this._instanceId}_ud_iv`),this._userDirectory.destroy().then(()=>{t()}).catch(e)):t()})),n.Promise.all(s).then(()=>{this._initDbs().then(()=>{!0===t&&this._dispatchEvent(u.EVENT_TYPES.DBS_DESTROYED,null),this._log(" Successfully destroyed all data."),this._destroyingDbs=!1,i()}).catch(t=>{this._destroyingDbs=!1,o(t)})}).catch(t=>{this._destroyingDbs=!1,o(t)})})}deleteAttachments(){return r.deleteAttachments()}deleteFile(t){return new n.Promise((e,i)=>{if(void 0!==t)return"ios"!==s.getPlatformName()||t.includes("file://")||(t=`file://${t}`),r.deleteFile(t).then(e).catch(i=>{this._onError(`Couldn't delete attachment at: '${t}':`,i),e()});e()})}setChatStatus(t,e,i,o){return this._isMethodReady(!0),new n.Promise((n,s)=>{if(u._validateChatStatus(t)){const r={status:t,label:e,metadata:o};if(!r.label)switch(t){case u.CHAT_STATUSES.CHAT:r.label="Available";break;case u.CHAT_STATUSES.AWAY:r.label="Away";break;case u.CHAT_STATUSES.XA:r.label="Extended Away";break;case u.CHAT_STATUSES.DND:r.label="Do Not Disturb"}this._setCacheItem("chat_status",r).then(()=>{!0===i?this._sendPresence().then(()=>n(r)).catch(s):n(r)}).catch(s)}else s("Invalid chat status provided, one of 'away', 'chat', 'dnd' or 'xa' should be specified.")})}getChatStatus(){return this._isMethodReady(!0),this._getCacheItem("chat_status")}setClientState(t){if(this._isMethodReady(!0,!0),!u._validateConstants(u.CLIENT_STATES,t))throw new Error("Invalid client state specified.");const e=u.jsonToXml(t,{$attributes:{xmlns:u.NAMESPACES.CLIENT_STATE_INDICATION}});return this._connection.send(e)}findContacts(t,e,i,n,o){return this._isMethodReady(!0),this._searchDb(this._contactDb,t,e,i,n,o)}getContacts(){return this._isMethodReady(!0),new n.Promise((t,e)=>{this._contactDb.allDocs({include_docs:!0}).then(e=>{const i=e.rows.filter(t=>!t.doc.language).map(t=>t.doc);t(i)}).catch(t=>{this._onError("Unable to get contacts from database.",t),e(t)})})}_embellishPasswordWithAdToken(t){if(!t)throw new Error("Password must be provided.");return new n.Promise((e,i)=>{if(!0===s.isElectron()&&!0===s.isWindows()&&this._options.adTokenPlaceholder&&this._options.adSecurityPackage&&this._options.adSpn&&t.indexOf(this._options.adTokenPlaceholder)>-1){const n=a.getSource("sspiclient");!1!==n?n.Helper.getUserToken(i=>{e(t.replace(this._options.adTokenPlaceholder,i))},i,this._options.adSpn,this._options.adSecurityPackage):i("Couldn't access sspiclient plugin.")}else e(t)})}_shouldMarkMessage(t,e){let i=!0;return!1!==t.markable&&(t.state.markers.every(n=>{if(n.type===e){if("groupchat"===t.type&&n.sender_resource===this.username)return i=!1,!1;if(n.sender_id===this._jid)return i=!1,!1}return!0}),i)}_markMessage(t,e,i=!0){return new n.Promise((n,s)=>{if(!0===t.mine||!1===this._shouldMarkMessage(t,e))n(t);else{const r={$attributes:{id:this.getUniqueId(),to:o.default.Strophe.getBareJidFromJid(t.stanza.message.$attributes.from),from:this._connection.jid},timestamp:{$attributes:{xmlns:u.NAMESPACES.CT_CLIENT_TIMESTAMP},$value:Date.now()}};r[e]={$attributes:{xmlns:u.NAMESPACES.CHAT_MARKERS,id:t._id}},"groupchat"===t.type&&(r.$attributes.type="groupchat"),this.sendStanza(r).then(()=>{this.saveMessage(t._id,t=>(t.state[e]=!0,t)).then(t=>{!1!==i&&this._dispatchEvent(u.EVENT_TYPES.MESSAGE_UPDATED,t),n(t)}).catch(s)}).catch(s)}})}markMessageRead(t){if(this._isMethodReady(!0,!0),!s.isDevice()||!d.isInBackground())return this._markMessage(t,u.MARKER_TYPES.READ)}markMessageReadById(t){return this._isMethodReady(!0,!0),this.getMessageById(t).then(t=>this.markMessageRead(t))}markMessageAcknowleged(t){return this._isMethodReady(!0,!0),this._markMessage(t,u.MARKER_TYPES.ACKNOWLEDGED)}markMessageAcknowledgedById(t){return this._isMethodReady(!0,!0),this.getMessageById(t).then(t=>this.markMessageAcknowleged(t))}_dispatchEvent(t,e){if(!u._validateEventType(t))throw new Error("Invalid event type provided.");void 0!==this._eventListeners[t]&&this._eventListeners[t].forEach(t=>{t(e)})}createRoom(t){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("mucHost must be provided as an option.");return new n.Promise((e,i)=>{const n=`${t}@${this._options.mucHost}`;let o={$attributes:{to:`${n}/${this.username}`,xmlns:u.NAMESPACES.JABBER_CLIENT},x:{$attributes:{xmlns:u.NAMESPACES.MUC}}};this._connection.addHandler(o=>{const s=u.xmlToJson(o);if(void 0!==s.$attributes&&"error"===s.$attributes.type){const e=new Error(`Failed to create room '${t}'.`);this._onError(`Unable to create room with name '${t}'.`,e),i(e)}else this.sendIq(n,"get",{query:{$attributes:{xmlns:u.NAMESPACES.MUC_OWNER}}}).then(()=>{this.sendIq(n,"set",{query:{$attributes:{xmlns:u.NAMESPACES.MUC_OWNER},x:{$attributes:{xmlns:u.NAMESPACES.X_DATA,type:"submit"},field:[{$attributes:{var:"muc#roomconfig_whois"},value:"anyone"}]}}}).then(()=>{this._log(`Room '${t}' successfully created.`),e()}).catch(t=>i)}).catch(t=>i);return!1},u.NAMESPACES.MUC,"presence",null,null,`${n}/${this.username}`,{ignoreNamespaceFragment:!0}),this._connection.send(u.jsonToXml("presence",o))})}destroyRoom(t){if(this._isMethodReady(!0,!0),!t)throw new Error("Parameter 'roomName' must be provided.");if(!this._options.mucHost)throw new Error("mucHost must be provided as an option.");return new n.Promise((e,i)=>{this.sendIq(`${t}@${this._options.mucHost}`,"set",{query:{$attributes:{xmlns:u.NAMESPACES.MUC_OWNER},destroy:{}}}).then(()=>{e()}).catch(t=>i)})}listRooms(t){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("mucHost must be provided as an option.");return new n.Promise((e,i)=>{const s=()=>{this._roomDb.allDocs({include_docs:!0}).then(t=>{const i=t.rows.map(t=>t.doc);e(i)}).catch(t=>{this._onError("Couldn't fetch list of rooms from database.",t),i(t)})};!0===this.connected&&!1!==t?this.sendIq(this._options.mucHost,"get",{query:{$attributes:{xmlns:"http://jabber.org/protocol/disco#items"}}}).then(t=>{if(t.iq&&t.iq.query&&t.iq.query.item){let r=[];r=Array.isArray(t.iq.query.item)?t.iq.query.item.map(t=>({_id:t.$attributes.jid,name:o.default.Strophe.getNodeFromJid(t.$attributes.jid)})):[{_id:t.iq.query.item.$attributes.jid,name:o.default.Strophe.getNodeFromJid(t.iq.query.item.$attributes.jid)}],this._roomDb.allDocs({include_docs:!0}).then(t=>{const e=[];t.rows.forEach(t=>{let i=t.doc,n=null;r.every(t=>t._id!==i._id||(n=t,!1)),null===n&&e.push(this._roomDb.remove(i))}),r.forEach(t=>{const i=new n.Promise((e,i)=>{this.saveRoom(t._id,e=>(void 0!==e._id?(e.name!==t.name&&(e.name=t.name),e.updated_at=this.getSyncedTimestamp(Date.now())):e={_id:t._id,name:t.name,ts:this.getSyncedTimestamp(Date.now()),updated_at:null},e)).then(e).catch(i)});e.push(i)}),n.Promise.all(e).then(()=>{s()}).catch(t=>{this._onError("Couldn't merge list of rooms from server with locally stored list of rooms.",t),i(t)})}),e(r)}else e([])}).catch(i):s()})}listSubscriptions(){return this._isMethodReady(!0,!0),new n.Promise((t,e)=>{this._options.mucHost?this.sendIq(this._options.mucHost,"get",{subscriptions:{$attributes:{xmlns:u.NAMESPACES.MUC_SUB}}}).then(e=>{let i=[];e.iq&&e.iq.subscriptions&&e.iq.subscriptions.subscription&&(Array.isArray(e.iq.subscriptions.subscription)?i=e.iq.subscriptions.subscription.map(t=>{if(t.$attributes&&t.$attributes.jid)return{name:o.default.Strophe.getNodeFromJid(t.$attributes.jid),jid:t.$attributes.jid}}):e.iq.subscriptions.subscription.$attributes&&e.iq.subscriptions.subscription.$attributes.jid&&(i=[{name:o.default.Strophe.getNodeFromJid(e.iq.subscriptions.subscription.$attributes.jid),jid:e.iq.subscriptions.subscription.$attributes.jid}])),t(i)}).catch(e):t([])})}joinRoom(t){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");if(!t)throw new Error("Parameter 'roomName' must be provided.");return new n.Promise((e,i)=>{const n=`${t}@${this._options.mucHost}`;this._createPresenceObject().then(o=>{o.$attributes.to=`${n}/${this.username}`,o.x={$attributes:{xmlns:u.NAMESPACES.MUC},history:{$attributes:{maxchars:0}}},this._connection.addHandler(o=>{try{const s=u.xmlToJson(o);s.presence&&void 0===s.presence.error?this.saveRoom(n,e=>(void 0!==e._id?e.name!==t&&(e.name=t,e.updated_at=this.getSyncedTimestamp(Date.now())):e={_id:n,name:t,ts:this.getSyncedTimestamp(Date.now()),updated_at:null},e)).then(n=>{this._joinedRooms[t]=Date.now(),!1!==this._options.mam.auto?this.queryMamByRoomName(t).then(()=>{e(n)}).catch(i):e(n)}).catch(i):(this._onError(`Couldn't join room '${t}' with nick '${this.username}'.`,o),i(o))}catch(t){this._onError("Couldn't convert stanza XML to JSON",t),i(t)}return!1},u.NAMESPACES.JABBER_CLIENT,"presence",null,null,`${t}@${this._options.mucHost}/${this.username}`,{ignoreNamespaceFragment:!0}),this._connection.send(u.jsonToXml("presence",o))})})}leaveRoom(t){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");if(!t)throw new Error("Parameter 'roomName' must be provided.");return new n.Promise(e=>{const i={$attributes:{from:this._jid,xmlns:u.NAMESPACES.JABBER_CLIENT,to:`${t}@${this._options.mucHost}/${this.username}`,type:"unavailable"}};this._connection.send(u.jsonToXml("presence",i)),delete this._joinedRooms[t],e()})}subscribeToRoom(t,e){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("mucHost must be provided as an option.");if(!t)throw new Error("Parameter 'roomName' must be provided.");return new n.Promise((i,n)=>{const o={subscribe:{$attributes:{xmlns:u.NAMESPACES.MUC_SUB,nick:this.username}}};if(!e){e=[];for(let t in u.MUC_NODES)e.push(u.MUC_NODES[t])}e.length>0&&(o.subscribe.event=[],e.forEach(t=>{o.subscribe.event.push({$attributes:{node:t}})})),this.sendIq(`${t}@${this._options.mucHost}`,"set",o).then(e=>{e.iq&&e.iq.subscribe?i(e):this._onError(`Couldn't subscribe to room '${t}.'`,e)}).catch(n)})}listSubscribedUsersForRoom(t){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("mucHost must be provided as an option.");return new n.Promise((e,i)=>{this.sendIq(`${t}@${this._options.mucHost}`,"get",{subscriptions:{$attributes:{xmlns:u.NAMESPACES.MUC_SUB}}}).then(t=>{let i=[];if(t.iq&&void 0!==t.iq.subscriptions)if(Array.isArray(t.iq.subscriptions.subscription))i=t.iq.subscriptions.subscription.map(t=>{if(t.$attributes&&void 0!==t.$attributes.jid)return t.$attributes.jid});else if(void 0!==t.iq.subscriptions.subscription){const e=t.iq.subscriptions.subscription;e.$attributes&&void 0!==e.$attributes.jid&&(i=[e.$attributes.jid])}e(i)}).catch(i)})}unsubscribeFromRoom(t){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("mucHost must be provided as an option.");return new n.Promise((e,i)=>{this.sendIq(`${t}@${this._options.mucHost}`,"set",{unsubscribe:{$attributes:{xmlns:u.NAMESPACES.MUC_SUB}}}).then(e).catch(i)})}getRoomById(t){if(this._isMethodReady(!0),!t)throw new Error("A room ID must be provided.");return this._log("Getting room with ID:",t),this._roomDb.get(t)}findRooms(t,e,i,n,o){return this._isMethodReady(!0),this._searchDb(this._roomDb,t,e,i,n,o)}saveRoom(t,e){return this._isMethodReady(!0),new n.Promise((i,n)=>{this._saveObject(u.OBJECT_TYPES.ROOM,t,e,t=>{i(t)},t=>{n(t)})})}saveParticipant(t,e){return this._isMethodReady(!0),new n.Promise((i,n)=>{this._saveObject(u.OBJECT_TYPES.PARTICIPANT,t,e,t=>{i(t)},t=>{n(t)})})}listParticipantsByRoom(t){return this._isMethodReady(!0),this._searchDb(this._participantDb,{room_name:t})}getParticipantByRoomAndJid(t,e){return this._isMethodReady(!0),new n.Promise((i,n)=>this._searchDb(this._participantDb,{room_name:t,jid:e}).then(t=>{t.length>0?i(t[0]):i(null)}).catch(n))}purgeParticipantsByUpdatedAt(t){return this._isMethodReady(!0),new n.Promise((e,i)=>{this._searchDb(this._participantDb,{updated_at:{$lt:t}}).then(t=>{const o=t.map(t=>this._participantDb.remove(t));n.Promise.all(o).then(e).catch(i)}).catch(t=>{console.error(t)})})}getServerVersion(){return this._isMethodReady(!0),new n.Promise((t,e)=>{this.sendIq(`${this._domain}`,"get",{query:{$attributes:{xmlns:u.NAMESPACES.SOFTWARE_VERSION}}}).then(e=>{e.iq&&e.iq.query&&t({name:e.iq.query.name||"",os:e.iq.query.os||"",version:e.iq.query.version})}).catch(e)})}_requestMessagesFromMam(t,e=null,i=!1,s=null,r,a=this._options.mam.pageSize){const c=(e,n,r,l,d,h=[],p=null)=>{const g={query:{$attributes:{xmlns:u.NAMESPACES.MAM,queryid:r},x:{$attributes:{xmlns:"jabber:x:data",type:"submit"},field:[{$attributes:{var:"FORM_TYPE",type:"hidden"},value:u.NAMESPACES.MAM}]},set:{$attributes:{xmlns:u.NAMESPACES.RESULT_SET_MANAGEMENT},max:""+a}}};if(this._log(`Querying the message archive for start date '${l}' and end date '${d}'.`),null!==l||!0===i){let t="";!0===i&&(t+="inf_conv_mode"),null!==l&&(t+=l.toISOString()),g.query.x.field.push({$attributes:{var:"start"},value:t})}null!==d&&g.query.x.field.push({$attributes:{var:"end"},value:d.toISOString()}),null!==p&&(g.query.set[!0===i?"before":"after"]=p),null!==s&&g.query.x.field.push({$attributes:{var:"with"},value:s}),this._connection.addHandler(t=>{const s=u.xmlToJson(t);try{if(void 0!==s.message.result&&void 0!==s.message.result.forwarded&&void 0!==s.message.result.forwarded.message){const t=s.message.result.forwarded;void 0===s.message.result.forwarded.message.archived&&void 0!==s.message.result&&void 0!==s.message.result.$attributes&&void 0!==s.message.result.$attributes.id&&(t.message.archived={$attributes:{by:o.default.Strophe.getBareJidFromJid(t.message.$attributes.from),id:s.message.result.$attributes.id,xmlns:u.NAMESPACES.MAM_TMP}}),h.push(t)}}catch(t){return n(t),!1}const a=void 0!==s.message.fin&&void 0!==s.message.fin.$attributes&&s.message.fin.$attributes.xmlns===u.NAMESPACES.MAM;return!0===a&&("true"==s.message.fin.$attributes.complete||!0===i?(this._log(`Finished paging through result set, got a total of '${h.length}' items.`),e(h)):(this._log(`Paging through result set to get a total of '${s.message.fin.set.count}' items.`),this._log(`Got '${h.length}' items so far...`),c(e,n,r,l,d,h,s.message.fin.set.last))),!a},u.NAMESPACES.JABBER_CLIENT,"message",null,null,t),this.sendIq(t,"set",g,null).catch(t=>{this._onError("Couldn't query the MAM:",t),n(t)})};let l=null,d=null;return new n.Promise((t,i)=>{null!==r?this.getServerTime().then(()=>{const n=this.getSyncedTimestamp(Date.now()+6e4);r>=n?i(`The start timestamp (${r}) cannot be equal to or larger than the end timestamp (${n}).`):(l=new Date(r),d=new Date(n),c(t,i,this.getUniqueId(),l,d,[],e))}):c(t,i,this.getUniqueId(),l,d,[],e)})}queryMam(t,e=null,i=null,o,s=!0){return this._isMethodReady(!0,!0),new n.Promise((n,r)=>{const a=o||this._options.mam.defaultTimeLimit,c=Date.now()-a,l=this.getSyncedTimestamp(c-6e4);this._log("Starting the MAM query process..."),this._perfStart("requestMessagesFromMam","Starting the first request for MAM messages","color: blue;"),this._requestMessagesFromMam(t,e,!1,i,l).then(t=>{this._perfEnd("requestMessagesFromMam","Finished getting all messages from the MAM","color: blue;"),this._processMamStanzas(t,s,!1).then(n).catch(r)}).then(()=>{if(this._options.autoPurgeOldMessagesAge>0)return this.purgeMessagesOlderThan(this._options.autoPurgeOldMessagesAge)}).then(()=>{if(this._options.autoPurgeOldRetainMessageCount>0)return this.purgeOldestMessagesLeavingCount(this._options.autoPurgeOldRetainMessageCount)}).catch(r)})}_processMamStanzas(t,e=!0,i=!1,o=!1){return new n.Promise((s,r)=>{const a=[],c=[];if(0===t.length)s([]);else{this._perfStart("processMamMessages","Starting to process all messages received from the MAM","color: yellow; background: black;"),this._perfStart("preProcessMamMessages","Starting to pre-process all messages received from the MAM","color: darkgreen; background: grey;");let l="0";t.forEach(t=>{const e={state:{sent:!0},fromMam:!1===i,injected:!0===i};let n=!1;try{n=void 0!==t.message.timestamp}catch(t){}if(!1===n&&t.delay&&t.delay.$attributes.stamp){let i=null;try{i=new Date(t.delay.$attributes.stamp).getTime()}catch(t){console.error("Couldn't parse stanza timestamp to integer.")}null!==i&&(e.ts=i)}const o=this._getArchiveIdFromStanza(t);o>l&&(l=o),u._isMarkerMessage(t)?(this._stanzaResponseHandler(t.message.$attributes.id),c.push(t)):t.message.$attributes&&"chat"===t.message.$attributes.type?a.push(this._messageDelta(t,{},e)):t.message.$attributes&&"groupchat"===t.message.$attributes.type?(this._stanzaResponseHandler(t.message.$attributes.id),a.push(this._messageDelta(t,{},e))):t.message.call&&t.message.call.$attributes&&t.message.call.$attributes.xmlns===u.NAMESPACES.INFINITY_BOT?(this._log(`Processing bot command response from the MAM with request ID '${t.message.call.$attributes["request-id"]}':`,t),this._botCommandResponseHandler(t.message.call.$attributes["request-id"],t)):t.message.error&&t.message.error.$attributes&&t.message.error.$attributes.xmlns===u.NAMESPACES.INFINITY_BOT?this._botCommandResponseHandler(t.message.error.$attributes["request-id"],t):t.message.ack&&t.message.ack.$attributes&&t.message.ack.$attributes.xmlns===u.NAMESPACES.INFINITY_ACK&&this._stanzaResponseHandler(t.message.ack.$attributes["original-id"])}),this._perfEnd("preProcessMamMessages","Finished pre-processing messages from the MAM.","color: darkgreen; background: grey;"),this._perfStart("postProcessMamMessages","Start post-processing messages received from the MAM","color: lightgreen; background: grey;"),this._perfStart("addMarkersToMamMessages","Adding markers to messages","color: brown; background: #E1E1E1;");const d=[];let h={};const p={};c.forEach(t=>{const e=u._getMarkerType(t),i=u._getMarkerMessageId(t,e);p[i]||(p[i]=[]),p[i].push(t)});for(let t in p){const e=p[t];let i=null;a.every(e=>e._id!==t||(i=e,!1)),null!==i?e.forEach(t=>{const e=u._getMarkerType(t),n=(u._getMarkerMessageId(t,e),this._updateMessageMarkers(t,e,i));!1!==n&&(h[i._id]=!0,i=n)}):d.push(new n.Promise(i=>{this.getMessageById(t).then(t=>{e.forEach(e=>{const i=u._getMarkerType(e),n=(u._getMarkerMessageId(e,i),this._updateMessageMarkers(e,i,t));!1!==n?a.push(n):this._setLastArchiveId(this._getArchiveIdFromStanza(e))}),i()}).catch(()=>{this._log(`Not found message with id '${t}', creating message placeholder...`);let n=Object.assign({},u._messageSkeleton(),{_id:t,placeholder:!0,markable:!0,type:null});e.forEach(t=>{const e=u._getMarkerType(t),i=(u._getMarkerMessageId(t,e),this._updateMessageMarkers(t,e,n));!1!==i&&(n=i)}),a.push(n),i()})}))}n.Promise.all(d).then(()=>{if(this._log("Messages to save from the MAM:",a),0===a.length)s([]);else{this._perfEnd("addMarkersToMamMessages","Finished adding markers to messages","color: brown; background: #E1E1E1;");const t=[];!0===o&&a.forEach((e,i,n)=>t.push(this.saveMessage(e._id,t=>{if(t._id)return n.splice(i,1),delete e.state,Object.assign({},t,e)}))),n.Promise.all(t).then(t=>{const i=a.filter(e=>0===t.filter(t=>!!t&&t._id===e._id).length);this._msgDb.bulkDocs(i).then(i=>{this._setLastArchiveId(l);const n=function(e){s([...e,...t].filter(t=>null!==t))};i.length>0?this._msgDb.bulkGet({docs:i}).then(t=>{let i=t.results.map(t=>{const i=t.docs[0].ok;return void 0===i?null:(!1!==e&&(null===i.updated_at||!0===h[i._id]?this._dispatchEvent(u.EVENT_TYPES.NEW_MESSAGE,i):this._dispatchEvent(u.EVENT_TYPES.MESSAGE_UPDATED,i)),!0===this._options.autoMarkMessages&&this._markMessage(i,u.MARKER_TYPES.RECEIVED,e),i)});h={},this._perfEnd("postProcessMamMessages","Finished post-processing messages received from the MAM","color: lightgreen; background: grey;"),this._perfEnd("processMamMessages","Finished processing messages received from the MAM","color: yellow; background: black;"),n(i)}):n([])}).catch(t=>{console.error(t),r(t)})})}})}})}processXmlStanzaStringsFromMam(t,e=!0){const i=new DOMParser,o=t.map(t=>i.parseFromString(t,"text/xml").childNodes[0]).map(t=>u.xmlToJson(t)),s={};return o.forEach(t=>{try{const e=t.message.$attributes.id,i=t.message.$attributes.to.split("@")[0];void 0===s[i]&&(s[i]=[]),s[i].push(e)}catch(t){console.error("The stanza wasn't in the expected format:",t)}}),this.getAllMessages().then(t=>{let i=[];return t.length>0&&(i=Object.keys(s).map(e=>{const i=t.filter(t=>t.recipient_id===`${e}@${this.mucHost}`||t.sender_id===`${e}@${this.mucHost}`);if(0!==i.length)return s[e].filter(t=>i.filter(e=>e._id===t).length>0).length>0?void 0:this.deleteMessagesByRoomName(e)})),n.Promise.all(i).then(()=>this._processMamStanzas(o,e,!0))})}purgeOldMessages(){return this._isMethodReady(!0),this.purgeMessagesOlderThan(this._options.autoPurgeOldMessagesAge)}purgeMessagesOlderThan(t){return this._isMethodReady(!0),this._log(" Removing messages older than: "+t),this.purgeMessagesFromBefore(this.getSyncedTimestamp(Date.now())-t)}purgeMessagesFromBefore(t){return this._isMethodReady(!0),this._log(" Removing messages with timestamp before: "+new Date(t).toISOString()),this.deleteMessages({ts:{$lt:t}})}purgeOldestMessagesLeavingCount(t){return this._isMethodReady(!0),this._log(" Want to restrict to: "+t+" messages in DB"),this._msgDb.info().then(e=>{this._log(" There are: "+e.doc_count+" messages in DB");const i=e.doc_count-t;if(i>0)return this._log(" Going to delete: "+i+" messages from DB"),this.purgeOldestMessagesCount(i)})}purgeOldestMessagesCount(t){return this._isMethodReady(!0),this._msgDb.createIndex({index:{fields:["ts"]}}).then(()=>{this._msgDb.find({selector:{},sort:["ts"],limit:t,fields:["_id"]}).then(t=>{let e=n.Promise.resolve();return t.docs.forEach(t=>{e=e.then(()=>(this._log(" Deleting message: "+t._id),this.deleteMessageById(t._id).then(()=>{this._log(" Deleted message: "+t._id)})))}),e})})}_setLastArchiveId(t){t>this._lastArchiveId&&(this._lastArchiveId=t,localStorage.setItem(`${this._instanceId}_last_archive_id`,t))}getLastArchiveId(){return this._lastArchiveId}getLastArchiveIdForRoom(t){if(this._isMethodReady(!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");return new n.Promise((e,i)=>{const n=`${t}@${this._options.mucHost}`;let o="0";this.getChatHistory(n).then(t=>{if(t.length>0){const e=t.sort((t,e)=>{const i=e.updated_at-t.updated_at;return 0===i?e.ts-t.ts:i})[0];o=e.archive_id}e(o)}).catch(i)})}getFirstArchiveIdForRoom(t){if(this._isMethodReady(!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");return new n.Promise((e,i)=>{const n=`${t}@${this._options.mucHost}`;let o="0";this.getChatHistory(n).then(t=>{if(t.length>0){const e=t.sort((t,e)=>t.ts-e.ts)[0];o=e.archive_id}e(o)}).catch(i)})}queryMamByRoomName(t,e=!0,i=null){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");return this._perfStart("queryMamByRoomName",`- Querying the MAM for room '${t}'`,"color: green;"),new n.Promise((n,o)=>{const s=`${t}@${this._options.mucHost}`,r=i=>{this.queryMam(s,i,null,null,e).then(e=>{this._perfEnd("queryMamByRoomName",`- Finished querying the MAM for message in room '${t}'.`,"color: green;"),n(e)}).catch(o)};null===i?this.getLastArchiveIdForRoom(t).then(t=>{r(t)}).catch(n):r(i)})}queryMamRoomHistoryByName(t,e=null,i=5,o=!0,s=null){if(this._isMethodReady(!0,!0),!this._options.mucHost)throw new Error("'mucHost' must be provided as an option.");return this._perfStart("queryMamRoomHistoryByName",`Querying MAM history for room '${t}'`,"color: purple;"),new n.Promise((n,r)=>{const a=`${t}@${this._options.mucHost}`;this._requestMessagesFromMam(a,e,!0,null,s,i).then(e=>{this._perfEnd("queryMamRoomHistoryByName",`Finished querying the MAM history for '${i}' messages in the '${t}' room.`,"color: purple;"),this._processMamStanzas(e,o,!1,!0).then(n).catch(r)}).then(()=>{if(this._options.autoPurgeOldMessagesAge>0)return this.purgeMessagesOlderThan(this._options.autoPurgeOldMessagesAge)}).then(()=>{if(this._options.autoPurgeOldRetainMessageCount>0)return this.purgeOldestMessagesLeavingCount(this._options.autoPurgeOldRetainMessageCount)}).catch(r)})}queryMamByRecipient(t,e=!0){return this._isMethodReady(!0,!0),new n.Promise((i,n)=>{this.getChatHistory(t).then(o=>{let s=null;o.length>0&&(s=o.sort((t,e)=>{const i=e.updated_at-t.updated_at;return 0===i?e.ts-t.ts:i})[0].archive_id),this.queryMam(null,s,t,null,e).then(i).catch(n)}).catch(t=>console.error)})}_saveObject(t,e,i,n,o){if(this._destroyingDbs)return this._log(`Couldn't save '${t}' because the databases are being destroyed.`),void(o&&o(u.ERROR_CODES.DESTROYING_DBS));let s=null;switch(t){case u.OBJECT_TYPES.MESSAGE:s=this._msgDb;break;case u.OBJECT_TYPES.CONTACT:s=this._contactDb;break;case u.OBJECT_TYPES.ROOM:s=this._roomDb;break;case u.OBJECT_TYPES.PARTICIPANT:s=this._participantDb;break;case u.OBJECT_TYPES.CACHE_ITEM:s=this._cacheDb}if(null===s)throw new Error(`The object type provided (${t}) is not valid.`);void 0===this._saveDebounce[t]&&(this._saveDebounce[t]={}),this._saveDebounce[t][e]?setTimeout(()=>{this._saveObject(t,e,i,n,o)},250):(this._saveDebounce[t][e]=!0,s.upsert(e,i).then(i=>{void 0!==i.rev?s.get(e).then(i=>{delete this._saveDebounce[t][e],n&&n(i)}).catch(i=>{this._onError(`Couldn't get ${t} with ID '${e}' after performing an update.`,i),delete this._saveDebounce[t][e],o&&o(i)}):(delete this._saveDebounce[t][e],n&&n(null))}).catch(i=>{this._log(`Couldn't update ${t} with ID '${e}'.`,i),delete this._saveDebounce[t][e],o&&o(i)}))}doDownload(t){return new n.Promise((e,i)=>{const n=n=>{r.download(t,n).then(t=>{var n=a.getSource("fileEncryption");s.isDevice()&&this._options.fileEncryption&&n?n.encrypt(function(i){t.source=i,e(t)},function(t){i(t)},t.source):e(t)}).catch(i)};!0===this._options.authAttachments?this._getCacheItem("user_password").then(t=>this._embellishPasswordWithAdToken(t)).then(t=>{n({Authorization:"Basic "+btoa(this._bareJid+":"+t)})}):n(null)})}downloadAttachment(t,e,i=!0){return this._isMethodReady(!0,!0),new n.Promise((n,o)=>{if(e>t.attachments.length-1)return o("No such attachment: "+e);const s=t.attachments[e];void 0===s.path?this.doDownload(s.get).then(o=>{s.path=o.source,s.state="transferred",this.saveMessage(t._id,t=>(t.attachments[e]=s,t)).then(t=>{!1!==i&&this._dispatchEvent(u.EVENT_TYPES.MESSAGE_UPDATED,t),n()})}).catch(o):n()})}initUserDirectory(){return new n.Promise((t,e)=>{if(!0===this._userDirectory.initialised)t();else{let i=null,n=localStorage.getItem(`${this._instanceId}_ud_iv`);if(null==n){i=window.crypto.getRandomValues(new Uint8Array(16));let t=[];for(let e=0;e<16;e++)t.push(String.fromCharCode(i[e]));const e=t.join("");localStorage.setItem(`${this._instanceId}_ud_iv`,e)}else{const t=new Uint8Array(16);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);i=t}d.getEncryptionKey(this._instanceId).then(n=>{this._userDirectory.initialise(n,i,this._options.userDirectoryEncryptionBlockSize||2e3).then(t).catch(e)})}})}_updateUserDirectoryTimer(){setTimeout(()=>{this.updateUserDirectory().then(t=>{this._log(` Updated user directory: ${t}`)}).catch(t=>{this._log(` Couldn't update user directory: ${t.message}`)})},this._options.updateUserDirectoryInterval)}updateUserDirectory(){return this.initUserDirectory().then(()=>(this._log(" Updating user directory..."),this._getCacheItem("user_directory_hash").then(t=>{const e={query:{$attributes:{xmlns:u.NAMESPACES.DIRECTORY}}};return t&&(e.query.$attributes.hash=t),this.sendIq(this._domain,"get",e).then(t=>{try{const e=t.iq.query.$attributes.url;return void 0===e?(this._updateUserDirectoryTimer(),"No change since last update."):this._getCacheItem("user_password").then(t=>this._embellishPasswordWithAdToken(t)).then(t=>this._userDirectory.update(this._bareJid,t,e).then(t=>this._setCacheItem("user_directory_hash",t.hash).then(()=>(this._log(" User directory successfully updated."),this._updateUserDirectoryTimer(),t.msg))))}catch(t){return this._updateUserDirectoryTimer(),n.Promise.reject("Couldn't obtain directory URL from server.")}})}))).catch(t=>this._getCacheItem("user_directory_hash").then(e=>void 0!==e?this._deleteCacheItem("user_directory_hash").then(()=>this.updateUserDirectory().then(t=>n.Promise.resolve(t)).catch(t=>n.Promise.reject(t))):n.Promise.reject(t)))}searchUsers(t,e){return this.initUserDirectory().then(()=>this._userDirectory.search(t,e))}getAllUsers(t=!1){return this.initUserDirectory().then(()=>this._userDirectory.getAllUsers(t))}getUserByJid(t){return this.initUserDirectory().then(()=>this._userDirectory.getUserByJid(t))}downloadAttachments(t,e=!0){return new n.Promise((i,o)=>{if(Array.isArray(t.attachments)&&t.attachments.length>0){let s=n.Promise.resolve({});t.attachments.forEach((e,i)=>{s=s.then(()=>new n.Promise((n,o)=>{void 0===e.path?this.doDownload(e.get).then(e=>{t.attachments[i].path=e.source,t.attachments[i].mediaType=r.getMediaTypeFromExtension(e.source),t.attachments[i].state="transferred",n()}).catch(o):n()}))}),s.then(()=>{this.saveMessage(t._id,()=>t).then(t=>{!1!==e&&this._dispatchEvent(u.EVENT_TYPES.MESSAGE_UPDATED,t),this._log(`Successfully updated message '${t._id}' with attachments.`,t),i(t)}).catch(e=>{this._onError(`Unable to update message '${t._id}' with attachments:`,e),o(e)})}).catch(t=>{this._onError("Unable to download all message attachments:",t),o(t)})}else i(t)})}_processNewMessage(t,e,i=!0,o=!0){return this._perfStart(`processNewMessage (${t.message.$attributes.id.split("-")[0]})`,"Starting to process a new message","color: purple;"),new n.Promise((n,s)=>{this._setLastArchiveId(this._getArchiveIdFromStanza(t)),this._messageStanzaToDbObject(t,e).then(t=>(!1!==o&&(null===t.updated_at?this._dispatchEvent(u.EVENT_TYPES.NEW_MESSAGE,t):this._dispatchEvent(u.EVENT_TYPES.MESSAGE_UPDATED,t)),this.getSyncedTimestamp((new Date).getTime())-t.ts<this._options.autoDownloadAttachmentTime||-1==this._options.autoDownloadAttachmentTime?this.downloadAttachments(t,o):t)).then(e=>{t.message.markable&&!0===i&&!0===this._options.autoMarkMessages?this._markMessage(e,u.MARKER_TYPES.RECEIVED,o).then(e=>{this._perfEnd(`processNewMessage (${t.message.$attributes.id.split("-")[0]})`,"Finished processing a new message","color: purple;"),n(e)}).catch(s):(this._perfEnd(`processNewMessage (${t.message.$attributes.id.split("-")[0]})`,"Finished processing a new message","color: purple;"),n(e))}).catch(s)})}_processGroupMessage(t,e,i=!0,n=!0){const s=u._merge({type:"groupchat",mine:o.default.Strophe.getBareJidFromJid(t.message.$attributes.from)===this._bareJid||o.default.Strophe.getResourceFromJid(t.message.$attributes.from)===this.username},e);try{this._stanzaResponseHandler(t.message.$attributes.id)}catch(e){this._onError("Couldn't process stanza response handler for stanza:",t)}return this._processNewMessage(t,s,i,n)}_updateMessageMarkers(t,e,i){if(!i._id)return!1;if(!i.markable)return!1;const n=o.default.Strophe.getBareJidFromJid(t.message.$attributes.from),s=o.default.Strophe.getResourceFromJid(t.message.$attributes.from);if(!0===i.state.markers.some(t=>{if(t.type===e&&(t.sender_id===n&&t.sender_resource===s||t.sender_resource===this.bareJid))return!0}))return!1;const r={type:e,sender_id:n,sender_resource:s,recipient_id:t.message.$attributes.to,ts:this._getTimestampFromStanza(t),priority:u.MARKER_PRIORITIES[e]};return i.state.markers.push(r),i.state.markers=i.state.markers.sort(function(t,e){return t.priority!==e.priority?t.priority-e.priority:null!==e.ts&&null!==t.ts?e.ts-t.ts:void 0}),i.state[e]=!0,!0!==i.state.sent&&(i.state.sent=!0),i.updated_at=this.getSyncedTimestamp(Date.now()),i}static _getMarkerType(t){let e=null;return t.message.received?e=u.MARKER_TYPES.RECEIVED:t.message.read?e=u.MARKER_TYPES.READ:t.message.acknowledged&&(e=u.MARKER_TYPES.ACKNOWLEDGED),e}static _getMarkerMessageId(t,e){return void 0!==t.message[e].$attributes&&void 0!==t.message[e].$attributes.id?t.message[e].$attributes.id:null}_processMarkerMessage(t,e=!0){return new n.Promise((i,n)=>{this._setLastArchiveId(this._getArchiveIdFromStanza(t));const s=u._getMarkerType(t);if(null!==s){const r=u._getMarkerMessageId(t,s);if(null!==r){this._log(`Processing marker of type '${s}' for message with ID '${r}':`,t),this._stanzaResponseHandler(t.message.$attributes.id);const a=o.default.Strophe.getBareJidFromJid(t.message.$attributes.from),c=o.default.Strophe.getResourceFromJid(t.message.$attributes.from);this.saveMessage(r,e=>this._updateMessageMarkers(t,s,e)).then(t=>{if(null!==t){const n={message_id:t._id,message:t,type:s,sender_id:a,sender_resource:c};!1!==e&&this._dispatchEvent(u.EVENT_TYPES.RECEIPT_RECEIVED,n),!1!==e&&this._dispatchEvent(u.EVENT_TYPES.MESSAGE_UPDATED,t),i(n)}else i(null)}).catch(n)}}})}_processErrorMessage(t){return new n.Promise((e,i)=>{const n=t.message.$attributes&&t.message.$attributes.id?t.message.$attributes.id:null;if(null!==n){const o=t.message.error&&t.message.error.text&&t.message.error.text.$value?t.message.error.text.$value:`The server returned an error for stanza with ID '${n}'.`;this._onError(o,Object.assign({},t.message.error,{messageId:n})),this._stanzaResponseHandler(n,o),this.saveMessage(n,t=>void 0!==t._id&&(!0!==t.state.read&&!0!==t.state.received&&!0!==t.state.acknowledged?t.state.sent=!1:!0!==t.state.sent&&(t.state.sent=!0),t)).then(()=>{e({id:n,msg:o})}).catch(i)}else e()})}_processAckMessage(t){return new n.Promise((e,i)=>{if(t.message.ack&&t.message.ack.$attributes&&t.message.ack.$attributes["original-id"]){const n=t.message.ack.$attributes["original-id"];this._stanzaResponseHandler(n),this._dispatchEvent(u.EVENT_TYPES.ACK_RECEIVED,n),this.saveMessage(n,t=>void 0!==t._id&&(!0!==t.state.sent&&(t.state.sent=!0),t)).then(e).catch(i)}else e()})}_onIq(t){return t&&t.iq&&t.iq.ping&&t.iq.$attributes&&t.iq.$attributes.from&&t.iq.$attributes.id&&setTimeout(()=>{this.sendIq(t.iq.$attributes.from,"result",{},void 0,t.iq.$attributes.id)},0),!0}_onStanza(t){this.connected=!0,this._setStatus(o.default.Strophe.Status.CONNECTED);try{const e=u.xmlToJson(t);if(this._isFilteredOut(e))return!0;if(this._log(`[1] - Processing stanza with ID '${e.message.$attributes.id}':`,e),e.message.$attributes&&"chat"===e.message.$attributes.type&&void 0!==e.message.sent&&void 0!==e.message.sent.$attributes&&e.message.sent.$attributes.xmlns===u.NAMESPACES.CARBONS&&void 0!==e.message.sent.forwarded)this._processNewMessage(e.message.sent.forwarded,{state:{sent:!0}});else if(e.message.$attributes&&"chat"===e.message.$attributes.type)this._processNewMessage(e);else if(e.message.event&&e.message.event.items){const t=t=>{u._isMarkerMessage(t)?(this._log(`[2] - Processing stanza with ID '${e.message.$attributes.id}':`,e),this._processMarkerMessage(t)):this._processGroupMessage(t)};Array.isArray(e.message.event.items.item)?e.message.event.items.forEach(e=>{e.message&&e.message.$attributes&&"groupchat"===e.message.$attributes.type?t(e):e.presence&&this._onPresence(e)}):"object"==typeof e.message.event.items.item&&e.message.event.items.item.message&&e.message.event.items.item.message.$attributes&&"groupchat"===e.message.event.items.item.message.$attributes.type?t(e.message.event.items.item):"object"==typeof e.message.event.items.item&&e.message.event.items.item.presence&&this._onPresence(e.message.event.items.item)}else u._isMarkerMessage(e)?(this._log(`[3] - Processing stanza with ID '${e.message.$attributes.id}':`,e),this._processMarkerMessage(e)):e.message.$attributes&&"groupchat"===e.message.$attributes.type&&e.message.$attributes.id?this._processGroupMessage(e):e.message.$attributes&&"error"===e.message.$attributes.type?this._processErrorMessage(e):void 0!==e.message.ack?this._processAckMessage(e):e.message.call&&e.message.call.$attributes&&e.message.call.$attributes.xmlns===u.NAMESPACES.INFINITY_BOT?(this._log(`Processing bot command response with request ID '${e.message.call.$attributes["request-id"]}':`,e),this._botCommandResponseHandler(e.message.call.$attributes["request-id"],e)):e.message.error&&e.message.error.$attributes&&e.message.error.$attributes.xmlns===u.NAMESPACES.INFINITY_BOT&&this._botCommandResponseHandler(e.message.error.$attributes["request-id"],e)}catch(t){this._onError("An error occurred when processing an incoming message stanza:",t)}return!0}_isFilteredOut(t){let e=!0;return this._includeStanzaFilters.length>0&&(e=!1,this._includeStanzaFilters.some(e=>{try{return e(t)}catch(t){return this._log("Include filter function failed: "+t),this._onError("Include filter function failed: "+t),!1}})&&(e=!0)),this._excludeStanzaFilters.some(e=>{try{return e(t)}catch(t){return this._log("Exclude filter function failed: "+t),this._onError("Exclude filter function failed: "+t),!1}})&&(e=!1),!e}_messageIsGroupChat(t){return this._options.mucHost&&t.$attributes&&"string"==typeof t.$attributes.from&&t.$attributes.from.indexOf(this._options.mucHost)>-1}_onPresence(t){if(void 0!==t.presence){const e=t.presence;if(void 0!==e.$attributes&&void 0!==e.$attributes.from){if("error"===e.$attributes.type)return this._onError("An error from the server was received in a presence stanza:",e),!0;const t=o.default.Strophe.getBareJidFromJid(e.$attributes.from);if(!t)return!0;if(t===this._bareJid)this.setChatStatus(e.show,e.status,!1,e.metadata);else{const i=u.getDomainFromJid(t);this._options.mucHost===i?this.saveParticipant(e.$attributes.from,t=>{if(void 0!==t._id)try{if(t.show=e.show,t.status=e.status,t.online="unavailable"!==e.$attributes.type,t.affiliation=e.x.item.$attributes.affiliation,t.room_role=e.x.item.$attributes.role,t.last_stanza=e,void 0!==e.metadata){const i=e.metadata;delete i.$attributes,t.metadata=i}t.updated_at=this.getSyncedTimestamp(Date.now())}catch(e){this._onError(`Presence stanza wasn't in the expected format when trying to update participant with ID '${t._id}' and JID '${t.jid}'.`,e)}else try{if(t._id=e.$attributes.from,t.jid=o.default.Strophe.getBareJidFromJid(e.x.item.$attributes.jid),t.is_current_user=t.jid===this._jid,t.username=o.default.Strophe.getNodeFromJid(t.jid),t.room_name=o.default.Strophe.getNodeFromJid(e.$attributes.from),t.affiliation=e.x.item.$attributes.affiliation,t.room_role=e.x.item.$attributes.role,t.online="unavailable"!==e.$attributes.type,t.show=e.show,t.status=e.status,t.ts=this.getSyncedTimestamp(Date.now()),void 0!==e.metadata){const i=e.metadata;delete i.$attributes,t.metadata=i}t.updated_at=null,t.last_stanza=e}catch(e){this._onError(`Presence stanza wasn't in the expected format when trying to create a new participant with ID '${t._id}' and JID '${t.jid}'.`,e)}return t}).then(t=>{null===t.updated_at?this._dispatchEvent(u.EVENT_TYPES.NEW_PARTICIPANT,t):this._dispatchEvent(u.EVENT_TYPES.PARTICIPANT_UPDATED,t)}).catch(t=>{this._onError("Couldn't upsert participant database.",t)}):this._saveObject(u.OBJECT_TYPES.CONTACT,t,t=>{if(void 0!==t&&(t.online="unavailable"!==e.$attributes.type,void 0!==e.show&&(t.show=e.show),void 0!==e.status&&(t.status=e.status),void 0!==e.metadata)){const i=e.metadata;delete i.$attributes,t.metadata=i}return t},i=>{let n=!1;e.x&&e.x.$attributes&&e.x.$attributes.xmlns&&e.x.$attributes.xmlns===u.NAMESPACES.VCARD_UPDATE&&void 0!==e.x.photo&&"string"==typeof e.x.photo&&(void 0!==i.avatarHash&&i.avatarHash===e.x.photo||(n=!0,this._log(" Avatar update for:",t),this._log(" New avatar hash:",e.x.photo),this.updatevCardForContact(t).then(()=>{this._saveObject(u.OBJECT_TYPES.CONTACT,t,t=>(t.avatarHash=e.x.photo,t),t=>{this._dispatchEvent(u.EVENT_TYPES.PRESENCE_UPDATE,t)},t=>{this._onError("Couldn't update contact with vCard: ",t)})}).catch(t=>{this._onError("Couldn't get updated vCard for contact: ",t)}))),!1===n&&this._dispatchEvent(u.EVENT_TYPES.PRESENCE_UPDATE,i)},t=>{this._onError("Couldn't upsert contacts database.",t)})}}}return!0}getContactByJid(t){return this._isMethodReady(!0),new n.Promise((e,i)=>{this.findContacts({id:t}).then(n=>{let o=n[0];void 0!==o?e(o):i("No contact found: "+t)}).catch(i)})}updatevCardForContact(t){return this._isMethodReady(!0,!0),this._log(" Updating vCard for Contact:",t),new n.Promise((e,i)=>{this.findContacts({id:t}).then(e=>{let n=e[0];if(void 0!==n)return n;this._log(" No contact:",t),i("No contact found: "+t)}).then(n=>{this._getvCard(t).then(n=>{if(void 0!==n){const o=h.VCardSimple.fromXml(n);void 0!==o?this._saveObject(u.OBJECT_TYPES.CONTACT,t,t=>(t.vCard=o.toJSON(),t),i=>{this._log(" vCard Updated:",t),e(i)},e=>{this._log(" Couldn't save contact:",t),i("Couldn't save contact: "+e)}):(this._log(" Bad vCard:",t),i("Bad vCard"))}else this._log(" No vCard:",t),e(null)}).catch(i)}).catch(i)})}_processRoster(t){return new n.Promise((e,i)=>{if(void 0!==t&&void 0!==t.iq&&void 0!==t.iq.query)if(void 0!==t.iq.query.$attributes&&void 0!==t.iq.query.$attributes.ver&&this._setCacheItem("roster_version",t.iq.query.$attributes.ver).catch(i),void 0!==t.iq.query.item){const o=[];(Array.isArray(t.iq.query.item)?t.iq.query.item:[t.iq.query.item]).forEach(t=>{if(void 0!==t.$attributes.jid){const e={id:t.$attributes.jid,subscription:t.$attributes.subscription,online:!1};void 0!==t.group&&("string"==typeof t.group?e.groups=[t.group]:Array.isArray(t.group)&&(e.groups=t.group)),o.push(e)}}),this._contactDb.allDocs({include_docs:!0}).then(t=>{const s=[];t.rows.forEach(t=>{let e=t.doc,i=null;o.every((t,n)=>t.id!==e.id||(i=t,delete o[n],!1)),null===i?s.push(this._contactDb.remove(e)):e.subscription===i.subscription&&u._arraysEqual(e.groups,i.groups)||(e=u._merge(e,i),this._log("MERGED CONTACT:",e),s.push(this._contactDb.post(e)))}),o.forEach(t=>{this._log("ADDING NEW CONTACT:",t),s.push(new n.Promise((e,i)=>{this._saveObject(u.OBJECT_TYPES.CONTACT,t.id,e=>t,i=>{this._log("CONTACT ADDED:",t.id),e(i)},e=>{this._log("CONTACT ADD FAILED:"+t.id+": "+e),i(e)})}))}),n.Promise.all(s).then(e).catch(t=>{this._onError("Couldn't merge contacts from server with locally sorted contacts.",t),i(t)})})}else e();else e()})}getvCardsForAllContacts(){return this._isMethodReady(!0,!0),this._log(" Fetching all vCards..."),new n.Promise((t,e)=>{this.getContacts().then(i=>{const o=[];i.forEach((t,e)=>{this._log(" Fetching vCard for:",t.id),o.push(new n.Promise((e,i)=>{this.updatevCardForContact(t.id).then(()=>{this._log(" Fetched vCard for:",t.id),e()}).catch(t=>{e()})}))}),n.Promise.all(o).then(t).catch(e)})})}getOurvCard(){return this._isMethodReady(!0,!0),this._log(" Fetching vCard for:",this._bareJid),new n.Promise((t,e)=>{this._getvCard(this._bareJid).then(i=>{if(void 0===i||i.length<1)return e("No vCard");const n=h.VCardSimple.fromXml(i);void 0!==n?(this._log(" Fetched vCard: ",n.toJSON()),t(n.toJSON())):(this._log(" Bad vCard: ",this._bareJid),e("Bad vCard"))}).catch(e)})}saveOurvCard(t){return this._isMethodReady(!0,!0),this._log(" Saving vCard for:",this._bareJid),new n.Promise((e,i)=>{const n=h.VCardSimple.fromJSON(t);this._setvCard(this._bareJid,n.toXML(!0)).then(()=>{this._log(" Saved vCard for:",this._bareJid),e()}).catch(i)})}_onError(t,e){console.error(t,e||""),this._dispatchEvent(u.EVENT_TYPES.ERROR,e)}_setCacheItem(t,e,i=!1){return new n.Promise((n,o)=>{const s=()=>{this._saveObject(u.OBJECT_TYPES.CACHE_ITEM,t,t=>t.value!==e&&(t.value=e,t.secret=!0===i,t),e=>{const i=e.value;!1===e.secret&&(this._cache[t]=i),n(e.value)},i=>{i===u.ERROR_CODES.DESTROYING_DBS?n():(this._onError(`Couldn't set cache item '${t}' with value '${e}'.`),o(i))})};this._getCacheItem(t).then(t=>{t===e?n(t):s()}).catch(s)})}_getCacheItem(t,e=0){return new n.Promise(i=>{void 0!==this._cache[t]?i(this._cache[t]):this._cacheDb.get(t).then(n=>{if(this._options.encryption&&!n.hasOwnProperty("value"))5===(e+=1)?i():setTimeout(()=>{this._getCacheItem(t,e).then(i)},100);else{const e=n.value;!1===n.secret&&(this._cache[t]=e),i(e)}}).catch(()=>{i()})})}_deleteCacheItem(t){return new n.Promise((e,i)=>{this._cacheDb.get(t).then(n=>{this._cacheDb.remove(n).then(()=>{delete this._cache[t],e()}).catch(i)}).catch(()=>{e()})})}_messageDelta(t,e,i){const n=t.message.$attributes.from,s=o.default.Strophe.getBareJidFromJid(n),r=o.default.Strophe.getResourceFromJid(n);if(void 0!==e._id)t!==e.stanza&&(e.stanza=t),void 0!==t.message.body&&t.message.body!==e.body&&(e.body=t.message.body),null===e.type&&(e.type=t.message.$attributes.type),"groupchat"===e.type&&(e.state.sent=!0),null===e.jid&&(e.jid=n),null===e.sender_id&&(e.sender_id=s),null===e.sender_resource&&(e.sender_resource=r),null===e.recipient_id&&(e.recipient_id=t.message.$attributes.to),void 0!==t.message.data&&t.message.data!==e.data&&(e.data=t.message.data),(null===e.ts||t.message.timestamp&&t.message.timestamp.length>1)&&(e.ts=this._getTimestampFromStanza(t)),null===e.mine&&(e.mine=s===this._bareJid),e.placeholder=!1,e.archive_id=this._getArchiveIdFromStanza(t),e.updated_at=this.getSyncedTimestamp(Date.now()),e=u._merge(e,i);else{let i=[];void 0!==t.message.attachments&&(Array.isArray(t.message.attachments)?i=t.message.attachments:i.push(t.message.attachments)),t.message.$attributes.id,this._getArchiveIdFromStanza(t),t.message.$attributes.to,t.message.body,this._getTimestampFromStanza(t),t.message.data,t.message.$attributes.type,this._bareJid,t.message.markable;let o=[];void 0!==t.message.addresses&&(Array.isArray(t.message.addresses.address)?o=t.message.addresses.address:o.push(t.message.addresses.address)),e=Object.assign({},u._messageSkeleton(),{_id:t.message.$attributes.id,stanza:t,archive_id:this._getArchiveIdFromStanza(t),jid:n,sender_id:s,sender_resource:r,recipient_id:t.message.$attributes.to,body:t.message.body,ts:this._getTimestampFromStanza(t),data:t.message.data,attachments:i,type:t.message.$attributes.type,mine:s===this._bareJid,markable:void 0!==t.message.markable,addresses:o})}return t.message.$attributes&&"groupchat"===t.message.$attributes.type&&(e.type="groupchat",e.mine=o.default.Strophe.getBareJidFromJid(t.message.$attributes.from)===this._bareJid||o.default.Strophe.getResourceFromJid(t.message.$attributes.from)===this.username),u._merge(e,i)}static _messageSkeleton(){return{_id:null,stanza:null,archive_id:null,jid:null,sender_id:null,sender_resource:null,recipient_id:null,body:null,updated_at:null,ts:null,state:{sent:null,markers:[],received:null,read:null,acknowledged:null},data:{},attachments:[],type:"chat",mine:null,markable:!1,fromMam:!1,placeholder:!1,injected:!1}}_messageStanzaToDbObject(t,e){return new n.Promise((i,n)=>{if(void 0!==t.message&&void 0!==t.message.$attributes)this.saveMessage(t.message.$attributes.id,i=>this._messageDelta(t,i,e)).then(i).catch(t=>{this._onError("Unable to convert message stanza to DB object.",t),n(t)});else{const t="No message part present in the stanza.";this._onError(t),n(t)}})}_getTimestampFromStanza(t){let e=null;if(void 0!==t.message&&void 0!==t.message.timestamp)if(Array.isArray(t.message.timestamp)){const i=t.message.timestamp.filter(t=>void 0!==t.$attributes&&t.$attributes.xmlns===u.NAMESPACES.CT_SERVER_TIMESTAMP);void 0!==i[0]&&(e=parseInt(i[0].$value))}else void 0!==t.message.timestamp.$value&&(e=parseInt(t.message.timestamp.$value));return null===e&&(e=this.getSyncedTimestamp(Date.now())),e}_getArchiveIdFromStanza(t){let e=null;if(void 0!==t.message.archived){const i=Array.isArray(t.message.archived)?t.message.archived[0]:t.message.archived;void 0!==i.$attributes&&void 0!==i.$attributes.id&&(e=i.$attributes.id)}return e}_log(t,e){!0===this._options.debug&&console.debug("["+(new Date).toString()+"] ",t,e||"")}getUniqueId(){return this._isMethodReady(!0,!0),this._connection.getUniqueId(`${this._instanceId}-${performance.now()}`)}_clearBotTimeout(t){this._botCommandTimeouts[t]&&(this._log(`Bot command response verified, removing bot timeout for request '${t}'.`),this._botCommandTimeouts[t].cancel(),delete this._botCommandTimeouts[t])}_clearBotPromise(t){this._botCommandPromises[t]&&(this._log(`Clearing bot command promise for request '${t}'.`),delete this._botCommandPromises[t])}_botCommandResponseHandler(t,e){if(!this._botCommandPromises[t])return!1;if(void 0!==e.message&&void 0!==e.message.$attributes&&"error"===e.message.$attributes.type){const i=void 0!==e.message.error&&void 0!==e.message.error.$attributes&&e.message.error.$attributes["request-id"]?e.message.error.$attributes["request-id"]:null;if(i===t){this._clearBotTimeout(i);const n=void 0!==e.message.error&&void 0!==e.message.error.text?e.message.error.text.$value:"An unexpected error occurred";this._botCommandPromises[t].reject(n),this._clearBotPromise(t)}}else if(void 0!==e.message&&void 0!==e.message.call&&void 0!==e.message.call.$attributes&&"result"===e.message.call.$attributes.type&&e.message.call.$attributes["request-id"]===t){if(this._clearBotTimeout(t),void 0!==e.message.call.json&&void 0!==e.message.call.json.$value){let i=null;try{i=JSON.parse(e.message.call.json.$value)}catch(e){this._onError("Couldn't parse JSON from bot command response:",e),this._botCommandPromises[t].reject(e),this._clearBotPromise(t)}null!==i&&(this._botCommandPromises[t].resolve(i),this._clearBotPromise(t))}return!1}return!0}sendBotCommand(t,e,i,o=5e3){return this._isMethodReady(!0,!0),new n.Promise((n,s)=>{const r=this.getUniqueId(),a={$attributes:{to:t,type:"normal"},call:{$attributes:{xmlns:u.NAMESPACES.INFINITY_BOT,"request-id":r,type:"get",name:e}}};let l=null;try{l=JSON.stringify(i)}catch(t){this._onError("Couldn't stringify JSON:",t)}null!==l&&(a.call.json={$attributes:{xmlns:"urn:xmpp:json:0"},$value:l}),this._botCommandPromises[r]={resolve:n,reject:s},this.sendStanza(a,!1).then(()=>{this._log(`Creating bot command timer for request '${r}'...`),this._botCommandTimeouts[r]=new c.default(r,()=>{this._log(`Bot command timer finished for request '${r}'.`),this._onError(`Didn't get a response from the bot within ${o}ms.`,{operationName:e}),this._botCommandPromises[r].reject("Your request took longer then expected, please try again.")},o)}).catch(t=>{this._onError("Couldn't send bot command:",t),s(t)})})}_pushHandler(t){this._log("Push Received: ",t)}_getPushTokens(){return new n.Promise((t,e)=>{const i=function(i=null){const n=a.getSource("PushNotification"),o=a.getSource("notification");if(!1!==n){const o={android:{},ios:{badge:"true",sound:"true",alert:"true"}};this._log("Registering for push notifications...");const s=this,r=n.init(o);r.on("registration",function(e){const n=e.registrationId;s._log("Registered for push:",n),s._setCacheItem("push_token",n).then(()=>{t({voipToken:i,standardToken:n})})}),r.on("notification",function(t){s._pushHandler.call(s,t)}),r.on("error",function(t){s._log("Error registering for push:",t),e(t)})}else if(!1!==o){let n=null;"android"===s.getPlatformName()?n={senderID:this._options.push.senderId}:"ios"===s.getPlatformName()&&(n={badge:"true",sound:"true",alert:"true"}),this._log("Registering for push notifications...");const r=this;o.registerForPush(function(e){r._log("Registered for push:",e),o.on("pushReceived",function(t){r._pushHandler(t),r._options.push.reLoginOnPushAndroid&&(r.connected||r.reLoginNow())}),r._setCacheItem("push_token",e).then(()=>{t({voipToken:i,standardToken:e})})},function(t){r._log("Error registering for push:",t),e(t)},n)}else this._log("Could not find Push plugin"),e("Could not find Push plugin")};if(this._options.push.voip&&"ios"===s.getPlatformName()){const t=this,n=a.getSource("VoIPPushNotification");if(!1!==n){const e=n.init();e.on("registration",function(e){t._log("Registered for push: ",e.deviceToken),t._setCacheItem("push_token",e.deviceToken).then(()=>{i.call(t,e.deviceToken)})}),e.on("notification",function(e){t._pushHandler(e),t._options.push.reLoginOnPushiOS&&(t.connected||t.reLoginNow())}),e.on("error",function(e){t._log("VOIP Push Error: "+e)})}else this._log("Could not find VOIP Push plugin"),e("Could not find VOIP Push plugin")}else i.call(this)})}registerForPush(t){if(!s.isDevice())throw new Error("This platform does not support push notifications.");return new n.Promise((e,i)=>{const n={package:this._options.push.packageId,type:"ios"===s.getPlatformName()?"apns":"gcm",token:t.standardToken,installation_id:this._installId};t.voipToken&&(n.voip_token=t.voipToken),this.sendIq(null,"set",{push:{$attributes:{xmlns:u.NAMESPACES.CT_PUSH},notification:n}}).then(t=>{let n=null;try{n=t.iq.push.notification.$attributes.jid,this._pushNodeName=t.iq.push.notification.$attributes.node}catch(t){this._onError("Couldn't enable push notifications.",t),i(t)}null!==n&&this._setCacheItem("push_jid",n).then(()=>{this.enablePush().then(e).catch(i)})}).catch(t=>{this._onError("Couldn't register for push notifications:",t),i(t)})})}enablePush(){return new n.Promise((t,e)=>{this._getCacheItem("push_jid").then(i=>{void 0!==i?this.sendIq(null,"set",{enable:{$attributes:{xmlns:u.NAMESPACES.PUSH,jid:i,node:this._pushNodeName}}}).then(t).catch(t=>{this._onError("Unable to enable push notifications:",t),e(t)}):(this._onError("'registerForPush' must be called before 'enablePush'."),e())})})}disablePush(){return new n.Promise((t,e)=>{this._getCacheItem("push_jid").then(i=>{void 0!==i?this.sendIq(null,"set",{disable:{$attributes:{xmlns:u.NAMESPACES.PUSH,jid:i,node:this._pushNodeName}}}).then(t).catch(t=>{this._onError("Unable to disable push notifications:",t),e(t)}):t()})})}_perfStart(t,e,i){!0===this._options.perfLogging&&(console.log(`%c[START: ${t}] ${e}`,i),console.time(t))}_perfEnd(t,e,i){!0===this._options.perfLogging&&(console.log(`%c[END: ${t}] ${e}`,i),console.timeEnd(t))}static jsonToXml(t,e){return u._parseJsonNode(e,u._createElement(t,e.$attributes))}static _parseJsonNode(t,e){for(let i in t){let n=t[i];if(0!==i.indexOf("$"))if(Array.isArray(n)&&n.length>0)n.forEach(t=>{let n;"string"==typeof t?(n=u._createElement(i,{})).textContent=t:(n=u._createElement(i,t.$attributes),n=u._parseJsonNode(t,n)),e.appendChild(n)});else{const t="object"==typeof n&&null!==n?n.$attributes:void 0;let o=u._createElement(i,t);if("object"==typeof n&&null!==n&&Object.keys(n).length>0)o=u._parseJsonNode(n,o);else if("string"==typeof n){const t=u.doc.createTextNode(n);o.appendChild(t)}e.appendChild(o)}else if("$value"===i){const t=u.doc.createTextNode(n);e.appendChild(t)}else if("$cdata"===i){const t=u.doc.createCDATASection(n);e.appendChild(t)}}return e}static xmlToJson(t){return u._parseXmlNode(t,{})}static _parseXmlNode(t,e){let i={};if(void 0!==t.attributes&&t.attributes.length>0){i.$attributes={};for(let e=0;e<t.attributes.length;e++){const n=t.attributes[e];i.$attributes[n.nodeName]=n.value}}if(t.childNodes.length>0)for(let e=0;e<t.childNodes.length;e++){const n=t.childNodes[e];if(3===n.nodeType)void 0!==i.$attributes?i.$value=n.textContent:i=n.textContent;else if(4===n.nodeType)i.$cdata=n.textContent;else{if("\n"===i)continue;u._parseXmlNode(n,i)}}return void 0!==e[t.nodeName]&&!1===Array.isArray(e[t.nodeName])&&(e[t.nodeName]=[e[t.nodeName]]),Array.isArray(e[t.nodeName])?e[t.nodeName].push(i):e[t.nodeName]=i,e}static _createElement(t,e){null===u.doc&&(u.doc=document.implementation.createDocument("ct:xmpp:client","infinity",null));const i=u.doc.createElement(t);if(void 0!==e&&Object.keys(e).length>0)for(let t in e)i.setAttribute(t,e[t]);return i}static _getContactFromRosterByJid(t,e){let i=null;return void 0!==e&&void 0!==e.contacts&&e.contacts.length>0&&e.contacts.forEach(e=>{e.jid===t&&(i=e)}),i}static _isObject(t){return t&&"object"==typeof t&&!Array.isArray(t)}static _merge(t,...e){if(!e.length)return t;const i=e.shift();if(u._isObject(t)&&u._isObject(i))for(const e in i)u._isObject(i[e])?(t[e]||Object.assign(t,{[e]:{}}),u._merge(t[e],i[e])):Object.assign(t,{[e]:i[e]});return u._merge(t,...e)}static _arraysEqual(t,e){if(!Array.isArray(t)||!Array.isArray(e))return t===e;if(t.length!==e.length)return!1;for(let i=t.length;i--;)if(t[i]!==e[i])return!1;return!0}static _validateEventType(t){return u._validateConstants(u.EVENT_TYPES,t)}static _validateChatStatus(t){return u._validateConstants(u.CHAT_STATUSES,t)}static _validateConstants(t,e){for(let i in t)if(t[i]===e)return!0;return!1}static getDomainFromJid(t){return o.default.Strophe.getBareJidFromJid(t).split("@")[1]}static _isMarkerMessage(t){return t.message.received&&t.message.received.$attributes&&t.message.received.$attributes.xmlns===u.NAMESPACES.CHAT_MARKERS||t.message.read&&t.message.read.$attributes&&t.message.read.$attributes.xmlns===u.NAMESPACES.CHAT_MARKERS||t.message.acknowledged&&t.message.acknowledged.$attributes&&t.message.acknowledged.$attributes.xmlns===u.NAMESPACES.CHAT_MARKERS}static getNodeFromJid(t){return o.default.Strophe.getNodeFromJid(t)}static pickFile(t={}){return r.pickFile(t)}_isMethodReady(t=!0,e=!1){if(!0===t&&!0!==this._initialised)throw new Error("XMPP client has not yet been fully initialised.");if(!0===e&&!1===this.connected)throw new Error("An active connection is required to perform this action.")}static isInBackground(){return d.isInBackground()}}u.doc=null,u.MARKER_TYPES={RECEIVED:"received",READ:"read",ACKNOWLEDGED:"acknowledged"},u.EVENT_TYPES={INITIALISED:"initialised",STATUS:"status",NEW_MESSAGE:"newmessage",ERROR:"error",MESSAGE_UPDATED:"messageupdated",PRESENCE_UPDATE:"presenceupdate",NEW_PARTICIPANT:"newparticipant",PARTICIPANT_UPDATED:"participantupdated",RECEIPT_RECEIVED:"receiptreceived",AUTO_RECONNECTED:"autoreconnected",DBS_DESTROYED:"dbsdestroyed",AUTO_DBS_DESTROYED:"autodbsdestroyed",ACK_RECEIVED:"ackreceived",UPLOAD_STARTED:"uploadstarted",UPLOAD_SUCCESS:"uploadsuccess",UPLOAD_FAILED:"uploadfailed"},u.CHAT_STATUSES={AWAY:"away",CHAT:"chat",DND:"dnd",XA:"xa"},u.NAMESPACES={MUC:"http://jabber.org/protocol/muc",MUC_SUB:"urn:xmpp:mucsub:0",MUC_OWNER:"http://jabber.org/protocol/muc#owner",X_DATA:"jabber:x:data",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",JABBER_CLIENT:"jabber:client",MAM:"urn:xmpp:mam:0",MAM_TMP:"urn:xmpp:mam:tmp",RESULT_SET_MANAGEMENT:"http://jabber.org/protocol/rsm",CHAT_MARKERS:"urn:xmpp:chat-markers:0",CT_METADATA:"ct:metadata:0",HINTS:"urn:xmpp:hints",CT_CLIENT_TIMESTAMP:"ct:client-timestamp:0",CT_SERVER_TIMESTAMP:"urn:commontime:infinity:timestamps",HTTP_UPLOAD:"urn:xmpp:http:upload",PING:"urn:xmpp:ping",CLIENT_STATE_INDICATION:"urn:xmpp:csi:0",ADDRESS:"http://jabber.org/protocol/address",VCARD_UPDATE:"vcard-temp:x:update",TIME:"urn:xmpp:time",INFINITY_BOT:"urn:commontime:infinity:api",PRIVATE_XML_STORAGE:"jabber:iq:private",CT_PRIVATE_XML_STORAGE:"ct:private-xml-data",CT_PUSH:"urn:commontime:infinity:push",PUSH:"urn:xmpp:push:0",DIRECTORY:"urn:commontime:infinity:directory",CARBONS:"urn:xmpp:carbons:2",INFINITY_MAM:"urn:commontime:infinity:mam",INFINITY_ACK:"urn:commontime:infinity:ack",SOFTWARE_VERSION:"jabber:iq:version"},u.MUC_NODES={PRESENCE:"urn:xmpp:mucsub:nodes:presence",MESSAGES:"urn:xmpp:mucsub:nodes:messages",AFFILIATIONS:"urn:xmpp:mucsub:nodes:affiliations",CONFIG:"urn:xmpp:mucsub:nodes:config",SUBJECT:"urn:xmpp:mucsub:nodes:subject",SYSTEM:"urn:xmpp:mucsub:nodes:system"},u.MARKER_PRIORITIES={received:3,read:2,acknowledged:1},u.OBJECT_TYPES={MESSAGE:"message",CONTACT:"contact",ROOM:"room",PARTICIPANT:"participant",CACHE_ITEM:"cache_item",OBJECT_URL:"object_url"},u.CLIENT_STATES={ACTIVE:"active",INACTIVE:"inactive"},u.ERROR_CODES={DESTROYING_DBS:"destroying_dbs"},e.CtXmppClient=u,window.CtXmppClient=u},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=window,o=window;e.getSource=function(t){if(void 0!==n[t])return n[t];if(void 0!==n.cordova&&void 0!==n.cordova[t])return n.cordova[t];if(void 0!==n.cordova&&void 0!==n.cordova.plugins&&void 0!==n.cordova.plugins[t])return n.cordova.plugins[t];if(void 0!==n.plugins&&void 0!==n.plugins[t])return n.plugins[t];if(void 0!==navigator&&void 0!==navigator[t])return navigator[t];if(void 0===o.require)return console.warn(`Plugin '${t}' is not available.`),!1;{let e=!1;try{return e=o.require(t)}catch(i){if(!1===e||void 0===e){const e=t.replace(/\-/g,"").toLowerCase();try{return o.require("@commontimeltd/com.commontime."+e)}catch(t){return!1}}return!1}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),e.BaseEventArgs=class{constructor(){this.eventDate=(new Date).getTime()}}},function(t,e){t.exports=skate},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(83);e.IQError=n.IQError;var o=i(84);e.NotConnectedError=o.NotConnectedError},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0);e.UserLookup=class{constructor(t){if(!t)throw new Error("Chat Layer Component Interface not supplied");this._layer=t,this._users=new Map}populate(t=[],e=[]){return n(this,void 0,void 0,function*(){const i=new Set;t&&t.forEach(t=>this._addFromConversation(t,i)),e&&e.forEach(t=>n(this,void 0,void 0,function*(){return this._addFromChatEntry(t,i)}));const o=Array.from(i.keys()).map(t=>this._processJid(t));return yield Promise.all(o),i.size>0})}getJids(){return[...this._users.keys()]}hasJid(t){return this._users.has(t)}get(t){if(!t)return null;const e=t.toLowerCase();return this._users.get(e)||null}_addFromConversation(t,e){return n(this,void 0,void 0,function*(){t.participants&&t.participants.length&&t.participants.forEach(t=>this._addIfNew(t.jid,e)),t.preview&&this._addFromChatEntry(t.preview,e)})}_addFromChatEntry(t,e){return n(this,void 0,void 0,function*(){switch(t.type){case o.ChatEntryType.Chat:const i=t;this._addIfNew(i.from,e);break;case o.ChatEntryType.Meta:const n=t;this._addIfNew(n.instigator,e),this._addIfNew(n.subject,e)}})}_processJid(t){return n(this,void 0,void 0,function*(){if(!t)return;const e=t.toLowerCase();if(this._users.has(e))return;const i=yield this._layer.getUserByJid(e);this._users.set(e,i||function(t){return{id:t,jid:t,username:t.split("@")[0],connectionStatus:o.ConnectionStatus.Disconnected,displayName:t}}(e))})}_addIfNew(t,e){if(!t)return;const i=t.toLowerCase();this.hasJid(i)||e.add(i)}}},function(t,e,i){"use strict";e.__esModule=!0,e.inherits=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=Object.create(t.prototype);for(var o in i)n[o]=i[o];return n.constructor=e,e.prototype=n,e}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(23);e.getThumbnail=function(t,e,i,s){return n(this,void 0,void 0,function*(){return new Promise((n,r)=>{const a=o.getSource("thumbnail");a&&a.makeThumbnail(t=>{n(t)},t=>{r(`Could not create thumbnail of image. ${t}`)},t,e,i,s)})})}},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0});const n=i(39),o=i(40),s=i(23),r=window,a=window;let c=null;const l="attachments",d="image",h="audio",u="video",p={a:{mimeType:"application/octet-stream",mediaType:null},ai:{mimeType:"application/postscript",mediaType:null},aif:{mimeType:"audio/x-aiff",mediaType:h},aifc:{mimeType:"audio/x-aiff",mediaType:h},aiff:{mimeType:"audio/x-aiff",mediaType:h},au:{mimeType:"audio/basic",mediaType:h},avi:{mimeType:"video/x-msvideo",mediaType:null},bat:{mimeType:"text/plain",mediaType:null},bin:{mimeType:"application/octet-stream",mediaType:null},bmp:{mimeType:"image/x-ms-bmp",mediaType:d},c:{mimeType:"text/plain",mediaType:null},cdf:{mimeType:"application/x-cdf",mediaType:null},csh:{mimeType:"application/x-csh",mediaType:null},css:{mimeType:"text/css",mediaType:null},dll:{mimeType:"application/octet-stream",mediaType:null},doc:{mimeType:"application/msword",mediaType:null},docm:{mimeType:"application/vnd.ms-word.document.macroEnabled.12",mediaType:null},docx:{mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",mediaType:null},dot:{mimeType:"application/msword",mediaType:null},dotx:{mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.template",mediaType:null},dvi:{mimeType:"application/x-dvi",mediaType:null},eml:{mimeType:"message/rfc822",mediaType:null},eps:{mimeType:"application/postscript",mediaType:null},etx:{mimeType:"text/x-setext",mediaType:null},exe:{mimeType:"application/octet-stream",mediaType:null},gif:{mimeType:"image/gif",mediaType:d},gtar:{mimeType:"application/x-gtar",mediaType:null},h:{mimeType:"text/plain",mediaType:null},hdf:{mimeType:"application/x-hdf",mediaType:null},htm:{mimeType:"text/html",mediaType:null},html:{mimeType:"text/html",mediaType:null},jpe:{mimeType:"image/jpe",mediaType:d},jpeg:{mimeType:"image/jpeg",mediaType:d},jpg:{mimeType:"image/jpeg",mediaType:d,preferred:!0},js:{mimeType:"application/javascript",mediaType:null},json:{mimeType:"application/json",mediaType:null},ksh:{mimeType:"text/plain",mediaType:null},latex:{mimeType:"application/x-latex",mediaType:null},m1v:{mimeType:"video/mpeg",mediaType:u},m4a:{mimeType:"audio/mpeg",mediaType:h,preferred:!0},man:{mimeType:"application/x-troff-man",mediaType:null},me:{mimeType:"application/x-troff-me",mediaType:null},mht:{mimeType:"message/rfc822",mediaType:null},mhtml:{mimeType:"message/rfc822",mediaType:null},mif:{mimeType:"application/x-mif",mediaType:null},mov:{mimeType:"video/quicktime",mediaType:u},movie:{mimeType:"video/x-sgi-movie",mediaType:u},mp2:{mimeType:"audio/mpeg",mediaType:h},mp3:{mimeType:"audio/mp3",mediaType:h},mp4:{mimeType:"video/mp4",mediaType:u},mpa:{mimeType:"video/mpeg",mediaType:u},mpe:{mimeType:"video/mpeg",mediaType:u},mpeg:{mimeType:"video/mpeg",mediaType:u},mpg:{mimeType:"video/mpeg",mediaType:u,preferred:!0},ms:{mimeType:"application/x-troff-ms",mediaType:null},nc:{mimeType:"application/x-netcdf",mediaType:null},nws:{mimeType:"message/rfc822",mediaType:null},o:{mimeType:"application/octet-stream",mediaType:null},obj:{mimeType:"application/octet-stream",mediaType:null},oda:{mimeType:"application/oda",mediaType:null},otf:{mimeType:"application/x-font-opentype",mediaType:null},pbm:{mimeType:"image/x-portable-bitmap",mediaType:d},pdf:{mimeType:"application/pdf",mediaType:null},pfx:{mimeType:"application/x-pkcs12",mediaType:null},pgm:{mimeType:"image/x-portable-graymap",mediaType:d},png:{mimeType:"image/png",mediaType:d},pnm:{mimeType:"image/x-portable-anymap",mediaType:d},po:{mimeType:"text/x-gettext-translation",mediaType:null},pot:{mimeType:"application/vnd.ms-powerpoint",mediaType:null},ppa:{mimeType:"application/vnd.ms-powerpoint",mediaType:null},ppm:{mimeType:"image/x-portable-pixmap",mediaType:d},pps:{mimeType:"application/vnd.ms-powerpoint",mediaType:null},ppt:{mimeType:"application/vnd.ms-powerpoint",mediaType:null},pptm:{mimeType:"application/vnd.ms-powerpoint.presentation.macroEnabled.12",mediaType:null},pptx:{mimeType:"application/vnd.openxmlformats-officedocument.presentationml.presentation",mediaType:null},ps:{mimeType:"application/postscript",mediaType:null},pwz:{mimeType:"application/vnd.ms-powerpoint",mediaType:null},py:{mimeType:"text/x-python",mediaType:null},pyc:{mimeType:"application/x-python-code",mediaType:null},pyo:{mimeType:"application/x-python-code",mediaType:null},qt:{mimeType:"video/quicktime",mediaType:u},ra:{mimeType:"audio/x-pn-realaudio",mediaType:h},ram:{mimeType:"application/x-pn-realaudio",mediaType:h},ras:{mimeType:"image/x-cmu-raster",mediaType:d},rdf:{mimeType:"application/xml",mediaType:null},rgb:{mimeType:"image/x-rgb",mediaType:d},roff:{mimeType:"application/x-troff",mediaType:null},rtx:{mimeType:"text/richtext",mediaType:null},sgm:{mimeType:"text/x-sgml",mediaType:null},sgml:{mimeType:"text/x-sgml",mediaType:null},sh:{mimeType:"application/x-sh",mediaType:null},shar:{mimeType:"application/x-shar",mediaType:null},snd:{mimeType:"audio/basic",mediaType:h},so:{mimeType:"application/octet-stream",mediaType:null},src:{mimeType:"application/x-wais-source",mediaType:null},svg:{mimeType:"image/svg+xml",mediaType:d},swf:{mimeType:"application/x-shockwave-flash",mediaType:null},t:{mimeType:"application/x-troff",mediaType:null},tar:{mimeType:"application/x-tar",mediaType:null},tcl:{mimeType:"application/x-tcl",mediaType:null},tex:{mimeType:"application/x-tex",mediaType:null},texi:{mimeType:"application/x-texinfo",mediaType:null},texinfo:{mimeType:"application/x-texinfo",mediaType:null},tif:{mimeType:"image/tiff",mediaType:d},tiff:{mimeType:"image/tiff",mediaType:d},tr:{mimeType:"application/x-troff",mediaType:null},tsv:{mimeType:"text/tab-separated-values",mediaType:null},ttf:{mimeType:"application/x-font-truetype",mediaType:null},txt:{mimeType:"text/plain",mediaType:null,preferred:!0},ustar:{mimeType:"application/x-ustar",mediaType:null},vcf:{mimeType:"text/x-vcard",mediaType:null},wav:{mimeType:"audio/x-wav",mediaType:h},woff:{mimeType:"application/font-woff",mediaType:null,preferred:!0},woff2:{mimeType:"application/font-woff",mediaType:null},wsdl:{mimeType:"application/xml",mediaType:null},xbm:{mimeType:"image/x-xbitmap",mediaType:d},xlb:{mimeType:"application/vnd.ms-excel",mediaType:null},xls:{mimeType:"application/vnd.ms-excel",mediaType:null},xlsm:{mimeType:"application/vnd.ms-excel.sheet.macroEnabled.12",mediaType:null},xlsx:{mimeType:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",mediaType:null},xml:{mimeType:"text/xml",mediaType:null},xpdl:{mimeType:"application/xml",mediaType:null},xpm:{mimeType:"image/x-xpixmap",mediaType:d},xsl:{mimeType:"application/xml",mediaType:null},xwd:{mimeType:"image/x-xwindowdump",mediaType:d},zip:{mimeType:"application/zip",mediaType:null}};function g(t){return-1!==t.indexOf(".")&&(t=t.split(".").pop().toLowerCase()),p.hasOwnProperty(t)?p[t].mimeType:null}function m(t){return-1!==t.indexOf(".")&&(t=t.split(".").pop().toLowerCase()),p.hasOwnProperty(t)?p[t].mediaType:null}function f(t){const e=Object.keys(p).filter(e=>p[e].mimeType===t)[0];return e?p[e].mediaType:null}function _(t){return t.replace(/\\/g,"/").split("/").pop()}function v(){return new n.Promise((t,e)=>{if(o.isElectron())try{const i=r.require("electron").remote.app,n=r.require("path").sep,o=i.getPath("userData")+n+l+n,s=r.require("fs");s.existsSync(o)||s.mkdirSync(o),t(o)}catch(t){e(t)}else{const i=o.getPlatformName(),n=s.getSource("file");if(!1!==n){let o="";if("ios"===i)o+=n.documentsDirectory;else{if("android"!==i)return e("Unsupported platform, expected Android or iOS.");o+=n.dataDirectory}a.resolveLocalFileSystemURL(o,function(i){i.getDirectory(l,{create:!0,exclusive:!1},function(e){t(e.nativeURL)},e)},e)}else e("No file plugin available.")}})}function y(t){return new n.Promise((e,i)=>{const n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="blob",n.onload=(()=>{200===n.status&&e(n.response)}),n.send()})}e.getMimeTypeFromExtension=g,e.getMediaTypeFromExtension=m,e.getMediaTypeFromMimeType=f,e.getFileNameFromPath=_,e.getStorageLocation=v,e.upload=function(t,e,i,r){return new n.Promise((n,a)=>{if(null===c&&(c=o.isElectron()?s.getSource("@commontimeltd/com.commontime.filetransfer"):s.getSource("FileTransfer")),!1!==c){const i={httpMethod:"PUT",fileName:_(t),fileKey:"file",headers:r,mimeType:g(t),chunkedMode:!1};(new c).upload(t,e,i=>{n({source:t,target:e,response:i.response})},a,i)}else console.warn("Falling back to using XHR for file uploads."),y(t).then(t=>{const o=new XMLHttpRequest;if(o.addEventListener("load",t=>{n({source:i,target:e,response:t})}),o.addEventListener("error",a),o.open("PUT",e,!0),r)for(let t in r)o.setRequestHeader(t,r[t]);o.send(t)})})},e.download=function(t,e=null){return new n.Promise((i,n)=>{null===c&&(c=o.isElectron()?s.getSource("@commontimeltd/com.commontime.filetransfer"):s.getSource("FileTransfer")),!1!==c?v().then(s=>{const r=new c,a=s+Date.now()+"_"+_(t),l=e=>{o.isElectron()?i({source:e.filePath,target:t}):o.isDevice()?i({source:e.nativeURL,target:t}):(console.warn("Attachments are not currently supported on this platform."),n())},d=e=>{console.error(`Unable to download file '${a}' from '${t}':`,e),n(e)};o.isDevice()?r.download(t,a,l,d,!1,{headers:e}):r.download(t,a,l,d,{headers:e})}).catch(n):i({source:t,target:t})})},e.getFileInfo=function(t){return new n.Promise((e,i)=>{if(o.isElectron())try{r.require("fs-plus").stat(t,(n,o)=>{n?i(n):e({name:_(t),path:t,size:o.size,type:g(t),mediaType:m(t)})})}catch(t){i("Couldn't require 'fs-plus' module.")}else if(o.isDevice()){const n=0!==t.indexOf("file://")?`file://${t}`:t;a.resolveLocalFileSystemURL(n,function(i){i.file(function(i){const o=i.type?i.type:g(t);e({name:i.name,path:n,size:i.size,type:o,mediaType:m(t)})})},i)}else y(t).then(i=>{e({name:t.split("/").pop(),path:t,size:i.size,type:i.type,mediaType:f(i.type)})})})},e.deleteFile=function(t){return new n.Promise((e,i)=>{if(o.isElectron())try{const n=r.require("fs-plus");n.existsSync(t)?(n.unlinkSync(t),e()):i(`File '${t}' doesn't exist and cannot be deleted.`)}catch(e){i(`Something went wrong while trying to delete the file '${t}': ${e}`)}else o.isDevice()?a.resolveLocalFileSystemURL(t,n=>{n.isDirectory?i(`File path '${t}' is a directory and cannot be deleted.`):n.remove(e,i)},t=>{i(t)}):e()})},e.urlToBlob=y,e.blobToObjectUrl=function(t){return new n.Promise(e=>{e(URL.createObjectURL(t))})},e.deleteAttachments=function(){return new n.Promise((t,e)=>{if(o.isElectron()){const i=r.require("path"),n=r.require("fs"),o=r.require("electron").remote.app.getPath("userData"),s=i.sep,a=o+s+l+s;if(!n.existsSync(a))return t();n.readdir(a,(o,s)=>{if(o)return e(o);for(const t of s)n.lstatSync(i.join(a,t)).isFile()&&n.unlinkSync(i.join(a,t));t()})}else if(o.isDevice()){const i=o.getPlatformName(),n=s.getSource("file");if(!1!==n){let o=null;"ios"===i?o=n.documentsDirectory:"android"===i&&(o=n.dataDirectory),null!==o?a.resolveLocalFileSystemURL(o,i=>{i.getDirectory(l,{create:!1,exclusive:!1},function(i){i.removeRecursively(t,e)},function(i){1===i.code?t():(console.error(`Couldn't get '${l}' to delete:`,i),e(i))})},function(t){e(t)}):e("Unsupported platform, expected Android or iOS.")}else e("No file plugin available.")}else t()})},e.pickFile=function(t){return new n.Promise((e,i)=>{let c=[],d=["*"],h="All Files";if(void 0!==t.mediaType?(d=Object.keys(p).filter(e=>p[e].mediaType===t.mediaType),c=d.map(t=>p[t].mimeType),h=t.mediaType):void 0!==t.mimeTypes&&(c=t.mimeTypes,d=Object.keys(p).filter(t=>c.indexOf(p[t].mimeType)>=0)),o.isElectron())r.require("electron").remote.dialog.showOpenDialog({properties:["openFile","multiSelections"],filters:[{name:h,extensions:d}]},t=>{const o=r.require("path"),s=r.require("fs"),a=r.require("electron").remote.app.getPath("userData"),c=o.sep,d=a+c+l+c;s.existsSync(d)||s.mkdirSync(d);const h=[];t.forEach(t=>{h.push(new n.Promise((e,i)=>{const n=o.join(d,Date.now()+"_"+o.basename(t)),r=e=>{console.error(`A problem occurred when trying to copy the file '${t}' to '${n}'.`,e),i(e)},a=s.createReadStream(t);a.on("error",r);const c=s.createWriteStream(n);c.on("error",r),c.on("close",()=>{e(n)}),a.pipe(c)}))}),n.Promise.all(h).then(e).catch(i)});else if(o.isDevice()){const n=o.getPlatformName(),r=s.getSource("file");if(!1!==r){let o=null;"ios"===n?o=r.documentsDirectory:"android"===n&&(o=r.dataDirectory),null!==o?a.resolveLocalFileSystemURL(o,n=>{n.getDirectory(l,{create:!0,exclusive:!1},n=>{const o=s.getSource("fileimporter");null!==o?o.importFile(n=>{if(t.encrypt){const t=s.getSource("fileEncryption");t||e([n]),t.encrypt(t=>{e([t])},t=>{i(`Could not encrypt image. ${t}`)},0!==n.indexOf("file://")?`file://${n}`:n)}else e([n])},i,void 0,c,l):i("File importer plugin not available.")},i)},i):i("Unsupported platform, expected Android or iOS.")}else i("No file plugin available.")}else{const t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("multiple","multiple"),t.addEventListener("change",()=>{const i=[];for(let e=0;e<t.files.length;e++)i.push(URL.createObjectURL(t.files[e]));e(i)}),t.click()}})},e.getFileSize=function(t){return new n.Promise((e,i)=>{if(t&&-1!==t.name.indexOf(".encrypted")){const n=s.getSource("fileEncryption");n?n.getFileSize(t=>{try{e(parseInt(t))}catch(t){console.error("Couldn't convert file size to an integer."),i(t)}},i,t.path):e(t.size)}else e(t.size)})},e.saveFileToDisk=function(e,i){return new n.Promise((n,o)=>{const s=r.require("path"),a=r.require("fs"),c=r.require("electron").remote.app.getPath("userData"),d=s.sep,h=c+d+l+d;a.existsSync(h)||a.mkdirSync(h);const u=s.join(h,Date.now()+"_"+s.basename(i)),p=t=>{console.error(`A problem occurred when trying to copy the file to '${u}'.`,t),o(t)},g=new FileReader;g.readAsArrayBuffer(e),g.onerror=p,g.onload=(()=>{try{a.writeFileSync(u,t(new Uint8Array(g.result))),n(u)}catch(t){p(t)}})})}}).call(this,i(41).Buffer)},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(23),o=i(41);e.isNumber=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},e.generateGuid=function(){let t=Date.now();return window.performance&&"function"==typeof window.performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)})},e.getEncryptionKey=function(t){return new Promise((e,i)=>{const s=n.getSource("securesettings");if(!1!==s)s.getOrCreateCryptographicKey(function(t){const i=o.Buffer.from(function(t){let e=[];for(let i=0;i<t.length;i+=2)e.push(parseInt(t.substr(i,2),16));return e}(t));e(i)},i,t,256);else{console.warn("Oh no!  Your databases are encrypted but the key couldn't be secured because this platform doesn't support secure settings.");const i=localStorage.getItem(`${t}_key`);if(null!==i){const t=o.Buffer.from(JSON.parse(i));e(t)}else{let i,n=[];if(window.crypto&&window.crypto.getRandomValues){var r=new Uint8Array(32);for(window.crypto.getRandomValues(r),i=0;i<32;i++)n[i]=r[i]}else for(let t=0;t<32;t++)n[t]=Math.floor(256*Math.random());localStorage.setItem(`${t}_key`,JSON.stringify(n));const s=o.Buffer.from(n);e(s)}}})};let s=!1;document.addEventListener("pause",()=>s=!0,!1),document.addEventListener("resume",()=>s=!1,!1),e.isInBackground=function(){return!0===s}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});class n{}n.XmppChat="xmppchat",e.BaseMessageType=n,e.BaseBotCommand=class{},e.BaseIQ=class{},e.get=function(t){return[]};var o=i(92);e.BaseHandler=o.BaseHandler,e.BaseHandlerInterface=o.BaseHandlerInterface},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__rest||function(t,e){var i={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(t);o<n.length;o++)e.indexOf(n[o])<0&&(i[n[o]]=t[n[o]])}return i};Object.defineProperty(e,"__esModule",{value:!0});const o=i(25),s=t=>t;e.prop=function(t){return function(e,i){const{type:r}=t,a=n(t,["type"]),c=function(t){if("function"!=typeof r)return;const e=r();return e instanceof Array?"array":"object"==typeof e?"object":typeof e}(),l=o.prop[c]||s,d=e.constructor,h=d.props||{},u=Object.assign({},h,{[i]:l(a)});Object.defineProperty(d,"props",{configurable:!0,get:()=>u})}}},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(4),c=i(9);var l;!function(t){t[t.CANCEL="Cancel"]="CANCEL"}(l||(l={}));let d=class extends s.CTLayerComponent{constructor(){super(...arguments),this._toggle=(()=>{this.open=!this.open}),this._action=(t=>{this._toggle(),t&&t()}),this._renderActionSheetButton=((t,e=!1)=>window.__CTRender(a.CTButton,{type:"action-sheet",class:"button",disabled:t.disabled,onClick:()=>this._action(t.action)},window.__CTRender("p",{class:`${t.subtitleText?"hasSubtitle":""}`},t.primaryText),t.subtitleText&&window.__CTRender("span",{class:"subtitle"},t.subtitleText)))}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}generateComponentMarkup(){return this.buttons&&this.buttons.length?1===this.buttons.length?window.__CTRender("div",{class:"container"},window.__CTRender(a.CTButton,{type:`${this.openSheetBackgroundColor?"none":"primary"}`,textColor:this.openSheetBackgroundColor?c.decideTextColorFromBgColor(this.openSheetBackgroundColor):null,style:c.buildStyles({backgroundColor:this.openSheetBackgroundColor}),class:"button",disabled:this.buttons[0].disabled,onClick:()=>this._action(this.buttons[0].action)},this.buttons[0].primaryText)):window.__CTRender("div",{class:"container"},window.__CTRender(a.CTButton,{type:`${this.openSheetBackgroundColor?"none":"primary"}`,textColor:this.openSheetBackgroundColor?c.decideTextColorFromBgColor(this.openSheetBackgroundColor):null,style:c.buildStyles({backgroundColor:this.openSheetBackgroundColor}),class:"button",onClick:this._toggle},this.openSheetButtonText),window.__CTRender("div",{class:`sheet-bg ${this.open?"":"hidden"}`},window.__CTRender("div",{class:"sheet-buttons"},window.__CTRender("div",{class:`inner-sheet-buttons ${this.open?"":"hidden"}`},window.__CTRender("div",{class:"inner-buttons"},this.buttons.map(t=>this._renderActionSheetButton(t))),window.__CTRender("div",{class:"close"},window.__CTRender(a.CTButton,{type:"action-sheet",class:"button",onClick:this._toggle},this.translateI18nItem(l.CANCEL))))))):null}};n([s.prop({type:Boolean,attribute:!1,default:!1})],d.prototype,"open",void 0),n([s.prop({type:Array,attribute:!1,default:[{text:"Sample"}]})],d.prototype,"buttons",void 0),n([s.prop({type:String,attribute:!1,default:"Open"})],d.prototype,"openSheetButtonText",void 0),n([s.prop({type:String,attribute:!1,default:""})],d.prototype,"openSheetBackgroundColor",void 0),d=n([r.component({tag:"ct-action-sheet",styles:[i(181)],i18nKeys:l})],d),e.CTActionSheet=d},function(t,e,i){"use strict";e.__esModule=!0,e.AMPERSAND=e.CLOSEPAREN=e.CLOSEANGLEBRACKET=e.CLOSEBRACKET=e.CLOSEBRACE=e.OPENPAREN=e.OPENANGLEBRACKET=e.OPENBRACKET=e.OPENBRACE=e.WS=e.TLD=e.SYM=e.UNDERSCORE=e.SLASH=e.MAILTO=e.PROTOCOL=e.QUERY=e.POUND=e.PLUS=e.NUM=e.NL=e.LOCALHOST=e.PUNCTUATION=e.DOT=e.COLON=e.AT=e.DOMAIN=e.Base=void 0;var n=i(61),o=i(28),s=(0,n.createTokenClass)();function r(t){var e=t?{v:t}:{};return(0,o.inherits)(s,(0,n.createTokenClass)(),e)}s.prototype={toString:function(){return this.v+""}};var a=r(),c=r("@"),l=r(":"),d=r("."),h=r(),u=r(),p=r("\n"),g=r(),m=r("+"),f=r("#"),_=r(),v=r("mailto:"),y=r("?"),C=r("/"),b=r("_"),w=r(),T=r(),E=r(),S=r("{"),R=r("["),A=r("<"),I=r("("),x=r("}"),M=r("]"),O=r(">"),N=r(")"),P=r("&");e.Base=s,e.DOMAIN=a,e.AT=c,e.COLON=l,e.DOT=d,e.PUNCTUATION=h,e.LOCALHOST=u,e.NL=p,e.NUM=g,e.PLUS=m,e.POUND=f,e.QUERY=y,e.PROTOCOL=_,e.MAILTO=v,e.SLASH=C,e.UNDERSCORE=b,e.SYM=w,e.TLD=T,e.WS=E,e.OPENBRACE=S,e.OPENBRACKET=R,e.OPENANGLEBRACKET=A,e.OPENPAREN=I,e.CLOSEBRACE=x,e.CLOSEBRACKET=M,e.CLOSEANGLEBRACKET=O,e.CLOSEPAREN=N,e.AMPERSAND=P},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(4),a=i(9),c=i(0);class l extends s.CTLayerComponent{static get is(){return"ct-group-avatar"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(198)}generateComponentMarkup(){const t=a.buildStyles({width:`${this.size}px`,height:`${this.size}px`}),e=Math.floor(this.size/2);return window.__CTRender("div",{class:"bg",style:t},window.__CTRender(r.CTIcon,{icon:c.Icons.COMMON.Users,width:e,height:e}),this.group.icon&&window.__CTRender("img",{class:"image",src:this.group.icon,width:this.size,height:this.size}))}}n([s.prop({type:Number,attribute:!1,default:40})],l.prototype,"size",void 0),n([s.prop({type:Object,attribute:!1})],l.prototype,"group",void 0),e.CTGroupAvatar=l,l.register()},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(0),c=i(4),l=i(2);let d=class extends s.CTLayerComponent{constructor(){super(...arguments),this._delay=200,this._onSelectChange=(t=>{const e=t.currentTarget.value;this._selectValue=e,e!==this.defaultSelectionValue?this.highlightSelection=!0:this.highlightSelection=!1,this.onSearch&&this.onSearch(e,this._textValue)}),this._onSearch=(t=>{const e=t.currentTarget.value;0===e.length?(this.cancelDebounce("search"),this.showClear=!1,this._textValue="",this.onSearch&&this.onSearch(this._selectValue,"")):(this.showClear=!0,this.debounce("search",()=>{this._textValue=e,"function"==typeof this.onSearch&&this.onSearch(this._selectValue,e)},this._delay))}),this._clear=(()=>{this._input.value="",this._textValue="",this.showClear=!1,this.onSearch&&this.onSearch(this._selectValue,"")})}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}generateComponentMarkup(){return window.__CTRender("div",{class:"container"},window.__CTRender("div",{class:`select ${this.highlightSelection?"highlight":""}`},window.__CTRender("select",{onChange:this._onSelectChange,ref:t=>this._select=t},window.__CTRender("option",null,this.defaultSelectionValue),this.selectionItems.map(t=>window.__CTRender("option",null,t))),window.__CTRender(c.CTIcon,{class:"select-icon",width:"12",height:"12",color:this.highlightSelection?l.getCSSVariable("--header-text"):"auto",icon:a.Icons.COMMON.ChevronDown})),window.__CTRender("input",{type:"text",placeholder:this.placeholder,oninput:this._onSearch,ref:t=>this._input=t}),this.showClear&&window.__CTRender(c.CTIcon,{class:"clear",width:"12",height:"12",icon:a.Icons.COMMON.CircleCross,onClick:this._clear}))}};n([s.prop({type:String,attribute:!1,default:"All"})],d.prototype,"defaultSelectionValue",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],d.prototype,"selectionItems",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],d.prototype,"highlightSelection",void 0),n([s.prop({type:String,attribute:!1,default:""})],d.prototype,"placeholder",void 0),n([s.prop({type:Function,attribute:!1,defaul:null})],d.prototype,"onSearch",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],d.prototype,"showClear",void 0),d=n([r.component({tag:"ct-selection-text-filter",styles:[i(223)]})],d),e.CTSelectionTextFilter=d},function(t,e,i){(function(e,i){
/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   v4.2.6+9869a4bc
 */
!function(e,i){t.exports=i()}(0,function(){"use strict";function t(t){return"function"==typeof t}var n=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},o=0,s=void 0,r=void 0,a=function(t,e){g[o]=t,g[o+1]=e,2===(o+=2)&&(r?r(m):f())},c="undefined"!=typeof window?window:void 0,l=c||{},d=l.MutationObserver||l.WebKitMutationObserver,h="undefined"==typeof self&&void 0!==e&&"[object process]"==={}.toString.call(e),u="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function p(){var t=setTimeout;return function(){return t(m,1)}}var g=new Array(1e3);function m(){for(var t=0;t<o;t+=2)(0,g[t])(g[t+1]),g[t]=void 0,g[t+1]=void 0;o=0}var f=void 0;function _(t,e){var i=this,n=new this.constructor(C);void 0===n[y]&&D(n);var o=i._state;if(o){var s=arguments[o-1];a(function(){return P(o,n,s,i._result)})}else O(i,n,t,e);return n}function v(t){if(t&&"object"==typeof t&&t.constructor===this)return t;var e=new this(C);return A(e,t),e}f=h?function(){return e.nextTick(m)}:d?function(){var t=0,e=new d(m),i=document.createTextNode("");return e.observe(i,{characterData:!0}),function(){i.data=t=++t%2}}():u?function(){var t=new MessageChannel;return t.port1.onmessage=m,function(){return t.port2.postMessage(0)}}():void 0===c?function(){try{var t=Function("return this")().require("vertx");return void 0!==(s=t.runOnLoop||t.runOnContext)?function(){s(m)}:p()}catch(t){return p()}}():p();var y=Math.random().toString(36).substring(2);function C(){}var b=void 0,w=1,T=2,E={error:null};function S(t){try{return t.then}catch(t){return E.error=t,E}}function R(e,i,n){i.constructor===e.constructor&&n===_&&i.constructor.resolve===v?function(t,e){e._state===w?x(t,e._result):e._state===T?M(t,e._result):O(e,void 0,function(e){return A(t,e)},function(e){return M(t,e)})}(e,i):n===E?(M(e,E.error),E.error=null):void 0===n?x(e,i):t(n)?function(t,e,i){a(function(t){var n=!1,o=function(t,e,i,n){try{t.call(e,i,n)}catch(t){return t}}(i,e,function(i){n||(n=!0,e!==i?A(t,i):x(t,i))},function(e){n||(n=!0,M(t,e))},t._label);!n&&o&&(n=!0,M(t,o))},t)}(e,i,n):x(e,i)}function A(t,e){t===e?M(t,new TypeError("You cannot resolve a promise with itself")):function(t){var e=typeof t;return null!==t&&("object"===e||"function"===e)}(e)?R(t,e,S(e)):x(t,e)}function I(t){t._onerror&&t._onerror(t._result),N(t)}function x(t,e){t._state===b&&(t._result=e,t._state=w,0!==t._subscribers.length&&a(N,t))}function M(t,e){t._state===b&&(t._state=T,t._result=e,a(I,t))}function O(t,e,i,n){var o=t._subscribers,s=o.length;t._onerror=null,o[s]=e,o[s+w]=i,o[s+T]=n,0===s&&t._state&&a(N,t)}function N(t){var e=t._subscribers,i=t._state;if(0!==e.length){for(var n=void 0,o=void 0,s=t._result,r=0;r<e.length;r+=3)n=e[r],o=e[r+i],n?P(i,n,o,s):o(s);t._subscribers.length=0}}function P(e,i,n,o){var s=t(n),r=void 0,a=void 0,c=void 0,l=void 0;if(s){if((r=function(t,e){try{return t(e)}catch(t){return E.error=t,E}}(n,o))===E?(l=!0,a=r.error,r.error=null):c=!0,i===r)return void M(i,new TypeError("A promises callback cannot return that same promise."))}else r=o,c=!0;i._state!==b||(s&&c?A(i,r):l?M(i,a):e===w?x(i,r):e===T&&M(i,r))}var L=0;function D(t){t[y]=L++,t._state=void 0,t._result=void 0,t._subscribers=[]}var k=function(){function t(t,e){this._instanceConstructor=t,this.promise=new t(C),this.promise[y]||D(this.promise),n(e)?(this.length=e.length,this._remaining=e.length,this._result=new Array(this.length),0===this.length?x(this.promise,this._result):(this.length=this.length||0,this._enumerate(e),0===this._remaining&&x(this.promise,this._result))):M(this.promise,new Error("Array Methods must be provided an Array"))}return t.prototype._enumerate=function(t){for(var e=0;this._state===b&&e<t.length;e++)this._eachEntry(t[e],e)},t.prototype._eachEntry=function(t,e){var i=this._instanceConstructor,n=i.resolve;if(n===v){var o=S(t);if(o===_&&t._state!==b)this._settledAt(t._state,e,t._result);else if("function"!=typeof o)this._remaining--,this._result[e]=t;else if(i===j){var s=new i(C);R(s,t,o),this._willSettleAt(s,e)}else this._willSettleAt(new i(function(e){return e(t)}),e)}else this._willSettleAt(n(t),e)},t.prototype._settledAt=function(t,e,i){var n=this.promise;n._state===b&&(this._remaining--,t===T?M(n,i):this._result[e]=i),0===this._remaining&&x(n,this._result)},t.prototype._willSettleAt=function(t,e){var i=this;O(t,void 0,function(t){return i._settledAt(w,e,t)},function(t){return i._settledAt(T,e,t)})},t}(),j=function(){function e(t){this[y]=L++,this._result=this._state=void 0,this._subscribers=[],C!==t&&("function"!=typeof t&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof e?function(t,e){try{e(function(e){A(t,e)},function(e){M(t,e)})}catch(e){M(t,e)}}(this,t):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return e.prototype.catch=function(t){return this.then(null,t)},e.prototype.finally=function(e){var i=this.constructor;return t(e)?this.then(function(t){return i.resolve(e()).then(function(){return t})},function(t){return i.resolve(e()).then(function(){throw t})}):this.then(e,e)},e}();return j.prototype.then=_,j.all=function(t){return new k(this,t).promise},j.race=function(t){var e=this;return n(t)?new e(function(i,n){for(var o=t.length,s=0;s<o;s++)e.resolve(t[s]).then(i,n)}):new e(function(t,e){return e(new TypeError("You must pass an array to race."))})},j.resolve=v,j.reject=function(t){var e=new this(C);return M(e,t),e},j._setScheduler=function(t){r=t},j._setAsap=function(t){a=t},j._asap=a,j.polyfill=function(){var t=void 0;if(void 0!==i)t=i;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var e=t.Promise;if(e){var n=null;try{n=Object.prototype.toString.call(e.resolve())}catch(t){}if("[object Promise]"===n&&!e.cast)return}t.Promise=j},j.Promise=j,j})}).call(this,i(74),i(30))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=window,o=document;function s(){const t=window.navigator.userAgent;return/Android/i.test(t)?"android":/iPhone|iPad|iPod/i.test(t)?"ios":/Electron/i.test(t)?"electron":/Chrome/i.test(t)?"chrome":/Safari/i.test(t)?"safari":/Edge/i.test(t)?"edge":n.MSInputMethodContext&&o.documentMode?"ie":null}e.getPlatformName=s,e.isElectron=function(){return"electron"===s()},e.isWindows=function(){return-1!==navigator.userAgent.toUpperCase().indexOf("WINDOWS")},e.isDevice=function(){const t=s();return"android"===t||"ios"===t},e.isBrowser=function(){const t=s();return"chrome"===t||"safari"===t||"ie"===t||"edge"===t}},function(t,e,i){"use strict";(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var n=i(75),o=i(76),s=i(77);function r(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(t,e){if(r()<e)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=c.prototype:(null===t&&(t=new c(e)),t.length=e),t}function c(t,e,i){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(t,e,i);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return h(this,t)}return l(this,t,e,i)}function l(t,e,i,n){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,i,n){if(e.byteLength,i<0||e.byteLength<i)throw new RangeError("'offset' is out of bounds");if(e.byteLength<i+(n||0))throw new RangeError("'length' is out of bounds");return e=void 0===i&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,i):new Uint8Array(e,i,n),c.TYPED_ARRAY_SUPPORT?(t=e).__proto__=c.prototype:t=u(t,e),t}(t,e,i,n):"string"==typeof e?function(t,e,i){if("string"==typeof i&&""!==i||(i="utf8"),!c.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var n=0|g(e,i),o=(t=a(t,n)).write(e,i);return o!==n&&(t=t.slice(0,o)),t}(t,e,i):function(t,e){if(c.isBuffer(e)){var i=0|p(e.length);return 0===(t=a(t,i)).length?t:(e.copy(t,0,0,i),t)}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||function(t){return t!=t}(e.length)?a(t,0):u(t,e);if("Buffer"===e.type&&s(e.data))return u(t,e.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function d(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function h(t,e){if(d(e),t=a(t,e<0?0:0|p(e)),!c.TYPED_ARRAY_SUPPORT)for(var i=0;i<e;++i)t[i]=0;return t}function u(t,e){var i=e.length<0?0:0|p(e.length);t=a(t,i);for(var n=0;n<i;n+=1)t[n]=255&e[n];return t}function p(t){if(t>=r())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r().toString(16)+" bytes");return 0|t}function g(t,e){if(c.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var i=t.length;if(0===i)return 0;for(var n=!1;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return B(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return H(t).length;default:if(n)return B(t).length;e=(""+e).toLowerCase(),n=!0}}function m(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function f(t,e,i,n,o){if(0===t.length)return-1;if("string"==typeof i?(n=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=o?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(o)return-1;i=t.length-1}else if(i<0){if(!o)return-1;i=0}if("string"==typeof e&&(e=c.from(e,n)),c.isBuffer(e))return 0===e.length?-1:_(t,e,i,n,o);if("number"==typeof e)return e&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):_(t,[e],i,n,o);throw new TypeError("val must be string, number or Buffer")}function _(t,e,i,n,o){var s,r=1,a=t.length,c=e.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||e.length<2)return-1;r=2,a/=2,c/=2,i/=2}function l(t,e){return 1===r?t[e]:t.readUInt16BE(e*r)}if(o){var d=-1;for(s=i;s<a;s++)if(l(t,s)===l(e,-1===d?0:s-d)){if(-1===d&&(d=s),s-d+1===c)return d*r}else-1!==d&&(s-=s-d),d=-1}else for(i+c>a&&(i=a-c),s=i;s>=0;s--){for(var h=!0,u=0;u<c;u++)if(l(t,s+u)!==l(e,u)){h=!1;break}if(h)return s}return-1}function v(t,e,i,n){i=Number(i)||0;var o=t.length-i;n?(n=Number(n))>o&&(n=o):n=o;var s=e.length;if(s%2!=0)throw new TypeError("Invalid hex string");n>s/2&&(n=s/2);for(var r=0;r<n;++r){var a=parseInt(e.substr(2*r,2),16);if(isNaN(a))return r;t[i+r]=a}return r}function y(t,e,i,n){return $(B(e,t.length-i),t,i,n)}function C(t,e,i,n){return $(function(t){for(var e=[],i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,n)}function b(t,e,i,n){return C(t,e,i,n)}function w(t,e,i,n){return $(H(e),t,i,n)}function T(t,e,i,n){return $(function(t,e){for(var i,n,o,s=[],r=0;r<t.length&&!((e-=2)<0);++r)n=(i=t.charCodeAt(r))>>8,o=i%256,s.push(o),s.push(n);return s}(e,t.length-i),t,i,n)}function E(t,e,i){return 0===e&&i===t.length?n.fromByteArray(t):n.fromByteArray(t.slice(e,i))}function S(t,e,i){i=Math.min(t.length,i);for(var n=[],o=e;o<i;){var s,r,a,c,l=t[o],d=null,h=l>239?4:l>223?3:l>191?2:1;if(o+h<=i)switch(h){case 1:l<128&&(d=l);break;case 2:128==(192&(s=t[o+1]))&&(c=(31&l)<<6|63&s)>127&&(d=c);break;case 3:s=t[o+1],r=t[o+2],128==(192&s)&&128==(192&r)&&(c=(15&l)<<12|(63&s)<<6|63&r)>2047&&(c<55296||c>57343)&&(d=c);break;case 4:s=t[o+1],r=t[o+2],a=t[o+3],128==(192&s)&&128==(192&r)&&128==(192&a)&&(c=(15&l)<<18|(63&s)<<12|(63&r)<<6|63&a)>65535&&c<1114112&&(d=c)}null===d?(d=65533,h=1):d>65535&&(d-=65536,n.push(d>>>10&1023|55296),d=56320|1023&d),n.push(d),o+=h}return function(t){var e=t.length;if(e<=R)return String.fromCharCode.apply(String,t);for(var i="",n=0;n<e;)i+=String.fromCharCode.apply(String,t.slice(n,n+=R));return i}(n)}e.Buffer=c,e.SlowBuffer=function(t){return+t!=t&&(t=0),c.alloc(+t)},e.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}(),e.kMaxLength=r(),c.poolSize=8192,c._augment=function(t){return t.__proto__=c.prototype,t},c.from=function(t,e,i){return l(null,t,e,i)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(t,e,i){return function(t,e,i,n){return d(e),e<=0?a(t,e):void 0!==i?"string"==typeof n?a(t,e).fill(i,n):a(t,e).fill(i):a(t,e)}(null,t,e,i)},c.allocUnsafe=function(t){return h(null,t)},c.allocUnsafeSlow=function(t){return h(null,t)},c.isBuffer=function(t){return!(null==t||!t._isBuffer)},c.compare=function(t,e){if(!c.isBuffer(t)||!c.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var i=t.length,n=e.length,o=0,s=Math.min(i,n);o<s;++o)if(t[o]!==e[o]){i=t[o],n=e[o];break}return i<n?-1:n<i?1:0},c.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(t,e){if(!s(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return c.alloc(0);var i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;var n=c.allocUnsafe(e),o=0;for(i=0;i<t.length;++i){var r=t[i];if(!c.isBuffer(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(n,o),o+=r.length}return n},c.byteLength=g,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)m(this,e,e+1);return this},c.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)m(this,e,e+3),m(this,e+1,e+2);return this},c.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)m(this,e,e+7),m(this,e+1,e+6),m(this,e+2,e+5),m(this,e+3,e+4);return this},c.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?S(this,0,t):function(t,e,i){var n=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return x(this,e,i);case"utf8":case"utf-8":return S(this,e,i);case"ascii":return A(this,e,i);case"latin1":case"binary":return I(this,e,i);case"base64":return E(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,e,i);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}.apply(this,arguments)},c.prototype.equals=function(t){if(!c.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===c.compare(this,t)},c.prototype.inspect=function(){var t="",i=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(t+=" ... ")),"<Buffer "+t+">"},c.prototype.compare=function(t,e,i,n,o){if(!c.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===n&&(n=0),void 0===o&&(o=this.length),e<0||i>t.length||n<0||o>this.length)throw new RangeError("out of range index");if(n>=o&&e>=i)return 0;if(n>=o)return-1;if(e>=i)return 1;if(this===t)return 0;for(var s=(o>>>=0)-(n>>>=0),r=(i>>>=0)-(e>>>=0),a=Math.min(s,r),l=this.slice(n,o),d=t.slice(e,i),h=0;h<a;++h)if(l[h]!==d[h]){s=l[h],r=d[h];break}return s<r?-1:r<s?1:0},c.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},c.prototype.indexOf=function(t,e,i){return f(this,t,e,i,!0)},c.prototype.lastIndexOf=function(t,e,i){return f(this,t,e,i,!1)},c.prototype.write=function(t,e,i,n){if(void 0===e)n="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)n=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(i)?(i|=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}var o=this.length-e;if((void 0===i||i>o)&&(i=o),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var s=!1;;)switch(n){case"hex":return v(this,t,e,i);case"utf8":case"utf-8":return y(this,t,e,i);case"ascii":return C(this,t,e,i);case"latin1":case"binary":return b(this,t,e,i);case"base64":return w(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return T(this,t,e,i);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var R=4096;function A(t,e,i){var n="";i=Math.min(t.length,i);for(var o=e;o<i;++o)n+=String.fromCharCode(127&t[o]);return n}function I(t,e,i){var n="";i=Math.min(t.length,i);for(var o=e;o<i;++o)n+=String.fromCharCode(t[o]);return n}function x(t,e,i){var n=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>n)&&(i=n);for(var o="",s=e;s<i;++s)o+=F(t[s]);return o}function M(t,e,i){for(var n=t.slice(e,i),o="",s=0;s<n.length;s+=2)o+=String.fromCharCode(n[s]+256*n[s+1]);return o}function O(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function N(t,e,i,n,o,s){if(!c.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>o||e<s)throw new RangeError('"value" argument is out of bounds');if(i+n>t.length)throw new RangeError("Index out of range")}function P(t,e,i,n){e<0&&(e=65535+e+1);for(var o=0,s=Math.min(t.length-i,2);o<s;++o)t[i+o]=(e&255<<8*(n?o:1-o))>>>8*(n?o:1-o)}function L(t,e,i,n){e<0&&(e=4294967295+e+1);for(var o=0,s=Math.min(t.length-i,4);o<s;++o)t[i+o]=e>>>8*(n?o:3-o)&255}function D(t,e,i,n,o,s){if(i+n>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function k(t,e,i,n,s){return s||D(t,0,i,4),o.write(t,e,i,n,23,4),i+4}function j(t,e,i,n,s){return s||D(t,0,i,8),o.write(t,e,i,n,52,8),i+8}c.prototype.slice=function(t,e){var i,n=this.length;if((t=~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),(e=void 0===e?n:~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),e<t&&(e=t),c.TYPED_ARRAY_SUPPORT)(i=this.subarray(t,e)).__proto__=c.prototype;else{var o=e-t;i=new c(o,void 0);for(var s=0;s<o;++s)i[s]=this[s+t]}return i},c.prototype.readUIntLE=function(t,e,i){t|=0,e|=0,i||O(t,e,this.length);for(var n=this[t],o=1,s=0;++s<e&&(o*=256);)n+=this[t+s]*o;return n},c.prototype.readUIntBE=function(t,e,i){t|=0,e|=0,i||O(t,e,this.length);for(var n=this[t+--e],o=1;e>0&&(o*=256);)n+=this[t+--e]*o;return n},c.prototype.readUInt8=function(t,e){return e||O(t,1,this.length),this[t]},c.prototype.readUInt16LE=function(t,e){return e||O(t,2,this.length),this[t]|this[t+1]<<8},c.prototype.readUInt16BE=function(t,e){return e||O(t,2,this.length),this[t]<<8|this[t+1]},c.prototype.readUInt32LE=function(t,e){return e||O(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},c.prototype.readUInt32BE=function(t,e){return e||O(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},c.prototype.readIntLE=function(t,e,i){t|=0,e|=0,i||O(t,e,this.length);for(var n=this[t],o=1,s=0;++s<e&&(o*=256);)n+=this[t+s]*o;return n>=(o*=128)&&(n-=Math.pow(2,8*e)),n},c.prototype.readIntBE=function(t,e,i){t|=0,e|=0,i||O(t,e,this.length);for(var n=e,o=1,s=this[t+--n];n>0&&(o*=256);)s+=this[t+--n]*o;return s>=(o*=128)&&(s-=Math.pow(2,8*e)),s},c.prototype.readInt8=function(t,e){return e||O(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},c.prototype.readInt16LE=function(t,e){e||O(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},c.prototype.readInt16BE=function(t,e){e||O(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},c.prototype.readInt32LE=function(t,e){return e||O(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},c.prototype.readInt32BE=function(t,e){return e||O(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},c.prototype.readFloatLE=function(t,e){return e||O(t,4,this.length),o.read(this,t,!0,23,4)},c.prototype.readFloatBE=function(t,e){return e||O(t,4,this.length),o.read(this,t,!1,23,4)},c.prototype.readDoubleLE=function(t,e){return e||O(t,8,this.length),o.read(this,t,!0,52,8)},c.prototype.readDoubleBE=function(t,e){return e||O(t,8,this.length),o.read(this,t,!1,52,8)},c.prototype.writeUIntLE=function(t,e,i,n){t=+t,e|=0,i|=0,n||N(this,t,e,i,Math.pow(2,8*i)-1,0);var o=1,s=0;for(this[e]=255&t;++s<i&&(o*=256);)this[e+s]=t/o&255;return e+i},c.prototype.writeUIntBE=function(t,e,i,n){t=+t,e|=0,i|=0,n||N(this,t,e,i,Math.pow(2,8*i)-1,0);var o=i-1,s=1;for(this[e+o]=255&t;--o>=0&&(s*=256);)this[e+o]=t/s&255;return e+i},c.prototype.writeUInt8=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,1,255,0),c.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},c.prototype.writeUInt16LE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):P(this,t,e,!0),e+2},c.prototype.writeUInt16BE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):P(this,t,e,!1),e+2},c.prototype.writeUInt32LE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):L(this,t,e,!0),e+4},c.prototype.writeUInt32BE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):L(this,t,e,!1),e+4},c.prototype.writeIntLE=function(t,e,i,n){if(t=+t,e|=0,!n){var o=Math.pow(2,8*i-1);N(this,t,e,i,o-1,-o)}var s=0,r=1,a=0;for(this[e]=255&t;++s<i&&(r*=256);)t<0&&0===a&&0!==this[e+s-1]&&(a=1),this[e+s]=(t/r>>0)-a&255;return e+i},c.prototype.writeIntBE=function(t,e,i,n){if(t=+t,e|=0,!n){var o=Math.pow(2,8*i-1);N(this,t,e,i,o-1,-o)}var s=i-1,r=1,a=0;for(this[e+s]=255&t;--s>=0&&(r*=256);)t<0&&0===a&&0!==this[e+s+1]&&(a=1),this[e+s]=(t/r>>0)-a&255;return e+i},c.prototype.writeInt8=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,1,127,-128),c.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},c.prototype.writeInt16LE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):P(this,t,e,!0),e+2},c.prototype.writeInt16BE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):P(this,t,e,!1),e+2},c.prototype.writeInt32LE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):L(this,t,e,!0),e+4},c.prototype.writeInt32BE=function(t,e,i){return t=+t,e|=0,i||N(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),c.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):L(this,t,e,!1),e+4},c.prototype.writeFloatLE=function(t,e,i){return k(this,t,e,!0,i)},c.prototype.writeFloatBE=function(t,e,i){return k(this,t,e,!1,i)},c.prototype.writeDoubleLE=function(t,e,i){return j(this,t,e,!0,i)},c.prototype.writeDoubleBE=function(t,e,i){return j(this,t,e,!1,i)},c.prototype.copy=function(t,e,i,n){if(i||(i=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&n<i&&(n=i),n===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-i&&(n=t.length-e+i);var o,s=n-i;if(this===t&&i<e&&e<n)for(o=s-1;o>=0;--o)t[o+e]=this[o+i];else if(s<1e3||!c.TYPED_ARRAY_SUPPORT)for(o=0;o<s;++o)t[o+e]=this[o+i];else Uint8Array.prototype.set.call(t,this.subarray(i,i+s),e);return s},c.prototype.fill=function(t,e,i,n){if("string"==typeof t){if("string"==typeof e?(n=e,e=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),1===t.length){var o=t.charCodeAt(0);o<256&&(t=o)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;var s;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(s=e;s<i;++s)this[s]=t;else{var r=c.isBuffer(t)?t:B(new c(t,n).toString()),a=r.length;for(s=0;s<i-e;++s)this[s+e]=r[s%a]}return this};var U=/[^+\/0-9A-Za-z-_]/g;function F(t){return t<16?"0"+t.toString(16):t.toString(16)}function B(t,e){var i;e=e||1/0;for(var n=t.length,o=null,s=[],r=0;r<n;++r){if((i=t.charCodeAt(r))>55295&&i<57344){if(!o){if(i>56319){(e-=3)>-1&&s.push(239,191,189);continue}if(r+1===n){(e-=3)>-1&&s.push(239,191,189);continue}o=i;continue}if(i<56320){(e-=3)>-1&&s.push(239,191,189),o=i;continue}i=65536+(o-55296<<10|i-56320)}else o&&(e-=3)>-1&&s.push(239,191,189);if(o=null,i<128){if((e-=1)<0)break;s.push(i)}else if(i<2048){if((e-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function H(t){return n.toByteArray(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(U,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function $(t,e,i,n){for(var o=0;o<n&&!(o+i>=e.length||o>=t.length);++o)e[o+i]=t[o];return o}}).call(this,i(30))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});class n{static addInstance(t,e){n.ensureRegistrationsObject(),window.__CTLayers[t]={instance:e,isReady:!1}}static getInstance(t){n.ensureRegistrationsObject();const e=window.__CTLayers[t];return e?e.instance:null}static onReady(t,e){n.ensureRegistrationsObject();const i=window.__CTLayers[t];i&&i.isReady?setTimeout(()=>{e()},0):document.addEventListener(`base-layer-ready:${t}`,t=>{setTimeout(()=>{e()},0)})}static fireReady(t){n.ensureRegistrationsObject();const e=window.__CTLayers[t];e&&(e.isReady=!0),document.dispatchEvent(new CustomEvent(`base-layer-ready:${t}`,{detail:{layer:e.instance}}))}static ensureRegistrationsObject(){window.__CTLayers||(window.__CTLayers={})}}e.LayerRegistration=n,window.CtLayerRegistration=n},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(12);var o;!function(t){t[t.PLEASE_WAIT="Please wait..."]="PLEASE_WAIT",t[t.ERROR="Error"]="ERROR",t[t.ERROR_OCCURED="An error occurred"]="ERROR_OCCURED",t[t.YES="Yes"]="YES",t[t.NO="No"]="NO",t[t.OKAY="Okay"]="OKAY"}(o||(o={}));class s{static _create(){return new n.Metadata(r,o)}static get instance(){return this._instance||(this._instance=this._create())}}s._instance=null,e.DefaultAlertsMetadata=s;class r{constructor(t){this._translationProvider=t,this._metadata=s.instance}AlertWaiting(t){return{id:this.generateId(),raisedOn:(new Date).getTime(),priority:1,type:"info",title:this._translate(o.PLEASE_WAIT),body:t,showLoadingAnimation:!0}}AlertErrorWithOkayButton(t=this._translate(o.ERROR),e=this._translate(o.OKAY),i=1,n={}){return{id:this.generateId(),raisedOn:(new Date).getTime(),priority:i,type:"error",title:t,body:e,buttons:[{text:this._translate(o.OKAY),action:n.okay,type:"primary"}]}}AlertYesNoQuestion(t,e,i=0,n={}){return{id:this.generateId(),raisedOn:(new Date).getTime(),priority:i,type:"question",title:t,body:e,buttons:[{text:this._translate(o.NO),action:n.no,type:"primary"},{text:this._translate(o.YES),action:n.yes,type:"primary"}]}}AlertQuestion(t,e,i=0,n){return{id:this.generateId(),raisedOn:(new Date).getTime(),priority:i,type:"question",title:t,body:e,buttons:n}}AlertAcknowledge(t,e,i=0,n={},s=this._translate(o.OKAY)){return{id:this.generateId(),raisedOn:(new Date).getTime(),priority:i,type:"success",title:t,body:e,buttons:[{text:s,action:n.okay,type:"primary"}]}}generateId(){return"alert_"+(new Date).getTime().toString()}_translate(t){return this._translationProvider.translateI18nItem(this._metadata.getI18nItem(t))}}e.DefaultAlerts=r},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),(e.Icons||(e.Icons={})).COMMON={StatusOnline:{viewBox:"0 0 1024 1024",paths:["M470.923457,555.52087 L517.156966,555.52087 L678.97425,987.033627 L309.106173,987.033627 L470.923457,555.52087 Z M581.144144,581.041767 L537.561355,537.458979 C548.780687,526.239647 555.684891,510.828477 555.684891,493.87619 C555.684891,459.848327 528.068075,432.231511 494.040212,432.231511 C459.950704,432.231511 432.395532,459.848327 432.395532,493.87619 C432.395532,510.828477 439.238091,526.239647 450.457423,537.458979 L406.874635,581.041767 C384.559261,558.726393 370.750852,527.904054 370.750852,493.87619 C370.750852,425.75882 425.922841,370.586831 494.040212,370.586831 C562.095938,370.586831 617.329571,425.75882 617.329571,493.87619 C617.329571,527.904054 603.459518,558.726393 581.144144,581.041767 Z M494.040212,185.652792 L493.916922,185.652792 C664.179527,185.652792 802.14032,323.67523 802.14032,493.87619 C802.14032,579.007493 767.680944,656.063343 711.892509,711.851778 L668.309721,668.268989 C712.940469,623.638241 740.495641,561.993561 740.495641,493.937835 C740.495641,357.764738 630.213309,247.359117 494.040212,247.359117 C357.80547,247.359117 247.461493,357.764738 247.461493,493.937835 C247.461493,561.993561 274.95502,623.638241 319.647413,668.268989 L276.064625,711.851778 C220.337834,656.063343 185.816814,579.007493 185.816814,493.87619 C185.816814,323.67523 323.777607,185.652792 494.040212,185.652792 Z M494.040212,0.718753674 C766.386406,0.718753674 987.197648,221.529996 987.197648,493.87619 C987.197648,630.049288 931.964016,753.338647 842.702519,842.600143 L799.119731,799.017354 C877.22354,720.97519 925.552969,613.097001 925.552969,493.87619 C925.552969,255.557859 732.296898,62.3634333 494.040212,62.3634333 C255.72188,62.3634333 62.5274544,255.557859 62.5274544,493.87619 C62.5274544,613.097001 110.733594,720.97519 188.899048,799.017354 L145.316259,842.600143 C56.0547631,753.338647 0.882774838,630.049288 0.882774838,493.87619 C0.882774838,221.529996 221.632372,0.718753674 494.040212,0.718753674 Z"]},StatusOffline:{viewBox:"0 0 1024 1024",paths:["M586.678306,210.286115 C562.139482,203.996961 536.419525,200.652792 509.916922,200.652792 L510.040212,200.652792 C339.777607,200.652792 201.816814,338.67523 201.816814,508.87619 C201.816814,535.342777 205.153389,561.028843 211.426433,585.537988 L264.560722,532.403699 C263.833299,524.67956 263.461493,516.852047 263.461493,508.937835 C263.461493,372.764738 373.80547,262.359117 510.040212,262.359117 C517.95418,262.359117 525.7807,262.732021 533.503206,263.461215 L586.678306,210.286115 Z M806.86787,425.990261 C814.213724,452.364232 818.14032,480.162284 818.14032,508.87619 C818.14032,594.007493 783.680944,671.063343 727.892509,726.851778 L684.309721,683.268989 C728.940469,638.638241 756.495641,576.993561 756.495641,508.937835 C756.495641,498.546495 755.853446,488.305204 754.606559,478.251572 L806.86787,425.990261 Z","M729.725748,67.238671 C663.573003,34.2656239 588.970927,15.7187537 510.040212,15.7187537 C237.632372,15.7187537 16.8827748,236.529996 16.8827748,508.87619 C16.8827748,587.810373 35.420918,662.415536 68.3909758,728.573445 L114.711707,682.252714 C91.4312107,629.204161 78.5274544,570.558265 78.5274544,508.87619 C78.5274544,270.557859 271.72188,77.3634333 510.040212,77.3634333 C571.684303,77.3634333 630.316005,90.2960769 683.367584,113.596835 L729.725747,67.2386739 L729.725748,67.238671 Z M948.986253,283.87188 C983.639793,351.333945 1003.19765,427.822772 1003.19765,508.87619 C1003.19765,645.049288 947.964016,768.338647 858.702519,857.600143 L815.119731,814.017354 C893.22354,735.97519 941.552969,628.097001 941.552969,508.87619 C941.552969,445.074231 927.701805,384.506419 902.844202,330.013931 L948.98625,283.871881 L948.986253,283.87188 Z","M568.387956,664.470175 L694.97425,1002.03363 L325.106173,1002.03363 L381.675174,851.182956 L568.387956,664.470175 Z M38.537334,1018.85532 L3.14468065,983.537334 L984.462666,0.144680652 L1019.85532,35.462666 L38.537334,1018.85532 Z"]},LoadingSpinner:{viewBox:"0 0 1024 1024",paths:["M1005.714 512c0 272.571-221.143 493.714-493.714 493.714s-493.714-221.143-493.714-493.714c0-248 182.857-453.143 420.571-488.571v130.286c-166.857 33.714-292.571 181.714-292.571 358.286 0 201.714 164 365.714 365.714 365.714s365.714-164 365.714-365.714c0-176.571-125.714-324.571-292.571-358.286v-130.286c237.714 35.429 420.571 240.571 420.571 488.571z"]},Menu:{viewBox:"0 0 1024 1024",paths:["M64 192h896v128h-896v-128z","M64 448h896v128h-896v-128z","M64 704h896v128h-896v-128z"]},ChevronDown:{viewBox:"0 0 1024 1024",paths:["M614.286 420.571q0 7.429-5.714 13.143l-266.286 266.286q-5.714 5.714-13.143 5.714t-13.143-5.714l-266.286-266.286q-5.714-5.714-5.714-13.143t5.714-13.143l28.571-28.571q5.714-5.714 13.143-5.714t13.143 5.714l224.571 224.571 224.571-224.571q5.714-5.714 13.143-5.714t13.143 5.714l28.571 28.571q5.714 5.714 5.714 13.143z"]},ChevronLeft:{viewBox:"0 0 1024 1024",paths:["M669.143 172l-303.429 303.429 303.429 303.429q10.857 10.857 10.857 25.714t-10.857 25.714l-94.857 94.857q-10.857 10.857-25.714 10.857t-25.714-10.857l-424-424q-10.857-10.857-10.857-25.714t10.857-25.714l424-424q10.857-10.857 25.714-10.857t25.714 10.857l94.857 94.857q10.857 10.857 10.857 25.714t-10.857 25.714z"]},ChevronRight:{viewBox:"0 0 1024 1024",paths:["M632.571 501.143l-424 424q-10.857 10.857-25.714 10.857t-25.714-10.857l-94.857-94.857q-10.857-10.857-10.857-25.714t10.857-25.714l303.429-303.429-303.429-303.429q-10.857-10.857-10.857-25.714t10.857-25.714l94.857-94.857q10.857-10.857 25.714-10.857t25.714 10.857l424 424q10.857 10.857 10.857 25.714t-10.857 25.714z"]},ChevronUp:{viewBox:"0 0 1024 1024",paths:["M614.286 676.571q0 7.429-5.714 13.143l-28.571 28.571q-5.714 5.714-13.143 5.714t-13.143-5.714l-224.571-224.571-224.571 224.571q-5.714 5.714-13.143 5.714t-13.143-5.714l-28.571-28.571q-5.714-5.714-5.714-13.143t5.714-13.143l266.286-266.286q5.714-5.714 13.143-5.714t13.143 5.714l266.286 266.286q5.714 5.714 5.714 13.143z"]},ClearTextbox:{viewBox:"0 0 1024 1024",paths:["M1014.662 822.66c-0.004-0.004-0.008-0.008-0.012-0.010l-310.644-310.65 310.644-310.65c0.004-0.004 0.008-0.006 0.012-0.010 3.344-3.346 5.762-7.254 7.312-11.416 4.246-11.376 1.824-24.682-7.324-33.83l-146.746-146.746c-9.148-9.146-22.45-11.566-33.828-7.32-4.16 1.55-8.070 3.968-11.418 7.31 0 0.004-0.004 0.006-0.008 0.010l-310.648 310.652-310.648-310.65c-0.004-0.004-0.006-0.006-0.010-0.010-3.346-3.342-7.254-5.76-11.414-7.31-11.38-4.248-24.682-1.826-33.83 7.32l-146.748 146.748c-9.148 9.148-11.568 22.452-7.322 33.828 1.552 4.16 3.97 8.072 7.312 11.416 0.004 0.002 0.006 0.006 0.010 0.010l310.65 310.648-310.65 310.652c-0.002 0.004-0.006 0.006-0.008 0.010-3.342 3.346-5.76 7.254-7.314 11.414-4.248 11.376-1.826 24.682 7.322 33.83l146.748 146.746c9.15 9.148 22.452 11.568 33.83 7.322 4.16-1.552 8.070-3.97 11.416-7.312 0.002-0.004 0.006-0.006 0.010-0.010l310.648-310.65 310.648 310.65c0.004 0.002 0.008 0.006 0.012 0.008 3.348 3.344 7.254 5.762 11.414 7.314 11.378 4.246 24.684 1.826 33.828-7.322l146.746-146.748c9.148-9.148 11.57-22.454 7.324-33.83-1.552-4.16-3.97-8.068-7.314-11.414z"]},CircleCross:{viewBox:"0 0 1024 1024",paths:["M512 0c-282.77 0-512 229.23-512 512s229.23 512 512 512 512-229.23 512-512-229.23-512-512-512zM512 928c-229.75 0-416-186.25-416-416s186.25-416 416-416 416 186.25 416 416-186.25 416-416 416z","M672 256l-160 160-160-160-96 96 160 160-160 160 96 96 160-160 160 160 96-96-160-160 160-160z"]},Info:{viewBox:"0 0 1024 1024",paths:["M448 304c0-26.4 21.6-48 48-48h32c26.4 0 48 21.6 48 48v32c0 26.4-21.6 48-48 48h-32c-26.4 0-48-21.6-48-48v-32z","M640 768h-256v-64h64v-192h-64v-64h192v256h64z","M512 0c-282.77 0-512 229.23-512 512s229.23 512 512 512 512-229.23 512-512-229.23-512-512-512zM512 928c-229.75 0-416-186.25-416-416s186.25-416 416-416 416 186.25 416 416-186.25 416-416 416z"]},RequiredField:{viewBox:"0 0 1024 1024",paths:["M1022.442 406.048c-4.274-13.2-16.566-22.142-30.442-22.142l-343.458-0.012-106.122-325.128c-4.296-13.164-16.572-22.072-30.42-22.072s-26.124 8.908-30.42 22.072l-106.12 325.128-343.46 0.012c-13.876 0-26.168 8.942-30.444 22.142-4.274 13.2 0.446 27.65 11.688 35.784l277.736 200.922-106.056 325.026c-4.298 13.174 0.37 27.618 11.568 35.784 11.198 8.162 26.378 8.194 37.606 0.070l277.902-201.006 277.9 201.004c5.598 4.048 12.176 6.072 18.754 6.072 6.62 0 13.236-2.048 18.854-6.142 11.198-8.166 15.868-22.61 11.568-35.784l-106.056-325.024 277.734-200.922c11.242-8.132 15.962-22.582 11.688-35.784z"]},ShowPassword:{viewBox:"0 0 1024 1024",paths:["M512 192c-223.318 0-416.882 130.042-512 320 95.118 189.958 288.682 320 512 320 223.312 0 416.876-130.042 512-320-95.116-189.958-288.688-320-512-320zM764.45 361.704c60.162 38.374 111.142 89.774 149.434 150.296-38.292 60.522-89.274 111.922-149.436 150.296-75.594 48.218-162.89 73.704-252.448 73.704-89.56 0-176.858-25.486-252.452-73.704-60.158-38.372-111.138-89.772-149.432-150.296 38.292-60.524 89.274-111.924 149.434-150.296 3.918-2.5 7.876-4.922 11.86-7.3-9.96 27.328-15.41 56.822-15.41 87.596 0 141.382 114.616 256 256 256 141.382 0 256-114.618 256-256 0-30.774-5.452-60.268-15.408-87.598 3.978 2.378 7.938 4.802 11.858 7.302v0zM512 416c0 53.020-42.98 96-96 96s-96-42.98-96-96 42.98-96 96-96 96 42.982 96 96z"]},AlertQuestion:{viewBox:"0 0 1024 1024",paths:["M512 786.286v-109.714q0-8-5.143-13.143t-13.143-5.143h-109.714q-8 0-13.143 5.143t-5.143 13.143v109.714q0 8 5.143 13.143t13.143 5.143h109.714q8 0 13.143-5.143t5.143-13.143zM658.286 402.286q0-50.286-31.714-93.143t-79.143-66.286-97.143-23.429q-138.857 0-212 121.714-8.571 13.714 4.571 24l75.429 57.143q4 3.429 10.857 3.429 9.143 0 14.286-6.857 30.286-38.857 49.143-52.571 19.429-13.714 49.143-13.714 27.429 0 48.857 14.857t21.429 33.714q0 21.714-11.429 34.857t-38.857 25.714q-36 16-66 49.429t-30 71.714v20.571q0 8 5.143 13.143t13.143 5.143h109.714q8 0 13.143-5.143t5.143-13.143q0-10.857 12.286-28.286t31.143-28.286q18.286-10.286 28-16.286t26.286-20 25.429-27.429 16-34.571 7.143-46.286zM877.714 512q0 119.429-58.857 220.286t-159.714 159.714-220.286 58.857-220.286-58.857-159.714-159.714-58.857-220.286 58.857-220.286 159.714-159.714 220.286-58.857 220.286 58.857 159.714 159.714 58.857 220.286z"]},AlertWarning:{viewBox:"0 0 1024 1024",paths:["M585.143 785.714v-108.571c0-10.286-8-18.857-18.286-18.857h-109.714c-10.286 0-18.286 8.571-18.286 18.857v108.571c0 10.286 8 18.857 18.286 18.857h109.714c10.286 0 18.286-8.571 18.286-18.857zM584 572l10.286-262.286c0-3.429-1.714-8-5.714-10.857-3.429-2.857-8.571-6.286-13.714-6.286h-125.714c-5.143 0-10.286 3.429-13.714 6.286-4 2.857-5.714 8.571-5.714 12l9.714 261.143c0 7.429 8.571 13.143 19.429 13.143h105.714c10.286 0 18.857-5.714 19.429-13.143zM576 38.286l438.857 804.571c12.571 22.286 12 49.714-1.143 72s-37.143 36-62.857 36h-877.714c-25.714 0-49.714-13.714-62.857-36s-13.714-49.714-1.143-72l438.857-804.571c12.571-23.429 37.143-38.286 64-38.286s51.429 14.857 64 38.286z"]},Search:{viewBox:"0 0 1024 1024",paths:["M658.286 475.429c0-141.143-114.857-256-256-256s-256 114.857-256 256 114.857 256 256 256 256-114.857 256-256zM950.857 950.857c0 40-33.143 73.143-73.143 73.143-19.429 0-38.286-8-51.429-21.714l-196-195.429c-66.857 46.286-146.857 70.857-228 70.857-222.286 0-402.286-180-402.286-402.286s180-402.286 402.286-402.286 402.286 180 402.286 402.286c0 81.143-24.571 161.143-70.857 228l196 196c13.143 13.143 21.143 32 21.143 51.429z"]},Filter:{viewBox:"0 0 1024 1024",paths:["M869.49 192l-293.49 293.49v296.542l-128 32v-328.542l-293.49-293.49h714.98zM1024 128h-1024l384 384v384l256-64v-320l384-384z"]},UserIconEmpty:{viewBox:"0 0 1024 1024",paths:["M686.286 448c80.571 23.429 191.429 102.857 191.429 362.857 0 117.714-87.429 213.143-194.857 213.143h-488c-107.429 0-194.857-95.429-194.857-213.143 0-260 110.857-339.429 191.429-362.857-28.571-45.143-45.143-98.286-45.143-155.429 0-161.143 131.429-292.571 292.571-292.571s292.571 131.429 292.571 292.571c0 57.143-16.571 110.286-45.143 155.429zM438.857 73.143c-121.143 0-219.429 98.286-219.429 219.429s98.286 219.429 219.429 219.429 219.429-98.286 219.429-219.429-98.286-219.429-219.429-219.429zM682.857 950.857c66.857 0 121.714-62.286 121.714-140 0-180-60.571-292.571-173.714-298.286-51.429 45.143-118.286 72.571-192 72.571s-140.571-27.429-192-72.571c-113.143 5.714-173.714 118.286-173.714 298.286 0 77.714 54.857 140 121.714 140h488z"]},PlusSign:{viewBox:"0 0 1024 1024",paths:["M804.571 420.571v109.714q0 22.857-16 38.857t-38.857 16h-237.714v237.714q0 22.857-16 38.857t-38.857 16h-109.714q-22.857 0-38.857-16t-16-38.857v-237.714h-237.714q-22.857 0-38.857-16t-16-38.857v-109.714q0-22.857 16-38.857t38.857-16h237.714v-237.714q0-22.857 16-38.857t38.857-16h109.714q22.857 0 38.857 16t16 38.857v237.714h237.714q22.857 0 38.857 16t16 38.857z"]},Tick:{viewBox:"0 0 1024 1024",paths:["M864 128l-480 480-224-224-160 160 384 384 640-640z"]},TickHollow:{viewBox:"0 0 1024 1024",paths:["M397.434 917.696l-397.868-391.6 197.378-194.27 200.49 197.332 429.62-422.852 197.378 194.27-626.998 617.12zM107.912 526.096l289.524 284.962 518.656-510.482-89.036-87.632-429.62 422.852-200.49-197.334-89.034 87.634z"]},Cross:{viewBox:"0 0 1024 1024",paths:["M1014.662 822.66c-0.004-0.004-0.008-0.008-0.012-0.010l-310.644-310.65 310.644-310.65c0.004-0.004 0.008-0.006 0.012-0.010 3.344-3.346 5.762-7.254 7.312-11.416 4.246-11.376 1.824-24.682-7.324-33.83l-146.746-146.746c-9.148-9.146-22.45-11.566-33.828-7.32-4.16 1.55-8.070 3.968-11.418 7.31 0 0.004-0.004 0.006-0.008 0.010l-310.648 310.652-310.648-310.65c-0.004-0.004-0.006-0.006-0.010-0.010-3.346-3.342-7.254-5.76-11.414-7.31-11.38-4.248-24.682-1.826-33.83 7.32l-146.748 146.748c-9.148 9.148-11.568 22.452-7.322 33.828 1.552 4.16 3.97 8.072 7.312 11.416 0.004 0.002 0.006 0.006 0.010 0.010l310.65 310.648-310.65 310.652c-0.002 0.004-0.006 0.006-0.008 0.010-3.342 3.346-5.76 7.254-7.314 11.414-4.248 11.376-1.826 24.682 7.322 33.83l146.748 146.746c9.15 9.148 22.452 11.568 33.83 7.322 4.16-1.552 8.070-3.97 11.416-7.312 0.002-0.004 0.006-0.006 0.010-0.010l310.648-310.65 310.648 310.65c0.004 0.002 0.008 0.006 0.012 0.008 3.348 3.344 7.254 5.762 11.414 7.314 11.378 4.246 24.684 1.826 33.828-7.322l146.746-146.748c9.148-9.148 11.57-22.454 7.324-33.83-1.552-4.16-3.97-8.068-7.314-11.414z"]},MenuDots:{viewBox:"0 0 1024 1024",paths:["M384 192c0-70.692 57.308-128 128-128s128 57.308 128 128c0 70.692-57.308 128-128 128s-128-57.308-128-128zM384 512c0-70.692 57.308-128 128-128s128 57.308 128 128c0 70.692-57.308 128-128 128s-128-57.308-128-128zM384 832c0-70.692 57.308-128 128-128s128 57.308 128 128c0 70.692-57.308 128-128 128s-128-57.308-128-128z"]},User:{viewBox:"0 0 1024 1024",paths:["M576 706.612v-52.78c70.498-39.728 128-138.772 128-237.832 0-159.058 0-288-192-288s-192 128.942-192 288c0 99.060 57.502 198.104 128 237.832v52.78c-217.102 17.748-384 124.42-384 253.388h896c0-128.968-166.898-235.64-384-253.388z"]},Users:{viewBox:"0 0 1408 1024",paths:["M768 705.306v-13.256c92.524-35.408 160-145.59 160-276.050 0-159.058-100.29-288-224-288-123.712 0-224 128.942-224 288 0 130.46 67.476 240.642 160 276.050v13.256c-217.102 8.874-384 62.21-384 126.694v128h896v-128c0-64.484-166.898-117.82-384-126.694z","M1152 448.592v-5.078c73.032-20.754 128-111.146 128-219.514 0-123.712-71.634-224-160-224s-160 100.288-160 224c0 108.37 54.968 198.76 128 219.514v5.078c-31.81 1.172-62.054 4.074-89.878 8.412-6.28 68.208-28.092 131.24-61.738 182.996h471.616v-96c0-49.414-112.006-90.1-256-95.408z","M409.878 457.004c-27.824-4.338-58.070-7.24-89.878-8.412v-5.078c73.032-20.754 128-111.146 128-219.514 0-123.712-71.634-224-160-224s-160 100.288-160 224c0 108.37 54.968 198.76 128 219.514v5.078c-143.994 5.308-256 45.994-256 95.408v96h471.618c-33.646-51.756-55.458-114.788-61.74-182.996z"]},Mute:{viewBox:"0 0 1024 1024",paths:["M704 0l-320 320h-192v384l512-512zM954.176 69.824l-884.352 884.352 69.824 69.824 282.176-282.176 282.176 282.176v-564.354l320-320z"]}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(46);e.ChatEntryEventArgs=class extends n.BaseChatEventArgs{constructor(t){super(),this.chatEntry=t}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(11);e.BaseChatEventArgs=class extends n.BaseEventArgs{constructor(){super()}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(46);e.ConversationEventArgs=class extends n.BaseChatEventArgs{constructor(t){super(),this.conversation=t}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r};Object.defineProperty(e,"__esModule",{value:!0});const o=i(34),s=i(122),r=i(25);window.__CTRender=window.skate.h;const a=[s.OverridingStylesMixin,s.ComponentStylesMixin,s.RenderMixin].reduce((t,e)=>e(t),r.Component);class c extends a{renderHtml(t,e){if(null!=t||(t=""),-1===t.indexOf("<")&&-1===t.indexOf(">")&&-1===t.indexOf("&lt;")&&-1===t.indexOf("&gt;"))return t;const i=`html_${e||performance.now().toString().replace(".","")}`,n=r.h("span",{id:i,class:"user-html",style:{display:"inline-block"}});return this.onRenderComplete(()=>{if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector(`#${i}`);e&&(e.innerHTML=t)},!0),n}onRenderComplete(t,e=!1){this.addEventListener("render-complete",function i(){t(),e&&this.removeEventListener("render-complete",i)})}renderedCallback(){super.renderedCallback(),this.dispatchEvent(new CustomEvent("render-complete"))}forceRedraw(){this._renderTrigger=(new Date).getTime()}static register(){null!==this.is?customElements.get(this.is)||customElements.define(this.is,this):console.error("Could not register component, please ensure that it has a static is property")}}c.is=null,n([o.prop({type:Number,attribute:!1,default:0})],c.prototype,"_renderTrigger",void 0),e.CTBaseComponent=c},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Music="music"]="Music",t[t.Notification="notification"]="Notification",t[t.Ring="ring"]="Ring",t[t.Alarm="alarm"]="Alarm",t[t.Voice="voice"]="Voice",t[t.System="system"]="System",t[t.Dtmf="dtmf"]="Dtmf"}(e.VolumeStream||(e.VolumeStream={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0),s=i(17),r=i(7),a=i(8),c=i(5),l=i(6),d=i(16),h=i(2),u=i(10),p=i(14),g=i(15);e.FetchConversationsHandler=class extends r.BaseChatHandler{constructor(){super(...arguments),this.messageKey=a.ChatMessageType.FetchConversations}createIq(t){const e=d.createIq("fetch",this.layer.config.xmpp.iq.namespace,{max:t.max.toString()});return t.timestamp&&(e.fetch.timestamp=t.timestamp.toString()),e}handleIqResponse(t,e){return n(this,void 0,void 0,function*(){this.layer.logger.log(s.LoggerTypes.Mam,`%c QUERYING SERVER FOR CONVERSATION UPDATES FOR USER: %c${this.layer.comms.username} (since ${t.timestamp})`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;");const i=JSON.parse(e.data.fetch),n=(i.conversations||[]).map(t=>this._convertToConversation(t));if(n.length>0){this.layer.logger.log(s.LoggerTypes.Mam,`%c ${n.length} CONVERSATION(S) UPDATED`,"color: #669; font-weight: bold;",i.conversations);const e=(i.conversations||[]).reduce((t,e)=>(t.push(...e.messages.map(t=>t.xml)),t),[]),r=yield this.layer.processXmlStanzaStringsFromMam(e,!1),a=[];for(const t of r){const e=yield u.convertToChatEntry(t,this.layer);null!==e&&a.push(e)}a.sort((t,e)=>e.date-t.date),this.layer.logger.log(s.LoggerTypes.Mam,`%c ${a.length} CHAT ENTRIES(S) RECEIVED`,"color: #669; font-weight: bold;",a);const l=new WeakMap;a.forEach(t=>{if(!t.to)return;const e=n.find(e=>e.roomJid===t.to);if(!e)return;const i=l.get(e)||[];i.push(t),l.set(e,i)});let d=!1;const h=this.layer.getCurrentUserJid();for(const e in n){const i=n[e],s=new g.ConversationConfigReader(this.layer,i),r=l.get(i);if(r&&r.length>0){const e=i.participants.find(t=>t.jid===this.layer.getCurrentUserJid()&&t.role===o.ChatRole.Participant);s.alert&&!1===s.participantAlertResponsesVisible&&e?i.preview=this._createBackupStartPreview(i):i.preview=r[0],t.timestamp&&(i.hasUnread=!0)}else i.preview=this._createBackupStartPreview(i);if(s.alert){if(!i.acknowledgements||!i.acknowledgements.find(t=>t.jid===h)){const t=yield this.layer.priorityAlert(i);d||(d=!0===t)}}else d=!0}if(d){const t=this.layer.translateI18nItem(p.ChatCommonMetadata.getI18nItem(p.ChatCommonI18nKeys.YOU_HAVE_NEW_NOTIFICATIONS));this.layer.emit(c.ChatEvents.ChatNotification,new c.ChatNotificationEventArgs(null,"",t,!1))}}else this.layer.logger.log(s.LoggerTypes.Mam,"%c NO NEW UPDATES","color: #669; font-weight: bold;");return Object.assign({},e,{data:{conversations:n,lastIdentifier:parseInt(i.timestamp,10)}})})}_convertToConversation(t){const e=t.name,i=h.enumFromString(t.type),n=t.jid,o=t.participants,s=i===l.ConversationType.Named?t.title:null,r=i===l.ConversationType.Named?t.desc||"":null,a=t.started,c=t.receipts,d=t.responses,p=t.started_by,g=parseInt(t.hide_before)||0,m=t.reply_template,f=t.attachments,_=t.priority?this.layer.getConfiguredPriorityById(t.priority):null,v=t.expiry_ttl,y=t.activity_ttl;return u.createConversation(e,i,n,o,s,r,a,_?_.id:null,v,y,c,d,p,g,m,f)}_createBackupStartPreview(t){return{id:"fake",action:"start",type:o.ChatEntryType.Meta,instigator:t.instigator,date:t.createdTime,to:"fake"}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(18),s=i(8),r=i(7),a=i(14),c=i(16);e.CreateConversationHandler=class extends r.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.CreateConversation}createIq(t){const e=c.createIq("create",this.layer.config.xmpp.iq.namespace,{type:t.type.toString(),participants:{item:t.participants.map(t=>c.createIqNode({jid:t.jid,affiliation:t.role.toString()}))}});return t.config.behaviour.namedSettings&&(e.create.title=t.subject||"",e.create.description=t.description||""),t.priority&&(e.create.priority=t.priority),t.expiry_ttl&&(e.create.expiry_ttl=`${t.expiry_ttl}`),t.activity_ttl&&(e.create.activity_ttl=`${t.activity_ttl}`),e.create.reply_template=JSON.stringify(t.config),t.attachments&&t.attachments.length&&(e.create.attachments={attachment:t.attachments.map(t=>JSON.stringify(t))}),e}handleIqResponse(t,e){return n(this,void 0,void 0,function*(){if("created"in e){const t=e.created&&e.created.$attributes.id||null;return Object.assign({},e,{data:{newConversationId:t}})}if("exists"in e)return Object.assign({},e,{data:{exists:!0}})})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_CREATING_CONVERSATION_TITLE)),i=e.message,n=o.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.UpdateConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.UpdateConversation}createIq(t){return c.createIq("update",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id,title:t.newSubject,description:t.newDescription})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_UPDATING_CONVERSATION_TITLE)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.AddParticipantsHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.AddParticipants}createIq(t){return c.createIq("add",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id,participants:{item:t.participants.map(t=>c.createIqNode({jid:t.jid,affiliation:t.role.toString()}))}})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_ADDING_PARTICIPANTS_TITLE)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.RemoveParticipantsHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.RemoveParticipants}createIq(t){return c.createIq("remove",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id,participants:{item:t.participants.map(t=>c.createIqNode({jid:t.jid}))}})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_REMOVING_PARTICIPANTS_TITLE)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.ChangeParticipantRoleHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ChangeParticipantRole}createIq(t){return c.createIq("changerole",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id,participant:c.createIqNode({jid:t.participant.jid,affiliation:t.newRole.toString()})})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_CHANGING_PARTICIPANT_ROLE_TITLE)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.LeaveConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.LeaveConversation}createIq(t){return c.createIq("leave",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_LEAVING_CONVERSATION_TITLE)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.EndConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.EndConversation}createIq(t){return c.createIq("end",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_ENDING_CONVERSATION_TITLE)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(11);e.PriorityConversationAcknowledgedEventArgs=class extends n.BaseEventArgs{constructor(t,e,i){super(),this.conversation=t,this.pendingCount=e,this.instigator=i}}},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(2),s=i(23),r=i(6),a=s.getSource("Media"),c=s.getSource("fileEncryption"),l=s.getSource("mediaproperties"),d=s.getSource("volumecontrol");var h;!function(t){t[t.MEDIA_NONE=0]="MEDIA_NONE",t[t.MEDIA_STARTING=1]="MEDIA_STARTING",t[t.MEDIA_RUNNING=2]="MEDIA_RUNNING",t[t.MEDIA_PAUSED=3]="MEDIA_PAUSED",t[t.MEDIA_STOPPED=4]="MEDIA_STOPPED"}(h=e.MediaStatus||(e.MediaStatus={})),e.SimpleAudioPlayer=class{constructor(t){this._totalLoops=1,this._loopsRemaining=0,this._loopIndefinitely=!1,this._audioStream=r.VolumeStream.Notification,this._volumeToPlayAt=-1,this._notifiedReady=!1,this._failTimerWillRetry=!0,this.state=0,this._reportDuration=(()=>n(this,void 0,void 0,function*(){this._durationCallback&&this._durationCallback(yield this.duration())})),this._mediaStatusUpdate=(t=>{this._updateMediaState(t),t===h.MEDIA_STOPPED&&(!0!==this._forceStop?this._checkIfVolumeHasChanged(()=>this._loop()):(clearTimeout(this._delayTimer),this._resetVolume(()=>delete this._previousVolume)),clearTimeout(this._failTimer)),t===h.MEDIA_RUNNING&&clearTimeout(this._failTimer),t===h.MEDIA_STARTING&&(this._failTimer=setTimeout(()=>{this._failTimerWillRetry&&(this.play(),this._failTimerWillRetry=!1)},5e3))}),this._loop=(()=>{!this._forceStop&&this._loopIndefinitely?this._delayTimer=setTimeout(()=>{!this._forceStop&&this._media&&this.play()},2e3):(this._loopsRemaining--,this._loopsRemaining>0?this._delayTimer=setTimeout(()=>this._forceStop?null:this.play(),2e3):this._resetVolume(()=>delete this._previousVolume))}),this._isMobile=o.isMobile(),this._volumeControl=d,t&&(this._callbackOnStateChange=t)}_init(t){this._media&&(this._forceStop=!0,this.stop()),this._audioSrc=this._getAssetPath(t),this._isMobile?(this._notifiedReady=!1,this._media=new a(this._audioSrc,t=>{this._readyCallback&&!1===this._notifiedReady&&(this._notifiedReady=!0,this._readyCallback())},t=>{t.code&&1===t.code&&this._loadingFromAssets&&(this.setAudio("pager_responder_alert.m4a",this._totalLoops,this._volumeToPlayAt,this._audioStream),setTimeout(()=>this.play(),500))},this._mediaStatusUpdate),this._durationCallback&&(this._audioSrc.includes("encrypted")?c.getAudioFileDuration(t=>{this._duration=1e3*Math.ceil(t),this._reportDuration()},t=>{console.error("Media properties error:",t)},this._getAssetPath(this._audioSrc,!0)):l.getProperties(t=>{this._duration=1e3*Math.ceil(t.duration),this._reportDuration()},t=>{console.error("Media properties error:",t)},this._getAssetPath(this._audioSrc,!0)))):window.cti&&(this._audioElm=document.createElement("audio"),this._audioElm.setAttribute("preload","true"),this._audioElm.onloadeddata=(()=>n(this,void 0,void 0,function*(){yield this._reportDuration(),this._readyCallback&&!1===this._notifiedReady&&(this._notifiedReady=!0,this._readyCallback())})),this._audioElm.setAttribute("src",this._audioSrc),this._audioElm.onended=this._loop,this._audioElm.onplay=(()=>this._updateMediaState(h.MEDIA_RUNNING)),this._audioElm.onpause=(()=>this._updateMediaState(h.MEDIA_PAUSED)),this._audioElm.onended=(()=>this._updateMediaState(h.MEDIA_STOPPED)),this._media=this._audioElm)}_getAssetPath(t,e=!1){this._loadingFromAssets=!1;let i="";if(!0===e&&(i="file://"),t.includes("/")||t.includes("\\"))return t.includes("file://")?t:`${i}${t}`;{this._loadingFromAssets=!0;const e=window,i=e.cti?e.cti.store.schema.assetDir||"user-assets/":"";return e.cti?`${i}${t}`:t}}_updateMediaState(t){this.state=t,this._callbackOnStateChange&&this._callbackOnStateChange(this.state)}_getAndSetVolume(t){this._volumeControl.getDeviceVolume(e=>{void 0===this._previousVolume&&(this._previousVolume=parseFloat(e)),this._volumeControl.setDeviceVolume(()=>this._media.setStreamId(t,this._audioStream.toString()),()=>this.stop(),this._volumeToPlayAt/100,this._audioStream)},t=>this.stop(),this._audioStream)}_resetVolume(t=(()=>{})){-1!==this._volumeToPlayAt&&this._volumeControl&&this._volumeControl.setDeviceVolume(t,()=>{},this._previousVolume,this._audioStream)}_checkIfVolumeHasChanged(t=(()=>{})){-1!==this._volumeToPlayAt&&this._volumeControl?this._volumeControl.getDeviceVolume(e=>{const i=parseFloat(e);Math.ceil(100*i)!==this._volumeToPlayAt?this._volumeControl.setDeviceVolume(t,()=>this.stop(),this._volumeToPlayAt/100,this._audioStream):t()},t,this._audioStream):t()}setAudio(t,e=1,i=-1,n=r.VolumeStream.Notification,o,s){this._durationCallback=o,this._readyCallback=s,this._init(t),this._totalLoops=e,this._loopsRemaining=this._totalLoops,this._loopIndefinitely=0===this._loopsRemaining,this._volumeToPlayAt=i,this._audioStream=n,this._updateMediaState(h.MEDIA_NONE)}play(){this._forceStop=!1,this._audioSrc&&this._media&&(-1!==this._volumeToPlayAt&&this._volumeControl?this._getAndSetVolume(()=>this._media.play()):this._media.setStreamId?this._media.setStreamId(()=>this._media.play(),this._audioStream.toString()):setTimeout(()=>this._media.play(),100))}stop(t=!1){this._audioSrc&&this._media&&(this._forceStop=t,this._updateMediaState(h.MEDIA_STOPPED),this._media.stop?this._media.stop():(this._media.pause(),this._audioElm.currentTime=0),this._loopsRemaining=this._totalLoops)}pause(){this._audioSrc&&this._media&&(this._updateMediaState(h.MEDIA_PAUSED),this._media.pause())}duration(){return n(this,void 0,void 0,function*(){if(this._audioSrc){if(o.isMobile())return this._duration;if(this._audioElm.duration===1/0){for(;this._audioElm.duration===1/0;)yield new Promise(t=>setTimeout(t,100)),this._audioElm.currentTime=1e7*Math.random();return 1e3*this._audioElm.duration}return 1e3*this._audioElm.duration}return 0})}release(){this._media&&this._media.release&&this._media.release()}reset(){clearTimeout(this._delayTimer),delete this._delayTimer,this._audioSrc="",this._audioElm=null,this._media=null,this._duration=0,this.state=h.MEDIA_NONE,this._totalLoops=1,this._loopsRemaining=0,this._loopIndefinitely=!1,this._audioStream=r.VolumeStream.Notification,this._previousVolume=null,this._volumeToPlayAt=-1,this._forceStop=null}}},function(t,e,i){"use strict";e.__esModule=!0,e.stateify=e.TokenState=e.CharacterState=void 0;var n=i(28),o=function(t){this.j=[],this.T=t||null};o.prototype={defaultTransition:!1,on:function(t,e){if(t instanceof Array){for(var i=0;i<t.length;i++)this.j.push([t[i],e]);return this}return this.j.push([t,e]),this},next:function(t){for(var e=0;e<this.j.length;e++){var i=this.j[e],n=i[0],o=i[1];if(this.test(t,n))return o}return this.defaultTransition},accepts:function(){return!!this.T},test:function(t,e){return t===e},emit:function(){return this.T}};var s=(0,n.inherits)(o,function(t){this.j=[],this.T=t||null},{test:function(t,e){return t===e||e instanceof RegExp&&e.test(t)}}),r=(0,n.inherits)(o,function(t){this.j=[],this.T=t||null},{jump:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this.next(new t(""));return i===this.defaultTransition?(i=new this.constructor(e),this.on(t,i)):e&&(i.T=e),i},test:function(t,e){return t instanceof e}});e.CharacterState=s,e.TokenState=r,e.stateify=function(t,e,i,n){for(var o=0,r=t.length,a=e,c=[],l=void 0;o<r&&(l=a.next(t[o]));)a=l,o++;if(o>=r)return[];for(;o<r-1;)l=new s(n),c.push(l),a.on(t[o],l),a=l,o++;return l=new s(i),c.push(l),a.on(t[r-1],l),c}},function(t,e,i){"use strict";e.__esModule=!0,e.createTokenClass=function(){return function(t){t&&(this.v=t)}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4),c=i(9);class l extends s.CTLayerComponent{constructor(){super(...arguments),this._rippleTimeout=null}static get is(){return"ct-button"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(192)}generateComponentMarkup(){const t=[this.type];this.selected&&t.push("selected"),this.large&&t.push("large"),this.isWaiting&&t.push("waiting"),this.isTransparent&&t.push("transparent");const e=r.Icons.COMMON.LoadingSpinner,i=c.buildStyles();return this.width&&(i.width=this.width),this.textColor&&(i.color=this.textColor),window.__CTRender("button",{class:t.join(" "),style:i,disabled:this.isWaiting||this.disabled,onClick:t=>this.handleButtonClick(t)},window.__CTRender("div",{class:"button-content"},c.renderIf(!this.isWaiting&&!!this.icon,window.__CTRender(a.CTIcon,{icon:this.icon,color:this.iconColor,width:this.iconWidth,height:this.iconHeight,class:"icon"})),c.renderIfElse(this.isWaiting,window.__CTRender(a.CTIcon,{icon:e,color:this.iconColor,width:this.iconHeight,height:this.iconHeight,spin:!0,class:"icon"}),window.__CTRender("div",{class:"label"},window.__CTRender("slot",null)))))}handleButtonClick(t){if(!this.disabled&&(this._ripple(t.offsetX,t.offsetY,t.target),"function"==typeof this.onClick)){const e=Object.create(t,{target:{value:this}});this.onClick(e)}}_ripple(t,e,i){const n=i.querySelector(".ripple");n&&n.remove();const o=i.clientWidth,s=i.clientHeight,r=Math.max(o,s),a=t-r/2,c=e-r/2;clearTimeout(this._rippleTimeout),this._rippleTimeout=setTimeout(()=>{const t=document.createElement("span");t.classList.add("ripple"),t.style.width=`${r}px`,t.style.height=`${r}px`,t.style.left=`${a}px`,t.style.top=`${c}px`,i.insertBefore(t,i.firstChild),t.addEventListener("animationend",()=>{t.remove()}),t.classList.add("animate")},0)}}n([s.prop({type:String,attribute:!0,default:"primary"})],l.prototype,"type",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],l.prototype,"selected",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],l.prototype,"disabled",void 0),n([s.prop({type:String,attribute:!0,default:null})],l.prototype,"width",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],l.prototype,"large",void 0),n([s.prop({type:String,attribute:!0})],l.prototype,"textColor",void 0),n([s.prop({type:String,attribute:!0,default:"auto"})],l.prototype,"iconColor",void 0),n([s.prop({type:String,attribute:!0,default:"18px"})],l.prototype,"iconWidth",void 0),n([s.prop({type:String,attribute:!0,default:"18px"})],l.prototype,"iconHeight",void 0),n([s.prop({type:Function,attribute:!0})],l.prototype,"onClick",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],l.prototype,"isTransparent",void 0),n([s.prop({type:Object,attribute:!1,default:null})],l.prototype,"icon",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],l.prototype,"isWaiting",void 0),e.CTButton=l,l.register()},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(4),a=i(12),c=i(37);var l;!function(t){t[t.MEMBERS="Members: "]="MEMBERS"}(l||(l={}));class d{static _create(){return new a.Metadata(h,l)}static get instance(){return this._instance||(this._instance=this._create())}}d._instance=null,e.CTGroupTileMetadata=d;class h extends s.CTLayerComponent{constructor(){super(),this.setMetadata(d.instance)}static get is(){return"ct-group-tile"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(200)}generateComponentMarkup(){if(this.group)return window.__CTRender(r.CTAvatarTile,{height:this.height,showAvatar:!1,detailStyle:this.detailStyle},this.showIcon&&window.__CTRender(c.CTGroupAvatar,{slot:"avatar",size:40}),window.__CTRender("div",{class:"name"},this.group.name),window.__CTRender("div",{class:"count"},this.translateI18nItem(l.MEMBERS),this.group.users.length),window.__CTRender("slot",{name:"additional"}))}}n([s.prop({type:s.Stroolean,attribute:!1,default:!0})],h.prototype,"showIcon",void 0),n([s.prop({type:Object,attribute:!1})],h.prototype,"group",void 0),n([s.prop({type:String,attribute:!1,default:null})],h.prototype,"height",void 0),n([s.prop({type:Object,attribute:!1,default:{}})],h.prototype,"detailStyle",void 0),e.CTGroupTile=h,h.register()},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(9),o=i(2),s=i(9),r="vl-l";e.VirtualList=class{constructor(t,e,i){this.EMPTY_STYLES=n.buildStyles(),this._scrollerStyles=n.buildStyles({"overflow-y":"auto",overflowScrolling:"touch",WebkitOverflowScrolling:"touch","will-change":"transform"}),this._host=t,this._items=e,this._config=i,this._initialized=!1,this._id=`vl_${o.generateRandomSixString()}`,this._scroller=null,this._useBlocks=i.blockSize&&i.blockSize>0,t.onRenderComplete(()=>{this._scroller=t.shadowRoot.querySelector(`#${this._id}`),this._scroller?this._initialized||(s.debouncedRequestAnimationFrame(()=>this._calculateVirtualListData(!0)),this._scroller.addEventListener("scroll",()=>s.debouncedRequestAnimationFrame(()=>this._calculateVirtualListData())),this._initialized=!0):this._initialized=!1}),window.addEventListener("resize",()=>{this._useBlocks||this._calculateVirtualListData()})}get items(){return this._items}setItems(t){this._items=t,this._calculateVirtualListData(!0),this._updateHost()}render(t,e="",i=""){const n=this._data&&this._data.scrollerProps||{id:this._id,key:this._id},o=this._data&&this._data.containerProps||{},s=this._data&&!!this._data.viewportItems;return window.__CTRender("div",Object.assign({class:`virtual-list-scroller ${e}`},n),s&&window.__CTRender("div",Object.assign({class:`virtual-list-content ${i}`},o),this._data.viewportItems.map((e,i)=>t(e.item,e.itemProps,i))))}_calculateVirtualListData(t=!1){if(!this._scroller)return;const e=Math.floor(this._scroller.scrollTop/this._config.itemHeight),i=parseInt(this._scroller.getAttribute(r))||null,n=this._useBlocks?Math.floor(e/this._config.blockSize):e;if(!t&&i===n)return;const o=this._items.length;if(this._useBlocks){const t=this._config.itemHeight*this._config.blockSize,e=Math.floor(o/this._config.blockSize)+1,i=Math.max(0,n-1),s=(Math.min(e,n+1)-i+1)*this._config.blockSize,r=i*this._config.blockSize,a=Math.max(0,r+s-1),c=i*t,l=this._items.slice(r,a+1);this._data=this._generateVirtualListData(l,n,c)}else{const t=Math.ceil(this._scroller.clientHeight/this._config.itemHeight),i=3*t,s=Math.max(e-i,0),r=e+t,a=(Math.max(e-s,0),Math.min(o-r,i),s*this._config.itemHeight),c=this._items.slice(s,r+1);this._data=this._generateVirtualListData(c,n,a)}this._updateHost(),"function"==typeof this._config.onUpdate&&this._config.onUpdate(this._data)}_generateVirtualListData(t,e,i){const n=this._items.length*this._config.itemHeight;return{viewportItems:this._mapToVirtualListItems(t,i),scrollerProps:{id:this._id,key:this._id,[r]:e.toString(),style:this._scrollerStyles},containerProps:{style:this._setStyles({position:"relative",height:`${n}px`})}}}_mapToVirtualListItems(t,e){return t.map((t,i)=>{const n=e+i*this._config.itemHeight;return{item:t,itemProps:{key:this._config.itemKeyGetter(t),style:this._setStyles({position:"absolute",top:0,left:0,width:"100%",height:`${this._config.itemHeight}px`,transform:`translateY(${n}px)`})}}})}_setStyles(t={}){return Object.assign({},this.EMPTY_STYLES,t)}_updateHost(){this._host.forceRedraw()}forceRecalc(){this._calculateVirtualListData(!0)}}},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(13),c=i(66),l=i(67),d=i(5),h=i(6),u=i(4),p=i(29),g=i(2),m=i(0);var f,_;!function(t){t[t.LOADING="loading"]="LOADING",t[t.IMAGE_FILE="image-file"]="IMAGE_FILE",t[t.AUDIO_FILE="audio-file"]="AUDIO_FILE",t[t.VIDEO_FILE="video-file"]="VIDEO_FILE",t[t.ERROR="error"]="ERROR"}(f||(f={})),function(t){t[t.ERROR_DEFAULT="There was an error loading the attachment."]="ERROR_DEFAULT",t[t.ERROR_NO_URI="No attachment URI provided"]="ERROR_NO_URI",t[t.ERROR_FAILED_DOWNLOAD="Attachment failed to download."]="ERROR_FAILED_DOWNLOAD",t[t.ERROR_CANNOT_LOAD_AUDIO="Unable to load audio file."]="ERROR_CANNOT_LOAD_AUDIO",t[t.ERROR_UNSUPPORTED_ATTACHMENT="Unsupported attachment type."]="ERROR_UNSUPPORTED_ATTACHMENT",t[t.ERROR_TAP_TO_RETRY="Tap to retry."]="ERROR_TAP_TO_RETRY"}(_||(_={}));let v=class extends a.CTCLComponent{constructor(){super(...arguments),this._allowRetry=!0,this._options={},this._defaultOptions={height:150,width:150,quality:100},this._processRemoteAttachment=(()=>o(this,void 0,void 0,function*(){try{this.state=f.LOADING;const t=this.type===h.SupportedAttachmentType.VIDEO,e=yield this.layer.downloadFileWithoutCatch(this.uri,t);this._processAttachmentAfterDownload(e)}catch(t){this._errorMessage=this.translateI18nItem(_.ERROR_FAILED_DOWNLOAD),this._allowRetry=!0,this.state=f.ERROR}})),this._openImageFullScreen=(()=>o(this,void 0,void 0,function*(){!g.isDesktop()&&this.allowOpenImageInFullScreen&&(yield this.layer.showMediaFullscreen(this._fullImgFilepath))}))}initialize(){return o(this,void 0,void 0,function*(){this._options=Object.assign({},this._options,this._defaultOptions),this.uri&&this.uri.includes("http")?this._processRemoteAttachment():this.uri?this._processAttachmentAfterDownload(this.uri,!0):(this._errorMessage=this.translateI18nItem(_.ERROR_NO_URI),this._allowRetry=!1,this.state=f.ERROR)})}setupListeners(){}_processAttachmentAfterDownload(t,e=!1){return o(this,void 0,void 0,function*(){switch(e||this.emitEvent(d.ChatEvents.AttachmentDownloadComplete,new d.AttachmentDownloadComplete(t,this.conversationId,this.type)),this.type){case h.SupportedAttachmentType.AUDIO:setTimeout(()=>{this.file=t,this.state=f.AUDIO_FILE,e||this.emitEvent(d.ChatEvents.AudioAttachmentDownloadComplete,new d.AudioAttachmentDownloadComplete(this.file))},1e3);break;case h.SupportedAttachmentType.IMAGE:this.uri.includes("data:image")?this.file=this.uri:this.file=yield p.getThumbnail(t,this._options.width,this._options.height,this._options.quality),this._fullImgFilepath=t,this.state=f.IMAGE_FILE;break;case h.SupportedAttachmentType.VIDEO:this.file=t,this.state=f.VIDEO_FILE;break;default:throw new Error(this.translateI18nItem(_.ERROR_UNSUPPORTED_ATTACHMENT))}})}generateComponentMarkup(){let t;switch(this.state){case f.AUDIO_FILE:t=this._renderAudio();break;case f.IMAGE_FILE:t=this._renderImage();break;case f.VIDEO_FILE:t=this._renderVideo();break;case f.ERROR:t=this._renderError();break;case f.LOADING:default:t=this._renderLoading()}return window.__CTRender("div",{class:"container"},t)}_renderLoading(){return window.__CTRender(u.CTIcon,{width:"16",height:"16",icon:m.Icons.COMMON.LoadingSpinner,spin:!0})}_renderError(){return window.__CTRender("div",{class:"error",onClick:this._allowRetry?this._processRemoteAttachment:null},window.__CTRender(u.CTIcon,{width:"16",height:"16",icon:m.Icons.COMMON.AlertWarning}),window.__CTRender("p",null,this._errorMessage||this.translateI18nItem(_.ERROR_DEFAULT),this._allowRetry&&` ${this.translateI18nItem(_.ERROR_TAP_TO_RETRY)}`))}_renderImage(){return window.__CTRender("img",{src:this.file,onClick:this._openImageFullScreen})}_renderAudio(){return window.__CTRender(c.CTCLAudioRecorderPlayer,{showRecord:!1,source:this.file,stream:this.stream,volumeToPlayAt:this.volumeToPlayAt,disablePlay:this.disablePlay,preventRemoteStart:this.preventRemoteStart})}_renderVideo(){return window.__CTRender(l.CTCLVideoRecorderPlayer,{source:this.file,showRecord:!1,allowRemoval:!1,showControls:!0})}};n([s.prop({type:String,attribute:!1,default:""})],v.prototype,"uri",void 0),n([s.prop({type:String,attribute:!1,default:""})],v.prototype,"type",void 0),n([s.prop({type:String,attribute:!1,default:""})],v.prototype,"file",void 0),n([s.prop({type:String,attribute:!1,default:f.LOADING})],v.prototype,"state",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],v.prototype,"allowOpenImageInFullScreen",void 0),n([s.prop({type:String,attribute:!1,default:""})],v.prototype,"conversationId",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],v.prototype,"disablePlay",void 0),n([s.prop({type:String,attribute:!1,default:h.VolumeStream.Music})],v.prototype,"stream",void 0),n([s.prop({type:Number,attribute:!1,default:-1})],v.prototype,"volumeToPlayAt",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],v.prototype,"preventRemoteStart",void 0),v=n([r.component({tag:"ctcl-attachment-handler",styles:[i(257)],i18nKeys:_})],v),e.CTCLAttachmentHandler=v},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(0),c=i(13),l=i(5),d=i(59),h=i(251),u=i(6),p=i(4),g=i(20),m=i(9);var f;!function(t){t[t.NO_RECORDING_SOURCE="No microphone has been detected on your system."]="NO_RECORDING_SOURCE",t[t.GENERAL_ERROR="There was an error trying to record audio."]="GENERAL_ERROR"}(f||(f={}));let _=class extends c.CTCLComponent{constructor(){super(...arguments),this._player=new d.SimpleAudioPlayer(t=>this._statusCallback(t)),this._recorder=new h.SimpleAudioRecorder(t=>this._onRecordingFinished(t),t=>this._onRecordingError(t)),this._currentlyRecording=!1,this._removeAudio=(()=>o(this,void 0,void 0,function*(){this.source="",this.currentTime=0,this.duration=0,this.onAudioRemoved&&this.onAudioRemoved()})),this._play=((t=200)=>this._buffer(()=>{this.emitEvent(l.ChatEvents.MuteAlertToPlayOtherAudio),this._timer||(this._timer=setInterval(()=>this.currentTime+=200,200)),setTimeout(()=>{this.disablePlay=!1,this._player.play()},t)})),this._pause=(()=>this._buffer(()=>{this.disablePlay=!1,clearInterval(this._timer),delete this._timer,this._player.pause(),this.emitEvent(l.ChatEvents.ResumeAlertAfterPlayingAudio)})),this._stop=(()=>this._buffer(()=>{clearInterval(this._timer),delete this._timer,this._player.stop(!0),this.currentTime=0,this.emitEvent(l.ChatEvents.ResumeAlertAfterPlayingAudio)})),this._startRecording=(()=>this._buffer(()=>{this._currentlyRecording?(this._currentlyRecording=!1,this._recorder.stop(),this.emitEvent(l.ChatEvents.AudioRecordingStopped),this._stopRecordingIndicator()):(this._startRecordingIndicator(),this.emitEvent(l.ChatEvents.AudioRecordingStarted),this._currentlyRecording=!0,this._recorder.start())})),this._onRecordingFinished=(t=>{t?(this.source=t,this.initPlayer(this.source),this.onRecordingFinished&&this.onRecordingFinished(this.source)):this.source=""}),this._onRecordingError=(t=>{this._stopRecordingIndicator();let e=f.GENERAL_ERROR;switch(t){case h.AudioRecorderError.NoAudioDevicesFound:e=f.NO_RECORDING_SOURCE}const i=new a.DefaultAlerts(this).AlertErrorWithOkayButton(this.translateI18nItem(g.CommonMetadata.getI18nItem(g.CommonI18nKeys.ERROR)),this.translateI18nItem(e),1,{okay:()=>{}});this.emitEvent(l.ChatEvents._Request_RaiseAlert,i)}),this._startRecordingIndicator=(()=>{let t=!0;this._recordBtn&&(setTimeout(()=>this._recordBtn.classList.add("flash"),100),this._flashTimer=setInterval(()=>{t?this._recordBtn.classList.remove("flash"):this._recordBtn.classList.add("flash"),t=!t},500))}),this._stopRecordingIndicator=(()=>{clearInterval(this._flashTimer),this._recordBtn&&this._recordBtn.classList.remove("flash")})}initialize(){return o(this,void 0,void 0,function*(){this.source&&this.initPlayer(this.source)})}setupListeners(){!1===this.preventRemoteStart&&(this.addListener(l.ChatEvents.RemotelyStartAudioPlayer,()=>{this._play(1e3)}),this.addEventListener(l.ChatEvents.RemotelyStopAudioPlayer,()=>{this._stop()}))}_buffer(t,e=200){(!this._bufferTime||(new Date).valueOf()>this._bufferTime+e)&&(this._bufferTime=(new Date).valueOf(),t())}initPlayer(t){this._player.setAudio(t,1,this.volumeToPlayAt,this.stream,t=>this.duration=t,()=>this.isReady=!0)}_statusCallback(t){this.mediaStatus=t,this.mediaStatus===d.MediaStatus.MEDIA_STOPPED&&(this.disablePlay=!1,clearInterval(this._timer),delete this._timer,this.currentTime=0,this.emitEvent(l.ChatEvents.ResumeAlertAfterPlayingAudio))}_millisToMinutesAndSeconds(t){if(0===t)return"0:00";const e=Math.floor(t/6e4),i=Math.round(t%6e4/1e3);return`${e}:${i<10?"0":""}${i}`}disconnectedCallback(){super.disconnectedCallback(),this._player.stop(!0),this._player.release()}generateComponentMarkup(){const t=!this.source,e=!(this._currentlyRecording||this.disablePlay||(!this.showRecord||!this.source)&&!this.source),i=!this._currentlyRecording&&e&&(this.mediaStatus===d.MediaStatus.MEDIA_RUNNING||this.mediaStatus===d.MediaStatus.MEDIA_PAUSED),n=this.allowRemoval&&this.source&&this.mediaStatus!==d.MediaStatus.MEDIA_RUNNING;return window.__CTRender("div",{class:"container"},window.__CTRender("div",{class:"controls"},this.showRecord&&window.__CTRender("div",{class:`action ${t?"":"disabled"}`,ref:t=>this._recordBtn=t},window.__CTRender(p.CTIcon,{color:"red",width:"16",height:"16",icon:u.Icons.UI.CircleFilled,onClick:this._startRecording})),window.__CTRender("div",{class:`action ${e?"":"disabled"}`},this.mediaStatus===d.MediaStatus.MEDIA_RUNNING?window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.Pause,onClick:e?this._pause:null}):window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.Play,onClick:e?this._play:null})),window.__CTRender("div",{class:`action ${i?"":"disabled"}`},window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.SquareFilled,onClick:i?this._stop:null})),this.allowRemoval&&this.source&&window.__CTRender("div",{class:`action ${n?"":"disabled"}`},window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.Cross,onClick:n?this._removeAudio:null}))),this.source&&window.__CTRender("div",{class:"progress"},window.__CTRender("div",{class:"length left"},window.__CTRender("span",null,this._millisToMinutesAndSeconds(this.currentTime))),window.__CTRender("div",{class:"bar"},window.__CTRender("span",{style:m.buildStyles({width:`${this.currentTime/this.duration*100}%`})})),window.__CTRender("div",{class:"length right"},window.__CTRender("span",null,this._millisToMinutesAndSeconds(this.duration)))))}};n([s.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"showRecord",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"allowRemoval",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"disablePlay",void 0),n([s.prop({type:String,attribute:!1,default:""})],_.prototype,"source",void 0),n([s.prop({type:Number,attribute:!1,default:0})],_.prototype,"mediaStatus",void 0),n([s.prop({type:Number,attribute:!1,default:0})],_.prototype,"currentTime",void 0),n([s.prop({type:Number,attribute:!1,default:0})],_.prototype,"duration",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"isReady",void 0),n([s.prop({type:String,attribute:!1,default:u.VolumeStream.Music})],_.prototype,"stream",void 0),n([s.prop({type:Number,attribute:!1,default:-1})],_.prototype,"volumeToPlayAt",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"preventRemoteStart",void 0),n([s.prop({type:Function,attribute:!1,default:null})],_.prototype,"onAudioRemoved",void 0),n([s.prop({type:Function,attribute:!1,default:null})],_.prototype,"onRecordingFinished",void 0),_=n([r.component({tag:"ctcl-audio-recorder-player",styles:[i(252)],i18nKeys:f})],_),e.CTCLAudioRecorderPlayer=_},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(13),c=i(5),l=i(254),d=i(6),h=i(4);let u=class extends a.CTCLComponent{constructor(){super(...arguments),this._initVideoElm=(t=>{this._videoElm=t,this._videoElm.onplay=this._onPlay,this._videoElm.onpause=this._onEndOrPause,this._videoElm.onended=this._onEndOrPause}),this._onPlay=(()=>{this.emitEvent(c.ChatEvents.MuteAlertToPlayOtherAudio)}),this._onEndOrPause=(()=>{this.emitEvent(c.ChatEvents.ResumeAlertAfterPlayingAudio)}),this._startRecording=(()=>{this.recording?(this.recording=!1,this._recorder.stop(),this._stopRecordingIndicator()):(this.recording=!0,this.showControls=!1,this._startRecordingIndicator(),this._recorder=new l.SimpleVideoRecorder(this._videoElm,this._onVideoRecordingFinished),this._recorder.start())}),this._onVideoRecordingFinished=(t=>{this.showControls=!0,this.source=t,this._videoElm.src=t,this._videoElm.muted=!1,this.onRecordingFinished&&this.onRecordingFinished(t)}),this._remove=(()=>{this.source="",this._videoElm.src="",this.showControls=!1,this.onVideoRemoved&&this.onVideoRemoved()}),this._startRecordingIndicator=(()=>{let t=!0;this._recordBtn&&(setTimeout(()=>this._recordBtn.classList.add("flash"),100),this._flashTimer=setInterval(()=>{t?this._recordBtn.classList.remove("flash"):this._recordBtn.classList.add("flash"),t=!t},500))}),this._stopRecordingIndicator=(()=>{clearInterval(this._flashTimer),this._recordBtn&&this._recordBtn.classList.remove("flash")})}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}disconnectedCallback(){super.disconnectedCallback(),this._videoElm.pause()}generateComponentMarkup(){const t=this.showRecord,e=this.allowRemoval&&""!==this.source;return window.__CTRender("div",{class:"container"},window.__CTRender("div",{class:"controls"},this.showRecord&&window.__CTRender("div",{class:`action ${t?"":"disabled"}`,ref:t=>this._recordBtn=t},window.__CTRender(h.CTIcon,{color:"red",width:"16",height:"16",icon:d.Icons.UI.CircleFilled,onClick:this._startRecording})),this.allowRemoval&&window.__CTRender("div",{class:`action ${e?"":"disabled"}`},window.__CTRender(h.CTIcon,{width:"16",height:"16",icon:d.Icons.UI.Cross,onClick:e?this._remove:null}))),window.__CTRender("div",{class:"player"},window.__CTRender("video",{ref:this._initVideoElm,width:320,height:240,controls:this.showControls,autoplay:this.autoplay,src:this.source})))}};n([s.prop({type:Boolean,attribute:!1,default:!0})],u.prototype,"showRecord",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],u.prototype,"allowRemoval",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],u.prototype,"recording",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],u.prototype,"showControls",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],u.prototype,"autoplay",void 0),n([s.prop({type:String,attribute:!1,default:""})],u.prototype,"source",void 0),n([s.prop({type:Function,attribute:!1,default:null})],u.prototype,"onVideoRemoved",void 0),n([s.prop({type:Function,attribute:!1,default:null})],u.prototype,"onRecordingFinished",void 0),u=n([r.component({tag:"ctcl-video-recorder-player",styles:[i(255)]})],u),e.CTCLVideoRecorderPlayer=u},function(t,e,i){"use strict";i.r(e);var n=i(69),o=i.n(n);e.default=function(t){const e=t.Strophe;return e.isTagEqual=function(t,e){return(t.tagName||t.node.tagName)===e},e.addConnectionPlugin("streamManagement",{logging:!0,returnWholeStanza:!1,autoSendCountOnEveryIncomingStanza:!1,requestResponseInterval:0,allowResume:!0,_c:null,_NS:"urn:xmpp:sm:3",_isStreamManagementEnabled:!1,_serverProcesssedStanzasCounter:null,_clientProcessedStanzasCounter:null,_clientSentStanzasCounter:null,_originalXMLOutput:null,_requestHandler:null,_incomingHandler:null,_requestResponseIntervalCount:0,_unacknowledgedStanzas:[],_acknowledgedStanzaListeners:[],_counters:{incoming:0,outgoing:0,server:0},addAcknowledgedStanzaListener:function(t){this._acknowledgedStanzaListeners.push(t)},enable:function(e){const i={xmlns:this._NS,resume:this.allowResume};if(e)try{i.max=""+e/1e3}catch(t){console.error(`Couldn't convert '${e}' to milliseconds:`,t)}this._c.send(t.$build("enable",i)),this._c.flush(),this._c.pause()},requestAcknowledgement:function(){this._requestResponseIntervalCount=0,this._c.send(t.$build("r",{xmlns:this._NS}))},getOutgoingCounter:function(){return this._counters.outgoing},getServerProcessedCounter:function(){return this._counters.server},getIncomingCounter:function(){return this._counters.incoming},init:function(t){this._c=t,e.addNamespace("SM",this._NS);const i=localStorage.getItem(this._c.options.instance_id+"_counters");if(null!==i){let e=null;try{e=JSON.parse(i)}catch(t){}null!==e&&(this._counters=e)}this._originalXMLOutput=this._c.xmlOutput,this._c.xmlOutput=this.xmlOutput.bind(this)},statusChanged:function(t,i){t!==e.Status.CONNECTED&&t!==e.Status.DISCONNECTED||(this._requestResponseIntervalCount=0,this._isStreamManagementEnabled=!1,t===e.Status.CONNECTED&&"resumed"!==i&&this._resetCounters(),t===e.Status.CONNECTED&&"resumed"===i&&(this._isStreamManagementEnabled=!0),this._unacknowledgedStanzas=[],this._requestHandler&&this._c.deleteHandler(this._requestHandler),this._incomingHandler&&this._c.deleteHandler(this._incomingHandler),this._requestHandler=this._c.addHandler(this._handleServerRequestHandler.bind(this),this._NS,"r"),this._incomingHandler=this._c.addHandler(this._incomingStanzaHandler.bind(this),null,null))},xmlOutput:function(t){function i(t){return e.isTagEqual(t,"iq")||e.isTagEqual(t,"presence")||e.isTagEqual(t,"message")}if(i(t))this._increaseSentStanzasCounter(t);else if(void 0!==t.children)for(var n,o=0;o<t.children.length;o++)n=t.children[o],i()&&this._increaseSentStanzasCounter(n);return this._originalXMLOutput.call(this._c,t)},_incomingStanzaHandler:function(t){if(e.isTagEqual(t,"enabled")&&t.getAttribute("xmlns")===this._NS&&(this._isStreamManagementEnabled=!0,this._c.resume()),(e.isTagEqual(t,"iq")||e.isTagEqual(t,"presence")||e.isTagEqual(t,"message"))&&(this._increaseReceivedStanzasCounter(),this.autoSendCountOnEveryIncomingStanza&&this._answerProcessedStanzas(),e.isTagEqual(t,"message")&&"error"===t.getAttribute("type")&&(this._counters.outgoing=this._counters.outgoing-1)),e.isTagEqual(t,"a")){var i=parseInt(t.getAttribute("h"));this._handleAcknowledgedStanzas(i,this._counters.server),this._counters.server=i,this._persistCounters(),this.requestResponseInterval>0&&(this._requestResponseIntervalCount=0)}return!0},_handleAcknowledgedStanzas:function(t,e){var i=t-e;i<0&&this._throwError("New reported stanza count lower than previous. New: "+t+" - Previous: "+e),i>this._unacknowledgedStanzas.length&&this._throwError("Higher reported acknowledge count than unacknowledged stanzas. Reported Acknowledge Count: "+i+" - Unacknowledge Stanza Count: "+this._unacknowledgedStanzas.length+" - New: "+t+" - Previous: "+e);for(var n=0;n<i;n++)for(var o=this._unacknowledgedStanzas.shift(),s=0;s<this._acknowledgedStanzaListeners.length;s++)this._acknowledgedStanzaListeners[s](o);this.logging&&this._unacknowledgedStanzas.length>0&&console.warn("Unacknowledged stanzas",this._unacknowledgedStanzas)},_handleServerRequestHandler:function(){return this._answerProcessedStanzas(),!0},_answerProcessedStanzas:function(e){(this._isStreamManagementEnabled||!0===e)&&this._c.send(t.$build("a",{xmlns:this._NS,h:this._counters.incoming}))},_increaseSentStanzasCounter:function(t){this._isStreamManagementEnabled&&(this._unacknowledgedStanzas.push(this.returnWholeStanza?t:t.getAttribute("id")),this._counters.outgoing++,this._persistCounters(),this.requestResponseInterval>0&&(this._requestResponseIntervalCount++,this._requestResponseIntervalCount===this.requestResponseInterval&&this.requestAcknowledgement()))},_increaseReceivedStanzasCounter:function(){this._isStreamManagementEnabled&&(this._counters.incoming++,this._persistCounters())},_persistCounters:function(){localStorage.setItem(this._c.options.instance_id+"_counters",JSON.stringify(this._counters))},_resetCounters:function(){this._counters={incoming:0,outgoing:0,server:0},this._persistCounters()},_throwError:function(t){console.error(t)}}),t}(o.a)},function(t,e,i){var n,o,s,r,a,c,l,d,h,u,p,g,m;n=function(){return t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",{encode:function(e){var i,n,o,s,r,a,c,l="",d=0;do{s=(i=e.charCodeAt(d++))>>2,r=(3&i)<<4|(n=e.charCodeAt(d++))>>4,a=(15&n)<<2|(o=e.charCodeAt(d++))>>6,c=63&o,isNaN(n)?(r=(3&i)<<4,a=c=64):isNaN(o)&&(c=64),l=l+t.charAt(s)+t.charAt(r)+t.charAt(a)+t.charAt(c)}while(d<e.length);return l},decode:function(e){var i,n,o,s,r,a,c="",l=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{i=t.indexOf(e.charAt(l++))<<2|(s=t.indexOf(e.charAt(l++)))>>4,n=(15&s)<<4|(r=t.indexOf(e.charAt(l++)))>>2,o=(3&r)<<6|(a=t.indexOf(e.charAt(l++))),c+=String.fromCharCode(i),64!=r&&(c+=String.fromCharCode(n)),64!=a&&(c+=String.fromCharCode(o))}while(l<e.length);return c}};var t}.call((o={id:"strophe-base64",exports:{},loaded:!1}).exports,i,o.exports,o),o.loaded=!0,void 0!==n||(n=o.exports),s=function(){return function(){function t(t,n){t[n>>5]|=128<<24-n%32,t[15+(n+64>>9<<4)]=n;var r,a,c,l,d,h,u,p,g=new Array(80),m=1732584193,f=-271733879,_=-1732584194,v=271733878,y=-1009589776;for(r=0;r<t.length;r+=16){for(l=m,d=f,h=_,u=v,p=y,a=0;a<80;a++)g[a]=a<16?t[r+a]:s(g[a-3]^g[a-8]^g[a-14]^g[a-16],1),c=o(o(s(m,5),e(a,f,_,v)),o(o(y,g[a]),i(a))),y=v,v=_,_=s(f,30),f=m,m=c;m=o(m,l),f=o(f,d),_=o(_,h),v=o(v,u),y=o(y,p)}return[m,f,_,v,y]}function e(t,e,i,n){return t<20?e&i|~e&n:t<40?e^i^n:t<60?e&i|e&n|i&n:e^i^n}function i(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function n(e,i){var n=r(e);n.length>16&&(n=t(n,8*e.length));for(var o=new Array(16),s=new Array(16),a=0;a<16;a++)o[a]=909522486^n[a],s[a]=1549556828^n[a];var c=t(o.concat(r(i)),512+8*i.length);return t(s.concat(c),672)}function o(t,e){var i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i}function s(t,e){return t<<e|t>>>32-e}function r(t){for(var e=[],i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<24-i%32;return e}function a(t){for(var e="",i=0;i<32*t.length;i+=8)e+=String.fromCharCode(t[i>>5]>>>24-i%32&255);return e}function c(t){for(var e,i,n="",o=0;o<4*t.length;o+=3)for(e=(t[o>>2]>>8*(3-o%4)&255)<<16|(t[o+1>>2]>>8*(3-(o+1)%4)&255)<<8|t[o+2>>2]>>8*(3-(o+2)%4)&255,i=0;i<4;i++)8*o+6*i>32*t.length?n+="=":n+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>6*(3-i)&63);return n}return{b64_hmac_sha1:function(t,e){return c(n(t,e))},b64_sha1:function(e){return c(t(r(e),8*e.length))},binb2str:a,core_hmac_sha1:n,str_hmac_sha1:function(t,e){return a(n(t,e))},str_sha1:function(e){return a(t(r(e),8*e.length))}}}()}.call((r={id:"strophe-sha1",exports:{},loaded:!1}).exports,i,r.exports,r),r.loaded=!0,void 0!==s||(s=r.exports),a=function(){return t=function(t,e){var i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i},e=function(t){for(var e=[],i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<i%32;return e},i=function(e,i,n,o,s,r){return t(function(t,e){return t<<s|t>>>32-s}(t(t(i,e),t(o,r))),n)},n=function(t,e,n,o,s,r,a){return i(e&n|~e&o,t,e,s,r,a)},o=function(t,e,n,o,s,r,a){return i(e&o|n&~o,t,e,s,r,a)},s=function(t,e,n,o,s,r,a){return i(e^n^o,t,e,s,r,a)},r=function(t,e,n,o,s,r,a){return i(n^(e|~o),t,e,s,r,a)},a=function(e,i){e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;for(var a,c,l,d,h=1732584193,u=-271733879,p=-1732584194,g=271733878,m=0;m<e.length;m+=16)a=h,c=u,l=p,d=g,h=n(h,u,p,g,e[m+0],7,-680876936),g=n(g,h,u,p,e[m+1],12,-389564586),p=n(p,g,h,u,e[m+2],17,606105819),u=n(u,p,g,h,e[m+3],22,-1044525330),h=n(h,u,p,g,e[m+4],7,-176418897),g=n(g,h,u,p,e[m+5],12,1200080426),p=n(p,g,h,u,e[m+6],17,-1473231341),u=n(u,p,g,h,e[m+7],22,-45705983),h=n(h,u,p,g,e[m+8],7,1770035416),g=n(g,h,u,p,e[m+9],12,-1958414417),p=n(p,g,h,u,e[m+10],17,-42063),u=n(u,p,g,h,e[m+11],22,-1990404162),h=n(h,u,p,g,e[m+12],7,1804603682),g=n(g,h,u,p,e[m+13],12,-40341101),p=n(p,g,h,u,e[m+14],17,-1502002290),u=n(u,p,g,h,e[m+15],22,1236535329),h=o(h,u,p,g,e[m+1],5,-165796510),g=o(g,h,u,p,e[m+6],9,-1069501632),p=o(p,g,h,u,e[m+11],14,643717713),u=o(u,p,g,h,e[m+0],20,-373897302),h=o(h,u,p,g,e[m+5],5,-701558691),g=o(g,h,u,p,e[m+10],9,38016083),p=o(p,g,h,u,e[m+15],14,-660478335),u=o(u,p,g,h,e[m+4],20,-405537848),h=o(h,u,p,g,e[m+9],5,568446438),g=o(g,h,u,p,e[m+14],9,-1019803690),p=o(p,g,h,u,e[m+3],14,-187363961),u=o(u,p,g,h,e[m+8],20,1163531501),h=o(h,u,p,g,e[m+13],5,-1444681467),g=o(g,h,u,p,e[m+2],9,-51403784),p=o(p,g,h,u,e[m+7],14,1735328473),u=o(u,p,g,h,e[m+12],20,-1926607734),h=s(h,u,p,g,e[m+5],4,-378558),g=s(g,h,u,p,e[m+8],11,-2022574463),p=s(p,g,h,u,e[m+11],16,1839030562),u=s(u,p,g,h,e[m+14],23,-35309556),h=s(h,u,p,g,e[m+1],4,-1530992060),g=s(g,h,u,p,e[m+4],11,1272893353),p=s(p,g,h,u,e[m+7],16,-155497632),u=s(u,p,g,h,e[m+10],23,-1094730640),h=s(h,u,p,g,e[m+13],4,681279174),g=s(g,h,u,p,e[m+0],11,-358537222),p=s(p,g,h,u,e[m+3],16,-722521979),u=s(u,p,g,h,e[m+6],23,76029189),h=s(h,u,p,g,e[m+9],4,-640364487),g=s(g,h,u,p,e[m+12],11,-421815835),p=s(p,g,h,u,e[m+15],16,530742520),u=s(u,p,g,h,e[m+2],23,-995338651),h=r(h,u,p,g,e[m+0],6,-198630844),g=r(g,h,u,p,e[m+7],10,1126891415),p=r(p,g,h,u,e[m+14],15,-1416354905),u=r(u,p,g,h,e[m+5],21,-57434055),h=r(h,u,p,g,e[m+12],6,1700485571),g=r(g,h,u,p,e[m+3],10,-1894986606),p=r(p,g,h,u,e[m+10],15,-1051523),u=r(u,p,g,h,e[m+1],21,-2054922799),h=r(h,u,p,g,e[m+8],6,1873313359),g=r(g,h,u,p,e[m+15],10,-30611744),p=r(p,g,h,u,e[m+6],15,-1560198380),u=r(u,p,g,h,e[m+13],21,1309151649),h=r(h,u,p,g,e[m+4],6,-145523070),g=r(g,h,u,p,e[m+11],10,-1120210379),p=r(p,g,h,u,e[m+2],15,718787259),u=r(u,p,g,h,e[m+9],21,-343485551),h=t(h,a),u=t(u,c),p=t(p,l),g=t(g,d);return[h,u,p,g]},{hexdigest:function(t){return function(t){for(var e="",i=0;i<4*t.length;i++)e+="0123456789abcdef".charAt(t[i>>2]>>i%4*8+4&15)+"0123456789abcdef".charAt(t[i>>2]>>i%4*8&15);return e}(a(e(t),8*t.length))},hash:function(t){return function(t){for(var e="",i=0;i<32*t.length;i+=8)e+=String.fromCharCode(t[i>>5]>>>i%32&255);return e}(a(e(t),8*t.length))}};var t,e,i,n,o,s,r,a}.call((c={id:"strophe-md5",exports:{},loaded:!1}).exports,i,c.exports,c),c.loaded=!0,void 0!==a||(a=c.exports),l=function(){return{utf16to8:function(t){var e,i,n="",o=t.length;for(e=0;e<o;e++)(i=t.charCodeAt(e))>=0&&i<=127?n+=t.charAt(e):i>2047?(n+=String.fromCharCode(224|i>>12&15),n+=String.fromCharCode(128|i>>6&63),n+=String.fromCharCode(128|i>>0&63)):(n+=String.fromCharCode(192|i>>6&31),n+=String.fromCharCode(128|i>>0&63));return n},addCookies:function(t){var e,i,n,o,s,r,a;for(e in t||{})s="",r="",a="",n="object"==typeof(i=t[e]),o=escape(unescape(n?i.value:i)),n&&(s=i.expires?";expires="+i.expires:"",r=i.domain?";domain="+i.domain:"",a=i.path?";path="+i.path:""),document.cookie=e+"="+o+s+r+a}}}.call((d={id:"strophe-utils",exports:{},loaded:!1}).exports,i,d.exports,d),d.loaded=!0,void 0!==l||(l=d.exports),h=function(){return Function.prototype.bind||(Function.prototype.bind=function(t){var e=this,i=Array.prototype.slice,n=Array.prototype.concat,o=i.call(arguments,1);return function(){return e.apply(t||this,n.call(o,i.call(arguments,0)))}}),Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),void(Array.prototype.indexOf||(Array.prototype.indexOf=function(t){var e=this.length,i=Number(arguments[1])||0;for((i=i<0?Math.ceil(i):Math.floor(i))<0&&(i+=e);i<e;i++)if(i in this&&this[i]===t)return i;return-1}))}.apply(e,[]),Array.prototype.forEach||(Array.prototype.forEach=function(t,e){var i,n;if(null===this)throw new TypeError(" this is null or not defined");var o=Object(this),s=o.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(arguments.length>1&&(i=e),n=0;n<s;){var r;n in o&&(r=o[n],t.call(i,r,n,o)),n++}}),u=function(){return function(t,e,i,n){var o;function s(t,e){return new o.Builder(t,e)}function r(t){return new o.Builder("iq",t)}function a(t){return new o.Builder("presence",t)}return(o={VERSION:"1.2.12",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(t){for(var e=0;e<o.XHTML.tags.length;e++)if(t==o.XHTML.tags[e])return!0;return!1},validAttribute:function(t,e){if(void 0!==o.XHTML.attributes[t]&&o.XHTML.attributes[t].length>0)for(var i=0;i<o.XHTML.attributes[t].length;i++)if(e==o.XHTML.attributes[t][i])return!0;return!1},validCSS:function(t){for(var e=0;e<o.XHTML.css.length;e++)if(t==o.XHTML.css[e])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(t,e){o.NS[t]=e},forEachChild:function(t,e,i){var n,s;for(n=0;n<t.childNodes.length;n++)(s=t.childNodes[n]).nodeType!=o.ElementType.NORMAL||e&&!this.isTagEqual(s,e)||i(s)},isTagEqual:function(t,e){return t.tagName==e},_xmlGenerator:null,_makeGenerator:function(){var t;return void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(t=this._getIEXmlDom()).appendChild(t.createElement("strophe")):t=document.implementation.createDocument("jabber:client","strophe",null),t},xmlGenerator:function(){return o._xmlGenerator||(o._xmlGenerator=o._makeGenerator()),o._xmlGenerator},_getIEXmlDom:function(){for(var t=null,e=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],i=0;i<e.length&&null===t;i++)try{t=new ActiveXObject(e[i])}catch(e){t=null}return t},xmlElement:function(t){if(!t)return null;var e,i,n,s=o.xmlGenerator().createElement(t);for(e=1;e<arguments.length;e++){var r=arguments[e];if(r)if("string"==typeof r||"number"==typeof r)s.appendChild(o.xmlTextNode(r));else if("object"==typeof r&&"function"==typeof r.sort)for(i=0;i<r.length;i++){var a=r[i];"object"==typeof a&&"function"==typeof a.sort&&void 0!==a[1]&&null!==a[1]&&s.setAttribute(a[0],a[1])}else if("object"==typeof r)for(n in r)r.hasOwnProperty(n)&&void 0!==r[n]&&null!==r[n]&&s.setAttribute(n,r[n])}return s},xmlescape:function(t){return(t=(t=(t=(t=t.replace(/\&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")},xmlunescape:function(t){return(t=(t=(t=(t=t.replace(/\&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&apos;/g,"'")).replace(/&quot;/g,'"')},xmlTextNode:function(t){return o.xmlGenerator().createTextNode(t)},xmlHtmlNode:function(t){var e;return window.DOMParser?e=(new DOMParser).parseFromString(t,"text/xml"):((e=new ActiveXObject("Microsoft.XMLDOM")).async="false",e.loadXML(t)),e},getText:function(t){if(!t)return null;var e="";0===t.childNodes.length&&t.nodeType==o.ElementType.TEXT&&(e+=t.nodeValue);for(var i=0;i<t.childNodes.length;i++)t.childNodes[i].nodeType==o.ElementType.TEXT&&(e+=t.childNodes[i].nodeValue);return o.xmlescape(e)},copyElement:function(t){var e,i;if(t.nodeType==o.ElementType.NORMAL){for(i=o.xmlElement(t.tagName),e=0;e<t.attributes.length;e++)i.setAttribute(t.attributes[e].nodeName,t.attributes[e].value);for(e=0;e<t.childNodes.length;e++)i.appendChild(o.copyElement(t.childNodes[e]))}else t.nodeType==o.ElementType.TEXT&&(i=o.xmlGenerator().createTextNode(t.nodeValue));return i},createHtml:function(t){var e,i,n,s,r,a,c,l,d,h,u;if(t.nodeType==o.ElementType.NORMAL)if(s=t.nodeName.toLowerCase(),o.XHTML.validTag(s))try{for(i=o.xmlElement(s),e=0;e<o.XHTML.attributes[s].length;e++)if(r=o.XHTML.attributes[s][e],void 0!==(a=t.getAttribute(r))&&null!==a&&""!==a&&!1!==a&&0!==a)if("style"==r&&"object"==typeof a&&void 0!==a.cssText&&(a=a.cssText),"style"==r){for(c=[],l=a.split(";"),n=0;n<l.length;n++)h=(d=l[n].split(":"))[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),o.XHTML.validCSS(h)&&(u=d[1].replace(/^\s*/,"").replace(/\s*$/,""),c.push(h+": "+u));c.length>0&&(a=c.join("; "),i.setAttribute(r,a))}else i.setAttribute(r,a);for(e=0;e<t.childNodes.length;e++)i.appendChild(o.createHtml(t.childNodes[e]))}catch(t){i=o.xmlTextNode("")}else for(i=o.xmlGenerator().createDocumentFragment(),e=0;e<t.childNodes.length;e++)i.appendChild(o.createHtml(t.childNodes[e]));else if(t.nodeType==o.ElementType.FRAGMENT)for(i=o.xmlGenerator().createDocumentFragment(),e=0;e<t.childNodes.length;e++)i.appendChild(o.createHtml(t.childNodes[e]));else t.nodeType==o.ElementType.TEXT&&(i=o.xmlTextNode(t.nodeValue));return i},escapeNode:function(t){return"string"!=typeof t?t:t.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(t){return"string"!=typeof t?t:t.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(t){return t.indexOf("@")<0?null:t.split("@")[0]},getDomainFromJid:function(t){var e=o.getBareJidFromJid(t);if(e.indexOf("@")<0)return e;var i=e.split("@");return i.splice(0,1),i.join("@")},getResourceFromJid:function(t){var e=t.split("/");return e.length<2?null:(e.splice(0,1),e.join("/"))},getBareJidFromJid:function(t){return t?t.split("/")[0]:null},_handleError:function(t){void 0!==t.stack&&o.fatal(t.stack),t.sourceURL?o.fatal("error: "+this.handler+" "+t.sourceURL+":"+t.line+" - "+t.name+": "+t.message):t.fileName?o.fatal("error: "+this.handler+" "+t.fileName+":"+t.lineNumber+" - "+t.name+": "+t.message):o.fatal("error: "+t.message)},log:function(t,e){},debug:function(t){this.log(this.LogLevel.DEBUG,t)},info:function(t){this.log(this.LogLevel.INFO,t)},warn:function(t){this.log(this.LogLevel.WARN,t)},error:function(t){this.log(this.LogLevel.ERROR,t)},fatal:function(t){this.log(this.LogLevel.FATAL,t)},serialize:function(t){var e;if(!t)return null;"function"==typeof t.tree&&(t=t.tree());var i,n,s=t.nodeName;for(t.getAttribute("_realname")&&(s=t.getAttribute("_realname")),e="<"+s,i=0;i<t.attributes.length;i++)"_realname"!=t.attributes[i].nodeName&&(e+=" "+t.attributes[i].nodeName+"='"+o.xmlescape(t.attributes[i].value)+"'");if(t.childNodes.length>0){for(e+=">",i=0;i<t.childNodes.length;i++)switch((n=t.childNodes[i]).nodeType){case o.ElementType.NORMAL:e+=o.serialize(n);break;case o.ElementType.TEXT:e+=o.xmlescape(n.nodeValue);break;case o.ElementType.CDATA:e+="<![CDATA["+n.nodeValue+"]]>"}e+="</"+s+">"}else e+="/>";return e},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(t,e){o._connectionPlugins[t]=e}}).Builder=function(t,e){"presence"!=t&&"message"!=t&&"iq"!=t||(e&&!e.xmlns?e.xmlns=o.NS.CLIENT:e||(e={xmlns:o.NS.CLIENT})),this.nodeTree=o.xmlElement(t,e),this.node=this.nodeTree},o.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return o.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(t){for(var e in t)t.hasOwnProperty(e)&&(void 0===t[e]?this.node.removeAttribute(e):this.node.setAttribute(e,t[e]));return this},c:function(t,e,i){var n=o.xmlElement(t,e,i);return this.node.appendChild(n),"string"!=typeof i&&"number"!=typeof i&&(this.node=n),this},cnode:function(t){var e,i=o.xmlGenerator();try{e=void 0!==i.importNode}catch(t){e=!1}var n=e?i.importNode(t,!0):o.copyElement(t);return this.node.appendChild(n),this.node=n,this},t:function(t){var e=o.xmlTextNode(t);return this.node.appendChild(e),this},h:function(t){var e=document.createElement("body");e.innerHTML=t;for(var i=o.createHtml(e);i.childNodes.length>0;)this.node.appendChild(i.childNodes[0]);return this}},o.Handler=function(t,e,i,n,s,r,a){this.handler=t,this.ns=e,this.name=i,this.type=n,this.id=s,this.options=a||{matchBareFromJid:!1,ignoreNamespaceFragment:!1},this.options.matchBare&&(o.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare),this.options.matchBareFromJid?this.from=r?o.getBareJidFromJid(r):null:this.from=r,this.user=!0},o.Handler.prototype={getNamespace:function(t){var e=t.getAttribute("xmlns");return e&&this.options.ignoreNamespaceFragment&&(e=e.split("#")[0]),e},namespaceMatch:function(t){var e=!1;if(!this.ns)return!0;var i=this;return o.forEachChild(t,null,function(t){i.getNamespace(t)===i.ns&&(e=!0)}),e=e||this.getNamespace(t)===this.ns},isMatch:function(t){var e=t.getAttribute("from");this.options.matchBareFromJid&&(e=o.getBareJidFromJid(e));var i=t.getAttribute("type");return!(!this.namespaceMatch(t)||this.name&&!o.isTagEqual(t,this.name)||this.type&&(Array.isArray(this.type)?-1==this.type.indexOf(i):i!=this.type)||this.id&&t.getAttribute("id")!=this.id||this.from&&e!=this.from)},run:function(t){var e=null;try{e=this.handler(t)}catch(t){throw o._handleError(t),t}return e},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},o.TimedHandler=function(t,e){this.period=t,this.handler=e,this.lastCalled=(new Date).getTime(),this.user=!0},o.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},o.Connection=function(t,e){this.service=t,this.options=e||{};var i=this.options.protocol||"";for(var s in 0===t.indexOf("ws:")||0===t.indexOf("wss:")||0===i.indexOf("ws")?this._proto=new o.Websocket(this):this._proto=new o.Bosh(this),this.jid="",this.domain=null,this.features=null,this._sasl_data={},this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.protocolErrorHandlers={HTTP:{},websocket:{}},this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.do_authentication=!0,this.paused=!1,this.restored=!1,this._data=[],this._uniqueId=0,this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100),n.addCookies(this.options.cookies),this.registerSASLMechanisms(this.options.mechanisms),o._connectionPlugins)if(o._connectionPlugins.hasOwnProperty(s)){var r=o._connectionPlugins[s],a=function(){};a.prototype=r,this[s]=new a,this[s].init(this)}},o.Connection.prototype={reset:function(){this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this.override=!1,this._data=[],this._requests=[],this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(t){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)});return"string"==typeof t||"number"==typeof t?e+":"+t:e+""},addProtocolErrorHandler:function(t,e,i){this.protocolErrorHandlers[t][e]=i},connect:function(t,e,i,n,s,r,a){this.jid=t,this.authzid=o.getBareJidFromJid(this.jid),this.authcid=a||o.getNodeFromJid(this.jid),this.pass=e,this.servtype="xmpp",this.connect_callback=i,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.domain=o.getDomainFromJid(this.jid),this._changeConnectStatus(o.Status.CONNECTING,null),this._proto._connect(n,s,r)},attach:function(t,e,i,n,s,r,a){if(!(this._proto instanceof o.Bosh))throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};this._proto._attach(t,e,i,n,s,r,a)},restore:function(t,e,i,n,o){if(!this._sessionCachingSupported())throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};this._proto._restore(t,e,i,n,o)},_sessionCachingSupported:function(){if(this._proto instanceof o.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_","_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(t){return!1}return!0}return!1},xmlInput:function(t){},xmlOutput:function(t){},rawInput:function(t){},rawOutput:function(t){},nextValidRid:function(t){},send:function(t){if(null!==t){if("function"==typeof t.sort)for(var e=0;e<t.length;e++)this._queueData(t[e]);else"function"==typeof t.tree?this._queueData(t.tree()):this._queueData(t);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendPresence:function(t,e,i,n){var o=null,s=this;"function"==typeof t.tree&&(t=t.tree());var r=t.getAttribute("id");if(r||(r=this.getUniqueId("sendPresence"),t.setAttribute("id",r)),"function"==typeof e||"function"==typeof i){var a=this.addHandler(function(t){o&&s.deleteTimedHandler(o),"error"==t.getAttribute("type")?i&&i(t):e&&e(t)},null,"presence",null,r);n&&(o=this.addTimedHandler(n,function(){return s.deleteHandler(a),i&&i(null),!1}))}return this.send(t),r},sendIQ:function(t,e,i,n){var o=null,s=this;"function"==typeof t.tree&&(t=t.tree());var r=t.getAttribute("id");if(r||(r=this.getUniqueId("sendIQ"),t.setAttribute("id",r)),"function"==typeof e||"function"==typeof i){var a=this.addHandler(function(t){o&&s.deleteTimedHandler(o);var n=t.getAttribute("type");if("result"==n)e&&e(t);else{if("error"!=n)throw{name:"StropheError",message:"Got bad IQ type of "+n};i&&i(t)}},null,"iq",["error","result"],r);n&&(o=this.addTimedHandler(n,function(){return s.deleteHandler(a),i&&i(null),!1}))}return this.send(t),r},_queueData:function(t){if(null===t||!t.tagName||!t.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(t)},_sendRestart:function(){this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(t,e){var i=new o.TimedHandler(t,e);return this.addTimeds.push(i),i},deleteTimedHandler:function(t){this.removeTimeds.push(t)},addHandler:function(t,e,i,n,s,r,a){var c=new o.Handler(t,e,i,n,s,r,a);return this.addHandlers.push(c),c},deleteHandler:function(t){this.removeHandlers.push(t);var e=this.addHandlers.indexOf(t);e>=0&&this.addHandlers.splice(e,1)},registerSASLMechanisms:function(t){this.mechanisms={},(t=t||[o.SASLAnonymous,o.SASLExternal,o.SASLMD5,o.SASLOAuthBearer,o.SASLPlain,o.SASLSHA1]).forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(t){this.mechanisms[t.prototype.name]=t},disconnect:function(t,e){if(o.info("Disconnect was called because: "+t),this.connected){this._changeConnectStatus(o.Status.DISCONNECTING,t);var i=!1;this.disconnecting=!0,this.authenticated&&(i=a({xmlns:o.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(i,e)}else o.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect(t)},_changeConnectStatus:function(t,e){for(var i in o._connectionPlugins)if(o._connectionPlugins.hasOwnProperty(i)){var n=this[i];if(n.statusChanged)try{n.statusChanged(t,e)}catch(t){o.error(i+" plugin caused an exception changing status: "+t)}}if(this.connect_callback)try{this.connect_callback(t,e)}catch(t){o._handleError(t),o.error("User connection callback caused an exception: "+t)}},_doDisconnect:function(t){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),o.info("_doDisconnect was called"),this._proto._doDisconnect(),this.authenticated=!1,this.disconnecting=!1,this.restored=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(o.Status.DISCONNECTED,t),this.connected=!1},_dataRecv:function(t,e){o.info("_dataRecv called");var i=this._proto._reqToData(t);if(null!==i){var n,s;for(this.xmlInput!==o.Connection.prototype.xmlInput&&(i.nodeName===this._proto.strip&&i.childNodes.length?this.xmlInput(i.childNodes[0]):this.xmlInput(i)),this.rawInput!==o.Connection.prototype.rawInput&&(e?this.rawInput(e):this.rawInput(o.serialize(i)));this.removeHandlers.length>0;)s=this.removeHandlers.pop(),(n=this.handlers.indexOf(s))>=0&&this.handlers.splice(n,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else{var r,a,c=i.getAttribute("type");if(null!==c&&"terminate"==c){if(this.disconnecting)return;return r=i.getAttribute("condition"),a=i.getElementsByTagName("conflict"),null!==r?("remote-stream-error"==r&&a.length>0&&(r="conflict"),this._changeConnectStatus(o.Status.CONNFAIL,r)):this._changeConnectStatus(o.Status.CONNFAIL,"unknown"),void this._doDisconnect(r)}var l=this;o.forEachChild(i,null,function(t){var e,i;for(i=l.handlers,l.handlers=[],e=0;e<i.length;e++){var n=i[e];try{!n.isMatch(t)||!l.authenticated&&n.user?l.handlers.push(n):n.run(t)&&l.handlers.push(n)}catch(t){o.warn("Removing Strophe handlers due to uncaught exception: "+t.message)}}})}}},mechanisms:{},_connect_cb:function(t,e,i){var n;o.info("_connect_cb was called"),this.connected=!0;try{n=this._proto._reqToData(t)}catch(t){if("badformat"!=t)throw t;this._changeConnectStatus(o.Status.CONNFAIL,"bad-format"),this._doDisconnect("bad-format")}if(n&&(this.xmlInput!==o.Connection.prototype.xmlInput&&(n.nodeName===this._proto.strip&&n.childNodes.length?this.xmlInput(n.childNodes[0]):this.xmlInput(n)),this.rawInput!==o.Connection.prototype.rawInput&&(i?this.rawInput(i):this.rawInput(o.serialize(n))),this._proto._connect_cb(n)!==o.Status.CONNFAIL))if(n.getElementsByTagNameNS?n.getElementsByTagNameNS(o.NS.STREAM,"features").length>0:n.getElementsByTagName("stream:features").length>0||n.getElementsByTagName("features").length>0){var s,r,a=[],c=n.getElementsByTagName("mechanism");if(c.length>0)for(s=0;s<c.length;s++)r=o.getText(c[s]),this.mechanisms[r]&&a.push(this.mechanisms[r]);0!==a.length||0!==n.getElementsByTagName("auth").length?!1!==this.do_authentication&&this.authenticate(a):this._proto._no_auth_received(e)}else this._proto._no_auth_received(e)},sortMechanismsByPriority:function(t){var e,i,n,o;for(e=0;e<t.length-1;++e){for(n=e,i=e+1;i<t.length;++i)t[i].prototype.priority>t[n].prototype.priority&&(n=i);n!=e&&(o=t[e],t[e]=t[n],t[n]=o)}return t},_attemptSASLAuth:function(t){t=this.sortMechanismsByPriority(t||[]);var i=0,n=!1;for(i=0;i<t.length;++i)if(t[i].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null),this._sasl_mechanism=new t[i],this._sasl_mechanism.onStart(this);var r=s("auth",{xmlns:o.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var a=this._sasl_mechanism.onChallenge(this,null);r.t(e.encode(a))}this.send(r.tree()),n=!0;break}return n},_attemptLegacyAuth:function(){null===o.getNodeFromJid(this.jid)?(this._changeConnectStatus(o.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(o.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(r({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:o.NS.AUTH}).c("username",{}).t(o.getNodeFromJid(this.jid)).tree()))},authenticate:function(t){this._attemptSASLAuth(t)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(t){var i=e.decode(o.getText(t)),n=this._sasl_mechanism.onChallenge(this,i),r=s("response",{xmlns:o.NS.SASL});return""!==n&&r.t(e.encode(n)),this.send(r.tree()),!0},_auth1_cb:function(t){var e=r({type:"set",id:"_auth_2"}).c("query",{xmlns:o.NS.AUTH}).c("username",{}).t(o.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return o.getResourceFromJid(this.jid)||(this.jid=o.getBareJidFromJid(this.jid)+"/strophe"),e.up().c("resource",{}).t(o.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(e.tree()),!1},_sasl_success_cb:function(t){if(this._sasl_data["server-signature"]){var i,n=e.decode(o.getText(t)).match(/([a-z]+)=([^,]+)(,|$)/);if("v"==n[1]&&(i=n[2]),i!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}o.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var s=[],r=function(t,e){for(;t.length;)this.deleteHandler(t.pop());return this._sasl_auth1_cb.bind(this)(e),!1};return s.push(this._addSysHandler(function(t){r.bind(this)(s,t)}.bind(this),null,"stream:features",null,null)),s.push(this._addSysHandler(function(t){r.bind(this)(s,t)}.bind(this),o.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(t){var e,i;for(this.features=t,e=0;e<t.childNodes.length;e++)"bind"==(i=t.childNodes[e]).nodeName&&(this.do_bind=!0),"session"==i.nodeName&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(o.Status.AUTHFAIL,null),!1;var n=this,a=function(){n._addSysHandler(n._sasl_bind_cb.bind(n),null,null,null,"_bind_auth_2"),n.override&&(n.send(r({type:"set",id:"_override_1"}).c("override",{xmlns:"urn:commontime:infinity:bind","resource-conflict":"closeold"}).tree()),n.override=!1);var t=o.getResourceFromJid(n.jid);t?n.send(r({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:o.NS.BIND}).c("resource",{}).t(t).tree()):n.send(r({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:o.NS.BIND}).tree())};return void 0!==this.streamManagement&&void 0!==this.streamManagement.prevId?(this._addSysHandler(function(){return n.authenticated=!0,n._changeConnectStatus(o.Status.CONNECTED,"resumed"),!1},"urn:xmpp:sm:3","resumed"),this._addSysHandler(function(){return a(),!1},"urn:xmpp:sm:3","failed"),this.send(s("resume",{xmlns:"urn:xmpp:sm:3",previd:this.streamManagement.prevId,h:this.streamManagement.getIncomingCounter()||0}))):a(),!1},_sasl_bind_cb:function(t){var e;if("error"==t.getAttribute("type"))return o.info("SASL binding failed."),t.getElementsByTagName("conflict").length>0&&(e="conflict",this._doDisconnect(e)),this._changeConnectStatus(o.Status.AUTHFAIL,e),!1;var i,n=t.getElementsByTagName("bind");if(!(n.length>0))return o.info("SASL binding failed."),this._changeConnectStatus(o.Status.AUTHFAIL,null),!1;(i=n[0].getElementsByTagName("jid")).length>0&&(this.jid=o.getText(i[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(r({type:"set",id:"_session_auth_2"}).c("session",{xmlns:o.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(o.Status.CONNECTED,null)))},_sasl_session_cb:function(t){if("result"==t.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(o.Status.CONNECTED,null);else if("error"==t.getAttribute("type"))return o.info("Session creation failed."),this._changeConnectStatus(o.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(t){this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure();const e=t.getElementsByTagName("text")[0];let i=null;return void 0!==e&&(i=e.innerHTML||null),this._changeConnectStatus(o.Status.AUTHFAIL,i),this.disconnect(i),!1},_auth2_cb:function(t){return"result"==t.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(o.Status.CONNECTED,null)):"error"==t.getAttribute("type")&&(this._changeConnectStatus(o.Status.AUTHFAIL,null),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(t,e){var i=new o.TimedHandler(t,e);return i.user=!1,this.addTimeds.push(i),i},_addSysHandler:function(t,e,i,n,s){var r=new o.Handler(t,e,i,n,s);return r.user=!1,this.addHandlers.push(r),r},_onDisconnectTimeout:function(){return o.info("_onDisconnectTimeout was called"),this._changeConnectStatus(o.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var t,e,i;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)e=this.removeTimeds.pop(),(t=this.timedHandlers.indexOf(e))>=0&&this.timedHandlers.splice(t,1);var n=(new Date).getTime();for(i=[],t=0;t<this.timedHandlers.length;t++)e=this.timedHandlers[t],!this.authenticated&&e.user||(e.lastCalled+e.period-n<=0?e.run()&&i.push(e):i.push(e));this.timedHandlers=i,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),1e3))}},o.SASLMechanism=function(t,e,i){this.name=t,this.isClientFirst=e,this.priority=i},o.SASLMechanism.prototype={test:function(t){return!0},onStart:function(t){this._connection=t},onChallenge:function(t,e){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},o.SASLAnonymous=function(){},o.SASLAnonymous.prototype=new o.SASLMechanism("ANONYMOUS",!1,20),o.SASLAnonymous.prototype.test=function(t){return null===t.authcid},o.SASLPlain=function(){},o.SASLPlain.prototype=new o.SASLMechanism("PLAIN",!0,30),o.SASLPlain.prototype.test=function(t){return null!==t.authcid},o.SASLPlain.prototype.onChallenge=function(t){var e=t.authzid;return e+="\0",e+=t.authcid,e+="\0",e+=t.pass,n.utf16to8(e)},o.SASLSHA1=function(){},o.SASLSHA1.prototype=new o.SASLMechanism("SCRAM-SHA-1",!0,50),o.SASLSHA1.prototype.test=function(t){return null!==t.authcid},o.SASLSHA1.prototype.onChallenge=function(o,s,r){var a=r||i.hexdigest(1234567890*Math.random()),c="n="+n.utf16to8(o.authcid);return c+=",r=",c+=a,o._sasl_data.cnonce=a,o._sasl_data["client-first-message-bare"]=c,c="n,,"+c,this.onChallenge=function(i,o){for(var s,r,a,c,l,d,h,u,p,g,m,f,_="c=biws,",v=i._sasl_data["client-first-message-bare"]+","+o+",",y=i._sasl_data.cnonce,C=/([a-z]+)=([^,]+)(,|$)/;o.match(C);){var b=o.match(C);switch(o=o.replace(b[0],""),b[1]){case"r":s=b[2];break;case"s":r=b[2];break;case"i":a=b[2]}}if(s.substr(0,y.length)!==y)return i._sasl_data={},i._sasl_failure_cb();for(v+=_+="r="+s,r=e.decode(r),r+="\0\0\0",p=n.utf16to8(i.pass),c=d=t.core_hmac_sha1(p,r),h=1;h<a;h++){for(l=t.core_hmac_sha1(p,t.binb2str(d)),u=0;u<5;u++)c[u]^=l[u];d=l}for(c=t.binb2str(c),g=t.core_hmac_sha1(c,"Client Key"),m=t.str_hmac_sha1(c,"Server Key"),f=t.core_hmac_sha1(t.str_sha1(t.binb2str(g)),v),i._sasl_data["server-signature"]=t.b64_hmac_sha1(m,v),u=0;u<5;u++)g[u]^=f[u];return _+",p="+e.encode(t.binb2str(g))}.bind(this),c},o.SASLMD5=function(){},o.SASLMD5.prototype=new o.SASLMechanism("DIGEST-MD5",!1,40),o.SASLMD5.prototype.test=function(t){return null!==t.authcid},o.SASLMD5.prototype._quote=function(t){return'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},o.SASLMD5.prototype.onChallenge=function(t,e,o){for(var s,r=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,a=o||i.hexdigest(""+1234567890*Math.random()),c="",l=null,d="";e.match(r);)switch(s=e.match(r),e=e.replace(s[0],""),s[2]=s[2].replace(/^"(.+)"$/,"$1"),s[1]){case"realm":c=s[2];break;case"nonce":d=s[2];break;case"qop":s[2];break;case"host":l=s[2]}var h=t.servtype+"/"+t.domain;null!==l&&(h=h+"/"+l);var u=n.utf16to8(t.authcid+":"+c+":"+this._connection.pass),p=i.hash(u)+":"+d+":"+a,g="AUTHENTICATE:"+h,m="";return m+="charset=utf-8,",m+="username="+this._quote(n.utf16to8(t.authcid))+",",m+="realm="+this._quote(c)+",",m+="nonce="+this._quote(d)+",",m+="nc=00000001,",m+="cnonce="+this._quote(a)+",",m+="digest-uri="+this._quote(h)+",",m+="response="+i.hexdigest(i.hexdigest(p)+":"+d+":00000001:"+a+":auth:"+i.hexdigest(g))+",",m+="qop=auth",this.onChallenge=function(){return""},m},o.SASLOAuthBearer=function(){},o.SASLOAuthBearer.prototype=new o.SASLMechanism("OAUTHBEARER",!0,60),o.SASLOAuthBearer.prototype.test=function(t){return null!==t.authcid},o.SASLOAuthBearer.prototype.onChallenge=function(t){var e="n,a=";return e+=t.authzid,e+=",",e+="",e+="auth=Bearer ",e+=t.pass,e+="",e+="",n.utf16to8(e)},o.SASLExternal=function(){},o.SASLExternal.prototype=new o.SASLMechanism("EXTERNAL",!0,10),o.SASLExternal.prototype.onChallenge=function(t){return t.authcid===t.authzid?"":t.authzid},{Strophe:o,$build:s,$msg:function(t){return new o.Builder("message",t)},$iq:r,$pres:a,SHA1:t,Base64:e,MD5:i}}.apply(this,arguments)}.apply(e,[s,n,a,l,h]),p=function(t){return function(t,e){return t.Request=function(e,i,n,o){this.id=++t._requestId,this.xmlData=e,this.data=t.serialize(e),this.origFunc=i,this.func=i,this.rid=n,this.date=NaN,this.sends=o||0,this.abort=!1,this.dead=null,this.age=function(){return this.date?(new Date-this.date)/1e3:0},this.timeDead=function(){return this.dead?(new Date-this.dead)/1e3:0},this.xhr=this._newXHR()},t.Request.prototype={getResponse:function(){var e=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if("parsererror"==(e=this.xhr.responseXML.documentElement).tagName)throw t.error("invalid response received"),t.error("responseText: "+this.xhr.responseText),t.error("responseXML: "+t.serialize(this.xhr.responseXML)),"parsererror"}else if(this.xhr.responseText)throw t.error("invalid response received"),t.error("responseText: "+this.xhr.responseText),"badformat";return e},_newXHR:function(){var t=null;return window.XMLHttpRequest?(t=new XMLHttpRequest).overrideMimeType&&t.overrideMimeType("text/xml; charset=utf-8"):window.ActiveXObject&&(t=new ActiveXObject("Microsoft.XMLHTTP")),t.onreadystatechange=this.func.bind(null,this),t}},t.Bosh=function(t){this._conn=t,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this.inactivity=null,this._requests=[]},t.Bosh.prototype={strip:null,_buildBody:function(){var i=e("body",{rid:this.rid++,xmlns:t.NS.HTTPBIND});return null!==this.sid&&i.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),i},_reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_connect:function(e,i,n){this.wait=e||this.wait,this.hold=i||this.hold,this.errors=0;var o=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":t.NS.BOSH});n&&o.attrs({route:n});var s=this._conn._connect_cb;this._requests.push(new t.Request(o.tree(),this._onRequestStateChange.bind(this,s.bind(this._conn)),o.tree().getAttribute("rid"))),this._throttledRequestHandler()},_attach:function(e,i,n,o,s,r,a){this._conn.jid=e,this.sid=i,this.rid=n,this._conn.connect_callback=o,this._conn.domain=t.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=s||this.wait,this.hold=r||this.hold,this.window=a||this.window,this._conn._changeConnectStatus(t.Status.ATTACHED,null)},_restore:function(e,i,n,o,s){var r=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!(null!=r&&r.rid&&r.sid&&r.jid&&(null==e||t.getBareJidFromJid(r.jid)==t.getBareJidFromJid(e)||null===t.getNodeFromJid(e)&&t.getDomainFromJid(r.jid)==e)))throw{name:"StropheSessionError",message:"_restore: no restoreable session."};this._conn.restored=!0,this._attach(r.jid,r.sid,r.rid,i,n,o,s)},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(e){var i,n,o=e.getAttribute("type");if(null!==o&&"terminate"==o)return i=e.getAttribute("condition"),t.error("BOSH-Connection failed: "+i),n=e.getElementsByTagName("conflict"),null!==i?("remote-stream-error"==i&&n.length>0&&(i="conflict"),this._conn._changeConnectStatus(t.Status.CONNFAIL,i)):this._conn._changeConnectStatus(t.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(i),t.Status.CONNFAIL;this.sid||(this.sid=e.getAttribute("sid"));var s=e.getAttribute("requests");s&&(this.window=parseInt(s,10));var r=e.getAttribute("hold");r&&(this.hold=parseInt(r,10));var a=e.getAttribute("wait");a&&(this.wait=parseInt(a,10));var c=e.getAttribute("inactivity");c&&(this.inactivity=parseInt(c,10))},_disconnect:function(t){this._sendTerminate(t)},_doDisconnect:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_callProtocolErrorHandlers:function(t){var e,i=this._getRequestStatus(t);(e=this._conn.protocolErrorHandlers.HTTP[i])&&e.call(this,i)},_hitError:function(e){this.errors++,t.warn("request errored, status: "+e+", number of errors: "+this.errors),this.errors>4&&this._conn._onDisconnectTimeout()},_no_auth_received:function(e){e=e?e.bind(this._conn):this._conn._connect_cb.bind(this._conn);var i=this._buildBody();this._requests.push(new t.Request(i.tree(),this._onRequestStateChange.bind(this,e.bind(this._conn)),i.tree().getAttribute("rid"))),this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var t;this._requests.length>0;)(t=this._requests.pop()).abort=!0,t.xhr.abort(),t.xhr.onreadystatechange=function(){}},_onIdle:function(){var e=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===e.length&&!this._conn.disconnecting&&(t.info("no requests during idle cycle, sending blank request"),e.push(null)),!this._conn.paused){if(this._requests.length<2&&e.length>0){for(var i=this._buildBody(),n=0;n<e.length;n++)null!==e[n]&&("restart"===e[n]?i.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":t.NS.BOSH}):i.cnode(e[n]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new t.Request(i.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),i.tree().getAttribute("rid"))),this._throttledRequestHandler()}if(this._requests.length>0){var o=this._requests[0].age();null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(t.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),o>Math.floor(t.TIMEOUT*this.wait)&&(t.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(t.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())}}},_getRequestStatus:function(e,i){var n;if(4==e.xhr.readyState)try{n=e.xhr.status}catch(e){t.error("Caught an error while retrieving a request's status, reqStatus: "+n)}return void 0===n&&(n="number"==typeof i?i:0),n},_onRequestStateChange:function(e,i){if(t.debug("request id "+i.id+"."+i.sends+" state changed to "+i.xhr.readyState),i.abort)i.abort=!1;else if(4===i.xhr.readyState){var n=this._getRequestStatus(i);if(this.disconnecting&&n>=400)return this._hitError(n),void this._callProtocolErrorHandlers(i);if((n>0&&n<500||i.sends>5)&&(this._removeRequest(i),t.debug("request id "+i.id+" should now be removed")),200==n){var o=this._requests[0]==i;(this._requests[1]==i||o&&this._requests.length>0&&this._requests[0].age()>Math.floor(t.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(i.rid)+1),t.debug("request id "+i.id+"."+i.sends+" got 200"),e(i),this.errors=0}else 0===n||n>=400&&n<600||n>=12e3?(t.error("request id "+i.id+"."+i.sends+" error "+n+" happened"),this._hitError(n),this._callProtocolErrorHandlers(i),n>=400&&n<500&&(this._conn._changeConnectStatus(t.Status.DISCONNECTING,null),this._conn._doDisconnect())):t.error("request id "+i.id+"."+i.sends+" error "+n+" happened");n>0&&n<500&&!(i.sends>5)||this._throttledRequestHandler()}},_processRequest:function(e){var i=this,n=this._requests[e],o=this._getRequestStatus(n,-1);if(n.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var s=n.age(),r=!isNaN(s)&&s>Math.floor(t.TIMEOUT*this.wait),a=null!==n.dead&&n.timeDead()>Math.floor(t.SECONDARY_TIMEOUT*this.wait),c=4==n.xhr.readyState&&(o<1||o>=500);if((r||a||c)&&(a&&t.error("Request "+this._requests[e].id+" timed out (secondary), restarting"),n.abort=!0,n.xhr.abort(),n.xhr.onreadystatechange=function(){},this._requests[e]=new t.Request(n.xmlData,n.origFunc,n.rid,n.sends),n=this._requests[e]),0===n.xhr.readyState){t.debug("request id "+n.id+"."+n.sends+" posting");try{var l=this._conn.options.contentType||"text/xml; charset=utf-8";n.xhr.open("POST",this._conn.service,!this._conn.options.sync),void 0!==n.xhr.setRequestHeader&&n.xhr.setRequestHeader("Content-Type",l),this._conn.options.withCredentials&&(n.xhr.withCredentials=!0)}catch(e){return t.error("XHR open failed."),this._conn.connected||this._conn._changeConnectStatus(t.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}var d=function(){if(n.date=new Date,i._conn.options.customHeaders){var t=i._conn.options.customHeaders;for(var e in t)t.hasOwnProperty(e)&&n.xhr.setRequestHeader(e,t[e])}n.xhr.send(n.data)};if(n.sends>1){var h=1e3*Math.min(Math.floor(t.TIMEOUT*this.wait),Math.pow(n.sends,3));setTimeout(function(){d()},h)}else d();n.sends++,this._conn.xmlOutput!==t.Connection.prototype.xmlOutput&&(n.xmlData.nodeName===this.strip&&n.xmlData.childNodes.length?this._conn.xmlOutput(n.xmlData.childNodes[0]):this._conn.xmlOutput(n.xmlData)),this._conn.rawOutput!==t.Connection.prototype.rawOutput&&this._conn.rawOutput(n.data)}else t.debug("_processRequest: "+(0===e?"first":"second")+" request has readyState of "+n.xhr.readyState)}},_removeRequest:function(e){var i;for(t.debug("removing request"),i=this._requests.length-1;i>=0;i--)e==this._requests[i]&&this._requests.splice(i,1);e.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(t){var e=this._requests[t];null===e.dead&&(e.dead=new Date),this._processRequest(t)},_reqToData:function(t){try{return t.getResponse()}catch(t){if("parsererror"!=t)throw t;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(e){t.info("_sendTerminate was called");var i=this._buildBody().attrs({type:"terminate"});e&&i.cnode(e.tree());var n=new t.Request(i.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),i.tree().getAttribute("rid"));this._requests.push(n),this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?t.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):t.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},t}(t.Strophe,t.$build)}.apply(e,[u]),g=function(t){return function(t,e){return t.Websocket=function(t){this._conn=t,this.strip="wrapper";var e=t.service;if(0!==e.indexOf("ws:")&&0!==e.indexOf("wss:")){var i="";"ws"===t.options.protocol&&"https:"!==window.location.protocol?i+="ws":i+="wss",i+="://"+window.location.host,0!==e.indexOf("/")?i+=window.location.pathname+e:i+=e,t.service=i}},t.Websocket.prototype={_buildStream:function(){return e("open",{xmlns:t.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(e,i){var n;if(0===(n=e.getElementsByTagNameNS?e.getElementsByTagNameNS(t.NS.STREAM,"error"):e.getElementsByTagName("stream:error")).length)return!1;for(var o=n[0],s="",r=0;r<o.childNodes.length;r++){var a=o.childNodes[r];if("urn:ietf:params:xml:ns:xmpp-streams"!==a.getAttribute("xmlns"))break;s="text"===a.nodeName?a.textContent:a.nodeName}var c="WebSocket stream error: ";return c+=s||"unknown",t.error(c),this._conn._changeConnectStatus(i,s),this._conn._doDisconnect(),!0},_reset:function(){},_connect:function(){this._closeSocket(),this.socket=new WebSocket(this._conn.service,"xmpp"),this.socket.onopen=this._onOpen.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(e){if(this._check_streamerror(e,t.Status.CONNFAIL))return t.Status.CONNFAIL},_handleStreamStart:function(e){var i=!1,n=e.getAttribute("xmlns");"string"!=typeof n?i="Missing xmlns in <open />":n!==t.NS.FRAMING&&(i="Wrong xmlns in <open />: "+n);var o=e.getAttribute("version");return"string"!=typeof o?i="Missing version in <open />":"1.0"!==o&&(i="Wrong version in <open />: "+o),!i||(this._conn._changeConnectStatus(t.Status.CONNFAIL,i),this._conn._doDisconnect(),!1)},_connect_cb_wrapper:function(e){if(0===e.data.indexOf("<open ")||0===e.data.indexOf("<?xml")){var i=e.data.replace(/^(<\?.*?\?>\s*)*/,"");if(""===i)return;var n=(new DOMParser).parseFromString(i,"text/xml").documentElement;this._conn.xmlInput(n),this._conn.rawInput(e.data),this._handleStreamStart(n)&&this._connect_cb(n)}else if(0===e.data.indexOf("<close ")){this._conn.rawInput(e.data),this._conn.xmlInput(e);var o=e.getAttribute("see-other-uri");o?(this._conn._changeConnectStatus(t.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=o,this._connect()):(this._conn._changeConnectStatus(t.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())}else{var s=this._streamWrap(e.data),r=(new DOMParser).parseFromString(s,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(r,null,e.data)}},_disconnect:function(i,n){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED&&(i&&this._conn.send(i),!0!==n)){var o=e("close",{xmlns:t.NS.FRAMING});this._conn.xmlOutput(o);var s=t.serialize(o);this._conn.rawOutput(s);try{this.socket.send(s)}catch(e){t.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){t.info("WebSockets _doDisconnect was called"),this._closeSocket()},_streamWrap:function(t){return"<wrapper>"+t+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(t){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(e){this._conn.connected&&!this._conn.disconnecting?(t.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):e&&1006===e.code&&!this._conn.connected&&this.socket?(t.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(t.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):t.info("Websocket closed")},_no_auth_received:function(e){t.error("Server did not send any auth methods"),this._conn._changeConnectStatus(t.Status.CONNFAIL,"Server did not send any auth methods"),e&&(e=e.bind(this._conn))(),this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(e){t.error("Websocket error "+e),this._conn._changeConnectStatus(t.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._disconnect()},_onIdle:function(){if(null!==this.socket){var e=this._conn._data;if(e.length>0&&!this._conn.paused){for(var i=0;i<e.length;i++){var n,o;null!==e[i]&&(n="restart"===e[i]?this._buildStream().tree():e[i],o=t.serialize(n),this._conn.xmlOutput(n),this._conn.rawOutput(o),this.socket.send(o))}this._conn._data=[]}}},_onMessage:function(e){var i,n,o='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(e.data===o)return this._conn.rawInput(o),this._conn.xmlInput(e),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===e.data.search("<open ")){if(i=(new DOMParser).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(i))return}else n=this._streamWrap(e.data),i=(new DOMParser).parseFromString(n,"text/xml").documentElement;return this._check_streamerror(i,t.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===i.firstChild.nodeName&&"unavailable"===i.firstChild.getAttribute("type")?(this._conn.xmlInput(i),void this._conn.rawInput(t.serialize(i))):void this._conn._dataRecv(i,e.data)},_onOpen:function(){t.info("Websocket open");var e=this._buildStream();this._conn.xmlOutput(e.tree());var i=t.serialize(e);this._conn.rawOutput(i),this.socket.send(i)},_reqToData:function(t){return t},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.bind(this._conn)()}},t}(t.Strophe,t.$build)}.apply(e,[u]),void 0===(m=function(t){return t}.apply(e,[u,p,g]))||(t.exports=m)},function(t,e,i){t.exports=i(71)},function(t,e,i){"use strict";function n(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}Object.defineProperty(e,"__esModule",{value:!0}),n(i(72)),n(i(303))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(1),s=i(26),r=i(17),a=i(0),c=i(10),l=i(143),d=i(15),h=i(5),u=i(8),p=i(59),g=i(170),m=i(171),f=i(6),_=i(300),v=i(20),y=i(2),C=i(302);class b extends o.BaseLayer{constructor(t,e,i){if(super(t,e),this.VERSION="1.0.0",this.bootstrapper=null,this._allConversations=null,this._currentConversation=null,this._conversationsBeingPurged=[],this._pendingConversationAlerts=[],this._isFetchingChatEntries=!1,this.name=t,this.config=this._checkConfigForPreferences(e),!this.config.xmpp)throw new Error("What are you doing not specifying XMPP configuration?");this.config.xmpp.mam&&(this.config.xmpp.mam.autoFetch=!1),this.config.xmpp.updateUserDirectoryOnLogin=!0,this.config.xmpp.bringToForegroundOnVoipPush=!1;const o=i&&i.store||new _.Store(t,this.logger,e),s=i&&i.comms||new l.Comms(t,e.xmpp,o,this.logger,this);this.bootstrapper=this.bootstrap(s,o),this.bootstrapper.then(()=>{this.on(h.ChatEvents.ForceQuitConversation,t=>n(this,void 0,void 0,function*(){const e=yield this.getCurrentConversation();e&&e.id===t.conversation.id&&(yield this.clearCurrentConversation(),yield this.purgeConversation(e))})),this.on(h.ChatEvents.PriorityConversationNotification,t=>{t.conversation&&!this._pendingConversationAlerts.find(e=>e.id===t.conversation.id)&&this._pendingConversationAlerts.push(t.conversation)}),this.on(h.ChatEvents.PriorityConversationAcknowledged,t=>{const e=this._pendingConversationAlerts.findIndex(e=>e.id===t.conversation.id);e>-1&&this._pendingConversationAlerts.splice(e,1)})}),window.simpleAudioPlayer=new p.SimpleAudioPlayer,window.vibrationController=new g.VibrationController}_checkConfigForPreferences(t){function e(t,e=null){return t?t&&t instanceof Array==0&&Object.keys(t).includes("readFromPreferences")?t.readFromPreferences:t:e}return t.xmpp=e(t.xmpp,{}),t.behaviour=e(t.behaviour,{}),t.conversationTypes=e(t.conversationTypes,[]),t.roles=e(t.roles,{}),t.priorities=e(t.priorities,[]),t}generateCommonComponents(t){return n(this,void 0,void 0,function*(){this._contactInfoModal=document.querySelector("ct-cl-contact-info"),this._contactInfoModal||(this._contactInfoModal=document.createElement("ct-cl-contact-info"),this._contactInfoModal.owner=this.name,t.appendChild(this._contactInfoModal)),this._alertModal=document.querySelector("ct-cl-conversation-alert"),this._alertModal||(this._alertModal=document.createElement("ct-cl-conversation-alert"),this._alertModal.owner=this.name,t.appendChild(this._alertModal)),this._roleInfoModal=document.querySelector("ct-cl-role-users-modal"),this._roleInfoModal||(this._roleInfoModal=document.createElement("ct-cl-role-users-modal"),this._roleInfoModal.owner=this.name,t.appendChild(this._roleInfoModal)),this._responseModal=document.querySelector("ctcl-responses-modal"),this._responseModal||(this._responseModal=document.createElement("ctcl-responses-modal"),this._responseModal.owner=this.name,t.appendChild(this._responseModal))})}getHandlers(){return u.get(this)}mute(){this.emit(h.ChatEvents.Mute)}getCurrentXmppDisplayName(){const t=this.getCurrentUser();return t&&y.formatUserName(t,y.NameFormat.PREFIX_INITIAL_LAST)||""}getCurrentUser(){return this.comms.user}loadAllConversations(){return n(this,void 0,void 0,function*(){const t=yield this.store.loadConversations(),e=yield this.store.getLatestIdentifier(),i={timestamp:e,max:0===e?1:10},n=yield this._sendIqCommand(u.ChatMessageType.FetchConversations,i);n.data&&n.data.lastIdentifier&&(yield this.store.updateLatestIdentifier(n.data.lastIdentifier));const o=n.data&&n.data.conversations||[],s=[...t];o.length>0&&(o.forEach(t=>{const e=s.findIndex(e=>e.id===t.id);-1!==e?s[e]=t:s.push(t)}),yield this.store.saveConversations(s)),s.forEach(t=>{t.preview&&t.preview.date>(t.hideBefore||t.lastHideBefore)&&(t.lastHideBefore=t.hideBefore||t.lastHideBefore,t.hideBefore=0)}),this._allConversations=s})}getConversations(){return n(this,void 0,void 0,function*(){return y.deepCloneArray(this._allConversations||[])})}getConversationById(t){return n(this,void 0,void 0,function*(){return(yield this.getConversations()).find(e=>e.id===t)||null})}getConversationByRoomJid(t){return n(this,void 0,void 0,function*(){return(yield this.getConversations()).find(e=>e.roomJid===t)||null})}getDirectConversationByParticipants(t){return n(this,void 0,void 0,function*(){const e=new Map;(yield this.getConversations()).filter(t=>t.type===f.ConversationType.Direct).forEach(t=>{e.set(c.getParticipantHash(t.participants),t)});const i=c.getParticipantHash(t);return e.get(i)||null})}createConversationFromProvisional(t){return n(this,void 0,void 0,function*(){return t.isProvisional?this.createConversation(t.participants,t.subject,t.description,t.expiryTTL,t.activityTTL,t.config):null})}addConversation(t,e){return n(this,void 0,void 0,function*(){-1===this._allConversations.findIndex(e=>e.id===t.id)&&(t.preview=e,this._allConversations.push(t),yield this.store.saveConversations(this._allConversations),this.emit(h.ChatEvents.ConversationAdded,new h.ConversationEventArgs(t)))})}updateConversation(t,e={}){return n(this,void 0,void 0,function*(){const i=this._allConversations.findIndex(e=>e.id===t.id);if(-1===i)return;const n=this._allConversations[i];e.preview&&((!n.preview||e.preview.date>n.preview.date)&&(t.preview=e.preview,e.overrideHasUnread||(t.hasUnread=!0)),t.hideBefore&&(t.lastHideBefore=t.hideBefore,t.hideBefore=0)),this._allConversations[i]=y.deepCloneObject(t),yield this.store.saveConversations(this._allConversations);const o=yield this.getCurrentConversation();o&&o.id===t.id&&(yield this.setCurrentConversation(t)),this.emit(h.ChatEvents.ConversationUpdated,new h.ConversationEventArgs(t)),e.isParticipantChange&&this.emit(h.ChatEvents.ConversationParticipantsChanged,new h.ConversationParticiantsEventArgs(t,t.participants))})}saveConversationDraft(t,e){return n(this,void 0,void 0,function*(){const i=this._allConversations.find(e=>e.id===t.id);i&&(e?i.draft=e:delete i.draft,yield this.updateConversation(i))})}closeConversation(t,e){return n(this,void 0,void 0,function*(){t.participants=[],t.isClosed=!0,yield this.comms.clearStoredConversationMessages(t),yield this.comms.clearStoredConversationAttachments(t),yield this.updateConversation(t,{preview:e}),yield this._alertModal.conversationClosed(t),this.emit(h.ChatEvents.ConversationClosed,new h.ConversationEventArgs(t))})}priorityAlert(t){return n(this,void 0,void 0,function*(){const e=new d.ConversationConfigReader(this,t);let i=!0;if(e.alert&&(i=e.alert&&!1===e.autoAlert,t.instigator!==this.getCurrentUserJid()&&!c.isExpiredConversation(t))){if(e.autoIncludeMembersInRoles&&t.participants.find(t=>t.jid===this.getCurrentUserJid()).role===a.ChatRole.Owner)return i;e.alert&&e.autoAlert&&(window.cti&&(window.cti.store.variables.default_urgent_volume=e.alertVolume),yield this.sendConversationReceived(t),yield this.emit(h.ChatEvents.PriorityConversationNotification,new C.PriorityConversationNotificationEventArgs(t,!!e.alert,e.autoAlert,!0))),e.alert&&e.autoAlert&&(yield this.store.addToPendingAlerts(t),yield this.showConversationAlert(null,!0))}return i})}reopenConversation(t,e,i){return n(this,void 0,void 0,function*(){t.participants=e,t.isClosed=!1,yield this.updateConversation(t,{preview:i,isParticipantChange:!0}),this.emit(h.ChatEvents.ConversationAdded,new h.ConversationEventArgs(t))})}getCurrentConversation(){return n(this,void 0,void 0,function*(){return this._currentConversation})}setCurrentConversation(t,e=!1){return n(this,void 0,void 0,function*(){const i=this._currentConversation&&this._currentConversation.id||"";this._currentConversation=t,e&&(yield this.comms.clearStoredConversationMessages(t)),t.id!==i&&this.emit(h.ChatEvents.CurrentConversationChanged)})}setProvisionalConversation(t){return n(this,void 0,void 0,function*(){if(!t.isProvisional)return;const e=this._currentConversation&&this._currentConversation.id||"";this._currentConversation=t,t.id!==e&&this.emit(h.ChatEvents.CurrentConversationChanged)})}belongsToCurrentConversation(t){return n(this,void 0,void 0,function*(){const e=yield this.getCurrentConversation();return!!e&&y.jidsMatch(t.to,e.roomJid)})}clearCurrentConversation(){return n(this,void 0,void 0,function*(){this._currentConversation=null})}removeConversationById(t){return n(this,void 0,void 0,function*(){const e=this._allConversations.findIndex(e=>e.id===t);-1!==e&&this._allConversations[e].isClosed&&(this._allConversations.splice(e,1),yield this.store.saveConversations(this._allConversations),this.emit(h.ChatEvents.ConversationRemoved))})}fetchConversationEntries(t,e=null,i=0){return n(this,void 0,void 0,function*(){if(!t||t.isClosed||t.isProvisional)return[];this._isFetchingChatEntries=!0;let n=e&&e.id||null;const o=null===n;null===n?this.logger.log(r.LoggerTypes.Mam,`%c FETCHING INITIAL CHAT ENTRIES FOR CONVERSATION: %c${t.id}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;"):this.logger.log(r.LoggerTypes.Mam,`%c FETCHING EARLIER CHAT ENTRIES FOR CONVERSATION: %c${t.id} (before ${n})`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;");let s=[];return o&&((s=yield this._getChatEntriesFromMessageStore(t)).length&&(n=s[0].id),this.logger.log(r.LoggerTypes.Mam,`%c FETCHED ${s.length} ENTRIES FROM THE STORE`,"color: #669; font-weight: bold;",s)),s.length<i&&(o&&this.logger.log(r.LoggerTypes.Mam,"%c ...NOT ENOUGH ENTRIES FOUND IN THE STORE, SUPPLEMENTING WITH MAM MESSAGES","color: #669; font-weight: bold;"),s=[...(yield this._getChatEntriesFromMam(t,n,i-s.length))||[],...s]),this.logger.log(r.LoggerTypes.Mam,`%c FETCHED ${s.length} CHAT ENTRIES`,"color: #669; font-weight: bold;",s),this._isFetchingChatEntries=!1,this.emit(h.ChatEvents.ChatEntriesFetched,new h.ConversationEventArgs(t)),t.hideBefore||t.lastHideBefore?s.filter(e=>e.date>(t.hideBefore||t.lastHideBefore)):s})}fetchAllConversationEntries(t){return n(this,void 0,void 0,function*(){return!t||t.isClosed||t.isProvisional?[]:yield this._getChatEntriesFromMessageStore(t)})}sendConversationMessage(t,e,i,o){return n(this,void 0,void 0,function*(){const n=yield this.sendRoomChatMessage(t.id,e,i,o,!0),s=n._id,r=n.ts,a=this.getCurrentUserJid(),l=a,d=t.roomJid,h=n.attachments.map(t=>({remote:t.get,local:t.path})),u=c.createChatMessage(s,r,a,l,d,e,h);return r>t.preview.date&&(t.preview=u),t.hasUnread=!1,t.hideBefore&&t.preview.date>(t.hideBefore||t.lastHideBefore)&&(t.lastHideBefore=t.hideBefore||t.lastHideBefore,t.hideBefore=0),yield this.updateConversation(t),yield this.updateLatestIdentifier(n),u})}deleteConversationMessageById(t,e=!0){return n(this,void 0,void 0,function*(){yield this.comms.deleteMessageById(t,e)})}updateLatestIdentifier(t){return n(this,void 0,void 0,function*(){const e=parseInt(t.archive_id,10);yield this.store.updateLatestIdentifier(e)})}showContactInfo(t,e,i,o=null){return n(this,void 0,void 0,function*(){yield this._contactInfoModal.show(t,e,i,!0,o)})}showRoleUsersModal(t,e=!0){return n(this,void 0,void 0,function*(){yield this._roleInfoModal.show(t,e)})}showResponsesModal(t,e=!0){return n(this,void 0,void 0,function*(){yield this._responseModal.show(t,e)})}updateUserDirectory(){return n(this,void 0,void 0,function*(){return yield this.comms.updateUserDirectory()})}dismissContactInfo(){return n(this,void 0,void 0,function*(){yield this._contactInfoModal.dismiss()})}showConversationAlert(t,e){return n(this,void 0,void 0,function*(){yield this._alertModal.show(t,e)})}dismissConversationAlert(){return n(this,void 0,void 0,function*(){yield this._alertModal.dismiss()})}setShowChatFunction(t){this._alertModal.setShowChatFunction(t)}markDirectConversationAsDeleted(t,e){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const i={conversation:t,timestamp:e||t.preview.date},n=yield this._sendIqCommand(u.ChatMessageType.HideDirectConversation,i);return!(!n.updated||n.updated.$attributes.id!==t.id)})}createConversation(t,e,i,o,s,c,l=[]){return n(this,void 0,void 0,function*(){const n=new d.ConversationConfigReader(this,null,c),o=[];for(let e=0;e<n.autoIncludeMembersInRoles.length;e++){const i=n.autoIncludeMembersInRoles[e];(yield this.searchUsers(i,["group"])).filter(t=>t.group===i).map(t=>({jid:t.jid,role:a.ChatRole.Owner})).forEach(e=>{t.find(t=>t.jid.toLowerCase()===e.jid.toLowerCase())||o.push(e)})}const s={type:n.namedSettings?f.ConversationType.Named:f.ConversationType.Direct,participants:[...t,...o],subject:e,description:i,config:c,attachments:l};if(n.priorityPush&&(s.priority=n.priorityPush),n.defaultConversationExpiryTTL>0&&(s.expiry_ttl=n.defaultConversationExpiryTTL),n.defaultConversationActivityTTL>0&&(s.activity_ttl=n.defaultConversationActivityTTL),s.attachments&&s.attachments.length)try{for(let t=0;t<s.attachments.length;t++){const e=yield this.comms.uploadFile(l[t].path);s.attachments[t].path=e}}catch(t){return this.logger.log(r.LoggerTypes.MessageSent,t.toString(),"Unable to upload attachment:",s.attachments),this.error(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.UPLOAD_ERROR_TITLE)),this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.UPLOAD_ERROR_DESCRIPTION))),null}const h=yield this._sendIqCommand(u.ChatMessageType.CreateConversation,s);return h?!0===h.data.exists?(this.error("Unable to create conversation","A direct conversation between these participants already exists."),null):h.data.newConversationId:null})}updateNamedConversation(t,e,i){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const n={conversation:t,newSubject:e,newDescription:i},o=yield this._sendIqCommand(u.ChatMessageType.UpdateConversation,n);return this.dismissWaitingMessage(),!!o})}addParticipantsToConversation(t,e){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const i={conversation:t,participants:e},n=yield this._sendIqCommand(u.ChatMessageType.AddParticipants,i);return this.dismissWaitingMessage(),!!n})}removeParticipantsFromConversation(t,e){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const i={conversation:t,participants:e},n=yield this._sendIqCommand(u.ChatMessageType.RemoveParticipants,i);return this.dismissWaitingMessage(),!!n})}changeParticipantRoleInConversation(t,e,i){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const n={conversation:t,participant:e,newRole:i},o=yield this._sendIqCommand(u.ChatMessageType.ChangeParticipantRole,n);return this.dismissWaitingMessage(),!!o})}leaveConversation(t){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const e={conversation:t},i=yield this._sendIqCommand(u.ChatMessageType.LeaveConversation,e);return this.dismissWaitingMessage(),!!i})}endConversation(t){return n(this,void 0,void 0,function*(){this.showWaitingMessage(this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.PLEASE_WAIT)));const e={conversation:t},i=yield this._sendIqCommand(u.ChatMessageType.EndConversation,e);return this.dismissWaitingMessage(),!!i})}getConfiguredPriorityById(t){return this.config.priorities.find(e=>e.id===t)}captureOrSelectMedia(){return n(this,void 0,void 0,function*(){if(!this.config.externalFunctions||"function"!=typeof this.config.externalFunctions.captureOrSelectMedia)throw this.error("External function not implemented","External function 'captureOrSelectMedia' is not implemented"),new Error("External function 'captureOrSelectMedia' is not implemented");try{return yield this.config.externalFunctions.captureOrSelectMedia()}catch(t){throw this.error("Could not attach media",t||"An unspecified error occurred"),t}})}cancelMediaSeletion(t){return n(this,void 0,void 0,function*(){if(!this.config.externalFunctions||"function"!=typeof this.config.externalFunctions.cancelMediaSeletion)throw this.error("External function not implemented","External function 'cancelMediaSeletion' is not implemented"),new Error("External function 'cancelMediaSeletion' is not implemented");try{yield this.config.externalFunctions.cancelMediaSeletion(t)}catch(t){throw this.error("Could not attach media",t||"An unspecified error occurred"),t}})}hasMediaFullscreenHandler(){return this.config.externalFunctions&&"function"==typeof this.config.externalFunctions.showMediaFullscreen}showMediaFullscreen(t){return n(this,void 0,void 0,function*(){if(this.hasMediaFullscreenHandler())try{yield this.config.externalFunctions.showMediaFullscreen(t)}catch(t){throw this.error("Could not show media fullscreen",t||"An unspecified error occurred"),t}})}sendConversationReceived(t){return n(this,void 0,void 0,function*(){return!!(yield this._sendIqCommand(u.ChatMessageType.ReceivedConversation,t))})}sendConversationAcknowledgement(t,e){return n(this,void 0,void 0,function*(){const i={conversation:t,value:e};return!!(yield this._sendIqCommand(u.ChatMessageType.AcknowledgeConversation,i))})}addToPendingAlerts(t){return n(this,void 0,void 0,function*(){return this.store.addToPendingAlerts(t)})}getNewestPendingAlert(){const t=this.store.getPendingAlerts();return t.length>0?t[0]:null}clearPendingAlert(t){return n(this,void 0,void 0,function*(){return yield this.store.clearPendingAlert(t)})}getPendingAlertCount(){return this.store.getPendingAlerts().filter(t=>!c.isExpiredConversation(t)).length}purgeAllConversations(){return n(this,void 0,void 0,function*(){if(!this.config.behaviour.maxChatEntriesToStore)return;let t=0;this.logger.shouldLog(r.LoggerTypes.CleanUp)&&(t=(new Date).getTime()),this.logger.log(r.LoggerTypes.CleanUp," Purging all conversations...");const e=yield this.comms.getAllMessages();let i=[];for(const t of this._allConversations){const n=e.filter(e=>e.recipient_id===`${t.id}@${this.comms.getMucHost()}`||e.sender_id===`${t.id}@${this.comms.getMucHost()}`).sort((t,e)=>t.ts-e.ts),o=n.splice(0,n.length-this.config.behaviour.maxChatEntriesToStore);i=[...i,...o]}for(const t of i)yield this.deleteConversationMessageById(t._id,!0);if(this.logger.shouldLog(r.LoggerTypes.CleanUp)){const e=(new Date).getTime()-t;this.logger.log(r.LoggerTypes.CleanUp,` Purged ${i.length} messages in ${e}ms.`)}})}_executePurge(t){return n(this,void 0,void 0,function*(){this._conversationsBeingPurged.push(t.id);const e=yield this.comms.findChatEntriesToPurge(t);this.logger.debug(r.LoggerTypes.Other,`Purging ${e.length} messages(s) from conversation ${t.id}`);for(const t of e)yield this.deleteConversationMessageById(t._id,!0);this._conversationsBeingPurged=this._conversationsBeingPurged.filter(e=>e!==t.id),this.emit(h.ChatEvents.ConversationPurged,new h.ConversationEventArgs(t))})}purgeConversation(t){return n(this,void 0,void 0,function*(){if(t&&this.config.behaviour.maxChatEntriesToStore&&!(this._currentConversation&&t.id===this._currentConversation.id||this._pendingConversationAlerts.find(e=>e.id===t.id)))return new Promise((e,i)=>n(this,void 0,void 0,function*(){this._isFetchingChatEntries||this.isProcessing()?this.on(h.ChatEvents.MessageProcessorQueueEmpty,()=>n(this,void 0,void 0,function*(){yield this._executePurge(t),e()}),!0):(yield this._executePurge(t),e())}))})}isConversationBeingPurged(t){return this._conversationsBeingPurged.includes(t)}getConfiguredConversations(){return this.config.conversationTypes?this.config.conversationTypes.sort((t,e)=>t.sortOrder>e.sortOrder?1:t.sortOrder<e.sortOrder?-1:t.name>e.name?1:t.name<e.name?-1:0):[]}doesDirectConversationExistInConfiguration(){return this.config.conversationTypes.find(t=>!t.behaviour.namedSettings)}_sendIqCommand(t,e){return n(this,void 0,void 0,function*(){return this.sendIq(this.config.xmpp.iq.host,"set",t,e)})}_getChatEntriesFromMessageStore(t){return n(this,void 0,void 0,function*(){const e=yield this.comms.getChatHistory(t.roomJid);return(yield Promise.all(e.map(t=>n(this,void 0,void 0,function*(){return yield c.convertToChatEntry(t,this)})))).filter(t=>null!==t)})}_getChatEntriesFromMam(t,e=null,i=null){return n(this,void 0,void 0,function*(){const n=this.getConnectionStatus();if(n!==a.ConnectionStatus.Connected)throw new s.NotConnectedError(n);try{let n=t.hideBefore||t.lastHideBefore||null;return n&&n++,yield this.comms.fetchConversationMessages(t,e,i,n)}catch(t){const e=this.translateI18nItem(v.CommonMetadata.getI18nItem(v.CommonI18nKeys.FETCH_ERROR));return this.error(e,t),[]}})}static getUniqueTranslationKeys(t=!1,...e){return[...o.BaseLayer.getUniqueTranslationKeys(t,...e),...m.getChatI18nKeys(t,...e)].filter((t,e,i)=>i.indexOf(t)===e).sort()}setStatusBarColor(t){const e=window;e.cti&&e.StatusBar&&e.StatusBar.backgroundColorByHexString(t)}}e.ChatLayer=b,window.CtChatLayer=b},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(22),s=i(26),r=i(11),a=i(42),c=i(17),l=i(0),d=i(115),h=i(2),u=i(5),p=i(11);class g{constructor(t,e){if(this.messageQueueProcessorDebounce=null,this.suppressMode=!1,this._messageHandlers=new Map,this._messageProcessorQueue=Promise.resolve(),this._suppressModeQueue=[],this._deferredStanzas=[],this._waitingAlertId=null,this._isProcessing=!1,!e)throw new Error("You must supply a config object");e.i18n&&e.i18n.enabled?h.setLocale(e.i18n.locale||e.i18n.language||"en-GB"):h.setLocale("en-GB"),this.name=t,this.config=e,this._eventListeners={},this.logger=new c.Logger(this.config.logging||[]),this._setUpHandlers(),document.addEventListener("backbutton",()=>{this._backHandler&&this._backHandler()},!1),a.LayerRegistration.addInstance(this.name,this)}static getInstance(t){return a.LayerRegistration.getInstance(t)}static onReady(t,e){a.LayerRegistration.onReady(t,e)}moveTaskToBack(){this.emit(p.BaseEvents.MoveTaskToBack)}setBackHandler(t){this._oldBackHandler=this._backHandler,this._backHandler=t}popBackHandler(){this._backHandler=this._oldBackHandler}isProcessing(){return this._isProcessing}bootstrap(t,e){return this._buildCommonComponents(),Promise.resolve().then(()=>this._setStore(e)).then(()=>this._setLogger()).then(()=>this._setComms(t)).then(()=>this._setupPushNotifications()).then(()=>this._setupCommonEventListeners()).then(()=>a.LayerRegistration.fireReady(this.name)).catch(t=>{a.LayerRegistration.fireReady(this.name),setTimeout(()=>{this.error("Error during bootstrap",t)},100)})}on(t,e,i=!1,o=!1){void 0===this._eventListeners[t]&&(this._eventListeners[t]=[]);const s=h.generateRandomSixString(),r={id:s,oneTimeOnly:i,allowSuppress:o,callback:t=>n(this,void 0,void 0,function*(){yield e(t.detail)})};return this._eventListeners[t].push(r),()=>{const e=this._eventListeners[t].findIndex(t=>t.id===s);if(-1!==e)return this._eventListeners[t].splice(e,1)[0]}}emit(t,e,i=!1){return n(this,void 0,void 0,function*(){const n=[Promise.resolve()];this._eventListeners[t]||(this._eventListeners[t]=[]),this.logger.log(c.LoggerTypes.Events,`%c RAISING EVENT:%c ${t} (${this._eventListeners[t].length} listeners)`,"color: #066; font-weight: bold;","color: #999; font-weight: normal;",{data:e});const o=[];for(let s=0;s<this._eventListeners[t].length;s++){const r=this._eventListeners[t][s];this.suppressMode&&r.allowSuppress&&!i||n.push(r.callback({detail:e})),!0===r.oneTimeOnly&&o.push(s)}o.length&&(this._eventListeners[t]=this._eventListeners[t].filter((t,e)=>!o.includes(e))),yield Promise.all(n)})}login(t,e){return n(this,void 0,void 0,function*(){return yield this.comms.login(t,e)})}attemptReconnect(){this.comms.attemptReconnect()}logout(t=!1,e=!0){return n(this,void 0,void 0,function*(){return yield this.comms.logout(t,e)})}getSyncedTimestamp(){return this.comms.getSyncedTimestamp()}getConnectionStatus(){return this.comms.getConnectionStatus()}clearAllData(t=!1){return n(this,void 0,void 0,function*(){try{yield this.store.clearAllData(),yield this.comms.clearAllData(t)}catch(t){this.error("Error clearing data",t)}})}getCurrentUserJid(){return this.comms.username}getCurrentUserResource(){return this.comms.getCurrentUserResource()}getCurrentUser(){return null}getCurrentXmppDisplayName(){return this.comms.username}updateUserDirectory(){return n(this,void 0,void 0,function*(){yield this.comms.updateUserDirectory()})}getUserByJid(t){return n(this,void 0,void 0,function*(){return yield this.comms.getUserByJid(t)})}searchUsers(t="",e=[]){return n(this,void 0,void 0,function*(){return yield this.comms.searchUsers(t,e)})}markChatEntryRead(t){return n(this,void 0,void 0,function*(){yield this.comms.markMessageRead(t.id)})}downloadMessageAttachments(t){return n(this,void 0,void 0,function*(){if(t.attachments&&0!==t.attachments.length)return this.comms.downloadMessageAttachments(t.id)})}downloadFile(t){return n(this,void 0,void 0,function*(){try{return yield this.comms.downloadFile(t)}catch(t){this.error("Error downloading file",t)}})}downloadFileWithoutCatch(t,e=!1){return n(this,void 0,void 0,function*(){return yield this.comms.downloadFile(t,e)})}processXmlStanzaStringsFromMam(t,e=!0){return n(this,void 0,void 0,function*(){try{return yield this.comms.processXmlStanzaStringsFromMam(t,e)}catch(t){this.error("Error processing XML stanzas from MAM",t)}})}error(t,e,i=null){return n(this,void 0,void 0,function*(){yield this.cancelSuppressMode("*"),this.dismissWaitingMessage();const n="string"==typeof e?e:e.message||"Unknown error";this.emit(r.BaseEvents._Request_RaiseAlert,new l.DefaultAlerts(this).AlertErrorWithOkayButton(t,n,1,{})),this.logger.error(i||e)})}getLabel(t,e){if(!this.config.labels||!this.config.labels[t])return null;const i=this.translateText(this.config.labels[t],!1);return h.tokenReplace(i,e)}translateText(t,e=!1){if(!this.config.i18n||!0!==this.config.i18n.enabled||"function"!=typeof this.config.i18n.translateFn)return t;if(void 0===t)return;if(null===t)return null;if(""===t)return"";const i=this.config.i18n.translateFn(t);return null===i?!0===e?null:this.config.i18n.debugMode?` ${t} `:t:i}translateI18nItem(t){if(!this.config.i18n||!0!==this.config.i18n.enabled)return t.key;const e=this.translateText(t.scopedKey,!0);return null!==e?e:this.translateText(t.key)}getUniqueCommsId(){return this.comms.getUniqueId()}sendMessage(t,e,i,o=[],s=!1){return n(this,void 0,void 0,function*(){const n=h.deepCloneObject(i),r=yield this._prepareMessage(t,n);if(null===r)return null;try{const i=yield this.comms.sendMessage(e,r,o);return h.parseMessagePayload(i,t)}catch(t){if(s)throw t;this.error("Error sending message",t)}})}sendRoomChatMessage(t,e,i=[],o=!0,s=!1){return n(this,void 0,void 0,function*(){try{return yield this.comms.sendRoomMessage(t,e,null,i,o)}catch(t){if(s)throw t;this.error("Error sending room chat message",t)}})}sendRoomMessage(t,e,i,o=!1){return n(this,void 0,void 0,function*(){const n=h.deepCloneObject(i),s=yield this._prepareMessage(e,n);if(null===s)return null;try{const i=yield this.comms.sendRoomMessage(t,null,s);return h.parseMessagePayload(i,e)}catch(t){if(o)throw t;this.error("Error sending room message",t)}})}sendMulticastMessage(t,e,i,o=[],s=!1){return n(this,void 0,void 0,function*(){const n=h.deepCloneObject(e),r=yield this._prepareMessage(t,n);if(null===r)return null;try{const e=yield this.comms.sendMulticastMessage(i,r,o);return h.parseMessagePayload(e,t)}catch(t){if(s)throw t;"object"==typeof t?(this.logger.error(t),this._workOutIfAttachmentTooLarge(t)):this.error("Error sending multicast message",t)}})}sendIq(t,e,i,o,r=!1){return n(this,void 0,void 0,function*(){const n=h.deepCloneObject(o),a=this._getHandlerForMessageType(i);if(!a)return null;const c=yield this._prepareIq(i,n);if(null===c)return null;let l=null;try{l=yield this.comms.sendIq(t,e,c)}catch(t){const e=t;if(r)throw e;return yield a.callHandleIqErrorResponse(n,e)}try{return yield a.callHandleIqResponse(n,l)}catch(t){const e=new s.IQError(t.message||t,l);if(r)throw e;return yield a.callHandleIqErrorResponse(n,e)}})}sendMessageToBot(t,e,i=!1){return n(this,void 0,void 0,function*(){const n=h.deepCloneObject(e);try{yield this._sendBotCommand(t,n,null)}catch(t){if(i)throw t;this.error("Error sending bot message",t)}})}sendBotCommand(t,e,i=!1){return n(this,void 0,void 0,function*(){const n=h.deepCloneObject(e);try{return yield this.comms.sendBotCommand(t.toString(),n)}catch(t){if(i)throw t;this.error("Error sending bot command",t)}})}setSupportLoggingTypes(t=["_all_"]){return n(this,void 0,void 0,function*(){return this.logger.setTypes(t),yield this.store.saveLoggerTypes(t)})}resetSupportLogging(){return n(this,void 0,void 0,function*(){return this.logger.resetTypes(),yield this.store.deleteLoggerTypes()})}showWaitingMessage(t){return n(this,void 0,void 0,function*(){yield this.dismissWaitingMessage();const e=new l.DefaultAlerts(this).AlertWaiting(t);this._waitingAlertId=e.id,this._alertModalManager.raiseAlert(e)})}dismissWaitingMessage(){return n(this,void 0,void 0,function*(){this._waitingAlertId&&(this._alertModalManager.dismissAlertById(this._waitingAlertId),this._waitingAlertId=null)})}enableSuppressMode(t,e=!1){if("*"===t)throw new Error("Suppress mode cannot be enabled with the id '*'");e&&this._suppressModeQueue.includes(t)?this.logger.log(c.LoggerTypes.Other,`%c SUPPRESSION MODE ALREADY EXISTS IN QUEUE %c${t}`,"color: #696; font-weight: bold;","color: #999; font-weight: normal;"):(this.logger.log(c.LoggerTypes.Other,`%c ADDING TO SUPPRESSION MODE QUEUE %c${t}`,"color: #696; font-weight: bold;","color: #999; font-weight: normal;"),this._suppressModeQueue.push(t)),this.logger.log(c.LoggerTypes.Other,"%c SUPPRESSION MODE QUEUE","color: #696; font-weight: bold;",this._suppressModeQueue),this.suppressMode||(this.logger.log(c.LoggerTypes.Other,"%c ENTERING SUPPRESSION MODE","color: #696; font-weight: bold;"),this.suppressMode=!0)}cancelSuppressMode(t){return n(this,void 0,void 0,function*(){if(0!==this._suppressModeQueue.length)return this._messageProcessorQueue=this._messageProcessorQueue.then(()=>new Promise(e=>{if("*"===t)this.logger.log(c.LoggerTypes.Other,"%c CLEARING SUPPRESSION MODE QUEUE","color: #696; font-weight: bold;"),this._suppressModeQueue=[],this.suppressMode=!1;else{const e=this._suppressModeQueue.indexOf(t);-1!==e&&(this.logger.log(c.LoggerTypes.Other,`%c REMOVING FROM SUPPRESSION MODE QUEUE %c${t}`,"color: #696; font-weight: bold;","color: #999; font-weight: normal;"),this._suppressModeQueue.splice(e,1),this.logger.log(c.LoggerTypes.Other,"%c SUPPRESSION MODE QUEUE","color: #696; font-weight: bold;",this._suppressModeQueue))}if(!0===this.suppressMode&&0===this._suppressModeQueue.length){if(this.logger.log(c.LoggerTypes.Other,"%c EXITING SUPPRESSION MODE","color: #696; font-weight: bold;"),this.suppressMode=!1,this._deferredStanzas.length>0){const t=[...this._deferredStanzas],e=t.filter(t=>t.eventType===o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE).map(t=>t.payload.data);this._deferredStanzas=[],this.logger.log(c.LoggerTypes.Other,`%c HANDLING ${e.length} DEFERRED MESSAGE(S) RECEIVED DURING SUPPRESSED MODE`,"color: #696; font-weight: bold;",e),t.forEach(t=>{switch(t.eventType){case o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE:this.handleNewMessage(t.payload);break;case o.CtXmppClient.EVENT_TYPES.MESSAGE_UPDATED:this.handleMessageUpdate(t.payload);break;case o.CtXmppClient.EVENT_TYPES.RECEIPT_RECEIVED:this.handleChatMarkerUpdate(t.payload)}})}else this.logger.log(c.LoggerTypes.Other,"%c NO MESSAGES RECEIVED DURING SUPPRESSED MODE","color: #696; font-weight: bold;");this.logger.log(c.LoggerTypes.Other,"%c REDRAWING UIS","color: #696; font-weight: bold;"),this.emit(r.BaseEvents._Request_RedrawAllUIs)}e()})),this._messageProcessorQueue})}addDeferredStanza(t){this._deferredStanzas||(this._deferredStanzas=[]),this.logger.log(c.LoggerTypes.Other,`%c ADDING DEFERRED STANZA %c${t.id} > ${t.eventType}`,"color: #696; font-weight: bold;","color: #999; font-weight: normal;",{payload:t.payload}),this._deferredStanzas.push(t)}removeDeferredStanza(t,e){this._deferredStanzas&&this._deferredStanzas.length&&this._deferredStanzas.some(i=>i.id===t&&i.eventType===e)&&(this.logger.log(c.LoggerTypes.Other,`%c REMOVING DEFERRED STANZA %c${t} > ${e}`,"color: #696; font-weight: bold;","color: #999; font-weight: normal;"),this._deferredStanzas=this._deferredStanzas.filter(i=>i.id!==t||i.eventType!==e))}getHandlerForMessage(t){const e=h.getMessageType(t);return this._getHandlerForMessageType(e)}setTheme(t){return n(this,void 0,void 0,function*(){yield this.store.saveTheme(t),this._setThemeOnHtml(t)})}_setComms(t){return new Promise((e,i)=>{const n=this.config.xmpp.initTimeout||1e4,o=setTimeout(()=>{i(`Comms was not initialised within ${Math.floor(n/1e3)} seconds. Aborting.`)},n);this.comms=t,this.comms.onLogin(t=>{this.comms.getServerVersion(),this.handleLogin(t)}),this.comms.onLogout(t=>{this.handleLogout(t)}),this.comms.onNewMessage(t=>{this.handleNewMessage(t)}),this.comms.onMessageUpdate(t=>{this.handleMessageUpdate(t)}),this.comms.onChatMarkerUpdate(t=>{this.handleChatMarkerUpdate(t)}),this.comms.onStatusUpdate((t,e,i)=>{this.handleConnectionChange(t,e,i)}),this.comms.onPresenceUpdate(t=>{this.handlePresenceUpdate(t)}),this.comms.onRoomNewParticipant(t=>{this.handleRoomParticipantUpdate(t)}),this.comms.onRoomParticipantUpdate(t=>{this.handleRoomParticipantUpdate(t)}),this.comms.onStartFetchingMissedMessages(()=>{this.enableSuppressMode("baseLayer#mam",!0)}),this.comms.onFinishedFetchingMissedMessages(()=>{this.cancelSuppressMode("baseLayer#mam")}),this.comms.onInitialized(()=>{e(),clearTimeout(o),this.config.xmpp.user.id&&this.config.xmpp.user.password&&this.config.xmpp.user.domain&&(this.showWaitingMessage(`Logging in as ${this.config.xmpp.user.id}`),this._attemptAutoLogin(this.config.xmpp.user.id,this.config.xmpp.user.password,this.config.xmpp.user.domain))})})}_setStore(t){return new Promise(e=>{this.store=t,this.store.init().then(()=>e())})}_setLogger(){return new Promise(t=>n(this,void 0,void 0,function*(){const e=yield this.store.getLoggerTypes();e&&this.logger.setTypes(e),t()}))}_setupPushNotifications(){return new Promise(t=>n(this,void 0,void 0,function*(){const e=window;this.config.enablePushNotifications&&e.cordova&&e.cordova.plugins.notification?e.cti.store.notification&&e.cti.store.notification.token?(yield this.store.savePushNotificationToken(e.cti.store.notification.token),t()):e.cordova.plugins.notification.registerForPush(e=>n(this,void 0,void 0,function*(){yield this.store.savePushNotificationToken(e),t()}),e=>{this.logger.error(e),t()},{channelName:this.name}):t()}))}_setupCommonEventListeners(){return new Promise(t=>n(this,void 0,void 0,function*(){const e=yield this.store.getTheme();this._setThemeOnHtml(e),this.on(r.BaseEvents._Request_ThemeChange,t=>n(this,void 0,void 0,function*(){yield this.store.saveTheme(t),this._setThemeOnHtml(t)})),t()}))}_setThemeOnHtml(t){document.querySelector("html").setAttribute("theme",t),this.emit(r.BaseEvents._Request_RedrawAllUIs)}_setUpHandlers(){this._messageHandlers=new Map,this.getHandlers().forEach(t=>{t.messageKey&&this._messageHandlers.set(t.messageKey,t),t.eventType&&t.eventType.length&&t.eventType.forEach(e=>{this.on(e,i=>n(this,void 0,void 0,function*(){try{yield t.callHandleEvent(e,i)}catch(t){this.error("Error handling event",`Event type: ${e.toString()}. ${t.message||t}`)}}))})})}_prepareMessage(t,e){return n(this,void 0,void 0,function*(){const i=this._messageHandlers.get(t),n=yield i.callCreateMessage(e);return null==n?null:{[i.messageKey]:JSON.stringify(n)}})}_prepareIq(t,e){return n(this,void 0,void 0,function*(){const i=yield this._messageHandlers.get(t).callCreateIq(e);return null==i?null:i})}_sendBotCommand(t,e,i){return n(this,void 0,void 0,function*(){const n=t.toString(),o=yield this._prepareBotMessage(t,e,i);if(null===o)return;const s=yield this.comms.sendBotCommand(n,o);s&&!1===s.success&&!0===(yield this._shouldRetryBotMessage(t,e,s))&&(yield this._sendBotCommand(t,e,s))})}_prepareBotMessage(t,e,i){return n(this,void 0,void 0,function*(){const n=this._messageHandlers.get(t),o=yield n.callCreateBotMessage(e,i);return null==o?null:{[n.messageKey]:JSON.stringify(o)}})}_shouldRetryBotMessage(t,e,i){return n(this,void 0,void 0,function*(){return yield this._messageHandlers.get(t).callHandleFailedBotResponse(e,i)})}_buildCommonComponents(){return n(this,void 0,void 0,function*(){let t=document.querySelector("div#___ct_base_layer_modal_container");t||((t=document.createElement("div")).id="___ct_base_layer_modal_container",t.setAttribute("style","position: absolute; top: 0; left: 0; width: 0; height: 0; z-index: 99999;"),document.body.appendChild(t)),this._alertModalManager=document.querySelector("ct-alert-modal-manager"),this._alertModalManager||(this._alertModalManager=document.createElement("ct-alert-modal-manager"),this._alertModalManager.owner=this.name,t.appendChild(this._alertModalManager)),yield this.generateCommonComponents(t)})}_attemptAutoLogin(t,e,i){return n(this,void 0,void 0,function*(){let n=`${t}@${i}`;this.config.xmpp.user&&!0===this.config.xmpp.user.forceLowercaseJid&&(n=n.toLowerCase()),this.logger.log(c.LoggerTypes.Connectivity,`%c ATTEMPTING AUTOMATIC LOGIN AS > %c${n}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;"),yield this.comms.login(n,e)})}_getHandlerForMessageType(t){return this._messageHandlers.get(t.toString())||this.error("No handler found",`No handlers was found for message type '${t.toString()}'`),this._messageHandlers.get(t)}_workOutIfAttachmentTooLarge(t){const e="There was an error sending the message, please try again.";if(t.nodeName&&"iq"===t.nodeName&&t.childNodes&&t.childNodes[1]&&"error"===t.childNodes[1].nodeName){const e=t.childNodes[1];if(e.childNodes&&e.childNodes[1]&&"text"===e.childNodes[1].nodeName){const t=e.childNodes[1].textContent.match(/\d+/)[0],i=t?parseInt(t):0;if(i){const t=`The attachment is too large. Please select a file lower than ${Math.round(i/1024/1024)}MB in size.`;throw this.error("Attachment Too Large",t),new Error(t)}{const t="The attachment is too large. Please choose a smaller attachment.";throw this.error("Attachment Too Large",t),new Error(t)}}}throw this.error("Error sending multicast message",e),new Error(e)}handleLogin(t){this.emit(r.BaseEvents.LoginResult,t)}handleLogout(t){this.emit(r.BaseEvents.LogoutResult,t)}_finishedProcessing(){clearTimeout(this.messageQueueProcessorDebounce),this.messageQueueProcessorDebounce=setTimeout(()=>{this._isProcessing=!1,this.emit(u.ChatEvents.MessageProcessorQueueEmpty)},1e3)}handleNewMessage(t){if(!0===this.suppressMode&&!0!==t.fromMam)return void this.addDeferredStanza({id:t._id,eventType:o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE,payload:t});this.emit(r.BaseEvents.UserActivity,new r.UserActivityEventArgs(t.jid,t.ts));const e=h.getMessageType(t),i=h.parseMessagePayload(t,e),s=this._getHandlerForMessageType(e);s&&(this._messageProcessorQueue=this._messageProcessorQueue.then(()=>n(this,void 0,void 0,function*(){try{this._isProcessing=!0,this.removeDeferredStanza(t._id,o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE),this.logger.log(c.LoggerTypes.ProcessingReceived,"%c PROCESSING NEW MESSAGE:%c","color: #060; font-weight: bold;","color: #999; font-weight: normal;",h.getMessageContentForDebug(i));const e=yield s.callHandleMessage(i);return this._finishedProcessing(),e}catch(t){this.error("Error processing message",t)}})).catch(t=>this.error("Error processing message",t)))}handleMessageUpdate(t){if(!0===this.suppressMode)return void this.addDeferredStanza({id:t._id,eventType:o.CtXmppClient.EVENT_TYPES.MESSAGE_UPDATED,payload:t});this.emit(r.BaseEvents.UserActivity,new r.UserActivityEventArgs(t.jid,t.ts));const e=h.getMessageType(t),i=h.parseMessagePayload(t,e),s=this._getHandlerForMessageType(e);s&&(this._messageProcessorQueue=this._messageProcessorQueue.then(()=>n(this,void 0,void 0,function*(){try{this.removeDeferredStanza(t._id,o.CtXmppClient.EVENT_TYPES.MESSAGE_UPDATED),this.logger.log(c.LoggerTypes.ProcessingUpdated,"%c PROCESSING MESSAGE UPDATE:%c","color: #060; font-weight: bold;","color: #999; font-weight: normal;",h.getMessageContentForDebug(i));const e=yield s.callHandleMessageUpdate(i);return this._finishedProcessing(),e}catch(t){this.error("Error processing message update",t)}})).catch(t=>this.error("Error processing message update",t)))}handleChatMarkerUpdate(t){if(!0===this.suppressMode)return void this.addDeferredStanza({id:t.message_id,eventType:o.CtXmppClient.EVENT_TYPES.RECEIPT_RECEIVED,payload:t});const e=Object.assign({},t);let i=`${e.sender_resource}@${this.config.xmpp.user.domain}`;this.config.xmpp.user&&!0===this.config.xmpp.user.forceLowercaseJid&&(i=i.toLowerCase()),e.sender_resource=i,this.emit(r.BaseEvents.UserActivity,new r.UserActivityEventArgs(e.sender_resource,e.message.updated_at||e.message.ts));const s=h.getMessageType(e.message),a=h.parseMessagePayload(e.message,s),l=Object.assign({},e,{message:a}),d=this._getHandlerForMessageType(s);d&&(this._messageProcessorQueue=this._messageProcessorQueue.then(()=>n(this,void 0,void 0,function*(){try{this.removeDeferredStanza(t.message_id,o.CtXmppClient.EVENT_TYPES.RECEIPT_RECEIVED);const i=e.sender_resource.split("@").shift();this.logger.log(c.LoggerTypes.ProcessingChatMarker,`%c PROCESSING CHAT MARKER: %c${i} > ${e.type}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;");const n=yield d.callHandleMessageReceipt(l);return this._finishedProcessing(),n}catch(t){this.error("Error processing chat marker",t)}})).catch(t=>this.error("Error processing chat marker",t)))}handleRoomParticipantUpdate(t){if(!t.jid)return;this.emit(r.BaseEvents.UserActivity,new r.UserActivityEventArgs(t.jid,t.updated_at||t.ts));const e=t.metadata&&t.metadata.role?t.metadata.role:"";this.emit(r.BaseEvents.RoomParticipantUpdate,new r.RoomParticipantUpdateEventArgs(t.jid,t.room_name,e,l.RoomRole[t.room_role]))}handleConnectionChange(t,e,i){this.comms.setConnectionStatus(t),g.onReady(this.name,()=>{this.emit(r.BaseEvents.ConnectionStatusChange,new r.ConnectionStatusEventArgs(t,e,i))})}handlePresenceUpdate(t){t.online&&this.emit(r.BaseEvents.UserActivity,new r.UserActivityEventArgs(t.id,this.getSyncedTimestamp()));const e=t.online?l.ConnectionStatus.Connected:l.ConnectionStatus.Disconnected;this.emit(r.BaseEvents.OtherUserConnectionStatusChange,new r.UserConnectionStatusEventArgs(t.id,e))}static getUniqueTranslationKeys(t=!1,...e){return d.getCommonI18nKeys(t,...e)}}e.BaseLayer=g},function(t,e){var i,n,o=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:s}catch(t){i=s}try{n="function"==typeof clearTimeout?clearTimeout:r}catch(t){n=r}}();var c,l=[],d=!1,h=-1;function u(){d&&c&&(d=!1,c.length?l=c.concat(l):h=-1,l.length&&p())}function p(){if(!d){var t=a(u);d=!0;for(var e=l.length;e;){for(c=l,l=[];++h<e;)c&&c[h].run();h=-1,e=l.length}c=null,d=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===r||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function g(t,e){this.fun=t,this.array=e}function m(){}o.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];l.push(new g(t,e)),1!==l.length||d||a(p)},g.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=m,o.addListener=m,o.once=m,o.off=m,o.removeListener=m,o.removeAllListeners=m,o.emit=m,o.prependListener=m,o.prependOnceListener=m,o.listeners=function(t){return[]},o.binding=function(t){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(t){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(t,e,i){"use strict";e.byteLength=function(t){var e=l(t),i=e[0],n=e[1];return 3*(i+n)/4-n},e.toByteArray=function(t){for(var e,i=l(t),n=i[0],r=i[1],a=new s(3*(n+r)/4-r),c=0,d=r>0?n-4:n,h=0;h<d;h+=4)e=o[t.charCodeAt(h)]<<18|o[t.charCodeAt(h+1)]<<12|o[t.charCodeAt(h+2)]<<6|o[t.charCodeAt(h+3)],a[c++]=e>>16&255,a[c++]=e>>8&255,a[c++]=255&e;return 2===r&&(e=o[t.charCodeAt(h)]<<2|o[t.charCodeAt(h+1)]>>4,a[c++]=255&e),1===r&&(e=o[t.charCodeAt(h)]<<10|o[t.charCodeAt(h+1)]<<4|o[t.charCodeAt(h+2)]>>2,a[c++]=e>>8&255,a[c++]=255&e),a},e.fromByteArray=function(t){for(var e,i=t.length,o=i%3,s=[],r=0,a=i-o;r<a;r+=16383)s.push(h(t,r,r+16383>a?a:r+16383));return 1===o?(e=t[i-1],s.push(n[e>>2]+n[e<<4&63]+"==")):2===o&&(e=(t[i-2]<<8)+t[i-1],s.push(n[e>>10]+n[e>>4&63]+n[e<<2&63]+"=")),s.join("")};for(var n=[],o=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,c=r.length;a<c;++a)n[a]=r[a],o[r.charCodeAt(a)]=a;function l(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=t.indexOf("=");return-1===i&&(i=e),[i,i===e?0:4-i%4]}function d(t){return n[t>>18&63]+n[t>>12&63]+n[t>>6&63]+n[63&t]}function h(t,e,i){for(var n,o=[],s=e;s<i;s+=3)n=(t[s]<<16&16711680)+(t[s+1]<<8&65280)+(255&t[s+2]),o.push(d(n));return o.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63},function(t,e){e.read=function(t,e,i,n,o){var s,r,a=8*o-n-1,c=(1<<a)-1,l=c>>1,d=-7,h=i?o-1:0,u=i?-1:1,p=t[e+h];for(h+=u,s=p&(1<<-d)-1,p>>=-d,d+=a;d>0;s=256*s+t[e+h],h+=u,d-=8);for(r=s&(1<<-d)-1,s>>=-d,d+=n;d>0;r=256*r+t[e+h],h+=u,d-=8);if(0===s)s=1-l;else{if(s===c)return r?NaN:1/0*(p?-1:1);r+=Math.pow(2,n),s-=l}return(p?-1:1)*r*Math.pow(2,s-n)},e.write=function(t,e,i,n,o,s){var r,a,c,l=8*s-o-1,d=(1<<l)-1,h=d>>1,u=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:s-1,g=n?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,r=d):(r=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-r))<1&&(r--,c*=2),(e+=r+h>=1?u/c:u*Math.pow(2,1-h))*c>=2&&(r++,c/=2),r+h>=d?(a=0,r=d):r+h>=1?(a=(e*c-1)*Math.pow(2,o),r+=h):(a=e*Math.pow(2,h-1)*Math.pow(2,o),r=0));o>=8;t[i+p]=255&a,p+=g,a/=256,o-=8);for(r=r<<o|a,l+=o;l>0;t[i+p]=255&r,p+=g,r/=256,l-=8);t[i+p-g]|=128*m}},function(t,e){var i={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==i.call(t)}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{constructor(t,e,i,n=!0){this._id=null,this._timeout=-1,this._startTime=-1,this._totalTimeRun=-1,this._complete=!1,this._duration=-1,this._callback=null,this._paused=!1,this._pauseable=!1,this._id=t,this._duration=i,this._callback=e,this._startTime=(new Date).getTime(),this._timeout=setTimeout(this._callback,this._duration),this._pauseable=!1!==n}_timeDiff(t){return(new Date).getTime()-t}cancel(){clearTimeout(this._timeout),this._paused=!1}pause(){clearTimeout(this._timeout),this._totalTimeRun=this._timeDiff(this._startTime),this._complete=this._totalTimeRun>=this._duration,this._complete||(this._paused=!0)}resume(){this._paused=!1,this._timeout=this._complete?-1:setTimeout(this._callback,this._duration-this._totalTimeRun)}end(){this._paused=!1,clearTimeout(this._timeout),this._callback()}restart(){this._paused=!1,this._startTime=(new Date).getTime(),this._timeout=setTimeout(this._callback,this._duration)}get paused(){return this._paused}get pauseable(){return this._pauseable}get id(){return this._id}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(80),o=i(32);e.UsersDirectory=class{constructor(t,e=!1){this._instanceId=null,this._worker=null,this._debug=!1,this._db=null,this._dbName=null,this.initialised=!1,this._workerResponseListeners={},this._instanceId=t,this._debug=e,this._dbName=`${t}_user_index`}_onWorkerResponse(t){if(t.data&&this._debug,t.data._id){const e=this._workerResponseListeners[t.data._id];if(!e)return;!0!==e(t.data)&&delete this._workerResponseListeners[t.data._id]}else switch(t.data.action){case"store-record":const e=this._db.transaction([this._dbName],"readwrite");e.oncomplete=(()=>{this._postMessageToWorker({action:"store-record-response",success:!0,key:t.data.key})}),e.onerror=(e=>{console.error(`Failed to put '${t.data.key}'.`),this._postMessageToWorker({key:t.data.key,action:"store-record-response",success:!1,msg:e.toString()})}),e.objectStore(this._dbName).put(t.data.record,t.data.key);break;case"retrieve-record":const i=this._db.transaction([this._dbName]).objectStore(this._dbName).get(t.data.key);i.onsuccess=(()=>{this._postMessageToWorker({action:"retrieve-record-response",success:!0,key:t.data.key,record:i.result})}),i.onerror=(e=>{console.error(`Failed to get ${t.data.key}:`,e),this._postMessageToWorker({key:t.data.key,action:"retrieve-record-response",success:!1,msg:e.toString(),record:null})})}}_postMessageToWorker(t,e){if(null===this._worker)throw new Error("Worker has not been initialised!");const i=o.generateGuid();e&&(this._workerResponseListeners[i]=e),this._worker.postMessage(Object.assign({},t,{_id:i}))}initialise(t,e){return new Promise((i,o)=>{const s=indexedDB.open(this._dbName);s.onupgradeneeded=(t=>{t.target.result.createObjectStore(this._dbName)}),s.onerror=(t=>{console.error("Couldn't open IndexedDB database.",t)}),s.onsuccess=(s=>{this._db=s.target.result,this._worker=new Worker(window.URL.createObjectURL(new Blob([`const start = ${n.default.toString()}; start.call(self);`],{type:"text/javascript"}))),this._worker.onmessage=this._onWorkerResponse.bind(this),this._postMessageToWorker({action:"initialise",instanceId:this._instanceId,key:t,iv:e,debug:this._debug},t=>(!0===t.success?(this.initialised=!0,i(t.msg)):(console.error(t.msg),this.initialised=!1,this.destroy(!0).then(()=>{o(t.msg)})),!1))})})}update(t,e,i){if(!0!==this.initialised)throw new Error("User index must be initialised first.");return new Promise((n,o)=>{this._postMessageToWorker({action:"fetch",endpoint:i,jid:t,pass:e},t=>(!0===t.success?n(t):(console.error(t.msg),o(t.msg)),!1))})}search(t,e){if(!0!==this.initialised)throw new Error("User index must be initialised first.");return new Promise((i,n)=>{this._postMessageToWorker({action:"search",query:t,fields:e||[]},t=>(!0===t.success?i(t.results):(console.error(t.msg),n(t.msg)),!1))})}getUserByJid(t){if(!0!==this.initialised)throw new Error("User index must be initialised first.");return new Promise((e,i)=>{this._postMessageToWorker({action:"jid-search",jid:t},t=>(!0===t.success?e(t.result):(console.error(t.msg),i(t.msg)),!1))})}getAllUsers(t=!1){if(!0!==this.initialised)throw new Error("User index must be initialised first.");return new Promise((e,i)=>{this._postMessageToWorker({action:"get-all-users"},n=>(!0===n.success?e(t?n.results.filter(t=>!t.deleted):n.results):(console.error(n.msg),i(n.msg)),!1))})}destroy(t=!1){if(!0!==this.initialised&&!1===t)throw new Error("User index must be initialised first.");return new Promise((t,e)=>{this._db.close();const i=indexedDB.deleteDatabase(this._dbName);i.onerror=(t=>{e("Error deleting user directory database.")}),i.onsuccess=(()=>{this._db=null,this.initialised=!1,t()}),i.onblocked=(()=>{e("Couldn't delete user directory database due to the operation being blocked.")})})}static _resolvePath(t){return t?0===t.indexOf("http")||0===t.indexOf("//")?t:0===t.indexOf("/")?window.location.origin+t:`${window.location.origin}/${t}`:null}}},function(t,e,i){"use strict";function n(){let t=!1,e=null,n="lunr_index",o="idxBlock",s="docBlock";const r=function(){var t=function(e){var i=new t.Index;return i.pipeline.add(t.trimmer,t.stopWordFilter,t.stemmer),e&&e.call(i,i),i};return t.version="0.9.5",lunr=t,t.utils={},t.utils.warn=function(t){return function(e){t.console&&console.warn&&console.warn(e)}}(this),t.utils.toString=function(t){return null==t?"":t.toString()},t.EventEmitter=function(){this.events={}},t.EventEmitter.prototype.addListener=function(){var t=Array.prototype.slice.call(arguments),e=t.pop(),i=t;if("function"!=typeof e)throw new TypeError("last argument must be a function");i.forEach(function(t){this.hasHandler(t)||(this.events[t]=[]),this.events[t].push(e)},this)},t.EventEmitter.prototype.removeListener=function(t,e){if(this.hasHandler(t)){var i=this.events[t].indexOf(e);-1!==i&&(this.events[t].splice(i,1),0==this.events[t].length&&delete this.events[t])}},t.EventEmitter.prototype.emit=function(t){if(this.hasHandler(t)){var e=Array.prototype.slice.call(arguments,1);this.events[t].forEach(function(t){t.apply(void 0,e)},this)}},t.EventEmitter.prototype.hasHandler=function(t){return t in this.events},t.tokenizer=function(e){if(!arguments.length||null==e)return[];if(Array.isArray(e)){var i=e.filter(function(t){return null!=t}),n=[];return(i=i.map(function(e){return t.utils.toString(e).toLowerCase()})).forEach(function(e){var i=e.split(t.tokenizer.seperator);n=n.concat(i)},this),n}return e.toString().trim().toLowerCase().split(t.tokenizer.seperator)},t.tokenizer.defaultSeperator=/[\s\-]+/,t.tokenizer.seperator=t.tokenizer.defaultSeperator,t.tokenizer.setSeperator=function(e){null!=e&&"object"==typeof e&&(t.tokenizer.seperator=e)},t.tokenizer.resetSeperator=function(){t.tokenizer.seperator=t.tokenizer.defaultSeperator},t.tokenizer.getSeperator=function(){return t.tokenizer.seperator},t.Pipeline=function(){this._queue=[]},t.Pipeline.registeredFunctions={},t.Pipeline.registerFunction=function(e,i){i in t.Pipeline.registeredFunctions&&t.utils.warn("Overwriting existing registered function: "+i),e.label=i,t.Pipeline.registeredFunctions[i]=e},t.Pipeline.getRegisteredFunction=function(e){return e in t.Pipeline.registeredFunctions!=1?null:t.Pipeline.registeredFunctions[e]},t.Pipeline.warnIfFunctionNotRegistered=function(e){e.label&&e.label in this.registeredFunctions||t.utils.warn("Function is not registered with pipeline. This may cause problems when serialising the index.\n",e)},t.Pipeline.load=function(e){var i=new t.Pipeline;return e.forEach(function(e){var n=t.Pipeline.getRegisteredFunction(e);if(!n)throw new Error("Cannot load un-registered function: "+e);i.add(n)}),i},t.Pipeline.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(e){t.Pipeline.warnIfFunctionNotRegistered(e),this._queue.push(e)},this)},t.Pipeline.prototype.after=function(e,i){t.Pipeline.warnIfFunctionNotRegistered(i);var n=this._queue.indexOf(e);if(-1===n)throw new Error("Cannot find existingFn");this._queue.splice(n+1,0,i)},t.Pipeline.prototype.before=function(e,i){t.Pipeline.warnIfFunctionNotRegistered(i);var n=this._queue.indexOf(e);if(-1===n)throw new Error("Cannot find existingFn");this._queue.splice(n,0,i)},t.Pipeline.prototype.remove=function(t){var e=this._queue.indexOf(t);-1!==e&&this._queue.splice(e,1)},t.Pipeline.prototype.run=function(t){for(var e=[],i=t.length,n=this._queue.length,o=0;o<i;o++){for(var s=t[o],r=0;r<n&&void 0!==(s=this._queue[r](s,o,t))&&null!==s;r++);null!=s&&e.push(s)}return e},t.Pipeline.prototype.reset=function(){this._queue=[]},t.Pipeline.prototype.get=function(){return this._queue},t.Pipeline.prototype.toJSON=function(){return this._queue.map(function(e){return t.Pipeline.warnIfFunctionNotRegistered(e),e.label})},t.Index=function(){this._fields=[],this._ref="id",this.pipeline=new t.Pipeline,this.documentStore=new t.DocumentStore,this.index={},this.eventEmitter=new t.EventEmitter,this._idfCache={},this.on("add","remove","update",function(){this._idfCache={}}.bind(this))},t.Index.prototype.on=function(){var t=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,t)},t.Index.prototype.off=function(t,e){return this.eventEmitter.removeListener(t,e)},t.Index.load=function(e){e.version!==t.version&&t.utils.warn("version mismatch: current "+t.version+" importing "+e.version);var i=new this;for(var n in i._fields=e.fields,i._ref=e.ref,i.documentStore=t.DocumentStore.load(e.documentStore),i.pipeline=t.Pipeline.load(e.pipeline),i.index={},e.index)i.index[n]=t.InvertedIndex.load(e.index[n]);return i},t.Index.prototype.addField=function(e){return this._fields.push(e),this.index[e]=new t.InvertedIndex,this},t.Index.prototype.setRef=function(t){return this._ref=t,this},t.Index.prototype.saveDocument=function(e){return this.documentStore=new t.DocumentStore(e),this},t.Index.prototype.addDoc=function(e,i){if(e){i=void 0===i||i;var n=e[this._ref];this.documentStore.addDoc(n,e),this._fields.forEach(function(i){var o=this.pipeline.run(t.tokenizer(e[i]));this.documentStore.addFieldLength(n,i,o.length);var s={};for(var r in o.forEach(function(t){t in s?s[t]+=1:s[t]=1},this),s){var a=s[r];a=Math.sqrt(a),this.index[i].addToken(r,{ref:n,tf:a})}},this),i&&this.eventEmitter.emit("add",e,this)}},t.Index.prototype.removeDocByRef=function(t,e){if(t&&!1!==this.documentStore.isDocStored()&&this.documentStore.hasDoc(t)){var i=this.documentStore.getDoc(t);this.removeDoc(i,!1)}},t.Index.prototype.removeDoc=function(e,i){if(e){i=void 0===i||i;var n=e[this._ref];this.documentStore.hasDoc(n)&&(this.documentStore.removeDoc(n),this._fields.forEach(function(i){this.pipeline.run(t.tokenizer(e[i])).forEach(function(t){this.index[i].removeToken(t,n)},this)},this),i&&this.eventEmitter.emit("remove",e,this))}},t.Index.prototype.updateDoc=function(t,e){e=void 0===e||e,this.removeDocByRef(t[this._ref],!1),this.addDoc(t,!1),e&&this.eventEmitter.emit("update",t,this)},t.Index.prototype.idf=function(t,e){var i="@"+e+"/"+t;if(Object.prototype.hasOwnProperty.call(this._idfCache,i))return this._idfCache[i];var n=this.index[e].getDocFreq(t),o=1+Math.log(this.documentStore.length/(n+1));return this._idfCache[i]=o,o},t.Index.prototype.getFields=function(){return this._fields.slice()},t.Index.prototype.search=function(e,i){if(!e)return[];e="string"==typeof e?{any:e}:JSON.parse(JSON.stringify(e));var n=null;null!=i&&(n=JSON.stringify(i));for(var o=new t.Configuration(n,this.getFields()).get(),s={},r=Object.keys(e),a=0;a<r.length;a++){var c=r[a];s[c]=this.pipeline.run(t.tokenizer(e[c]))}var l={};for(var d in o){var h=s[d]||s.any;if(h){var u=this.fieldSearch(h,d,o),p=o[d].boost;for(var g in u)u[g]=u[g]*p;for(var g in u)g in l?l[g]+=u[g]:l[g]=u[g]}}var m,f=[];for(var g in l)m={ref:g,score:l[g]},this.documentStore.hasDoc(g)&&(m.doc=this.documentStore.getDoc(g)),f.push(m);return f.sort(function(t,e){return e.score-t.score}),f},t.Index.prototype.fieldSearch=function(t,e,i){var n=i[e].bool,o=i[e].expand,s=null,r={};if(0!==i[e].boost)return t.forEach(function(t){var i=[t];1==o&&(i=this.index[e].expandToken(t));var a={};i.forEach(function(i){var o=this.index[e].getDocs(i),c=this.idf(i,e);if(s&&"AND"==n){var l={};for(var d in s)d in o&&(l[d]=o[d]);o=l}for(var d in i==t&&this.fieldSearchStats(r,i,o),o){var h=this.index[e].getTermFrequency(i,d),u=this.documentStore.getFieldLength(d,e),p=1;0!=u&&(p=1/Math.sqrt(u));var g=1;i!=t&&(g=.15*(1-(i.length-t.length)/i.length));var m=h*c*p*g;d in a?a[d]+=m:a[d]=m}},this),s=this.mergeScores(s,a,n)},this),s=this.coordNorm(s,r,t.length)},t.Index.prototype.mergeScores=function(t,e,i){if(!t)return e;if("AND"==i){var n={};for(var o in e)o in t&&(n[o]=t[o]+e[o]);return n}for(var o in e)o in t?t[o]+=e[o]:t[o]=e[o];return t},t.Index.prototype.fieldSearchStats=function(t,e,i){for(var n in i)n in t?t[n].push(e):t[n]=[e]},t.Index.prototype.coordNorm=function(t,e,i){for(var n in t)if(n in e){var o=e[n].length;t[n]=t[n]*o/i}return t},t.Index.prototype.toJSON=function(){var e={};return this._fields.forEach(function(t){e[t]=this.index[t].toJSON()},this),{version:t.version,fields:this._fields,ref:this._ref,documentStore:this.documentStore.toJSON(),index:e,pipeline:this.pipeline.toJSON()}},t.Index.prototype.use=function(t){var e=Array.prototype.slice.call(arguments,1);e.unshift(this),t.apply(this,e)},t.DocumentStore=function(t){this._save=null==t||t,this.docs={},this.docInfo={},this.length=0},t.DocumentStore.load=function(t){var e=new this;return e.length=t.length,e.docs=t.docs,e.docInfo=t.docInfo,e._save=t.save,e},t.DocumentStore.prototype.isDocStored=function(){return this._save},t.DocumentStore.prototype.addDoc=function(t,e){this.hasDoc(t)||this.length++,!0===this._save?this.docs[t]=function(t){if(null===t||"object"!=typeof t)return t;var e=t.constructor();for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e}(e):this.docs[t]=null},t.DocumentStore.prototype.getDoc=function(t){return!1===this.hasDoc(t)?null:this.docs[t]},t.DocumentStore.prototype.hasDoc=function(t){return t in this.docs},t.DocumentStore.prototype.removeDoc=function(t){this.hasDoc(t)&&(delete this.docs[t],delete this.docInfo[t],this.length--)},t.DocumentStore.prototype.addFieldLength=function(t,e,i){null!=t&&0!=this.hasDoc(t)&&(this.docInfo[t]||(this.docInfo[t]={}),this.docInfo[t][e]=i)},t.DocumentStore.prototype.updateFieldLength=function(t,e,i){null!=t&&0!=this.hasDoc(t)&&this.addFieldLength(t,e,i)},t.DocumentStore.prototype.getFieldLength=function(t,e){return null==t?0:t in this.docs&&e in this.docInfo[t]?this.docInfo[t][e]:0},t.DocumentStore.prototype.toJSON=function(){return{docs:this.docs,docInfo:this.docInfo,length:this.length,save:this._save}},t.stemmer=function(){var t={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},e={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},i="[aeiouy]",n="[^aeiou][^aeiouy]*",o=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*"),s=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*[aeiouy][aeiou]*[^aeiou][^aeiouy]*"),r=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy][aeiou]*[^aeiou][^aeiouy]*([aeiouy][aeiou]*)?$"),a=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy]"),c=/^(.+?)(ss|i)es$/,l=/^(.+?)([^s])s$/,d=/^(.+?)eed$/,h=/^(.+?)(ed|ing)$/,u=/.$/,p=/(at|bl|iz)$/,g=new RegExp("([^aeiouylsz])\\1$"),m=new RegExp("^"+n+i+"[^aeiouwxy]$"),f=/^(.+?[^aeiou])y$/,_=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,v=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,y=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,C=/^(.+?)(s|t)(ion)$/,b=/^(.+?)e$/,w=/ll$/,T=new RegExp("^"+n+i+"[^aeiouwxy]$");return function(i){var n,E,S,R,A,I,x;if(i.length<3)return i;if("y"==(S=i.substr(0,1))&&(i=S.toUpperCase()+i.substr(1)),A=l,(R=c).test(i)?i=i.replace(R,"$1$2"):A.test(i)&&(i=i.replace(A,"$1$2")),A=h,(R=d).test(i)){var M=R.exec(i);(R=o).test(M[1])&&(R=u,i=i.replace(R,""))}else A.test(i)&&(n=(M=A.exec(i))[1],(A=a).test(n)&&(I=g,x=m,(A=p).test(i=n)?i+="e":I.test(i)?(R=u,i=i.replace(R,"")):x.test(i)&&(i+="e")));return(R=f).test(i)&&(i=(n=(M=R.exec(i))[1])+"i"),(R=_).test(i)&&(n=(M=R.exec(i))[1],E=M[2],(R=o).test(n)&&(i=n+t[E])),(R=v).test(i)&&(n=(M=R.exec(i))[1],E=M[2],(R=o).test(n)&&(i=n+e[E])),A=C,(R=y).test(i)?(n=(M=R.exec(i))[1],(R=s).test(n)&&(i=n)):A.test(i)&&(n=(M=A.exec(i))[1]+M[2],(A=s).test(n)&&(i=n)),(R=b).test(i)&&(n=(M=R.exec(i))[1],A=r,I=T,((R=s).test(n)||A.test(n)&&!I.test(n))&&(i=n)),A=s,(R=w).test(i)&&A.test(i)&&(R=u,i=i.replace(R,"")),"y"==S&&(i=S.toLowerCase()+i.substr(1)),i}}(),t.Pipeline.registerFunction(t.stemmer,"stemmer"),t.stopWordFilter=function(e){if(e&&!0!==t.stopWordFilter.stopWords[e])return e},t.clearStopWords=function(){t.stopWordFilter.stopWords={}},t.addStopWords=function(e){null!=e&&!1!==Array.isArray(e)&&e.forEach(function(e){t.stopWordFilter.stopWords[e]=!0},this)},t.resetStopWords=function(){t.stopWordFilter.stopWords=t.defaultStopWords},t.defaultStopWords={"":!0,a:!0,able:!0,about:!0,across:!0,after:!0,all:!0,almost:!0,also:!0,am:!0,among:!0,an:!0,and:!0,any:!0,are:!0,as:!0,at:!0,be:!0,because:!0,been:!0,but:!0,by:!0,can:!0,cannot:!0,could:!0,dear:!0,did:!0,do:!0,does:!0,either:!0,else:!0,ever:!0,every:!0,for:!0,from:!0,get:!0,got:!0,had:!0,has:!0,have:!0,he:!0,her:!0,hers:!0,him:!0,his:!0,how:!0,however:!0,i:!0,if:!0,in:!0,into:!0,is:!0,it:!0,its:!0,just:!0,least:!0,let:!0,like:!0,likely:!0,may:!0,me:!0,might:!0,most:!0,must:!0,my:!0,neither:!0,no:!0,nor:!0,not:!0,of:!0,off:!0,often:!0,on:!0,only:!0,or:!0,other:!0,our:!0,own:!0,rather:!0,said:!0,say:!0,says:!0,she:!0,should:!0,since:!0,so:!0,some:!0,than:!0,that:!0,the:!0,their:!0,them:!0,then:!0,there:!0,these:!0,they:!0,this:!0,tis:!0,to:!0,too:!0,twas:!0,us:!0,wants:!0,was:!0,we:!0,were:!0,what:!0,when:!0,where:!0,which:!0,while:!0,who:!0,whom:!0,why:!0,will:!0,with:!0,would:!0,yet:!0,you:!0,your:!0},t.stopWordFilter.stopWords=t.defaultStopWords,t.Pipeline.registerFunction(t.stopWordFilter,"stopWordFilter"),t.trimmer=function(t){if(null==t)throw new Error("token should not be undefined");return t.replace(/^\W+/,"").replace(/\W+$/,"")},t.Pipeline.registerFunction(t.trimmer,"trimmer"),t.InvertedIndex=function(){this.root={docs:{},df:0}},t.InvertedIndex.load=function(t){var e=new this;return e.root=t.root,e},t.InvertedIndex.prototype.addToken=function(t,e,i){i=i||this.root;for(var n=0;n<=t.length-1;){var o=t[n];o in i||(i[o]={docs:{},df:0}),n+=1,i=i[o]}var s=e.ref;i.docs[s]?i.docs[s]={tf:e.tf}:(i.docs[s]={tf:e.tf},i.df+=1)},t.InvertedIndex.prototype.hasToken=function(t){if(!t)return!1;for(var e=this.root,i=0;i<t.length;i++){if(!e[t[i]])return!1;e=e[t[i]]}return!0},t.InvertedIndex.prototype.getNode=function(t){if(!t)return null;for(var e=this.root,i=0;i<t.length;i++){if(!e[t[i]])return null;e=e[t[i]]}return e},t.InvertedIndex.prototype.getDocs=function(t){var e=this.getNode(t);return null==e?{}:e.docs},t.InvertedIndex.prototype.getTermFrequency=function(t,e){var i=this.getNode(t);return null==i?0:e in i.docs?i.docs[e].tf:0},t.InvertedIndex.prototype.getDocFreq=function(t){var e=this.getNode(t);return null==e?0:e.df},t.InvertedIndex.prototype.removeToken=function(t,e){if(t){var i=this.getNode(t);null!=i&&e in i.docs&&(delete i.docs[e],i.df-=1)}},t.InvertedIndex.prototype.expandToken=function(t,e,i){if(null==t||""==t)return[];if(e=e||[],null==i&&null==(i=this.getNode(t)))return e;for(var n in i.df>0&&e.push(t),i)"docs"!==n&&"df"!==n&&this.expandToken(t+n,e,i[n]);return e},t.InvertedIndex.prototype.toJSON=function(){return{root:this.root}},t.Configuration=function(e,i){var n;if(e=e||"",null==i||null==i)throw new Error("fields should not be null");this.config={};try{n=JSON.parse(e),this.buildUserConfig(n,i)}catch(e){t.utils.warn("user configuration parse failed, will use default configuration"),this.buildDefaultConfig(i)}},t.Configuration.prototype.buildDefaultConfig=function(t){this.reset(),t.forEach(function(t){this.config[t]={boost:1,bool:"OR",expand:!1}},this)},t.Configuration.prototype.buildUserConfig=function(e,i){var n="OR",o=!1;if(this.reset(),"bool"in e&&(n=e.bool||n),"expand"in e&&(o=e.expand||o),"fields"in e)for(var s in e.fields)if(i.indexOf(s)>-1){var r=e.fields[s],a=o;null!=r.expand&&(a=r.expand),this.config[s]={boost:r.boost||0===r.boost?r.boost:1,bool:r.bool||n,expand:a}}else t.utils.warn("field name in user configuration not found in index instance fields");else this.addAllFields2UserConfig(n,o,i)},t.Configuration.prototype.addAllFields2UserConfig=function(t,e,i){i.forEach(function(i){this.config[i]={boost:1,bool:t,expand:e}},this)},t.Configuration.prototype.get=function(){return this.config},t.Configuration.prototype.reset=function(){this.config={}},lunr.SortedSet=function(){this.length=0,this.elements=[]},lunr.SortedSet.load=function(t){var e=new this;return e.elements=t,e.length=t.length,e},lunr.SortedSet.prototype.add=function(){var t,e;for(t=0;t<arguments.length;t++)e=arguments[t],~this.indexOf(e)||this.elements.splice(this.locationFor(e),0,e);this.length=this.elements.length},lunr.SortedSet.prototype.toArray=function(){return this.elements.slice()},lunr.SortedSet.prototype.map=function(t,e){return this.elements.map(t,e)},lunr.SortedSet.prototype.forEach=function(t,e){return this.elements.forEach(t,e)},lunr.SortedSet.prototype.indexOf=function(t){for(var e=0,i=this.elements.length,n=i-e,o=e+Math.floor(n/2),s=this.elements[o];n>1;){if(s===t)return o;s<t&&(e=o),s>t&&(i=o),n=i-e,o=e+Math.floor(n/2),s=this.elements[o]}return s===t?o:-1},lunr.SortedSet.prototype.locationFor=function(t){for(var e=0,i=this.elements.length,n=i-e,o=e+Math.floor(n/2),s=this.elements[o];n>1;)s<t&&(e=o),s>t&&(i=o),n=i-e,o=e+Math.floor(n/2),s=this.elements[o];return s>t?o:s<t?o+1:void 0},lunr.SortedSet.prototype.intersect=function(t){for(var e=new lunr.SortedSet,i=0,n=0,o=this.length,s=t.length,r=this.elements,a=t.elements;!(i>o-1||n>s-1);)r[i]!==a[n]?r[i]<a[n]?i++:r[i]>a[n]&&n++:(e.add(r[i]),i++,n++);return e},lunr.SortedSet.prototype.clone=function(){var t=new lunr.SortedSet;return t.elements=this.toArray(),t.length=t.elements.length,t},lunr.SortedSet.prototype.union=function(t){var e,i,n;this.length>=t.length?(e=this,i=t):(e=t,i=this),n=e.clone();for(var o=0,s=i.toArray();o<s.length;o++)n.add(s[o]);return n},lunr.SortedSet.prototype.toJSON=function(){return this.toArray()},t}();let a=!0;const c=new Map;let l="pureJs";self.onmessage=function(d){switch(d.data.action){case"initialise":const m=()=>{t=!0,self.postMessage({_id:d.data._id,action:"initialisation-complete",success:!0,msg:"Successfully initialised the user index."})},f=t=>{self.postMessage({_id:d.data._id,action:"initialisation-complete",success:!1,msg:t})};if(!d.data.instanceId)return void f("Error initialising user index database.");a=!0===d.data.debug,this._blockSize=d.data.blockSize||this._blockSize,new Promise((t,e)=>{g(l).then(e=>{if(void 0===e){const e=void 0===self.crypto.subtle;p(l,e).then(()=>{t(e)})}else t(e)})}).then(t=>{t?(function(){!function(t){function e(t){return parseInt(t)===t}function n(t){if(!e(t.length))return!1;for(var i=0;i<t.length;i++)if(!e(t[i])||t[i]<0||t[i]>255)return!1;return!0}function o(t,i){if(t.buffer&&ArrayBuffer.isView(t)&&"Uint8Array"===t.name)return i&&(t=t.slice?t.slice():Array.prototype.slice.call(t)),t;if(Array.isArray(t)){if(!n(t))throw new Error("Array contains invalid value: "+t);return new Uint8Array(t)}if(e(t.length)&&n(t))return new Uint8Array(t);throw new Error("unsupported array-like object")}function s(t){return new Uint8Array(t)}function r(t,e,i,n,o){null==n&&null==o||(t=t.slice?t.slice(n,o):Array.prototype.slice.call(t,n,o)),e.set(t,i)}var a={toBytes:function(t){var e=[],i=0;for(t=encodeURI(t);i<t.length;){var n=t.charCodeAt(i++);37===n?(e.push(parseInt(t.substr(i,2),16)),i+=2):e.push(n)}return o(e)},fromBytes:function(t){for(var e=[],i=0;i<t.length;){var n=t[i];n<128?(e.push(String.fromCharCode(n)),i++):n>191&&n<224?(e.push(String.fromCharCode((31&n)<<6|63&t[i+1])),i+=2):(e.push(String.fromCharCode((15&n)<<12|(63&t[i+1])<<6|63&t[i+2])),i+=3)}return e.join("")}},c=function(){var t="0123456789abcdef";return{toBytes:function(t){for(var e=[],i=0;i<t.length;i+=2)e.push(parseInt(t.substr(i,2),16));return e},fromBytes:function(e){for(var i=[],n=0;n<e.length;n++){var o=e[n];i.push(t[(240&o)>>4]+t[15&o])}return i.join("")}}}(),l={16:10,24:12,32:14},d=[1,2,4,8,16,32,64,128,27,54,108,216,171,77,154,47,94,188,99,198,151,53,106,212,179,125,250,239,197,145],h=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],u=[82,9,106,213,48,54,165,56,191,64,163,158,129,243,215,251,124,227,57,130,155,47,255,135,52,142,67,68,196,222,233,203,84,123,148,50,166,194,35,61,238,76,149,11,66,250,195,78,8,46,161,102,40,217,36,178,118,91,162,73,109,139,209,37,114,248,246,100,134,104,152,22,212,164,92,204,93,101,182,146,108,112,72,80,253,237,185,218,94,21,70,87,167,141,157,132,144,216,171,0,140,188,211,10,247,228,88,5,184,179,69,6,208,44,30,143,202,63,15,2,193,175,189,3,1,19,138,107,58,145,17,65,79,103,220,234,151,242,207,206,240,180,230,115,150,172,116,34,231,173,53,133,226,249,55,232,28,117,223,110,71,241,26,113,29,41,197,137,111,183,98,14,170,24,190,27,252,86,62,75,198,210,121,32,154,219,192,254,120,205,90,244,31,221,168,51,136,7,199,49,177,18,16,89,39,128,236,95,96,81,127,169,25,181,74,13,45,229,122,159,147,201,156,239,160,224,59,77,174,42,245,176,200,235,187,60,131,83,153,97,23,43,4,126,186,119,214,38,225,105,20,99,85,33,12,125],p=[3328402341,4168907908,4000806809,4135287693,4294111757,3597364157,3731845041,2445657428,1613770832,33620227,3462883241,1445669757,3892248089,3050821474,1303096294,3967186586,2412431941,528646813,2311702848,4202528135,4026202645,2992200171,2387036105,4226871307,1101901292,3017069671,1604494077,1169141738,597466303,1403299063,3832705686,2613100635,1974974402,3791519004,1033081774,1277568618,1815492186,2118074177,4126668546,2211236943,1748251740,1369810420,3521504564,4193382664,3799085459,2883115123,1647391059,706024767,134480908,2512897874,1176707941,2646852446,806885416,932615841,168101135,798661301,235341577,605164086,461406363,3756188221,3454790438,1311188841,2142417613,3933566367,302582043,495158174,1479289972,874125870,907746093,3698224818,3025820398,1537253627,2756858614,1983593293,3084310113,2108928974,1378429307,3722699582,1580150641,327451799,2790478837,3117535592,0,3253595436,1075847264,3825007647,2041688520,3059440621,3563743934,2378943302,1740553945,1916352843,2487896798,2555137236,2958579944,2244988746,3151024235,3320835882,1336584933,3992714006,2252555205,2588757463,1714631509,293963156,2319795663,3925473552,67240454,4269768577,2689618160,2017213508,631218106,1269344483,2723238387,1571005438,2151694528,93294474,1066570413,563977660,1882732616,4059428100,1673313503,2008463041,2950355573,1109467491,537923632,3858759450,4260623118,3218264685,2177748300,403442708,638784309,3287084079,3193921505,899127202,2286175436,773265209,2479146071,1437050866,4236148354,2050833735,3362022572,3126681063,840505643,3866325909,3227541664,427917720,2655997905,2749160575,1143087718,1412049534,999329963,193497219,2353415882,3354324521,1807268051,672404540,2816401017,3160301282,369822493,2916866934,3688947771,1681011286,1949973070,336202270,2454276571,201721354,1210328172,3093060836,2680341085,3184776046,1135389935,3294782118,965841320,831886756,3554993207,4068047243,3588745010,2345191491,1849112409,3664604599,26054028,2983581028,2622377682,1235855840,3630984372,2891339514,4092916743,3488279077,3395642799,4101667470,1202630377,268961816,1874508501,4034427016,1243948399,1546530418,941366308,1470539505,1941222599,2546386513,3421038627,2715671932,3899946140,1042226977,2521517021,1639824860,227249030,260737669,3765465232,2084453954,1907733956,3429263018,2420656344,100860677,4160157185,470683154,3261161891,1781871967,2924959737,1773779408,394692241,2579611992,974986535,664706745,3655459128,3958962195,731420851,571543859,3530123707,2849626480,126783113,865375399,765172662,1008606754,361203602,3387549984,2278477385,2857719295,1344809080,2782912378,59542671,1503764984,160008576,437062935,1707065306,3622233649,2218934982,3496503480,2185314755,697932208,1512910199,504303377,2075177163,2824099068,1841019862,739644986],g=[2781242211,2230877308,2582542199,2381740923,234877682,3184946027,2984144751,1418839493,1348481072,50462977,2848876391,2102799147,434634494,1656084439,3863849899,2599188086,1167051466,2636087938,1082771913,2281340285,368048890,3954334041,3381544775,201060592,3963727277,1739838676,4250903202,3930435503,3206782108,4149453988,2531553906,1536934080,3262494647,484572669,2923271059,1783375398,1517041206,1098792767,49674231,1334037708,1550332980,4098991525,886171109,150598129,2481090929,1940642008,1398944049,1059722517,201851908,1385547719,1699095331,1587397571,674240536,2704774806,252314885,3039795866,151914247,908333586,2602270848,1038082786,651029483,1766729511,3447698098,2682942837,454166793,2652734339,1951935532,775166490,758520603,3000790638,4004797018,4217086112,4137964114,1299594043,1639438038,3464344499,2068982057,1054729187,1901997871,2534638724,4121318227,1757008337,0,750906861,1614815264,535035132,3363418545,3988151131,3201591914,1183697867,3647454910,1265776953,3734260298,3566750796,3903871064,1250283471,1807470800,717615087,3847203498,384695291,3313910595,3617213773,1432761139,2484176261,3481945413,283769337,100925954,2180939647,4037038160,1148730428,3123027871,3813386408,4087501137,4267549603,3229630528,2315620239,2906624658,3156319645,1215313976,82966005,3747855548,3245848246,1974459098,1665278241,807407632,451280895,251524083,1841287890,1283575245,337120268,891687699,801369324,3787349855,2721421207,3431482436,959321879,1469301956,4065699751,2197585534,1199193405,2898814052,3887750493,724703513,2514908019,2696962144,2551808385,3516813135,2141445340,1715741218,2119445034,2872807568,2198571144,3398190662,700968686,3547052216,1009259540,2041044702,3803995742,487983883,1991105499,1004265696,1449407026,1316239930,504629770,3683797321,168560134,1816667172,3837287516,1570751170,1857934291,4014189740,2797888098,2822345105,2754712981,936633572,2347923833,852879335,1133234376,1500395319,3084545389,2348912013,1689376213,3533459022,3762923945,3034082412,4205598294,133428468,634383082,2949277029,2398386810,3913789102,403703816,3580869306,2297460856,1867130149,1918643758,607656988,4049053350,3346248884,1368901318,600565992,2090982877,2632479860,557719327,3717614411,3697393085,2249034635,2232388234,2430627952,1115438654,3295786421,2865522278,3633334344,84280067,33027830,303828494,2747425121,1600795957,4188952407,3496589753,2434238086,1486471617,658119965,3106381470,953803233,334231800,3005978776,857870609,3151128937,1890179545,2298973838,2805175444,3056442267,574365214,2450884487,550103529,1233637070,4289353045,2018519080,2057691103,2399374476,4166623649,2148108681,387583245,3664101311,836232934,3330556482,3100665960,3280093505,2955516313,2002398509,287182607,3413881008,4238890068,3597515707,975967766],m=[1671808611,2089089148,2006576759,2072901243,4061003762,1807603307,1873927791,3310653893,810573872,16974337,1739181671,729634347,4263110654,3613570519,2883997099,1989864566,3393556426,2191335298,3376449993,2106063485,4195741690,1508618841,1204391495,4027317232,2917941677,3563566036,2734514082,2951366063,2629772188,2767672228,1922491506,3227229120,3082974647,4246528509,2477669779,644500518,911895606,1061256767,4144166391,3427763148,878471220,2784252325,3845444069,4043897329,1905517169,3631459288,827548209,356461077,67897348,3344078279,593839651,3277757891,405286936,2527147926,84871685,2595565466,118033927,305538066,2157648768,3795705826,3945188843,661212711,2999812018,1973414517,152769033,2208177539,745822252,439235610,455947803,1857215598,1525593178,2700827552,1391895634,994932283,3596728278,3016654259,695947817,3812548067,795958831,2224493444,1408607827,3513301457,0,3979133421,543178784,4229948412,2982705585,1542305371,1790891114,3410398667,3201918910,961245753,1256100938,1289001036,1491644504,3477767631,3496721360,4012557807,2867154858,4212583931,1137018435,1305975373,861234739,2241073541,1171229253,4178635257,33948674,2139225727,1357946960,1011120188,2679776671,2833468328,1374921297,2751356323,1086357568,2408187279,2460827538,2646352285,944271416,4110742005,3168756668,3066132406,3665145818,560153121,271589392,4279952895,4077846003,3530407890,3444343245,202643468,322250259,3962553324,1608629855,2543990167,1154254916,389623319,3294073796,2817676711,2122513534,1028094525,1689045092,1575467613,422261273,1939203699,1621147744,2174228865,1339137615,3699352540,577127458,712922154,2427141008,2290289544,1187679302,3995715566,3100863416,339486740,3732514782,1591917662,186455563,3681988059,3762019296,844522546,978220090,169743370,1239126601,101321734,611076132,1558493276,3260915650,3547250131,2901361580,1655096418,2443721105,2510565781,3828863972,2039214713,3878868455,3359869896,928607799,1840765549,2374762893,3580146133,1322425422,2850048425,1823791212,1459268694,4094161908,3928346602,1706019429,2056189050,2934523822,135794696,3134549946,2022240376,628050469,779246638,472135708,2800834470,3032970164,3327236038,3894660072,3715932637,1956440180,522272287,1272813131,3185336765,2340818315,2323976074,1888542832,1044544574,3049550261,1722469478,1222152264,50660867,4127324150,236067854,1638122081,895445557,1475980887,3117443513,2257655686,3243809217,489110045,2662934430,3778599393,4162055160,2561878936,288563729,1773916777,3648039385,2391345038,2493985684,2612407707,505560094,2274497927,3911240169,3460925390,1442818645,678973480,3749357023,2358182796,2717407649,2306869641,219617805,3218761151,3862026214,1120306242,1756942440,1103331905,2578459033,762796589,252780047,2966125488,1425844308,3151392187,372911126],f=[1667474886,2088535288,2004326894,2071694838,4075949567,1802223062,1869591006,3318043793,808472672,16843522,1734846926,724270422,4278065639,3621216949,2880169549,1987484396,3402253711,2189597983,3385409673,2105378810,4210693615,1499065266,1195886990,4042263547,2913856577,3570689971,2728590687,2947541573,2627518243,2762274643,1920112356,3233831835,3082273397,4261223649,2475929149,640051788,909531756,1061110142,4160160501,3435941763,875846760,2779116625,3857003729,4059105529,1903268834,3638064043,825316194,353713962,67374088,3351728789,589522246,3284360861,404236336,2526454071,84217610,2593830191,117901582,303183396,2155911963,3806477791,3958056653,656894286,2998062463,1970642922,151591698,2206440989,741110872,437923380,454765878,1852748508,1515908788,2694904667,1381168804,993742198,3604373943,3014905469,690584402,3823320797,791638366,2223281939,1398011302,3520161977,0,3991743681,538992704,4244381667,2981218425,1532751286,1785380564,3419096717,3200178535,960056178,1246420628,1280103576,1482221744,3486468741,3503319995,4025428677,2863326543,4227536621,1128514950,1296947098,859002214,2240123921,1162203018,4193849577,33687044,2139062782,1347481760,1010582648,2678045221,2829640523,1364325282,2745433693,1077985408,2408548869,2459086143,2644360225,943212656,4126475505,3166494563,3065430391,3671750063,555836226,269496352,4294908645,4092792573,3537006015,3452783745,202118168,320025894,3974901699,1600119230,2543297077,1145359496,387397934,3301201811,2812801621,2122220284,1027426170,1684319432,1566435258,421079858,1936954854,1616945344,2172753945,1330631070,3705438115,572679748,707427924,2425400123,2290647819,1179044492,4008585671,3099120491,336870440,3739122087,1583276732,185277718,3688593069,3772791771,842159716,976899700,168435220,1229577106,101059084,606366792,1549591736,3267517855,3553849021,2897014595,1650632388,2442242105,2509612081,3840161747,2038008818,3890688725,3368567691,926374254,1835907034,2374863873,3587531953,1313788572,2846482505,1819063512,1448540844,4109633523,3941213647,1701162954,2054852340,2930698567,134748176,3132806511,2021165296,623210314,774795868,471606328,2795958615,3031746419,3334885783,3907527627,3722280097,1953799400,522133822,1263263126,3183336545,2341176845,2324333839,1886425312,1044267644,3048588401,1718004428,1212733584,50529542,4143317495,235803164,1633788866,892690282,1465383342,3115962473,2256965911,3250673817,488449850,2661202215,3789633753,4177007595,2560144171,286339874,1768537042,3654906025,2391705863,2492770099,2610673197,505291324,2273808917,3924369609,3469625735,1431699370,673740880,3755965093,2358021891,2711746649,2307489801,218961690,3217021541,3873845719,1111672452,1751693520,1094828930,2576986153,757954394,252645662,2964376443,1414855848,3149649517,370555436],_=[1374988112,2118214995,437757123,975658646,1001089995,530400753,2902087851,1273168787,540080725,2910219766,2295101073,4110568485,1340463100,3307916247,641025152,3043140495,3736164937,632953703,1172967064,1576976609,3274667266,2169303058,2370213795,1809054150,59727847,361929877,3211623147,2505202138,3569255213,1484005843,1239443753,2395588676,1975683434,4102977912,2572697195,666464733,3202437046,4035489047,3374361702,2110667444,1675577880,3843699074,2538681184,1649639237,2976151520,3144396420,4269907996,4178062228,1883793496,2403728665,2497604743,1383856311,2876494627,1917518562,3810496343,1716890410,3001755655,800440835,2261089178,3543599269,807962610,599762354,33778362,3977675356,2328828971,2809771154,4077384432,1315562145,1708848333,101039829,3509871135,3299278474,875451293,2733856160,92987698,2767645557,193195065,1080094634,1584504582,3178106961,1042385657,2531067453,3711829422,1306967366,2438237621,1908694277,67556463,1615861247,429456164,3602770327,2302690252,1742315127,2968011453,126454664,3877198648,2043211483,2709260871,2084704233,4169408201,0,159417987,841739592,504459436,1817866830,4245618683,260388950,1034867998,908933415,168810852,1750902305,2606453969,607530554,202008497,2472011535,3035535058,463180190,2160117071,1641816226,1517767529,470948374,3801332234,3231722213,1008918595,303765277,235474187,4069246893,766945465,337553864,1475418501,2943682380,4003061179,2743034109,4144047775,1551037884,1147550661,1543208500,2336434550,3408119516,3069049960,3102011747,3610369226,1113818384,328671808,2227573024,2236228733,3535486456,2935566865,3341394285,496906059,3702665459,226906860,2009195472,733156972,2842737049,294930682,1206477858,2835123396,2700099354,1451044056,573804783,2269728455,3644379585,2362090238,2564033334,2801107407,2776292904,3669462566,1068351396,742039012,1350078989,1784663195,1417561698,4136440770,2430122216,775550814,2193862645,2673705150,1775276924,1876241833,3475313331,3366754619,270040487,3902563182,3678124923,3441850377,1851332852,3969562369,2203032232,3868552805,2868897406,566021896,4011190502,3135740889,1248802510,3936291284,699432150,832877231,708780849,3332740144,899835584,1951317047,4236429990,3767586992,866637845,4043610186,1106041591,2144161806,395441711,1984812685,1139781709,3433712980,3835036895,2664543715,1282050075,3240894392,1181045119,2640243204,25965917,4203181171,4211818798,3009879386,2463879762,3910161971,1842759443,2597806476,933301370,1509430414,3943906441,3467192302,3076639029,3776767469,2051518780,2631065433,1441952575,404016761,1942435775,1408749034,1610459739,3745345300,2017778566,3400528769,3110650942,941896748,3265478751,371049330,3168937228,675039627,4279080257,967311729,135050206,3635733660,1683407248,2076935265,3576870512,1215061108,3501741890],v=[1347548327,1400783205,3273267108,2520393566,3409685355,4045380933,2880240216,2471224067,1428173050,4138563181,2441661558,636813900,4233094615,3620022987,2149987652,2411029155,1239331162,1730525723,2554718734,3781033664,46346101,310463728,2743944855,3328955385,3875770207,2501218972,3955191162,3667219033,768917123,3545789473,692707433,1150208456,1786102409,2029293177,1805211710,3710368113,3065962831,401639597,1724457132,3028143674,409198410,2196052529,1620529459,1164071807,3769721975,2226875310,486441376,2499348523,1483753576,428819965,2274680428,3075636216,598438867,3799141122,1474502543,711349675,129166120,53458370,2592523643,2782082824,4063242375,2988687269,3120694122,1559041666,730517276,2460449204,4042459122,2706270690,3446004468,3573941694,533804130,2328143614,2637442643,2695033685,839224033,1973745387,957055980,2856345839,106852767,1371368976,4181598602,1033297158,2933734917,1179510461,3046200461,91341917,1862534868,4284502037,605657339,2547432937,3431546947,2003294622,3182487618,2282195339,954669403,3682191598,1201765386,3917234703,3388507166,0,2198438022,1211247597,2887651696,1315723890,4227665663,1443857720,507358933,657861945,1678381017,560487590,3516619604,975451694,2970356327,261314535,3535072918,2652609425,1333838021,2724322336,1767536459,370938394,182621114,3854606378,1128014560,487725847,185469197,2918353863,3106780840,3356761769,2237133081,1286567175,3152976349,4255350624,2683765030,3160175349,3309594171,878443390,1988838185,3704300486,1756818940,1673061617,3403100636,272786309,1075025698,545572369,2105887268,4174560061,296679730,1841768865,1260232239,4091327024,3960309330,3497509347,1814803222,2578018489,4195456072,575138148,3299409036,446754879,3629546796,4011996048,3347532110,3252238545,4270639778,915985419,3483825537,681933534,651868046,2755636671,3828103837,223377554,2607439820,1649704518,3270937875,3901806776,1580087799,4118987695,3198115200,2087309459,2842678573,3016697106,1003007129,2802849917,1860738147,2077965243,164439672,4100872472,32283319,2827177882,1709610350,2125135846,136428751,3874428392,3652904859,3460984630,3572145929,3593056380,2939266226,824852259,818324884,3224740454,930369212,2801566410,2967507152,355706840,1257309336,4148292826,243256656,790073846,2373340630,1296297904,1422699085,3756299780,3818836405,457992840,3099667487,2135319889,77422314,1560382517,1945798516,788204353,1521706781,1385356242,870912086,325965383,2358957921,2050466060,2388260884,2313884476,4006521127,901210569,3990953189,1014646705,1503449823,1062597235,2031621326,3212035895,3931371469,1533017514,350174575,2256028891,2177544179,1052338372,741876788,1606591296,1914052035,213705253,2334669897,1107234197,1899603969,3725069491,2631447780,2422494913,1635502980,1893020342,1950903388,1120974935],y=[2807058932,1699970625,2764249623,1586903591,1808481195,1173430173,1487645946,59984867,4199882800,1844882806,1989249228,1277555970,3623636965,3419915562,1149249077,2744104290,1514790577,459744698,244860394,3235995134,1963115311,4027744588,2544078150,4190530515,1608975247,2627016082,2062270317,1507497298,2200818878,567498868,1764313568,3359936201,2305455554,2037970062,1047239e3,1910319033,1337376481,2904027272,2892417312,984907214,1243112415,830661914,861968209,2135253587,2011214180,2927934315,2686254721,731183368,1750626376,4246310725,1820824798,4172763771,3542330227,48394827,2404901663,2871682645,671593195,3254988725,2073724613,145085239,2280796200,2779915199,1790575107,2187128086,472615631,3029510009,4075877127,3802222185,4107101658,3201631749,1646252340,4270507174,1402811438,1436590835,3778151818,3950355702,3963161475,4020912224,2667994737,273792366,2331590177,104699613,95345982,3175501286,2377486676,1560637892,3564045318,369057872,4213447064,3919042237,1137477952,2658625497,1119727848,2340947849,1530455833,4007360968,172466556,266959938,516552836,0,2256734592,3980931627,1890328081,1917742170,4294704398,945164165,3575528878,958871085,3647212047,2787207260,1423022939,775562294,1739656202,3876557655,2530391278,2443058075,3310321856,547512796,1265195639,437656594,3121275539,719700128,3762502690,387781147,218828297,3350065803,2830708150,2848461854,428169201,122466165,3720081049,1627235199,648017665,4122762354,1002783846,2117360635,695634755,3336358691,4234721005,4049844452,3704280881,2232435299,574624663,287343814,612205898,1039717051,840019705,2708326185,793451934,821288114,1391201670,3822090177,376187827,3113855344,1224348052,1679968233,2361698556,1058709744,752375421,2431590963,1321699145,3519142200,2734591178,188127444,2177869557,3727205754,2384911031,3215212461,2648976442,2450346104,3432737375,1180849278,331544205,3102249176,4150144569,2952102595,2159976285,2474404304,766078933,313773861,2570832044,2108100632,1668212892,3145456443,2013908262,418672217,3070356634,2594734927,1852171925,3867060991,3473416636,3907448597,2614737639,919489135,164948639,2094410160,2997825956,590424639,2486224549,1723872674,3157750862,3399941250,3501252752,3625268135,2555048196,3673637356,1343127501,4130281361,3599595085,2957853679,1297403050,81781910,3051593425,2283490410,532201772,1367295589,3926170974,895287692,1953757831,1093597963,492483431,3528626907,1446242576,1192455638,1636604631,209336225,344873464,1015671571,669961897,3375740769,3857572124,2973530695,3747192018,1933530610,3464042516,935293895,3454686199,2858115069,1863638845,3683022916,4085369519,3292445032,875313188,1080017571,3279033885,621591778,1233856572,2504130317,24197544,3017672716,3835484340,3247465558,2220981195,3060847922,1551124588,1463996600],C=[4104605777,1097159550,396673818,660510266,2875968315,2638606623,4200115116,3808662347,821712160,1986918061,3430322568,38544885,3856137295,718002117,893681702,1654886325,2975484382,3122358053,3926825029,4274053469,796197571,1290801793,1184342925,3556361835,2405426947,2459735317,1836772287,1381620373,3196267988,1948373848,3764988233,3385345166,3263785589,2390325492,1480485785,3111247143,3780097726,2293045232,548169417,3459953789,3746175075,439452389,1362321559,1400849762,1685577905,1806599355,2174754046,137073913,1214797936,1174215055,3731654548,2079897426,1943217067,1258480242,529487843,1437280870,3945269170,3049390895,3313212038,923313619,679998e3,3215307299,57326082,377642221,3474729866,2041877159,133361907,1776460110,3673476453,96392454,878845905,2801699524,777231668,4082475170,2330014213,4142626212,2213296395,1626319424,1906247262,1846563261,562755902,3708173718,1040559837,3871163981,1418573201,3294430577,114585348,1343618912,2566595609,3186202582,1078185097,3651041127,3896688048,2307622919,425408743,3371096953,2081048481,1108339068,2216610296,0,2156299017,736970802,292596766,1517440620,251657213,2235061775,2933202493,758720310,265905162,1554391400,1532285339,908999204,174567692,1474760595,4002861748,2610011675,3234156416,3693126241,2001430874,303699484,2478443234,2687165888,585122620,454499602,151849742,2345119218,3064510765,514443284,4044981591,1963412655,2581445614,2137062819,19308535,1928707164,1715193156,4219352155,1126790795,600235211,3992742070,3841024952,836553431,1669664834,2535604243,3323011204,1243905413,3141400786,4180808110,698445255,2653899549,2989552604,2253581325,3252932727,3004591147,1891211689,2487810577,3915653703,4237083816,4030667424,2100090966,865136418,1229899655,953270745,3399679628,3557504664,4118925222,2061379749,3079546586,2915017791,983426092,2022837584,1607244650,2118541908,2366882550,3635996816,972512814,3283088770,1568718495,3499326569,3576539503,621982671,2895723464,410887952,2623762152,1002142683,645401037,1494807662,2595684844,1335535747,2507040230,4293295786,3167684641,367585007,3885750714,1865862730,2668221674,2960971305,2763173681,1059270954,2777952454,2724642869,1320957812,2194319100,2429595872,2815956275,77089521,3973773121,3444575871,2448830231,1305906550,4021308739,2857194700,2516901860,3518358430,1787304780,740276417,1699839814,1592394909,2352307457,2272556026,188821243,1729977011,3687994002,274084841,3594982253,3613494426,2701949495,4162096729,322734571,2837966542,1640576439,484830689,1202797690,3537852828,4067639125,349075736,3342319475,4157467219,4255800159,1030690015,1155237496,2951971274,1757691577,607398968,2738905026,499347990,3794078908,1011452712,227885567,2818666809,213114376,3034881240,1455525988,3414450555,850817237,1817998408,3092726480],b=[0,235474187,470948374,303765277,941896748,908933415,607530554,708780849,1883793496,2118214995,1817866830,1649639237,1215061108,1181045119,1417561698,1517767529,3767586992,4003061179,4236429990,4069246893,3635733660,3602770327,3299278474,3400528769,2430122216,2664543715,2362090238,2193862645,2835123396,2801107407,3035535058,3135740889,3678124923,3576870512,3341394285,3374361702,3810496343,3977675356,4279080257,4043610186,2876494627,2776292904,3076639029,3110650942,2472011535,2640243204,2403728665,2169303058,1001089995,899835584,666464733,699432150,59727847,226906860,530400753,294930682,1273168787,1172967064,1475418501,1509430414,1942435775,2110667444,1876241833,1641816226,2910219766,2743034109,2976151520,3211623147,2505202138,2606453969,2302690252,2269728455,3711829422,3543599269,3240894392,3475313331,3843699074,3943906441,4178062228,4144047775,1306967366,1139781709,1374988112,1610459739,1975683434,2076935265,1775276924,1742315127,1034867998,866637845,566021896,800440835,92987698,193195065,429456164,395441711,1984812685,2017778566,1784663195,1683407248,1315562145,1080094634,1383856311,1551037884,101039829,135050206,437757123,337553864,1042385657,807962610,573804783,742039012,2531067453,2564033334,2328828971,2227573024,2935566865,2700099354,3001755655,3168937228,3868552805,3902563182,4203181171,4102977912,3736164937,3501741890,3265478751,3433712980,1106041591,1340463100,1576976609,1408749034,2043211483,2009195472,1708848333,1809054150,832877231,1068351396,766945465,599762354,159417987,126454664,361929877,463180190,2709260871,2943682380,3178106961,3009879386,2572697195,2538681184,2236228733,2336434550,3509871135,3745345300,3441850377,3274667266,3910161971,3877198648,4110568485,4211818798,2597806476,2497604743,2261089178,2295101073,2733856160,2902087851,3202437046,2968011453,3936291284,3835036895,4136440770,4169408201,3535486456,3702665459,3467192302,3231722213,2051518780,1951317047,1716890410,1750902305,1113818384,1282050075,1584504582,1350078989,168810852,67556463,371049330,404016761,841739592,1008918595,775550814,540080725,3969562369,3801332234,4035489047,4269907996,3569255213,3669462566,3366754619,3332740144,2631065433,2463879762,2160117071,2395588676,2767645557,2868897406,3102011747,3069049960,202008497,33778362,270040487,504459436,875451293,975658646,675039627,641025152,2084704233,1917518562,1615861247,1851332852,1147550661,1248802510,1484005843,1451044056,933301370,967311729,733156972,632953703,260388950,25965917,328671808,496906059,1206477858,1239443753,1543208500,1441952575,2144161806,1908694277,1675577880,1842759443,3610369226,3644379585,3408119516,3307916247,4011190502,3776767469,4077384432,4245618683,2809771154,2842737049,3144396420,3043140495,2673705150,2438237621,2203032232,2370213795],w=[0,185469197,370938394,487725847,741876788,657861945,975451694,824852259,1483753576,1400783205,1315723890,1164071807,1950903388,2135319889,1649704518,1767536459,2967507152,3152976349,2801566410,2918353863,2631447780,2547432937,2328143614,2177544179,3901806776,3818836405,4270639778,4118987695,3299409036,3483825537,3535072918,3652904859,2077965243,1893020342,1841768865,1724457132,1474502543,1559041666,1107234197,1257309336,598438867,681933534,901210569,1052338372,261314535,77422314,428819965,310463728,3409685355,3224740454,3710368113,3593056380,3875770207,3960309330,4045380933,4195456072,2471224067,2554718734,2237133081,2388260884,3212035895,3028143674,2842678573,2724322336,4138563181,4255350624,3769721975,3955191162,3667219033,3516619604,3431546947,3347532110,2933734917,2782082824,3099667487,3016697106,2196052529,2313884476,2499348523,2683765030,1179510461,1296297904,1347548327,1533017514,1786102409,1635502980,2087309459,2003294622,507358933,355706840,136428751,53458370,839224033,957055980,605657339,790073846,2373340630,2256028891,2607439820,2422494913,2706270690,2856345839,3075636216,3160175349,3573941694,3725069491,3273267108,3356761769,4181598602,4063242375,4011996048,3828103837,1033297158,915985419,730517276,545572369,296679730,446754879,129166120,213705253,1709610350,1860738147,1945798516,2029293177,1239331162,1120974935,1606591296,1422699085,4148292826,4233094615,3781033664,3931371469,3682191598,3497509347,3446004468,3328955385,2939266226,2755636671,3106780840,2988687269,2198438022,2282195339,2501218972,2652609425,1201765386,1286567175,1371368976,1521706781,1805211710,1620529459,2105887268,1988838185,533804130,350174575,164439672,46346101,870912086,954669403,636813900,788204353,2358957921,2274680428,2592523643,2441661558,2695033685,2880240216,3065962831,3182487618,3572145929,3756299780,3270937875,3388507166,4174560061,4091327024,4006521127,3854606378,1014646705,930369212,711349675,560487590,272786309,457992840,106852767,223377554,1678381017,1862534868,1914052035,2031621326,1211247597,1128014560,1580087799,1428173050,32283319,182621114,401639597,486441376,768917123,651868046,1003007129,818324884,1503449823,1385356242,1333838021,1150208456,1973745387,2125135846,1673061617,1756818940,2970356327,3120694122,2802849917,2887651696,2637442643,2520393566,2334669897,2149987652,3917234703,3799141122,4284502037,4100872472,3309594171,3460984630,3545789473,3629546796,2050466060,1899603969,1814803222,1730525723,1443857720,1560382517,1075025698,1260232239,575138148,692707433,878443390,1062597235,243256656,91341917,409198410,325965383,3403100636,3252238545,3704300486,3620022987,3874428392,3990953189,4042459122,4227665663,2460449204,2578018489,2226875310,2411029155,3198115200,3046200461,2827177882,2743944855],T=[0,218828297,437656594,387781147,875313188,958871085,775562294,590424639,1750626376,1699970625,1917742170,2135253587,1551124588,1367295589,1180849278,1265195639,3501252752,3720081049,3399941250,3350065803,3835484340,3919042237,4270507174,4085369519,3102249176,3051593425,2734591178,2952102595,2361698556,2177869557,2530391278,2614737639,3145456443,3060847922,2708326185,2892417312,2404901663,2187128086,2504130317,2555048196,3542330227,3727205754,3375740769,3292445032,3876557655,3926170974,4246310725,4027744588,1808481195,1723872674,1910319033,2094410160,1608975247,1391201670,1173430173,1224348052,59984867,244860394,428169201,344873464,935293895,984907214,766078933,547512796,1844882806,1627235199,2011214180,2062270317,1507497298,1423022939,1137477952,1321699145,95345982,145085239,532201772,313773861,830661914,1015671571,731183368,648017665,3175501286,2957853679,2807058932,2858115069,2305455554,2220981195,2474404304,2658625497,3575528878,3625268135,3473416636,3254988725,3778151818,3963161475,4213447064,4130281361,3599595085,3683022916,3432737375,3247465558,3802222185,4020912224,4172763771,4122762354,3201631749,3017672716,2764249623,2848461854,2331590177,2280796200,2431590963,2648976442,104699613,188127444,472615631,287343814,840019705,1058709744,671593195,621591778,1852171925,1668212892,1953757831,2037970062,1514790577,1463996600,1080017571,1297403050,3673637356,3623636965,3235995134,3454686199,4007360968,3822090177,4107101658,4190530515,2997825956,3215212461,2830708150,2779915199,2256734592,2340947849,2627016082,2443058075,172466556,122466165,273792366,492483431,1047239e3,861968209,612205898,695634755,1646252340,1863638845,2013908262,1963115311,1446242576,1530455833,1277555970,1093597963,1636604631,1820824798,2073724613,1989249228,1436590835,1487645946,1337376481,1119727848,164948639,81781910,331544205,516552836,1039717051,821288114,669961897,719700128,2973530695,3157750862,2871682645,2787207260,2232435299,2283490410,2667994737,2450346104,3647212047,3564045318,3279033885,3464042516,3980931627,3762502690,4150144569,4199882800,3070356634,3121275539,2904027272,2686254721,2200818878,2384911031,2570832044,2486224549,3747192018,3528626907,3310321856,3359936201,3950355702,3867060991,4049844452,4234721005,1739656202,1790575107,2108100632,1890328081,1402811438,1586903591,1233856572,1149249077,266959938,48394827,369057872,418672217,1002783846,919489135,567498868,752375421,209336225,24197544,376187827,459744698,945164165,895287692,574624663,793451934,1679968233,1764313568,2117360635,1933530610,1343127501,1560637892,1243112415,1192455638,3704280881,3519142200,3336358691,3419915562,3907448597,3857572124,4075877127,4294704398,3029510009,3113855344,2927934315,2744104290,2159976285,2377486676,2594734927,2544078150],E=[0,151849742,303699484,454499602,607398968,758720310,908999204,1059270954,1214797936,1097159550,1517440620,1400849762,1817998408,1699839814,2118541908,2001430874,2429595872,2581445614,2194319100,2345119218,3034881240,3186202582,2801699524,2951971274,3635996816,3518358430,3399679628,3283088770,4237083816,4118925222,4002861748,3885750714,1002142683,850817237,698445255,548169417,529487843,377642221,227885567,77089521,1943217067,2061379749,1640576439,1757691577,1474760595,1592394909,1174215055,1290801793,2875968315,2724642869,3111247143,2960971305,2405426947,2253581325,2638606623,2487810577,3808662347,3926825029,4044981591,4162096729,3342319475,3459953789,3576539503,3693126241,1986918061,2137062819,1685577905,1836772287,1381620373,1532285339,1078185097,1229899655,1040559837,923313619,740276417,621982671,439452389,322734571,137073913,19308535,3871163981,4021308739,4104605777,4255800159,3263785589,3414450555,3499326569,3651041127,2933202493,2815956275,3167684641,3049390895,2330014213,2213296395,2566595609,2448830231,1305906550,1155237496,1607244650,1455525988,1776460110,1626319424,2079897426,1928707164,96392454,213114376,396673818,514443284,562755902,679998e3,865136418,983426092,3708173718,3557504664,3474729866,3323011204,4180808110,4030667424,3945269170,3794078908,2507040230,2623762152,2272556026,2390325492,2975484382,3092726480,2738905026,2857194700,3973773121,3856137295,4274053469,4157467219,3371096953,3252932727,3673476453,3556361835,2763173681,2915017791,3064510765,3215307299,2156299017,2307622919,2459735317,2610011675,2081048481,1963412655,1846563261,1729977011,1480485785,1362321559,1243905413,1126790795,878845905,1030690015,645401037,796197571,274084841,425408743,38544885,188821243,3613494426,3731654548,3313212038,3430322568,4082475170,4200115116,3780097726,3896688048,2668221674,2516901860,2366882550,2216610296,3141400786,2989552604,2837966542,2687165888,1202797690,1320957812,1437280870,1554391400,1669664834,1787304780,1906247262,2022837584,265905162,114585348,499347990,349075736,736970802,585122620,972512814,821712160,2595684844,2478443234,2293045232,2174754046,3196267988,3079546586,2895723464,2777952454,3537852828,3687994002,3234156416,3385345166,4142626212,4293295786,3841024952,3992742070,174567692,57326082,410887952,292596766,777231668,660510266,1011452712,893681702,1108339068,1258480242,1343618912,1494807662,1715193156,1865862730,1948373848,2100090966,2701949495,2818666809,3004591147,3122358053,2235061775,2352307457,2535604243,2653899549,3915653703,3764988233,4219352155,4067639125,3444575871,3294430577,3746175075,3594982253,836553431,953270745,600235211,718002117,367585007,484830689,133361907,251657213,2041877159,1891211689,1806599355,1654886325,1568718495,1418573201,1335535747,1184342925];function S(t){for(var e=[],i=0;i<t.length;i+=4)e.push(t[i]<<24|t[i+1]<<16|t[i+2]<<8|t[i+3]);return e}var R=function(t){if(!(this instanceof R))throw Error("AES must be instanitated with `new`");Object.defineProperty(this,"key",{value:o(t,!0)}),this._prepare()};R.prototype._prepare=function(){var t=l[this.key.length];if(null==t)throw new Error("invalid key size (must be 16, 24 or 32 bytes)");this._Ke=[],this._Kd=[];for(var e=0;e<=t;e++)this._Ke.push([0,0,0,0]),this._Kd.push([0,0,0,0]);var i,n=4*(t+1),o=this.key.length/4,s=S(this.key);for(e=0;e<o;e++)i=e>>2,this._Ke[i][e%4]=s[e],this._Kd[t-i][e%4]=s[e];for(var r,a=0,c=o;c<n;){if(r=s[o-1],s[0]^=h[r>>16&255]<<24^h[r>>8&255]<<16^h[255&r]<<8^h[r>>24&255]^d[a]<<24,a+=1,8!=o)for(e=1;e<o;e++)s[e]^=s[e-1];else{for(e=1;e<o/2;e++)s[e]^=s[e-1];r=s[o/2-1],s[o/2]^=h[255&r]^h[r>>8&255]<<8^h[r>>16&255]<<16^h[r>>24&255]<<24;for(e=o/2+1;e<o;e++)s[e]^=s[e-1]}for(e=0;e<o&&c<n;)u=c>>2,p=c%4,this._Ke[u][p]=s[e],this._Kd[t-u][p]=s[e++],c++}for(var u=1;u<t;u++)for(var p=0;p<4;p++)r=this._Kd[u][p],this._Kd[u][p]=b[r>>24&255]^w[r>>16&255]^T[r>>8&255]^E[255&r]},R.prototype.encrypt=function(t){if(16!=t.length)throw new Error("invalid plaintext size (must be 16 bytes)");for(var e=this._Ke.length-1,i=[0,0,0,0],n=S(t),o=0;o<4;o++)n[o]^=this._Ke[0][o];for(var r=1;r<e;r++){for(o=0;o<4;o++)i[o]=p[n[o]>>24&255]^g[n[(o+1)%4]>>16&255]^m[n[(o+2)%4]>>8&255]^f[255&n[(o+3)%4]]^this._Ke[r][o];n=i.slice()}var a,c=s(16);for(o=0;o<4;o++)a=this._Ke[e][o],c[4*o]=255&(h[n[o]>>24&255]^a>>24),c[4*o+1]=255&(h[n[(o+1)%4]>>16&255]^a>>16),c[4*o+2]=255&(h[n[(o+2)%4]>>8&255]^a>>8),c[4*o+3]=255&(h[255&n[(o+3)%4]]^a);return c},R.prototype.decrypt=function(t){if(16!=t.length)throw new Error("invalid ciphertext size (must be 16 bytes)");for(var e=this._Kd.length-1,i=[0,0,0,0],n=S(t),o=0;o<4;o++)n[o]^=this._Kd[0][o];for(var r=1;r<e;r++){for(o=0;o<4;o++)i[o]=_[n[o]>>24&255]^v[n[(o+3)%4]>>16&255]^y[n[(o+2)%4]>>8&255]^C[255&n[(o+1)%4]]^this._Kd[r][o];n=i.slice()}var a,c=s(16);for(o=0;o<4;o++)a=this._Kd[e][o],c[4*o]=255&(u[n[o]>>24&255]^a>>24),c[4*o+1]=255&(u[n[(o+3)%4]>>16&255]^a>>16),c[4*o+2]=255&(u[n[(o+2)%4]>>8&255]^a>>8),c[4*o+3]=255&(u[255&n[(o+1)%4]]^a);return c};var A=function(t){if(!(this instanceof A))throw Error("AES must be instanitated with `new`");this.description="Electronic Code Block",this.name="ecb",this._aes=new R(t)};A.prototype.encrypt=function(t){if((t=o(t)).length%16!=0)throw new Error("invalid plaintext size (must be multiple of 16 bytes)");for(var e=s(t.length),i=s(16),n=0;n<t.length;n+=16)r(t,i,0,n,n+16),r(i=this._aes.encrypt(i),e,n);return e},A.prototype.decrypt=function(t){if((t=o(t)).length%16!=0)throw new Error("invalid ciphertext size (must be multiple of 16 bytes)");for(var e=s(t.length),i=s(16),n=0;n<t.length;n+=16)r(t,i,0,n,n+16),r(i=this._aes.decrypt(i),e,n);return e};var I=function(t,e){if(!(this instanceof I))throw Error("AES must be instanitated with `new`");if(this.description="Cipher Block Chaining",this.name="cbc",e){if(16!=e.length)throw new Error("invalid initialation vector size (must be 16 bytes)")}else e=s(16);this._lastCipherblock=o(e,!0),this._aes=new R(t)};I.prototype.encrypt=function(t){if((t=o(t)).length%16!=0)throw new Error("invalid plaintext size (must be multiple of 16 bytes)");for(var e=s(t.length),i=s(16),n=0;n<t.length;n+=16){r(t,i,0,n,n+16);for(var a=0;a<16;a++)i[a]^=this._lastCipherblock[a];this._lastCipherblock=this._aes.encrypt(i),r(this._lastCipherblock,e,n)}return e},I.prototype.decrypt=function(t){if((t=o(t)).length%16!=0)throw new Error("invalid ciphertext size (must be multiple of 16 bytes)");for(var e=s(t.length),i=s(16),n=0;n<t.length;n+=16){r(t,i,0,n,n+16),i=this._aes.decrypt(i);for(var a=0;a<16;a++)e[n+a]=i[a]^this._lastCipherblock[a];r(t,this._lastCipherblock,0,n,n+16)}return e};var x=function(t,e,i){if(!(this instanceof x))throw Error("AES must be instanitated with `new`");if(this.description="Cipher Feedback",this.name="cfb",e){if(16!=e.length)throw new Error("invalid initialation vector size (must be 16 size)")}else e=s(16);i||(i=1),this.segmentSize=i,this._shiftRegister=o(e,!0),this._aes=new R(t)};x.prototype.encrypt=function(t){if(t.length%this.segmentSize!=0)throw new Error("invalid plaintext size (must be segmentSize bytes)");for(var e,i=o(t,!0),n=0;n<i.length;n+=this.segmentSize){e=this._aes.encrypt(this._shiftRegister);for(var s=0;s<this.segmentSize;s++)i[n+s]^=e[s];r(this._shiftRegister,this._shiftRegister,0,this.segmentSize),r(i,this._shiftRegister,16-this.segmentSize,n,n+this.segmentSize)}return i},x.prototype.decrypt=function(t){if(t.length%this.segmentSize!=0)throw new Error("invalid ciphertext size (must be segmentSize bytes)");for(var e,i=o(t,!0),n=0;n<i.length;n+=this.segmentSize){e=this._aes.encrypt(this._shiftRegister);for(var s=0;s<this.segmentSize;s++)i[n+s]^=e[s];r(this._shiftRegister,this._shiftRegister,0,this.segmentSize),r(t,this._shiftRegister,16-this.segmentSize,n,n+this.segmentSize)}return i};var M=function(t,e){if(!(this instanceof M))throw Error("AES must be instanitated with `new`");if(this.description="Output Feedback",this.name="ofb",e){if(16!=e.length)throw new Error("invalid initialation vector size (must be 16 bytes)")}else e=s(16);this._lastPrecipher=o(e,!0),this._lastPrecipherIndex=16,this._aes=new R(t)};M.prototype.encrypt=function(t){for(var e=o(t,!0),i=0;i<e.length;i++)16===this._lastPrecipherIndex&&(this._lastPrecipher=this._aes.encrypt(this._lastPrecipher),this._lastPrecipherIndex=0),e[i]^=this._lastPrecipher[this._lastPrecipherIndex++];return e},M.prototype.decrypt=M.prototype.encrypt;var O=function(t){if(!(this instanceof O))throw Error("Counter must be instanitated with `new`");0===t||t||(t=1),"number"==typeof t?(this._counter=s(16),this.setValue(t)):this.setBytes(t)};O.prototype.setValue=function(t){if("number"!=typeof t||parseInt(t)!=t)throw new Error("invalid counter value (must be an integer)");if(t>Number.MAX_SAFE_INTEGER)throw new Error("integer value out of safe range");for(var e=15;e>=0;--e)this._counter[e]=t%256,t=parseInt(t/256)},O.prototype.setBytes=function(t){if(16!=(t=o(t,!0)).length)throw new Error("invalid counter bytes size (must be 16 bytes)");this._counter=t},O.prototype.increment=function(){for(var t=15;t>=0;t--){if(255!==this._counter[t]){this._counter[t]++;break}this._counter[t]=0}};var N=function(t,e){if(!(this instanceof N))throw Error("AES must be instanitated with `new`");this.description="Counter",this.name="ctr",e instanceof O||(e=new O(e)),this._counter=e,this._remainingCounter=null,this._remainingCounterIndex=16,this._aes=new R(t)};N.prototype.encrypt=function(t){for(var e=o(t,!0),i=0;i<e.length;i++)16===this._remainingCounterIndex&&(this._remainingCounter=this._aes.encrypt(this._counter._counter),this._remainingCounterIndex=0,this._counter.increment()),e[i]^=this._remainingCounter[this._remainingCounterIndex++];return e},N.prototype.decrypt=N.prototype.encrypt;var P={AES:R,Counter:O,ModeOfOperation:{ecb:A,cbc:I,cfb:x,ofb:M,ctr:N},utils:{hex:c,utf8:a},padding:{pkcs7:{pad:function(t){var e=16-(t=o(t,!0)).length%16,i=s(t.length+e);r(t,i);for(var n=t.length;n<i.length;n++)i[n]=e;return i},strip:function(t){if((t=o(t,!0)).length<16)throw new Error("PKCS#7 invalid length");var e=t[t.length-1];if(e>16)throw new Error("PKCS#7 padding byte out of range");for(var i=t.length-e,n=0;n<e;n++)if(t[i+n]!==e)throw new Error("PKCS#7 invalid padding byte");var a=s(i);return r(t,a,0,0,i),a}}},_arrayTest:{coerceArray:o,createArray:s,copyArray:r}};"undefined"!=typeof exports||("function"==typeof define&&i(81)?define(P):(t.aesjs&&(P._aesjs=t.aesjs),t.aesjs=P))}(this)}(),this.subtle=null):this.subtle=self.crypto.subtle,function(t){return new Promise((e,i)=>{this.subtle?this.subtle.importKey("raw",t,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(t=>{e(t)}):e(t)})}(d.data.key).then(t=>{this._key=t,this._iv=d.data.iv,new Promise((t,e)=>{let i=null,r=0,a=0;g(n).then(n=>{if(!n)return t(i);u(n).then(n=>{i=n,function n(){g(s+r).then(s=>{if(!s)return function n(){g(o+a).then(o=>{if(!o)return t(i);u(o).then(t=>{i.index[t.prop]=t.data,a++,n()}).catch(e)}).catch(e)}();u(s).then(t=>{i.documentStore.docs=Object.assign(i.documentStore.docs,t),r++,n()}).catch(e)}).catch(e)}()}).catch(e)}).catch(e)}).then(t=>{t&&(e=r.Index.load(t)),m()}).catch(t=>{f("Failed reading database for previously stored index.")})}).catch(t=>{f("Failed importing key for previously stored index.")})}).catch(t=>{f("Failed detecting crypto type for previously stored index")});break;case"fetch":if(!1===t)return void self.postMessage({_id:d.data._id,success:!1,action:"index-complete",msg:"Initialisation must be completed before the 'fetch' action can take place."});const _=Date.now();fetch(d.data.endpoint,{method:"GET",headers:{Authorization:"Basic "+function(t){return btoa(unescape(encodeURIComponent(t)))}(`${d.data.jid}:${d.data.pass}`)}}).then(t=>{if(200!==t.status)throw new Error(`Couldn't download user directory. Status code: '${t.status}'.`);return t.json()}).then(t=>{const i={added:t.added||[],updated:t.updated||[],removed:t.removed||[]};void 0!==t.full&&(e=null,i.added=t.full);const c=Date.now()-_,l=[`Downloaded '${i.added.length}' additions, '${i.updated.length}' updates and '${i.removed.length}' deletions in ${c}ms`];null===e&&(e=r(function(){this.setRef("jid"),this.addField("jid"),this.addField("firstName"),this.addField("lastName"),this.addField("jobTitle"),this.addField("telephone"),this.addField("group"),this.saveDocument(!0)}),l.push("Created a fresh index")),i.added.length>0&&(i.added.forEach(t=>e.addDoc(t)),l.push(`Added '${i.added.length}' users to index`)),i.updated.length>0&&(i.updated.forEach(t=>e.updateDoc(t)),l.push(`Updated '${i.updated.length}' users in index`)),i.removed.length>0&&(i.removed.forEach(t=>e.removeDoc(t)),l.push(`Removed '${i.removed.length}' users from index`)),function(t=1e3){return a&&console.time("encrypt"),new Promise((i,r)=>{let c=0,l=0;const d=e.toJSON(),u=JSON.parse(JSON.stringify(d)),g=Object.keys(u.documentStore.docs),m=Object.keys(u.index);!function e(){if(0===g.length)a&&console.timeEnd("encrypt"),a&&console.time("index"),u.documentStore.docs={},a&&console.time("index2"),function t(){if(0===m.length)u.index={},h(u).then(t=>{a&&console.timeEnd("index2"),p(n,t).then(i).catch(r)});else{const e=m.shift();a&&console.time("chunk"),h({prop:e,data:u.index[e]}).then(e=>{p(o+l++,e).then(()=>{a&&console.timeEnd("chunk"),t()})})}}();else{const i=g.splice(0,t),n={};i.forEach(t=>{const e=d.documentStore.docs[t];n[t]=e}),a&&console.time("block"),h(n).then(t=>{p(s+c++,t).then(()=>{a&&console.timeEnd("block"),e()}).catch(r)}).catch(r)}}()})}(2e3).then(()=>{self.postMessage({_id:d.data._id,success:!0,action:"index-complete",hash:t.hash||null,msg:`${l.join(", ")} | Completed in ${Date.now()-_}ms.`})}).catch(t=>{self.postMessage({_id:d.data._id,success:!1,action:"index-complete",msg:"Couldn't persist updated index."})})}).catch(t=>{const e=`Unable to download user directory from location '${d.data.endpoint}'`;console.error(e,t),self.postMessage({_id:d.data._id,success:!1,action:"index-complete",msg:e})});break;case"search":if(r.clearStopWords(),!1===t)return void self.postMessage({_id:d.data._id,success:!1,action:"search-complete",msg:"Initialisation must be completed before the 'search' action can take place."});if(null===e)return void self.postMessage({_id:d.data._id,success:!1,action:"search-complete",msg:"There is no index to be searched, have you updated the index yet?"});const v=Date.now();let y=null;if(Array.isArray(d.data.fields)&&d.data.fields.length>0){const t={fields:{},bool:"OR",expand:!0};d.data.fields.forEach(e=>{t.fields[e]={}}),y=e.search(d.data.query,t)}else y=e.search(d.data.query,{expand:!0});const C=y.map(t=>t.doc);self.postMessage({_id:d.data._id,success:!0,action:"search-complete",msg:`Found ${C.length} users in ${Date.now()-v}ms.`,results:C});break;case"jid-search":if(!1===t)return void self.postMessage({_id:d.data._id,success:!1,action:"jid-search-complete",msg:"Initialisation must be completed before the 'jid-search' action can take place."});if(null===e)return void self.postMessage({_id:d.data._id,success:!1,action:"jid-search-complete",msg:"There is no index to be searched, have you updated the index yet?"});const b=Date.now(),w=e.search(d.data.jid,{expand:!0})[0],T=void 0!==w?w.doc:null;self.postMessage({_id:d.data._id,success:!0,action:"jid-search-complete",msg:null!==T?`Found user with JID '${d.data.jid}' in ${Date.now()-b}ms.`:`No user with JID '${d.data.jid}' could be found.`,result:T});break;case"get-all-users":if(!1===t)return void self.postMessage({_id:d.data._id,success:!1,action:"get-all-users-complete",msg:"Initialisation must be completed before the 'get-all-users' action can take place."});if(null===e)return void self.postMessage({_id:d.data._id,success:!1,action:"get-all-users-complete",msg:"There is no index available, have you updated the index yet?"});const E=Date.now(),S=[];for(let t in e.documentStore.docs)S.push(e.documentStore.docs[t]);self.postMessage({_id:d.data._id,success:!0,action:"get-all-users-complete",msg:`Fetched '${S.length}' users in ${Date.now()-E}ms.`,results:S});break;case"store-record-response":case"retrieve-record-response":const R=c.get(d.data.key);R&&(d.data.success?R.resolve(d.data.record):R.reject(d.data.msg),c.delete(d.data.key));break;default:self.postMessage({_id:d.data._id,success:!0,msg:`Invalid action '${d.data.action}' was specified.`})}function h(t){return new Promise((e,i)=>{(function(t){return new Promise((e,i)=>{e((new TextEncoder).encode(t))})})(JSON.stringify(t)).then(t=>{if(this.subtle)this.subtle.encrypt({name:"AES-CBC",iv:this._iv},this._key,t).then(t=>{e(t)}).catch(i);else{const i=new aesjs.ModeOfOperation.ctr(this._key).encrypt(t);e(i)}}).catch(i)})}function u(t){return new Promise((e,i)=>{this.subtle?this.subtle.decrypt({name:"AES-CBC",iv:this._iv},this._key,t).then(t=>{m(new Uint8Array(t)).then(t=>{e(JSON.parse(t))}).catch(i)}).catch(i):m(new aesjs.ModeOfOperation.ctr(this._key).decrypt(t)).then(t=>{e(JSON.parse(t))}).catch(i)})}function p(t,e){return new Promise((i,n)=>{c.set(t,{resolve:i,reject:n}),self.postMessage({action:"store-record",key:t,record:e})})}function g(t){return new Promise((e,i)=>{c.set(t,{resolve:e,reject:i}),self.postMessage({action:"retrieve-record",key:t})})}function m(t){return new Promise((e,i)=>{e((new TextDecoder).decode(t))})}}}i.r(e),i.d(e,"default",function(){return n})},function(t,e){(function(e){t.exports=e}).call(this,{})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});class n{constructor(){this.nsResolve=function(t){return"vc"==t?"vcard-temp":null},this.json={}}static fromXml(t){const e=new n;try{e.initFromXML(t)}catch(t){return void console.error("Bad vCard: "+t)}return e}static fromJSON(t){const e=new n;return e.initFromJSON(t),e}_extractEmail(t){const e={};return"string"==typeof t.USERID&&(e.address=t.USERID),t.HOME&&(e.home=!0),t.WORK&&(e.work=!0),t.INTERNET&&(e.internet=!0),t.PREF&&(e.pref=!0),t.X400&&(e.x400=!0),e}_extractTelephone(t){const e={};return"string"==typeof t.NUMBER&&(e.number=t.NUMBER),t.HOME&&(e.home=!0),t.WORK&&(e.work=!0),t.VOICE&&(e.voice=!0),t.FAX&&(e.fax=!0),t.PAGER&&(e.pager=!0),t.MSG&&(e.msg=!0),t.CELL&&(e.cell=!0),t.VIDEO&&(e.video=!0),t.BBS&&(e.bbs=!0),t.MODEM&&(e.modem=!0),t.ISDN&&(e.isdn=!0),t.PCS&&(e.pcs=!0),t.PREF&&(e.pref=!0),e}_extractAddress(t){const e={};return"string"==typeof t.POBOX&&(e.poBox=t.POBOX),"string"==typeof t.EXTADD&&(e.extraAddress=t.EXTADD),"string"==typeof t.STREET&&(e.street=t.STREET),"string"==typeof t.LOCALITY&&(e.locality=t.LOCALITY),"string"==typeof t.REGION&&(e.locality=t.REGION),"string"==typeof t.PCODE&&(e.locality=t.PCODE),"string"==typeof t.CTRY&&(e.locality=t.CTRY),t.WORK&&(e.work=!0),t.HOME&&(e.home=!0),t.POSTAL&&(e.postal=!0),t.PARCEL&&(e.parcel=!0),t.DOM&&(e.dom=!0),t.INTL&&(e.intl=!0),t.PREF&&(e.pref=!0),e}initFromXML(t){const e={};"string"==typeof t.VERSION&&(e.version=t.VERSION),"string"==typeof t.FN&&(e.fullName=t.FN),"object"!=typeof t.N||Array.isArray(t.N)||(e.name={},"string"==typeof t.N.FAMILY&&(e.name.family=t.N.FAMILY),"string"==typeof t.N.GIVEN&&(e.name.given=t.N.GIVEN),"string"==typeof t.N.MIDDLE&&(e.name.middle=t.N.MIDDLE),"string"==typeof t.N.PREFIX&&(e.name.prefix=t.N.PREFIX),"string"==typeof t.N.SUFFIX&&(e.name.suffix=t.N.SUFFIX)),"string"==typeof t.NICKNAME&&(e.nickName=t.NICKNAME),"object"!=typeof t.PHOTO||Array.isArray(t.PHOTO)||(e.photo={},"string"==typeof t.PHOTO.TYPE&&(e.photo.type=t.PHOTO.TYPE),"string"==typeof t.PHOTO.BINVAL&&(e.photo.binval=t.PHOTO.BINVAL)),"string"==typeof t.BDAY&&(e.birthday=t.BDAY),"object"==typeof t.ADR&&(e.address=[],Array.isArray(t.ADR)?t.ADR.forEach(t=>{e.address.push(this._extractAddress(t))}):e.address.push(this._extractAddress(t.ADR))),"object"==typeof t.TEL&&(e.telephone=[],Array.isArray(t.TEL)?t.TEL.forEach(t=>{e.telephone.push(this._extractTelephone(t))}):e.telephone.push(this._extractTelephone(t.TEL))),"object"==typeof t.EMAIL&&(e.email=[],Array.isArray(t.EMAIL)?t.EMAIL.forEach(t=>{e.email.push(this._extractEmail(t))}):e.email.push(this._extractEmail(t.EMAIL))),"string"==typeof t.JABBERID&&(e.jabberId=t.JABBERID),"string"==typeof t.MAILER&&(e.mailer=t.MAILER),"string"==typeof t.TZ&&(e.timeZone=t.TZ),"object"!=typeof t.GEO||Array.isArray(t.GEO)||(e.geolocation={},"string"==typeof t.GEO.LAT&&(e.geolocation.lat=t.GEO.LAT),"string"==typeof t.GEO.LON&&(e.geolocation.lng=t.N.GIVEN)),"string"==typeof t.TITLE&&(e.title=t.TITLE),"string"==typeof t.ROLE&&(e.role=t.ROLE),"object"!=typeof t.LOGO||Array.isArray(t.LOGO)||(e.logo={},"string"==typeof t.LOGO.TYPE&&(e.logo.type=t.PHOTO.TYPE),"string"==typeof t.PHOTO.BINVAL&&(e.logo.binval=t.PHOTO.BINVAL),"string"==typeof t.PHOTO.EXTVAL&&(e.logo.extval=t.PHOTO.EXTVAL)),"object"!=typeof t.AGENT||Array.isArray(t.AGENT)||(e.agent={},"string"==typeof t.AGENT.EXTVAL&&(e.agent.extval=t.AGENT.EXTVAL)),"object"!=typeof t.ORG||Array.isArray(t.ORG)||(e.organisation={},"string"==typeof t.ORG.ORGNAME&&(e.organisation.name=t.ORG.ORGNAME),"string"==typeof t.ORG.ORGUNIT&&(e.organisation.unit=t.ORG.ORGUNIT)),"object"==typeof t.CATEGORIES&&(e.categories=[],Array.isArray(t.CATEGORIES)?t.CATEGORIES.forEach(t=>{e.categories.push({keyword:t.KEYWORD})}):e.telephone.push({keyword:t.CATEGORIES.KEYWORD})),"string"==typeof t.NOTE&&(e.note=t.NOTE),"string"==typeof t.PRODID&&(e.prodid=t.PRODID),"string"==typeof t.REV&&(e.rev=t.REV),"string"==typeof t["SORT-STRING"]&&(e.sortString=t["SORT-STRING"]),"object"!=typeof t.SOUND||Array.isArray(t.SOUND)||(e.sound={},"string"==typeof t.SOUND.PHONETIC&&(e.sound.phonetic=t.SOUND.PHONETIC),"string"==typeof t.SOUND.BINVAL&&(e.sound.binval=t.SOUND.BINVAL),"string"==typeof t.SOUND.EXTVAL&&(e.sound.extval=t.SOUND.EXTVAL)),"string"==typeof t.UID&&(e.uid=t.UID),"string"==typeof t.URL&&(e.url=t.URL),"string"==typeof t.DESC&&(e.description=t.DESC),"object"!=typeof t.CLASS||Array.isArray(t.CLASS)||(t.CLASS.PUBLIC&&(e.classification="public"),t.CLASS.PRIVATE&&(e.classification="private"),t.CLASS.CONFIDENTIAL&&(e.classification="confidential")),"object"!=typeof t.KEY||Array.isArray(t.KEY)||(e.key={},"string"==typeof t.KEY.CRED&&(e.key.credential=t.KEY.CRED),"string"==typeof t.KEY.TYPE&&(e.key.type=t.KEY.TYPE)),this.json=e}initFromJSON(t){this.json=t}toJSON(){return this.json}toXML(t){const e=(new DOMParser).parseFromString('<vCard xmlns="vcard-temp"/>',"text/xml"),i=e.firstElementChild;if(this.json.fullName&&this.addNode(i,"FN",this.json.fullName),this.json.name){const t=this.addNode(i,"N");this.json.name.family&&this.addNode(t,"FAMILY",this.json.name.family),this.json.name.given&&this.addNode(t,"GIVEN",this.json.name.given),this.json.name.middle&&this.addNode(t,"MIDDLE",this.json.name.middle),this.json.name.prefix&&this.addNode(t,"PREFIX",this.json.name.prefix),this.json.name.suffix&&this.addNode(t,"SUFFIX",this.json.name.suffix)}if(this.json.nickName&&this.addNode(i,"NICKNAME",this.json.nickName),this.json.photo){const t=this.addNode(i,"PHOTO");this.json.photo.type&&this.addNode(t,"TYPE",this.json.photo.type),this.json.photo.binval&&this.addNode(t,"BINVAL",this.json.photo.binval)}if(this.json.birthday&&this.addNode(i,"BDAY",this.json.birthday),this.json.address&&this.json.address.forEach(t=>{const e=this.addNode(i,"ADR");t.home&&this.addNode(e,"HOME"),t.work&&this.addNode(e,"WORK"),t.postal&&this.addNode(e,"POSTAL"),t.parcel&&this.addNode(e,"PARCEL"),t.dom&&this.addNode(e,"DOM"),t.intl&&this.addNode(e,"INTL"),t.pref&&this.addNode(e,"PREF"),t.poBox&&this.addNode(e,"POBOX",t.poBox),t.extraAddress&&this.addNode(e,"EXTADD",t.extraAddress),t.street&&this.addNode(e,"STREET",t.street),t.locality&&this.addNode(e,"LOCALITY",t.locality),t.region&&this.addNode(e,"REGION",t.region),t.postcode&&this.addNode(e,"PCODE",t.postcode),t.country&&this.addNode(e,"CTRY",t.country)}),this.json.telephone&&this.json.telephone.forEach(t=>{const e=this.addNode(i,"TEL");t.home&&this.addNode(e,"HOME"),t.work&&this.addNode(e,"WORK"),t.voice&&this.addNode(e,"VOICE"),t.fax&&this.addNode(e,"FAX"),t.pager&&this.addNode(e,"PAGER"),t.msg&&this.addNode(e,"MSG"),t.cell&&this.addNode(e,"CELL"),t.video&&this.addNode(e,"VIDEO"),t.bbs&&this.addNode(e,"BBS"),t.modem&&this.addNode(e,"MODEM"),t.isdn&&this.addNode(e,"ISDN"),t.pcs&&this.addNode(e,"PCS"),t.pref&&this.addNode(e,"PREF"),t.number&&this.addNode(e,"NUMBER",t.number)}),this.json.email&&this.json.email.forEach(t=>{const e=this.addNode(i,"EMAIL");t.home&&this.addNode(e,"HOME"),t.work&&this.addNode(e,"WORK"),t.internet&&this.addNode(e,"INTERNET"),t.pref&&this.addNode(e,"PREF"),t.x400&&this.addNode(e,"X400"),t.address&&this.addNode(e,"USERID",t.address)}),this.json.jabberId&&this.addNode(i,"JABBERID",this.json.jabberId),this.json.mailer&&this.addNode(i,"MAILER",this.json.mailer),this.json.timeZone&&this.addNode(i,"TZ",this.json.timeZone),this.json.geolocation){const t=this.addNode(i,"GEO");this.json.geolocation.lat&&this.addNode(t,"LAT",this.json.geolocation.lat),this.json.geolocation.lng&&this.addNode(t,"LON",this.json.geolocation.lng)}if(this.json.title&&this.addNode(i,"TITLE",this.json.title),this.json.role&&this.addNode(i,"ROLE",this.json.role),this.json.logo){const t=this.addNode(i,"LOGO");this.json.logo.type&&this.addNode(t,"TYPE",this.json.logo.type),this.json.logo.binval&&this.addNode(t,"BINVAL",this.json.logo.binval),this.json.logo.extval&&this.addNode(t,"EXTVAL",this.json.logo.extval)}if(this.json.organisation){const t=this.addNode(i,"ORG");this.json.organisation.name&&this.addNode(t,"ORGNAME",this.json.organisation.name),this.json.organisation.unit&&this.addNode(t,"ORGUNIT",this.json.organisation.unit)}if(this.json.categories&&this.json.categories.forEach(t=>{const e=this.addNode(i,"CATEGORIES");t.keyword&&this.addNode(e,"KEYWORD",t.keyword)}),this.json.note&&this.addNode(i,"NOTE",this.json.note),this.json.productId&&this.addNode(i,"PRODID",this.json.productId),this.json.lastRevised&&this.addNode(i,"REV",this.json.lastRevised),this.json.sortString&&this.addNode(i,"SORT-STRING",this.json.sortString),this.json.sound){const t=this.addNode(i,"SOUND");this.json.sound.phonetic&&this.addNode(t,"PHONETIC",this.json.sound.phonetic),this.json.sound.extval&&this.addNode(t,"EXTVAL",this.json.sound.extval),this.json.sound.binval&&this.addNode(t,"BINVAL",this.json.sound.binval)}if(this.json.uid&&this.addNode(i,"UID",this.json.uid),this.json.url&&this.addNode(i,"URL",this.json.url),this.json.description&&this.addNode(i,"DESC",this.json.description),this.json.classification){const t=this.addNode(i,"CLASS");"public"===this.json.classification&&this.addNode(t,"PUBLIC"),"private"===this.json.classification&&this.addNode(t,"PRIVATE"),"confidential"===this.json.classification&&this.addNode(t,"CONFIDENTIAL")}if(this.json.key){const t=this.addNode(i,"KEY");this.json.key.credential&&this.addNode(t,"CRED",this.json.key.credential),this.json.key.type&&this.addNode(t,"TYPE",this.json.key.type)}let n="";if(t)n=(new XMLSerializer).serializeToString(e);else{const t=e.children[0];for(let e=0;e<t.childElementCount;e++)console.log(t.childNodes.item(e)),n+=(new XMLSerializer).serializeToString(t.childNodes.item(e))}return n}addNode(t,e,i){const n=t.ownerDocument.createElement(e);return t.appendChild(n),void 0!==i&&(n.textContent=i),n}}e.VCardSimple=n},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),e.IQError=class extends Error{constructor(t,e){super(t),this.iqResponse=e}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),e.NotConnectedError=class extends Error{constructor(t,e){super(e),this.connectionStatus=t}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(24);e.CommsEventArgs=class extends n.BaseEventArgs{constructor(t,e){super(),this.success=t,e&&(this.errorMessage=e)}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(24);e.UserActivityEventArgs=class extends n.BaseEventArgs{constructor(t,e){super(),this.jid=t,this.date=e}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(24);e.UserConnectionStatusEventArgs=class extends n.BaseEventArgs{constructor(t,e){super(),this.jid=t,this.connectionStatus=e}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(24);e.RoomParticipantUpdateEventArgs=class extends n.BaseEventArgs{constructor(t,e,i,n){super(),this.jid=t,this.roomName=e,this.role=i,this.roomRole=n}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(24);e.ConnectionStatusEventArgs=class extends n.BaseEventArgs{constructor(t,e,i){super(),this.status=t,this.reconnectTime=e,this.disconnectStatus=i}}},function(t,e){t.exports=moment},function(t,e,i){"use strict";i.r(e),function(t){var i,n,o=[];function s(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}function r(t,e){Object.defineProperty(this,"kind",{value:t,enumerable:!0}),e&&e.length&&Object.defineProperty(this,"path",{value:e,enumerable:!0})}function a(t,e,i){a.super_.call(this,"E",t),Object.defineProperty(this,"lhs",{value:e,enumerable:!0}),Object.defineProperty(this,"rhs",{value:i,enumerable:!0})}function c(t,e){c.super_.call(this,"N",t),Object.defineProperty(this,"rhs",{value:e,enumerable:!0})}function l(t,e){l.super_.call(this,"D",t),Object.defineProperty(this,"lhs",{value:e,enumerable:!0})}function d(t,e,i){d.super_.call(this,"A",t),Object.defineProperty(this,"index",{value:e,enumerable:!0}),Object.defineProperty(this,"item",{value:i,enumerable:!0})}function h(t,e,i){var n=t.slice((i||e)+1||t.length);return t.length=e<0?t.length+e:e,t.push.apply(t,n),t}function u(t){var e=typeof t;return"object"!==e?e:t===Math?"math":null===t?"null":Array.isArray(t)?"array":"[object Date]"===Object.prototype.toString.call(t)?"date":"function"==typeof t.toString&&/^\/.*\//.test(t.toString())?"regexp":"object"}function p(t,e,i,n,o,s,r){r=r||[];var g=(o=o||[]).slice(0);if(void 0!==s){if(n){if("function"==typeof n&&n(g,s))return;if("object"==typeof n){if(n.prefilter&&n.prefilter(g,s))return;if(n.normalize){var m=n.normalize(g,s,t,e);m&&(t=m[0],e=m[1])}}}g.push(s)}"regexp"===u(t)&&"regexp"===u(e)&&(t=t.toString(),e=e.toString());var f=typeof t,_=typeof e,v="undefined"!==f||r&&r[r.length-1].lhs&&r[r.length-1].lhs.hasOwnProperty(s),y="undefined"!==_||r&&r[r.length-1].rhs&&r[r.length-1].rhs.hasOwnProperty(s);if(!v&&y)i(new c(g,e));else if(!y&&v)i(new l(g,t));else if(u(t)!==u(e))i(new a(g,t,e));else if("date"===u(t)&&t-e!=0)i(new a(g,t,e));else if("object"===f&&null!==t&&null!==e)if(r.filter(function(e){return e.lhs===t}).length)t!==e&&i(new a(g,t,e));else{if(r.push({lhs:t,rhs:e}),Array.isArray(t)){var C;for(t.length,C=0;C<t.length;C++)C>=e.length?i(new d(g,C,new l(void 0,t[C]))):p(t[C],e[C],i,n,g,C,r);for(;C<e.length;)i(new d(g,C,new c(void 0,e[C++])))}else{var b=Object.keys(t),w=Object.keys(e);b.forEach(function(o,s){var a=w.indexOf(o);a>=0?(p(t[o],e[o],i,n,g,o,r),w=h(w,a)):p(t[o],void 0,i,n,g,o,r)}),w.forEach(function(t){p(void 0,e[t],i,n,g,t,r)})}r.length=r.length-1}else t!==e&&("number"===f&&isNaN(t)&&isNaN(e)||i(new a(g,t,e)))}function g(t,e,i,n){return n=n||[],p(t,e,function(t){t&&n.push(t)},i),n.length?n:void 0}function m(t,e,i){if(t&&e&&i&&i.kind){for(var n=t,o=-1,s=i.path?i.path.length-1:0;++o<s;)void 0===n[i.path[o]]&&(n[i.path[o]]="number"==typeof i.path[o]?[]:{}),n=n[i.path[o]];switch(i.kind){case"A":!function t(e,i,n){if(n.path&&n.path.length){var o,s=e[i],r=n.path.length-1;for(o=0;o<r;o++)s=s[n.path[o]];switch(n.kind){case"A":t(s[n.path[o]],n.index,n.item);break;case"D":delete s[n.path[o]];break;case"E":case"N":s[n.path[o]]=n.rhs}}else switch(n.kind){case"A":t(e[i],n.index,n.item);break;case"D":e=h(e,i);break;case"E":case"N":e[i]=n.rhs}return e}(i.path?n[i.path[o]]:n,i.index,i.item);break;case"D":delete n[i.path[o]];break;case"E":case"N":n[i.path[o]]=i.rhs}}}i="object"==typeof t&&t?t:"undefined"!=typeof window?window:{},(n=i.DeepDiff)&&o.push(function(){void 0!==n&&i.DeepDiff===g&&(i.DeepDiff=n,n=void 0)}),s(a,r),s(c,r),s(l,r),s(d,r),Object.defineProperties(g,{diff:{value:g,enumerable:!0},observableDiff:{value:p,enumerable:!0},applyDiff:{value:function(t,e,i){t&&e&&p(t,e,function(n){i&&!i(t,e,n)||m(t,e,n)})},enumerable:!0},applyChange:{value:m,enumerable:!0},revertChange:{value:function(t,e,i){if(t&&e&&i&&i.kind){var n,o,s=t;for(o=i.path.length-1,n=0;n<o;n++)void 0===s[i.path[n]]&&(s[i.path[n]]={}),s=s[i.path[n]];switch(i.kind){case"A":!function t(e,i,n){if(n.path&&n.path.length){var o,s=e[i],r=n.path.length-1;for(o=0;o<r;o++)s=s[n.path[o]];switch(n.kind){case"A":t(s[n.path[o]],n.index,n.item);break;case"D":case"E":s[n.path[o]]=n.lhs;break;case"N":delete s[n.path[o]]}}else switch(n.kind){case"A":t(e[i],n.index,n.item);break;case"D":case"E":e[i]=n.lhs;break;case"N":e=h(e,i)}return e}(s[i.path[n]],i.index,i.item);break;case"D":case"E":s[i.path[n]]=i.lhs;break;case"N":delete s[i.path[n]]}}},enumerable:!0},isConflict:{value:function(){return void 0!==n},enumerable:!0},noConflict:{value:function(){return o&&(o.forEach(function(t){t()}),o=null),g},enumerable:!0}}),e.default=g}.call(this,i(30))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0);e.BaseHandler=class{constructor(t){this.messageKey=null,this.eventType=[],this.layer=t,this.defaultAlerts=new o.DefaultAlerts(t)}createMessage(t){throw new Error("Not implemented")}createIq(t){throw new Error("Not implemented")}createBotMessage(t,e){throw new Error("Not implemented")}handleFailedBotResponse(t,e){return n(this,void 0,void 0,function*(){return!1})}handleMessage(t){return n(this,void 0,void 0,function*(){})}handleMessageUpdate(t){return n(this,void 0,void 0,function*(){})}handleMessageReceipt(t){return n(this,void 0,void 0,function*(){})}handleEvent(t,e){return n(this,void 0,void 0,function*(){})}handleIqResponse(t,e){return n(this,void 0,void 0,function*(){return e})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){return e.iqResponse})}callCreateMessage(t){return n(this,void 0,void 0,function*(){const e=this.createMessage(t);return this._embelishI18n(e),e})}callCreateIq(t){return n(this,void 0,void 0,function*(){const e=this.createIq(t);return this._embelishI18n(e),e})}callCreateBotMessage(t,e){return n(this,void 0,void 0,function*(){const e=yield this.createBotMessage(t);return this._embelishI18n(e),e})}callHandleFailedBotResponse(t,e){return n(this,void 0,void 0,function*(){return!(!e||!0===e.success)&&(yield this.handleFailedBotResponse(t,e))})}callHandleMessage(t){return n(this,void 0,void 0,function*(){yield this.handleMessage(t)})}callHandleMessageUpdate(t){return n(this,void 0,void 0,function*(){yield this.handleMessageUpdate(t)})}callHandleMessageReceipt(t){return n(this,void 0,void 0,function*(){yield this.handleMessageReceipt(t)})}callHandleEvent(t,e){return n(this,void 0,void 0,function*(){yield this.handleEvent(t,e)})}callHandleIqResponse(t,e){return n(this,void 0,void 0,function*(){return yield this.handleIqResponse(t,e)})}callHandleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){return yield this.handleIqErrorResponse(t,e)})}_embelishI18n(t){this.layer.config.i18n&&!0===this.layer.config.i18n.enabled&&(t.language=this.layer.config.i18n.language,t.locale=this.layer.config.i18n.locale)}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Broadcaster="broadcaster"]="Broadcaster",t[t.Responder="responder"]="Responder"}(e.AppMode||(e.AppMode={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(12);e.Metadata=class{constructor(t,e){t&&(this._scope="string"==typeof t?t:"name"in t?t.name:t.toString()),this._i18nItems=new Map,e&&this.fillFromEnum(e)}fillFromEnum(t){let e=0;for(const i in t)t.hasOwnProperty(i)&&e%2!=0&&this.addI18nItem(i),e+=1}addI18nItem(t){t&&this._i18nItems.set(t.toString(),new n.I18nItem(this._scope,t.toString()))}getI18nItem(t){if(!t)return;const e=t.toString();if(!this._i18nItems.has(e))throw new Error(`No i18n item registered for key: "${e}"`);return this._i18nItems.get(e)}getUniqueI18Keys(t){return[...this._i18nItems.values()].map(e=>t?e.scopedKey:e.key).filter((t,e,i)=>i.indexOf(t)===e)}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),e.I18nItem=class{constructor(t,e){this.scope=t,this.key=e}get scopedKey(){return`${this.scope}_${this.key}`}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Meta="meta"]="Meta",t[t.Chat="chat"]="Chat",t[t.Divider="divider"]="Divider"}(e.ChatEntryType||(e.ChatEntryType={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Participant="member"]="Participant",t[t.Administrator="admin"]="Administrator",t[t.Owner="owner"]="Owner"}(e.ChatRole||(e.ChatRole={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Connecting="connecting"]="Connecting",t[t.Connected="connected"]="Connected",t[t.Disconnected="disconnected"]="Disconnected",t[t.Disconnecting="disconnecting"]="Disconnecting"}(e.ConnectionStatus||(e.ConnectionStatus={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),e.DisconnectionStatus=class{constructor(t,e){this.wontReconnect=t,this.reason=e}getReason(){return this.reason}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.None="none"]="None",t[t.Participant="participant"]="Participant",t[t.Moderator="moderator"]="Moderator"}(e.RoomRole||(e.RoomRole={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Contact="contact"]="Contact",t[t.VCard="vcard"]="VCard",t[t.Participant="participant"]="Participant",t[t.DirectoryUser="directoryuser"]="DirectoryUser"}(e.UserAdditionalDetailsType||(e.UserAdditionalDetailsType={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(43),o=i(20);e.getCommonI18nKeys=function(t=!1,...e){return 0===e.length&&(e=[...s.keys()]),e.reduce((e,i)=>e.concat(function(t,e){return(null===e||s.has(e))&&s.get(e).getUniqueI18Keys(t)||[]}(t,i)),[]).filter((t,e,i)=>i.indexOf(t)===e).sort()};const s=new Map;s.set("DefaultAlerts",n.DefaultAlertsMetadata.instance),s.set("Common",o.CommonMetadata)},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(11);e.AttachmentDownloadComplete=class extends n.BaseEventArgs{constructor(t,e,i){super(),this.filepath=t,this.type=i,this.conversationId=e}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(11);e.AudioAttachmentDownloadComplete=class extends n.BaseEventArgs{constructor(t,e){super(),this.filepath=t,this.conversation=e}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(45);e.ChatNotificationEventArgs=class extends n.ChatEntryEventArgs{constructor(t,e,i,n){super(t),this.conversationTitle=e,this.messagePreview=i,this.isForCurrentConversation=n}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(5);e.ConversationParticiantRoleEventArgs=class extends n.ConversationEventArgs{constructor(t,e,i){super(t),this.participant=e,this.newRole=i}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(5);e.ConversationParticiantsEventArgs=class extends n.ConversationEventArgs{constructor(t,e){super(t),this.participants=e}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(47);e.ForceQuitConversationEventArgs=class extends n.ConversationEventArgs{constructor(t,e,i){super(t),this.instigator=e,this.reason=i}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(123);e.RenderMixin=n.RenderMixin;var o=i(124);e.ComponentStylesMixin=o.ComponentStylesMixin;var s=i(125);e.OverridingStylesMixin=s.OverridingStylesMixin},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),e.RenderMixin=function(t){function e(t){return t instanceof Array?t:[t]}return class extends t{renderCallback(){return[...e(this.styleElements||[]),...e(this.componentMarkup&&this.componentMarkup()||[])]}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(25);e.ComponentStylesMixin=function(t){class e extends t{constructor(...t){super(...t);const i=window.ShadyCSS,o=!i;if(this.styleElements||(this.styleElements=[]),this.componentStyles)if(o)this.styleElements=[n.h("style",this.componentStyles),...this.styleElements];else{if(!this.overridingStylesMixinApplied)return;const t=this.localName;if(!0!==e._seenTags[t]){e._seenTags[t]=!0;const n=document.createElement("template");n.innerHTML=`<style>${this.componentStyles}</style>`,i.prepareTemplate(n,t)}}}get componentStylesMixinApplied(){return!0}}return e._seenTags={},e}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(25);e.OverridingStylesMixin=function(t){class e extends t{constructor(...t){super(...t);const i=this.localName,o=window.ShadyCSS,s=!o,r=window.__CtOverridingStyles||{},a=[...r["*"]||[],...r[i.toLowerCase()]||[]];if(s)a&&(this.styleElements||(this.styleElements=[]),a.forEach(t=>{const e=/^(.*?)\.css$/.test(t)?`@import url('${t}');`:t;this.styleElements=[...this.styleElements,n.h("style",e)]}));else if(!0!==e._seenTags[i]){e._seenTags[i]=!0;const t=[];a&&a.forEach(e=>{const i=/^(.*?)\.css$/.test(e)?function(t){return new Promise(e=>{const i=new XMLHttpRequest;i.onreadystatechange=(()=>{i.readyState===XMLHttpRequest.DONE&&(200===i.status?e(i.responseText):e(`:host { content: 'Error: could not load stylesheet: ${t}' }`))}),i.open("GET",t),i.send()})}(e):Promise.resolve(e);t.push(i)}),Promise.all(t).then(t=>{const e=document.createElement("template");if(this.componentStyles&&!0===this.componentStylesMixinApplied&&(e.innerHTML+=this.componentStyles),t.length>0){const i=t.join("\n");e.innerHTML+=`<style>${i}</style>`}e.innerHTML.length&&o.prepareTemplate(e,i)})}}get overridingStylesMixinApplied(){return!0}}return e._seenTags={},e}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(48),r=i(34),a=i(11),c=i(42),l=i(17),d=i(0),h=i(25);class u extends s.CTBaseComponent{constructor(){super(...arguments),this._connected=!1,this._metadata=null,this._defaultAlerts=null,this._debouncers={},this._listenerUnsubscribers=[]}get layer(){return this._baseLayer?this._baseLayer:null}get metadata(){if(null===this._metadata){if(Object.getPrototypeOf(this)._metadata)return Object.getPrototypeOf(this)._metadata;throw new Error(`Metadata not set for component <${this.localName}>`)}return this._metadata}get defaultAlerts(){return this._defaultAlerts||(this._defaultAlerts=new d.DefaultAlerts(this._baseLayer))}get generateComponentStyles(){return null}getStyles(){return this.styles&&this.styles.length?this.styles.reduce((t,e)=>t+=e,""):this.generateComponentStyles||""}get componentStyles(){return this.getStyles()}componentMarkup(){if(!this.layer){const t=this._findParentCTLayerComponent();if(t&&(this._baseLayer=t._baseLayer,this._initializeForBaseLayer()),!this._connected)return null;if(!this.layer)return t?console.error(`Component <${this.localName}> child of <${t.localName}> does not have an owner layer specified`):console.error(`Component <${this.localName}> does not have an owner layer specified`),h.h("em",{style:{display:"inline-block",fontSize:"12px",color:"#900",backgroundColor:"#FF0",padding:"3px 6px"}},`${this.localName}:`,h.h("br"),"OWNER NOT SPECIFIED")}return this.generateComponentMarkup()}connectedCallback(){super.connectedCallback()}disconnectedCallback(){super.disconnectedCallback(),this._listenerUnsubscribers.forEach(t=>t())}attributeChangedCallback(t,e,i){switch(super.attributeChangedCallback(t,e,i),t){case"owner":i!==e&&""!==i&&(this.owner=i,this._attemptConnectToBaseLayer())}}setMetadata(t){this._metadata=t}defer(t){setTimeout(t,0)}debounce(t,e,i=100){clearTimeout(this._debouncers[t]),this._debouncers[t]=setTimeout(()=>{e(),delete this._debouncers[t]},i)}cancelDebounce(t){clearTimeout(this._debouncers[t])}emitEvent(t,e){return o(this,void 0,void 0,function*(){this._baseLayer?yield this._baseLayer.emit(t,e):console.error(`Could not emit event from component <${this.localName}> - it does not have an owner layer specified`)})}emitComponentEvent(t,e){this._baseLayer?(this._baseLayer.logger.log(l.LoggerTypes.Events,`%c RAISING COMPONENT EVENT:%c ${t}`,"color: #066; font-weight: bold;","color: #999; font-weight: normal;",{component:this,data:e}),this.dispatchEvent(new CustomEvent(t,{detail:e}))):console.error(`Could not emit event from component <${this.localName}> - it does not have an owner layer specified`)}addListener(t,e,i){if(this._baseLayer){let n=!1,o=!0;i&&!0===i.onceOnly&&(n=!0),i&&!0===i.dontSuppress&&(o=!1);const s=this._baseLayer.on(t,e,n,o);this._listenerUnsubscribers.push(s)}else console.error(`Could not set event handler on component <${this.localName}> - it does not have an owner layer specified`)}addListeners(t,e,i){t.forEach(t=>{this.addListener(t,e,i)})}launchModal(t){this._baseLayer.emit(a.BaseEvents._Request_RaiseAlert,t)}launchAckownledgeDialog(t,e,i){this._baseLayer.emit(a.BaseEvents._Request_RaiseAlert,this.defaultAlerts.AlertAcknowledge(t,e,1,{okay:()=>{i()}}))}launchConfirmationDialog(t,e,i,n){this._baseLayer.emit(a.BaseEvents._Request_RaiseAlert,this.defaultAlerts.AlertYesNoQuestion(t,e,1,{yes:()=>{i()},no:()=>{"function"==typeof n&&n()}}))}showWaitingMessage(t){return o(this,void 0,void 0,function*(){yield this._baseLayer.showWaitingMessage(t)})}dismissWaitingMessage(){return o(this,void 0,void 0,function*(){yield this._baseLayer.dismissWaitingMessage()})}getLabel(t,e){return this.layer.getLabel(t,e)}translateText(t,e){return this._baseLayer.translateText(t,!1)}translateI18nItem(t){let e;if(t&&["scope","key"].every(e=>t.hasOwnProperty(e))?e=t.key:(e=t.toString(),t=this.metadata&&this.metadata.getI18nItem(e)||null),null===t)return e;if(null===this.metadata)return e;if(!this._baseLayer.config.i18n||!0!==this._baseLayer.config.i18n.enabled)return e;const i=this._baseLayer.translateText(t.scopedKey,!0);return null!==i?i:this._baseLayer.translateText(t.key)}_attemptConnectToBaseLayer(){this.owner&&c.LayerRegistration.onReady(this.owner,()=>{this._connectToLayer()})}_connectToLayer(){return o(this,void 0,void 0,function*(){this._connected||this.owner&&(this._baseLayer=c.LayerRegistration.getInstance(this.owner)||null,this._baseLayer&&(yield this._initializeForBaseLayer()))})}_initializeForBaseLayer(){return o(this,void 0,void 0,function*(){this.layer&&(yield this.initialize.apply(this),this.setupListeners(),this._connected=!0,this.forceRedraw(),["ct-cl-chat-message-list"].includes(this.nodeName.toLowerCase())||this.addListener(a.BaseEvents._Request_RedrawAllUIs,()=>o(this,void 0,void 0,function*(){this.layer&&(yield this.initialize.apply(this),this.forceRedraw())})))})}_findParentCTLayerComponent(){let t=this,e=!1;do{(t=t.parentNode||t.host)||(e=!0),t&&t.owner&&(e=!0)}while(!e);return t||null}}u.is=null,n([r.prop({type:String,attribute:!0})],u.prototype,"owner",void 0),e.CTLayerComponent=u},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(25);e.Stroolean=n.prop.create({coerce:t=>"string"==typeof t&&"true"===t.toLowerCase(),default:!1,deserialize:t=>"string"==typeof t&&"true"===t.toLowerCase(),serialize:t=>t?"true":"false"}),e.NullableNumber=n.prop.create({coerce:t=>"null"===t?null:parseInt(t),default:null,deserialize:t=>"null"===t?null:parseInt(t),serialize:t=>null==t?"null":t.toString()})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.START="start"]="START",t[t.UPDATE="update"]="UPDATE",t[t.ADD="add"]="ADD",t[t.REMOVE="remove"]="REMOVE",t[t.CHANGEROLE="changerole"]="CHANGEROLE",t[t.LEFT="left"]="LEFT",t[t.END="end"]="END",t[t.ACK="acknowledge"]="ACK",t[t.RECEIVED="received"]="RECEIVED"}(e.ChatMetaActivityType||(e.ChatMetaActivityType={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Direct="direct"]="Direct",t[t.Named="named"]="Named"}(e.ConversationType||(e.ConversationType={}))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0}),(e.Icons||(e.Icons={})).UI={Pencil:{viewBox:"0 0 1024 1024",paths:["M732.458 3.542l-572.458 572.458-160 448 447.666-160 572.792-572.458c32-128-160-320-288-288zM288 704l-64-64 544-544 64 64-544 544z"]},Attachment:{viewBox:"0 0 1097 1024",paths:["M548.571 384c90.857 0 164.571 73.714 164.571 164.571s-73.714 164.571-164.571 164.571-164.571-73.714-164.571-164.571 73.714-164.571 164.571-164.571zM950.857 146.286c80.571 0 146.286 65.714 146.286 146.286v512c0 80.571-65.714 146.286-146.286 146.286h-804.571c-80.571 0-146.286-65.714-146.286-146.286v-512c0-80.571 65.714-146.286 146.286-146.286h128l29.143-77.714c14.286-37.714 58.857-68.571 98.857-68.571h292.571c40 0 84.571 30.857 98.857 68.571l29.143 77.714h128zM548.571 804.571c141.143 0 256-114.857 256-256s-114.857-256-256-256-256 114.857-256 256 114.857 256 256 256z"]},Error:{viewBox:"0 0 1024 1024",paths:["M512 96c-111.118 0-215.584 43.272-294.156 121.844s-121.844 183.038-121.844 294.156c0 111.118 43.272 215.584 121.844 294.156s183.038 121.844 294.156 121.844c111.118 0 215.584-43.272 294.156-121.844s121.844-183.038 121.844-294.156c0-111.118-43.272-215.584-121.844-294.156s-183.038-121.844-294.156-121.844zM512 0v0c282.77 0 512 229.23 512 512s-229.23 512-512 512c-282.77 0-512-229.23-512-512s229.23-512 512-512zM448 704h128v128h-128zM448 192h128v384h-128z"]},SendMessage:{viewBox:"0 0 1024 1024",paths:["M448 704l393.636 140.488 182.364-797.356zM320 659.908l704-612.776-1024 506.462zM448 771.954v252.046l185.752-185.752z"]},Reconnect:{viewBox:"0 0 1024 1024",paths:["M1024 384h-384l143.53-143.53c-72.53-72.526-168.96-112.47-271.53-112.47s-199 39.944-271.53 112.47c-72.526 72.53-112.47 168.96-112.47 271.53s39.944 199 112.47 271.53c72.53 72.526 168.96 112.47 271.53 112.47s199-39.944 271.528-112.472c6.056-6.054 11.86-12.292 17.456-18.668l96.32 84.282c-93.846 107.166-231.664 174.858-385.304 174.858-282.77 0-512-229.23-512-512s229.23-512 512-512c141.386 0 269.368 57.326 362.016 149.984l149.984-149.984v384z"]},Download:{viewBox:"0 0 1024 1024",paths:["M576 576h-128v192h-160l224 224 224-224h-160z","M892.216 514.542c2.49-11.29 3.784-22.87 3.784-34.542 0-88.224-71.776-160-160-160-13.956 0-27.796 1.83-41.164 5.378-24.838-77.286-97.404-133.378-182.836-133.378-86.654 0-160.886 58.042-184.312 138.118-22.982-6.66-47.052-10.118-71.688-10.118-141.158 0-256 114.84-256 256 0 61.986 22.444 121.798 63.2 168.42 40.354 46.164 95.852 76.346 156.266 84.988 1.538 0.218 3.064 0.326 4.572 0.326 15.666 0 29.354-11.514 31.638-27.472 2.502-17.496-9.652-33.708-27.146-36.208-45.262-6.474-86.864-29.116-117.144-63.754-30.558-34.956-47.386-79.81-47.386-126.3 0-105.87 86.13-192 192-192 52.024 0 100.73 20.466 137.146 57.63 12.368 12.624 32.63 12.83 45.252 0.458 12.624-12.37 12.83-32.628 0.458-45.252-15.676-15.998-33.070-29.66-51.76-40.848 12.84-57.42 64.304-99.988 124.904-99.988 70.58 0 128 57.42 128 128 0 8.706-0.876 17.398-2.602 25.832-3.542 17.316 7.624 34.222 24.938 37.764 2.164 0.444 4.32 0.656 6.448 0.656 14.884 0 28.218-10.442 31.318-25.592 2.218-10.854 3.494-21.972 3.812-33.126 10.244-3.624 21.096-5.534 32.086-5.534 52.936 0 96 43.066 96 96 0 10.964-1.88 21.784-5.484 32h-26.516c-17.674 0-32 14.326-32 32s14.326 32 32 32h64c52.934 0 96 43.066 96 96s-43.066 96-96 96h-64c-17.674 0-32 14.326-32 32s14.326 32 32 32h64c88.224 0 160-71.776 160-160 0-78.594-56.976-144.086-131.784-157.458z"]},ScrollToBottom:{viewBox:"0 0 1024 1024",nodes:[{name:"mask",attributes:{id:"ScrollToBottom-Mask"},children:[{name:"rect",attributes:{width:"100%",height:"100%",fill:"white"}},{name:"path",attributes:{d:"M512 684l150-350-300 0z",fill:"black"}}]},{name:"path",attributes:{d:"M512 64c282.77 0 512 186.25 512 416 0 229.752-229.23 416-512 416-27.156 0-53.81-1.734-79.824-5.044-109.978 109.978-241.25 129.7-368.176 132.596v-26.916c68.536-33.578 128-94.74 128-164.636 0-9.754-0.758-19.33-2.164-28.696-115.796-76.264-189.836-192.754-189.836-323.304 0-229.75 229.23-416 512-416z",mask:"url(#ScrollToBottom-Mask)"}}]},Plus:{viewBox:"0 0 1024 1024",paths:["M992 384h-352v-352c0-17.672-14.328-32-32-32h-192c-17.672 0-32 14.328-32 32v352h-352c-17.672 0-32 14.328-32 32v192c0 17.672 14.328 32 32 32h352v352c0 17.672 14.328 32 32 32h192c17.672 0 32-14.328 32-32v-352h352c17.672 0 32-14.328 32-32v-192c0-17.672-14.328-32-32-32z"]},Photo:{viewBox:"0 0 1024 1024",paths:["M959.884 128c0.040 0.034 0.082 0.076 0.116 0.116v767.77c-0.034 0.040-0.076 0.082-0.116 0.116h-895.77c-0.040-0.034-0.082-0.076-0.114-0.116v-767.772c0.034-0.040 0.076-0.082 0.114-0.114h895.77zM960 64h-896c-35.2 0-64 28.8-64 64v768c0 35.2 28.8 64 64 64h896c35.2 0 64-28.8 64-64v-768c0-35.2-28.8-64-64-64v0z","M832 288c0 53.020-42.98 96-96 96s-96-42.98-96-96 42.98-96 96-96 96 42.98 96 96z","M896 832h-768v-128l224-384 256 320h64l224-192z"]},Cross:{viewBox:"0 0 1024 1024",paths:["M893.254 221.254l-90.508-90.508-290.746 290.744-290.746-290.744-90.508 90.506 290.746 290.748-290.746 290.746 90.508 90.508 290.746-290.746 290.746 290.746 90.508-90.51-290.744-290.744z"]},MusicalNote:{viewBox:"0 0 1024 1024",paths:["M812.158 294.412c-87.050-122.21-78.88-35.914-163.208-279.684l-89.178-14.728-99.218 732.95c-223.632-127.958-364.672 3.468-328.984 168.886 18.92 87.712 161.432 170.274 301.8 88.78 66.342-39.89 87.672-104.22 96.14-149.838l70.876-543.852c252.89 222.974 172.142 357.892 119.85 513.244 107.498-44.334 275.88-239.888 91.922-515.758z"]},Microphone:{viewBox:"0 0 1024 1024",paths:["M896 448c0-6.26-0.152-12.59-0.454-18.812-1.278-26.478-23.746-46.918-50.256-45.632-26.478 1.278-46.908 23.778-45.63 50.256 0.224 4.688 0.34 9.46 0.34 14.186 0 158.894-129.196 288.166-288 288.166s-288-129.272-288-288.166c0-4.692 0.114-9.438 0.336-14.106 1.27-26.48-19.166-48.974-45.644-50.246-26.46-1.26-48.974 19.166-50.244 45.646-0.298 6.196-0.448 12.49-0.448 18.708 0 190.018 138.622 348.226 320 378.8v133.2c0 35.346 28.654 64 64 64s64-28.654 64-64v-133.2c181.378-30.574 320-188.782 320-378.8z","M512 0c-106.040 0-192 85.96-192 192v256c0 106.040 85.96 192 192 192s192-85.96 192-192v-256c0-106.040-85.96-192-192-192z"]},CheckboxChecked:{viewBox:"0 0 1024 1024",paths:["M896 0h-768c-70.4 0-128 57.6-128 128v768c0 70.4 57.6 128 128 128h768c70.4 0 128-57.6 128-128v-768c0-70.4-57.6-128-128-128zM448 794.51l-237.254-237.256 90.51-90.508 146.744 146.744 306.746-306.746 90.508 90.51-397.254 397.256z"]},CheckboxUnchecked:{viewBox:"0 0 1024 1024",paths:["M896 0h-768c-70.4 0-128 57.6-128 128v768c0 70.4 57.6 128 128 128h768c70.4 0 128-57.6 128-128v-768c0-70.4-57.6-128-128-128zM896 896h-768v-768h768v768z"]},SquareFilled:{viewBox:"0 0 1024 1024",paths:["M128 128h768v768h-768z"]},CircleFilled:{viewBox:"0 0 1024 1024",paths:["M0 512c0-282.77 229.23-512 512-512s512 229.23 512 512c0 282.77-229.23 512-512 512s-512-229.23-512-512z"]},Play:{viewBox:"0 0 1024 1024",paths:["M192 128l640 384-640 384z"]},Pause:{viewBox:"0 0 1024 1024",paths:["M128 128h320v768h-320zM576 128h320v768h-320z"]},AlertBell:{viewBox:"0 0 1024 1024",paths:["M1024 832c-106.042 0-192-85.96-192-192v-285.090c0-140.738-109.942-258.128-256-285.084v-69.826h-128v69.824c-146.064 26.958-256 144.346-256 285.084v285.092c0 106.040-85.962 192-192 192v64h429.598c-5.208 11.424-8.11 24.118-8.11 37.49 0 49.986 40.524 90.51 90.512 90.51 49.984 0 90.51-40.524 90.51-90.51 0-13.376-2.902-26.066-8.112-37.49h429.602v-64z"]},AlertBellRinging:{viewBox:"0 0 1024 1024",paths:["M1024 832c-106.042 0-192-85.96-192-192v-285.090c0-140.738-109.942-258.128-256-285.084v-69.826h-128v69.824c-146.064 26.958-256 144.346-256 285.084v285.092c0 106.040-85.962 192-192 192v64h429.598c-5.208 11.424-8.11 24.118-8.11 37.49 0 49.986 40.524 90.51 90.512 90.51 49.984 0 90.51-40.524 90.51-90.51 0-13.376-2.9-26.066-8.112-37.49h429.602v-64z","M990.92 384c-16.714 0-30.786-12.98-31.9-29.9-7.526-114.362-58.112-220.42-142.44-298.638-12.958-12.018-13.718-32.264-1.7-45.222 12.020-12.956 32.266-13.716 45.222-1.7 96.366 89.384 154.174 210.614 162.78 341.358 1.16 17.634-12.196 32.872-29.83 34.032-0.714 0.048-1.428 0.070-2.132 0.070z","M33.082 384c-0.708 0-1.416-0.022-2.132-0.070-17.636-1.16-30.99-16.398-29.83-34.032 8.606-130.75 66.416-251.982 162.778-341.36 12.96-12.018 33.206-11.254 45.224 1.702 12.018 12.958 11.256 33.204-1.702 45.222-84.326 78.214-134.912 184.272-142.44 298.64-1.112 16.92-15.186 29.898-31.898 29.898z"]},PickVideo:{viewBox:"0 0 1024 1024",paths:["M78.302 262.54l865.444-231.884 49.69 185.452-865.444 231.884zM128 448v576h896v-576h-896zM448 896v-320l256 160-256 160z"]},RecordVideo:{viewBox:"0 0 1024 1024",paths:["M978.84 256.252c-10.588 0-21.458 3.722-31.436 10.766l-179.404 126.614v-105.632c0-52.8-43.2-96-96-96h-576c-52.8 0-96 43.2-96 96v448c0 52.8 43.2 96 96 96h576c52.8 0 96-43.2 96-96v-105.63l179.402 126.614c9.978 7.042 20.848 10.764 31.434 10.766 0.002 0 0.002 0 0.006 0 14.088 0 26.954-6.496 35.292-17.822 6.456-8.77 9.868-20.054 9.868-32.636v-410.582c-0.002-33.126-22.72-50.458-45.162-50.458z"]}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";function n(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}Object.defineProperty(e,"__esModule",{value:!0}),n(i(139)),n(i(140))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.AUDIO="audio"]="AUDIO",t[t.IMAGE="image"]="IMAGE",t[t.VIDEO="video"]="VIDEO"}(e.SupportedAttachmentType||(e.SupportedAttachmentType={}))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.defaultAlertResponseOption={id:"_default",name:"Acknowledge",options:[{name:"Acknowledge",type:"button",label:"Acknowledge",value:"Acknowledge"}]},e.directConversationConfig={id:"1",sortOrder:1,name:"Direct",shortDescription:"A personal conversation with you and one or more participants.",colorCode:"",displayGroup:"normal",behaviour:{chatAvailable:!0,canSendAttachmentsWithinConversation:!0}},e.namedConversationConfig={id:"2",sortOrder:2,name:"Named",shortDescription:"A converstion with a subject and context.",colorCode:"",displayGroup:"normal",behaviour:{chatAvailable:!0,namedSettings:{subjectRequired:!0,descriptionRequired:!0},participantCanLeave:!0,ownerCanEditAfterSend:!0,ownerCanCloseEarly:!0,ownerCanAddAdditionalContacts:!0,canSendAttachmentsWithinConversation:!0}},e.page={id:"3",sortOrder:3,name:"Page",shortDescription:"A single page that requires a prompted response from the participants.",colorCode:"",displayGroup:"normal",behaviour:{warnWhenNoContacts:!0,chatAvailable:!1,namedSettings:{subjectRequired:!0,subjectFieldLabel:"Title",descriptionRequired:!0,descriptionFieldLabel:"Description"},participantCanLeave:!1,ownerCanEditAfterSend:!1,ownerCanCloseEarly:!1,canSendAttachmentsWithinConversation:!1,autoRemoveOnClose:!0,alert:{autoAlert:!0,alertResponseOptions:[e.defaultAlertResponseOption],shouldOpenConversationAfterResponded:!1,participantAlertResponsesVisible:!1},attachments:{image:!0,audio:!0}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(22),s=i(144),r=i(26),a=i(17),c=i(0),l=i(10),d=i(14),h=i(20),u=i(2),p=i(5);e.Comms=class extends s.BaseComms{constructor(t,e,i,n,o){super(t,e,i,n),this.user=null,this._loggedIn=!1,this._postLoginTimeout=null,this._shouldClearData=!1,this._mamFetchInProgress=!1,this._mamQueryInProgress=!1,this._disconnectedDuringMamFetch=!1,this._onDisconnectDuringLogin=(t=>{t.detail===c.ConnectionStatus.Disconnected&&this._postLoginTimeout&&(this.clearPostLoginTimeout(),this._chatLayer.clearAllData(),document.removeEventListener("__cm-connection-change",this._onDisconnectDuringLogin))}),this._chatLayer=o,this._setupHandlers()}login(t,e,i=!0){const o=Object.create(null,{login:{get:()=>super.login}});return n(this,void 0,void 0,function*(){this._chatLayer.showWaitingMessage(this._chatLayer.translateI18nItem(h.CommonMetadata.getI18nItem(h.CommonI18nKeys.AUTHENTICATING))),this._chatLayer.enableSuppressMode("chat/comms#login",!0),document.removeEventListener("__cm-connection-change",this._onDisconnectDuringLogin),document.addEventListener("__cm-connection-change",this._onDisconnectDuringLogin);try{yield o.login.call(this,t,e,!1),yield this._postLogin()}catch(t){throw this._handleLoginFailure(),this.triggerLoginEvent(!1,t.msg),t}})}setPresence(){return n(this,void 0,void 0,function*(){try{yield this.client.sendPresence()}catch(t){throw this.logger.error(t),t}})}getAllMessages(){return n(this,void 0,void 0,function*(){return yield this.client.getAllMessages()})}getMucHost(){return this.client.mucHost}findChatEntriesToPurge(t){return n(this,void 0,void 0,function*(){let e=[];try{const i=(yield this.getAllMessages()).filter(e=>e.recipient_id===`${t.id}@${this.client.mucHost}`||e.sender_id===`${t.id}@${this.client.mucHost}`).sort((t,e)=>t.ts-e.ts);e=i.splice(0,i.length-this._chatLayer.config.behaviour.maxChatEntriesToStore)}catch(t){this.logger.error("Couldn't fetch chat entries to purge:",t)}return e})}isMamFetchInProgress(){return this._mamFetchInProgress}embelishUser(t){return n(this,void 0,void 0,function*(){return t.connectionStatus=t.connectionStatus||c.ConnectionStatus.Disconnected,t.displayName=u.formatUserName(t,u.NameFormat.PREFIX_FIRST_LAST),t})}_setupHandlers(){this.onStatusUpdate(t=>n(this,void 0,void 0,function*(){t===c.ConnectionStatus.Connected&&this._chatLayer.enableSuppressMode("chat/comms#login",!0),this.user&&(this.user.connectionStatus=t)})),this.onAutoReconnected(({resumed:t})=>n(this,void 0,void 0,function*(){const e=!0===this._loggedIn,i=!0===t;if(!1===e)try{yield this._chatLayer.bootstrapper,yield this._postLogin(i)}catch(t){this._handleLoginFailure(),this.triggerLoginEvent(!1,t)}else if(this._disconnectedDuringMamFetch||!i){this._disconnectedDuringMamFetch&&(yield this._chatLayer.clearAllData());const t=yield this._chatLayer.store.getLatestIdentifier();yield this._chatLayer.loadAllConversations(),yield this._processMissedPersonalMamMessage(t),this._chatLayer.cancelSuppressMode("chat/comms#login"),yield this._priorityAlert(),yield this.setPresence()}else this._chatLayer.cancelSuppressMode("chat/comms#login"),yield this._priorityAlert(),yield this.setPresence();this._chatLayer.emit(p.ChatEvents.AutoReconnected,{resumed:t})})),this.onDatabasesAutoDestroyed(()=>n(this,void 0,void 0,function*(){this._shouldClearData=!0}))}_priorityAlert(){return n(this,void 0,void 0,function*(){const t=this._chatLayer.getNewestPendingAlert();if(t)return yield this._chatLayer.priorityAlert(t)})}_postLogin(t=!1){return n(this,void 0,void 0,function*(){return this.username?(yield this._chatLayer.showWaitingMessage(this._chatLayer.translateI18nItem(h.CommonMetadata.getI18nItem(h.CommonI18nKeys.SYNCING))),new Promise((e,i)=>n(this,void 0,void 0,function*(){this.clearPostLoginTimeout();const n=this.xmppConfig.loginTimeout||1e4;if(this._postLoginTimeout=setTimeout(()=>{this.clearPostLoginTimeout(),this.logger.log(a.LoggerTypes.Connectivity,"%c LOGIN TIMED OUT","color: #600; font-weight: bold;"),i(new Error(this._chatLayer.translateI18nItem(h.CommonMetadata.getI18nItem(h.CommonI18nKeys.LOGIN_TIMEOUT))))},n),this._shouldClearData&&(this.logger.log(a.LoggerTypes.CleanUp,"%c DELETING DATA FOR FRESH USER","color: #669; font-weight: bold;"),yield this._chatLayer.store.clearChatData(),this._shouldClearData=!1),this.user=yield this._chatLayer.getUserByJid(this.username),!this.user){const t=this._chatLayer.translateI18nItem(h.CommonMetadata.getI18nItem(h.CommonI18nKeys.USER_NOT_FOUND)).replace("{{username}}",this.username);return i(new Error(t))}const o=yield this._chatLayer.store.getLatestIdentifier();yield this._chatLayer.showWaitingMessage(this._chatLayer.translateI18nItem(d.ChatCommonMetadata.getI18nItem(d.ChatCommonI18nKeys.FETCHING_CONVERSATIONS))),yield this._chatLayer.loadAllConversations(),t||(yield this._chatLayer.showWaitingMessage(this._chatLayer.translateI18nItem(d.ChatCommonMetadata.getI18nItem(d.ChatCommonI18nKeys.FETCHING_OWN_DATA))),yield this._processMissedPersonalMamMessage(o)),this.logger.log(a.LoggerTypes.Connectivity,`%c LOGIN COMPLETE > %c${this.username}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;"),yield this._chatLayer.dismissWaitingMessage(),this._chatLayer.cancelSuppressMode("chat/comms#login"),this.clearPostLoginTimeout(),this._loggedIn=!0,yield this.setPresence(),yield this._chatLayer.purgeAllConversations(),this.triggerLoginEvent(!0),yield this._priorityAlert(),this._chatLayer.emit(p.ChatEvents.PostLoginComplete),e()}))):Promise.reject(new Error("Error in post-login: no username specified"))})}_handleLoginFailure(){const t=Object.create(null,{logout:{get:()=>super.logout}});return n(this,void 0,void 0,function*(){this.user=null,this._loggedIn=!1,yield t.logout.call(this,!0,!0)})}fetchConversationMessages(t,e=null,i=null,o=null){return n(this,void 0,void 0,function*(){let n=(1e3*Date.now()).toString();return e&&(n=(yield this.client.getMessageById(e)).archive_id),yield this._fetchEarlierConversationMessages(t,n,i,o)})}clearStoredConversationMessages(t){return n(this,void 0,void 0,function*(){yield this.client.deleteMessagesByRoomName(t.id)})}clearStoredConversationAttachments(t){return n(this,void 0,void 0,function*(){return new Promise((e,i)=>n(this,void 0,void 0,function*(){const i=[];t.attachments.forEach(t=>{void 0!==t.local&&i.push(new Promise(e=>this.client.deleteFile(t.local).then(e).catch(i=>{this.logger.log(a.LoggerTypes.XmppClient,`Couldn't delete attachment at: '${t.local}':`,i),e()})))}),Promise.all(i).then(()=>{e()})}))})}clearPostLoginTimeout(){clearTimeout(this._postLoginTimeout),this._postLoginTimeout=null}_processMissedPersonalMamMessage(t=null){return n(this,void 0,void 0,function*(){if(!0!==this._mamFetchInProgress)try{this._mamQueryInProgress=!1,this._disconnectedDuringMamFetch=!1;const e=t&&t.toString()||null;if(null===e)return;this.logger.log(a.LoggerTypes.Mam,`%c QUERYING PERSONAL MAM FOR MISSED MESSAGE(S) FOR USER: %c${this.username} (since ${e})`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;");const i=Date.now(),n=yield this.client.queryMam(null,e,null,null,!1),s=Date.now();if(this._mamQueryInProgress=!1,this.logger.log(a.LoggerTypes.Mam,`%c QUERYING PERSONAL MAM TOOK ${s-i}ms`,"color: #669; font-weight: bold;"),this.logger.log(a.LoggerTypes.Mam,`%c FOUND ${n.length} MISSED MESSAGE(S) IN PERSONAL MAM`,"color: #669; font-weight: bold;"),n.length>0){const t=[],e=[];n.forEach(e=>{e&&u.jidsMatch(e.recipient_id,this.username)&&u.getMessageType(e)?(this.logger.shouldLog(a.LoggerTypes.Mam)&&this.logger.log(a.LoggerTypes.Mam,"%c DISPATCHING PERSONAL MAM MESSAGE:%c","color: #669; font-weight: bold;","color: #999; font-weight: normal;",u.getMessageContentForDebug(e)),this.client._dispatchEvent(o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE,e)):t.push(e)}),this.logger.log(a.LoggerTypes.Mam,`%c ${n.length-e.length-t.length} PERSONAL MAM MESSAGE(S) DISPATCHED`,"color: #669; font-weight: bold;"),e.length>0&&this.logger.log(a.LoggerTypes.Mam,`%c ${e.length} PERSONAL MAM MESSAGE(S) IGNORED DUE TO STANZA EXCLUSION RULES`,"color: #669; font-weight: bold;",e),t.length>0&&this.logger.log(a.LoggerTypes.Mam,`%c ${t.length} INVALID PERSONAL MAM MESSAGE(S) IGNORED`,"color: #C00; font-weight: bold;",t),this._mamFetchInProgress=!1}else this._mamFetchInProgress=!1}catch(t){const e=o.CtXmppClient.xmlToJson(t),i=e&&e.iq&&e.iq.error&&e.iq.error.text&&e.iq.error.text.$value||"";throw this.logger.log(a.LoggerTypes.Mam,"%c ERROR DURING PERSONAL MAM FETCH","color: #C00; font-weight: bold;",Object.assign({},e)),new r.IQError(i,e.iq)}else this.logger.log(a.LoggerTypes.Mam,"%c MAM FETCHING ALREADY IN PROGRESS: SKIPPING MAM CHECK","color: #669; font-weight: bold;")})}_fetchEarlierConversationMessages(t,e,i,s=null){return n(this,void 0,void 0,function*(){if(!0!==this._mamFetchInProgress)try{const c=t.roomJid.split("@").shift();this._mamQueryInProgress=!1,this._disconnectedDuringMamFetch=!1,this.logger.log(a.LoggerTypes.Mam,`%c QUERYING ROOM MAM FOR MESSAGES FOR CONVERSATION: %c${c} (before ${e})`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;");const d=Date.now(),h=yield this.client.queryMamRoomHistoryByName(c,e,i,!1,s),p=Date.now();this._mamQueryInProgress=!1,this.logger.log(a.LoggerTypes.Mam,`%c QUERYING ROOM MAM TOOK ${p-d}ms`,"color: #669; font-weight: bold;"),this.logger.log(a.LoggerTypes.Mam,`%c FOUND ${h.length} MESSAGE(S) IN THE ROOM MAM`,"color: #669; font-weight: bold;",h);const g=[];if(h.length>0){const t=[],e=[];h.forEach(e=>{e&&u.getMessageType(e)?(this.logger.shouldLog(a.LoggerTypes.Mam)&&this.logger.log(a.LoggerTypes.Mam,"%c DISPATCHING ROOM MAM MESSAGE:%c","color: #669; font-weight: bold;","color: #999; font-weight: normal;",u.getMessageContentForDebug(e)),this.client._dispatchEvent(o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE,e),g.push(e)):t.push(e)});const i=yield Promise.all(g.map(t=>n(this,void 0,void 0,function*(){return yield l.convertToChatEntry(t,this._chatLayer)})));return this.logger.log(a.LoggerTypes.Mam,`%c ${h.length-e.length-t.length} ROOM MAM MESSAGE(S) DISPATCHED`,"color: #669; font-weight: bold;"),e.length>0&&this.logger.log(a.LoggerTypes.Mam,`%c ${e.length} ROOM MAM MESSAGE(S) IGNORED DUE TO STANZA EXCLUSION RULES`,"color: #669; font-weight: bold;",e),t.length>0&&this.logger.log(a.LoggerTypes.Mam,`%c ${t.length} INVALID ROOM MAM MESSAGE(S) IGNORED`,"color: #C00; font-weight: bold;",t),this._mamFetchInProgress=!1,i}return this._mamFetchInProgress=!1,[]}catch(t){const e=o.CtXmppClient.xmlToJson(t),i=e&&e.iq&&e.iq.error&&e.iq.error.text&&e.iq.error.text.$value||"";if(this.logger.log(a.LoggerTypes.Mam,"%c ERROR DURING ROOM MAM FETCH","color: #C00; font-weight: bold;",Object.assign({},e)),!i.includes("Only members may query archives of this room"))throw new r.IQError(i,e.iq);return}else this.logger.log(a.LoggerTypes.Mam,"%c MAM FETCHING ALREADY IN PROGRESS: SKIPPING MAM CHECK","color: #669; font-weight: bold;")})}}},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});
/*! Copyright (c) 2018 CommonTime Ltd */
const o=i(22),s=i(68),r=i(26),a=i(11),c=i(17),l=i(0),d=i(2);e.BaseComms=class{constructor(t,e,i,n){this._firstConnectionInitialized=!1,this._loggingIn=!1,this._loginTimeout=null,this._clientName=t;const s={debug:n.getTypesAsEnumValues().includes(c.LoggerTypes.XmppClient),mucHost:e.mucHost,mam:{auto:e.mam&&!0===e.mam.autoFetch||!1,defaultTimeLimit:e.maxMessageAge||0,pageSize:500},autoLogin:void 0===e.autoLogin||e.autoLogin,autoReconnect:void 0===e.autoReconnect||e.autoReconnect,enablePing:!1!==e.enablePing,pingInterval:e.pingInterval||5e3,pingTimeout:e.pingTimeout||1e4,multicastHost:e.multicastHost,uploadHost:e.uploadHost,autoMarkMessages:e.useChatMarkers,autoPurgeOldMessagesAge:e.maxMessageAge||0,encryption:e.encryption||!1,fileEncryption:e.fileEncryption||!1,authAttachments:!0===e.authAttachments,streamResumption:!1!==e.streamResumption,useEncodedJidAsResource:e.user&&!0===e.user.userPersistentResource||!1,adSpn:e.adSpn||null,adSecurityPackage:e.adSecurityPackage||null,push:e.push||{androidEnabled:!1,iosEnabled:!0},updateUserDirectoryOnLogin:e.updateUserDirectoryOnLogin||null,enableMessageCarbons:e.enableMessageCarbons||!1,bringToForegroundOnVoipPush:void 0!==e.bringToForegroundOnVoipPush?e.bringToForegroundOnVoipPush:null,updateUserDirectoryInterval:e.updateUserDirectoryInterval||18e5,alwaysSendPresence:e.alwaysSendPresence,sleepingBeauty:e.sleepingBeauty};e.push&&(s.push=e.push),e.adTokenPlaceholder&&(s.adTokenPlaceholder=e.adTokenPlaceholder),this.client=new o.CtXmppClient(this._clientName,e.endpoint,s),this.store=i,this.logger=n,this.xmppConfig=e,this._localEventHandlers={},this._setupCommonHandlers()}onInitialized(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.INITIALISED,()=>{t()})}onLogin(t){void 0===this._localEventHandlers["comms-login"]&&(this._localEventHandlers["comms-login"]=[]),this._localEventHandlers["comms-login"].push(t)}onLogout(t){void 0===this._localEventHandlers["comms-logout"]&&(this._localEventHandlers["comms-logout"]=[]),this._localEventHandlers["comms-logout"].push(t)}onNewMessage(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE,e=>{t(Object.assign({},e))})}onMessageUpdate(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.MESSAGE_UPDATED,e=>{t(Object.assign({},e))})}onChatMarkerUpdate(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.RECEIPT_RECEIVED,e=>{t(Object.assign({},e))})}onStatusUpdate(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.STATUS,e=>{this.resetServerVersion();let i=l.ConnectionStatus.Disconnected,n=null;switch(e.id){case s.default.Strophe.Status.CONNFAIL:i=l.ConnectionStatus.Disconnected,n=new l.DisconnectionStatus(e.wontReconnect,e.reason);break;case s.default.Strophe.Status.AUTHFAIL:i=l.ConnectionStatus.Disconnected,n=new l.DisconnectionStatus(!1,e.reason);break;case s.default.Strophe.Status.ERROR:i=l.ConnectionStatus.Disconnected,n=new l.DisconnectionStatus(e.wontReconnect,e.reason);break;case s.default.Strophe.Status.CONNECTING:case s.default.Strophe.Status.AUTHENTICATING:i=l.ConnectionStatus.Connecting;break;case s.default.Strophe.Status.CONNECTED:i=l.ConnectionStatus.Connected;break;case s.default.Strophe.Status.DISCONNECTING:i=l.ConnectionStatus.Disconnecting;break;case s.default.Strophe.Status.DISCONNECTED:i=l.ConnectionStatus.Disconnected,n=new l.DisconnectionStatus(e.wontReconnect,e.reason),document.dispatchEvent(new CustomEvent("__cm-connection-change",{detail:i}));break;default:l.ConnectionStatus.Disconnected}t(i,e.reconnectTime,n)})}onPresenceUpdate(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.PRESENCE_UPDATE,e=>{t(e)})}onRoomNewParticipant(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.NEW_PARTICIPANT,e=>{t(Object.assign({},e))})}onRoomParticipantUpdate(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.PARTICIPANT_UPDATED,e=>{t(Object.assign({},e))})}onError(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.ERROR,e=>{t(e)})}onStartFetchingMissedMessages(t){const e="missed-messages-start";void 0===this._localEventHandlers[e]&&(this._localEventHandlers[e]=[]),this._localEventHandlers[e].push(t)}onFinishedFetchingMissedMessages(t){const e="missed-messages-finished";void 0===this._localEventHandlers[e]&&(this._localEventHandlers[e]=[]),this._localEventHandlers[e].push(t)}onAutoReconnected(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.AUTO_RECONNECTED,e=>{this.getServerVersion(),t(e)})}onDatabasesAutoDestroyed(t){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.AUTO_DBS_DESTROYED,()=>{t()})}getSyncedTimestamp(t){const e=null==t?(new Date).getTime():t;return this.client.getSyncedTimestamp(e)}getCurrentUserResource(){return this.client.resource}getConnectionStatus(){return this.status}setConnectionStatus(t){this.status=t}login(t,e,i=!0){return n(this,void 0,void 0,function*(){return!0===this._loggingIn?Promise.reject(new Error("Login currently in progress, please wait.")):new Promise((o,s)=>n(this,void 0,void 0,function*(){try{let r=e;!0===this.xmppConfig.user.sendAppIdentifier&&(r=`app_id~${this.xmppConfig.user.appIdentifier}~${e}`),this._loggingIn=!0,clearTimeout(this._loginTimeout);const a=this.xmppConfig.loginTimeout||1e4;this._loginTimeout=setTimeout(()=>n(this,void 0,void 0,function*(){clearTimeout(this._loginTimeout),yield this.logout(!0,!0),this.logger.log(c.LoggerTypes.Connectivity,"%c LOGIN TIMED OUT","color: #600; font-weight: bold;"),s(new Error(`Logging in took longer than ${Math.floor(a/1e3)} seconds. Please check your connectivity and try again.`))}),a),this.xmppConfig.user&&!0===this.xmppConfig.user.forceLowercaseJid&&(t=t.toLowerCase()),this.logger.log(c.LoggerTypes.Connectivity,`%c ATTEMPTING LOGIN > %c${t}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;"),this.username=t,yield this.client.login(t,r),this.checkTimeSync(!1),i&&this.triggerLoginEvent(!0),clearTimeout(this._loginTimeout),this._loggingIn=!1,o()}catch(e){clearTimeout(this._loginTimeout),this._loggingIn=!1,this.logger.log(c.LoggerTypes.Connectivity,`%c LOGIN FAILED > %c${t}`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;"),this.username="",i&&this.triggerLoginEvent(!1,e.msg),s(e)}}))})}logout(t=!1,e=!0){return n(this,void 0,void 0,function*(){try{this.logger.log(c.LoggerTypes.Connectivity,`%c LOGGING OUT > %c${this.username}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;"),this._loggingIn=!1,this._firstConnectionInitialized=!1,yield this.client.logout(t),this.username="",e&&this.triggerLogoutEvent(!0)}catch(t){this.logger.log(c.LoggerTypes.Connectivity,`%c LOGOUT FAILED > %c${this.username}`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;"),e&&this.triggerLogoutEvent(!1)}})}attemptReconnect(){this.client.reLoginNow()}joinRoom(t){return n(this,void 0,void 0,function*(){yield this._joinOrLeaveRoom(t)})}leaveRoom(t){return n(this,void 0,void 0,function*(){yield this._joinOrLeaveRoom(t,!0)})}setClientStateActive(t){return n(this,void 0,void 0,function*(){const e=t?o.CtXmppClient.CLIENT_STATES.ACTIVE:o.CtXmppClient.CLIENT_STATES.INACTIVE;this.client.setClientState(e)})}getUniqueId(){return this.client.getUniqueId()}sendMessage(t,e,i=[]){return n(this,void 0,void 0,function*(){if(!t)throw new Error("No recipient specified");if(this.status!==l.ConnectionStatus.Connected)throw new Error("Unable to send message: not currently connected");const n=yield this.client.sendChatMessage(t,null,e,i);return this.logger.shouldLog(c.LoggerTypes.MessageSent)&&this.logger.log(c.LoggerTypes.MessageSent,`%c MESSAGE SENT: %c${t} >`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;",d.getMessageContentForDebug(n)),n})}sendRoomMessage(t,e=null,i=null,o=[],s=!0){return n(this,void 0,void 0,function*(){if(!t)throw new Error("No room name specified");if(this.status!==l.ConnectionStatus.Connected)throw new Error("Unable to send room message: not currently connected");const n=yield this.client.sendGroupChatMessage(t,e,i,o,s);return this.logger.shouldLog(c.LoggerTypes.MessageSent)&&this.logger.log(c.LoggerTypes.MessageSent,`%c ROOM MESSAGE SENT: %c${t} >`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;",d.getMessageContentForDebug(n)),n})}sendMulticastMessage(t,e,i=[]){return n(this,void 0,void 0,function*(){if(this.status!==l.ConnectionStatus.Connected)throw new Error("Unable to multicast message: not currently connected");const n=yield this.client.sendMulticastMessage(t,null,e,i);if(this.logger.shouldLog(c.LoggerTypes.MessageSent)){const e=JSON.stringify(t);this.logger.log(c.LoggerTypes.MessageSent,`%c MUTILCAST MESSAGE SENT: %c${e} >`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;",d.getMessageContentForDebug(n))}return n})}sendIq(t,e,i){return n(this,void 0,void 0,function*(){if(!t)throw new Error("No recipient specified");if(!e)throw new Error("No type specified");if(this.status!==l.ConnectionStatus.Connected)throw new Error("Unable to send IQ: not currently connected");const n=Object.keys(i)[0];this.logger.shouldLog(c.LoggerTypes.MessageSent)&&this.logger.log(c.LoggerTypes.MessageSent,`%c IQ SENT: %c${n} >`,"color: #906; font-weight: bold;","color: #999; font-weight: normal;",{iq:i});try{const s=yield this.client.sendIq(t,e,i);return this.logger.shouldLog(c.LoggerTypes.MessageSent)&&this.logger.log(c.LoggerTypes.MessageSent,`%c IQ RESPONSE: %c${n} >`,"color: #906; font-weight: bold;","color: #999; font-weight: normal;",Object.assign({},s)),s.iq}catch(t){const e=o.CtXmppClient.xmlToJson(t),i=e&&e.iq&&e.iq.error&&e.iq.error.text&&e.iq.error.text.$value||"";throw this.logger.log(c.LoggerTypes.MessageSent,`%c IQ ERROR: %c${n} > ${i}`,"color: #C00; font-weight: bold;","color: #999; font-weight: normal;",Object.assign({},e)),new r.IQError(i,e.iq)}})}sendBotCommand(t,e){return n(this,void 0,void 0,function*(){if(this.status!==l.ConnectionStatus.Connected)throw new Error(`Unable to send bot command "${t}": not currently connected`);if(!this.xmppConfig.bot)throw new Error("No bot configured in XmppConfig");const i=this.xmppConfig.bot.componentJid;if(!i)throw new Error("Unable to issue bot command; no bot component jid configured");if(null!=e){const i=Object.assign({},e);t in i&&(i[t]=JSON.parse(i[t])),this.logger.log(c.LoggerTypes.MessageSent,`%c BOT COMMAND SENT: %c${t} >`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;",{data:i})}else this.logger.log(c.LoggerTypes.MessageSent,`%c BOT COMMAND SENT: %c${t}`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;");try{const n=yield this.client.sendBotCommand(i,t,e,this.xmppConfig.bot.timeout);return this.logger.log(c.LoggerTypes.MessageSent,`%c BOT RESPONSE: %c${t} > ${n.success?"success":"fail"}`,"color: #600; font-weight: bold;","color: #999; font-weight: normal;",{data:n.data||null}),n}catch(t){const e="Server connections to local subdomains are forbidden"===t?`Unable to connect to bot: ${i}`:t.message||t;throw new Error(e)}})}deleteMessageById(t,e=!0){return n(this,void 0,void 0,function*(){yield this.client.deleteMessageById(t,e)})}deleteMessageByRoomName(t){return n(this,void 0,void 0,function*(){yield this.client.deleteMessagesByRoomName(t)})}updateStatus(t,e,i=!1,o){return n(this,void 0,void 0,function*(){const n=yield this.client.setChatStatus(t,e,i,o);if(this.logger.shouldLog(c.LoggerTypes.Status)){const t=JSON.stringify(n);this.logger.log(c.LoggerTypes.Status,`%c STATUS UPDATED: %c${t}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;")}return n})}listParticipantsByRoom(t){return n(this,void 0,void 0,function*(){const e=yield this.client.listParticipantsByRoom(t);return Promise.all(e.map(t=>n(this,void 0,void 0,function*(){return yield this._participantToUser(t)})))})}getParticipantByRoomAndJid(t,e){return n(this,void 0,void 0,function*(){const i=yield this.client.getParticipantByRoomAndJid(t,e);return i?yield this._participantToUser(i):null})}getAllContacts(){return n(this,void 0,void 0,function*(){const t=yield this.client.getContacts();return Promise.all(t.map(t=>n(this,void 0,void 0,function*(){return yield this._xmppContactToUser(t)})).filter(t=>null!==t))})}getUserByJid(t){return n(this,void 0,void 0,function*(){const e=yield this.client.getUserByJid(t);return e?yield this._directoryUserToUser(e):null})}updateUserDirectory(){return n(this,void 0,void 0,function*(){yield this.client.updateUserDirectory()})}searchUsers(t="",e=[]){return n(this,void 0,void 0,function*(){const i=null!=t&&t.length>0?yield this.client.searchUsers(t,e):yield this.client.getAllUsers(),n=[];for(const t of i)null!==t&&n.push(yield this._directoryUserToUser(t));return n})}markMessageRead(t){return n(this,void 0,void 0,function*(){if(!this.xmppConfig.useChatMarkers)return;const e=yield this.client.getMessageById(t);e&&!e.mine&&e.markable&&(e.state.markers.some(t=>"read"===t.type&&t.sender_resource&&t.sender_resource.toLowerCase()===this.username.split("@")[0].toLowerCase()||t.sender_id.toLowerCase()===this.username.toLowerCase())||(yield this.client.markMessageRead(e)))})}getChatHistory(t){return n(this,void 0,void 0,function*(){return yield this.client.getChatHistory(t)})}queryMam(t,e,i,o,s=!0){return n(this,void 0,void 0,function*(){return yield this.client.queryMam(t,e,i,o,s)})}processXmlStanzaStringsFromMam(t,e=!0){return n(this,void 0,void 0,function*(){return yield this.client.processXmlStanzaStringsFromMam(t,e)})}clearAllData(t=!1){return n(this,void 0,void 0,function*(){yield this.client.destroyDbs(!1,t)})}createPushNotificationRegistration(t){return n(this,void 0,void 0,function*(){const e=this._generatePushNotificationPayload(t.platform,t.channelUri,t.azureId);return yield this.client.sendIq("push.localhost","set",e)})}checkTimeSync(t=!0){const e=(new Date).getTime(),i=this.getSyncedTimestamp(e),n=Math.abs(i-e),o=n<1e4,s=o?"#666":"#F00",r=o?"#999":"#F00",a=t?console.log:o?()=>{}:console.log;if(a.call(console.log,`%c CLIENT TIME: %c${new Date(e).toTimeString()}`,"color: #666; font-weight: bold;","color: #999; font-weight: normal;"),a.call(console.log,`%c SERVER TIME: %c${new Date(i).toTimeString()}`,"color: #666; font-weight: bold;","color: #999; font-weight: normal;"),n){const t=Math.floor(n/36e5%24),o=Math.floor(n/6e4%60),c=Math.floor(n/1e3%60),l=Math.floor(n%1e3);let d="";t>0&&(d+=`${t}h `),o>0&&(d+=`${o}m `),c>0&&(d+=`${c}s `),l>0&&(d+=`${l}ms `),e>i?a.call(console.log,`%c TIME SYNC: %cClient is %c${d.trim()} ahead %cof server`,`color: ${s}; font-weight: bold;`,`color: ${r}; font-weight: normal;`,`color: ${r}; font-weight: bold;`,`color: ${r}; font-weight: normal;`):a.call(console.log,`%c TIME SYNC: %cClient is %c${d.trim()} behind %cserver`,`color: ${s}; font-weight: bold;`,`color: ${r}; font-weight: normal;`,`color: ${r}; font-weight: bold;`,`color: ${r}; font-weight: normal;`)}else a.call(console.log,"%c TIME SYNC: %cClient and server times are identical","color: #666; font-weight: bold;","color: #999; font-weight: normal;")}updateVCardForUser(t){return n(this,void 0,void 0,function*(){if(this.username&&this.username===t)return null;yield this.client.updatevCardForContact(t)})}getOurVCard(){return n(this,void 0,void 0,function*(){try{return yield this.client.getOurvCard()}catch(t){return null}})}downloadMessageAttachments(t){return n(this,void 0,void 0,function*(){const e=yield this.client.getMessageById(t);e&&(yield this.client.downloadAttachments(e,!0))})}downloadFile(t,e=!1){return n(this,void 0,void 0,function*(){return(yield this.client.doDownload(t)).source||null})}getServerVersion(){return n(this,void 0,void 0,function*(){this.serverVersion=yield this.client.getServerVersion()})}resetServerVersion(){return n(this,void 0,void 0,function*(){this.serverVersion=null})}uploadFile(t){return n(this,void 0,void 0,function*(){try{return yield this.client.uploadAttachment(t)}catch(e){throw this.logger.log(c.LoggerTypes.MessageSent,`%c UPLOAD ERROR: %c$Unable to upload file > ${e}`,"color: #C00; font-weight: bold;","color: #999; font-weight: normal;",t),new Error("Unable to upload attachment")}})}initializeFirstConnection(){return n(this,void 0,void 0,function*(){})}buildCurrentUser(t){return n(this,void 0,void 0,function*(){const e=t.split("@").shift(),i={id:t,jid:t,username:e,firstName:"",lastName:"",connectionStatus:this.getConnectionStatus()},n=yield this.getOurVCard();return yield this.embelishUser(i,n,l.UserAdditionalDetailsType.VCard)})}triggerLoginEvent(t,e){this._fireLocalEventHandlers("comms-login",new a.CommsEventArgs(t,e))}triggerLogoutEvent(t,e){this._fireLocalEventHandlers("comms-logout",new a.CommsEventArgs(t,e))}triggerFetchingMissedMessagesState(t){t?this._fireLocalEventHandlers("missed-messages-start"):this._fireLocalEventHandlers("missed-messages-finished")}_setupCommonHandlers(){this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.NEW_MESSAGE,t=>n(this,void 0,void 0,function*(){this.logger.shouldLog(c.LoggerTypes.MessageReceived)&&this.logger.log(c.LoggerTypes.MessageReceived,"%c MESSAGE RECEIVED:%c","color: #060; font-weight: bold;","color: #999; font-weight: normal;",d.getMessageContentForDebug(t))})),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.MESSAGE_UPDATED,t=>{this.logger.shouldLog(c.LoggerTypes.MessageUpdated)&&this.logger.log(c.LoggerTypes.MessageUpdated,"%c MESSAGE UPDATED:%c","color: #060; font-weight: bold;","color: #999; font-weight: normal;",d.getMessageContentForDebug(t))}),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.RECEIPT_RECEIVED,t=>{if(this.logger.shouldLog(c.LoggerTypes.MessageChatMarker)){const e=t.sender_resource.split("@").shift();this.logger.log(c.LoggerTypes.MessageChatMarker,`%c CHAT MARKER RECEIVED: %c${e} > ${t.type}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;")}}),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.STATUS,t=>n(this,void 0,void 0,function*(){const e=l.ConnectionStatus[t.label];if(this.setConnectionStatus(e),e===l.ConnectionStatus.Connected&&(this.username=this.client.bareJid,!1===this._firstConnectionInitialized&&(yield this.initializeFirstConnection(),this._firstConnectionInitialized=!0)),this.logger.shouldLog(c.LoggerTypes.Connectivity)){const i=t.reconnectTime?` - reconnect attempt in ${t.reconnectTime/1e3} second(s)`:"";this.logger.log(c.LoggerTypes.Connectivity,`%c CONNECTIVITY CHANGE: %c${e}${i}`,"color: #669; font-weight: bold;","color: #999; font-weight: normal;")}})),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.NEW_PARTICIPANT,t=>n(this,void 0,void 0,function*(){if(t.jid&&this.logger.shouldLog(c.LoggerTypes.Participation)){const e=yield this._participantToUser(t);this.logger.log(c.LoggerTypes.Participation,`%c NEW PARTICIPANT: %c${e.username} > ${e.connectionStatus}`,"color: #006; font-weight: bold;","color: #999; font-weight: normal;",{participant:t})}})),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.PARTICIPANT_UPDATED,t=>n(this,void 0,void 0,function*(){if(t.jid&&this.logger.shouldLog(c.LoggerTypes.Participation)){const e=yield this._participantToUser(t);this.logger.log(c.LoggerTypes.Participation,`%c PARTICIPANT UPDATED: %c${e.username} > ${e.connectionStatus}`,"color: #006; font-weight: bold;","color: #999; font-weight: normal;",{participant:t})}})),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.PRESENCE_UPDATE,t=>n(this,void 0,void 0,function*(){if(t.id&&this.logger.shouldLog(c.LoggerTypes.Presence)){const e=yield this._xmppContactToUser(t);e?this.logger.log(c.LoggerTypes.Presence,`%c PRESENCE UPDATED: %c${e.username} > ${e.connectionStatus}`,"color: #006; font-weight: bold;","color: #999; font-weight: normal;"):this.logger.error(c.LoggerTypes.Presence,"%c PRESENCE UPDATED FOR UNKNOWN CONTACT:","color: #006; font-weight: bold;",{contact:t})}})),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.ERROR,t=>{this.logger.error("%c ERROR:","color: #C00; font-weight: bold;","\r\n\t",t)}),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.AUTO_RECONNECTED,({resumed:t})=>n(this,void 0,void 0,function*(){if(this.logger.shouldLog(c.LoggerTypes.Connectivity)){const e=!0===t?" - STREAM RESUMED":"";this.logger.log(c.LoggerTypes.Connectivity,`%c AUTO RECONNECTED AFTER DISCONNECT${e}`,"color: #669; font-weight: bold;")}})),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.DBS_DESTROYED,()=>{this.logger.shouldLog(c.LoggerTypes.CleanUp)&&this.logger.log(c.LoggerTypes.CleanUp,"%c DATABASES DESTROYED","color: #669; font-weight: bold;")}),this.client.addEventListener(o.CtXmppClient.EVENT_TYPES.AUTO_DBS_DESTROYED,()=>{this.logger.shouldLog(c.LoggerTypes.CleanUp)&&this.logger.log(c.LoggerTypes.CleanUp,"%c DATABASES AUTO DESTROYED","color: #669; font-weight: bold;")})}_joinOrLeaveRoom(t,e=!1){return n(this,void 0,void 0,function*(){"participant"===t.type&&((yield e)?this.client.leaveRoom(t.name):this.client.joinRoom(t.name)),"subscriber"===t.type&&((yield e)?this.client.unsubscribeFromRoom(t.name):this.client.subscribeToRoom(t.name,t.nodes))})}_participantToUser(t){return n(this,void 0,void 0,function*(){const e={id:t._id,jid:t.jid,username:t.username,firstName:"",lastName:"",connectionStatus:t.online?l.ConnectionStatus.Connected:l.ConnectionStatus.Disconnected};return this.embelishUser(e,t,l.UserAdditionalDetailsType.Participant)})}_xmppContactToUser(t){return n(this,void 0,void 0,function*(){if(!t||!t.id)return null;const e={id:t.id,jid:t.id,username:t.id.substring(0,t.id.indexOf("@")),firstName:"",lastName:"",connectionStatus:t.online?l.ConnectionStatus.Connected:l.ConnectionStatus.Disconnected,groups:t.groups,subscription:t.subscription};return this.embelishUser(e,t,l.UserAdditionalDetailsType.Contact)})}_directoryUserToUser(t){return n(this,void 0,void 0,function*(){if(!t||!t.jid)return null;const e=t.jid,i={id:e,jid:e,username:e.substring(0,e.indexOf("@")),connectionStatus:l.ConnectionStatus.Disconnected,prefix:t.prefix,firstName:t.firstName,lastName:t.lastName,displayName:null,telephone:t.telephone,jobTitle:t.jobTitle,avatar:t.avatar,group:t.group};return this.embelishUser(i,t,l.UserAdditionalDetailsType.DirectoryUser)})}_fireLocalEventHandlers(t,e){void 0!==this._localEventHandlers[t]&&this._localEventHandlers[t].forEach(t=>t(e))}_generatePushNotificationPayload(t,e,i){return{push:{$attributes:{xmlns:"urn:commontime:infinity:push"},notification:{type:"android"===t?"gcm":"apns",installation_id:i,registration_id:e}}}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.AcknowledgeConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.AcknowledgeConversation}createIq(t){return c.createIq("ack",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id,value:t.value})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_ACKNOWLEDGING_CONVERSATION)),i=e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(33);class o extends n.BaseMessageType{}o.FetchConversations="fetch-conversations",o.CreateConversation="create-conversation",o.UpdateConversation="update-conversation",o.AddParticipants="add-participants",o.RemoveParticipants="remove-participants",o.ChangeParticipantRole="change-participant-role",o.LeaveConversation="leave-conversation",o.EndConversation="end-conversation",o.ReceivedConversation="received-conversation",o.AcknowledgeConversation="acknowledge-conversation",o.HideDirectConversation="hide-before",o.ConversationStarted="conversationstarted",o.ConversationUpdated="conversationupdated",o.ParticipantAdded="participantadded",o.ParticipantRemoved="participantremoved",o.ParticipantRoleChanged="participantrolechanged",o.ParticipantLeft="participantleft",o.ConversationEnded="conversationended",o.ParticipantReceived="participantreceipt",o.ParticipantAcknowledged="participantacked",o.User_ConversationStarted="user_conversationstarted",o.User_ConversationUpdated="user_conversationupdated",o.User_Added="user_added",o.User_Removed="user_removed",o.User_RoleChanged="user_rolechanged",o.User_Left="user_left",o.User_ConversationEnded="user_conversationended",o.User_DeleteDirectConversation="user_hid_conv",e.ChatMessageType=o},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(11),s=i(7),r=i(20);e.CommsConnectionHandler=class extends s.BaseChatHandler{constructor(){super(...arguments),this.eventType=[o.BaseEvents.LoginResult,o.BaseEvents._Request_Logout]}handleEvent(t,e){return n(this,void 0,void 0,function*(){if(t===o.BaseEvents.LoginResult){const t=e;if(!t.success){const e=this.layer.translateI18nItem(r.CommonMetadata.getI18nItem(r.CommonI18nKeys.LOGIN_ERROR_TITLE)),i=t.errorMessage||this.layer.translateI18nItem(r.CommonMetadata.getI18nItem(r.CommonI18nKeys.LOGIN_ERROR_GENERIC));this.layer.error(e,i)}}if(t===o.BaseEvents._Request_Logout)try{yield this.layer.logout(!0)}catch(t){const e=this.layer.translateI18nItem(r.CommonMetadata.getI18nItem(r.CommonI18nKeys.LOGOUT_ERROR_TITLE));this.layer.error(e,t)}})}}},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(18),a=i(14),c=i(16);e.DeleteDirectConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.HideDirectConversation}createIq(t){return c.createIq("hide_before",this.layer.config.xmpp.iq.namespace,{roomid:t.conversation.id,timestamp:t.timestamp.toString()})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){const t=this.layer.translateI18nItem(a.ChatCommonMetadata.getI18nItem(a.ChatCommonI18nKeys.ERROR_DELETING_DIRECT_CONVERSATION)),i=e.message.includes("connected")?"E_NO_CONNECTION_DELETING_DIRECT":e.message,n=r.getErrorMessage(i,this.layer);return this.layer.error(t,n),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(22),s=i(7),r=i(8),a=i(5),c=i(10),l=i(2);e.ChatMessageHandler=class extends s.BaseChatHandler{constructor(){super(...arguments),this.messageKey=r.ChatMessageType.XmppChat,this.DEBOUNCE_PURGE_NAME="purge",this.DEBOUNCE_DURATION=2e3,this._debouncers={}}handleMessage(t){return n(this,void 0,void 0,function*(){if(this.isMamMessage(t)||this.isInjectedMessage(t))return;const e=yield this.convert(t),i=yield this.layer.getConversationByRoomJid(e.to);if(!i||i.isClosed)return null;if(e.date<=(i.hideBefore||i.lastHideBefore))return null;e.date,i.hideBefore||i.lastHideBefore,yield this.layer.updateConversation(i,{preview:e}),this.debounce(this.DEBOUNCE_PURGE_NAME,()=>this.layer.purgeConversation(i),this.DEBOUNCE_DURATION),this.layer.emit(a.ChatEvents.ChatEntryReceived,new a.ChatEntryEventArgs(e))})}debounce(t,e,i=100){clearTimeout(this._debouncers[t]),this._debouncers[t]=setTimeout(()=>{e(),delete this._debouncers[t]},i)}handleMessageUpdate(t){return n(this,void 0,void 0,function*(){const e=yield this.convert(t),i=yield this.layer.getConversationByRoomJid(e.to);return!i||i.isClosed?null:e.date<=(i.hideBefore||i.lastHideBefore)?null:void this.layer.emit(a.ChatEvents.ChatEntryUpdated,new a.ChatEntryEventArgs(e))})}convert(t){return n(this,void 0,void 0,function*(){const e=t._id,i=t.ts,n=this.layer.getCurrentUserJid(),s=this.isInjectedMessage(t)?t.sender_id:t.mine?n:`${t.sender_resource}@${this.layer.config.xmpp.user.domain}`,r=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost),a="string"==typeof t.body?t.body:"",d=t.attachments instanceof Array?t.attachments.map(t=>({remote:t.get,local:t.path})):[],h=[],u=[];return(t.state&&t.state.markers||[]).forEach(t=>{const e={jid:`${t.sender_resource}@${this.layer.config.xmpp.user.domain}`,date:t.ts};t.type===o.CtXmppClient.MARKER_TYPES.RECEIVED&&h.push(e),t.type===o.CtXmppClient.MARKER_TYPES.READ&&u.push(e)}),c.createChatMessage(e,i,n,s,r,a,d,h,u,t.placeholder)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2),d=i(15);e.ConversationStartedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ConversationStarted}handleMessage(t){return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const e=t.data[this.messageKey];let i=yield this.layer.getConversationById(e.id);if(null!==i)return;const n=l.enumFromString(e.type);i=c.createConversation(e.id,n,e.roomJid,e.participants,e.title,e.description,e.date,e.priority,e.expiry_ttl,e.activity_ttl,[],[],e.instigator,void 0,e.reply_template,e.attachments);const o=new d.ConversationConfigReader(this.layer,i),s=yield this.convert(t,e);yield this.layer.addConversation(i,s);let a=!0;o.alert&&(a=yield this.layer.priorityAlert(i)),a&&this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(s))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return c.createMetaEntry(i,e.date,n,a.ChatMetaActivityType.START,e.instigator)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2);e.ConversationUpdatedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ConversationUpdated}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);n.subject=i.title,n.description=i.description;const o=yield this.convert(t,i);yield this.layer.updateConversation(n,{preview:o}),this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(o))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return c.createMetaEntry(i,e.date,n,a.ChatMetaActivityType.UPDATE,e.instigator,null,e.title)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2);e.ParticipantAddedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ParticipantAdded}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);const o=[...n.participants,i.participant];n.participants=l.uniqueArrayItems(o,t=>t.jid);const s=yield this.convert(t,i);yield this.layer.updateConversation(n,{preview:s,isParticipantChange:!0}),this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(s))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return c.createMetaEntry(i,e.date,n,a.ChatMetaActivityType.ADD,e.instigator,e.participant.jid)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2);e.ParticipantRemovedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ParticipantRemoved}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);n.participants=n.participants.filter(t=>!l.jidsMatch(t.jid,i.participant.jid));const o=yield this.convert(t,i);yield this.layer.updateConversation(n,{preview:o,isParticipantChange:!0}),this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(o))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return c.createMetaEntry(i,e.date,n,a.ChatMetaActivityType.REMOVE,e.instigator,e.participant.jid)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2);e.ParticipantRoleChangedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ParticipantRoleChanged}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);const o=n.participants.find(t=>l.jidsMatch(t.jid,i.participant.jid));if(!o)return void console.error(" Unable to find participant in conversation");o.role=i.participant.role;const s=yield this.convert(t,i);yield this.layer.updateConversation(n,{preview:s,isParticipantChange:!0}),this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(s))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return c.createMetaEntry(i,e.date,n,a.ChatMetaActivityType.CHANGEROLE,e.instigator,e.participant.jid,e.participant.role.toString())})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2);e.ParticipantLeftHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ParticipantLeft}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);n.participants=n.participants.filter(t=>!l.jidsMatch(t.jid,i.instigator));const o=yield this.convert(t,i);yield this.layer.updateConversation(n,{preview:o,isParticipantChange:!0}),this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(o))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=l.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return c.createMetaEntry(i,e.date,n,a.ChatMetaActivityType.LEFT,e.instigator)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8);e.ConversationEndedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ConversationEnded}handleMessage(t){return n(this,void 0,void 0,function*(){})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5),a=i(6),c=i(10),l=i(2),d=i(15);e.UserAddedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.User_Added}handleMessage(t){return n(this,void 0,void 0,function*(){const e=t.data[this.messageKey];let i=yield this.layer.getConversationById(e.id);if(null===i&&this.isMamMessage(t))return;if(null!==i&&!i.isClosed)return;const n=new d.ConversationConfigReader(this.layer,i),o=this.layer.getCurrentUserJid(),s=c.createMetaEntry(t._id,e.date,e.roomJid,a.ChatMetaActivityType.ADD,e.instigator,o);if(i&&i.isClosed)yield this.layer.reopenConversation(i,e.participants,s);else{const t=l.enumFromString(e.type);i=c.createConversation(e.id,t,e.roomJid,e.participants,e.title,e.description,e.started,e.priority,e.expiry_ttl,e.activity_ttl,e.receipts,e.responses,e.started_by),yield this.layer.addConversation(i,s)}let h=!0;n.alert&&(h=yield this.layer.priorityAlert(i)),h&&this.layer.emit(r.ChatEvents.ChatEntryReceived,new r.ChatEntryEventArgs(s))})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0),s=i(7),r=i(8),a=i(5),c=i(6),l=i(10),d=i(14);e.UserRemovedHandler=class extends s.BaseChatHandler{constructor(){super(...arguments),this.messageKey=r.ChatMessageType.User_Removed}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);const s=yield this.layer.getCurrentConversation(),r=s&&s.id===n.id,h=this.layer.getCurrentUserJid(),u=h===i.instigator;if(r&&!u){const t=this.layer.translateI18nItem(d.ChatCommonMetadata.getI18nItem(d.ChatCommonI18nKeys.REMOVED_TITLE)),e=this.layer.translateI18nItem(d.ChatCommonMetadata.getI18nItem(d.ChatCommonI18nKeys.REMOVED_MESSAGE)).replace("{{subject}}",n.subject);this.layer.emit(a.ChatEvents._Request_RaiseAlert,new o.DefaultAlerts(this.layer).AlertAcknowledge(t,e,1,{})),this.layer.emit(a.ChatEvents.ForceQuitConversation,new a.ConversationEventArgs(n))}const p=l.createMetaEntry(t._id,i.date,n.roomJid,c.ChatMetaActivityType.REMOVE,i.instigator,h);yield this.layer.closeConversation(n,p),this.layer.emit(a.ChatEvents.ChatEntryReceived,new a.ChatEntryEventArgs(p))})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(6),a=i(10);e.UserLeftHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.User_Left}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);const o=this.layer.getCurrentUserJid(),s=a.createMetaEntry(t._id,i.date,n.roomJid,r.ChatMetaActivityType.LEFT,o);yield this.layer.closeConversation(n,s)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0),s=i(7),r=i(8),a=i(5),c=i(6),l=i(10),d=i(14);e.UserConversationEndedHandler=class extends s.BaseChatHandler{constructor(){super(...arguments),this.messageKey=r.ChatMessageType.User_ConversationEnded}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);const s=yield this.layer.getCurrentConversation(),r=s&&s.id===n.id,h=this.layer.getCurrentUserJid()===i.instigator;if(r&&!h){const t=this.layer.translateI18nItem(d.ChatCommonMetadata.getI18nItem(d.ChatCommonI18nKeys.ENDED_TITLE)),e=this.layer.translateI18nItem(d.ChatCommonMetadata.getI18nItem(d.ChatCommonI18nKeys.ENDED_MESSAGE)).replace("{{subject}}",n.subject);this.layer.emit(a.ChatEvents.ForceQuitConversation,new a.ForceQuitConversationEventArgs(n,i.instigator,c.ChatMetaActivityType.END)),setTimeout(()=>this.layer.emit(a.ChatEvents._Request_RaiseAlert,new o.DefaultAlerts(this.layer).AlertAcknowledge(t,e,1,{}),!0),1e3)}const u=l.createMetaEntry(t._id,i.date,n.roomJid,c.ChatMetaActivityType.END,i.instigator);yield this.layer.closeConversation(n,u),"expired"===i.state&&(yield this.layer.removeConversationById(n.id))})}}},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(5);e.UserDeleteDirectConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.User_DeleteDirectConversation}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){const i=t.data[this.messageKey];if(this.layer.getCurrentUser().id.toLowerCase()===i.instigator.toLowerCase()){const n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);if(n.preview&&n.preview.date>parseInt(i.hide_before))n.hideBefore&&(n.lastHideBefore=n.hideBefore,n.hideBefore=0),yield this.layer.updateConversation(n);else{const t=yield this.layer.getCurrentConversation();if(t&&t.id===n.id)t.hideBefore=parseInt(i.hide_before),yield this.layer.comms.clearStoredConversationMessages(t),yield this.layer.updateConversation(t),yield this.layer.clearCurrentConversation(),this.layer.emit(r.ChatEvents.ConversationDeleted);else{const t=yield this.layer.getConversationById(i.id);t.hideBefore=parseInt(i.hide_before),yield this.layer.comms.clearStoredConversationMessages(t),yield this.layer.updateConversation(t)}}this.layer.dismissWaitingMessage()}})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0),s=i(7),r=i(5),a=i(6),c=i(27),l=i(10),d=i(2);e.ChatEntryEventHandler=class extends s.BaseChatHandler{constructor(){super(...arguments),this.eventType=[r.ChatEvents.ChatEntryReceived]}handleEvent(t,e){return n(this,void 0,void 0,function*(){if(t===r.ChatEvents.ChatEntryReceived){const t=e,i=t.chatEntry;if(!i)return;const n=this.layer.getCurrentUserJid(),o=yield this.layer.getConversationByRoomJid(i.to),s=yield this.layer.getCurrentConversation(),a=s&&s.id===o.id||!1;if(this._shouldRaiseNotification(i,n,o,a)){const e=new c.UserLookup(this.layer);yield e.populate([o]);const s=l.getConversationTitle(o,e,n,""),d=this._getMessagePreview(i,e,n);this.layer.emit(r.ChatEvents.ChatNotification,new r.ChatNotificationEventArgs(t.chatEntry,s,d,a))}}})}_shouldRaiseNotification(t,e,i,n){if(t.type===o.ChatEntryType.Chat&&t.mine)return!1;if(t.type===o.ChatEntryType.Meta&&d.jidsMatch(t.instigator,e))return!1;if(t.date<=(i.hideBefore||i.lastHideBefore))return!1;if(i.instigator!==this.layer.getCurrentUserJid()&&i.acknowledgements&&!i.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid()))return!1;if(i.instigator!==this.layer.getCurrentUserJid()&&i.acknowledgements&&t.date<=i.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid()).ts)return!1;const s=this.layer.getConfiguredPriorityById(i.priority);if(s&&s.alert&&i.acknowledgements&&!i.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid()))return!1;if(s&&s.alert&&i.acknowledgements&&t.date<=i.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid()).ts)return!1;if(n&&t.type!==o.ChatEntryType.Meta&&t.action===a.ChatMetaActivityType.ACK.toString())return!0;if(t.type===o.ChatEntryType.Chat)return!0;if(t.type===o.ChatEntryType.Meta){const n=t;if(n.action===a.ChatMetaActivityType.START.toString())return i.type!==a.ConversationType.Direct;if([a.ChatMetaActivityType.ADD.toString(),a.ChatMetaActivityType.REMOVE.toString(),a.ChatMetaActivityType.CHANGEROLE.toString()].includes(n.action)&&n.subject===e)return!0}return!1}_getMessagePreview(t,e,i){if(t.type===o.ChatEntryType.Chat){const e=t;return l.getChatMessageTextForPreview(e,this.layer)}if(t.type===o.ChatEntryType.Meta){const n=t;return l.getChatMetaActivitySummaryText(n,e,i,this.layer,!1)}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(0),s=i(7),r=i(8),a=i(5),c=i(6),l=i(10),d=i(2),h=i(58),u=i(15);e.ParticipantAcknowledgedHandler=class extends s.BaseChatHandler{constructor(){super(...arguments),this.messageKey=r.ChatMessageType.ParticipantAcknowledged}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data[this.messageKey],n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);const s=new u.ConversationConfigReader(this.layer,n);let r=!1;if(n.acknowledgements||(n.acknowledgements=[]),n.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid())?r=!0:n.acknowledgements.push({jid:i.instigator,ts:parseInt(i.date),value:i.value}),!n.acknowledgements.find(t=>t.jid===i.instigator)&&s.autoIncludeMembersInRoles.length&&s.autoIncludeMembersInRoles.includes(this.layer.getCurrentUser().group))return void n.acknowledgements.push({jid:i.instigator,ts:parseInt(i.date),value:i.value});const c=yield this.convert(t,i);let l=!1;if(i.instigator===this.layer.getCurrentUserJid()&&!1===s.shouldOpenConversationAfterResponded&&(n.hasUnread=!1,l=!0),n.participants.filter(t=>t.role===o.ChatRole.Owner).find(t=>t.jid===this.layer.getCurrentUserJid())||s.participantAlertResponsesVisible?yield this.layer.updateConversation(n,{preview:c,isParticipantChange:!1,overrideHasUnread:l}):yield this.layer.updateConversation(n),this.layer.emit(a.ChatEvents.ChatEntryReceived,new a.ChatEntryEventArgs(c)),i.instigator===this.layer.getCurrentUserJid()){const t=window;d.isAndroid()&&t.PushNotification&&(t.PushNotification.addToIgnoreList&&t.PushNotification.addToIgnoreList(()=>{},()=>{},n.createdTime),t.PushNotification.cancelAtFront&&t.PushNotification.cancelAtFront(()=>{},()=>{})),d.isIos()&&t.VoIPPushNotification&&t.VoIPPushNotification.addToIgnoreList&&t.VoIPPushNotification.addToIgnoreList(n.createdTime,()=>{},()=>{})}i.instigator===this.layer.getCurrentUserJid()&&r?this.layer.emit(a.ChatEvents.PriorityConversationAcknowledgedOnAnotherDevice):this.layer.emit(a.ChatEvents.PriorityConversationAcknowledged,new h.PriorityConversationAcknowledgedEventArgs(n,this.layer.getPendingAlertCount(),i.instigator))})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=d.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return l.createMetaEntry(i,e.date,n,c.ChatMetaActivityType.ACK,e.instigator,e.value)})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(5);e.AutoReconnectedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.eventType=[s.ChatEvents.AutoReconnected]}handleEvent(t,e){return n(this,void 0,void 0,function*(){t===s.ChatEvents.AutoReconnected&&window.cti&&"Login"===window.cti.store.state.currentPage&&(this.layer.comms.clearPostLoginTimeout(),window.cti.utils.callAction("go-to-page",{name:"Conversations"}))})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(14),a=i(16);e.ReceivedConversationHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ReceivedConversation}createIq(t){return a.createIq("rec",this.layer.config.xmpp.iq.namespace,{roomid:t.id})}handleIqErrorResponse(t,e){return n(this,void 0,void 0,function*(){return this.layer.translateI18nItem(r.ChatCommonMetadata.getI18nItem(r.ChatCommonI18nKeys.ERROR_RECEIVING_CONVERSATION)),this.layer.logger.error("Could not mark conversation as received:",e),null})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(8),r=i(6),a=i(5),c=i(2),l=i(10);e.ParticipantReceivedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.messageKey=s.ChatMessageType.ParticipantReceived}handleMessage(t){const e=Object.create(null,{handleConversationNotFound:{get:()=>super.handleConversationNotFound}});return n(this,void 0,void 0,function*(){if(this.isMamMessage(t))return;const i=t.data.participantreceipt,n=yield this.layer.getConversationById(i.id);if(!n)return e.handleConversationNotFound.call(this,t,i.id);let o=!1;n.receivedList||(n.receivedList=[]),n.receivedList.find(t=>t.jid===this.layer.getCurrentUserJid())||n.receivedList.push({jid:i.instigator,ts:parseInt(i.ts),value:""}),yield this.layer.updateConversation(n);const s=yield this.layer.getCurrentConversation();s&&s.id===n.id&&this.layer.emit(a.ChatEvents.CurrentConversationChanged)})}convert(t,e){return n(this,void 0,void 0,function*(){const i=t._id,n=c.findRoomJidInMessage(t,this.layer.config.xmpp.mucHost);return l.createMetaEntry(i,e.date,n,r.ChatMetaActivityType.RECEIVED,e.instigator,"received")})}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(15),s=i(5),r=i(7),a=i(2),c=window;e.RaiseDeviceNotificationHandler=class extends r.BaseChatHandler{constructor(){super(...arguments),this.eventType=[s.ChatEvents.PriorityConversationNotification,s.ChatEvents.PriorityConversationAcknowledged,s.ChatEvents.MuteAlertToPlayOtherAudio,s.ChatEvents.ResumeAlertAfterPlayingAudio,s.ChatEvents.AudioAttachmentDownloadComplete,s.ChatEvents.Mute,s.ChatEvents.ChatNotification],this.currentlyAlerting=!1,this.isMuted=!1}handleEvent(t,e){return n(this,void 0,void 0,function*(){if(t===s.ChatEvents.ChatNotification){if(this.currentlyAlerting)return;const t=e;if(c.cti){const e=c.cti.store.schema.displayName,i="New Message Received";if(!c.cti.store.state.foreground)return void c.cti.utils.callAction("show-notification",{name:"device_notification",title:e,text:i,options:{badge:1}});t.isForCurrentConversation||c.cti.utils.callAction("show-notification",{name:"app_notification",title:e,text:i})}return c.simpleAudioPlayer.setAudio("Clinical_Messaging_Notification.m4a",1),c.simpleAudioPlayer.play(),void c.vibrationController.vibrate(100)}if(t===s.ChatEvents.PriorityConversationNotification&&!this.currentlyAlerting){this.currentlyAlerting=!0;const t=e;c.cti&&!c.cti.store.state.foreground&&c.PushNotification&&c.PushNotification.bringToFront&&c.PushNotification.bringToFront(),c.cti&&(c.cti.store.variables.currently_alerting=!0),this.currentConversation=t.conversation,this._playAlertSound(t.conversation)}if(t===s.ChatEvents.PriorityConversationAcknowledged){this.isMuted=!1;const t=e;if(t.instigator&&t.instigator!==this.layer.getCurrentUserJid())return;if(this.currentConversation=null,this.layer.emit(s.ChatEvents.RemotelyStopAudioPlayer),0===t.pendingCount)this.currentlyAlerting=!1,c.simpleAudioPlayer.stop(!0),c.simpleAudioPlayer.release(),c.vibrationController.stop();else{const t=this.layer.getNewestPendingAlert();c.simpleAudioPlayer.release(),this._playAlertSound(t)}}if(t===s.ChatEvents.MuteAlertToPlayOtherAudio||t===s.ChatEvents.Mute){if(t===s.ChatEvents.Mute){if(this.isMuted)return c.simpleAudioPlayer.play(),void(this.isMuted=!1);this.isMuted=!0}this.layer.getPendingAlertCount()>0&&(c.simpleAudioPlayer.stop(!0),c.vibrationController.stop())}t===s.ChatEvents.ResumeAlertAfterPlayingAudio&&(this.isMuted=!1,this.layer.getPendingAlertCount()>0&&c.simpleAudioPlayer.play()),t===s.ChatEvents.AudioAttachmentDownloadComplete&&new o.ConversationConfigReader(this.layer,this.currentConversation).automaticallyPlayAudioOnDownload&&(c.simpleAudioPlayer.stop(!0),setTimeout(()=>this.layer.emit(s.ChatEvents.RemotelyStartAudioPlayer),1500))})}_playAlertSound(t){const e=new o.ConversationConfigReader(this.layer,t);e.alert&&(c.simpleAudioPlayer.setAudio(e.alertSoundFilename,e.alertSoundLoops,e.alertVolume,a.enumFromString(e.alertAudioStream)),c.simpleAudioPlayer.play(),e.vibrate&&c.vibrationController.vibrate(e.vibrateDuration,0,e.forceVibrate))}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(7),s=i(5);e.AttachmentDownloadedHandler=class extends o.BaseChatHandler{constructor(){super(...arguments),this.eventType=[s.ChatEvents.AttachmentDownloadComplete]}handleEvent(t,e){return n(this,void 0,void 0,function*(){if(t===s.ChatEvents.AttachmentDownloadComplete){const t=e,i=yield this.layer.getConversationById(t.conversationId);if(i){const e=i.attachments.find(e=>e.type===t.type);e&&(e.local=t.filepath,yield this.layer.updateConversation(i))}}})}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(2);var o;!function(t){t[t.iOS=1]="iOS",t[t.Android=2]="Android",t[t.Desktop=3]="Desktop"}(o||(o={})),e.VibrationController=class{constructor(){this._iterations=0;const t=window;t.cti?this._platform="android"===t.cti.store.env.platform.name?o.Android:o.iOS:this._platform=o.Desktop}_vibrate(t=100,e=!1){n.isDesktop()?navigator.vibrate(t):(0,navigator.vibrate)(t,e)}vibrate(t=100,e=1,i=!1){clearInterval(this._timer);const n=t+500;this._iterations=e,0===t?this._platform===o.iOS?(this._vibrate(t,i),this._timer=setInterval(()=>this._vibrate(t,i),n)):this._platform===o.Android&&this._vibrate(864e5,i):(this._vibrate(t,i),0===this._iterations?this._timer=setInterval(()=>this._vibrate(t,i),n):(this._iterations=e-1,this._timer=setInterval(()=>{this._iterations>0?(this._iterations--,this._vibrate(t,i)):this.stop()},n)))}vibrateWithPattern(t,e=1,i=!1){if(clearInterval(this._timer),this._iterations=0,this._platform===o.Android){const n=t.reduce((t,e)=>t+=e,0)+500;this._vibrate(t,i),this._iterations--,this._timer=0===e?setInterval(()=>this._vibrate(t,i),n):setInterval(()=>{this._iterations>0?(this._iterations--,this._vibrate(t,i)):this.stop()},n)}}stop(){this._iterations=0,clearInterval(this._timer),delete this._timer,this._vibrate(0)}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(172),o=i(247),s=i(265),r=i(268),a=i(271),c=i(21),l=i(274),d=i(18),h=i(297),u=i(14),p=window;e.getChatI18nKeys=function(t=!1,...e){return 0===e.length&&(e=[...p.translationData.keys()]),e.reduce((e,i)=>e.concat(function(t,e){return(null===e||p.translationData.has(e))&&p.translationData.get(e).getUniqueI18Keys(t)||[]}(t,i)),[]).filter((t,e,i)=>i.indexOf(t)===e).sort()},p.translationData.set("CTCLConversationAlert",h.CTCLConversationAlertMetadata.instance),p.translationData.set("CTCLAddConversationContacts",n.CTCLAddConversationContactsMetadata.instance),p.translationData.set("CTCLChatMessageList",o.CTCLChatMessageListMetadata.instance),p.translationData.set("CTCLContactInfo",s.CTCLContactInfoMetadata.instance),p.translationData.set("CTCLConversationInfo",r.CTCLConversationInfoMetadata.instance),p.translationData.set("CTCLConversationList",a.CTCLConversationListMetadata.instance),p.translationData.set("CTCLHeader",c.CTCLHeaderMetadata.instance),p.translationData.set("CTCLNewConversation",l.CTCLNewConversationMetadata.instance),p.translationData.set("ChatErrors",d.ChatErrorsMetadata),p.translationData.set("ChatCommon",u.ChatCommonMetadata)},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(12),c=i(0),l=i(13),d=i(21),h=i(5),u=i(4),p=i(2);var g;!function(t){t[t.ADD_CONTACTS="Add Contacts"]="ADD_CONTACTS",t[t.CHOOSE_CONTACT="Choose contacts to add to conversation"]="CHOOSE_CONTACT",t[t.TOTAL_CONTACTS="Total {{number}} Contacts in Conversation"]="TOTAL_CONTACTS",t[t.TOTAL_CONTACTS_MAX="Total {{number}} Contacts in Conversation (out of {{maximum}})"]="TOTAL_CONTACTS_MAX",t[t.SEARCH_PLACEHOLDER="Find Contacts"]="SEARCH_PLACEHOLDER",t[t.INITIAL_MESSAGE="Find your contacts using the search bar above"]="INITIAL_MESSAGE",t[t.NO_MATCHES="No contacts match your search"]="NO_MATCHES",t[t.ADD="Add"]="ADD"}(g||(g={}));class m{static _create(){return new a.Metadata(f,g)}static get instance(){return this._instance||(this._instance=this._create())}}m._instance=null,e.CTCLAddConversationContactsMetadata=m;class f extends l.CTCLComponent{constructor(){super(),this.setMetadata(m.instance)}static get is(){return"ct-cl-add-conversation-contacts"}initialize(){return o(this,void 0,void 0,function*(){if(this.conversation=yield this.layer.getCurrentConversation(),!this.conversation)return this._back();this.layer.setBackHandler(()=>{this._back()})})}setupListeners(){this.setupConnectionStatusListener(),this.addListener(h.ChatEvents.ConversationParticipantsChanged,t=>{this.conversation&&this.conversation.id===t.conversation.id&&(this.conversation.participants=t.conversation.participants,this.forceRedraw())}),this.addListener(r.BaseEvents.ConnectionStatusChange,t=>{t.status===c.ConnectionStatus.Disconnected&&(this.dismissWaitingMessage(),this._back())},{dontSuppress:!0})}get generateComponentStyles(){return i(245)}generateComponentMarkup(){const t=this.conversation.participants.map(t=>t.jid),e=this.layer.config.behaviour.maxConversationParticipants,i={excludeUsers:t,allowSearch:this.allowSearch,requireSearch:this.requireSearch,searchPlaceholder:this.translateI18nItem(g.SEARCH_PLACEHOLDER),initialMessage:this.translateI18nItem(g.INITIAL_MESSAGE),noMatchesMessage:this.translateI18nItem(g.NO_MATCHES),allowSelection:!0,maxSelections:e-t.length,onChangeSelection:t=>{this.selectedParticipantCount=t.length},onClickUser:t=>{this.layer.showContactInfo(t,null,!1)},onClickGroup:t=>this.layer.showRoleUsersModal(t)};return window.__CTRender("div",{class:"contact-list"},this._renderHeader(),window.__CTRender("div",{class:"user-list"},window.__CTRender(u.CTUserList,Object.assign({id:"user-list"},i))),this._renderFooter())}_renderHeader(){const t=this.layer.config.behaviour.maxConversationParticipants||0,e=0===t?this.translateI18nItem(g.TOTAL_CONTACTS):this.translateI18nItem(g.TOTAL_CONTACTS_MAX),i=this.conversation.participants.length-1+this.selectedParticipantCount,n=null!==this.showCountFrom&&i>=this.showCountFrom?e.replace("{{number}}",i.toString()).replace("{{maximum}}",(t-1).toString()):this.translateI18nItem(g.CHOOSE_CONTACT);return window.__CTRender(d.CTCLHeader,{class:"header"},window.__CTRender("div",{slot:"left-action"},window.__CTRender(u.CTIcon,{class:"action",width:"20",height:"20",icon:c.Icons.COMMON.ChevronLeft,onClick:this._back.bind(this)})),window.__CTRender("div",{slot:"heading"},this.translateI18nItem(g.ADD_CONTACTS)),window.__CTRender("div",{slot:"sub-heading"},n))}_renderFooter(){return window.__CTRender("div",{class:"footer"},window.__CTRender(u.CTButton,{type:"primary",class:"button",disabled:!this.isOnline||0===this.selectedParticipantCount,onClick:this._add.bind(this)},this.translateI18nItem(g.ADD)))}_back(){return o(this,void 0,void 0,function*(){yield this._clearSelectedUsers(),this.emitComponentEvent("go-back")})}_add(){return o(this,void 0,void 0,function*(){const t=yield this._getSelectedUsers(),e=new Map;for(const i of t)i.name?i.users.map(t=>e.set(t.jid.toLowerCase(),t)):e.set(i.jid.toLowerCase(),i);const i=Array.from(e.keys()).map(t=>({jid:t,role:c.ChatRole.Participant}));(yield this.layer.addParticipantsToConversation(this.conversation,i))&&this._back()})}_getSelectedUsers(){return o(this,void 0,void 0,function*(){const t=this.shadowRoot.querySelector("#user-list");if(!t)return[];const e=yield t.getSelections();return p.sortUsersByName(e)})}_clearSelectedUsers(){return o(this,void 0,void 0,function*(){const t=this.shadowRoot.querySelector("#user-list");t&&(yield t.clearSelections())})}}n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],f.prototype,"allowSearch",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],f.prototype,"requireSearch",void 0),n([s.prop({type:s.NullableNumber,attribute:!0,default:null})],f.prototype,"showCountFrom",void 0),n([s.prop({type:Object,attribute:!1,default:null})],f.prototype,"conversation",void 0),n([s.prop({type:Number,attribute:!1,default:0})],f.prototype,"selectedParticipantCount",void 0),e.CTCLAddConversationContacts=f,f.register()},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(0),c=i(20);class l extends s.CTLayerComponent{initialize(t){return o(this,void 0,void 0,function*(){this.layer.setShowChatFunction(()=>{this.emitComponentEvent("go-chat")})})}setupConnectionStatusListener(t){this._updateConnectionStatus(this.layer.getConnectionStatus()),this.addListener(r.BaseEvents.ConnectionStatusChange,e=>{this._updateConnectionStatus(e.status,t)},{dontSuppress:!0})}showAcknowledge(t,e){return new Promise(i=>{super.launchAckownledgeDialog(t,e,()=>i())})}requestConfirmation(t){return new Promise(e=>{const i=this.translateI18nItem(c.CommonMetadata.getI18nItem(c.CommonI18nKeys.ARE_YOU_SURE));super.launchConfirmationDialog(i,t,()=>e(!0),()=>e(!1))})}_updateConnectionStatus(t,e){this.connectionStatus=t,this.isOnline=t===a.ConnectionStatus.Connected,"function"==typeof e&&e({status:this.connectionStatus,online:this.isOnline})}}n([s.prop({type:String,attribute:!1,default:a.ConnectionStatus.Disconnected})],l.prototype,"connectionStatus",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],l.prototype,"isOnline",void 0),e.CTCLComponent=l},function(t,e,i){t.exports=i(175).default},function(t,e,i){"use strict";e.__esModule=!0;var n=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(i(176)),o=n.tokenize,s=n.options.Options;function r(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function a(t){return t.replace(/"/g,"&quot;")}function c(t){if(!t)return"";var e=[];for(var i in t){var n=t[i]+"";e.push(i+'="'+a(n)+'"')}return e.join(" ")}function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=new s(e);for(var i=o(t),n=[],l=0;l<i.length;l++){var d=i[l];if("nl"===d.type&&e.nl2br)n.push("<br>\n");else if(d.isLink&&e.check(d)){var h=e.resolve(d),u=h.formatted,p=h.formattedHref,g=h.tagName,m=h.className,f=h.target,_=h.attributes,v="<"+g+' href="'+a(p)+'"';m&&(v+=' class="'+a(m)+'"'),f&&(v+=' target="'+a(f)+'"'),_&&(v+=" "+c(_)),v+=">"+r(u)+"</"+g+">",n.push(v)}else n.push(r(d.toString()))}return n.join("")}String.prototype.linkify||(String.prototype.linkify=function(t){return l(this,t)}),e.default=l},function(t,e,i){"use strict";e.__esModule=!0,e.tokenize=e.test=e.scanner=e.parser=e.options=e.inherits=e.find=void 0;var n=i(28),o=a(i(177)),s=a(i(178)),r=a(i(179));function a(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var c=function(t){return r.run(s.run(t))};e.find=function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=c(t),n=[],o=0;o<i.length;o++){var s=i[o];!s.isLink||e&&s.type!==e||n.push(s.toObject())}return n},e.inherits=n.inherits,e.options=o,e.parser=r,e.scanner=s,e.test=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=c(t);return 1===i.length&&i[0].isLink&&(!e||i[0].type===e)},e.tokenize=c},function(t,e,i){"use strict";e.__esModule=!0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o={defaultProtocol:"http",events:null,format:r,formatHref:r,nl2br:!1,tagName:"a",target:function(t,e){return"url"===e?"_blank":null},validate:!0,ignoreTags:[],attributes:null,className:"linkified"};function s(t){t=t||{},this.defaultProtocol=t.defaultProtocol||o.defaultProtocol,this.events=t.events||o.events,this.format=t.format||o.format,this.formatHref=t.formatHref||o.formatHref,this.nl2br=t.nl2br||o.nl2br,this.tagName=t.tagName||o.tagName,this.target=t.target||o.target,this.validate=t.validate||o.validate,this.ignoreTags=[],this.attributes=t.attributes||t.linkAttributes||o.attributes,this.className=t.className||t.linkClass||o.className;for(var e=t.ignoreTags||o.ignoreTags,i=0;i<e.length;i++)this.ignoreTags.push(e[i].toUpperCase())}function r(t){return t}e.defaults=o,e.Options=s,e.contains=function(t,e){for(var i=0;i<t.length;i++)if(t[i]===e)return!0;return!1},s.prototype={resolve:function(t){var e=t.toHref(this.defaultProtocol);return{formatted:this.get("format",t.toString(),t),formattedHref:this.get("formatHref",e,t),tagName:this.get("tagName",e,t),className:this.get("className",e,t),target:this.get("target",e,t),events:this.getObject("events",e,t),attributes:this.getObject("attributes",e,t)}},check:function(t){return this.get("validate",t.toString(),t)},get:function(t,e,i){var s=this[t];if(!s)return s;switch(void 0===s?"undefined":n(s)){case"function":return s(e,i.type);case"object":var r=s[i.type]||o[t];return"function"==typeof r?r(e,i.type):r}return s},getObject:function(t,e,i){var n=this[t];return"function"==typeof n?n(e,i.type):n}}},function(t,e,i){"use strict";e.__esModule=!0,e.start=e.run=e.TOKENS=e.State=void 0;var n=i(60),o=i(36),s=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}(o),r="aaa|aarp|abb|abbott|abogado|ac|academy|accenture|accountant|accountants|aco|active|actor|ad|adac|ads|adult|ae|aeg|aero|af|afl|ag|agency|ai|aig|airforce|airtel|al|alibaba|alipay|allfinanz|alsace|am|amica|amsterdam|an|analytics|android|ao|apartments|app|apple|aq|aquarelle|ar|aramco|archi|army|arpa|arte|as|asia|associates|at|attorney|au|auction|audi|audio|author|auto|autos|avianca|aw|ax|axa|az|azure|ba|baidu|band|bank|bar|barcelona|barclaycard|barclays|bargains|bauhaus|bayern|bb|bbc|bbva|bcg|bcn|bd|be|beats|beer|bentley|berlin|best|bet|bf|bg|bh|bharti|bi|bible|bid|bike|bing|bingo|bio|biz|bj|black|blackfriday|bloomberg|blue|bm|bms|bmw|bn|bnl|bnpparibas|bo|boats|boehringer|bom|bond|boo|book|boots|bosch|bostik|bot|boutique|br|bradesco|bridgestone|broadway|broker|brother|brussels|bs|bt|budapest|bugatti|build|builders|business|buy|buzz|bv|bw|by|bz|bzh|ca|cab|cafe|cal|call|camera|camp|cancerresearch|canon|capetown|capital|car|caravan|cards|care|career|careers|cars|cartier|casa|cash|casino|cat|catering|cba|cbn|cc|cd|ceb|center|ceo|cern|cf|cfa|cfd|cg|ch|chanel|channel|chase|chat|cheap|chloe|christmas|chrome|church|ci|cipriani|circle|cisco|citic|city|cityeats|ck|cl|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|cm|cn|co|coach|codes|coffee|college|cologne|com|commbank|community|company|compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cool|coop|corsica|country|coupon|coupons|courses|cr|credit|creditcard|creditunion|cricket|crown|crs|cruises|csc|cu|cuisinella|cv|cw|cx|cy|cymru|cyou|cz|dabur|dad|dance|date|dating|datsun|day|dclk|de|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|diamonds|diet|digital|direct|directory|discount|dj|dk|dm|dnp|do|docs|dog|doha|domains|download|drive|dubai|durban|dvag|dz|earth|eat|ec|edeka|edu|education|ee|eg|email|emerck|energy|engineer|engineering|enterprises|epson|equipment|er|erni|es|esq|estate|et|eu|eurovision|eus|events|everbank|exchange|expert|exposed|express|fage|fail|fairwinds|faith|family|fan|fans|farm|fashion|fast|feedback|ferrero|fi|film|final|finance|financial|firestone|firmdale|fish|fishing|fit|fitness|fj|fk|flickr|flights|florist|flowers|flsmidth|fly|fm|fo|foo|football|ford|forex|forsale|forum|foundation|fox|fr|fresenius|frl|frogans|frontier|fund|furniture|futbol|fyi|ga|gal|gallery|gallup|game|garden|gb|gbiz|gd|gdn|ge|gea|gent|genting|gf|gg|ggee|gh|gi|gift|gifts|gives|giving|gl|glass|gle|global|globo|gm|gmail|gmbh|gmo|gmx|gn|gold|goldpoint|golf|goo|goog|google|gop|got|gov|gp|gq|gr|grainger|graphics|gratis|green|gripe|group|gs|gt|gu|gucci|guge|guide|guitars|guru|gw|gy|hamburg|hangout|haus|hdfcbank|health|healthcare|help|helsinki|here|hermes|hiphop|hitachi|hiv|hk|hm|hn|hockey|holdings|holiday|homedepot|homes|honda|horse|host|hosting|hoteles|hotmail|house|how|hr|hsbc|ht|hu|hyundai|ibm|icbc|ice|icu|id|ie|ifm|iinet|il|im|immo|immobilien|in|industries|infiniti|info|ing|ink|institute|insurance|insure|int|international|investments|io|ipiranga|iq|ir|irish|is|iselect|ist|istanbul|it|itau|iwc|jaguar|java|jcb|je|jetzt|jewelry|jlc|jll|jm|jmp|jo|jobs|joburg|jot|joy|jp|jpmorgan|jprs|juegos|kaufen|kddi|ke|kerryhotels|kerrylogistics|kerryproperties|kfh|kg|kh|ki|kia|kim|kinder|kitchen|kiwi|km|kn|koeln|komatsu|kp|kpn|kr|krd|kred|kuokgroup|kw|ky|kyoto|kz|la|lacaixa|lamborghini|lamer|lancaster|land|landrover|lanxess|lasalle|lat|latrobe|law|lawyer|lb|lc|lds|lease|leclerc|legal|lexus|lgbt|li|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|limited|limo|lincoln|linde|link|live|living|lixil|lk|loan|loans|local|locus|lol|london|lotte|lotto|love|lr|ls|lt|ltd|ltda|lu|lupin|luxe|luxury|lv|ly|ma|madrid|maif|maison|makeup|man|management|mango|market|marketing|markets|marriott|mba|mc|md|me|med|media|meet|melbourne|meme|memorial|men|menu|meo|mg|mh|miami|microsoft|mil|mini|mk|ml|mm|mma|mn|mo|mobi|mobily|moda|moe|moi|mom|monash|money|montblanc|mormon|mortgage|moscow|motorcycles|mov|movie|movistar|mp|mq|mr|ms|mt|mtn|mtpc|mtr|mu|museum|mutuelle|mv|mw|mx|my|mz|na|nadex|nagoya|name|natura|navy|nc|ne|nec|net|netbank|network|neustar|new|news|nexus|nf|ng|ngo|nhk|ni|nico|nikon|ninja|nissan|nl|no|nokia|norton|nowruz|np|nr|nra|nrw|ntt|nu|nyc|nz|obi|office|okinawa|om|omega|one|ong|onl|online|ooo|oracle|orange|org|organic|origins|osaka|otsuka|ovh|pa|page|pamperedchef|panerai|paris|pars|partners|parts|party|passagens|pe|pet|pf|pg|ph|pharmacy|philips|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pizza|pk|pl|place|play|playstation|plumbing|plus|pm|pn|pohl|poker|porn|post|pr|praxi|press|pro|prod|productions|prof|promo|properties|property|protection|ps|pt|pub|pw|pwc|py|qa|qpon|quebec|quest|racing|re|read|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|ricoh|rio|rip|ro|rocher|rocks|rodeo|room|rs|rsvp|ru|ruhr|run|rw|rwe|ryukyu|sa|saarland|safe|safety|sakura|sale|salon|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|saxo|sb|sbs|sc|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scor|scot|sd|se|seat|security|seek|select|sener|services|seven|sew|sex|sexy|sfr|sg|sh|sharp|shell|shia|shiksha|shoes|show|shriram|si|singles|site|sj|sk|ski|skin|sky|skype|sl|sm|smile|sn|sncf|so|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|spreadbetting|sr|srl|st|stada|star|starhub|statefarm|statoil|stc|stcgroup|stockholm|storage|store|studio|study|style|su|sucks|supplies|supply|support|surf|surgery|suzuki|sv|swatch|swiss|sx|sy|sydney|symantec|systems|sz|tab|taipei|taobao|tatamotors|tatar|tattoo|tax|taxi|tc|tci|td|team|tech|technology|tel|telecity|telefonica|temasek|tennis|tf|tg|th|thd|theater|theatre|tickets|tienda|tiffany|tips|tires|tirol|tj|tk|tl|tm|tmall|tn|to|today|tokyo|tools|top|toray|toshiba|total|tours|town|toyota|toys|tp|tr|trade|trading|training|travel|travelers|travelersinsurance|trust|trv|tt|tube|tui|tunes|tushu|tv|tvs|tw|tz|ua|ubs|ug|uk|unicom|university|uno|uol|us|uy|uz|va|vacations|vana|vc|ve|vegas|ventures|verisign|versicherung|vet|vg|vi|viajes|video|viking|villas|vin|vip|virgin|vision|vista|vistaprint|viva|vlaanderen|vn|vodka|volkswagen|vote|voting|voto|voyage|vu|vuelos|wales|walter|wang|wanggou|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weir|wf|whoswho|wien|wiki|williamhill|win|windows|wine|wme|wolterskluwer|work|works|world|ws|wtc|wtf|xbox|xerox|xin|xperia|xxx|xyz|yachts|yahoo|yamaxun|yandex|ye|yodobashi|yoga|yokohama|youtube|yt|za|zara|zero|zip|zm|zone|zuerich|zw".split("|"),a="0123456789".split(""),c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),l=[" ","\f","\r","\t","\v","","",""],d=[],h=function(t){return new n.CharacterState(t)},u=h(),p=h(o.NUM),g=h(o.DOMAIN),m=h(),f=h(o.WS);u.on("@",h(o.AT)).on(".",h(o.DOT)).on("+",h(o.PLUS)).on("#",h(o.POUND)).on("?",h(o.QUERY)).on("/",h(o.SLASH)).on("_",h(o.UNDERSCORE)).on(":",h(o.COLON)).on("{",h(o.OPENBRACE)).on("[",h(o.OPENBRACKET)).on("<",h(o.OPENANGLEBRACKET)).on("(",h(o.OPENPAREN)).on("}",h(o.CLOSEBRACE)).on("]",h(o.CLOSEBRACKET)).on(">",h(o.CLOSEANGLEBRACKET)).on(")",h(o.CLOSEPAREN)).on("&",h(o.AMPERSAND)).on([",",";","!",'"',"'"],h(o.PUNCTUATION)),u.on("\n",h(o.NL)).on(l,f),f.on(l,f);for(var _=0;_<r.length;_++){var v=(0,n.stateify)(r[_],u,o.TLD,o.DOMAIN);d.push.apply(d,v)}var y=(0,n.stateify)("file",u,o.DOMAIN,o.DOMAIN),C=(0,n.stateify)("ftp",u,o.DOMAIN,o.DOMAIN),b=(0,n.stateify)("http",u,o.DOMAIN,o.DOMAIN),w=(0,n.stateify)("mailto",u,o.DOMAIN,o.DOMAIN);d.push.apply(d,y),d.push.apply(d,C),d.push.apply(d,b);var T=y.pop(),E=C.pop(),S=b.pop(),R=w.pop(),A=h(o.DOMAIN),I=h(o.PROTOCOL),x=h(o.MAILTO);E.on("s",A).on(":",I),S.on("s",A).on(":",I),d.push(A),T.on(":",I),A.on(":",I),R.on(":",x);var M=(0,n.stateify)("localhost",u,o.LOCALHOST,o.DOMAIN);d.push.apply(d,M),u.on(a,p),p.on("-",m).on(a,p).on(c,g),g.on("-",m).on(c,g);for(var O=0;O<d.length;O++)d[O].on("-",m).on(c,g);m.on("-",m).on(a,g).on(c,g),u.defaultTransition=h(o.SYM);var N=u;e.State=n.CharacterState,e.TOKENS=s,e.run=function(t){for(var e=t.replace(/[A-Z]/g,function(t){return t.toLowerCase()}),i=t.length,n=[],o=0;o<i;){for(var s=u,r=null,a=0,c=null,l=-1;o<i&&(r=s.next(e[o]));)(s=r).accepts()?(l=0,c=s):l>=0&&l++,a++,o++;if(!(l<0)){o-=l,a-=l;var d=c.emit();n.push(new d(t.substr(o-a,a)))}}return n},e.start=N},function(t,e,i){"use strict";e.__esModule=!0,e.start=e.run=e.TOKENS=e.State=void 0;var n=i(60),o=i(36),s=(a(o),i(180)),r=a(s);function a(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}var c=function(t){return new n.TokenState(t)},l=c(),d=c(),h=c(),u=c(),p=c(),g=c(),m=c(),f=c(s.URL),_=c(),v=c(s.URL),y=c(s.URL),C=c(),b=c(),w=c(),T=c(),E=c(),S=c(s.URL),R=c(s.URL),A=c(s.URL),I=c(s.URL),x=c(),M=c(),O=c(),N=c(),P=c(),L=c(),D=c(s.EMAIL),k=c(),j=c(s.EMAIL),U=c(s.MAILTOEMAIL),F=c(),B=c(),H=c(),$=c(),q=c(s.NL);l.on(o.NL,q).on(o.PROTOCOL,d).on(o.MAILTO,h).on(o.SLASH,u),d.on(o.SLASH,u),u.on(o.SLASH,p),l.on(o.TLD,g).on(o.DOMAIN,g).on(o.LOCALHOST,f).on(o.NUM,g),p.on(o.TLD,y).on(o.DOMAIN,y).on(o.NUM,y).on(o.LOCALHOST,y),g.on(o.DOT,m),P.on(o.DOT,L),m.on(o.TLD,f).on(o.DOMAIN,g).on(o.NUM,g).on(o.LOCALHOST,g),L.on(o.TLD,D).on(o.DOMAIN,P).on(o.NUM,P).on(o.LOCALHOST,P),f.on(o.DOT,m),D.on(o.DOT,L),f.on(o.COLON,_).on(o.SLASH,y),_.on(o.NUM,v),v.on(o.SLASH,y),D.on(o.COLON,k),k.on(o.NUM,j);var z=[o.DOMAIN,o.AT,o.LOCALHOST,o.NUM,o.PLUS,o.POUND,o.PROTOCOL,o.SLASH,o.TLD,o.UNDERSCORE,o.SYM,o.AMPERSAND],V=[o.COLON,o.DOT,o.QUERY,o.PUNCTUATION,o.CLOSEBRACE,o.CLOSEBRACKET,o.CLOSEANGLEBRACKET,o.CLOSEPAREN,o.OPENBRACE,o.OPENBRACKET,o.OPENANGLEBRACKET,o.OPENPAREN];y.on(o.OPENBRACE,b).on(o.OPENBRACKET,w).on(o.OPENANGLEBRACKET,T).on(o.OPENPAREN,E),C.on(o.OPENBRACE,b).on(o.OPENBRACKET,w).on(o.OPENANGLEBRACKET,T).on(o.OPENPAREN,E),b.on(o.CLOSEBRACE,y),w.on(o.CLOSEBRACKET,y),T.on(o.CLOSEANGLEBRACKET,y),E.on(o.CLOSEPAREN,y),S.on(o.CLOSEBRACE,y),R.on(o.CLOSEBRACKET,y),A.on(o.CLOSEANGLEBRACKET,y),I.on(o.CLOSEPAREN,y),x.on(o.CLOSEBRACE,y),M.on(o.CLOSEBRACKET,y),O.on(o.CLOSEANGLEBRACKET,y),N.on(o.CLOSEPAREN,y),b.on(z,S),w.on(z,R),T.on(z,A),E.on(z,I),b.on(V,x),w.on(V,M),T.on(V,O),E.on(V,N),S.on(z,S),R.on(z,R),A.on(z,A),I.on(z,I),S.on(V,S),R.on(V,R),A.on(V,A),I.on(V,I),x.on(z,S),M.on(z,R),O.on(z,A),N.on(z,I),x.on(V,x),M.on(V,M),O.on(V,O),N.on(V,N),y.on(z,y),C.on(z,y),y.on(V,C),C.on(V,C),h.on(o.TLD,U).on(o.DOMAIN,U).on(o.NUM,U).on(o.LOCALHOST,U),U.on(z,U).on(V,F),F.on(z,U).on(V,F);var G=[o.DOMAIN,o.NUM,o.PLUS,o.POUND,o.QUERY,o.UNDERSCORE,o.SYM,o.AMPERSAND,o.TLD];g.on(G,B).on(o.AT,H),f.on(G,B).on(o.AT,H),m.on(G,B),B.on(G,B).on(o.AT,H).on(o.DOT,$),$.on(G,B),H.on(o.TLD,P).on(o.DOMAIN,P).on(o.LOCALHOST,D),e.State=n.TokenState,e.TOKENS=r,e.run=function(t){for(var e=t.length,i=0,n=[],o=[];i<e;){for(var r=l,a=null,c=null,d=0,h=null,u=-1;i<e&&!(a=r.next(t[i]));)o.push(t[i++]);for(;i<e&&(c=a||r.next(t[i]));)a=null,(r=c).accepts()?(u=0,h=r):u>=0&&u++,i++,d++;if(u<0)for(var p=i-d;p<i;p++)o.push(t[p]);else{o.length>0&&(n.push(new s.TEXT(o)),o=[]),i-=u,d-=u;var g=h.emit();n.push(new g(t.slice(i-d,i)))}}return o.length>0&&n.push(new s.TEXT(o)),n},e.start=l},function(t,e,i){"use strict";e.__esModule=!0,e.URL=e.TEXT=e.NL=e.EMAIL=e.MAILTOEMAIL=e.Base=void 0;var n=i(61),o=i(28),s=i(36);function r(t){return t instanceof s.DOMAIN||t instanceof s.TLD}var a=(0,n.createTokenClass)();a.prototype={type:"token",isLink:!1,toString:function(){for(var t=[],e=0;e<this.v.length;e++)t.push(this.v[e].toString());return t.join("")},toHref:function(){return this.toString()},toObject:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http";return{type:this.type,value:this.toString(),href:this.toHref(t)}}};var c=(0,o.inherits)(a,(0,n.createTokenClass)(),{type:"email",isLink:!0}),l=(0,o.inherits)(a,(0,n.createTokenClass)(),{type:"email",isLink:!0,toHref:function(){return this.v,"mailto:"+this.toString()}}),d=(0,o.inherits)(a,(0,n.createTokenClass)(),{type:"text"}),h=(0,o.inherits)(a,(0,n.createTokenClass)(),{type:"nl"}),u=(0,o.inherits)(a,(0,n.createTokenClass)(),{type:"url",isLink:!0,toHref:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http",e=!1,i=!1,n=this.v,o=[],a=0;n[a]instanceof s.PROTOCOL;)e=!0,o.push(n[a].toString().toLowerCase()),a++;for(;n[a]instanceof s.SLASH;)i=!0,o.push(n[a].toString()),a++;for(;r(n[a]);)o.push(n[a].toString().toLowerCase()),a++;for(;a<n.length;a++)o.push(n[a].toString());return o=o.join(""),e||i||(o=t+"://"+o),o},hasProtocol:function(){return this.v[0]instanceof s.PROTOCOL}});e.Base=a,e.MAILTOEMAIL=c,e.EMAIL=l,e.NL=h,e.TEXT=d,e.URL=u},function(t,e,i){var n=i(182);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block;width:100%}:host div.container ct-button{font-size:1.4em}:host div.container div.sheet-bg{display:flex;position:absolute;top:0;left:0;height:100%;width:100%;background-color:rgba(0,0,0,.3);transition:all .1s ease-in;opacity:1;overflow:hidden}:host div.container div.sheet-bg.hidden{opacity:0;pointer-events:none}:host div.container div.sheet-bg div.sheet-buttons{display:flex;flex-direction:column;justify-content:flex-end;flex:1;padding:10px 20px}:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons{transform:translateY(0);transition:all .3s ease-in-out}:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.close,:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.inner-buttons{border-radius:10px;overflow:hidden}:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.close ct-button,:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.inner-buttons ct-button{border-bottom:1px solid var(--action-sheet-border-color,#d9d9d9);border-radius:0}:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.close ct-button:last-child,:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.inner-buttons ct-button:last-child{border-bottom:0}:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons div.close{margin-top:10px}:host div.container div.sheet-bg div.sheet-buttons div.inner-sheet-buttons.hidden{transform:translateY(100%)}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(4);class c extends s.CTLayerComponent{static get is(){return"ct-alert-modal-manager"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){this.addListener(r.BaseEvents._Request_RaiseAlert,t=>this.raiseAlert(t)),this.addListener(r.BaseEvents._Request_CloseAlert,t=>this.dismissAlertById(t))}get generateComponentStyles(){return i(184)}generateComponentMarkup(){return window.__CTRender("div",{class:"alerts"},this.alerts.map((t,e)=>window.__CTRender(a.CTAlertModal,{id:t.id||this.defaultAlerts.generateId(),raisedOn:t.raisedOn,priority:t.priority,type:t.type,title:t.title,body:t.body,buttons:t.buttons,remaining:this.alerts.length,positionInStack:e,showLoadingAnimation:t.showLoadingAnimation})))}raiseAlert(t){if(t){if(t.buttons)for(const e of t.buttons)if(e.action){const t=e.action.bind(this);e.action=(e=>{t(e),this.dismissAlert()})}else e.action=(()=>this.dismissAlert());this.alerts=[...this.alerts,t],this.alertsToShow=!0}}dismissAlert(t=0){this.alerts.splice(t,1),0===this.alerts.length?this.alertsToShow=!1:this.alerts=this.alerts.map((t,e)=>(t.remaining=this.alerts.length,t))}dismissAlertById(t){const e=this.alerts.findIndex(e=>e.id===t);-1!==e&&this.dismissAlert(e)}}n([s.prop({type:Boolean,attribute:!0,default:!1})],c.prototype,"alertsToShow",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],c.prototype,"alerts",void 0),e.CTAlertModalManager=c,c.register()},function(t,e,i){var n=i(185);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:none;width:100%;height:100%;background:var(--modal-overlay,rgba(0,0,0,.5));position:fixed;top:0;z-index:99999;padding:20px;overflow:auto}:host .alerts{display:flex;width:100%;max-width:420px;margin:auto;position:relative}:host([alerts-to-show]){display:flex}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(44),a=i(4),c=i(9);class l extends s.CTLayerComponent{static get is(){return"ct-alert-modal"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(187)}generateComponentMarkup(){const t=r.Icons.COMMON.LoadingSpinner,e=5*this.positionInStack;return this.style.right=`${e}px`,this.style.bottom=`${e}px`,this.style.zIndex=`${this.remaining-this.positionInStack}`,0===this.positionInStack?this.showing=!0:this.stacked=!0,window.__CTRender("div",{"alert-id":this.id,class:`alert-dialog ${this.type}`},this.remaining>1&&this.showing?window.__CTRender("div",{class:"remaining"},this.remaining):null,window.__CTRender("div",{class:"title"},this.renderHtml(this.title)),window.__CTRender("div",{class:"body"},c.renderIf(this.showLoadingAnimation,window.__CTRender(a.CTIcon,{class:"loading",width:"18",height:"18",spin:!0,icon:t})),window.__CTRender("div",{class:"message"},this.renderHtml(this.body))),c.renderIf(!!this.buttons&&this.buttons.length>0,window.__CTRender("div",{class:"buttons"},this.buttons.map((t,e)=>window.__CTRender(a.CTButton,{type:t.type,class:`${this.buttons.length>2?"overflex":""} ${2===this.buttons.length&&0===e?"right-border":""}`,onClick:e=>t.action(e.target.textContent)},t.text)))))}}n([s.prop({type:Boolean,attribute:!0,default:!1})],l.prototype,"showing",void 0),n([s.prop({type:String,attribute:!1,default:0})],l.prototype,"id",void 0),n([s.prop({type:Number,attribute:!1,default:0})],l.prototype,"raisedOn",void 0),n([s.prop({type:Number,attribute:!1,default:0})],l.prototype,"priority",void 0),n([s.prop({type:String,attribute:!1,default:"info"})],l.prototype,"type",void 0),n([s.prop({type:String,attribute:!1,default:""})],l.prototype,"title",void 0),n([s.prop({type:String,attribute:!1,default:""})],l.prototype,"body",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],l.prototype,"buttons",void 0),n([s.prop({type:Number,attribute:!1,default:0})],l.prototype,"remaining",void 0),n([s.prop({type:Number,attribute:!1,default:0})],l.prototype,"positionInStack",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],l.prototype,"showLoadingAnimation",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],l.prototype,"stacked",void 0),e.CTAlertModal=l,l.register()},function(t,e,i){var n=i(188);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,'/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:none;width:100%;height:100%;flex-direction:column;background-color:var(--modal-bg,#fff)}:host .alert-dialog{overflow:hidden}:host .alert-dialog .remaining{position:absolute;width:35px;height:35px;background-color:red;border-radius:50%;text-align:center;line-height:35px;color:#fff;right:-5%;top:-5%}:host .alert-dialog .title{font-size:16px;text-transform:uppercase;margin:0 auto;padding:10px}:host .alert-dialog .body,:host .alert-dialog .title{display:flex;justify-content:center;text-align:center}:host .alert-dialog .body{align-items:flex-start;font-size:18px;font-weight:300;padding:50px}:host .alert-dialog .body ct-icon{flex:none;margin:3px 10px 0 0}:host .alert-dialog .buttons{padding:10px 5px;flex:none;display:flex;flex-wrap:wrap;flex-direction:row;justify-content:space-between}:host .alert-dialog .buttons ct-button{flex:1;margin:0 5px;border-radius:0}:host .alert-dialog .buttons ct-button.overflex{flex-basis:100%}:host .alert-dialog .buttons ct-button.overflex+ct-button{margin-top:10px}:host .alert-dialog.error .title{background-color:var(--alert-error-bg,#c80031);color:var(--alert-error-text,#fff)}:host .alert-dialog.info .title{background-color:var(--alert-info-bg,#15233b);color:var(--alert-info-text,#fff)}:host .alert-dialog.question .title{background-color:var(--alert-question-bg,#15233b);color:var(--alert-question-text,#fff)}:host .alert-dialog.success .title{background-color:var(--alert-success-bg,#bcdf90);color:var(--alert-success-text,#fff)}:host([showing]){display:flex;z-index:10}:host([stacked]){display:flex;position:absolute;bottom:5px;right:5px;z-index:1}:host([stacked]):before{content:"";display:block;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.25)}',""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(9);class a extends s.CTLayerComponent{static get is(){return"ct-avatar-tile"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(190)}generateComponentMarkup(){const t=["avatar-tile"];this.hatched&&t.push("hatched");const e=r.buildStyles({height:this.height||"auto"});return window.__CTRender("div",{class:t.join(" "),style:e},window.__CTRender("div",{class:"avatar"},window.__CTRender("slot",{name:"avatar"})),window.__CTRender("div",{class:"detail",style:this.detailStyle},window.__CTRender("slot",null)),window.__CTRender("slot",{name:"additional"}))}}n([s.prop({type:String,attribute:!1,default:null})],a.prototype,"height",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],a.prototype,"hatched",void 0),n([s.prop({type:Object,attribute:!1,default:{}})],a.prototype,"detailStyle",void 0),e.CTAvatarTile=a,a.register()},function(t,e,i){var n=i(191);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block}:host .avatar-tile{position:relative;display:flex;align-items:center;padding:var(--avatar-tile-padding,6px 10px);color:var(--default-font-color,#212121);background-color:var(--list-item-bg,#fff);border-bottom:var(--list-item-border,1px solid #ddd)}:host .avatar-tile .avatar{flex:none;display:flex;flex-direction:column;justify-content:center;align-items:center}:host .avatar-tile .avatar ::slotted(*){margin:0 10px 0 0}@media only screen and (min-width:960px){:host .avatar-tile .avatar{flex:0 0 10%;justify-content:flex-start;flex-direction:row;flex-basis:6vw}}:host .avatar-tile .detail{flex:1 1 auto;display:flex;flex-direction:column;overflow:hidden}@media only screen and (min-width:960px){:host .avatar-tile .detail{flex-direction:row}:host .avatar-tile .detail slot{display:flex;flex:1}:host .avatar-tile .detail slot::slotted(.name){flex:1 1 20%!important;align-items:center;margin:auto 0}:host .avatar-tile .detail slot::slotted(.group),:host .avatar-tile .detail slot::slotted(.job-title){display:flex;flex:1 0 35%;align-items:center}}:host .avatar-tile.hatched{background-size:5px 5px;background-image:linear-gradient(45deg,transparent 46%,#d8d8d8 49%,#d8d8d8 51%,transparent 55%)}",""])},function(t,e,i){var n=i(193);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}@keyframes ripple{to{transform:scale(2);opacity:0}}:host{display:block;border-radius:10px}:host,:host button{position:relative;overflow:hidden}:host button{background:transparent;color:#000;padding:.55em 1em;border:1px solid transparent;font-family:inherit;font-size:inherit;font-weight:inherit;outline:none;cursor:pointer;width:100%;height:100%;min-height:45px;border-radius:inherit}:host button .button-content{pointer-events:none;display:inline-flex;justify-content:center;align-items:center}:host button .button-content .icon,:host button .button-content .label{display:block}:host button .button-content .icon+.label{margin:0 0 0 5px}:host button .ripple{background-color:#fff;border-radius:50%;opacity:.4;transform:scale(.01);position:absolute;pointer-events:none}:host button .ripple.animate{animation:ripple .6s ease-out}:host button.primary{background-color:var(--button-primary-bg,#000);border:var(--button-primary-border,1px solid #000);color:var(--button-primary-text,#fff)}:host button.primary .ripple{background-color:var(--button-primary-ripple,#fff)}:host button.secondary{background-color:var(--button-secondary-bg,transparent);border:var(--button-secondary-border,1px solid #000);color:var(--button-secondary-text,#000)}:host button.secondary .ripple{background-color:var(--button-secondary-ripple,#000)}:host button.tertiary{background-color:var(--button-tertiary-bg,#ddd);border:var(--button-tertiary-border,1px solid #ddd);color:var(--button-tertiary-text,#000)}:host button.tertiary .ripple{background-color:var(--button-tertiary-ripple,#fff)}:host button.invert-primary{background:var(--button-invert-primary-bg,#fff);border:var(--button-invert-primary-border,1px solid #fff);color:var(--button-invert-primary-text,#2c394e)}:host button.invert-primary .ripple{background-color:var(--button-invert-primary-ripple,#2c394e)}:host button.invert-secondary{background:var(--button-invert-secondary-bg,transparent);border:var(--button-invert-secondary-border,1px solid #fff);color:var(--button-invert-secondary-text,#fff)}:host button.invert-secondary .ripple{background-color:var(--button-invert-secondary-ripple,#fff)}:host button.selected{background-color:var(--button-selected-bg,#15233b);border:var(--button-selected-border,1px solid #15233b);color:var(--button-selected-text,#fff)}:host button.selected .ripple{background-color:var(--button-selected-ripple,#fff)}:host button.cancel{background-color:var(--button-cancel-bg,transparent);border:var(--button-cancel-border,1px solid #fff);color:var(--button-cancel-text,#000)}:host button.cancel .ripple{background-color:var(--button-cancel-ripple,#000)}:host button.warning{background-color:var(--button-warning-bg,#fdb851);border:var(--button-warning-border,#fdb851);color:var(--button-warning-text,#fff)}:host button.warning .ripple{background-color:var(--button-warning-ripple,#fff)}:host button.dangerous{background-color:var(--button-dangerous-bg,#f24647);border:var(--button-dangerous-border,#f24647);color:var(--button-dangerous-text,#fff)}:host button.dangerous .ripple{background-color:var(--button-dangerous-ripple,#fff)}:host button.headerBack{background-color:#231f20;border:none;color:#fff}:host button.headerBack .ripple{background-color:#fff}:host button.transparent{background-color:transparent;border:none}:host button.large{padding:1.25em 1em}:host button[disabled]{opacity:.5;cursor:not-allowed}:host button.action-sheet{background-color:var(--action-sheet-button-bg,#fff);color:var(--button-primary-bg,#000)}:host button.action-sheet div.label{display:flex;flex-direction:column;justify-content:flex-start}::slotted(p){margin:0}::slotted(p.hasSubtitle){padding-top:6px}::slotted(span){padding-bottom:10px;font-size:.7em;color:var(--action-sheet-subtitle-color,#828688)}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(17),s=i(13),r=i(4);class a extends s.CTCLComponent{constructor(){super(...arguments),this.ALL_LOGGERS_TOKEN="_all_",this._loggingTypes=Object.values(o.LoggerTypes).filter((t,e)=>e%2==0),this._selectedLoggingTypes=[]}static get is(){return"ct-debugger"}initialize(){return n(this,void 0,void 0,function*(){this._selectedLoggingTypes=this.layer.logger.getTypes()})}setupListeners(){}get generateComponentStyles(){return i(195)}generateComponentMarkup(){return window.__CTRender("div",{class:"debugger"},this._renderLoggingOptions(),this._renderResetOptions())}_renderLoggingOptions(){const t=this.layer.logger.hasInitialTypes();return window.__CTRender("div",{class:"section logging"},window.__CTRender("div",{class:"heading"},"Logging"),window.__CTRender("div",{class:"buttons"},window.__CTRender(r.CTButton,{class:"button",type:"secondary",width:"auto",onClick:this._enableAllLogging.bind(this)},"All"),window.__CTRender(r.CTButton,{class:"button",type:"secondary",width:"auto",onClick:this._disableAllLogging.bind(this)},"None"),t&&window.__CTRender(r.CTButton,{class:"button",type:"secondary",width:"auto",onClick:this._resetAllLogging.bind(this)},"Reset")),window.__CTRender("div",{class:"options"},this._loggingTypes.map(t=>{const e=this._selectedLoggingTypes.includes(t)||this._selectedLoggingTypes.includes(this.ALL_LOGGERS_TOKEN);return window.__CTRender("div",{key:t,class:"option"},window.__CTRender("label",{htmlFor:t},window.__CTRender("input",{type:"checkbox",id:t,checked:e,onChange:()=>this._onChangeLoggingType(t)})," ",t))})))}_renderResetOptions(){return window.__CTRender("div",{class:"section reset"},window.__CTRender("div",{class:"heading"},"App reset"),window.__CTRender("div",{class:"buttons"},window.__CTRender(r.CTButton,{class:"button",type:"secondary",width:"auto",onClick:this._reloadApp.bind(this)},"Reload"),window.__CTRender(r.CTButton,{class:"button",type:"secondary",width:"auto",onClick:this._clearAllAppData.bind(this)},"Clear local data")))}_enableAllLogging(){return n(this,void 0,void 0,function*(){yield this.layer.setSupportLoggingTypes([...this._loggingTypes]),this._updateLoggers()})}_disableAllLogging(){this.layer.setSupportLoggingTypes([]),this._updateLoggers()}_resetAllLogging(){this.layer.resetSupportLogging(),this._updateLoggers()}_onChangeLoggingType(t){this._selectedLoggingTypes.includes(this.ALL_LOGGERS_TOKEN)&&(this._selectedLoggingTypes=[...this._loggingTypes]);const e=this._selectedLoggingTypes.includes(t)?this._selectedLoggingTypes.filter(e=>e!==t):[...this._selectedLoggingTypes,t];this.layer.setSupportLoggingTypes(e),this._updateLoggers()}_reloadApp(){this.layer.showWaitingMessage("Reloading..."),window.location.reload()}_clearAllAppData(){this.layer.showWaitingMessage("Clearing all data..."),this.layer.clearAllData().then(()=>{window.location.reload()})}_updateLoggers(){this._selectedLoggingTypes=this.layer.logger.getTypes(),this.forceRedraw()}}e.CTDebugger=a,a.register()},function(t,e,i){var n=i(196);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block}:host .debugger .section{border:1px dotted var(--default-border-color,#d9d9d9);border-radius:8px;padding:10px}:host .debugger .section .heading{font-size:18px;font-weight:600;margin:0 0 10px}:host .debugger .section .buttons{display:flex;margin:10px 0}:host .debugger .section .buttons .button+.button{margin:0 0 0 5px}:host .debugger .section.logging .options{display:flex;flex-wrap:wrap}:host .debugger .section.logging .options .option{width:160px}:host .debugger .section+.section{margin:10px 0 0}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(22),r=i(1),a=i(0),c=i(4);class l extends r.CTLayerComponent{constructor(){super(...arguments),this.btnClick=(()=>o(this,void 0,void 0,function*(){const t=yield s.CtXmppClient.pickFile({mimeTypes:this.fileTypes});this.callback&&this.callback(t)}))}static get is(){return"ct-file-picker"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return""}generateComponentMarkup(){return window.__CTRender("div",null,window.__CTRender(c.CTButton,{icon:a.Icons.COMMON.PlusSign,iconColor:"#fff",onClick:this.btnClick}))}}n([r.prop({type:Array,attribute:!0,default:["image/jpeg","image/png","image/gif"]})],l.prototype,"fileTypes",void 0),n([r.prop({type:Function,attribute:!1})],l.prototype,"callback",void 0),e.CTFilePicker=l,l.register()},function(t,e,i){var n=i(199);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block}:host .bg{position:relative;flex:none;display:flex;flex-direction:column;justify-content:center;align-items:center;border-radius:50%;overflow:hidden;background:var(--avatar-bg,#7b7e80);color:var(--avatar-color,#fff)}:host .bg .image{position:absolute;top:0;left:0;border-radius:50%}",""])},function(t,e,i){var n=i(201);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host .name{flex:1 1 auto;font-size:18px;color:var(--default-font-color,#212121)}:host .group,:host .job-title,:host .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}:host .group,:host .job-title{color:var(--subtle-font-color,#828688)}:host .group{font-style:italic}:host .empty{color:#e1e1e1}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(9);class a extends s.CTLayerComponent{constructor(){super(),this._textbox=null,this._sizeTest=null,this._htmlStripper=null,this._messageContent="",this._sizeTestContent="",this._isMaxSizeMessageTextBox=!1,this._setupResizeWatcher()}static get is(){return"ct-growing-textbox"}initialize(){return o(this,void 0,void 0,function*(){this.onRenderComplete(()=>this._updateTextboxHeight(),!0)})}setupListeners(){}get generateComponentStyles(){return i(203)}generateComponentMarkup(){const t=["textbox","animate-height"];this.transparent&&t.push("transparent"),this._isMaxSizeMessageTextBox&&t.push("max-size");const e=r.buildStyles({"max-height":`${this.maxHeight||200}px`});return null!==this.height&&(e.height=`${this.height}px`),window.__CTRender("div",{class:"growing-textbox"},window.__CTRender("textarea",{id:"textbox",class:t.join(" "),style:e,rows:1,value:this.value,placeholder:this.placeholder,disabled:this.disabled,maxLength:this.maxLength,onFocus:this._onFocus.bind(this),onInput:this._onChange.bind(this),onKeydown:t=>this._onKeyDown(t)}),window.__CTRender("div",{id:"size-test",class:"textbox size-test"},this.renderHtml(this._sizeTestContent)))}_onFocus(){"function"==typeof this.onFocus&&this.onFocus()}_onChange(){this._updateTextboxHeight(),"function"==typeof this.onChange&&this.onChange()}_onKeyDown(t){13===t.keyCode&&t.shiftKey&&(t.preventDefault(),"function"==typeof this.onSubmit&&this.onSubmit())}focus(){this._getDomNodes(),this._textbox&&this._textbox.focus()}getValue(){return this._getDomNodes(),this._textbox?this._textbox.value:""}clear(){this._getDomNodes(),this._textbox&&(this.value="",this._textbox.value="",this._updateTextboxHeight())}_getDomNodes(){const t=this.shadowRoot;this._textbox=this._textbox||t.querySelector("#textbox"),this._sizeTest=this._sizeTest||t.querySelector("#size-test"),this._htmlStripper=this._htmlStripper||document.createElement("div")}_setupResizeWatcher(){window.addEventListener("resize",this._updateTextboxHeight.bind(this))}_updateTextboxHeight(){if(this._getDomNodes(),!this._textbox)return;if(!this._sizeTest)return;const t=this._textbox.value;this._sizeTest.style.width=`${this._textbox.offsetWidth}px`,this._messageContent=t,this._htmlStripper.innerHTML=t;const e=this._htmlStripper.textContent.replace(/\n/g,"<br/>");this._sizeTestContent=e,this._sizeTest.innerHTML=e+"&nbsp",this.height=this._sizeTest.offsetHeight;const i=(this.height||0)>=this.maxHeight;i!==this._isMaxSizeMessageTextBox&&(this._isMaxSizeMessageTextBox=i,this.forceRedraw())}}n([s.prop({type:String,attribute:!0,default:""})],a.prototype,"value",void 0),n([s.prop({type:String,attribute:!0,default:""})],a.prototype,"placeholder",void 0),n([s.prop({type:s.NullableNumber,attribute:!0,default:null})],a.prototype,"height",void 0),n([s.prop({type:Number,attribute:!0,default:200})],a.prototype,"maxHeight",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],a.prototype,"transparent",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],a.prototype,"disabled",void 0),n([s.prop({type:Number,attribute:!0,default:!1})],a.prototype,"maxLength",void 0),n([s.prop({type:Function,attribute:!1,default:null})],a.prototype,"onFocus",void 0),n([s.prop({type:Function,attribute:!1,default:null})],a.prototype,"onChange",void 0),n([s.prop({type:Function,attribute:!1,default:null})],a.prototype,"onSubmit",void 0),e.CTGrowingTextbox=a,a.register()},function(t,e,i){var n=i(204);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:flex}:host .growing-textbox{display:flex;flex-direction:column;flex:1 1 auto;background-color:var(--default-bg-color-light,#fff);overflow:hidden;border:var(--secondary-border,1px solid #ddd);border-radius:10px}:host .growing-textbox .textbox{flex:1 1 auto;font-family:inherit;font-size:inherit;font-weight:inherit;min-height:32px;overflow:hidden;padding:6px 10px;resize:none;outline:none;border:var(--secondary-border,1px solid #ddd);will-change:transform;color:var(--tertiary-font-color,inherit)}:host .growing-textbox .textbox.animate-height{transition:height .1s ease-out}:host .growing-textbox .textbox.transparent{background:transparent;border:0;padding:7px 10px}:host .growing-textbox .textbox.max-size{overflow:auto}:host .growing-textbox .textbox.size-test{position:fixed;top:-10000px;left:-10000px;height:auto;white-space:pre-wrap}:host .growing-textbox .textbox::placeholder{color:var(--select-placeholder-color,#828688)}:host .growing-textbox .textbox::-webkit-input-placeholder{color:var(--select-placeholder-color,#828688)}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(9);class a extends s.CTLayerComponent{static get is(){return"ct-icon"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(206)}generateComponentMarkup(){if(!this.icon)return null;const t=r.buildStyles({fill:"auto"!==this.color?this.color:window.getComputedStyle(this.parentElement).color,width:this.width,height:this.height}),e=this.icon.viewBox||"0 0 1024 1024",i=this.icon.nodes||[],n=this.icon.paths||[];return i.length?this._drawFromNodes(e,i,t):this._drawFromPaths(e,n,t)}_drawFromPaths(t,e,i){return window.__CTRender("svg",{width:this.width,height:this.height,viewBox:t,style:i},e.map(t=>window.__CTRender("path",{d:t})))}_drawFromNodes(t,e,i){return window.__CTRender("svg",{width:this.width,height:this.height,viewBox:t,style:i},e.map(t=>this._drawNode(t)))}_drawNode(t){return window.__CTRender(t.name,Object.assign({},t.attributes),(t.children||[]).map(t=>this._drawNode(t)))}}n([s.prop({type:String,attribute:!0})],a.prototype,"width",void 0),n([s.prop({type:String,attribute:!0})],a.prototype,"height",void 0),n([s.prop({type:String,attribute:!0,default:"auto"})],a.prototype,"color",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],a.prototype,"spin",void 0),n([s.prop({type:Object,attribute:!1,default:null})],a.prototype,"icon",void 0),e.CTIcon=a,a.register()},function(t,e,i){var n=i(207);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:flex}:host svg{margin:auto}:host([spin]) svg{animation:spin 1s infinite linear;transform-origin:50% 50%}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(12),c=i(0),l=i(4),d=i(9);var h;!function(t){t[t.USERNAME="Username"]="USERNAME",t[t.PASSWORD="Password"]="PASSWORD",t[t.LOG_IN="Log In"]="LOG_IN",t[t.LOG_OUT="Log Out"]="LOG_OUT"}(h||(h={}));class u{static _create(){return new a.Metadata(p,h)}static get instance(){return this._instance||(this._instance=this._create())}}u._instance=null,e.CTLoginFormMetadata=u;class p extends s.CTLayerComponent{constructor(){super(),this.setMetadata(u.instance)}static get is(){return"ct-login-form"}initialize(){return o(this,void 0,void 0,function*(){this._resetFields()})}setupListeners(){this.addListener(r.BaseEvents.ConnectionStatusChange,t=>{switch(t.status){case c.ConnectionStatus.Connected:this.userLoggedIn=!0;break;case c.ConnectionStatus.Connecting:this.isWaiting=!0;break;default:this.isWaiting=!1,this.userLoggedIn=!1}},{dontSuppress:!0})}get generateComponentStyles(){return i(209)}generateComponentMarkup(){return this.userLoggedIn?this._renderLogoutForm():this._renderLoginForm()}_renderLoginForm(){const t=["form"];this.theme&&t.push(`theme-${this.theme}`);const e=d.buildStyles({display:this.hideUsername?"none":"block"}),i={};return this.theme&&(i[`theme-${this.theme}`]=!0),window.__CTRender("div",{class:t.join(" ")},window.__CTRender("div",{class:"form-field",style:e},window.__CTRender(l.CTTextbox,Object.assign({type:"text",placeholder:this.translateI18nItem(h.USERNAME),name:"username",defaultValue:this._username,disabled:this.disableUsername||this.isWaiting},i,{callback:t=>this._onChange(t),returnKeypress:t=>this._login(),forceTransparency:!0}))),window.__CTRender("div",{class:"form-field"},window.__CTRender(l.CTTextbox,Object.assign({type:"password",placeholder:this.translateI18nItem(h.PASSWORD),name:"password",defaultValue:this._password},i,{callback:t=>this._onChange(t),disabled:this.isWaiting,returnKeypress:t=>this._login(),forceTransparency:!0}))),window.__CTRender("div",{class:"form-buttons"},window.__CTRender(l.CTButton,{class:"button",type:"primary",disabled:this.disabled,onClick:t=>this._login(),isWaiting:this.isWaiting},this.logInLabel||this.translateI18nItem(h.LOG_IN))))}_renderLogoutForm(){let t=this.layer.getCurrentUserJid();this.autoAppendDomainName&&(t=t.split("@").shift());const e={};return this.theme&&(e[`theme-${this.theme}`]=!0),window.__CTRender("div",{class:"form",style:d.buildStyles({display:"flex"})},window.__CTRender("div",{class:"form-field"},window.__CTRender(l.CTTextbox,Object.assign({type:"text",name:"username",defaultValue:t},e,{disabled:!0}))),window.__CTRender("div",{class:"form-buttons"},window.__CTRender(l.CTButton,{type:"primary",disabled:!1,onClick:t=>this._logout(),isWaiting:this.isWaiting},this.translateI18nItem(h.LOG_OUT))))}_onChange(t){t&&"username"===t.key&&(this._username=t.value),t&&"password"===t.key&&(this._password=t.value),this.disabled=!this._username||!this._password}_resetFields(){this._username=this.username||"",this._password="",this.disabled=!0}_login(){return o(this,void 0,void 0,function*(){if(this._username&&this._password){this.isWaiting=!0;let t=this.autoAppendDomainName?`${this._username.trim()}@${this.layer.config.xmpp.user.domain}`:this._username.trim();this.layer.config.xmpp.user&&!0===this.layer.config.xmpp.user.forceLowercaseJid&&(t=t.toLowerCase());try{yield this.layer.login(t,this._password),this.emitComponentEvent(r.BaseEvents.LoginFormResult,new r.CommsEventArgs(!0)),this.isWaiting=!1,this._resetFields()}catch(e){this.emitComponentEvent(r.BaseEvents.LoginFormResult,new r.CommsEventArgs(!1,`Could not log in as ${t}`)),this.isWaiting=!1,this._password="",this._onChange(),document.activeElement.blur()}}})}_logout(){return o(this,void 0,void 0,function*(){this.isWaiting=!0;try{yield this.layer.logout(),this.isWaiting=!1,this._resetFields()}catch(t){this.emitComponentEvent(r.BaseEvents.LoginFormResult,new r.CommsEventArgs(!1,"There was an error logging out. Please try again.")),this.isWaiting=!1,document.activeElement.blur()}})}}n([s.prop({type:String,attribute:!0,default:""})],p.prototype,"theme",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],p.prototype,"autoAppendDomainName",void 0),n([s.prop({type:String,attribute:!0,default:""})],p.prototype,"username",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],p.prototype,"hideUsername",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],p.prototype,"disableUsername",void 0),n([s.prop({type:String,attribute:!0,default:null})],p.prototype,"logInLabel",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],p.prototype,"isWaiting",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],p.prototype,"disabled",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],p.prototype,"userLoggedIn",void 0),e.CTLoginForm=p,p.register()},function(t,e,i){var n=i(210);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block;width:100%;margin:auto}:host .form{display:flex;flex-direction:column;width:100%}:host .form .form-buttons,:host .form .form-field{margin:5px 0}:host .form.theme-light .form-buttons .button{--button-primary-bg:transparent;--button-primary-text:#fff;--button-primary-border:1px solid #fff}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4);class c extends s.CTLayerComponent{constructor(){super(),this._open=!1,this._setUpEventHandlers()}static get is(){return"ct-menu"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(212)}generateComponentMarkup(){return window.__CTRender("div",{class:"menu-container"},window.__CTRender("div",{class:"button",onClick:t=>this._toggleMenu(t)},window.__CTRender(a.CTIcon,{width:"20",height:"20",icon:r.Icons.COMMON.MenuDots})),this._open&&window.__CTRender("div",{class:"menu"},this.menuItems.map(t=>this._renderMenuItem(t))))}_renderMenuItem(t){const e=["menu-item"];return t.disabled&&e.push("disabled"),t.className&&e.push(t.className),window.__CTRender("div",{class:e.join(" "),onClick:()=>this._performAction(t)},t.label)}_toggleMenu(t){t.stopPropagation(),this._setMenuState(!this._open)}_performAction(t){t&&t.action&&(t.disabled||(this._setMenuState(!1),t.action()))}_setUpEventHandlers(){const t=this._handleDocumentInteraction.bind(this);document.addEventListener("click",t),window.addEventListener("resize",t)}_setMenuState(t=!this._open){this._open=t,this.forceRedraw()}_handleDocumentInteraction(){this._open&&this._setMenuState(!1)}}n([s.prop({type:Array,attribute:!0,default:[]})],c.prototype,"menuItems",void 0),e.CTMenu=c,e.MenuItem=class{constructor(t,e,i=!1,n=null){this.label=t,this.action=e,this.disabled=i,this.className=n}},c.register()},function(t,e,i){var n=i(213);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:inline-block;color:inherit}:host .menu-container{position:relative}:host .menu-container .button{cursor:pointer}:host .menu-container .menu{position:absolute;top:25px;right:0;min-width:80px;background:var(--list-bg);color:var(--default-font-color,#212121);border:var(--list-item-border);z-index:99999;box-shadow:0 2px 5px rgba(0,0,0,.5)}:host .menu-container .menu .menu-item{border-bottom:var(--list-item-border);padding:10px;cursor:pointer;white-space:nowrap}:host .menu-container .menu .menu-item.disabled{opacity:.5}:host .menu-container .menu .menu-item:hover:not(.disabled){background:var(--secondary-color,#efefef)}:host .menu-container .menu .menu-item:last-child{border-bottom:0}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(12),c=i(0),l=i(4),d=i(9),h=i(62);var u;!function(t){t[t.ONLINE="Online"]="ONLINE",t[t.OFFLINE="Offline"]="OFFLINE",t[t.RECONNECTING="Reconnecting"]="RECONNECTING",t[t.RECONNECT="Reconnect"]="RECONNECT"}(u||(u={}));class p{static _create(){return new a.Metadata(g,u)}static get instance(){return this._instance||(this._instance=this._create())}}p._instance=null,e.CTOnlineIndicatorMetadata=p;class g extends s.CTLayerComponent{constructor(){super(),this.attemptCount=0,this.setMetadata(p.instance)}static get is(){return"ct-online-indicator"}initialize(){return o(this,void 0,void 0,function*(){this.status=this.layer.getConnectionStatus()})}setupListeners(){this.addListener(r.BaseEvents.ConnectionStatusChange,t=>{this.status=t.status,this.reconnectTime=t.reconnectTime,this.allowReconnect=t.status===c.ConnectionStatus.Disconnected,clearInterval(this.timeoutId),t.reconnectTime&&(this.timeoutId=setInterval(()=>{this.reconnectTime-=1e3},1e3))},{dontSuppress:!0})}get generateComponentStyles(){return i(215)}generateComponentMarkup(){const t=["online-indicator",this.status===c.ConnectionStatus.Connected?"online":"offline"],e=this.status===c.ConnectionStatus.Connecting?c.Icons.COMMON.LoadingSpinner:this.status===c.ConnectionStatus.Connected?c.Icons.COMMON.StatusOnline:c.Icons.COMMON.StatusOffline;return window.__CTRender("div",{class:t.join(" ")},d.renderIf(this.showIcon,window.__CTRender("div",{class:"icon"},window.__CTRender(l.CTIcon,{width:"16",height:"16",icon:e,spin:this.status===c.ConnectionStatus.Connecting}))),d.renderIf(this.showText,window.__CTRender("div",{class:"label"},window.__CTRender("span",{class:"status"},this._getStatusLabel()),d.renderIf(this.status===c.ConnectionStatus.Disconnected&&void 0!==this.reconnectTime&&this.reconnectTime>0,window.__CTRender("span",{class:"reconnect-detail"},window.__CTRender("span",{class:"countdown"},this._getCountdownLabel()),window.__CTRender(h.CTButton,{type:"invert-secondary",disabled:!this.allowReconnect,onClick:t=>this._tryLoginNow(t)},this.translateI18nItem(u.RECONNECT)))))))}_getStatusLabel(){switch(this.status){case c.ConnectionStatus.Connected:return this.translateI18nItem(u.ONLINE);case c.ConnectionStatus.Connecting:return this.translateI18nItem(u.RECONNECTING);case c.ConnectionStatus.Disconnecting:case c.ConnectionStatus.Disconnected:return this.translateI18nItem(u.OFFLINE)}}_getCountdownLabel(){return`(${this.reconnectTime/1e3}s)`}_tryLoginNow(t){!1!==this.allowReconnect&&(this.allowReconnect=!1,this.status=c.ConnectionStatus.Connecting,this.layer.attemptReconnect())}}n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],g.prototype,"showIcon",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],g.prototype,"showText",void 0),n([s.prop({type:String,attribute:!1,default:c.ConnectionStatus.Disconnected})],g.prototype,"status",void 0),n([s.prop({type:Number,attribute:!1,default:0})],g.prototype,"reconnectTime",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],g.prototype,"allowReconnect",void 0),e.CTOnlineIndicator=g,g.register()},function(t,e,i){var n=i(216);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:inline-flex;font-size:inherit;font-weight:inherit;color:inherit}:host .online-indicator{display:flex;align-items:center}:host .online-indicator .icon{flex:none;margin:0 5px 0 0}:host .online-indicator .label{flex:1 1}:host .online-indicator .label,:host .online-indicator .label .reconnect-detail{display:flex;align-items:center}:host .online-indicator .label .reconnect-detail .countdown{width:40px;padding:0 5px}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4);class c extends s.CTLayerComponent{static get is(){return"ct-searchbox"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(218)}generateComponentMarkup(){let t=r.Icons.COMMON.Search;return"filter"===this.type&&(t=r.Icons.COMMON.Filter),window.__CTRender("div",{class:"search-box"},window.__CTRender("input",{type:"text",placeholder:this.placeholder,oninput:t=>this._onChange(t.target.value),onblur:t=>this._onBlur()}),window.__CTRender(a.CTIcon,{class:"icon",width:"16",height:"16",icon:t}),this.allowClear&&this.showClear&&window.__CTRender(a.CTIcon,{class:"clear",width:"12",height:"12",icon:r.Icons.COMMON.CircleCross,onClick:this._clear.bind(this)}))}_onChange(t){0===t.length?(this.cancelDebounce("search"),this.showClear=!1,this.value="",this.onSearch("")):(this.showClear=!0,this.debounce("search",()=>{this.value=t,"function"==typeof this.onSearch&&this.onSearch(t)},this.delay))}_clear(t=!0){if(!this.allowClear)return;const e=this.shadowRoot.querySelector("input");e.value="",t&&e.focus(),this._onChange("")}_onBlur(){this.onBlur&&this.onBlur()}clear(){return o(this,void 0,void 0,function*(){this._clear(!1)})}}n([s.prop({type:String,attribute:!0,default:"search"})],c.prototype,"type",void 0),n([s.prop({type:String,attribute:!0,default:""})],c.prototype,"placeholder",void 0),n([s.prop({type:Number,attribute:!0,default:200})],c.prototype,"delay",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],c.prototype,"allowClear",void 0),n([s.prop({type:Function,attribute:!1,default:null})],c.prototype,"onSearch",void 0),n([s.prop({type:Function,attribute:!1,default:null})],c.prototype,"onBlur",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],c.prototype,"showClear",void 0),n([s.prop({type:String,attribute:!1,default:""})],c.prototype,"value",void 0),e.CTSearchbox=c,c.register()},function(t,e,i){var n=i(219);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block}:host .search-box{position:relative;color:var(--subtle-font-color,#828688)}:host .search-box input{width:100%;height:30px;font-family:inherit;font-size:14px;font-weight:inherit;padding:4px 26px;border-radius:15px;background:#fff;color:var(--default-font-color,#212121);border:var(--secondary-border,1px solid #ddd);outline:none}:host .search-box input::placeholder{text-align:center;color:var(--subtle-font-color,#828688)}:host .search-box input::-webkit-input-placeholder{text-align:center;color:var(--subtle-font-color,#828688)}:host .search-box .icon{left:0}:host .search-box .clear,:host .search-box .icon{position:absolute;top:0;height:100%;padding:0 7px}:host .search-box .clear{right:0;cursor:pointer}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4),c=i(9);class l extends s.CTLayerComponent{static get is(){return"ct-selection-list"}initialize(){return o(this,void 0,void 0,function*(){"function"==typeof this.onSelect&&this.onSelect(this.options[this.selected].key)})}setupListeners(){}get generateComponentStyles(){return i(221)}generateComponentMarkup(){const t=!this.forceDropdown&&(this.buttonList||this.options.length<=4),e=["selection-list"];return this.buttonList&&e.push("button-list"),window.__CTRender("div",{class:e.join(" ")},window.__CTRender("label",null,"Response Options"),c.renderIfElse(t,this._renderButtons(),this._renderDropDown()))}_renderDropDown(){return window.__CTRender("div",{class:"dropdown-contanier"},window.__CTRender("select",{onChange:t=>this._onMakeSelection(t),value:this.selected.toString()},this.options.map(t=>window.__CTRender("option",{"data-key":t.key,value:t.key.toString(),defaultSelected:this.selected===t.key},t.value))),window.__CTRender(a.CTIcon,{class:"select-icon",width:"12",height:"12",icon:r.Icons.COMMON.ChevronDown}))}_renderButtons(){return this.options.map(t=>window.__CTRender("div",{class:"button-container"},window.__CTRender(a.CTButton,{"data-key":t.key,type:"secondary",selected:this.selected===t.key,onClick:t=>this._onMakeSelection(t)},t.value)))}_onMakeSelection(t){const e=t.target;if(!e)return;let i=null;switch(e.nodeName){case"CT-BUTTON":i=parseInt(e.getAttribute("data-key"));break;case"SELECT":i=parseInt(e.value)}if(isNaN(i))return;const n=this.options.find(t=>t.key===i);n&&(this._makeSelection(n.key),this.selected=n.key)}_makeSelection(t){"function"==typeof this.onSelect&&this.onSelect(t)}}n([s.prop({type:Number,attribute:!0,default:Number.MIN_VALUE})],l.prototype,"selected",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],l.prototype,"buttonList",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],l.prototype,"forceDropdown",void 0),n([s.prop({type:Function,attribute:!0})],l.prototype,"onSelect",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],l.prototype,"options",void 0),e.CTSelectionList=l,l.register()},function(t,e,i){var n=i(222);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block;width:100%}:host .selection-list{display:flex;flex-direction:row;flex-wrap:wrap;color:var(--default-bg-color-light-font,#212121)}:host .selection-list label{margin:10px 0 5px;text-transform:uppercase;font-size:.8em;color:var(--tertiary-placeholder-color,#212121)}:host .selection-list .dropdown-contanier{flex:1 1 100%;position:relative}:host .selection-list .dropdown-contanier select{width:100%;height:30px;font-size:16px;outline:none;background-color:var(--default-bg-color-light,#fff);border:1px solid var(--select-border-color,#d9d9d9);color:inherit;-webkit-appearance:none;padding:.3em;border-radius:0}:host .selection-list .dropdown-contanier ct-icon.select-icon{pointer-events:none;position:absolute;top:0;right:0;height:100%;padding:0 7px;cursor:pointer}:host .selection-list .button-container{position:relative;flex:0 1 50%}:host .selection-list .button-container:nth-child(2n-1){padding:10px 5px 0 0}:host .selection-list .button-container:nth-child(2n-2){padding:10px 0 0 5px}:host .selection-list .button-container:first-child,:host .selection-list .button-container:nth-child(2){padding-top:0}:host .selection-list.button-list{display:block}:host .selection-list.button-list .button-container{display:block;padding:0 0 1px}:host .selection-list.button-list .button-container:last-child{padding:0}",""])},function(t,e,i){var n=i(224);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:flex;flex:1}:host div.container{display:flex;flex:1;height:40px;border-radius:20px;border:1px solid var(--select-border-color,#d9d9d9);background-color:var(--default-bg-color-light,#fff);position:relative;color:var(--default-bg-color-light-font,#212121)}:host div.container div.select>select,:host div.container input{outline:0;font-size:16px;padding:0 10px;border:0}:host div.container div.select{border-top-left-radius:20px;border-bottom-left-radius:20px;border-top-right-radius:0;border-bottom-right-radius:0;flex:0 0 30%;width:30%;height:100%;position:relative;border-right:1px solid var(--select-border-color,#d9d9d9)}:host div.container div.select select{border-top-left-radius:20px;border-bottom-left-radius:20px;-webkit-appearance:none;padding-right:26px;width:100%;height:100%;cursor:pointer;background-color:transparent;color:inherit}:host div.container div.select.highlight,:host div.container div.select.highlight>select{color:var(--primary-color,#15233b);font-weight:700}:host div.container input{flex:1;border-top-right-radius:20px;border-bottom-right-radius:20px;padding-right:26px;margin:0;border-top-left-radius:0;border-bottom-left-radius:0;background-color:transparent;color:inherit}:host div.container input::placeholder{color:var(--select-placeholder-color,#828688)}:host div.container input::-webkit-input-placeholder{color:var(--select-placeholder-color,#828688)}:host div.container ct-icon.select-icon{pointer-events:none}:host div.container ct-icon.clear,:host div.container ct-icon.select-icon{position:absolute;top:0;right:0;height:100%;padding:0 7px;cursor:pointer}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4),c=i(9);class l extends s.CTLayerComponent{static get is(){return"ct-slide-panel"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(226)}generateComponentMarkup(){const t=["slide-panel",this.state],e=c.buildStyles({width:this.menuWidth||"300px"});return window.__CTRender("div",{class:t.join(" ")},window.__CTRender("div",{class:"button",onClick:this._toggleMenu.bind(this)},window.__CTRender(a.CTIcon,{width:"20",height:"20",icon:r.Icons.COMMON.Menu})),window.__CTRender("div",{class:"blocker",onClick:this._closeMenu.bind(this)}),window.__CTRender("div",{class:"slide-panel-menu",style:e},window.__CTRender("slot",null)))}_toggleMenu(){this.state&&"closed"!==this.state?this.state="closed":this.state="open"}_closeMenu(){this.state="closed"}}n([s.prop({type:String,attribute:!0,default:"300px"})],l.prototype,"menuWidth",void 0),n([s.prop({type:String,attribute:!1,default:""})],l.prototype,"state",void 0),e.CTSlidePanel=l,l.register()},function(t,e,i){var n=i(227);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block;color:inherit}@keyframes fadein{0%{opacity:0;transform:translateX(-100%)}1%{opacity:0;transform:translateX(0)}to{opacity:1;transform:translateX(0)}}@keyframes fadeout{0%{opacity:1;transform:translateX(0)}99%{opacity:0;transform:translateX(0)}to{opacity:0;transform:translateX(-100%)}}@keyframes slidein{0%{transform:translateX(-200%)}1%{transform:translateX(-100%)}to{transform:translateX(0)}}@keyframes slideout{0%{transform:translateX(0)}99%{transform:translateX(-100%)}to{transform:translateX(-200%)}}:host .slide-panel{display:flex;justify-content:center;align-items:center;height:100%}:host .slide-panel .button{display:block;z-index:99999;cursor:pointer}:host .slide-panel .blocker{width:100%;background:rgba(0,0,0,.5);z-index:99997}:host .slide-panel .blocker,:host .slide-panel .slide-panel-menu{position:fixed;top:0;left:0;height:100%;transform:translateX(-200%);will-change:transform}:host .slide-panel .slide-panel-menu{background:transparent;color:#212121;z-index:99998}:host .slide-panel.open .blocker{animation:fadein var(--animation-fast,.3s) 1 ease-out normal forwards}:host .slide-panel.open .slide-panel-menu{animation:slidein var(--animation-fast,.3s) 1 ease-out normal forwards}:host .slide-panel.closed .blocker{animation:fadeout var(--animation-fast,.3s) 1 ease-out normal forwards}:host .slide-panel.closed .slide-panel-menu{animation:slideout var(--animation-fast,.3s) 1 ease-out normal forwards}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4),c=i(9);class l extends s.CTLayerComponent{static get is(){return"ct-textbox"}initialize(){return o(this,void 0,void 0,function*(){this._value=this.defaultValue||"",this._isPasswordField=this.type&&"password"===this.type.toLowerCase(),this._isPasswordField&&this._watchPasswordField()})}setupListeners(){}get generateComponentStyles(){return i(229)}generateComponentMarkup(){const t={};return this.max&&(t.maxlength=this.max),window.__CTRender("div",{class:this.disabled?"disabled":""},c.renderIf(void 0!==this.label,window.__CTRender("label",{htmlFor:this.name},this.label)),window.__CTRender("div",{class:"input"},c.renderIfElse("textarea"===this.type,window.__CTRender("textarea",Object.assign({class:`${this.forceTransparency?"transparent":""}`,placeholder:this.placeholder,name:this.name,onFocus:t=>this._toggleFocus(!0),onBlur:t=>this._toggleFocus(!1),onInput:t=>this._updateValue({key:t.target.name,value:t.target.value}),onkeydown:this._keydown.bind(this),value:this.defaultValue,disabled:this.disabled,required:this.required,rows:5},t)),window.__CTRender("input",Object.assign({class:`${this.forceTransparency?"transparent":""}`,type:this.type,placeholder:this.placeholder,name:this.name,onFocus:t=>this._toggleFocus(!0),onBlur:t=>this._toggleFocus(!1),onInput:t=>this._updateValue({key:t.target.name,value:t.target.value}),onkeydown:this._keydown.bind(this),value:this.defaultValue,disabled:this.disabled,required:this.required},t))),c.renderIf(this.required,window.__CTRender(a.CTIcon,{class:"required",width:"8",height:"8",color:"#a91a49",icon:r.Icons.COMMON.RequiredField})),c.renderIf(this.showClearOptions&&!this._isPasswordField,window.__CTRender(a.CTIcon,{class:"clear-value",width:"12",height:"12",icon:r.Icons.COMMON.ClearTextbox,onClick:t=>this._clear()})),c.renderIf(this._isPasswordField,window.__CTRender(a.CTIcon,{class:`show-password ${"text"===this.type?"show-password-enabled":""}`,width:"20",height:"20",icon:r.Icons.COMMON.ShowPassword,onClick:t=>this._togglePasswordFieldType()}))))}_toggleFocus(t){const e=this.shadowRoot.querySelector(".input"),i="textarea"===this.type?e.querySelector("textarea"):e.querySelector("input");t?(e.classList.add("focus"),"scrollIntoViewIfNeeded"in i?i.scrollIntoViewIfNeeded():"scrollIntoView"in i&&i.scrollIntoView()):e.classList.remove("focus")}_keydown(t){13===t.keyCode&&this.returnKeypress&&this.returnKeypress()}_updateValue(t){this._value=t.value,"function"==typeof this.callback&&this.callback({key:t.key,value:t.value,validated:this.validated})}_clear(){let t;(t="textarea"!==this.type?this.shadowRoot.querySelector("input"):this.shadowRoot.querySelector("textarea")).value="",t.focus(),t.dispatchEvent(new Event("input"))}_togglePasswordFieldType(){this._isPasswordField&&("password"===this.type?this.type="text":this.type="password")}_watchPasswordField(){const t=t=>{const e=this.shadowRoot.querySelector(".input");t.path&&!1===t.path.includes(e)&&"text"===this.type&&(this.type="password")};document.removeEventListener("click",t),document.addEventListener("click",t)}}n([s.prop({type:String,attribute:!0})],l.prototype,"placeholder",void 0),n([s.prop({type:String,attribute:!0})],l.prototype,"type",void 0),n([s.prop({type:String,attribute:!0})],l.prototype,"label",void 0),n([s.prop({type:String,attribute:!0})],l.prototype,"name",void 0),n([s.prop({type:Boolean,attribute:!0,default:!0})],l.prototype,"showClearOptions",void 0),n([s.prop({type:String,attribute:!0})],l.prototype,"defaultValue",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],l.prototype,"required",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],l.prototype,"disabled",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],l.prototype,"fullBorder",void 0),n([s.prop({type:Number,attribute:!0,default:4e3})],l.prototype,"max",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],l.prototype,"validated",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],l.prototype,"forceTransparency",void 0),e.CTTextbox=l,l.register()},function(t,e,i){var n=i(230);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host label{color:var(--default-font-color,#212121)}:host div div.input{position:relative;display:flex;flex-direction:row;margin:0 0 5px;border-bottom:1px solid var(--default-border-color,#d9d9d9)}:host div div.input.focus{border-color:var(--login-form-border-color,green)}:host div div.input input,:host div div.input textarea{flex:1 1;font-family:inherit;font-size:inherit;font-weight:inherit;background-color:var(--default-bg-color-light,transparent);border:none;padding:.3em;margin:auto;outline:none;resize:none;color:var(--login-form-font-color,inherit)}:host div div.input input.transparent,:host div div.input textarea.transparent{background-color:transparent}:host div div.input input:focus,:host div div.input textarea:focus{border:none;outline-offset:0}:host div div.input input:focus:not(:placeholder-shown)~.clear-value,:host div div.input textarea:focus:not(:placeholder-shown)~.clear-value{opacity:.5;cursor:pointer}:host div div.input input:focus:not(:placeholder-shown)~.required,:host div div.input textarea:focus:not(:placeholder-shown)~.required{visibility:hidden}:host div div.input input:valid~.required,:host div div.input textarea:valid~.required{visibility:hidden}:host div div.input ct-icon{flex:0 0 20px;text-align:center}:host div div.input ct-icon.show-password{opacity:.5}:host div div.input ct-icon.show-password.show-password-enabled{opacity:1}:host div div.input ct-icon.required{position:absolute;right:5px;top:0;height:100%}:host div div.input ct-icon.clear-value{opacity:0}:host div div.input ct-icon+ct-icon{margin:0 0 0 5px}:host div div.input .validation{margin-bottom:1%;color:red}:host div.disabled div.input{border-bottom:none}:host([full-border]) div div.input{background-color:var(--default-bg-color-light,#fff);border:1px solid var(--select-border-color,#d9d9d9);color:var(--default-bg-color-light-font,#212121)}:host([full-border]) div div.input input::placeholder,:host([full-border]) div div.input textarea::placeholder{color:var(--select-placeholder-color,#828688)}:host([full-border]) div div.input input::-webkit-input-placeholder,:host([full-border]) div div.input textarea::-webkit-input-placeholder{color:var(--select-placeholder-color,#828688)}:host([theme-light]) label{color:#fff}:host([theme-light]) div div.input{border-bottom:1px solid hsla(0,0%,100%,.6);color:#fff}:host([theme-light]) div div.input input,:host([theme-light]) div div.input textarea{color:#fff}:host([theme-light]) div div.input input::placeholder,:host([theme-light]) div div.input textarea::placeholder{color:hsla(0,0%,100%,.6)}:host([theme-light]) div div.input input::-webkit-input-placeholder,:host([theme-light]) div div.input textarea::-webkit-input-placeholder{color:hsla(0,0%,100%,.6)}:host([theme-light]) div div.input.focus{border-color:#fff}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(0),a=i(4),c=i(9);class l extends s.CTLayerComponent{static get is(){return"ct-user-avatar"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(232)}generateComponentMarkup(){const t=c.buildStyles({width:`${this.size}px`,height:`${this.size}px`});this.bgColor&&(t.backgroundColor=this.bgColor);const e=Math.floor(this.size/2);return window.__CTRender("div",{class:"bg",style:t},window.__CTRender(a.CTIcon,{icon:this.defaultIcon,width:e,height:e}),this.user.avatar&&window.__CTRender("img",{class:"image",src:this.user.avatar,width:this.size,height:this.size}))}}n([s.prop({type:Number,attribute:!1,default:40})],l.prototype,"size",void 0),n([s.prop({type:Object,attribute:!1})],l.prototype,"user",void 0),n([s.prop({type:Object,attribute:!1,default:r.Icons.COMMON.User})],l.prototype,"defaultIcon",void 0),n([s.prop({type:String,attribute:!1,default:""})],l.prototype,"bgColor",void 0),e.CTUserAvatar=l,l.register()},function(t,e,i){var n=i(233);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block}:host .bg{position:relative;flex:none;display:flex;flex-direction:column;justify-content:center;align-items:center;border-radius:50%;overflow:hidden;background:var(--avatar-bg,#7b7e80);color:var(--avatar-color,#fff)}:host .bg .image{position:absolute;top:0;left:0;border-radius:50%}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(0),c=i(4),l=i(9);class d extends s.CTLayerComponent{static get is(){return"ct-user-display"}initialize(){return o(this,void 0,void 0,function*(){this._update()})}setupListeners(){this.addListeners([r.BaseEvents.ConnectionStatusChange,r.BaseEvents.CurrentUserVCardUpdate],()=>{this._update()})}get generateComponentStyles(){return i(235)}generateComponentMarkup(){switch(this.type){case"simple":return this._renderSimple();case"full":return this._renderFull()}return null}_renderSimple(){return this.displayName?window.__CTRender("div",{class:"user-display"},this.showIcon&&window.__CTRender("div",{class:"icon"},window.__CTRender(c.CTIcon,{width:"16",height:"16",icon:a.Icons.COMMON.UserIconEmpty})),window.__CTRender("div",{class:"label"},this.displayName)):null}_renderFull(){return this.user?window.__CTRender("div",{class:"user-display"},window.__CTRender(c.CTUserTile,{user:this.user,showAvatar:this.showIcon,detailStyle:l.buildStyles({flexDirection:"column",overflow:"hidden",width:"100%"})})):null}_update(){switch(this.type){case"simple":this.displayName=this.layer.getCurrentXmppDisplayName(),this.user=null;break;case"full":this.displayName=null,this.user=this.layer.getCurrentUser()}}}n([s.prop({type:String,attribute:!0,default:"simple"})],d.prototype,"type",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],d.prototype,"showIcon",void 0),n([s.prop({type:String,attribute:!1,default:null})],d.prototype,"displayName",void 0),n([s.prop({type:Object,attribute:!1,default:null})],d.prototype,"user",void 0),e.CTUserDisplay=d,d.register()},function(t,e,i){var n=i(236);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:inline-flex;font-size:inherit;font-weight:inherit;color:inherit}:host .user-display{display:flex;align-items:center;width:100%}:host .user-display .icon{flex:none;margin:0 5px 0 0}:host .user-display .label{flex:1 1}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(12),a=i(0),c=i(4),l=i(38),d=i(64),h=i(9),u=i(2),p=i(37),g=i(63);var m;!function(t){t[t.SEARCH_PLACEHOLDER="Find Users"]="SEARCH_PLACEHOLDER",t[t.INITIAL_MESSAGE="Find users by searching for first name or last name"]="INITIAL_MESSAGE",t[t.NO_MATCHES="No users match your search"]="NO_MATCHES",t[t.SEARCH_BY="Search By:"]="SEARCH_BY",t[t.SEARCH_BY_ALL="All"]="SEARCH_BY_ALL",t[t.SEARCH_BY_NAME="Name"]="SEARCH_BY_NAME",t[t.SEARCH_BY_JOB_TITLE="Job Title"]="SEARCH_BY_JOB_TITLE",t[t.SEARCH_BY_ROLE="Role"]="SEARCH_BY_ROLE",t[t.UNABLE_TO_ADD_USERS="Unable to add users"]="UNABLE_TO_ADD_USERS",t[t.MAX_USERS_REACHED_ROLE="It was not possible to add this role to the conversation as it would exceed the maximum number of users allowed"]="MAX_USERS_REACHED_ROLE"}(m||(m={}));class f{static _create(){return new r.Metadata(_,m)}static get instance(){return this._instance||(this._instance=this._create())}}f._instance=null,e.CTUserListMetadata=f;class _ extends s.CTLayerComponent{constructor(){super(),this.TILE_HEIGHT=70,this._onSearchChange=((t,e)=>{const i=!e||0===e.trim().length,n=i?0:250;this.isFetching=!i,this.debounce("search",()=>{this._searchContacts((t||"").toLowerCase(),e)},n)}),this.setMetadata(f.instance),this._onWindowResize=this._onWindowResize.bind(this),window.addEventListener("resize",this._onWindowResize,!0)}static get is(){return"ct-user-list"}initialize(){return o(this,void 0,void 0,function*(){this.rolesOnly?this._virtualList=new d.VirtualList(this,[],{itemHeight:this.TILE_HEIGHT,itemKeyGetter:t=>t.name}):this._virtualList=new d.VirtualList(this,[],{itemHeight:this.TILE_HEIGHT,itemKeyGetter:t=>t.jid}),this.allowSearch&&this.requireSearch?(this.isFetching=!1,this.searchTerm=""):(this.isFetching=!0,this.defer(()=>o(this,void 0,void 0,function*(){yield this._searchContacts("","")})))})}setupListeners(){}disconnectedCallback(){window.removeEventListener("resize",this._onWindowResize)}get generateComponentStyles(){return i(238)}generateComponentMarkup(){const t=[this.translateI18nItem(m.SEARCH_BY_NAME),this.translateI18nItem(m.SEARCH_BY_JOB_TITLE)];return this.layer.config.roles.enableRoles&&t.push(this.layer.config.roles.rolesLabel||this.translateI18nItem(m.SEARCH_BY_ROLE)),window.__CTRender("div",{class:"user-list"},this.allowSearch&&window.__CTRender("div",{class:"search"},window.__CTRender(l.CTSelectionTextFilter,{placeholder:this.searchPlaceholder||this.translateI18nItem(m.SEARCH_PLACEHOLDER),selectionItems:t,onSearch:this._onSearchChange})),this.allowSelection&&this._renderSelections(),this.isFetching&&window.__CTRender("div",{class:"fetching"},window.__CTRender(c.CTIcon,{width:"16",height:"16",icon:a.Icons.COMMON.LoadingSpinner,spin:!0})),!this.isFetching&&window.__CTRender("div",{class:"user-list-items"},this._users&&this._users.length>1&&window.__CTRender("div",{class:"fetching users-loading-bg"},window.__CTRender(c.CTIcon,{width:"16",height:"16",icon:a.Icons.COMMON.LoadingSpinner,spin:!0})),this._renderUsers()))}_renderSelections(){const t=["selected-users"];return this.selections.size>0&&t.push("has-selections"),window.__CTRender("div",{class:t.join(" ")},this.selections.size>0&&window.__CTRender("div",{class:"scroller"},[...this.selections.values()].map(t=>window.__CTRender("div",{class:"selected-user"},h.renderIf(void 0!==t.jid,window.__CTRender("div",{class:"avatar"},window.__CTRender(c.CTUserAvatar,{user:t,size:32}),window.__CTRender("div",{class:"remove",onClick:e=>this._removeUserSelection(t,e)},window.__CTRender(c.CTIcon,{class:"icon",width:"6",height:"6",icon:a.Icons.COMMON.Cross})))),h.renderIf(void 0!==t.name,window.__CTRender("div",{class:"avatar"},window.__CTRender(p.CTGroupAvatar,{size:32}),window.__CTRender("div",{class:"remove",onClick:e=>this._removeUserSelection(t,e)},window.__CTRender(c.CTIcon,{class:"icon",width:"6",height:"6",icon:a.Icons.COMMON.Cross})))),h.renderIf(void 0!==t.jid,window.__CTRender("div",{class:"name"},u.formatUserName(t,this.selectedUsersNameFormat))),h.renderIf(void 0!==t.name,window.__CTRender("div",{class:"name"},t.name))))))}_renderUsers(){const t=!this.searchTerm||0===this.searchTerm.trim().length;return this.allowSearch&&this.requireSearch&&t?window.__CTRender("div",{class:"initial-message"},this.initialMessage||this.translateI18nItem(m.INITIAL_MESSAGE)):0===this._users.length?window.__CTRender("div",{class:"no-users"},this.noMatchesMessage||this.translateI18nItem(m.NO_MATCHES)):this._virtualList.render(this._renderItem.bind(this),"users","users-content")}_renderItem(t,e){const i=this._userSelected(t),n=["user"],o=this._maxUsersReached();this.allowSelection&&i&&n.push("selected"),!i&&o&&n.push("selection-disabled"),"function"==typeof this.onClickUser&&n.push("clickable");const s=e=>{e.stopPropagation(),this.allowSelection&&(!i&&o||this._toggleUserSelection(t,e))},r=h.buildStyles({paddingRight:"36px"});return t.name?window.__CTRender("div",Object.assign({class:n.join(" ")},e,{onClick:e=>this._onClickItem(t,e)}),window.__CTRender(g.CTGroupTile,{group:t,height:`${this.TILE_HEIGHT}px`,detailStyle:r},this.allowSelection&&window.__CTRender("div",{slot:"additional",class:"selection",onClick:s.bind(this)},window.__CTRender("div",{class:"checkbox"},i&&window.__CTRender(c.CTIcon,{width:"12",height:"12",icon:a.Icons.COMMON.Tick}))))):window.__CTRender("div",Object.assign({class:n.join(" ")},e,{onClick:e=>this._onClickItem(t,e)}),window.__CTRender(c.CTUserTile,{user:t,nameFormat:this.nameFormat,height:`${this.TILE_HEIGHT}px`,detailStyle:r},this.allowSelection&&window.__CTRender("div",{slot:"additional",class:"selection",onClick:s.bind(this)},window.__CTRender("div",{class:"checkbox"},i&&window.__CTRender(c.CTIcon,{width:"12",height:"12",icon:a.Icons.COMMON.Tick})))))}_onWindowResize(){this.debounce("resize",()=>{this.forceRecalcList()})}forceRecalcList(){this._virtualList.forceRecalc()}_onClickItem(t,e){e.stopPropagation(),t.users?"function"==typeof this.onClickGroup&&this.onClickGroup(t):"function"==typeof this.onClickUser&&this.onClickUser(t)}_toggleUserSelection(t,e){return o(this,void 0,void 0,function*(){e.stopPropagation(),this.allowSelection&&(this._userSelected(t)?yield this._removeUserSelection(t,e):yield this._addUserSelection(t,e))})}_addUserSelection(t,e){return o(this,void 0,void 0,function*(){if(e.stopPropagation(),t.jid)this.selections.set(t.jid,t);else{if(this._maxUsersWillBeReached(t.users.length))return;this.selections.set(t.name,t)}this.onRenderComplete(()=>{const t=this.shadowRoot.querySelector(".selected-users");t.scrollLeft=t.firstChild.clientWidth},!0),"function"==typeof this.onChangeSelection&&this.onChangeSelection(yield this.getSelections()),this.forceRedraw()})}_removeUserSelection(t,e){return o(this,void 0,void 0,function*(){e.stopPropagation(),t.jid?this.selections.delete(t.jid):this.selections.delete(t.name),"function"==typeof this.onChangeSelection&&this.onChangeSelection(yield this.getSelections()),this.forceRedraw()})}getSelections(){return o(this,void 0,void 0,function*(){return this.allowSelection?u.deepCloneArray([...this.selections.values()]):[]})}clearSelections(){return o(this,void 0,void 0,function*(){this.allowSelection&&(this.selections.clear(),"function"==typeof this.onChangeSelection&&this.onChangeSelection(yield this.getSelections()),this.forceRedraw(),yield u.sleep(0))})}reset(){return o(this,void 0,void 0,function*(){yield this.clearSelections()})}_searchContacts(t,e){return o(this,void 0,void 0,function*(){this.rolesOnly=!1;const i=!e||0===e.trim().length,n=(this.layer.config.roles.rolesLabel||this.translateI18nItem(m.SEARCH_BY_ROLE)).toLowerCase();if(i&&this.requireSearch)this.searchTerm="",this._updateUserList([]),this.isFetching=!1;else{const i=[];switch(t){case"name":i.push("firstName"),i.push("lastName");break;case"job title":i.push("jobTitle");break;case n:i.push("group"),this.rolesOnly=!0}const o=yield this.layer.searchUsers(e,i),s=(this.excludeUsers||[]).map(t=>t.toLowerCase()),r=s.length?o.filter(t=>!s.includes(t.jid.toLowerCase())):o;this.searchTerm=e,this._updateUserList(r),this.isFetching=!1}})}_userSelected(t){return t.name?this.selections.has(t.name):this.selections.has(t.jid)}_maxUsersWillBeReached(t){return!(!this.maxSelections&&0!==this.maxSelections)&&this._totalSelectedUserCount()+t>this.maxSelections}_totalSelectedUserCount(){const t=new Map;for(const e of this.selections.values())e.jid?t.set(e.jid,e):e.users.map(e=>t.set(e.jid,e));return t.size}_maxUsersReached(){return!(!this.maxSelections&&0!==this.maxSelections)&&this._totalSelectedUserCount()>=this.maxSelections}_updateUserList(t){return o(this,void 0,void 0,function*(){if(this._users=t,this.rolesOnly){const e=[];for(const i of t)i.group.split(", ").filter(t=>t.toLowerCase().includes(this.searchTerm.toLowerCase().trim())).forEach(t=>{let n=e.find(e=>e.name===t);null==n&&(n={name:t,users:[]},e.push(n)),n.users.push(i)});this._virtualList.setItems(e)}else this._virtualList.setItems(this._users)})}}n([s.prop({type:Object,attribute:!1,default:u.NameFormat.PREFIX_FIRST_LAST})],_.prototype,"nameFormat",void 0),n([s.prop({type:Array,attribute:!1,default:null})],_.prototype,"excludeUsers",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],_.prototype,"allowSearch",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],_.prototype,"requireSearch",void 0),n([s.prop({type:String,attribute:!1,default:null})],_.prototype,"searchPlaceholder",void 0),n([s.prop({type:String,attribute:!1,default:null})],_.prototype,"initialMessage",void 0),n([s.prop({type:String,attribute:!1,default:null})],_.prototype,"noMatchesMessage",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],_.prototype,"allowSelection",void 0),n([s.prop({type:Object,attribute:!1,default:u.NameFormat.PREFIX_INITIAL_LAST})],_.prototype,"selectedUsersNameFormat",void 0),n([s.prop({type:s.NullableNumber,attribute:!1,default:null})],_.prototype,"maxSelections",void 0),n([s.prop({type:Function,attribute:!1,default:null})],_.prototype,"onClickUser",void 0),n([s.prop({type:Function,attribute:!1,default:null})],_.prototype,"onClickGroup",void 0),n([s.prop({type:Function,attribute:!1,default:null})],_.prototype,"onChangeSelection",void 0),n([s.prop({type:Object,attribute:!1,default:new Map})],_.prototype,"selections",void 0),n([s.prop({type:String,attribute:!1,default:""})],_.prototype,"searchTerm",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],_.prototype,"isFetching",void 0),n([s.prop({type:s.Stroolean,attribute:!1,default:!1})],_.prototype,"rolesOnly",void 0),e.CTUserList=_,_.register()},function(t,e,i){var n=i(239);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{flex-direction:column}:host,:host .user-list{display:flex;height:100%}:host .user-list{position:relative;flex-direction:column;flex:1 1 auto}:host .user-list .search{flex:0 0 55px;display:flex;padding:0 20px;justify-content:center;align-items:center;background:var(--secondary-color,#2c394e);border-bottom:var(--secondary-border,1px solid #ddd)}:host .user-list .search .search-box{width:75%;font-size:14px}:host .user-list .search .fields{margin-top:10px}:host .user-list .search input[type=radio]{display:none}:host .user-list .search input[type=radio]:checked+span{font-weight:700;color:var(--primary-color,#15233b)}:host .user-list .search label{border-right:1px solid #e1e1e1;padding:0 10px;color:#999;font-size:14px}:host .user-list .search label:first-child{color:#ccc}:host .user-list .search label:first-child,:host .user-list .search label:last-child{border-right:none}:host .user-list .selected-users{flex:none;display:flex;align-items:center;height:0;background-color:var(--list-item-bg,#fff);overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;transition:height var(--animation-normal,.5s) ease-out}:host .user-list .selected-users .scroller{display:inline-flex}:host .user-list .selected-users .scroller .selected-user{display:inline-flex;flex-direction:column;justify-content:center;align-items:center;text-overflow:ellipsis;width:75px;margin:10px 0 0}:host .user-list .selected-users .scroller .selected-user .avatar{position:relative;margin:0 0 5px}:host .user-list .selected-users .scroller .selected-user .avatar .remove{position:absolute;display:flex;flex-direction:column;justify-content:center;align-items:center;top:-5px;right:-5px;width:16px;height:16px;border-radius:50%;background:var(--primary-color,#15233b);border:2px solid var(--avatar-color,#fff);color:var(--primary-font-color,#fff);cursor:pointer}:host .user-list .selected-users .scroller .selected-user .name{font-size:14px;color:var(--default-font-color);overflow:hidden;text-overflow:ellipsis;width:100%;height:20px;line-height:.9em;text-align:center;white-space:nowrap}:host .user-list .selected-users.has-selections{height:70px;border-bottom:var(--list-item-border,1px solid #ddd)}:host .user-list .user-list-items{position:relative;display:flex;flex-direction:column;flex:1 1 auto;height:100%;overflow:hidden}:host .user-list .user-list-items .users-loading-bg{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;background:var(--list-bg,#2c394e);z-index:-1}:host .user-list .user-list-items .users{flex:1 1 auto;overflow:auto;-webkit-overflow-scrolling:touch}:host .user-list .user-list-items .users .user{position:relative}:host .user-list .user-list-items .users .user .selection{position:absolute;top:0;right:0;height:100%;display:flex;justify-content:center;align-items:center;padding:0 20px;cursor:pointer}:host .user-list .user-list-items .users .user .selection .checkbox{display:flex;justify-content:center;align-items:center;width:16px;height:16px;color:var(--subtle-font-color,#828688);border:2px solid var(--subtle-font-color,#828688)}:host .user-list .user-list-items .users .user.selected .selection .checkbox{border:0}:host .user-list .user-list-items .users .user.selection-disabled .selection{opacity:0;cursor:not-allowed}:host .user-list .user-list-items .users .user.clickable{cursor:pointer}:host .user-list .fetching,:host .user-list .initial-message,:host .user-list .no-users{flex:1;display:flex;justify-content:center;align-items:flex-start;height:100%;text-align:center;padding:55px;background:var(--list-bg,#2c394e);color:var(--subtle-font-color,#828688)}:host .user-list .initial-message{align-items:center;font-size:18px}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(4),a=i(2);class c extends s.CTLayerComponent{static get is(){return"ct-user-tile"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}get generateComponentStyles(){return i(241)}generateComponentMarkup(){if(!this.user)return;const t=["group"];this.user.group||t.push("empty");const e=["job-title"];return this.user.jobTitle||e.push("empty"),window.__CTRender(r.CTAvatarTile,{height:this.height,showAvatar:this.showAvatar,detailStyle:this.detailStyle},this.showAvatar&&window.__CTRender(r.CTUserAvatar,{slot:"avatar",size:40,user:this.user}),window.__CTRender("div",{class:"name"},a.formatUserName(this.user,this.nameFormat)),window.__CTRender("div",{class:e.join(" ")},this.user.jobTitle||"No Job Title"),this.layer.config.roles.enableRoles&&window.__CTRender("div",{class:t.join(" ")},this.user.group||`No ${this.layer.config.roles.rolesLabel||"Role"}`),window.__CTRender("slot",{name:"additional"}))}}n([s.prop({type:s.Stroolean,attribute:!1,default:!0})],c.prototype,"showAvatar",void 0),n([s.prop({type:Object,attribute:!1})],c.prototype,"user",void 0),n([s.prop({type:Object,attribute:!1,default:a.NameFormat.PREFIX_FIRST_LAST})],c.prototype,"nameFormat",void 0),n([s.prop({type:String,attribute:!1,default:null})],c.prototype,"height",void 0),n([s.prop({type:Object,attribute:!1,default:{}})],c.prototype,"detailStyle",void 0),e.CTUserTile=c,c.register()},function(t,e,i){var n=i(242);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{width:100%}:host .name{flex:1 1 auto;font-size:18px;color:var(--default-font-color,#212121);white-space:pre-line;overflow:hidden;text-overflow:ellipsis}:host .group,:host .job-title{color:var(--subtle-font-color,#828688);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}:host .group{font-style:italic}:host .empty{color:#e1e1e1}",""])},function(t,e,i){var n=i(244);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block;font-size:1em}:host .header{position:relative;display:flex;align-items:center;height:var(--header-height,75px);padding:0 20px;background:var(--header-bg,#22b1c8);color:var(--header-text,#fff)}:host .header .left-action{flex:0 0 20px}:host .header .details{flex:1 1 auto;position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;text-align:center;transition:padding .3s ease-out;overflow:hidden}:host .header .details .heading{font-size:1.5em}:host .header .details .sub-heading{font-weight:100}:host .header .details .status{position:absolute;bottom:0;left:50%;transform:translate(-50%,100%);display:flex;justify-content:center;align-items:center;font-size:.833em;padding:3px 10px;border:1px solid hsla(0,0%,100%,.5);border-bottom:0;border-radius:10px 10px 0 0;will-change:transform;transition:transform .3s ease-out}:host .header .details .status .icon{margin:0 0 0 5px}:host .header .right-action{flex:0 0 20px}:host .header.offline .details{padding:0 0 20px}:host .header.offline .details .status{transform:translate(-50%);cursor:pointer}:host .header.offline .details .status:hover{background:hsla(0,0%,100%,.1)}:host .header.connecting .details .status,:host .header.disconnecting .details .status{opacity:.5;cursor:default}",""])},function(t,e,i){var n=i(246);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block;height:100%;font-size:1em}:host .contact-list{flex:1 1 auto;display:flex;flex-direction:column;height:100%}:host .contact-list .header .action{cursor:pointer}:host .contact-list .user-list{flex:1 1 auto;display:flex;flex-direction:column;overflow:auto}:host .contact-list .user-list #user-list{display:flex;flex-direction:column;flex:1}:host .contact-list .footer{flex:0 0 auto;background:var(--secondary-color,#f2f2f2);border-top:var(--secondary-border,1px solid #ddd);display:flex;padding:10px 20px}:host .contact-list .footer .button{flex:1 1;margin:0 5px}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(26),a=i(12),c=i(0),l=i(13),d=i(10),h=i(21),u=i(248),p=i(65),g=i(259),m=i(15),f=i(27),_=i(5),v=i(6),y=i(4),C=i(20),b=i(29),w=i(9),T=i(2),E=i(262),S={once:!0};var R;!function(t){t[t.DIRECT_CONVERSATION="Direct Conversation"]="DIRECT_CONVERSATION",t[t.NAMED_CONVERSATION="Named Conversation"]="NAMED_CONVERSATION",t[t.SELF_CONVERSATION="Conversation with self"]="SELF_CONVERSATION",t[t.CONTACTS_IN_CONVERSATION="{{number}} contact(s) in this conversation"]="CONTACTS_IN_CONVERSATION",t[t.INFO="Info"]="INFO",t[t.EDIT_INFO="Edit Info"]="EDIT_INFO",t[t.LEAVE="Leave"]="LEAVE",t[t.COMFIRM_LEAVE="Are you sure you wish to leave this conversation?"]="COMFIRM_LEAVE",t[t.END="End"]="END",t[t.COMFIRM_END="Are you sure you wish to end this conversation?"]="COMFIRM_END",t[t.DELETE="Delete"]="DELETE",t[t.DELETE_CONFIRM="Are you sure you wish to delete this conversation? This will remove all messages from your device."]="DELETE_CONFIRM",t[t.RESPONSES="View Responses"]="RESPONSES",t[t.PROVISIONAL_MESSAGE="This conversation will be created when you send your first message"]="PROVISIONAL_MESSAGE",t[t.SCROLL_TO_TOP_FOR_MORE="Scroll to top to fetch more"]="SCROLL_TO_TOP_FOR_MORE",t[t.AT_START="At start of conversation"]="AT_START",t[t.LOADING_IMAGE="loading image..."]="LOADING_IMAGE",t[t.IMAGE_REFETCH="Download image"]="IMAGE_REFETCH",t[t.IMAGE_ERROR="Image unable to download, press to retry"]="IMAGE_ERROR",t[t.MESSAGE_PLACEHOLDER="Message"]="MESSAGE_PLACEHOLDER",t[t.CONFIRM_REPLACE_IMAGE="You have already selected an image to attach. Do you want to replace this with a different image?"]="CONFIRM_REPLACE_IMAGE",t[t.SEND_ERROR="Unable to send message"]="SEND_ERROR",t[t.FETCH_ERROR_NOT_ONLINE="Unable to fetch messages whilst offline"]="FETCH_ERROR_NOT_ONLINE"}(R||(R={}));class A{static _create(){return new a.Metadata(I,R)}static get instance(){return this._instance||(this._instance=this._create())}}A._instance=null,e.CTCLChatMessageListMetadata=A;class I extends l.CTCLComponent{constructor(){super(),this._isInitialising=!1,this._chatListScrollable=null,this._chatListFetchMore=null,this._chatScrollToBottom=null,this._messageTextbox=null,this._isInitialFetch=!0,this._rawChatEntries=[],this._processedChatEntries=[],this._batchSize=null,this._visibleChatEntryBlockSize=null,this._startIdx=null,this._endIdx=null,this._supportsOverscroll=!1,this._suppressScrollHandler=!1,this._newNotificationsCount=0,this._draft=null,this._saveDraftTimeout=null,this._pendingConversationId=null,this._pendingDraft=null,this._maxMessageLength=null,this._description=null,this._priorityDescriptionExpanded=!0,this._deferredEvents=[],this._onForeground=(()=>{this.isOnline&&this.visibleChatEntries.forEach(t=>this.layer.markChatEntryRead(t)),document.removeEventListener("pause",this._onBackground),document.addEventListener("pause",this._onBackground,S)}),this._onBackground=(()=>{document.removeEventListener("resume",this._onForeground),document.addEventListener("resume",this._onForeground,S)}),this._onScroll=(()=>{if(this._suppressScrollHandler)return;const t=this._chatListScrollable.scrollTop,e=this._chatListScrollable.scrollHeight-this._chatListScrollable.clientHeight;t<=0?(this._suppressScrollHandler=!0,this._stopScroll(0).then(()=>this._handleScrollAtTop())):Math.ceil(t)>=e&&(this._suppressScrollHandler=!0,this._stopScroll(e).then(()=>this._handleScrollAtBottom()))}),this._viewInfo=(()=>o(this,void 0,void 0,function*(){yield this._saveDraft();const t=this.conversation.type===v.ConversationType.Direct;if(t&&1===this.conversation.participants.length){const t=this.layer.getCurrentUser();this.layer.showContactInfo(t,this.conversation,!1)}else if(t&&2===this.conversation.participants.length){const t=this.layer.getCurrentUserJid(),e=this.conversation.participants.find(e=>!T.jidsMatch(e.jid,t)),i=this._userLookup.get(e.jid);this.layer.showContactInfo(i,this.conversation,!1)}else this.emitComponentEvent("go-info")})),this._deleteDirect=(()=>o(this,void 0,void 0,function*(){if(yield this.requestConfirmation(this.translateI18nItem(R.DELETE_CONFIRM))){const t=this._rawChatEntries[this._rawChatEntries.length-1];yield this.layer.markDirectConversationAsDeleted(this.conversation,t?t.date:0)}})),this._openResponses=(()=>o(this,void 0,void 0,function*(){yield this.layer.showResponsesModal(this.conversation)})),this.setMetadata(A.instance)}static get is(){return"ct-cl-chat-message-list"}initialize(t){const e=Object.create(null,{initialize:{get:()=>super.initialize}});return o(this,void 0,void 0,function*(){return yield e.initialize.call(this,t),this._isInitialising=!0,this._userLookup=new f.UserLookup(this.layer),this._batchSize=this.layer.config.behaviour&&this.layer.config.behaviour.chatEntriesFetchBatchSize||null,this._visibleChatEntryBlockSize=this._batchSize||10,this._maxMessageLength=this.layer.config.behaviour&&this.layer.config.behaviour.maxMessageLength||5e3,this._detectOverscrollSupport(),this.conversation=yield this.layer.getCurrentConversation(),this.conversation?this.conversation.isClosed?this._back():(this._config=new m.ConversationConfigReader(this.layer,this.conversation),this._draft=this.conversation.draft||null,this._updateSendButton(),this.onRenderComplete(()=>this._getDomNodes()),this.onRenderComplete(()=>this._multilineEllipsis(!1)),this.onRenderComplete(()=>this._setupScrollWatcher(),!0),this.onRenderComplete(()=>this._calcLongDescription(),!0),this.isFetchingMore=!0,this.defer(()=>o(this,void 0,void 0,function*(){yield this._refreshUserLookup(),this.forceRedraw(),this.defer(()=>o(this,void 0,void 0,function*(){this.layer.isConversationBeingPurged(this.conversation.id)||(yield this._fetchMoreChatEntries(!0)),this.defer(()=>{this._isInitialising=!1,this._deferredEvents.forEach(t=>this.emitEvent(t.eventType,t.data))})}))})),this._autoFocusMessageTextboxOnDesktop(),void this.layer.setBackHandler(()=>{this._back()})):this._back()})}setupListeners(){this.addListener(_.ChatEvents.ConversationPurged,t=>o(this,void 0,void 0,function*(){t.conversation.id===this.conversation.id&&this._fetchMoreChatEntries()})),this.addListener(_.ChatEvents.AutoReconnected,({resumed:t})=>o(this,void 0,void 0,function*(){if(this._isInitialising)return void this._deferredEvents.push({eventType:_.ChatEvents.AutoReconnected,data:{resumed:t}});this._isInitialising=!0,yield this._resetForConversationChange(),yield this._fetchMoreChatEntries(!0),this._suppressScrollHandler=!1;const e=yield this.layer.getCurrentConversation();e&&e.id===this.conversation.id&&(this.conversation.preview=this._processedChatEntries[this._processedChatEntries.length-1],this.conversation.hasUnread=!1,yield this.layer.updateConversation(this.conversation)),this.isOnline&&this.visibleChatEntries.forEach(t=>this.layer.markChatEntryRead(t)),this._removeDeferredEvent(_.ChatEvents.AutoReconnected),this.defer(()=>{this._isInitialising=!1,this._deferredEvents.forEach(t=>this.emitEvent(t.eventType,t.data))})}),{dontSuppress:!0}),this.setupConnectionStatusListener(),this.addListener(_.ChatEvents.ConversationAdded,t=>o(this,void 0,void 0,function*(){if(this._pendingConversationId&&this._pendingConversationId===t.conversation.id){const e=T.deepCloneObject(t.conversation);this._draft=this._pendingDraft,this._pendingDraft=null,yield this.layer.setCurrentConversation(e)}})),this.addListener(_.ChatEvents.ConversationParticipantsChanged,t=>o(this,void 0,void 0,function*(){this.conversation&&this.conversation.id===t.conversation.id&&(this.conversation.participants=t.participants,yield this._refreshUserLookup(),this.forceRedraw())})),this.addListener(_.ChatEvents.ChatEntryReceived,t=>o(this,void 0,void 0,function*(){if(this._isInitialising)this._deferredEvents.push({eventType:_.ChatEvents.ChatEntryReceived,data:t});else{if(yield this.layer.belongsToCurrentConversation(t.chatEntry)){yield this._appendChatEntry(t.chatEntry),this.conversation=yield this.layer.getCurrentConversation(),this.conversation.hasUnread=!1;const e={};t.chatEntry.date>this.conversation.preview.date&&(this.conversation.preview=t.chatEntry,e.preview=t.chatEntry),yield this.layer.updateConversation(this.conversation,e),this._calcLongDescription(),this.isOnline&&(yield this.layer.markChatEntryRead(t.chatEntry))}this._removeDeferredEvent(_.ChatEvents.ChatEntryReceived)}})),this.addListener(_.ChatEvents.ChatEntryUpdated,t=>o(this,void 0,void 0,function*(){this._isInitialising?this._deferredEvents.push({eventType:_.ChatEvents.ChatEntryUpdated,data:t}):(yield this.layer.belongsToCurrentConversation(t.chatEntry))&&t.chatEntry.type===c.ChatEntryType.Chat&&(setTimeout(()=>{this._updateChatEntry(t.chatEntry)},1e3),this._removeDeferredEvent(_.ChatEvents.ChatEntryUpdated))})),this.addListener(_.ChatEvents.CurrentConversationChanged,()=>o(this,void 0,void 0,function*(){this._resetForConversationChange(),this.conversation=yield this.layer.getCurrentConversation(),this.conversation&&(yield this._refreshUserLookup(),this.isFetchingMore=!0,this.defer(()=>o(this,void 0,void 0,function*(){yield this._fetchMoreChatEntries(),this._pendingConversationId&&this._pendingConversationId===this.conversation.id&&(this._pendingConversationId=null,(this._draft||this.media&&this.media.length)&&(this.sending=!1,this._sendMessage()))})))})),this.addListener(_.ChatEvents.ConversationDeleted,()=>{this._clearDraft(),this.emitComponentEvent("go-end")}),this.addListener(_.ChatEvents.ThumbnailLoaded,t=>{const e=this._processedChatEntries.findIndex(e=>e.id===t.id);e>-1&&this._processedChatEntries.length-e<5&&setTimeout(()=>this._scrollToBottom(!1),500)}),document.removeEventListener("pause",this._onBackground),document.addEventListener("pause",this._onBackground,S)}_removeDeferredEvent(t){const e=this._deferredEvents.findIndex(e=>e.eventType===t);e>-1&&this._deferredEvents.splice(e,1)}disconnectedCallback(){super.disconnectedCallback(),this._removeMedia(!0)}get generateComponentStyles(){return i(263)}generateComponentMarkup(){const t=this.conversation.participants.find(t=>T.jidsMatch(t.jid,this.layer.getCurrentUserJid()));return![c.ChatRole.Owner].includes(t.role)&&this._config.usePagerUI?window.__CTRender("div",{class:"chat-message-list"},this._renderHeader(),this._renderPagerUI()):window.__CTRender("div",{class:"chat-message-list"},this._renderHeader(),window.__CTRender("div",{class:"chat-message-list desktop"},(this.conversation.attachments&&this.conversation.attachments.length||this.conversation.description)&&this._renderPriorityDescription(),this._config.chatAvailable?this._renderChatEntries():window.__CTRender(g.CTCLResponseView,{conversation:this.conversation})),this._config.chatAvailable&&this._renderScrollToBottom(),this._renderFooter())}_renderHeader(){let t="",e=this._config.descriptionAtTop;if(this._config.namedSettings)t=this.conversation.subject||this._config.name;else if(1===this.conversation.participants.length){const i=this.layer.getCurrentUser();t=T.formatUserName(i,T.NameFormat.PREFIX_FIRST_LAST),e=this.translateI18nItem(R.SELF_CONVERSATION)}else if(2===this.conversation.participants.length){const i=this.layer.getCurrentUserJid(),n=this.conversation.participants.find(t=>!T.jidsMatch(t.jid,i)),o=this._userLookup.get(n.jid);t=T.formatUserName(o,T.NameFormat.PREFIX_FIRST_LAST)||" ",e=this.translateI18nItem(R.DIRECT_CONVERSATION)}else this.conversation.participants.length>2&&(t=this.translateI18nItem(R.DIRECT_CONVERSATION),e=this.translateI18nItem(R.CONTACTS_IN_CONVERSATION).replace("{{number}}",(this.conversation.participants.length-1).toString()));const i=this.conversation.isProvisional||this.conversation.hideBefore?c.Icons.COMMON.CircleCross:c.Icons.COMMON.ChevronLeft;return window.__CTRender(h.CTCLHeader,{class:"header",backgroundColor:this._config.colorCode},window.__CTRender("div",{slot:"left-action"},window.__CTRender(y.CTIcon,{class:"action",width:"20",height:"20",icon:i,onClick:this._back.bind(this)})),window.__CTRender("div",{slot:"heading"},t),window.__CTRender("div",{slot:"sub-heading"},e),window.__CTRender("div",{slot:"right-action"},this._renderRightAction()))}_renderRightAction(){return this.conversation.type===v.ConversationType.Direct?this._renderInfo():this._renderMenu()}_renderInfo(){if(1===this.conversation.participants.length)return null;const t=[new y.MenuItem(this.translateI18nItem(R.INFO),this._viewInfo)];return this.conversation.hideBefore?window.__CTRender(y.CTMenu,{menuItems:t}):(this.conversation.isProvisional&&0!==this.conversation.hideBefore||!this._config.participantCanDelete||t.push(new y.MenuItem(this.translateI18nItem(R.DELETE),this._deleteDirect)),t.length>0?window.__CTRender(y.CTMenu,{menuItems:t}):null)}_renderMenu(){const t=this.layer.getCurrentUserJid(),e=this.conversation.participants.find(e=>T.jidsMatch(e.jid,t));if(!e)return null;const i=[c.ChatRole.Owner].includes(e.role)&&this._config.ownerCanEditAfterSend,n=this._config.participantCanLeave,o=[c.ChatRole.Owner].includes(e.role)&&this._config.ownerCanCloseEarly,s=[];return i?s.push(new y.MenuItem(this.translateI18nItem(R.EDIT_INFO),this._editInfo.bind(this))):s.push(new y.MenuItem(this.translateI18nItem(R.INFO),this._viewInfo)),this._config.alert&&[c.ChatRole.Owner].includes(e.role)&&this._config.chatAvailable&&s.push(new y.MenuItem(this.translateI18nItem(R.RESPONSES),this._openResponses,!1)),n&&s.push(new y.MenuItem(this.translateI18nItem(R.LEAVE),this._leave.bind(this),!this.isOnline)),o&&s.push(new y.MenuItem(this.translateI18nItem(R.END),this._end.bind(this),!this.isOnline)),s.length>0?window.__CTRender(y.CTMenu,{menuItems:s}):null}_renderChatEntries(){const t=this._processedChatEntries[this._processedChatEntries.length-1],e=t&&t.id||"";return window.__CTRender("div",{id:"chat-history",class:"chat-history"},this.conversation.isProvisional&&this._renderProvisionalMessage(),!this.conversation.isProvisional&&this.mightHaveMore&&this._renderFetchMore(),!this.conversation.isProvisional&&this.visibleChatEntries.map(t=>{const i=t.id===e;return this._renderEntry(t,i)}))}_renderFetchMore(){const t=["fetch-more"];return this.isFetchingMore&&t.push("fetching"),this.noMoreToFetch&&t.push("no-more"),window.__CTRender("div",{id:"fetch-more",key:"fetch-more",class:t.join(" ")},!!this.fetchError&&window.__CTRender("div",{class:"error"},window.__CTRender(y.CTIcon,{class:"icon",width:"16",height:"16",icon:c.Icons.COMMON.AlertWarning}),this.fetchError),!this.fetchError&&!this.noMoreToFetch&&!this.isFetchingMore&&this.translateI18nItem(R.SCROLL_TO_TOP_FOR_MORE),this.isFetchingMore&&window.__CTRender(y.CTIcon,{width:"16",height:"16",icon:c.Icons.COMMON.LoadingSpinner,spin:!0}),this.noMoreToFetch&&this.translateI18nItem(R.AT_START))}_renderProvisionalMessage(){return window.__CTRender("div",{class:"entry meta"},window.__CTRender("div",{class:"bubble"},this.translateI18nItem(R.PROVISIONAL_MESSAGE)))}_renderEntry(t,e){const i=["entry",t.type.toString()];t.type===c.ChatEntryType.Chat&&i.push(t.mine?"sent":"received");const n=this._generateDomIdFromEntryId(t.id);return window.__CTRender("div",{id:n,key:t.id,class:i.join(" ")},t.type===c.ChatEntryType.Meta&&this._renderMetaMessage(t),t.type===c.ChatEntryType.Chat&&this._renderChatMessage(t,e),t.type===c.ChatEntryType.Divider&&this._renderDivider(t))}_renderDivider(t){return window.__CTRender("span",null,T.getFriendlyDate(t.date,this))}_renderChatMessage(t,e){const i=["bubble"];this._isOnlyEmojis(t.body)&&i.push("emojis-only");const n=this._userLookup.get(t.from);return window.__CTRender("div",{class:"chat"},window.__CTRender("div",{class:i.join(" ")},!1===t.mine&&window.__CTRender("div",{class:"from"},T.formatUserName(n,T.NameFormat.PREFIX_FIRST_LAST)||t.from),t.attachments&&t.attachments.length>0&&this._renderMedia(t,t.attachments[0],e),"string"==typeof t.body&&t.body.length>0&&window.__CTRender("div",{class:"content"},this.renderHtml(w.linkifyText(t.body.trim()),this._generateDomIdFromEntryId(t.id)))),window.__CTRender("div",{class:"meta"},window.__CTRender("div",{class:"chat-status"},this._renderChatMessageStatus(t)),window.__CTRender("div",{class:"chat-time"},window.__CTRender("span",{class:"hour-min"},T.getFriendlyTime(t.date)))))}_renderChatMessageStatus(t){if(!this._shouldUseChatMarkers())return null;if(!t.mine)return null;const e=t.receivedBy&&t.receivedBy.length>0;return t.readBy&&t.readBy.length>0?window.__CTRender(y.CTIcon,{width:"10",height:"10",icon:c.Icons.COMMON.Tick}):e?window.__CTRender(y.CTIcon,{width:"10",height:"10",icon:c.Icons.COMMON.TickHollow}):null}_renderMetaMessage(t){const e=this.layer.getCurrentUserJid(),i=this.conversation.participants.find(t=>T.jidsMatch(t.jid,e));if(![c.ChatRole.Owner].includes(i.role)&&!1===this._config.participantAlertResponsesVisible&&t.instigator!==e&&t.action===v.ChatMetaActivityType.ACK)return null;const n=d.getChatMetaActivitySummaryText(t,this._userLookup,e,this,!0);return window.__CTRender("div",{class:"bubble"},this.renderHtml(n,this._generateDomIdFromEntryId(t.id)))}_renderMedia(t,e,i){return window.__CTRender("div",null,window.__CTRender(u.CTCLThumbnail,{chatMessage:t,attachment:e,isLastEntry:i}))}_renderScrollToBottom(){return this.conversation?!0===this.conversation.isProvisional?null:0===this._rawChatEntries.length?null:(this.onRenderComplete(()=>{this._chatScrollToBottom&&this._chatScrollToBottom.classList.add("animate")},!0),window.__CTRender("div",{id:"chat-scroll-to-bottom",class:"chat-scroll-to-bottom",onClick:()=>this._scrollToBottom(!0)},window.__CTRender("div",{class:"icon"},window.__CTRender(y.CTIcon,{icon:v.Icons.UI.ScrollToBottom,width:16,height:16})),window.__CTRender("div",{class:"number"},this._newNotificationsCount))):null}_multilineEllipsis(t){this._description&&E.clamp(this._description,{clamp:t})}_calcLongDescription(){this._description&&(this._description.classList.remove("collapsed"),this.hasLongDescription=this._description.clientHeight>60,this.forceRedraw())}_renderPriorityDescription(){const t=this.conversation.attachments.find(t=>t.type===v.SupportedAttachmentType.AUDIO),e=this.conversation.attachments.find(t=>t.type===v.SupportedAttachmentType.IMAGE);return window.__CTRender("div",{class:"description-container"},t&&window.__CTRender("div",{class:"audio-attachment"},window.__CTRender(p.CTCLAttachmentHandler,{uri:t.local||t.path,type:v.SupportedAttachmentType.AUDIO,conversationId:this.conversation.id,preventRemoteStart:!0})),window.__CTRender("div",{class:"priority-description"},e&&window.__CTRender("div",{class:"image-thumbnail"},window.__CTRender(p.CTCLAttachmentHandler,{uri:e.local||e.path,type:v.SupportedAttachmentType.IMAGE,allowOpenImageInFullScreen:this._config.allowOpenInFullScreen,conversationId:this.conversation.id})),window.__CTRender("div",{id:"description-text",class:"description-text"},this.conversation.description),this.hasLongDescription&&window.__CTRender("div",{class:"expander"},window.__CTRender(y.CTIcon,{id:"priority-description-collapsed-icon",width:"16",height:"16",icon:c.Icons.COMMON.ChevronDown,onClick:t=>this._togglePriorityDescriptionExpansion()}),window.__CTRender(y.CTIcon,{id:"priority-description-expanded-icon",class:"hidden",width:"16",height:"16",icon:c.Icons.COMMON.ChevronUp,onClick:t=>this._togglePriorityDescriptionExpansion()}))))}_renderFooter(){if(this.conversation.disallowReply||!1===this._config.chatAvailable)return null;const t=this._draft&&this._draft.body||"",e=this._draft&&!0===this._draft.error,i=["action","attach"],n=["textbox"],o=["action","send"];!this.sendButtonDisabled&&this.isOnline||o.push("disabled"),this.sending&&(i.push("disabled"),n.push("disabled"));const s=e||this.sendError;return window.__CTRender("div",{class:"footer"},this._config.canSendAttachmentsWithinConversation&&window.__CTRender("div",{class:i.join(" "),onClick:this._attachMedia.bind(this)},window.__CTRender(y.CTIcon,{width:"16",height:"16",icon:v.Icons.UI.Attachment})),window.__CTRender("div",{class:n.join(" ")},this.media&&this.media.length>0&&window.__CTRender("div",{class:"media"},this.media.map(t=>this._renderDraftMedia(t))),window.__CTRender(y.CTGrowingTextbox,{id:"message",key:"message",value:t,placeholder:this.translateI18nItem(R.MESSAGE_PLACEHOLDER),maxHeight:200,maxLength:this._maxMessageLength,transparent:!0,disabled:this.sending,onFocus:this._onFocusMessage.bind(this),onChange:this._onMessageChanged.bind(this),onSubmit:this._sendMessage.bind(this)}),s&&window.__CTRender("div",{class:"error"},window.__CTRender(y.CTIcon,{width:"16",height:"16",icon:v.Icons.UI.Error}))),window.__CTRender("div",{class:o.join(" "),onClick:this._sendMessage.bind(this)},!this.sending&&window.__CTRender(y.CTIcon,{width:"16",height:"16",icon:v.Icons.UI.SendMessage}),this.sending&&window.__CTRender(y.CTIcon,{width:"16",height:"16",icon:c.Icons.COMMON.LoadingSpinner,spin:!0})))}_renderDraftMedia(t){const e=this._getDraftAttachmentSrc(t);return window.__CTRender("div",{class:"media-item"},window.__CTRender("img",{class:"media-image",src:e}),!this.sending&&window.__CTRender("div",{class:"remove"},window.__CTRender(y.CTIcon,{width:"16",height:"16",icon:c.Icons.COMMON.CircleCross,onClick:t=>this._removeMediaItem(t)})))}_renderPagerUI(){const t=this.conversation.attachments.find(t=>t.type===v.SupportedAttachmentType.AUDIO),e=this.conversation.attachments.find(t=>t.type===v.SupportedAttachmentType.IMAGE),i=this.conversation.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid());return window.__CTRender("div",{class:"pager-ui"},t&&window.__CTRender("div",{class:"audio-attachment"},window.__CTRender(p.CTCLAttachmentHandler,{uri:t.local||t.path,type:v.SupportedAttachmentType.AUDIO,conversationId:this.conversation.id,preventRemoteStart:!0})),e&&window.__CTRender("div",{class:"image-thumbnail"},window.__CTRender(p.CTCLAttachmentHandler,{uri:e.local||t.path,type:v.SupportedAttachmentType.IMAGE,allowOpenImageInFullScreen:this._config.allowOpenInFullScreen,conversationId:this.conversation.id})),window.__CTRender("div",{id:"description-text",class:"description-text"},this.conversation.description),i&&window.__CTRender("div",{class:"meta"},window.__CTRender("span",null,"You responded with: ",window.__CTRender("strong",null,i.value)," at ",window.__CTRender("strong",{class:"hour-min"},T.getFriendlyTime(parseInt(""+i.ts))))))}_onMessageChanged(){return o(this,void 0,void 0,function*(){this._updateDraft(),this._updateSendButton()})}_onFocusMessage(){return o(this,void 0,void 0,function*(){this.sendError=!1,T.isAndroid()&&this._chatListScrollable.scrollTop>this._chatListScrollable.scrollHeight/2&&setTimeout(()=>this._scrollToBottom(!0),500),this._updateDraft()})}_removeMediaItem(t){t.stopPropagation(),this._removeMedia(!0)}_sendMessage(){return o(this,void 0,void 0,function*(){if(this.isOnline&&!this.sending&&!this.sendButtonDisabled&&this._messageTextbox){this.sendError=!1,this.sending=!0;try{if(this.conversation.isProvisional)this._pendingConversationId=yield this.layer.createConversationFromProvisional(this.conversation),this._pendingDraft=this._draft;else{const t=this._draft&&this._draft.body?this._draft.body:this._messageTextbox.getValue(),e=this.media.length&&this.media[0].path||null,i=e&&[e]||[],n=this._shouldUseChatMarkers(),o=yield this.layer.sendConversationMessage(this.conversation,t,i,n);this._appendChatEntry(o,!0),this._messageTextbox.clear(),yield this._removeMedia(!1),this._clearDraft(),this._updateSendButton(),this.sending=!1,this._autoFocusMessageTextboxOnDesktop()}}catch(t){const e=this.translateI18nItem(R.SEND_ERROR),i=this.translateI18nItem(R.SEND_ERROR);this.layer.error(e,i,t),t.message&&t.message._id&&this.layer.deleteConversationMessageById(t.message._id,!1),this.sendError=!0,this.sending=!1,this._updateDraft()}}})}_back(){return o(this,void 0,void 0,function*(){this.emitEvent(_.ChatEvents.RemotelyStopAudioPlayer),yield this._removeMedia(!0),yield this._saveDraft(),yield this.layer.clearCurrentConversation(),this.layer.purgeConversation(this.conversation),this.emitComponentEvent("go-back")})}_editInfo(){return o(this,void 0,void 0,function*(){yield this._saveDraft(),this.emitComponentEvent("go-info")})}_leave(){return o(this,void 0,void 0,function*(){(yield this.requestConfirmation(this.translateI18nItem(R.COMFIRM_LEAVE)))&&(yield this.layer.leaveConversation(this.conversation))&&(this.showWaitingMessage(this.translateI18nItem(C.CommonMetadata.getI18nItem(C.CommonI18nKeys.PLEASE_WAIT))),this.addListener(_.ChatEvents.ConversationClosed,()=>o(this,void 0,void 0,function*(){this.dismissWaitingMessage(),this._clearDraft(),yield this.layer.clearCurrentConversation(),this.emitComponentEvent("go-leave")}),{onceOnly:!0}))})}_end(){return o(this,void 0,void 0,function*(){(yield this.requestConfirmation(this.translateI18nItem(R.COMFIRM_END)))&&(yield this.layer.endConversation(this.conversation))&&(this.showWaitingMessage(this.translateI18nItem(C.CommonMetadata.getI18nItem(C.CommonI18nKeys.PLEASE_WAIT))),this.addListener(_.ChatEvents.ConversationClosed,()=>o(this,void 0,void 0,function*(){this.dismissWaitingMessage(),this._clearDraft(),yield this.layer.clearCurrentConversation(),this.emitComponentEvent("go-end")}),{onceOnly:!0}))})}_refreshUserLookup(){return o(this,void 0,void 0,function*(){return yield this._userLookup.populate([this.conversation],this._rawChatEntries)})}_detectOverscrollSupport(){const t=document.createElement("div");document.documentElement.appendChild(t),t.style.WebkitOverflowScrolling="touch",this._supportsOverscroll="getComputedStyle"in window&&"touch"===window.getComputedStyle(t)["-webkit-overflow-scrolling"],document.documentElement.removeChild(t)}_getDomNodes(){const t=this.shadowRoot;this._chatListScrollable=t.querySelector("#chat-history"),this._chatListFetchMore=t.querySelector("#fetch-more"),this._chatScrollToBottom=t.querySelector("#chat-scroll-to-bottom"),this._messageTextbox=t.querySelector("#message"),this._description=t.querySelector("#description-text")}_generateDomIdFromEntryId(t){return`entry_${(t||"").replace(/[:.]/g,"_")}`}_setupScrollWatcher(){this._chatListScrollable&&setTimeout(()=>{this._chatListScrollable.removeEventListener("scroll",this._onScroll),this._chatListScrollable.addEventListener("scroll",this._onScroll)},500)}_stopScroll(t){return o(this,void 0,void 0,function*(){return this._supportsOverscroll?new Promise(e=>{this._chatListScrollable.classList.add("stop-scroll"),this._chatListScrollable.scrollTop=t,setTimeout(()=>{this._chatListScrollable.classList.remove("stop-scroll"),e()},0)}):Promise.resolve()})}_scrollToBottom(t){return o(this,void 0,void 0,function*(){const e=this._processedChatEntries.length-1;if(this._endIdx<e)return e-this._endIdx==1?(this._endIdx+=1,this._calculateStartIdxBasedOnEndIdx(),void this._updateVisibleChatEntries().then(()=>this._scrollToBottom(t))):void this._setMostRecentChatEntriesVisible();if(!this._chatListScrollable)return;this._hideScrollToBottom();const i=this._chatListScrollable.scrollTop,n=this._chatListScrollable.scrollHeight-this._chatListScrollable.clientHeight;if(i>=n)return Promise.resolve();if(t){const t=300;return new Promise(e=>{const i=this._chatListScrollable.scrollTop,o=n-i;let s=0;const r=()=>{s+=20,this._chatListScrollable.scrollTop=((t,e,i,n)=>(t/=n/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e)(s,i,o,t),s<t?setTimeout(r,20):e()};r()})}return this._chatListScrollable.scrollTop=n,Promise.resolve()})}_handleScrollAtTop(){if(this.isFetchingMore)return;if(!this.visibleChatEntries||0===this.visibleChatEntries.length)return;const t=this.visibleChatEntries[0];0!==this._processedChatEntries.findIndex(e=>e.id===t.id)||this.noMoreToFetch?(this._offsetVisibleIndexes(-this._visibleChatEntryBlockSize),this._processIndexChanges(t.id)):this._fetchMoreChatEntries()}_handleScrollAtBottom(){if(!this.visibleChatEntries||0===this.visibleChatEntries.length)return;const t=this.visibleChatEntries[this.visibleChatEntries.length-1];if(this._processedChatEntries.findIndex(e=>e.id===t.id)===this._processedChatEntries.length-1)return this._hideScrollToBottom(),void(this._suppressScrollHandler=!1);this._offsetVisibleIndexes(this._visibleChatEntryBlockSize),this._processIndexChanges(t.id)}_offsetVisibleIndexes(t){this._startIdx=Math.max(0,this._startIdx+t),this._calculateEndIdxBasedOnStartIdx()}_calculateStartIdxBasedOnEndIdx(){this._startIdx=Math.max(0,this._endIdx-3*this._visibleChatEntryBlockSize)}_calculateEndIdxBasedOnStartIdx(){this._endIdx=Math.min(this._processedChatEntries.length-1,this._startIdx+3*this._visibleChatEntryBlockSize)}_processIndexChanges(t){if(!this._chatListScrollable)return;const e=this._getMessageBoundsTop(t);this._updateVisibleChatEntries().then(()=>{const i=this._getMessageTop(t);this._chatListScrollable.scrollTop=i-e,this._suppressScrollHandler=!1})}_getMessageTop(t){const e=this._generateDomIdFromEntryId(t),i=this.shadowRoot.querySelector(`#${e}`);return i&&i.offsetTop||0}_getMessageBoundsTop(t){const e=this._generateDomIdFromEntryId(t),i=this._chatListScrollable.getBoundingClientRect().top||0,n=this.shadowRoot.querySelector(`#${e}`);return(n&&n.getBoundingClientRect().top||0)-i}_resetForConversationChange(){return o(this,void 0,void 0,function*(){this._rawChatEntries=[],this._processedChatEntries=[],this.visibleChatEntries=[],this.fetchError=null,this.noMoreToFetch=!1,this.mightHaveMore=!0})}_fetchMoreChatEntries(t=!1){return o(this,void 0,void 0,function*(){if(this.noMoreToFetch)return;if(!this._config.usePagerUI&&!this._chatListScrollable)return;clearTimeout(this.layer.messageQueueProcessorDebounce),this.isFetchingMore=!0,this.fetchError=null;const e=this._rawChatEntries&&this._rawChatEntries[0]||null;this._isInitialFetch=t||null===e;try{let t=yield this.layer.fetchConversationEntries(this.conversation,e,this._batchSize||10);t.length?(t=t.filter(t=>!t.placeholder),this.isOnline&&t.forEach(t=>this.layer.markChatEntryRead(t)),yield this._updateChatEntries([...t,...this._rawChatEntries]),this._isInitialFetch?this._setMostRecentChatEntriesVisible():(this._startIdx=0,this._calculateEndIdxBasedOnStartIdx(),this._processIndexChanges(e.id)),this.isFetchingMore=!1,this._isInitialFetch&&this.conversation.hasUnread&&(this.conversation.hasUnread=!1,yield this.layer.updateConversation(this.conversation))):(this.isFetchingMore=!1,this.noMoreToFetch=!0,this._suppressScrollHandler=!1),this._isInitialFetch&&t.length<(this._batchSize||Number.MAX_VALUE)&&(this.mightHaveMore=!1)}catch(t){if(!(t instanceof r.NotConnectedError))throw t;this.fetchError=this.translateI18nItem(R.FETCH_ERROR_NOT_ONLINE),this.isFetchingMore=!1}})}_setMostRecentChatEntriesVisible(){this._endIdx=this._processedChatEntries.length-1,this._calculateStartIdxBasedOnEndIdx(),this._updateVisibleChatEntries().then(()=>this._scrollToBottom(!1))}_updateVisibleChatEntries(){return new Promise(t=>{this._startIdx=Math.max(this._startIdx,0),this._endIdx=Math.min(this._endIdx,this._processedChatEntries.length-1),this.visibleChatEntries=this._processedChatEntries.slice(this._startIdx,this._endIdx+1),this.onRenderComplete(()=>t(),!0)})}_updateChatEntries(t){return o(this,void 0,void 0,function*(){this._rawChatEntries=t,this._processedChatEntries=yield this._generateProcessedChatEntries(t),yield this._refreshUserLookup()})}_updateChatEntry(t){return o(this,void 0,void 0,function*(){const e=this._rawChatEntries.findIndex(e=>e.id===t.id);if(-1===e)return;const i=this._rawChatEntries.map((i,n)=>n===e?t:i);yield this._updateChatEntries(i),yield this._updateVisibleChatEntries()})}_appendChatEntry(t,e=!1){return o(this,void 0,void 0,function*(){this._rawChatEntries.find(e=>e.id===t.id)||(yield this._updateChatEntries([...this._rawChatEntries,t]),this._isNearBottom()||e?yield this._scrollToBottom(!0):(this._newNotificationsCount+=1,this._showScrollToBottom()))})}_generateProcessedChatEntries(t){return o(this,void 0,void 0,function*(){const e=[];let i=null;for(let n=t.length-1;n>=0;n--){const o=t[n],s=new Date(o.date);null!==i&&i.toDateString()!==s.toDateString()&&this._addDivider(e,i),e.unshift(o),i=s}return e.sort((t,e)=>t.date-e.date)})}_addDivider(t,e){const i=e.setHours(0,0,0,0);t.unshift({id:`divider_${i}`,type:c.ChatEntryType.Divider,date:i,to:this.conversation.roomJid})}_shouldUseChatMarkers(){return this.conversation.type===v.ConversationType.Direct&&2===this.conversation.participants.length}_isOnlyEmojis(t){return!!t&&0===t.replace(new RegExp("(?:[-]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[#-9]?||||||\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]||\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|||[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|||[-]|||[-]||||||[-]||||||||||||[-]|[-]||||[-])","g"),"").length}_isNearBottom(){if(this._chatListScrollable)return this._chatListScrollable.scrollHeight-this._chatListScrollable.clientHeight-this._chatListScrollable.scrollTop<=100}_showScrollToBottom(){this._chatScrollToBottom&&(this.onRenderComplete(()=>{this._newNotificationsCount&&this._newNotificationsCount>0?this._chatScrollToBottom.querySelector(".number").textContent=this._newNotificationsCount.toString():this._chatScrollToBottom.querySelector(".number").textContent=""},!0),this._chatScrollToBottom.classList.add("visible"))}_hideScrollToBottom(){this._chatScrollToBottom&&(this._chatScrollToBottom.classList.remove("visible"),this._newNotificationsCount=0,setTimeout(()=>{const t=this._chatScrollToBottom.querySelector(".number");t&&(t.textContent="")},300))}_attachMedia(){return o(this,void 0,void 0,function*(){this.sending||(this.media.length>0?(yield this.requestConfirmation(this.translateI18nItem(R.CONFIRM_REPLACE_IMAGE)))&&this._doAttachMedia():this._doAttachMedia())})}_doAttachMedia(){return o(this,void 0,void 0,function*(){const t=yield this.layer.captureOrSelectMedia();t.base64=yield b.getThumbnail(t.path,75,75,100),yield this._removeMedia(!0),this.media=[t],this._updateDraft(),this._updateSendButton()})}_removeMedia(t){return o(this,void 0,void 0,function*(){this.media.length>0&&(t&&(yield this.layer.cancelMediaSeletion(this.media[0].path)),this.media=[],this._updateDraft(),this._updateSendButton())})}_getDraftAttachmentSrc(t){if(t.base64){if(t.base64.startsWith("data:")&&t.base64.includes("base64"))return t.base64;if(t.mimeType)return`data:${t.mimeType};base64,${t.base64}`}return t.path?T.normalizeLocalFilePaths(t.path):""}_updateDraft(){if(!this._messageTextbox)return;const t=this._messageTextbox.getValue();let e=null;t&&((e=e||{}).body=t,e.error=this.sendError),JSON.stringify(e)!==JSON.stringify(this._draft)&&(this._draft=null===e?null:e,this._saveDraft(!0),this.forceRedraw())}_clearDraft(){this._draft=null,this._saveDraft()}_saveDraft(t=!1){return o(this,void 0,void 0,function*(){clearTimeout(this._saveDraftTimeout),t?this._saveDraftTimeout=setTimeout(()=>{this.layer.saveConversationDraft(this.conversation,this._draft)},2e3):yield this.layer.saveConversationDraft(this.conversation,this._draft)})}_updateSendButton(){const t=this._draft&&"string"==typeof this._draft.body&&this._draft.body.length>0;this.sendButtonDisabled=!t&&0===this.media.length}_autoFocusMessageTextboxOnDesktop(){T.isDesktop()&&!0===this._config.chatAvailable&&this.onRenderComplete(()=>{this.defer(()=>{this._messageTextbox.focus()})},!0)}_togglePriorityDescriptionExpansion(){if(!this._description)return;const t=this.shadowRoot.querySelector("#priority-description-collapsed-icon");this.shadowRoot.querySelector("#priority-description-expanded-icon").classList.toggle("hidden"),t.classList.toggle("hidden"),this._description.classList.toggle("collapsed"),this._description.classList.contains("collapsed")?(this._description.scrollTop=0,this._multilineEllipsis(2)):this._multilineEllipsis(!1)}}n([s.prop({type:Object,attribute:!1,default:null})],I.prototype,"conversation",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],I.prototype,"visibleChatEntries",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],I.prototype,"isFetchingMore",void 0),n([s.prop({type:String,attribute:!1,default:null})],I.prototype,"fetchError",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],I.prototype,"mightHaveMore",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],I.prototype,"noMoreToFetch",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],I.prototype,"media",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],I.prototype,"sendButtonDisabled",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],I.prototype,"sending",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],I.prototype,"sendError",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],I.prototype,"hasLongDescription",void 0),e.CTCLChatMessageList=I,I.register()},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(5),r=i(29),a=i(1),c=i(12),l=i(0),d=i(4),h=i(2),u=i(13),p=i(6),g=i(21);var m;!function(t){t[t.LOADING_IMAGE="Loading image..."]="LOADING_IMAGE",t[t.IMAGE_REFETCH="Download image"]="IMAGE_REFETCH",t[t.IMAGE_ERROR="Image unable to download, press to retry"]="IMAGE_ERROR"}(m||(m={}));class f{static _create(){return new c.Metadata(g.CTCLHeader,m)}static get instance(){return this._instance||(this._instance=this._create())}}f._instance=null,e.CTCLThumbnailMetadata=f;class _ extends u.CTCLComponent{constructor(){super(),this._onMediaError=(t=>{this._errorIcon=l.Icons.COMMON.AlertWarning,this._errorMessage=this.translateI18nItem(m.IMAGE_ERROR),this.hasError=!0}),this._onClickMedia=(t=>o(this,void 0,void 0,function*(){t.stopPropagation(),yield this.layer.showMediaFullscreen(this.attachment.local)})),this._errorOnClick=(()=>{h.isDesktop()?console.error("Attachments unavailable on desktop."):(this.isLoading=!0,this.hasError=!1,this._downloadRemoteImage())}),this.setMetadata(f.instance)}static get is(){return"ct-cl-thumbnail"}connectedCallback(){super.connectedCallback(),this.initialize()}initialize(){return o(this,void 0,void 0,function*(){this.attachment&&this.chatMessage&&(this.attachment&&!this.attachment.local&&this._downloadRemoteImage(),this.attachment&&this.attachment.local&&this._loadImageFromSource())})}setupListeners(){this.addListener(s.ChatEvents.ChatEntryUpdated,t=>o(this,void 0,void 0,function*(){(yield this.layer.belongsToCurrentConversation(t.chatEntry))&&t.chatEntry.id===this.chatMessage.id&&(this._finalImageSrc||this._isGettingBase64?this._finalImageSrc:(this.attachment=t.chatEntry.attachments[0],this._loadImageFromSource()))}))}get generateComponentStyles(){return i(249)}generateComponentMarkup(){if(!this.chatMessage||!this.attachment)return null;const t=this.layer.hasMediaFullscreenHandler();return window.__CTRender("div",{class:"attachment"},this.isLoading?window.__CTRender("div",{class:`loading ${this.chatMessage.mine?"mine":""}`},window.__CTRender(d.CTIcon,{class:"icon",width:"32",height:"32",icon:p.Icons.UI.Attachment}),window.__CTRender("div",{class:"message"},window.__CTRender(d.CTIcon,{class:"icon",width:"16",height:"16",icon:l.Icons.COMMON.LoadingSpinner,spin:!0}),this.translateI18nItem(m.LOADING_IMAGE))):null,this.hasError?window.__CTRender("div",{class:`error ${this.chatMessage.mine?"mine":""}`,onClick:this._errorOnClick},window.__CTRender(d.CTIcon,{class:"icon",width:"32",height:"32",icon:this._errorIcon}),window.__CTRender("div",{class:"message"},this._errorMessage)):null,this.isLoading||this.hasError?null:window.__CTRender("img",{class:`image ${t?"interactive":""}`,src:this._finalImageSrc,onError:this._onMediaError,onClick:this._onClickMedia}))}_downloadRemoteImage(){this.layer.downloadMessageAttachments(this.chatMessage).catch(()=>{this._errorIcon=l.Icons.COMMON.AlertWarning,this._errorMessage=this.translateI18nItem(m.IMAGE_ERROR),this.hasError=!0,this.isLoading=!1})}_loadImageFromSource(){this.attachment&&this.attachment.local?h.isDesktop()?(this._finalImageSrc=this.attachment.local,this.isLoading=!1,this.onRenderComplete(()=>this.emitEvent(s.ChatEvents.ThumbnailLoaded,this.chatMessage),!0)):this._getBase64():this.isLoading=!0}_getBase64(){return o(this,void 0,void 0,function*(){this._isGettingBase64=!0;try{this._finalImageSrc=yield r.getThumbnail(this.attachment.local,200,200,100),this.hasError=!1,this.onRenderComplete(()=>this.emitEvent(s.ChatEvents.ThumbnailLoaded,this.chatMessage),!0)}catch(t){this._errorIcon=l.Icons.COMMON.AlertWarning,this._errorMessage=this.translateI18nItem(m.IMAGE_ERROR),this.hasError=!0}finally{this.isLoading=!1,this._isGettingBase64=!1}})}}n([a.prop({type:Boolean,attribute:!1,default:!0})],_.prototype,"isLoading",void 0),n([a.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"hasError",void 0),n([a.prop({type:Object,attribute:!0,default:null})],_.prototype,"chatMessage",void 0),n([a.prop({type:Object,attribute:!0,default:null})],_.prototype,"attachment",void 0),n([a.prop({type:Boolean,attribute:!1,default:!1})],_.prototype,"isLastEntry",void 0),e.CTCLThumbnail=_,_.register()},function(t,e,i){var n=i(250);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{font-size:1em}:host,:host .attachment{display:block}:host .attachment .error,:host .attachment .loading{display:flex;flex-direction:column;justify-content:center;align-items:center;width:160px;height:100px;color:var(--chat-message-bubble-received-text,#212121)}:host .attachment .error.mine,:host .attachment .loading.mine{color:var(--chat-message-bubble-sent-text,#fff)}:host .attachment .error.hidden,:host .attachment .loading.hidden{display:none}:host .attachment .error .message,:host .attachment .loading .message{display:flex;flex-direction:row;margin:5px 0 0}:host .attachment .error .message .icon,:host .attachment .loading .message .icon{margin:0 5px 0 0}:host .attachment .error{cursor:pointer}:host .attachment .image{display:block;margin:0 auto;max-width:200px;border-radius:3px}:host .attachment .image.interactive{cursor:pointer}:host .attachment .image.hidden{display:none}:host .attachment+.content{margin:5px 0 0}",""])},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(31),s=i(23),r=i(2),a=s.getSource("Media");var c;!function(t){t[t.NoAudioDevicesFound=1]="NoAudioDevicesFound"}(c=e.AudioRecorderError||(e.AudioRecorderError={})),e.SimpleAudioRecorder=class{constructor(t,e){this._onDataAvailable=(t=>{this._chunks.push(t.data)}),this._onStopRecording=(t=>n(this,void 0,void 0,function*(){this._stream.stop();const t=new Blob(this._chunks);try{const e=yield this._encodeToMp3(t);this._onFinishedCallback&&this._onFinishedCallback(e)}catch(t){this._onFinishedCallback&&this._onFinishedCallback(null)}})),this._mediaError=(()=>{}),this._mediaStatusUpdate=(t=>{}),this._isMobile=r.isMobile(),this._onFinishedCallback=t,this._errorCallback=e}_encodeToMp3(t){return new Promise((e,i)=>n(this,void 0,void 0,function*(){const n=yield o.saveFileToDisk(t,"recording.webm"),s=this._workOutPath(n);window.require("easy-ffmpeg")(n).output(s).on("end",()=>{window.require("fs").unlink(n,()=>{e(s)})}).on("error",t=>{console.error("Encoding error:",t),i(t)}).run()}))}_workOutPath(t){const e=window;return e.process&&"win32"===e.process.platform?`${`${t.substring(0,t.lastIndexOf("\\"))}`}\\${(new Date).valueOf()}_recording.mp3`:`${`${t.substring(0,t.lastIndexOf("/"))}`}/${(new Date).valueOf()}_recording.mp3`}start(){return n(this,void 0,void 0,function*(){if(this._isMobile){let t=yield o.getStorageLocation();0===t.indexOf("file://")&&(t=t.replace("file://",""));const e=`${t}${(new Date).getTime()}.m4a`;this._media=new a(e,()=>{},this._mediaError,this._mediaStatusUpdate),this._media.startRecordWithCompression({SampleRate:44100,NumberOfChannels:1})}else try{this._chunks=[],this._stream=yield navigator.mediaDevices.getUserMedia({audio:!0}),this._recorder=new window.MediaRecorder(this._stream),this._recorder.addEventListener("dataavailable",this._onDataAvailable),this._recorder.addEventListener("stop",this._onStopRecording),this._recorder.start()}catch(t){console.error("NK:",t),t.name&&"DevicesNotFoundError"===t.name&&this._errorCallback&&this._errorCallback(c.NoAudioDevicesFound)}})}stop(){return n(this,void 0,void 0,function*(){this._isMobile?(this._media.stopRecord(),this._media.release(),this._onFinishedCallback&&this._onFinishedCallback(this._media.src)):this._recorder&&this._recorder.stop&&this._recorder.stop()})}}},function(t,e,i){var n=i(253);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host,:host div.container{display:flex;flex:1}:host div.container div.progress{display:flex;width:100%;align-items:center;margin:auto 0}:host div.container div.progress div.bar{display:flex;flex:1;background-color:var(--default-border-color,#ddd);height:3px;width:100%}:host div.container div.progress div.bar span{display:inline-block;height:3px;background-color:var(--primary-color,#22b1c8);transition:all .1s linear}:host div.container div.progress div.length{font-size:.8em}:host div.container div.progress div.length.left{margin-right:10px}:host div.container div.progress div.length.right{margin-left:10px}:host div.container div.controls,:host div.container div.controls div.action{display:flex;align-items:center;justify-content:center}:host div.container div.controls div.action{flex:none;width:36px;height:36px;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border-radius:50%;cursor:pointer;margin-right:10px;transition:background .3s ease-in;transition:opacity .3s linear}:host div.container div.controls div.action.disabled{background:var(--subtle-font-color,#828688);cursor:default}:host div.container div.controls div.action.flash{opacity:.5}",""])},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(31);e.SimpleVideoRecorder=class{constructor(t,e){this._constraints={audio:!0,video:{width:640,height:480,frameRate:24}},this._onDataAvailable=(t=>{this._chunks.push(t.data)}),this._onStopRecording=(t=>n(this,void 0,void 0,function*(){const t=new Blob(this._chunks);try{const e=yield o.saveFileToDisk(t,"video.webm");this._onFinishedCallback&&this._onFinishedCallback(e)}catch(t){console.error("NK: File saving error",t)}})),this._video=t,this._onFinishedCallback=e}_encodeToMp4(t){return new Promise((e,i)=>n(this,void 0,void 0,function*(){const n=yield o.saveFileToDisk(t,"video.webm"),s=`${`${n.substring(0,n.lastIndexOf("/"))}`}/${(new Date).valueOf()}_video.mp4`;window.require("easy-ffmpeg")(n).output(s).on("end",()=>{window.require("fs").unlink(n,()=>{e(s)})}).on("error",t=>{console.error("Encoding error:",t),i(t)}).run()}))}start(){return n(this,void 0,void 0,function*(){this._chunks=[],this._stream=yield navigator.mediaDevices.getUserMedia(this._constraints),this._video.onloadedmetadata=(()=>this._video.play()),this._video.muted=!0,this._video.srcObject=this._stream,this._recorder=new window.MediaRecorder(this._stream),this._recorder.addEventListener("dataavailable",this._onDataAvailable),this._recorder.addEventListener("stop",this._onStopRecording),this._recorder.start()})}stop(){this._recorder.stop(),this._stream.getTracks().forEach(t=>t.stop()),this._video.srcObject=null}}},function(t,e,i){var n=i(256);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:flex;flex:1}:host div.container{display:flex;flex:1;justify-content:space-between}:host div.container div.controls{display:flex;align-items:flex-start;justify-content:center}:host div.container div.controls div.action{display:flex;justify-content:center;align-items:center;flex:none;width:36px;height:36px;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border-radius:50%;cursor:pointer;margin-right:10px;transition:background .3s ease-in;transition:opacity .3s linear}:host div.container div.controls div.action.disabled{background:var(--subtle-font-color,#828688);cursor:default}:host div.container div.controls div.action.flash{opacity:.5}:host div.container div.player{display:flex;width:100%;align-items:center;margin:auto 0;justify-content:center}",""])},function(t,e,i){var n=i(258);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,":host{display:block;width:100%;height:100%}:host div.container{height:100%;justify-content:center}:host div.container,:host div.container div.error{align-items:center;display:flex}:host div.container div.error ct-icon{margin-right:10px}:host div.container img{height:100%}",""])},function(t,e,i){"use strict";var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(0),c=i(13),l=i(15),d=i(27),h=i(4),u=i(9),p=i(2);let g=class extends c.CTCLComponent{constructor(){super(...arguments),this._renderUserLine=(t=>{const e=this._userLookup.get(t.jid),i=this.conversation.receivedList.find(e=>e.jid===t.jid),n=this.conversation.acknowledgements.find(e=>e.jid===t.jid);let o="#aaa";if(n){const t=this._config.alertResponseOptionTemplates.find(t=>t.value===n.value);o=t&&t.color||"#aaa"}return window.__CTRender("div",{class:"user-row"},window.__CTRender("div",{class:"user"},window.__CTRender(h.CTUserAvatar,{user:e}),window.__CTRender("span",null,e.displayName)),i&&window.__CTRender("div",{class:"received"},window.__CTRender("div",{class:"pill"},window.__CTRender("span",{class:"ts"},this._renderTime(i.ts)))),n&&window.__CTRender("div",{class:"response"},window.__CTRender("div",{class:"pill",style:u.buildStyles({backgroundColor:o})},window.__CTRender("span",{class:"res"},n.value),window.__CTRender("span",{class:"ts"},this._renderTime(n.ts)))))})}initialize(){return o(this,void 0,void 0,function*(){this._userLookup=new d.UserLookup(this.layer),yield this._userLookup.populate([this.conversation]),this._config=new l.ConversationConfigReader(this.layer,this.conversation)})}setupListeners(){}generateComponentMarkup(){return this.conversation?window.__CTRender("div",{class:"container"},window.__CTRender("div",{class:"headings"},window.__CTRender("div",{class:"user"},window.__CTRender("span",null,"Participant")),window.__CTRender("div",{class:"received"},window.__CTRender("span",null,"Received")),window.__CTRender("div",{class:"response"},window.__CTRender("span",null,"Responded"))),window.__CTRender("div",{class:"user-list"},this.conversation.participants.filter(t=>t.role!==a.ChatRole.Owner).map(this._renderUserLine))):null}_renderTime(t){let e=t;return"string"==typeof t&&(e=parseInt(t)),t&&(0===p.daysFromNow(e)?p.getFriendlyTime(e):p.getFriendlyDate(e,this))||null}};n([s.prop({type:Object,attribute:!1,default:null})],g.prototype,"conversation",void 0),g=n([r.component({tag:"ctcl-response-view",styles:[i(260)]})],g),e.CTCLResponseView=g},function(t,e,i){var n=i(261);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:flex;width:100%;flex:1 1}:host div.container{display:flex;flex-direction:column;width:100%}:host div.container div.headings{display:flex;background:var(--secondary-color,#f2f2f2);border-top:var(--secondary-border,1px solid #ddd);border-bottom:var(--secondary-border,1px solid #ddd);color:var(--subtle-font-color);align-items:center;padding:5px 10px}@media only screen and (min-width:960px){:host div.container div.headings{border-top:none}}:host div.container div.headings div.user{padding-left:10px;flex-basis:40%}:host div.container div.headings div.received,:host div.container div.headings div.response{flex-basis:30%}:host div.container div.headings div span{text-transform:uppercase}:host div.container div.user-list{display:flex;flex-direction:column;height:100%;overflow-y:scroll}:host div.container div.user-list div.user-row{display:flex;flex-shrink:0;padding:10px 20px;align-items:center;border-bottom:1px solid var(--default-border-color,#ddd)}@media only screen and (max-width:640px){:host div.container div.user-list div.user-row{font-size:.8em}}:host div.container div.user-list div.user-row div.user{display:flex;flex-basis:40%;padding-right:10px;align-items:center;color:var(--default-font-color,#212121)}:host div.container div.user-list div.user-row div.user ct-user-avatar{margin-right:20px}:host div.container div.user-list div.user-row div.received{flex-basis:30%;padding-right:10px}:host div.container div.user-list div.user-row div.received div.pill{background-color:#aaa}:host div.container div.user-list div.user-row div.response{flex-basis:30%}:host div.container div.user-list div.user-row div.pill{color:var(--tertiary-font-color,#fff);padding:5px 20px;border-radius:20px;display:flex;justify-content:space-around;align-items:center}:host div.container div.user-list div.user-row div.pill span.res{font-weight:700;margin-right:5px}",""])},function(t,e,i){"use strict";
/*!
    * Clamp.js 0.5.1
    *
    * Copyright 2011-2013, Joseph Schmitt http://joe.sh
    * Released under the WTFPL license
    * http://sam.zoy.org/wtfpl/
*/function n(t,e){e=e||{};var i,n=window,o={clamp:e.clamp||1e6,useNativeClamp:void 0===e.useNativeClamp||e.useNativeClamp,splitOnChars:e.splitOnChars||[".","-","",""," "],animate:e.animate||!1,truncationChar:e.truncationChar||"",truncationHTML:e.truncationHTML},s=t.style,r=t.innerHTML,a=void 0!==t.style.webkitLineClamp,c=o.clamp,l=c.indexOf&&(c.indexOf("px")>-1||c.indexOf("em")>-1);function d(t,e){return n.getComputedStyle||(n.getComputedStyle=function(t,e){return this.el=t,this.getPropertyValue=function(e){var i=/(\-([a-z]){1})/g;return"float"==e&&(e="styleFloat"),i.test(e)&&(e=e.replace(i,function(){return arguments[2].toUpperCase()})),t.currentStyle&&t.currentStyle[e]?t.currentStyle[e]:null},this}),n.getComputedStyle(t,null).getPropertyValue(e)}function h(e){var i=e||t.clientHeight,n=u(t);return Math.max(Math.floor(i/n),0)}function u(t){var e=d(t,"line-height");return"normal"==e&&(e=1.2*parseInt(d(t,"font-size"))),parseInt(e)}o.truncationHTML&&((i=document.createElement("span")).innerHTML=o.truncationHTML);var p,g,m,f=o.splitOnChars.slice(0),_=f[0];function v(e){return e.lastChild.children&&e.lastChild.children.length>0?v(Array.prototype.slice.call(e.children).pop()):e.lastChild&&e.lastChild.nodeValue&&""!=e.lastChild.nodeValue&&e.lastChild.nodeValue!=o.truncationChar?e.lastChild:(e.lastChild.parentNode.removeChild(e.lastChild),v(t))}function y(t,e){t.nodeValue=e+o.truncationChar}if("auto"==c?c=h():l&&(c=h(parseInt(c))),a&&o.useNativeClamp)s.overflow="hidden",s.textOverflow="ellipsis",s.webkitBoxOrient="vertical",s.display="-webkit-box",s.webkitLineClamp=c,l&&(s.height=o.clamp+"px");else{var C=function(e){return u(t)*e}(c);C<=t.clientHeight&&(m=function e(n,s){if(s){var r=n.nodeValue.replace(o.truncationChar,"");if(p||(_=f.length>0?f.shift():"",p=r.split(_)),p.length>1?(g=p.pop(),y(n,p.join(_))):p=null,i&&(n.nodeValue=n.nodeValue.replace(o.truncationChar,""),t.innerHTML=n.nodeValue+" "+i.innerHTML+o.truncationChar),p){if(t.clientHeight<=s){if(!(f.length>=0&&""!=_))return t.innerHTML;y(n,p.join(_)+_+g),p=null}}else""==_&&(y(n,""),n=v(t),f=o.splitOnChars.slice(0),_=f[0],p=null,g=null);if(!o.animate)return e(n,s);setTimeout(function(){e(n,s)},!0===o.animate?10:o.animate)}}(v(t),C))}return{original:r,clamped:m}}i.r(e),i.d(e,"clamp",function(){return n})},function(t,e,i){var n=i(264);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,'/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block;height:736px;font-size:1em}:host .chat-message-list{position:relative;flex:1 1 auto;display:flex;flex-direction:column;height:736px;overflow-x:hidden;background-color:var(--chat-list-bg-color,#fff)}@media only screen and (min-width:960px){:host .chat-message-list.desktop{flex-direction:row}:host .chat-message-list.desktop .description-container{flex-basis:40%;flex-direction:column;background:var(--default-bg-color-light,#f1f1f1)}:host .chat-message-list.desktop .description-container .image-thumbnail{align-items:center;width:100%;padding:20px 20px 0;flex:0 1;height:30%}:host .chat-message-list.desktop .description-container #description-text{overflow:initial!important}:host .chat-message-list.desktop .description-container .expander{display:none}}:host .chat-message-list ctcl-response-view{flex-basis:50%;flex:1}:host .chat-message-list .response-container{flex:1}:host .chat-message-list .header .action{cursor:pointer}:host .chat-message-list .audio-attachment{padding:20px}:host .chat-message-list .audio-attachment,:host .chat-message-list .priority-description{background:var(--default-bg-color-light,#f1f1f1);color:var(--default-bg-color-light-font,--default-font-color)}:host .chat-message-list .priority-description{display:flex;flex-direction:row;flex-shrink:0}:host .chat-message-list .priority-description .image-thumbnail{height:75px;width:75px;flex:0 0 auto}:host .chat-message-list .priority-description .description-text{font-size:1.333em;padding:15px 10px 0 25px;margin-bottom:15px}:host .chat-message-list .priority-description .description-text.collapsed{overflow:hidden}:host .chat-message-list .priority-description .description-text:not(.collapsed){height:auto;max-height:200px;overflow-y:auto!important;text-wrap:normal;-webkit-overflow-scrolling:touch;white-space:pre-line}:host .chat-message-list .priority-description .expander{display:flex;flex-direction:column-reverse;padding:15px}:host .chat-message-list .priority-description .expander>.hidden{display:none}:host .chat-message-list .chat-history{flex:1 1 auto;position:relative;overflow:auto;-webkit-overflow-scrolling:touch}:host .chat-message-list .chat-history .fetch-more{display:flex;justify-content:center;align-items:center;text-align:center;height:80px;overflow:hidden;transition:height var(--animation-normal,.5s) ease-out;color:var(--subtle-font-color,#828688)}:host .chat-message-list .chat-history .fetch-more .error{display:flex;align-items:center}:host .chat-message-list .chat-history .fetch-more .error .icon{margin:0 5px 0 0}:host .chat-message-list .chat-history .fetch-more.no-more{height:0}:host .chat-message-list .chat-history .entry{display:flex}:host .chat-message-list .chat-history .entry.divider{justify-content:center;background:var(--light-header-bg,#f2f2f2);color:var(--light-header-text,#828688);padding:3px 15px;margin:10px 0;font-size:.833em;font-weight:600;text-transform:uppercase}:host .chat-message-list .chat-history .entry.meta{padding:10px;justify-content:center;text-align:center}:host .chat-message-list .chat-history .entry.meta .bubble{display:inline-block;background:var(--light-header-bg,#f2f2f2);color:var(--light-header-text,#828688);font-size:.833em;padding:3px 30px;margin:0 auto;border-radius:10px}:host .chat-message-list .chat-history .entry.meta .bubble .b{font-weight:700}:host .chat-message-list .chat-history .entry.meta+.meta{padding-top:0}:host .chat-message-list .chat-history .entry.chat{padding:10px 0}:host .chat-message-list .chat-history .entry.chat .chat{display:flex;flex-direction:column}:host .chat-message-list .chat-history .entry.chat .chat .bubble{position:relative;display:inline-block;padding:8px;font-size:1em;border-radius:5px}:host .chat-message-list .chat-history .entry.chat .chat .bubble .from{margin:0 0 5px}:host .chat-message-list .chat-history .entry.chat .chat .bubble .content{word-break:break-word;white-space:pre-line;word-wrap:break-word}:host .chat-message-list .chat-history .entry.chat .chat .bubble .content a{color:inherit}:host .chat-message-list .chat-history .entry.chat .chat .bubble.emojis-only .content{font-size:36px;line-height:1em}:host .chat-message-list .chat-history .entry.chat .chat .bubble:after{content:"";display:block;position:absolute;top:12px;width:0;height:0}:host .chat-message-list .chat-history .entry.chat .chat .meta{display:flex;font-size:.833em;font-weight:600;padding:2px 5px;color:var(--subtle-font-color,#828688)}:host .chat-message-list .chat-history .entry.chat .chat .meta .chat-status{margin:0 3px 0 0}:host .chat-message-list .chat-history .entry.chat.sent{justify-content:flex-end}:host .chat-message-list .chat-history .entry.chat.sent .chat{margin:0 15px 0 50px;align-items:flex-end}:host .chat-message-list .chat-history .entry.chat.sent .chat .bubble{background:var(--chat-message-bubble-sent-bg,#22b1c8);color:var(--chat-message-bubble-sent-text,#fff)}:host .chat-message-list .chat-history .entry.chat.sent .chat .bubble:after{right:0;margin:0 -12px 0 0;border-top:5px solid transparent;border-bottom:5px solid transparent;border-left:15px solid var(--chat-message-bubble-sent-bg,#22b1c8)}:host .chat-message-list .chat-history .entry.chat.sent .meta{justify-content:flex-end;align-items:center}:host .chat-message-list .chat-history .entry.chat.received{justify-content:flex-start}:host .chat-message-list .chat-history .entry.chat.received .chat{margin:0 50px 0 15px}:host .chat-message-list .chat-history .entry.chat.received .chat .bubble{background:var(--chat-message-bubble-received-bg,#ebebeb);color:var(--chat-message-bubble-received-text,#212121)}:host .chat-message-list .chat-history .entry.chat.received .chat .bubble .from{color:var(--chat-message-bubble-received-from,#22b1c8)}:host .chat-message-list .chat-history .entry.chat.received .chat .bubble:after{left:0;margin:0 0 0 -12px;border-top:5px solid transparent;border-bottom:5px solid transparent;border-right:15px solid var(--chat-message-bubble-received-bg,#ebebeb)}:host .chat-message-list .chat-history.stop-scroll{overflow:hidden}:host .chat-message-list .chat-scroll-to-bottom{position:absolute;right:0;bottom:65px;display:flex;align-items:center;padding:3px;background:#fff;border:var(--secondary-border,#f2f2f2);border-width:1px 0 1px 1px;border-radius:50px 0 0 50px;transform:translateX(100%);cursor:pointer}:host .chat-message-list .chat-scroll-to-bottom .icon{width:34px;height:34px;display:flex;justify-content:center;align-items:center;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border:1px solid var(--primary-font-color,#fff);border-radius:50%}:host .chat-message-list .chat-scroll-to-bottom .number{margin:0 3px;color:var(--primary-color,#22b1c8);font-size:.833em;font-weight:600}:host .chat-message-list .chat-scroll-to-bottom.animate{transition:transform .3s ease-out}:host .chat-message-list .chat-scroll-to-bottom.visible{transform:translateX(0)}:host .chat-message-list .pager-ui{background:var(--default-bg-color-light,#f1f1f1);color:var(--default-bg-color-light-font,--default-font-color);flex:1;display:flex;flex-direction:column}:host .chat-message-list .pager-ui .image-thumbnail{padding:20px 20px 0;display:flex;height:25vh;width:50%;align-self:center}:host .chat-message-list .pager-ui .description-text{font-size:1.333em;padding:20px 10px 0 25px;margin-bottom:auto}:host .chat-message-list .pager-ui .meta{display:flex;padding:2px 5px;background:var(--light-header-bg,#ebebeb);color:var(--light-header-text,#828688);padding:3px 30px;margin:0 15% 40px;border-radius:10px;justify-content:center}:host .chat-message-list .pager-ui .meta span{text-align:center}:host .chat-message-list .footer{flex:none;display:flex;align-items:flex-end;padding:10px;background:var(--secondary-color,#f2f2f2);border-top:var(--secondary-border,1px solid #ddd)}:host .chat-message-list .footer .action{display:flex;justify-content:center;align-items:center;flex:none;width:32px;height:32px;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border-radius:50%;cursor:pointer}:host .chat-message-list .footer .action.disabled{background:var(--subtle-font-color,#828688);cursor:default}:host .chat-message-list .footer .textbox{position:relative;flex:1 1 auto;margin:0 5px;background:transparent}:host .chat-message-list .footer .textbox .media{display:flex;flex-direction:row;justify-content:center;padding:7px 10px;border-bottom:var(--secondary-border,1px solid #ddd)}:host .chat-message-list .footer .textbox .media .media-item{position:relative}:host .chat-message-list .footer .textbox .media .media-item .media-image{max-height:75px;display:block}:host .chat-message-list .footer .textbox .media .media-item .remove{position:absolute;top:5px;right:5px;color:#fff;background:#212121;border-radius:50%;cursor:pointer}:host .chat-message-list .footer .textbox .error{position:absolute;bottom:8px;right:5px;color:var(--conversation-has-error-color,#d93247)}:host .chat-message-list .footer .textbox.disabled{background:var(--secondary-color,#f2f2f2)}',""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(12),c=i(0),l=i(13),d=i(10),h=i(21),u=i(15),p=i(5),g=i(4),m=i(2);var f;!function(t){t[t.CONTACT_INFORMATION="Contact Information"]="CONTACT_INFORMATION",t[t.START_DIRECT_CONVERSATION="Direct Conversation"]="START_DIRECT_CONVERSATION",t[t.USER_TYPE="User Type"]="USER_TYPE",t[t.ACCESS_RIGHTS="Access Rights"]="ACCESS_RIGHTS",t[t.PARTICIPANT="Participant"]="PARTICIPANT",t[t.PARTICIPANT_RIGHTS="Read/Reply"]="PARTICIPANT_RIGHTS",t[t.ADMIN="Admin"]="ADMIN",t[t.ADMIN_RIGHTS="Add/Remove Participants"]="ADMIN_RIGHTS",t[t.OWNER="Owner"]="OWNER",t[t.OWNER_RIGHTS="Add/Remove/Promote/Demote Anybody"]="OWNER_RIGHTS",t[t.REMOVE_FROM_CONVERSATION="Remove From This Conversation"]="REMOVE_FROM_CONVERSATION",t[t.CONFIRM_DIRECT_CONVERSATION="Are you sure you wish to start or resume a direct conversation with this contact?"]="CONFIRM_DIRECT_CONVERSATION",t[t.CONFIRM_CHANGE_ROLE="Are you sure you wish to change the role of this contact?"]="CONFIRM_CHANGE_ROLE",t[t.CONFIRM_REMOVE="Are you sure you wish to remove this contact from the conversation?"]="CONFIRM_REMOVE"}(f||(f={}));class _{static _create(){return new a.Metadata(v,f)}static get instance(){return this._instance||(this._instance=this._create())}}_._instance=null,e.CTCLContactInfoMetadata=_;class v extends l.CTCLComponent{constructor(){super(),this._animationDuration=500,this._goChatFunction=null,this.setMetadata(_.instance)}static get is(){return"ct-cl-contact-info"}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){this.setupConnectionStatusListener(),this.addListener(p.ChatEvents.ConversationParticipantsChanged,t=>{this.conversation&&this.conversation.id===t.conversation.id&&(this.conversation.participants=t.conversation.participants,this.forceRedraw())}),this.addListener(r.BaseEvents.ConnectionStatusChange,t=>{t.status===c.ConnectionStatus.Disconnected&&this.dismissWaitingMessage()},{dontSuppress:!0})}get generateComponentStyles(){return i(266)}generateComponentMarkup(){return this.contact?window.__CTRender("div",{class:"contact-info"},this._renderHeader(),this._renderContactInfo(),this.conversation&&this._renderConversationContext()):null}_renderHeader(){return window.__CTRender(h.CTCLHeader,{class:"header"},window.__CTRender("div",{slot:"left-action"},window.__CTRender(g.CTIcon,{class:"action",width:"20",height:"20",icon:c.Icons.COMMON.ChevronLeft,onClick:this._back.bind(this)})),window.__CTRender("div",{slot:"heading"},m.formatUserName(this.contact,m.NameFormat.PREFIX_INITIAL_LAST)),window.__CTRender("div",{slot:"sub-heading"},this.translateI18nItem(f.CONTACT_INFORMATION)))}_renderContactInfo(){return window.__CTRender("div",{class:"user-info"},window.__CTRender(g.CTUserAvatar,{class:"avatar",user:this.contact,size:90}),window.__CTRender("div",{class:"name"},m.formatUserName(this.contact,m.NameFormat.PREFIX_FIRST_LAST)),this.contact.jobTitle&&window.__CTRender("div",{class:"job-title"},this.contact.jobTitle),this.layer.config.roles.enableRoles&&this.contact.group&&window.__CTRender("div",{class:"group"},this.contact.group),this.contact.telephone&&window.__CTRender("a",{class:"telephone",href:`tel:${this.contact.telephone}`},this.contact.telephone),this.allowStartDirect&&window.__CTRender("div",{class:"actions"},window.__CTRender(g.CTButton,{type:"secondary",width:"auto",disabled:!this.isOnline,onClick:this._startDirectConversation.bind(this)},this.translateI18nItem(f.START_DIRECT_CONVERSATION))))}_renderConversationContext(){const t=this._getParticipant(this.contact.jid);if(!t)return null;const e=this._config.namedSettings&&this._config.ownerCanEditAfterSend,i=this.layer.getCurrentUserJid(),n=this._getParticipant(i).role,o=n===c.ChatRole.Owner,s=n===c.ChatRole.Owner||n===c.ChatRole.Administrator&&t.role===c.ChatRole.Participant;return window.__CTRender("div",{class:"conversation-context"},e&&window.__CTRender("div",{class:"roles"},window.__CTRender("div",{class:"row header"},window.__CTRender("div",{class:"l"},this.translateI18nItem(f.USER_TYPE)),window.__CTRender("div",{class:"r"},this.translateI18nItem(f.ACCESS_RIGHTS))),this._renderRoleType(t,c.ChatRole.Owner,f.OWNER,f.OWNER_RIGHTS,o),this._renderRoleType(t,c.ChatRole.Administrator,f.ADMIN,f.ADMIN_RIGHTS,o),this._renderRoleType(t,c.ChatRole.Participant,f.PARTICIPANT,f.PARTICIPANT_RIGHTS,o)),e&&s&&window.__CTRender("div",{class:"footer"},window.__CTRender(g.CTButton,{type:"dangerous",width:"auto",disabled:!this.isOnline,onClick:()=>this._removeFromConversation(t)},this.translateI18nItem(f.REMOVE_FROM_CONVERSATION))))}_renderRoleType(t,e,i,n,o){const s=t.role===e,r=["row","role"];return o&&this.isOnline||r.push("disabled"),s&&r.push("selected"),window.__CTRender("div",{class:r.join(" "),onClick:(()=>{o&&e!==t.role&&this._changeRole(t,e)}).bind(this)},window.__CTRender("div",{class:"l"},window.__CTRender("div",{class:"radio"}),this.translateI18nItem(i)),window.__CTRender("div",{class:"r"},this.translateI18nItem(n)))}_back(){this.dismiss()}_startDirectConversation(){return o(this,void 0,void 0,function*(){if(this.isOnline&&(yield this.requestConfirmation(this.translateI18nItem(f.CONFIRM_DIRECT_CONVERSATION)))){const t=this.layer.getCurrentUserJid(),e=d.buildConversationParticipants(null,null,[t,this.contact.jid]),i=yield this.layer.getDirectConversationByParticipants(e);if(i)yield this.layer.setCurrentConversation(i),yield this.dismiss(!1),this._callGoChatFunction();else{const t=d.createProvisionalDirectConversation(e,this.layer.doesDirectConversationExistInConfiguration());yield this.layer.setProvisionalConversation(t),yield this.dismiss(!1),this._callGoChatFunction()}}})}_changeRole(t,e){return o(this,void 0,void 0,function*(){this.isOnline&&(yield this.requestConfirmation(this.translateI18nItem(f.CONFIRM_CHANGE_ROLE)))&&(yield this.layer.changeParticipantRoleInConversation(this.conversation,t,e))})}_removeFromConversation(t){return o(this,void 0,void 0,function*(){this.isOnline&&(yield this.requestConfirmation(this.translateI18nItem(f.CONFIRM_REMOVE)))&&(yield this.layer.removeParticipantsFromConversation(this.conversation,[t]))&&this.dismiss(!1)})}show(t,e=null,i=!0,n=!0,s=null){return o(this,void 0,void 0,function*(){this.animateModal=n,this.contact=t,this.conversation=e,this._config=new u.ConversationConfigReader(this.layer,this.conversation),this.showing=!0,this._goChatFunction=s,this.allowStartDirect=!!i&&!!this.layer.doesDirectConversationExistInConfiguration(),this.layer.setBackHandler(()=>{this._back()}),yield m.sleep(n?this._animationDuration:0)})}dismiss(t=!0){return o(this,void 0,void 0,function*(){this.animateModal=t,this.showing=!1,this.layer.popBackHandler(),yield m.sleep(t?this._animationDuration:0),this.contact=null,this.conversation=null,this.allowStartDirect=!1})}_getParticipant(t){return this.conversation&&this.conversation.participants.find(e=>m.jidsMatch(e.jid,t))||null}_callGoChatFunction(){"function"==typeof this._goChatFunction&&this._goChatFunction(),this._goChatFunction=null}}n([s.prop({type:Boolean,attribute:!0,default:!0})],v.prototype,"animateModal",void 0),n([s.prop({type:Boolean,attribute:!0,default:!1})],v.prototype,"showing",void 0),n([s.prop({type:Object,attribute:!1,default:null})],v.prototype,"contact",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],v.prototype,"allowStartDirect",void 0),n([s.prop({type:Object,attribute:!1,default:null})],v.prototype,"conversation",void 0),e.CTCLContactInfo=v,v.register()},function(t,e,i){var n=i(267);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,'/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100%;width:100%;background:#fff;font-size:1em;transform:translateY(100%);will-change:transform;z-index:99997}:host .contact-info{flex:1 1 auto;display:flex;flex-direction:column;height:100%;background-color:var(--list-bg);color:var(--default-font-color)}:host .contact-info .header .action{cursor:pointer}:host .contact-info .user-info{display:flex;flex-direction:column;align-items:center;flex:none;padding:10px 40px 20px}:host .contact-info .user-info .avatar{margin:0 0 10px}:host .contact-info .user-info .name{font-size:1.333em}:host .contact-info .user-info .group,:host .contact-info .user-info .job-title{font-size:1.333em;font-weight:300;color:var(--subtle-font-color,#828688)}:host .contact-info .user-info .group{font-style:italic}:host .contact-info .user-info .telephone{font-size:1.333em;color:var(--primary-color,#22b1c8);text-decoration:none}:host .contact-info .user-info .actions{margin:20px 0 0}:host .contact-info .conversation-context{display:flex;flex-direction:column;flex:1 1 auto}:host .contact-info .conversation-context .roles{flex:1 1 auto}:host .contact-info .conversation-context .roles .row{display:flex;align-items:center;border-bottom:var(--secondary-border,1px solid #ddd)}:host .contact-info .conversation-context .roles .row .r{margin:0 0 0 auto;text-align:right}:host .contact-info .conversation-context .roles .row.header{flex:none;background:var(--light-header-bg,#f2f2f2);color:var(--light-header-text,#828688);font-size:.833em;font-weight:600;text-transform:uppercase;padding:7px 20px}:host .contact-info .conversation-context .roles .row.role{padding:10px 20px;cursor:pointer}:host .contact-info .conversation-context .roles .row.role .l{position:relative;padding:0 0 0 30px}:host .contact-info .conversation-context .roles .row.role .l .radio{position:absolute;display:flex;justify-content:center;align-items:center;left:0;top:50%;transform:translateY(-50%);width:18px;height:18px;border:2px solid var(--default-font-color,#212121);border-radius:50%}:host .contact-info .conversation-context .roles .row.role .r{font-size:.833em;color:var(--subtle-font-color,#828688)}:host .contact-info .conversation-context .roles .row.disabled{opacity:.5;cursor:not-allowed}:host .contact-info .conversation-context .roles .row.selected .l .radio:before{content:"";display:block;width:6px;height:6px;background-color:var(--default-font-color,#212121);border-radius:50%}:host .contact-info .conversation-context .footer{flex:none;padding:10px;text-align:center}:host([animate]){transition:transform var(--animation-normal,.5s) ease-out}:host([showing]){transform:translateY(0)}',""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(12),a=i(0),c=i(13),l=i(21),d=i(15),h=i(27),u=i(5),p=i(4),g=i(9),m=i(2);var f;!function(t){t[t.INFORMATION="Information"]="INFORMATION",t[t.DIRECT_CONVERSATION="Direct Conversation"]="DIRECT_CONVERSATION",t[t.NAMED_CONVERSATION="Named Conversation"]="NAMED_CONVERSATION",t[t.CURRENT_ROLE_ADMINISTRATOR="You are an Admin of this conversation"]="CURRENT_ROLE_ADMINISTRATOR",t[t.CURRENT_ROLE_OWNER="You are an Owner of this conversation"]="CURRENT_ROLE_OWNER",t[t.ADMIN="Admin"]="ADMIN",t[t.OWNER="Owner"]="OWNER",t[t.CONTACT_LIST_HEADER="Contacts in this conversation"]="CONTACT_LIST_HEADER",t[t.ADD_MORE_CONTACTS="Add More Contacts"]="ADD_MORE_CONTACTS",t[t.SUBJECT="Subject"]="SUBJECT",t[t.DESCRIPTION_OPTIONAL="Description (optional)"]="DESCRIPTION_OPTIONAL",t[t.EDIT="Edit details"]="EDIT",t[t.SAVE="Save"]="SAVE",t[t.CANCEL="Cancel"]="CANCEL"}(f||(f={}));class _{static _create(){return new r.Metadata(v,f)}static get instance(){return this._instance||(this._instance=this._create())}}_._instance=null,e.CTCLConversationInfoMetadata=_;class v extends c.CTCLComponent{constructor(){super(),this._me=null,this._namedConversationSubject="",this._namedConversationDescription="",this.setMetadata(_.instance)}static get is(){return"ct-cl-conversation-info"}initialize(){return o(this,void 0,void 0,function*(){if(this.isLoading=!0,this.conversation=yield this.layer.getCurrentConversation(),this._config=new d.ConversationConfigReader(this.layer,this.conversation),!this.conversation)return yield this._back();this._getCurrentUserParticipant(),this._namedConversationSubject=this.conversation.subject,this._namedConversationDescription=this.conversation.description,this.defer(()=>o(this,void 0,void 0,function*(){this._userLookup=new h.UserLookup(this.layer),yield this._userLookup.populate([this.conversation]),this._createUserList(),this.isLoading=!1})),this.layer.setBackHandler(()=>{this._back()})})}_createUserList(){const t=this.conversation.participants.filter(t=>!m.jidsMatch(t.jid,this._me.jid)).map(t=>this._userLookup.get(t.jid)).filter(t=>null!==t),e=m.sortUsersByName(t);this.usersToDisplay=e}_getCurrentUserParticipant(){const t=this.layer.getCurrentUserJid();this._me=this.conversation.participants.find(e=>m.jidsMatch(e.jid,t))||null}setupListeners(){this.setupConnectionStatusListener(),this.addListener(u.ChatEvents.ConversationUpdated,t=>o(this,void 0,void 0,function*(){this.conversation&&this.conversation.id===t.conversation.id&&(this.conversation=t.conversation,yield this._userLookup.populate([this.conversation]),this._createUserList())})),this.addListener(u.ChatEvents.ConversationParticipantsChanged,t=>o(this,void 0,void 0,function*(){this.conversation&&this.conversation.id===t.conversation.id&&(this.isLoading=!0,this.conversation.participants=t.participants,this._getCurrentUserParticipant(),yield this._userLookup.populate([this.conversation]),this._createUserList(),this.isLoading=!1)}))}get generateComponentStyles(){return i(269)}generateComponentMarkup(){if(!this.conversation)return;if(!this._me)return;const t=this._config.namedSettings,e=t&&[a.ChatRole.Owner].includes(this._me.role)&&this._config.ownerCanEditAfterSend,i=t&&[a.ChatRole.Administrator,a.ChatRole.Owner].includes(this._me.role)&&this._config.ownerCanAddAdditionalContacts;return window.__CTRender("div",{class:"conversation-info"},this._renderHeader(),t&&this._renderMyRole(),window.__CTRender("div",{class:"scrollable"},t&&this._renderNamedConversationInfo(e),!this.editMode&&window.__CTRender("div",{class:"participants"},window.__CTRender("div",{class:"heading"},this.translateI18nItem(f.CONTACT_LIST_HEADER)),this.isLoading?window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:a.Icons.COMMON.LoadingSpinner,spin:!0}):this._renderParticipants()),!this.editMode&&i&&this._renderFooter()))}_renderHeader(){const t=this._config.name;return window.__CTRender(l.CTCLHeader,{class:"header"},window.__CTRender("div",{slot:"left-action"},window.__CTRender(p.CTIcon,{class:"action",width:"20",height:"20",icon:a.Icons.COMMON.ChevronLeft,onClick:this._back.bind(this)})),window.__CTRender("div",{slot:"heading"},this.translateI18nItem(f.INFORMATION)),window.__CTRender("div",{slot:"sub-heading"},t))}_renderMyRole(){const t=this._getCurrentRoleString();return t&&window.__CTRender("div",{class:"role"},t)}_renderNamedConversationInfo(t){if(t&&this.editMode){const t=this._config.maxSubjectLength,e=this._config.maxDescriptionLength;return window.__CTRender("div",{class:"named-info"},window.__CTRender("div",{class:"form-item subject"},window.__CTRender(p.CTTextbox,{type:"text",name:"subject",max:t,required:!0,fullBorder:!0,defaultValue:this._namedConversationSubject,placeholder:this._config.subjectFieldLabel,callback:t=>this._onChangeNamedConversationDetail(t)})),window.__CTRender("div",{class:"form-item description"},window.__CTRender(p.CTTextbox,{type:"textarea",name:"description",max:e,fullBorder:!0,defaultValue:this._namedConversationDescription,placeholder:this.translateI18nItem(f.DESCRIPTION_OPTIONAL),callback:t=>this._onChangeNamedConversationDetail(t)})),window.__CTRender("div",{class:"buttons"},window.__CTRender(p.CTButton,{class:"button",type:"primary",width:"auto",disabled:this.saveDisabled||!this.isOnline,onClick:this._saveChanges.bind(this)},this.translateI18nItem(f.SAVE)),window.__CTRender(p.CTButton,{class:"button",type:"secondary",width:"auto",disabled:!this.isOnline,onClick:this._cancelChanges.bind(this)},this.translateI18nItem(f.CANCEL))))}return window.__CTRender("div",{class:"named-info"},window.__CTRender("div",{class:"subject"},this.conversation.subject),this.conversation.description&&window.__CTRender("div",{class:"description"},this.conversation.description),t&&window.__CTRender("div",{class:"buttons"},window.__CTRender(p.CTButton,{class:"button",type:"secondary",width:"auto",disabled:!this.isOnline,onClick:this._enterEditMode.bind(this)},this.translateI18nItem(f.EDIT))))}_renderParticipants(){return window.__CTRender("div",{class:"participant-list"},this.usersToDisplay.map(t=>this._renderContact(t)))}_renderContact(t){if(!t)return null;const e=this.conversation.participants.find(e=>m.jidsMatch(e.jid,t.jid))||null;if(!e)return null;const i=this._config.namedSettings,n=i&&this._getRoleString(e)||null,o=i&&this._getRoleClass(e)||null,s=g.buildStyles({});return n&&(s.paddingRight="60px"),window.__CTRender("div",{class:"participant",onClick:()=>this._showContactInfo(t)},window.__CTRender(p.CTUserTile,{user:t,detailStyle:s},n&&window.__CTRender("div",{class:"badges",slot:"additional"},window.__CTRender("div",{class:`badge ${o}`},n))))}_renderFooter(){return window.__CTRender("div",{class:"footer"},window.__CTRender(p.CTButton,{type:"secondary",width:"auto",disabled:!this.isOnline,onClick:this._addContacts.bind(this)},this.translateI18nItem(f.ADD_MORE_CONTACTS)))}_enterEditMode(){this.saveDisabled=!0,this.editMode=!0}_onChangeNamedConversationDetail(t){t&&"subject"===t.key&&(this._namedConversationSubject=t.value),t&&"description"===t.key&&(this._namedConversationDescription=t.value);const e=!this._config.subjectRequired||this._namedConversationSubject.trim().length>0,i=!this._config.descriptionRequired||this._namedConversationDescription.trim().length>0,n=this.conversation.subject!==this._namedConversationSubject||this.conversation.description!==this._namedConversationDescription;this.saveDisabled=!e||!i||!n}_saveChanges(){return o(this,void 0,void 0,function*(){this.saveDisabled||(yield this.layer.updateNamedConversation(this.conversation,this._namedConversationSubject.trim(),this._namedConversationDescription.trim()))&&(this.editMode=!1)})}_cancelChanges(){this._namedConversationSubject=this.conversation.subject,this._namedConversationDescription=this.conversation.description,this.editMode=!1}_back(){return o(this,void 0,void 0,function*(){this.conversation&&(yield this.layer.setCurrentConversation(this.conversation)),this.emitComponentEvent("go-back")})}_addContacts(){this.emitComponentEvent("go-add-contacts")}_goChat(){this.emitComponentEvent("go-chat")}_showContactInfo(t){this.layer.showContactInfo(t,this.conversation,!0,this._goChat.bind(this))}_getCurrentRoleString(){switch(this._me&&this._me.role){case a.ChatRole.Administrator:return this.translateI18nItem(f.CURRENT_ROLE_ADMINISTRATOR);case a.ChatRole.Owner:return this.translateI18nItem(f.CURRENT_ROLE_OWNER);default:return null}}_getRoleString(t){switch(t&&t.role){case a.ChatRole.Administrator:return this.translateI18nItem(f.ADMIN);case a.ChatRole.Owner:return this.translateI18nItem(f.OWNER);default:return null}}_getRoleClass(t){switch(t&&t.role){case a.ChatRole.Administrator:return"admin";case a.ChatRole.Owner:return"owner";default:return null}}}n([s.prop({type:Object,attribute:!1,default:null})],v.prototype,"conversation",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],v.prototype,"editMode",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],v.prototype,"saveDisabled",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],v.prototype,"usersToDisplay",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],v.prototype,"isLoading",void 0),e.CTCLConversationInfo=v,v.register()},function(t,e,i){var n=i(270);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block;height:100%;font-size:1em}:host .conversation-info{flex:1 1 auto;display:flex;flex-direction:column;height:100%}:host .conversation-info .header .action{cursor:pointer}:host .conversation-info .role{flex:none;background:var(--dark-header-bg,#212121);color:var(--dark-header-text,#f2f2f2);padding:7px 20px}:host .conversation-info .scrollable{flex:1 1 auto;display:flex;flex-direction:column;overflow:auto}:host .conversation-info .scrollable .named-info{flex:none}:host .conversation-info .scrollable .named-info .description,:host .conversation-info .scrollable .named-info .subject{padding:10px 20px;color:var(--subtle-font-color,#828688)}:host .conversation-info .scrollable .named-info .description.form-item,:host .conversation-info .scrollable .named-info .subject.form-item{padding:10px 10px 5px}:host .conversation-info .scrollable .named-info .buttons,:host .conversation-info .scrollable .named-info .description{border-top:1px solid var(--light-header-bg,#f2f2f2)}:host .conversation-info .scrollable .named-info .buttons{display:flex;justify-content:center;padding:10px}:host .conversation-info .scrollable .named-info .buttons .button+.button{margin:0 0 0 10px}:host .conversation-info .scrollable .participants{flex:1 1 auto}:host .conversation-info .scrollable .participants .heading{flex:none;background:var(--light-header-bg,#f2f2f2);color:var(--light-header-text,#828688);font-size:.833em;font-weight:600;text-transform:uppercase;padding:7px 20px}:host .conversation-info .scrollable .participants ct-icon{margin-top:20px}:host .conversation-info .scrollable .participants .participant-list{flex:1 1 auto}:host .conversation-info .scrollable .participants .participant-list .participant{position:relative;cursor:pointer}:host .conversation-info .scrollable .participants .participant-list .participant .badges{position:absolute;top:50%;right:10px;transform:translateY(-50%)}:host .conversation-info .scrollable .participants .participant-list .participant .badges .badge{display:inline-block;font-size:.75em;font-weight:300;text-transform:uppercase;padding:3px 10px;border-radius:4px;margin:0 0 0 5px;line-height:1em}:host .conversation-info .scrollable .participants .participant-list .participant .badges .badge.admin{background:#303233;color:#fff}:host .conversation-info .scrollable .participants .participant-list .participant .badges .badge.owner{background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff)}:host .conversation-info .scrollable .footer{flex:none;padding:10px;text-align:center}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(12),a=i(0),c=i(13),l=i(10),d=i(21),h=i(15),u=i(27),p=i(5),g=i(6),m=i(4),f=i(38),_=i(64),v=i(2),y=i(9);var C;!function(t){t[t.CONVERSATIONS="Conversations"]="CONVERSATIONS",t[t.NO_UNREAD="No Unread Conversations"]="NO_UNREAD",t[t.UNREAD_COUNT="{{number}} Unread Conversation(s)"]="UNREAD_COUNT",t[t.NO_CONVERSATIONS="You do not have any conversations"]="NO_CONVERSATIONS",t[t.NO_MATCH="No conversations match that filter"]="NO_MATCH",t[t.FILTER_PLACEHOLDER="Filter by Subject & Participant"]="FILTER_PLACEHOLDER",t[t.SUBJECT="Subject"]="SUBJECT",t[t.EXPIRED="Expired"]="EXPIRED",t[t.YOU="You"]="YOU",t[t.CLOSED="Closed"]="CLOSED"}(C||(C={}));class b{static _create(){return new r.Metadata(w,C)}static get instance(){return this._instance||(this._instance=this._create())}}b._instance=null,e.CTCLConversationListMetadata=b;class w extends c.CTCLComponent{constructor(){super(),this.TILE_HEIGHT=70,this._filterType="",this._filterTerm="",this._contentLimit=100,this._onFilterChange=((t,e)=>{this._filterType=t,this._filterTerm=e,this._updateVirtualList()}),this.setMetadata(b.instance),this._virtualList=new _.VirtualList(this,[],{itemHeight:this.TILE_HEIGHT,itemKeyGetter:t=>t.id})}static get is(){return"ct-cl-conversation-list"}initialize(t){const e=Object.create(null,{initialize:{get:()=>super.initialize}});return o(this,void 0,void 0,function*(){yield e.initialize.call(this,t),this._userLookup=new u.UserLookup(this.layer),this.isFetching=!0,this.defer(()=>o(this,void 0,void 0,function*(){yield this._updateConversations()})),this.layer.setBackHandler(()=>{this.layer.moveTaskToBack()})})}setupListeners(){this.addListeners([p.ChatEvents.ConversationAdded,p.ChatEvents.ConversationUpdated,p.ChatEvents.ConversationRemoved],()=>o(this,void 0,void 0,function*(){this.debounce("update",()=>o(this,void 0,void 0,function*(){yield this._updateConversations()}))}))}_generateFilterItems(){const t=this.layer.getConfiguredConversations().map(t=>t.name);return this._allConversations.forEach(e=>{e.config&&!t.includes(e.config.name)&&t.push(e.config.name)}),t.sort(),t}get generateComponentStyles(){return i(272)}generateComponentMarkup(){return window.__CTRender("div",{class:"conversation-list"},this._renderHeader(),window.__CTRender("div",{class:"filter"},window.__CTRender(f.CTSelectionTextFilter,{placeholder:this.translateI18nItem(C.FILTER_PLACEHOLDER),selectionItems:this.filterItems,onSearch:this._onFilterChange})),window.__CTRender("div",{class:"column-headings"},window.__CTRender("div",{class:"type"},window.__CTRender("span",null,"Type")),window.__CTRender("div",{class:"from-to"},window.__CTRender("span",null,"From / To")),window.__CTRender("div",{class:"subject"},window.__CTRender("span",null,"Subject / Description")),window.__CTRender("div",{class:"last-response"},window.__CTRender("span",null,"Response / Time")),window.__CTRender("div",{class:"raised-at"},window.__CTRender("span",null,"Raised"))),this.isFetching&&window.__CTRender("div",{class:"fetching"},window.__CTRender(m.CTIcon,{width:"16",height:"16",icon:a.Icons.COMMON.LoadingSpinner,spin:!0})),!this.isFetching&&this._renderConversations())}_renderHeader(){const t=this._virtualList.items.filter(t=>t.hasUnread&&!t.isClosed).length,e=this.translateI18nItem(C.CONVERSATIONS),i=0===t?this.translateI18nItem(C.NO_UNREAD):this.translateI18nItem(C.UNREAD_COUNT).replace("{{number}}",t.toString());return window.__CTRender(d.CTCLHeader,{class:"header"},window.__CTRender("div",{slot:"heading"},e),window.__CTRender("div",{slot:"sub-heading"},i),window.__CTRender("div",{slot:"right-action"},this._renderRightAction()))}_renderRightAction(){return 0===this.layer.getConfiguredConversations().length?null:this.updatingUserDirectory?window.__CTRender(m.CTIcon,{class:"action",width:"20",height:"20",icon:a.Icons.COMMON.LoadingSpinner,spin:!0}):window.__CTRender(m.CTIcon,{class:"action",width:"20",height:"20",icon:a.Icons.COMMON.PlusSign,onClick:this._startNew.bind(this)})}_renderConversations(){return this._allConversations&&0!==this._allConversations.length?0===this._virtualList.items.length?window.__CTRender("div",{class:"no-conversations"},this.translateI18nItem(C.NO_MATCH)):this._virtualList.render(this._renderConversation.bind(this),"conversations","conversations-content"):window.__CTRender("div",{class:"no-conversations"},this.translateI18nItem(C.NO_CONVERSATIONS))}_renderConversation(t,e){const i=new h.ConversationConfigReader(this.layer,t),n=["conversation",t.hasUnread?"unread":"read"];t.isClosed&&n.push("closed"),t.isClosed||"function"!=typeof this._onClickConversation||n.push("clickable");const o=this.layer.getCurrentUserJid(),s=l.getConversationTitle(t,this._userLookup,o,this.translateI18nItem(C.YOU)),r=t.description?t.description.substr(0,100):null,a=this._userLookup.get(t.instigator).displayName,c=l.generateConversationTitleFromParticipants(this._userLookup,t.participants.filter(t=>t.jid!==o),o).substr(0,100),d=t.preview&&(0===v.daysFromNow(t.preview.date)?v.getFriendlyTime(t.preview.date):v.getFriendlyDate(t.preview.date,this))||null,u=0===v.daysFromNow(t.createdTime)?v.getFriendlyTime(t.createdTime):v.getFriendlyDate(t.createdTime,this);let p=i.name,g=i.colorCode;l.isExpiredConversation(t)?(p=i.name,g="#CCC"):i.alert&&(p=i.name,g=i.colorCode);const f=y.buildStyles({backgroundColor:g,color:g?y.decideTextColorFromBgColor(g):"#FFF"}),_=["badge"];if(i.alert){const e=this.layer.getCurrentUserJid();t.instigator===e||i.autoIncludeMembersInRoles.length&&i.autoIncludeMembersInRoles.includes(this.layer.getCurrentUser().group)||l.isExpiredConversation(t)||t.acknowledgements&&t.acknowledgements.find(t=>t.jid===e)||_.push("blink")}return window.__CTRender("div",Object.assign({class:n.join(" ")},e,{onClick:e=>this._onClickConversation(t,e,i)}),window.__CTRender(m.CTAvatarTile,{height:`${this.TILE_HEIGHT}px`,hatched:t.isClosed},this._renderAvatar(t,i),window.__CTRender("div",{class:"subject"},i.namedSettings&&!t.isClosed&&window.__CTRender("div",{class:_.join(" "),style:f},p),window.__CTRender("div",{class:"expanded"},window.__CTRender("div",{class:"from"},"From: ",a),window.__CTRender("div",{class:"to"},"To: ",c)),window.__CTRender("div",{class:"title"},s),this._renderSubjectLineIcon(t)),window.__CTRender("div",{class:"description"},window.__CTRender("div",{class:"subject-desc"},s),window.__CTRender("div",{class:"user-desc"},r)),t.preview&&window.__CTRender("div",{class:"preview"},window.__CTRender("div",{class:"mobile-preview"},this._renderPreviewLine(t.preview),window.__CTRender("div",{class:"when"},d),window.__CTRender("div",{class:"marker"})),window.__CTRender("div",{class:"desktop-preview"},this._renderPreviewLine(t.preview),window.__CTRender("div",{class:"when"},d))),window.__CTRender("div",{class:"raised-on"},window.__CTRender("span",null,u),window.__CTRender("div",{class:"marker"}))))}_renderAvatar(t,e){const i=this.layer.getCurrentUserJid(),n=t.participants.filter(t=>!v.jidsMatch(t.jid,i));if(t.isClosed)return window.__CTRender("div",{slot:"avatar",class:"avatar closed"},window.__CTRender("div",{class:"badge"},this.translateI18nItem(C.CLOSED)));if(e.alert&&e.autoAlert)return window.__CTRender("div",{slot:"avatar",class:"avatar individual"},window.__CTRender(m.CTUserAvatar,{bgColor:t.isClosed?null:e.colorCode,defaultIcon:g.Icons.UI.AlertBellRinging}));if(e.alert&&!e.autoAlert)return window.__CTRender("div",{slot:"avatar",class:"avatar individual"},window.__CTRender(m.CTUserAvatar,{bgColor:t.isClosed?null:e.colorCode,defaultIcon:g.Icons.UI.AlertBell}));if(1===n.length){const i=this._userLookup.get(n[0].jid);return window.__CTRender("div",{slot:"avatar",class:"avatar individual"},window.__CTRender(m.CTUserAvatar,{bgColor:t.isClosed?null:e.colorCode||v.getCSSVariable("--primary-color"),user:i}))}{const t=n.length.toString().length;let e="";return 3===t?e="small":4===t&&(e="smallest"),window.__CTRender("div",{slot:"avatar",class:"avatar group"},window.__CTRender(m.CTIcon,{class:"icon",width:"12",height:"12",icon:a.Icons.COMMON.Users}),window.__CTRender("div",{class:`count ${e}`},"+ ",n.length))}}_renderSubjectLineIcon(t){return t.isClosed?window.__CTRender("div",{class:"icon remove"},window.__CTRender(m.CTIcon,{width:"16",height:"16",icon:a.Icons.COMMON.CircleCross,onClick:e=>this._removeConversation(t,e)})):t.draft?!0===t.draft.error?window.__CTRender("div",{class:"icon error"},window.__CTRender(m.CTIcon,{width:"16",height:"16",icon:g.Icons.UI.Error})):t.draft?window.__CTRender("div",{class:"icon pending"},window.__CTRender(m.CTIcon,{width:"16",height:"16",icon:g.Icons.UI.Pencil})):void 0:null}_renderPreviewLine(t){return t?window.__CTRender("div",{class:"entry"},(()=>{switch(t.type){case a.ChatEntryType.Meta:const e=this.layer.getCurrentUserJid(),i=t,n=l.getChatMetaActivitySummaryText(i,this._userLookup,e,this,!1);return window.__CTRender("div",{class:"message"},n);case a.ChatEntryType.Chat:const o=t,s=this._userLookup.get(o.from),r=o.mine?this.translateI18nItem(C.YOU):v.formatUserName(s,v.NameFormat.PREFIX_INITIAL_LAST)||o.from,c=o.attachments&&o.attachments.length>0,d=["message"];c&&d.push("has-attachment");const h=l.getChatMessageTextForPreview(o,this);return window.__CTRender("div",{class:d.join(" ")},r,":"," ",c&&window.__CTRender("div",{class:"icon"},window.__CTRender(m.CTIcon,{width:"14",height:"14",icon:g.Icons.UI.Attachment})),c&&window.__CTRender("span",{class:"label"},h),!c&&h)}})()):null}_startNew(){return o(this,void 0,void 0,function*(){if(this.layer.config.behaviour.updateUsersOnNewConversationClick){this.updatingUserDirectory=!0;try{yield this.layer.updateUserDirectory()}catch(t){console.error(t)}finally{this.updatingUserDirectory=!1,this.emitComponentEvent("go-new-conversation")}}else this.emitComponentEvent("go-new-conversation")})}_onClickConversation(t,e,i){return o(this,void 0,void 0,function*(){e.stopPropagation(),t.isClosed||(yield this.layer.setCurrentConversation(t,!1),!i.alert||t.instigator===this.layer.getCurrentUserJid()||i.autoIncludeMembersInRoles.length&&i.autoIncludeMembersInRoles.includes(this.layer.getCurrentUser().group)||l.isExpiredConversation(t)||t.acknowledgements&&t.acknowledgements.find(t=>t.jid===this.layer.getCurrentUserJid())?this.emitComponentEvent("go-chat"):yield this.layer.showConversationAlert(t,!0))})}_removeConversation(t,e){return o(this,void 0,void 0,function*(){e.stopPropagation(),t.isClosed&&(yield this.layer.removeConversationById(t.id))})}_updateConversations(){return o(this,void 0,void 0,function*(){const t=yield this.layer.getConversations();this._allConversations=t.filter(t=>!t.hideBefore),yield this._userLookup.populate(this._allConversations),this._updateVirtualList(),this.filterItems=this._generateFilterItems()})}_updateVirtualList(){return o(this,void 0,void 0,function*(){this.isFetching=!0;const t=this.layer.getCurrentUserJid(),e=l.prepareConversationsForList(this._userLookup,this._allConversations,t,this._filterType,this._filterTerm,this.layer);this._conversationHash=l.sortConversationsIntoHash(this._userLookup,this._allConversations,t,this._filterType,this._filterTerm,this.layer),this._virtualList.setItems(e),this.filterItems=this._generateFilterItems(),this.isFetching=!1})}}n([s.prop({type:s.Stroolean,attribute:!1,default:!0})],w.prototype,"isFetching",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],w.prototype,"updatingUserDirectory",void 0),n([s.prop({type:Array,attribute:!1,default:[]})],w.prototype,"filterItems",void 0),e.CTCLConversationList=w,w.register()},function(t,e,i){var n=i(273);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,'/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}@-moz-keyframes blinker{0%{opacity:1}50%{opacity:.25}to{opacity:1}}@-webkit-keyframes blinker{0%{opacity:1}50%{opacity:.25}to{opacity:1}}@keyframes blinker{0%{opacity:1}50%{opacity:.25}to{opacity:1}}:host{display:block;height:100%;font-size:1em}:host .conversation-list{flex:1 1 auto;display:flex;flex-direction:column;height:100%}:host .conversation-list .header .action{cursor:pointer}:host .conversation-list .filter{flex:0 0 55px;display:flex;justify-content:center;align-items:center;background:var(--secondary-color,#f2f2f2);border-bottom:var(--secondary-border,1px solid #ddd);padding:0 20px}:host .conversation-list .filter .search-box{width:80%;font-size:.833em}:host .conversation-list .column-headings{display:none;background:var(--secondary-color,#f2f2f2);border-bottom:var(--secondary-border,1px solid #ddd);color:var(--subtle-font-color);align-items:center;padding:5px 10px}@media only screen and (min-width:960px){:host .conversation-list .column-headings{display:flex;flex:0 0 auto}}:host .conversation-list .column-headings div.type{flex-basis:6vw}:host .conversation-list .column-headings div.from-to{flex-basis:20vw}:host .conversation-list .column-headings div.last-response,:host .conversation-list .column-headings div.subject{flex-basis:30vw}:host .conversation-list .column-headings div.raised-at{flex-basis:10vw}:host .conversation-list .column-headings div span{text-transform:uppercase}:host .conversation-list .fetching,:host .conversation-list .no-conversations{flex:1 1 auto;display:flex;justify-content:center;align-items:flex-start;text-align:center;height:100%;padding:25px 10px;background:var(--list-bg,#f2f2f2);color:var(--subtle-font-color,#828688)}:host .conversation-list .conversations{flex:1 1 auto;overflow:auto;-webkit-overflow-scrolling:touch;background:var(--list-bg,#f2f2f2)}:host .conversation-list .conversations .conversations-content .conversation{cursor:pointer}:host .conversation-list .conversations .conversations-content .conversation .avatar{flex:none;display:flex;flex-direction:column;justify-content:center;align-items:center;width:40px;height:40px;background:var(--avatar-bg,#7b7e80);color:var(--avatar-color,#fff);border-radius:50%}:host .conversation-list .conversations .conversations-content .conversation .avatar.group{background:var(--group-avatar-bg,#22b1c8);color:var(--group-avatar-color,#fff)}:host .conversation-list .conversations .conversations-content .conversation .avatar.group .icon{margin:-2px 0 2px}:host .conversation-list .conversations .conversations-content .conversation .avatar.group .count{line-height:.8em;font-size:1.333em;letter-spacing:-1px}:host .conversation-list .conversations .conversations-content .conversation .avatar.group .count.small{font-size:1em}:host .conversation-list .conversations .conversations-content .conversation .avatar.group .count.smallest{font-size:.833em}:host .conversation-list .conversations .conversations-content .conversation .avatar.closed{background:none;justify-content:flex-start}:host .conversation-list .conversations .conversations-content .conversation .avatar.closed .badge{background:#303233;color:#fff;font-size:.75em;font-weight:300;text-transform:uppercase;padding:3px 4px;margin:5px 0 0;border-radius:4px;line-height:1em}:host .conversation-list .conversations .conversations-content .conversation .avatar.closed .badge.blink{-webkit-animation-name:blinker;-webkit-animation-duration:3s;-webkit-animation-timing-function:linear;-webkit-animation-iteration-count:infinite;-moz-animation-name:blinker;-moz-animation-duration:3s;-moz-animation-timing-function:linear;-moz-animation-iteration-count:infinite;animation-name:blinker;animation-duration:3s;animation-timing-function:linear;animation-iteration-count:infinite}:host .conversation-list .conversations .conversations-content .conversation .expanded{display:none}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .expanded{display:flex;flex-basis:20vw;overflow:hidden;flex-direction:column}:host .conversation-list .conversations .conversations-content .conversation .expanded div.from,:host .conversation-list .conversations .conversations-content .conversation .expanded div.to{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}}:host .conversation-list .conversations .conversations-content .conversation .subject{display:flex;align-items:center;overflow:hidden}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .subject{flex-basis:20vw;padding-right:20px}}:host .conversation-list .conversations .conversations-content .conversation .subject .badge{flex:none;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);font-size:.75em;font-weight:300;text-transform:uppercase;margin:0 5px 0 0;padding:3px 4px;border-radius:4px;line-height:1em}:host .conversation-list .conversations .conversations-content .conversation .subject .badge.blink{-webkit-animation-name:blinker;-webkit-animation-duration:1s;-webkit-animation-timing-function:linear;-webkit-animation-iteration-count:infinite;-moz-animation-name:blinker;-moz-animation-duration:1s;-moz-animation-timing-function:linear;-moz-animation-iteration-count:infinite;animation-name:blinker;animation-duration:1s;animation-timing-function:linear;animation-iteration-count:infinite}:host .conversation-list .conversations .conversations-content .conversation .subject .title{flex:1 1 auto;font-size:1.333em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .subject .title{display:none}}:host .conversation-list .conversations .conversations-content .conversation .subject .icon{flex:none;margin:0 0 0 10px}:host .conversation-list .conversations .conversations-content .conversation .subject .icon.pending{color:var(--conversation-has-draft-color,#7e8080)}:host .conversation-list .conversations .conversations-content .conversation .subject .icon.error{color:var(--conversation-has-error-color,#d93247)}:host .conversation-list .conversations .conversations-content .conversation .subject .icon.remove{color:var(--subtle-font-color,#828688);cursor:pointer}:host .conversation-list .conversations .conversations-content .conversation .description{display:none}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .description{display:flex;flex-basis:30vw;flex-direction:column;overflow:hidden;padding-right:20px;justify-content:center}:host .conversation-list .conversations .conversations-content .conversation .description div.subject-desc{font-size:1.333em}:host .conversation-list .conversations .conversations-content .conversation .description div.subject-desc,:host .conversation-list .conversations .conversations-content .conversation .description div.user-desc{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}}:host .conversation-list .conversations .conversations-content .conversation .preview{display:flex;align-items:center;flex-direction:row;padding-right:20px;color:var(--conversation-read-text,#828688)}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .preview{flex:0 0 30vw}}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview{flex:1 1 auto;display:flex;align-items:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview{display:none}}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .entry{flex:1 1 auto;display:flex;align-items:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .entry .message{text-overflow:ellipsis;overflow:hidden}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .entry .message.has-attachment{display:flex;align-items:center}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .entry .message.has-attachment .icon{margin:0 3px 0 5px;color:var(--subtle-font-color,#828688)}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .entry .message.has-attachment .label{font-size:.833em;color:var(--subtle-font-color,#828688)}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .when{flex:none;margin:0 0 0 10px}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .marker{flex:none;margin:0 0 0 5px;width:16px}:host .conversation-list .conversations .conversations-content .conversation .preview .mobile-preview .marker:before{display:block;content:"";width:10px;height:10px;margin:0 auto;border-radius:50%;background:var(--conversation-read-marker-bg,#fff);border:var(--conversation-read-marker-border,1px solid #ddd)}:host .conversation-list .conversations .conversations-content .conversation .preview .desktop-preview{display:none}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation .preview .desktop-preview{display:flex;flex-basis:30vw;flex-direction:column;overflow:hidden;justify-content:center}:host .conversation-list .conversations .conversations-content .conversation .preview .desktop-preview div.entry div.message{font-size:1.1em}}:host .conversation-list .conversations .conversations-content .conversation div.raised-on{display:none}@media only screen and (min-width:960px){:host .conversation-list .conversations .conversations-content .conversation div.raised-on{display:flex;flex-basis:10vw;flex-direction:row;overflow:hidden;align-content:center}:host .conversation-list .conversations .conversations-content .conversation div.raised-on span{margin:auto 0}:host .conversation-list .conversations .conversations-content .conversation div.raised-on div.marker{margin:auto 0 auto 5px;flex:none;width:16px}:host .conversation-list .conversations .conversations-content .conversation div.raised-on div.marker:before{display:block;content:"";width:10px;height:10px;margin:0 auto;border-radius:50%;background:var(--conversation-read-marker-bg,#fff);border:var(--conversation-read-marker-border,1px solid #ddd)}}:host .conversation-list .conversations .conversations-content .conversation.unread .description .subject-desc,:host .conversation-list .conversations .conversations-content .conversation.unread .subject .title{font-weight:600}:host .conversation-list .conversations .conversations-content .conversation.unread .preview .entry,:host .conversation-list .conversations .conversations-content .conversation.unread .raised-on .entry{color:var(--conversation-unread-text,#212121)}:host .conversation-list .conversations .conversations-content .conversation.unread .preview .marker:before,:host .conversation-list .conversations .conversations-content .conversation.unread .raised-on .marker:before{background:var(--conversation-unread-marker-bg,#22b1c8);border:var(--conversation-unread-marker-border,1px solid #22b1c8)}:host .conversation-list .conversations .conversations-content .conversation.closed{position:relative;cursor:default}:host .conversation-list .conversations .conversations-content .conversation.closed .subject{color:var(--subtle-font-color,#828688)}:host .conversation-list .conversations .conversations-content .conversation.closed .subject .title{font-weight:400}:host .conversation-list .conversations .conversations-content .conversation.closed .preview .entry,:host .conversation-list .conversations .conversations-content .conversation.closed .preview .when{color:var(--subtle-font-color,#828688)}:host .conversation-list .conversations .conversations-content .conversation.closed .preview .marker{display:none}',""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(11),a=i(12),c=i(0),l=i(13),d=i(10),h=i(275),u=i(21),p=i(278),g=i(281),m=i(15),f=i(284),_=i(6),v=i(4),y=i(35),C=i(292),b=i(2),w=i(0),T=i(20),E=i(5);var S,R;!function(t){t[t.SELECT_CONTACTS="Select Contacts"]="SELECT_CONTACTS",t[t.CHOOSE_CONTACT=""]="CHOOSE_CONTACT",t[t.TOTAL_CONTACTS="Total {{number}} Contacts Added"]="TOTAL_CONTACTS",t[t.TOTAL_CONTACTS_MAX="Total {{number}} Contacts Added (out of {{maximum}})"]="TOTAL_CONTACTS_MAX",t[t.SEARCH_PLACEHOLDER="Find Contacts"]="SEARCH_PLACEHOLDER",t[t.INITIAL_MESSAGE="Find your contacts using the search bar above"]="INITIAL_MESSAGE",t[t.NO_MATCHES="No contacts match your search"]="NO_MATCHES",t[t.DIRECT="Direct"]="DIRECT",t[t.NAMED="Named"]="NAMED",t[t.NAMED_CONVERSATION="Named Conversation"]="NAMED_CONVERSATION",t[t.ADD_SUBJECT_AND_DESCRIPTION="Add a Subject & Description"]="ADD_SUBJECT_AND_DESCRIPTION",t[t.SUBJECT="Subject"]="SUBJECT",t[t.DESCRIPTION_OPTIONAL="Description (optional)"]="DESCRIPTION_OPTIONAL",t[t.CREATE="Create"]="CREATE",t[t.CREATING_CONVERSATION="Creating conversation"]="CREATING_CONVERSATION",t[t.THIS_PRIORITY_WILL_POP_UP_WARNING="Selecting this priority will cause a pop-up on the recipient's device, are you sure?"]="THIS_PRIORITY_WILL_POP_UP_WARNING",t[t.WARN_NO_CONTACTS="You have not selected any contacts. Are you sure you wish to proceed?"]="WARN_NO_CONTACTS",t[t.OPTIONS="Options"]="OPTIONS",t[t.PARTICIPANT_ERROR="You cannot create this conversation without selecting contacts first."]="PARTICIPANT_ERROR"}(S||(S={}));class A{static _create(){return new a.Metadata(I,S)}static get instance(){return this._instance||(this._instance=this._create())}}A._instance=null,e.CTCLNewConversationMetadata=A,function(t){t[t.CONTACT_LIST=0]="CONTACT_LIST",t[t.NAMED_CONVERSATION_DETAILS=1]="NAMED_CONVERSATION_DETAILS"}(R||(R={}));class I extends l.CTCLComponent{constructor(){super(),this._namedConversationSubject="",this._namedConversationDescription="",this._pendingConversationId=null,this._alertResponseOption=_.defaultAlertResponseOption,this._newPageOptions=f.generateDefaultNewPage(),this._attachments=[],this._startDirectConversation=(()=>o(this,void 0,void 0,function*(){const t=yield this._getConversationParticipants(!1);yield this._resetUserList();const e=yield this.layer.getDirectConversationByParticipants(t);if(e)yield this.layer.setCurrentConversation(e),this.emitComponentEvent("go-chat");else{const e=d.createProvisionalDirectConversation(t,this._config.constructConfigurationToSend());yield this.layer.setProvisionalConversation(e),this.emitComponentEvent("go-chat")}})),this._goToNamedConversationDetailsStep=(()=>o(this,void 0,void 0,function*(){this.step=R.NAMED_CONVERSATION_DETAILS})),this._onReplyTemplateChange=(t=>{const e=this._config.alertResponseOptions[t];this._alertResponseOption=e||_.defaultAlertResponseOption}),this._setImgAttachment=(t=>{this._attachments.filter(t=>t.type===_.SupportedAttachmentType.IMAGE).forEach((t,e)=>this._attachments.splice(e,1)),t&&this._attachments.push({path:t,type:_.SupportedAttachmentType.IMAGE})}),this._setAudioAttachment=(t=>{const e=!this._config.subjectRequired||this._namedConversationSubject.trim().length>0,i=!this._config.descriptionRequired||this._namedConversationDescription.trim().length>0;e&&i&&(this.createNamedConversationDisabled=!1),this.isRecording=!1,this._attachments.filter(t=>t.type===_.SupportedAttachmentType.AUDIO).forEach((t,e)=>this._attachments.splice(e,1)),t&&this._attachments.push({path:t,type:_.SupportedAttachmentType.AUDIO})}),this._setVideoAttachment=(t=>{this._attachments.filter(t=>t.type===_.SupportedAttachmentType.VIDEO).forEach((t,e)=>this._attachments.splice(e,1)),t&&this._attachments.push({path:t,type:_.SupportedAttachmentType.VIDEO})}),this._onEnableChatChange=(t=>{this._newPageOptions.enableChat=t}),this.setMetadata(A.instance)}static get is(){return"ct-cl-new-conversation"}initialize(){return o(this,void 0,void 0,function*(){this.layer.setBackHandler(()=>{this._back()})})}setupListeners(){this.setupConnectionStatusListener(),this.addListener(E.ChatEvents.ConversationAdded,t=>o(this,void 0,void 0,function*(){this._pendingConversationId&&this._pendingConversationId===t.conversation.id&&(this._pendingConversationId=null,yield this._resetUserList(),yield this.layer.setCurrentConversation(t.conversation),yield this.dismissWaitingMessage(),this.emitComponentEvent("go-chat"))})),this.addListener(r.BaseEvents.ConnectionStatusChange,t=>{t.status===c.ConnectionStatus.Disconnected&&this.dismissWaitingMessage()},{dontSuppress:!0}),this.addListener(E.ChatEvents.AudioRecordingStarted,()=>{this.isRecording=!0,this.createNamedConversationDisabled=!0})}get generateComponentStyles(){return i(295)}generateComponentMarkup(){return window.__CTRender("div",{class:"new-conversation"},this._renderHeader(),this._renderContactList(),this._renderNamedConversationDetails(),this._renderFooter())}_renderHeader(){const t=this.layer.config.behaviour.maxConversationParticipants||0,e=0===t?this.translateI18nItem(S.TOTAL_CONTACTS):this.translateI18nItem(S.TOTAL_CONTACTS_MAX),i=null!==this.showCountFrom&&this.selectedParticipantCount>=this.showCountFrom?e.replace("{{number}}",this.selectedParticipantCount.toString()).replace("{{maximum}}",(t-1).toString()):this.translateI18nItem(S.CHOOSE_CONTACT);let n="",o="";return this.step===R.CONTACT_LIST&&(n=this.translateI18nItem(S.SELECT_CONTACTS),o=i),this.step===R.NAMED_CONVERSATION_DETAILS&&(n=this._config.name,o=this._config.shortDescription),window.__CTRender(u.CTCLHeader,{class:"header"},window.__CTRender("div",{slot:"left-action"},window.__CTRender(v.CTIcon,{class:"action",width:"20",height:"20",icon:c.Icons.COMMON.ChevronLeft,onClick:this._back.bind(this)})),window.__CTRender("div",{slot:"heading"},n),o&&window.__CTRender("div",{slot:"sub-heading"},o))}_renderContactList(){const t=this.layer.getCurrentUserJid(),e=this.layer.config.behaviour.maxConversationParticipants,i={excludeUsers:[t],allowSearch:this.allowSearch,requireSearch:this.requireSearch,searchPlaceholder:this.translateI18nItem(S.SEARCH_PLACEHOLDER),initialMessage:this.translateI18nItem(S.INITIAL_MESSAGE),noMatchesMessage:this.translateI18nItem(S.NO_MATCHES),allowSelection:!0,maxSelections:e-1,onChangeSelection:t=>{this.selectedParticipantCount=t.length},onClickUser:t=>{t.users||this.layer.showContactInfo(t,null,!1)},onClickGroup:t=>this.layer.showRoleUsersModal(t)},n=["contact-list"];return this.step!==R.CONTACT_LIST&&n.push("hidden"),window.__CTRender("div",{class:n.join(" ")},window.__CTRender(v.CTUserList,Object.assign({id:"user-list"},i)))}_renderNamedConversationDetails(){if(!this._config)return null;const t=["named-conversation-details"];this.step!==R.NAMED_CONVERSATION_DETAILS&&t.push("hidden");const e=this._config.maxSubjectLength,i=this._config.maxDescriptionLength;return window.__CTRender("div",{class:t.join(" ")},window.__CTRender("div",{class:"form-item subject"},window.__CTRender(v.CTTextbox,{type:"text",name:"subject",max:e,required:this._config.subjectRequired,fullBorder:!0,placeholder:this._config.subjectFieldLabel,callback:t=>this._onChangeNamedConversationDetail(t)})),window.__CTRender("div",{class:"form-item description"},window.__CTRender(v.CTTextbox,{type:"textarea",name:"description",max:i,required:this._config.descriptionRequired,fullBorder:!0,placeholder:this._config.descriptionFieldLabel,callback:t=>this._onChangeNamedConversationDetail(t)})),this._config.alert&&this._renderResponseOptions(),this._config.image&&window.__CTRender("div",null,window.__CTRender("hr",null),window.__CTRender(p.CTCLImageAttachment,{callback:this._setImgAttachment}),window.__CTRender("hr",null)),this._config.audio&&window.__CTRender("div",null,window.__CTRender(h.CTCLAudioAttachment,{callback:this._setAudioAttachment,allowAttach:this._config.attachPreRecordedFile,allowRecorc:this._config.attachLiveRecordedAudio}),window.__CTRender("hr",null)),this._config.video&&window.__CTRender("div",null,window.__CTRender(g.CTCLVideoAttachment,{callback:this._setVideoAttachment}),window.__CTRender("hr",null)),"user-choice"===this._config.chatAvailable&&window.__CTRender(C.CTSingleCheckbox,{label:"Enable chat",value:!0,callback:this._onEnableChatChange}))}_renderResponseOptions(){if(!this._config.alertResponseOptions)return null;const t=[...this._config.alertResponseOptions];0===this._config.alertResponseOptions.length&&t.push(_.defaultAlertResponseOption);const e=t.map((t,e)=>({key:e,value:t.name}));return window.__CTRender("div",null,window.__CTRender("div",{class:"form-item priority"},window.__CTRender(v.CTSelectionList,{name:"priority",options:e,selected:0,forceDropdown:!0,onSelect:this._onReplyTemplateChange})))}_renderFooter(){return window.__CTRender("div",{class:"footer"},this._renderFooterButtons())}_renderFooterButtons(){if(this.step===R.CONTACT_LIST){const t=this.layer.getConfiguredConversations().map(t=>({primaryText:t.name,subtitleText:t.shortDescription,action:()=>this._startNewConversation(t)}));return[window.__CTRender(y.CTActionSheet,{buttons:t,openSheetButtonText:"Create"})]}if(this.step===R.NAMED_CONVERSATION_DETAILS)return[window.__CTRender(v.CTButton,{type:"primary",class:"button",disabled:!this.isOnline||this.createNamedConversationDisabled,onClick:this._startNamedConversation.bind(this)},this.translateI18nItem(S.CREATE))]}_back(){return o(this,void 0,void 0,function*(){this.step===R.CONTACT_LIST&&(yield this._resetUserList(),this.emitComponentEvent("go-back")),this.step===R.NAMED_CONVERSATION_DETAILS&&(this.step=R.CONTACT_LIST,setTimeout(()=>{const t=this.shadowRoot.querySelector("#user-list");t&&t.forceRecalcList()},250))})}_startNewConversation(t){if(this._config=new m.ConversationConfigReader(this.layer,null,t),0===this.selectedParticipantCount&&this._config.errorWhenNoContacts){const t=new w.DefaultAlerts(this).AlertErrorWithOkayButton(this.translateI18nItem(T.CommonMetadata.getI18nItem(T.CommonI18nKeys.ERROR)),this.translateI18nItem(S.PARTICIPANT_ERROR),1,{okay:()=>{}});this.emitEvent(E.ChatEvents._Request_RaiseAlert,t)}else if(0===this.selectedParticipantCount&&this._config.warnWhenNoContacts){const t=new w.DefaultAlerts(this).AlertYesNoQuestion(this.translateI18nItem(T.CommonMetadata.getI18nItem(T.CommonI18nKeys.ARE_YOU_SURE)),this.translateI18nItem(S.WARN_NO_CONTACTS),1,{yes:()=>{this._config.namedSettings?this._goToNamedConversationDetailsStep():this._startDirectConversation()},no:()=>{}});this.emitEvent(E.ChatEvents._Request_RaiseAlert,t)}else this._config.namedSettings?this._goToNamedConversationDetailsStep():this._startDirectConversation()}_onChangeNamedConversationDetail(t){t&&"subject"===t.key&&(this._namedConversationSubject=t.value),t&&"description"===t.key&&(this._namedConversationDescription=t.value);const e=!this._config.subjectRequired||this._namedConversationSubject.trim().length>0,i=!this._config.descriptionRequired||this._namedConversationDescription.trim().length>0;this.isRecording||(this.createNamedConversationDisabled=!e||!i),this.forceRedraw()}_startNamedConversation(){return o(this,void 0,void 0,function*(){if(!this.createNamedConversationDisabled)if(!this._config.suppressAlertModalWarning&&this._config.autoAlert){const t=new w.DefaultAlerts(this).AlertYesNoQuestion(this.translateI18nItem(T.CommonMetadata.getI18nItem(T.CommonI18nKeys.ARE_YOU_SURE)),this.translateI18nItem(S.THIS_PRIORITY_WILL_POP_UP_WARNING),1,{yes:()=>o(this,void 0,void 0,function*(){this._completeStartNamedConversation()}),no:()=>o(this,void 0,void 0,function*(){})});this.emitEvent(E.ChatEvents._Request_RaiseAlert,t)}else this._completeStartNamedConversation()})}_completeStartNamedConversation(){return o(this,void 0,void 0,function*(){const t=yield this._getConversationParticipants(!0);yield this.showWaitingMessage(this.translateI18nItem(S.CREATING_CONVERSATION)),this._pendingConversationId=yield this.layer.createConversation(t,this._namedConversationSubject.trim(),this._namedConversationDescription.trim(),this._config.defaultConversationExpiryTTL,this._config.defaultConversationActivityTTL,this._config.constructConfigurationToSend(this._alertResponseOption,this._config.chatAvailable),this._attachments)})}_getSelectedUsers(){return o(this,void 0,void 0,function*(){const t=this.shadowRoot.querySelector("#user-list");if(!t)return[];const e=yield t.getSelections();return b.sortUsersByName(e)})}_resetUserList(){return o(this,void 0,void 0,function*(){const t=this.shadowRoot.querySelector("#user-list");t&&(yield t.reset())})}_getConversationParticipants(t){return o(this,void 0,void 0,function*(){const e=this.layer.getCurrentUserJid(),i=yield this._getSelectedUsers(),n=new Map;for(const t of i)t.name?t.users.map(t=>n.set(t.jid.toLowerCase(),t)):n.set(t.jid.toLowerCase(),t);const o=Array.from(n.keys()),s=t?[e]:null,r=t?o:[e,...o];return d.buildConversationParticipants(s,null,r)})}}n([s.prop({type:s.Stroolean,attribute:!0,default:!0})],I.prototype,"allowSearch",void 0),n([s.prop({type:s.Stroolean,attribute:!0,default:!1})],I.prototype,"requireSearch",void 0),n([s.prop({type:s.NullableNumber,attribute:!0,default:null})],I.prototype,"showCountFrom",void 0),n([s.prop({type:Number,attribute:!1,default:0})],I.prototype,"selectedParticipantCount",void 0),n([s.prop({type:Number,attribute:!1,default:R.CONTACT_LIST})],I.prototype,"step",void 0),n([s.prop({type:Boolean,attribute:!1,default:!0})],I.prototype,"createNamedConversationDisabled",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],I.prototype,"isRecording",void 0),e.CTCLNewConversation=I,I.register()},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(22),r=i(1),a=i(19),c=i(0),l=i(13),d=i(66),h=i(5),u=i(6),p=i(4);var g;!function(t){t[t.ADD_AUDIO_ATTACHMENT="Add Audio Attachment"]="ADD_AUDIO_ATTACHMENT",t[t.NO_AUDIO_ATTACHED="No audio attached"]="NO_AUDIO_ATTACHED"}(g||(g={}));let m=class extends l.CTCLComponent{constructor(){super(...arguments),this._loadFromSource=!1,this.attachClick=(()=>o(this,void 0,void 0,function*(){const t=yield s.CtXmppClient.pickFile({mimeTypes:this.fileTypes});t&&t.length&&(this._loadFromSource=!0,this.audioSrc=t[0],this.callback&&this.callback(this.audioSrc))})),this._recordClick=(()=>o(this,void 0,void 0,function*(){this._loadFromSource=!1,this.audioSrc="",this.recordAudio=!this.recordAudio})),this._onRecordFinished=(t=>{this.callback&&this.callback(t)}),this._onRecordingDeleted=(()=>{this.audioSrc="",this._loadFromSource=!1,this.callback&&this.callback(this.audioSrc)})}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){this.addListener(h.ChatEvents.AudioRecordingStarted,()=>this.audioRecording=!0),this.addListener(h.ChatEvents.AudioRecordingStopped,()=>this.audioRecording=!1)}generateComponentMarkup(){return window.__CTRender("div",{class:"container"},window.__CTRender("h4",null,this.translateI18nItem(g.ADD_AUDIO_ATTACHMENT)),window.__CTRender("div",{class:"controls"},this.allowAttach&&window.__CTRender("div",{class:`action ${this.recordAudio||this.audioSrc?"disabled":""}`,onClick:this.recordAudio||this.audioSrc?null:this.attachClick},window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.MusicalNote})),this.allowRecord&&window.__CTRender("div",{class:`action ${this.audioSrc||this.audioRecording?"disabled":""}`,onClick:this.audioSrc||this.audioRecording?null:this._recordClick},window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.Microphone})),window.__CTRender("div",{class:"placeholder"},this.isLoading?window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:c.Icons.COMMON.LoadingSpinner,spin:!0}):this.recordAudio||this.audioSrc?window.__CTRender(d.CTCLAudioRecorderPlayer,{onRecordingFinished:this._onRecordFinished,onAudioRemoved:this._onRecordingDeleted,showRecord:!this._loadFromSource,source:this.audioSrc,allowRemoval:!0}):window.__CTRender("p",null,this.translateI18nItem(g.NO_AUDIO_ATTACHED)))))}};n([r.prop({type:Array,attribute:!0,default:["audio/mp3","audio/mp4","audio/m4a"]})],m.prototype,"fileTypes",void 0),n([r.prop({type:Function,attribute:!1})],m.prototype,"callback",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],m.prototype,"isLoading",void 0),n([r.prop({type:String,attribute:!1,default:null})],m.prototype,"audioSrc",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],m.prototype,"recordAudio",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],m.prototype,"audioRecording",void 0),n([r.prop({type:Boolean,attribute:!1,default:!0})],m.prototype,"allowAttach",void 0),n([r.prop({type:Boolean,attribute:!1,default:!0})],m.prototype,"allowRecord",void 0),m=n([a.component({tag:"ct-cl-audio-attachment",styles:[i(276)],i18nKeys:g})],m),e.CTCLAudioAttachment=m},function(t,e,i){var n=i(277);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block}:host div.container{display:flex;padding:10px;flex-direction:column}:host div.container h4{margin-top:0;font-weight:400;text-transform:uppercase;font-size:.8em;color:var(--tertiary-placeholder-color,#212121)}:host div.container div.controls{display:flex}:host div.container div.controls div.action{display:flex;justify-content:center;align-items:center;flex:none;width:36px;height:36px;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border-radius:50%;cursor:pointer;margin-right:10px;transition:all .5s ease-in}:host div.container div.controls div.action.disabled{background:var(--subtle-font-color,#828688);cursor:default}:host div.container div.controls div.placeholder{display:flex;flex:1}:host div.container div.controls div.placeholder ctcl-audio-player{flex:0}:host div.container div.controls div.placeholder div.action{margin-left:auto}:host div.container div.controls div.placeholder p{margin:auto 0;align-items:center;color:var(--subtle-font-color,#828688)}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(22),r=i(1),a=i(19),c=i(0),l=i(13),d=i(6),h=i(4),u=i(29);var p;!function(t){t[t.ADD_IMAGE_ATTACHMENT="Add image attachment"]="ADD_IMAGE_ATTACHMENT",t[t.NO_IMAGE="No image attached"]="NO_IMAGE"}(p||(p={}));let g=class extends l.CTCLComponent{constructor(){super(...arguments),this.fullImagePath="",this.imgPreviewHeight=122,this.imgPreviewWidth=122,this.attachClick=(()=>o(this,void 0,void 0,function*(){const t=yield s.CtXmppClient.pickFile({mimeTypes:this.fileTypes,encrypt:!0});if(t&&t.length){this.isLoading=!0;const e=yield u.getThumbnail(t[0],this.imgPreviewWidth,this.imgPreviewHeight,100);this.imgSrc=e,this.fullImagePath=t[0],this.isLoading=!1,this.callback&&this.callback(this.fullImagePath)}})),this.cameraClick=(()=>o(this,void 0,void 0,function*(){try{const t=yield this.layer.captureOrSelectMedia();this.isLoading=!0,t.base64=yield u.getThumbnail(t.path,this.imgPreviewWidth,this.imgPreviewHeight,100),this.imgSrc=t.base64,this.fullImagePath=t.path,this.isLoading=!1,this.callback&&this.callback(this.fullImagePath)}catch(t){console.error(t)}})),this.removeImg=(()=>{this.imgSrc="",this.fullImagePath=""})}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}generateComponentMarkup(){return window.__CTRender("div",{class:"container"},window.__CTRender("h4",null,this.translateI18nItem(p.ADD_IMAGE_ATTACHMENT)),window.__CTRender("div",{class:"controls"},window.__CTRender("div",{class:`action ${this.imgSrc||this.isLoading?"disabled":""}`,onClick:this.cameraClick},window.__CTRender(h.CTIcon,{width:"16",height:"16",icon:d.Icons.UI.Attachment})),window.__CTRender("div",{class:`action ${this.imgSrc||this.isLoading?"disabled":""}`,onClick:this.attachClick},window.__CTRender(h.CTIcon,{width:"16",height:"16",icon:d.Icons.UI.Photo})),window.__CTRender("div",{class:"placeholder"},this.isLoading?window.__CTRender(h.CTIcon,{width:"16",height:"16",icon:c.Icons.COMMON.LoadingSpinner,spin:!0}):this.imgSrc?[window.__CTRender("div",{class:"action",onClick:this.removeImg},window.__CTRender(h.CTIcon,{width:"16",height:"16",icon:d.Icons.UI.Cross})),window.__CTRender("img",{src:this.imgSrc,height:this.imgPreviewHeight,width:this.imgPreviewWidth})]:window.__CTRender("p",null,this.translateI18nItem(p.NO_IMAGE)))))}};n([r.prop({type:Array,attribute:!0,default:["image/jpeg","image/png"]})],g.prototype,"fileTypes",void 0),n([r.prop({type:Function,attribute:!1})],g.prototype,"callback",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],g.prototype,"isLoading",void 0),n([r.prop({type:String,attribute:!1,default:null})],g.prototype,"imgSrc",void 0),g=n([a.component({tag:"ct-cl-image-attachment",styles:[i(279)],i18nKeys:p})],g),e.CTCLImageAttachment=g},function(t,e,i){var n=i(280);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block}:host div.container{display:flex;padding:10px;flex-direction:column}:host div.container h4{margin-top:0;font-weight:400;text-transform:uppercase;font-size:.8em;color:var(--tertiary-placeholder-color,#212121)}:host div.container div.controls{display:flex}:host div.container div.controls div.action{display:flex;justify-content:center;align-items:center;flex:none;width:36px;height:36px;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border-radius:50%;cursor:pointer;margin-right:10px;transition:all .5s ease-in}:host div.container div.controls div.action.disabled{background:var(--subtle-font-color,#828688);cursor:default}:host div.container div.controls div.placeholder{display:flex;flex:1}:host div.container div.controls div.placeholder div.action{margin-left:auto}:host div.container div.controls div.placeholder p{margin:auto 0;align-items:center;color:var(--subtle-font-color,#828688)}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(22),r=i(1),a=i(19),c=i(0),l=i(13),d=i(67),h=i(5),u=i(6),p=i(4);var g;!function(t){t[t.ADD_VIDEO_ATTACHMENT="Add Video Attachment"]="ADD_VIDEO_ATTACHMENT",t[t.NO_VIDEO_ATTACHED="No video attached"]="NO_VIDEO_ATTACHED"}(g||(g={}));let m=class extends l.CTCLComponent{constructor(){super(...arguments),this._loadFromSource=!1,this.attachClick=(()=>o(this,void 0,void 0,function*(){const t=yield s.CtXmppClient.pickFile({mimeTypes:this.fileTypes});t&&t.length&&(this._loadFromSource=!0,this.videoSrc=t[0],this.callback&&this.callback(this.videoSrc))})),this._recordClick=(()=>o(this,void 0,void 0,function*(){this._loadFromSource=!1,this.videoSrc="",this.recordVideo=!this.recordVideo})),this._onRecordFinished=(t=>{this.callback&&this.callback(t)}),this._onRecordingDeleted=(()=>{this.videoSrc="",this._loadFromSource=!1,this.callback&&this.callback(this.videoSrc)})}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){this.addListener(h.ChatEvents.AudioRecordingStarted,()=>this.videoRecording=!0),this.addListener(h.ChatEvents.AudioRecordingStopped,()=>this.videoRecording=!1)}generateComponentMarkup(){return window.__CTRender("div",{class:"container"},window.__CTRender("h4",null,this.translateI18nItem(g.ADD_VIDEO_ATTACHMENT)),window.__CTRender("div",{class:"controls"},window.__CTRender("div",{class:`action ${this.recordVideo||this.videoSrc?"disabled":""}`,onClick:this.recordVideo||this.videoSrc?null:this.attachClick},window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.PickVideo})),window.__CTRender("div",{class:`action ${this.videoSrc||this.videoRecording?"disabled":""}`,onClick:this.videoSrc||this.videoRecording?null:this._recordClick},window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:u.Icons.UI.RecordVideo})),window.__CTRender("div",{class:"placeholder"},this.isLoading?window.__CTRender(p.CTIcon,{width:"16",height:"16",icon:c.Icons.COMMON.LoadingSpinner,spin:!0}):this.recordVideo||this.videoSrc?window.__CTRender(d.CTCLVideoRecorderPlayer,{onRecordingFinished:this._onRecordFinished,onVideoRemoved:this._onRecordingDeleted}):window.__CTRender("p",null,this.translateI18nItem(g.NO_VIDEO_ATTACHED)))))}};n([r.prop({type:Array,attribute:!0,default:["video/mp4","video/webm"]})],m.prototype,"fileTypes",void 0),n([r.prop({type:Function,attribute:!1})],m.prototype,"callback",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],m.prototype,"isLoading",void 0),n([r.prop({type:String,attribute:!1,default:null})],m.prototype,"videoSrc",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],m.prototype,"recordVideo",void 0),n([r.prop({type:Boolean,attribute:!1,default:!1})],m.prototype,"videoRecording",void 0),m=n([a.component({tag:"ct-cl-video-attachment",styles:[i(282)],i18nKeys:g})],m),e.CTCLVideoAttachment=m},function(t,e,i){var n=i(283);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block}:host div.container{display:flex;padding:10px;flex-direction:column}:host div.container h4{margin-top:0;font-weight:400;text-transform:uppercase;font-size:.8em;color:var(--tertiary-placeholder-color,#212121)}:host div.container div.controls{display:flex}:host div.container div.controls div.action{display:flex;justify-content:center;align-items:center;flex:none;width:36px;height:36px;background:var(--primary-color,#22b1c8);color:var(--primary-font-color,#fff);border-radius:50%;cursor:pointer;margin-right:10px;transition:all .5s ease-in}:host div.container div.controls div.action.disabled{background:var(--subtle-font-color,#828688);cursor:default}:host div.container div.controls div.placeholder{display:flex;flex:1}:host div.container div.controls div.placeholder ctcl-audio-player{flex:0}:host div.container div.controls div.placeholder div.action{margin-left:auto}:host div.container div.controls div.placeholder p{margin:auto 0;align-items:center;color:var(--subtle-font-color,#828688)}",""])},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}(i(285))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=i(286);e.generateDefaultNewPage=function(){return{replyTemplate:n.defaultReplyTemplate,imgSrc:"",audioSrc:"",enableChat:!0}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});var n=i(287);e.ChatLayerConfig=n.ChatLayerConfig;var o=i(288);e.ChatXmppConfig=o.ChatXmppConfig;var s=i(289);e.ChatBehaviourConfig=s.ChatBehaviourConfig;var r=i(290);e.ChatExternalFunctionsConfig=r.ChatExternalFunctionsConfig,function(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}(i(291))},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.defaultReplyTemplate={id:"_default",name:"Acknowledge",options:[{name:"Acknowledge",type:"button",label:"Acknowledge",value:"Acknowledge"}]}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),a=i(6),c=i(4);let l=class extends s.CTLayerComponent{constructor(){super(...arguments),this._toggle=(()=>{this.value=!this.value,this.callback&&this.callback(this.value)})}initialize(){return o(this,void 0,void 0,function*(){})}setupListeners(){}generateComponentMarkup(){return window.__CTRender("div",{class:"container",onClick:this._toggle},window.__CTRender("p",null,this.label),this.value?window.__CTRender(c.CTIcon,{width:"16",height:"16",icon:a.Icons.UI.CheckboxChecked}):window.__CTRender(c.CTIcon,{width:"16",height:"16",icon:a.Icons.UI.CheckboxUnchecked}))}};n([s.prop({type:Function,attribute:!1})],l.prototype,"callback",void 0),n([s.prop({type:Boolean,attribute:!1,default:!1})],l.prototype,"value",void 0),n([s.prop({type:String,attribute:!1,default:null})],l.prototype,"label",void 0),l=n([r.component({tag:"ct-single-checkbox",styles:[i(293)]})],l),e.CTSingleCheckbox=l},function(t,e,i){var n=i(294);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */:host{font-family:inherit;font-size:inherit;font-weight:400;color:#212121}:host h1,:host h2,:host h3,:host h4,:host h5,:host h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}:host,:host *{box-sizing:border-box}.user-html p{margin:0}.user-html p+p{margin:.8em 0 0}.user-html strong{font-weight:600}:host{display:block}:host div.container{display:flex;margin:5px 0;padding:0 5px;justify-content:space-between;cursor:pointer;color:var(--primary-color,#15233b)}:host div.container p{color:var(--default-font-color,#212121)}",""])},function(t,e,i){var n=i(296);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block;height:100%;font-size:1em}:host hr{display:block;height:1px;border:0;border-top:1px solid var(--default-border-color,#ddd);margin:10px 5px;padding:0}:host .new-conversation{flex:1 1 auto;display:flex;flex-direction:column;height:100%}:host .new-conversation .header .action{cursor:pointer}:host .new-conversation .contact-list{flex:1 1 auto;display:flex;flex-direction:column;overflow:auto}:host .new-conversation .contact-list #user-list{display:flex;flex-direction:column;flex:1}:host .new-conversation .contact-list.hidden{display:none}:host .new-conversation .named-conversation-details{flex:1 1 auto;display:flex;flex-direction:column;overflow:auto;background:var(--secondary-color,#f2f2f2);padding:10px}:host .new-conversation .named-conversation-details.hidden{display:none}:host .new-conversation .named-conversation-details .priority-type-description{text-align:center;padding:15px 30px 0}:host .new-conversation .footer{flex:0 0 auto;background:var(--secondary-color,#f2f2f2);border-top:var(--secondary-border,1px solid #ddd);display:flex;padding:10px 20px}:host .new-conversation .footer .button{flex:1 1;margin:0 5px;font-size:1.4em}",""])},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__decorate||function(t,e,i,n){var o,s=arguments.length,r=s<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,i,r):o(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},o=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const s=i(65),r=i(15),a=i(49),c=i(35),l=i(1),d=i(12),h=i(0),u=i(0),p=i(4),g=i(9),m=i(2),f=i(13),_=i(5),v=i(58),y=i(6),C=i(21);var b;!function(t){t[t.EXPIRED_PRIORITY_CONVERSATION="Expired Priority Conversation"]="EXPIRED_PRIORITY_CONVERSATION",t[t.ACKNOWLEDGE="Acknowledge"]="ACKNOWLEDGE",t[t.MUTE="Mute"]="MUTE",t[t.CONVERSATION_IS_CLOSED="This conversation is closed."]="CONVERSATION_IS_CLOSED"}(b||(b={}));class w{static _create(){return new d.Metadata(T,b)}static get instance(){return this._instance||(this._instance=this._create())}}w._instance=null,e.CTCLConversationAlertMetadata=w;class T extends f.CTCLComponent{constructor(){super(),this._raisedBy="",this._animationDuration=500,this.mute=(()=>{this.layer.mute(),this.muted=!0}),this.setMetadata(w.instance)}initialize(t){const e=Object.create(null,{initialize:{get:()=>super.initialize}});return o(this,void 0,void 0,function*(){yield e.initialize.call(this,t)})}setupListeners(){this.setupConnectionStatusListener(t=>{t.online&&!0===this.muted&&!1===this.disableMute&&this.emitEvent(_.ChatEvents.ResumeAlertAfterPlayingAudio)}),this.addListener(_.ChatEvents.PriorityConversationAcknowledgedOnAnotherDevice,()=>o(this,void 0,void 0,function*(){yield this.layer.clearPendingAlert(this.conversation),this._resetAndClose()})),this.addListener(_.ChatEvents.MuteAlertToPlayOtherAudio,()=>{this.disableMute=!0}),this.addListener(_.ChatEvents.ResumeAlertAfterPlayingAudio,()=>{this.muted=!1,this.disableMute=!1})}show(t,e){return o(this,void 0,void 0,function*(){this.animateAlert=e;const i=t||this.layer.getNewestPendingAlert();if(i)if(this.conversation=i,this._config=new r.ConversationConfigReader(this.layer,this.conversation),this._raisedBy=yield this._getConversationStarter(),this.showing=!1,this.muted=!1,yield m.sleep(e?this._animationDuration:0),this.conversation.attachments){const t=this.conversation.attachments.find(t=>t.type===y.SupportedAttachmentType.IMAGE),e=this.conversation.attachments.find(t=>t.type===y.SupportedAttachmentType.AUDIO),i=this.conversation.attachments.find(t=>t.type===y.SupportedAttachmentType.VIDEO);t&&(this.imgAttachmentSrc=t.local||t.path),e&&(this.audioAttachmentSrc=e.local||e.path),i&&(this.videoAttachmentSrc=i.local||i.path),setTimeout(()=>o(this,void 0,void 0,function*(){this.showing=!0}),500)}else this.showing=!0})}get generateComponentStyles(){return i(298)}generateComponentMarkup(){return this.showing&&this.conversation?window.__CTRender("div",{class:"chat-conversation-alert"},this._renderHeader(),this._renderAttachment(),this._renderDescription(),this._renderFooter()):null}static get is(){return"ct-cl-conversation-alert"}_renderHeader(){const t=this.conversation.subject,e=this._config.name,i=this._config.colorCode?this._colorLuminance(this._config.colorCode,-.05):null,n=this._config.colorCode?this._colorLuminance(this._config.colorCode,-.1):null;return[window.__CTRender(C.CTCLHeader,{class:"header",backgroundColor:this._config.colorCode},window.__CTRender("div",{slot:"left-action"},!this._config.autoAlert&&window.__CTRender(p.CTIcon,{class:"action",width:"20",height:"20",icon:u.Icons.COMMON.ChevronLeft,onClick:t=>this._resetAndClose()})),window.__CTRender("div",{slot:"heading"},t),window.__CTRender("div",{slot:"sub-heading"},e),window.__CTRender("div",{slot:"right-action"},this._renderPendingCount())),window.__CTRender("div",{class:"header-priority-details"},window.__CTRender("div",{style:g.buildStyles({backgroundColor:i})},window.__CTRender("div",null,window.__CTRender("label",null,"TIME SENT:"),window.__CTRender("div",{class:"header-priority-detail-value",id:"priority-time-sent-value"},m.getFriendlyTime(new Date(this.conversation.createdTime))))),window.__CTRender("div",{style:g.buildStyles({backgroundColor:n})},window.__CTRender("div",null,window.__CTRender("label",null,"RAISED BY:"),window.__CTRender("div",{class:"header-priority-detail-value",id:"priority-raised-by-value"},this._raisedBy))))]}_renderDescription(){return this.conversation.description?window.__CTRender("div",{id:"chat-description",class:"chat-description"},this.conversation.description):null}_renderAttachment(){return this.conversation.attachments&&0===this.conversation.attachments.length?null:window.__CTRender("div",{class:"attachment"},this.videoAttachmentSrc&&window.__CTRender("div",{class:"video"},window.__CTRender(s.CTCLAttachmentHandler,{uri:this.videoAttachmentSrc,type:y.SupportedAttachmentType.VIDEO,conversationId:this.conversation.id})),this.audioAttachmentSrc&&window.__CTRender("div",{class:"audio"},window.__CTRender(s.CTCLAttachmentHandler,{uri:this.audioAttachmentSrc,type:y.SupportedAttachmentType.AUDIO,conversationId:this.conversation.id,stream:a.VolumeStream.Alarm,volumeToPlayAt:this._config.alertVolume})),this.imgAttachmentSrc&&window.__CTRender("div",{class:"image"},window.__CTRender(s.CTCLAttachmentHandler,{uri:this.imgAttachmentSrc,type:y.SupportedAttachmentType.IMAGE,allowOpenImageInFullScreen:this._config.allowOpenInFullScreen,conversationId:this.conversation.id})))}_renderFooter(){return window.__CTRender("div",{class:"footer"},this._renderReplyTemplate(),g.renderIf(this._config.autoAlert&&!this.muted&&!this.isOnline,window.__CTRender(p.CTButton,{type:"none",disabled:this.disableMute,className:"mute",onClick:t=>this.mute(),style:g.buildStyles({backgroundColor:this._config.colorCode})},window.__CTRender(p.CTIcon,{width:"16",height:"16",color:"#FFF",icon:h.Icons.COMMON.Mute}))))}_renderReplyTemplate(){let t;const e=(t=this._config.alertResponseOptions&&0!==this._config.alertResponseOptions.length?this._config.alertResponseOptions[0]:y.defaultAlertResponseOption).options.map(t=>({primaryText:t.label,subtitleText:t.shortDescription,action:()=>this._acknowledgeAndDismiss(t.value),disabled:!this.isOnline,color:this._config.colorCode}));return[window.__CTRender(c.CTActionSheet,{buttons:e,openSheetButtonText:"Respond",openSheetBackgroundColor:this._config.colorCode})]}_getConversationStarter(){return o(this,void 0,void 0,function*(){const t=yield this.layer.getUserByJid(this.conversation.participants[0].jid);return t.displayName||`${t.firstName}  ${t.lastName}`})}_acknowledgeAndDismiss(t){return o(this,void 0,void 0,function*(){if(yield this.layer.clearPendingAlert(this.conversation),this._isExpired(this.conversation)){yield this.emitEvent(_.ChatEvents.PriorityConversationAcknowledged,new v.PriorityConversationAcknowledgedEventArgs(this.conversation,this.layer.getPendingAlertCount()));const t=new h.DefaultAlerts(this).AlertAcknowledge(this.translateI18nItem(b.EXPIRED_PRIORITY_CONVERSATION),this.translateI18nItem(b.EXPIRED_PRIORITY_CONVERSATION),1,{okay:()=>o(this,void 0,void 0,function*(){this.conversation.isClosed||!1===this._config.shouldOpenConversationAfterResponded?this._resetAndClose():yield this._dismissAndGoToConversation(),yield this.layer.showConversationAlert(null,!0)})});yield this.emitEvent(_.ChatEvents._Request_RaiseAlert,t)}else if(this.conversation.isClosed){yield this.emitEvent(_.ChatEvents.PriorityConversationAcknowledged,new v.PriorityConversationAcknowledgedEventArgs(this.conversation,this.layer.getPendingAlertCount()));const t=new h.DefaultAlerts(this).AlertAcknowledge(this.translateI18nItem(b.CONVERSATION_IS_CLOSED),this.translateI18nItem(b.CONVERSATION_IS_CLOSED),1,{okay:()=>o(this,void 0,void 0,function*(){yield this._resetAndClose(),yield this.layer.showConversationAlert(null,!0)})});yield this.emitEvent(_.ChatEvents._Request_RaiseAlert,t)}else yield this.emitEvent(_.ChatEvents.RemotelyStopAudioPlayer),yield this.layer.sendConversationAcknowledgement(this.conversation,t||"acknowledge"),this._config.shouldOpenConversationAfterResponded?yield this._dismissAndGoToConversation():yield this._resetAndClose(),yield this.layer.showConversationAlert(null,!0)})}_dismissAndGoToConversation(){return o(this,void 0,void 0,function*(){yield this.layer.setCurrentConversation(this.conversation,!1),this._goChatFunction&&this._goChatFunction instanceof Function&&this._goChatFunction(),this.conversation=null,this._config=null,this.imgAttachmentSrc="",this.audioAttachmentSrc="",this.videoAttachmentSrc="",yield this.dismiss()})}_isExpired(t){const e=t.createdTime+1e3*t.expiryTTL;return(new Date).getTime()>e}_resetAndClose(){return o(this,void 0,void 0,function*(){yield this.emitEvent(_.ChatEvents.PriorityConversationAcknowledged,new v.PriorityConversationAcknowledgedEventArgs(this.conversation,this.layer.getPendingAlertCount())),this.conversation=null,this._config=null,this.imgAttachmentSrc="",this.audioAttachmentSrc="",this.videoAttachmentSrc="",this.showing=!1,yield m.sleep(this.animate?this._animationDuration:0)})}dismiss(){return o(this,void 0,void 0,function*(){this.showing=!1,yield m.sleep(this.animate?this._animationDuration:0)})}_colorLuminance(t,e){(t=String(t).replace(/[^0-9a-f]/gi,"")).length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),e=e||0;let i,n,o="#";for(n=0;n<3;n++){i=parseInt(t.substr(2*n,2),16);const s=Math.round(Math.min(Math.max(0,i+i*e),255)).toString(16);o+=("00"+s).substr(s.length)}return o}_renderPendingCount(){return g.renderIf(this._config.autoAlert&&this.layer.getPendingAlertCount()>1,window.__CTRender("div",{id:"pending-count",class:"pending-count",style:g.buildStyles({backgroundColor:this._config.colorCode})},this.layer.getPendingAlertCount()-1))}setShowChatFunction(t){this._goChatFunction=t}conversationClosed(t){return o(this,void 0,void 0,function*(){this.conversation&&this.conversation.roomJid===t.roomJid&&(yield this.emitEvent(_.ChatEvents.PriorityConversationAcknowledged,new v.PriorityConversationAcknowledgedEventArgs(this.conversation,this.layer.getPendingAlertCount())),this.conversation.isClosed=!0)})}}n([l.prop({type:Object,attribute:!1,default:null})],T.prototype,"conversation",void 0),n([l.prop({type:Boolean,attribute:!0,default:!0})],T.prototype,"animateAlert",void 0),n([l.prop({type:Boolean,attribute:!0,default:!1})],T.prototype,"showing",void 0),n([l.prop({type:Boolean,attribute:!1,default:!1})],T.prototype,"muted",void 0),n([l.prop({type:String,attribute:!1,default:""})],T.prototype,"imgAttachmentSrc",void 0),n([l.prop({type:String,attribute:!1,default:""})],T.prototype,"audioAttachmentSrc",void 0),n([l.prop({type:String,attribute:!1,default:""})],T.prototype,"videoAttachmentSrc",void 0),n([l.prop({type:Boolean,attribute:!1,default:!1})],T.prototype,"disableMute",void 0),e.CTCLConversationAlert=T,T.register()},function(t,e,i){var n=i(299);t.exports="string"==typeof n?n:n.toString()},function(t,e,i){(t.exports=i(3)(!1)).push([t.i,"/*! Copyright (c) 2018 CommonTime Ltd *//*! Copyright (c) 2018 CommonTime Ltd */input:not([type=checkbox]):not([type=radio]){-webkit-appearance:none}:host{display:block;flex-direction:column;position:fixed;top:0;left:0;height:100%;width:100%;background:#fff;font-size:1em;transform:translateY(100%);will-change:transform;z-index:99997}:host .chat-conversation-alert{flex-direction:column;height:100%;display:flex;background-color:var(--list-bg);color:var(--default-font-color)}:host .chat-conversation-alert .header .action{cursor:pointer}:host .chat-conversation-alert .header .pending-count{border-radius:50%;width:30px;height:30px;padding-top:6px;text-align:center;filter:brightness(85%)}:host .chat-conversation-alert .header-priority-details{display:flex;flex:0 0 auto;flex-direction:row;background:var(--header-bg,#22b1c8);color:var(--header-text,#fff)}:host .chat-conversation-alert .header-priority-details>div{padding:8px 10px}:host .chat-conversation-alert .header-priority-details>div>div{color:var(--header-text,#fff)}:host .chat-conversation-alert .header-priority-details>:not(:last-child){flex:0 0 125px}:host .chat-conversation-alert .header-priority-details>:last-child{flex:1 1 auto}:host .chat-conversation-alert .header-priority-details label{font-size:1em}:host .chat-conversation-alert .header-priority-details .header-priority-detail-value{font-size:1.333em}:host .chat-conversation-alert .chat-description{font-size:1.333em;display:flex;flex-direction:column;flex:1;padding:20px 25px;overflow-y:auto;white-space:pre-line;max-height:270px}:host .chat-conversation-alert .attachment{display:flex;padding:20px 25px 0;flex:0 1 auto;flex-direction:column;min-height:250px;max-height:250px}:host .chat-conversation-alert .attachment div.image{display:flex;flex:1;justify-content:center;align-self:center;padding:20px}:host .chat-conversation-alert .attachment div.image img{height:100%}:host .chat-conversation-alert .attachment div.audio{display:flex;flex:1}:host .chat-conversation-alert .attachment div.audio ctcl-attachment-handler{height:auto;margin-bottom:auto}:host .chat-conversation-alert .footer{flex:0 0 auto;color:#fff;font-size:1em;background:var(--secondary-color,#f2f2f2);border-top:var(--secondary-border,1px solid #ddd);padding:10px 20px;flex-direction:row;display:flex;margin-top:auto}:host .chat-conversation-alert .footer .yes{flex:1 1;margin:0 5px}:host .chat-conversation-alert .footer .mute{margin-left:10px;font-weight:300}:host([animate]){transition:transform var(--animation-normal,.5s) ease-out}:host([showing]){transform:translateY(0)}",""])},function(t,e,i){"use strict";var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(301),s=i(17);e.Store=class extends o.BaseStore{constructor(t,e,i){super(t,e),this.SCHEMA_VERSION=1,this._config=i}init(){const t=Object.create(null,{init:{get:()=>super.init}});return n(this,void 0,void 0,function*(){yield t.init.call(this),this.state.schemaVersion===this.SCHEMA_VERSION?this.logger.log(s.LoggerTypes.DataStorage,` %cSTATE IS USING EXPECTED SCHEMA VERSION: %c${this.state.schemaVersion}`,"color: #606; font-weight: bold;","color: #999; font-weight: normal;"):this.state.schemaVersion<this.SCHEMA_VERSION?this.logger.log(s.LoggerTypes.DataStorage," %cSTATE IS USING OLD SCHEMA VERSION:","color: #C00; font-weight: bold;",{current:this.state.schemaVersion,expected:this.SCHEMA_VERSION}):this.logger.log(s.LoggerTypes.DataStorage," %cSTATE IS NEWER THAN EXPECTED SCHEMA VERSION:","color: #C00; font-weight: bold;",{current:this.state.schemaVersion,expected:this.SCHEMA_VERSION})})}getLatestIdentifier(){return n(this,void 0,void 0,function*(){return this.state.latestIdentifier})}updateLatestIdentifier(t){return n(this,void 0,void 0,function*(){t>this.state.latestIdentifier&&(this.logger.log(s.LoggerTypes.DataStorage,` %cSTORING latestIdentifier '${t}':`,"color: #C00; font-weight: bold;"),this.state.latestIdentifier=t,yield this.saveToPersistent())})}loadConversations(){return n(this,void 0,void 0,function*(){return this.state.conversations||[]})}saveConversations(t){return n(this,void 0,void 0,function*(){this.state.conversations=t,yield this.saveToPersistent()})}clearChatData(){return n(this,void 0,void 0,function*(){this.state.latestIdentifier=0,this.state.conversations=[],yield this.saveToPersistent()})}addToPendingAlerts(t){return n(this,void 0,void 0,function*(){this.state.pendingAlerts||(this.state.pendingAlerts=[]),this.state.pendingAlerts.includes(t.id)||(this.state.pendingAlerts=[t.id,...this.state.pendingAlerts],yield this.saveToPersistent())})}getPendingAlerts(){return this.state.pendingAlerts?this.state.pendingAlerts.reduce((t,e)=>{const i=this.getConversationById(e);return i?[...t,i]:t},[]):[]}clearPendingAlert(t){return n(this,void 0,void 0,function*(){if(this.state.pendingAlerts&&t){const e=this.state.pendingAlerts.indexOf(t.id);this.state.pendingAlerts.splice(e,1),yield this.saveToPersistent()}})}getConversationById(t){return this.state.conversations.find(e=>e.id===t)}generateInitialState(){return{_id:this.name,_rev:"",schemaVersion:this.SCHEMA_VERSION,latestIdentifier:0,conversations:[],pendingAlerts:[]}}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const o=i(32),s=i(17),r=i(2);e.BaseStore=class{constructor(t,e,i=!1,n=!0){this._saveToPersistentQueue=Promise.resolve(),this._isDestoryingDb=!1,this.name=t,this.logger=e,this._autoCompact=i,this._encryption=n}init(){return n(this,void 0,void 0,function*(){if(this._db||(yield this._createDb(this.name)),this.state=yield this.getFromPersistent(),this.logger.shouldLog(s.LoggerTypes.DataStorage)){const t=r.deepCloneObject(this.state);this.logger.log(s.LoggerTypes.DataStorage," %cINITIAL STATE:","color: #606; font-weight: bold;",Object.assign({},t)),this.prevState=t}})}savePushNotificationToken(t){return n(this,void 0,void 0,function*(){this.state.pushNotificationToken=t,yield this.saveToPersistent()})}getPushNotificationToken(){return n(this,void 0,void 0,function*(){return this.state.pushNotificationToken})}savePushNotificationAzureId(t){return n(this,void 0,void 0,function*(){this.state.pushNotificationTokenAzureId=t,yield this.saveToPersistent()})}getPushNotificationAzureId(){return n(this,void 0,void 0,function*(){return this.state.pushNotificationTokenAzureId})}clearAllData(){return n(this,void 0,void 0,function*(){return new Promise(t=>{localStorage.removeItem(this.name),this._db&&!this._isDestoryingDb?(this._isDestoryingDb=!0,this._db.destroy().then(()=>(this._createDb(this.name),this.init())).then(()=>{this._isDestoryingDb=!1,t()})):t()})})}getLoggerTypes(){return n(this,void 0,void 0,function*(){return this.state.loggerTypes})}saveLoggerTypes(t){return n(this,void 0,void 0,function*(){return this.state.loggerTypes=t,yield this.saveToPersistent()})}deleteLoggerTypes(){return n(this,void 0,void 0,function*(){return delete this.state.loggerTypes,yield this.saveToPersistent()})}getStateSnapshot(){return this.state}getTheme(){return n(this,void 0,void 0,function*(){return this.state.theme||""})}saveTheme(t){return n(this,void 0,void 0,function*(){return this.state.theme=t,yield this.saveToPersistent()})}getFromPersistent(){return n(this,void 0,void 0,function*(){if(!this._db)return localStorage.getItem(this.name)?JSON.parse(localStorage.getItem(this.name)):this.generateInitialState();try{return yield this._db.get(this.name)}catch(t){const e=this.generateInitialState(),i=yield this._db.put(e);return e._rev=i.rev,e}})}saveToPersistent(){return n(this,void 0,void 0,function*(){clearTimeout(this._saveDebouncer),this._saveDebouncer=setTimeout(()=>{this._db?this._saveToPersistentQueue=this._saveToPersistentQueue.then(()=>n(this,void 0,void 0,function*(){try{const t=yield this._db.put(this.state);this.state._rev=t.rev,this.logger.shouldLog(s.LoggerTypes.DataStorage)&&this._logUpdate()}catch(t){throw new Error(t)}})):(localStorage[this.name]=JSON.stringify(this.state),this.logger.shouldLog(s.LoggerTypes.DataStorage)&&this._logUpdate())},150)})}_createDb(t){return n(this,void 0,void 0,function*(){if(window.PouchDB){if(this.logger.log(s.LoggerTypes.DataStorage,` %cUSING POUCHDB: %c${t}`,"color: #606; font-weight: bold;","color: #999; font-weight: normal;"),this._db=new window.PouchDB(`${t}`,{revs_limit:1,auto_compaction:this._autoCompact}),!0===this._encryption){this.logger.log(s.LoggerTypes.DataStorage," %cENCRYPTING POUCHDB...","color: #606; font-weight: bold;","color: #999; font-weight: normal;");const e=yield o.getEncryptionKey(t+"_layer");this._db.crypto({key:e})}}else this.logger.log(s.LoggerTypes.DataStorage," %cCANNOT FIND POUCHDB, USING LOCAL STORAGE INSTEAD","color: #606; font-weight: bold;")})}_logUpdate(){const t=r.deepCloneObject(this.state),e=r.getDiffs(this.prevState,t),i=r.groupArrayItemsByKey(e,t=>t.path),n=Object.keys(i);0===e.length?this.logger.log(s.LoggerTypes.DataStorage," %cSTATE UPDATED %c- NO STATE CHANGES","color: #606; font-weight: bold;","color: #999; font-weight: bold;",Object.assign({},t)):(this.logger.log(s.LoggerTypes.DataStorage," %cSTATE UPDATED","color: #606; font-weight: bold;",Object.assign({},t)),this.logger.group(s.LoggerTypes.DataStorage,e.length<3,` %c${e.length} STATE CHANGE(S):`,"color: #999; font-weight: bold;"),n.forEach(t=>{this.logger.log(s.LoggerTypes.DataStorage,`%cstate.${t}:`,"color: #666; font-weight: normal;"),i[t].forEach(t=>{if(t.added||t.deleted){const e=t.added?"090":"900";this.logger.log(s.LoggerTypes.DataStorage,`  %c${t.type.toLowerCase()}:`,`color: #${e}; font-weight: normal;`,t.rhs)}else this.logger.log(s.LoggerTypes.DataStorage,`  %c${t.lhs||"<empty>"} %c %c${t.rhs}`,"color: #900; font-weight: normal;","color: #CCC;","color: #090; font-weight: normal;")})}),this.logger.groupEnd(s.LoggerTypes.DataStorage)),this.prevState=t}}},function(t,e,i){"use strict";
/*! Copyright (c) 2018 CommonTime Ltd */Object.defineProperty(e,"__esModule",{value:!0});const n=i(11);e.PriorityConversationNotificationEventArgs=class extends n.BaseEventArgs{constructor(t,e,i,n){super(),this.conversation=t,this.alert=e,this.autoAlert=i,this.mustAcknowledge=n}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}(i(4))}]);